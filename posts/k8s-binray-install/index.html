<!DOCTYPE html>
<html
  lang="zh"
  dir="ltr"
  
><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>K8s äºŒè¿›åˆ¶å®‰è£… | /dev/null</title>

<meta name="generator" content="Hugo Eureka 0.9.3" />
<link rel="stylesheet" href="/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css">
<script defer src="/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js"></script>













<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&amp;family=Noto&#43;Serif&#43;SC:wght@400;600;700&amp;display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/atom-one-dark.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"
   crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js"
     crossorigin></script>
<link rel="stylesheet" href="/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css" media="print" onload="this.media='all';this.onload=null">


<script defer type="text/javascript" src="/js/fontawesome.min.7ecdf591e18d9b7d9a9acfee01f5545be9b15d3fb9a6235fc83f0f7b48df77c7d3fd123037395d75224bf17af86143c1.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
   integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" 
  integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
   integrity="sha384-&#43;XBljXPPiv&#43;OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js" 
  integrity="sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0"  crossorigin></script>
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-80J26VFWFL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-80J26VFWFL');
</script>

<meta name="referrer" content="no-referrer" />
<style>
    .search-container {
    margin-top: -0.3rem;
    }
    .search-container .search {
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    }
    .search-container input {
    padding-left: 1rem;
    line-height: 2rem;
    outline: none;
    background: transparent;
    }
    .search-container button {
    font-size: 0.8rem;
    margin-right: 0.5rem;
    color: #e2e8f0;
    }

     
    .categories-card {
    margin: 0 auto;
     
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-direction: row;
    flex-wrap: wrap;
    line-height: 1.6rem;
    }

    .categories-card .card-item {
    font-size: .875rem;
    text-align: left;
    width: 45%;
    display: flex;
    align-items: flex-start;
    margin-top: 2rem;
    min-height: 10rem;
    padding: 0 2%;
    position: relative;
    }

    .categories-card .card-item .card-item-wrapper {
    width: 100%;
    overflow: hidden;
    }

    .categories-card .card-item .card-item-wrapper .card-item-title {
    font-size: 1.2rem;
    font-weight: bold;
    display: inline-block;
    margin-top: 1rem;
    margin-bottom: .75rem;
    }

    .categories-card .card-item .card-item-wrapper span {
    float: right;
    padding-right: 1rem;
    }

    .archive-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    margin: .25rem 0 .25rem 1.5rem;
    }

    .more-post {
    text-align: right;
    }
    .tag-cloud-tags {
    margin: 10px 0;
    }

    .tag-cloud-tags a {
    display: inline-block;
    position: relative;
    margin: 5px 10px;
    }
    
    .archive .single-title {
    text-align: right;
    }

    .archive .group-title {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    }
    .archive .archive-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    margin: 0.25rem 0 0.25rem 1.5rem;
    }
     

</style>
<script src="/fontawesome/js/all.min.js"></script>
<link rel="icon" type="image/png" sizes="32x32" href="/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_32x32_fill_box_center_3.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_180x180_fill_box_center_3.png">

<meta name="description"
  content="ç¯å¢ƒ ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"æ–‡ç« ",
      "item":"/posts/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"K8s äºŒè¿›åˆ¶å®‰è£…",
      "item":"/posts/k8s-binray-install/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/posts/k8s-binray-install/"
    },
    "headline": "K8s äºŒè¿›åˆ¶å®‰è£… | \/dev\/null","datePublished": "2023-04-13T22:05:14+08:00",
    "dateModified": "2023-04-13T22:05:14+08:00",
    "wordCount":  3055 ,
    "publisher": {
        "@type": "Person",
        "name": "void",
        "logo": {
            "@type": "ImageObject",
            "url": "/images/icon.png"
        }
        },
    "description": "ç¯å¢ƒ ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š"
}
</script><meta property="og:title" content="K8s äºŒè¿›åˆ¶å®‰è£… | /dev/null" />
<meta property="og:type" content="article" />


<meta property="og:image" content="/images/icon.png">


<meta property="og:url" content="/posts/k8s-binray-install/" />




<meta property="og:description" content="ç¯å¢ƒ ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š" />




<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="/dev/null" />






<meta property="article:published_time" content="2023-04-13T22:05:14&#43;08:00" />


<meta property="article:modified_time" content="2023-04-13T22:05:14&#43;08:00" />



<meta property="article:section" content="posts" />


<meta property="article:tag" content="k8s" />





<meta property="og:see_also" content="/posts/k8s-secret/" />

<meta property="og:see_also" content="/posts/client-go-yuan-ma/" />

<meta property="og:see_also" content="/posts/kubebuilder/" />

<meta property="og:see_also" content="/posts/k8s-statefulset/" />

<meta property="og:see_also" content="/posts/k8s-configmap/" />

<meta property="og:see_also" content="/posts/k8s-namespace/" />




  <body class="flex min-h-screen flex-col">
    <header
      class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"
    >
      <div class="mx-auto w-full max-w-screen-xl"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="me-6 text-primary-text text-xl font-bold">/dev/null</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">å…³äº</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  me-4">æ–‡ç« </a>
            <a href="/tags/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">æ ‡ç­¾</a>
            <a href="/categories/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">åˆ†ç±»</a>
            <a href="/archive/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">å½’æ¡£</a>
        </div>

        <div class="flex">
            
            <div class="search-container relative pt-4 md:pt-0">
                <div class="search">
                    <form role="search" class="search-form" action="/search" method="get">
                    <label>
                        <input name="q" type="text" placeholder="æœç´¢ ..." class="search-field">
                    </label>
                    <button>
                        <i class="fas fa-search"></i>
                    </button>
                    </form>
                </div>
            </div>


            <div class="relative pt-4 md:pt-0" style="margin-left: 1rem">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">æµ…è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">æ·±è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">è‡ªåŠ¨</span>
                </div>
            </div>

            
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
    </header>
    <main class="grow pt-16">
        <div class="pl-scrollbar">
          <div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8">
  
  
  <div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12">
    <div
      class=" bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"
    >
      <article class="prose">
  <h1 class="mb-4">K8s äºŒè¿›åˆ¶å®‰è£…</h1>

  <div
  class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"
>
  <div class="me-6 my-2">
    <i class="fas fa-calendar me-1"></i>
    <span
      >2023-04-13</span
    >
  </div>
  <div class="me-6 my-2">
    <i class="fas fa-clock me-1"></i>
    <span>15åˆ†é’Ÿé˜…è¯»æ—¶é•¿</span>
  </div>

  

  
</div>


  
  

  <h1 id="ç¯å¢ƒ">ç¯å¢ƒ</h1>
<p>ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>os</th>
<th>ip</th>
<th>cpu</th>
<th>mem</th>
<th>disk</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-master</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.128</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
<tr>
<td>k8s-worker1</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.129</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
<tr>
<td>k8s-worker2</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.130</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
</tbody>
</table>
<h1 id="åŸºç¡€ç¯å¢ƒå‡†å¤‡">åŸºç¡€ç¯å¢ƒå‡†å¤‡</h1>
<h2 id="é…ç½®-hosts">é…ç½® hosts</h2>
<p>åœ¨ 3 å°ä¸»æœºçš„ /etc/hosts æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code>192.168.223.128 k8s-master
192.168.223.129 k8s-worker1
192.168.223.130 k8s-worker2
</code></pre>
<h2 id="é…ç½®å…å¯†ç™»å½•">é…ç½®å…å¯†ç™»å½•</h2>
<p>é¦–å…ˆåœ¨æ¯å°æœºå™¨ä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç”Ÿæˆ ssh ç§˜é’¥ï¼Œç›´æ¥å›è½¦åˆ°åº•ï¼š</p>
<pre><code class="language-shell">$ ssh-keygen -t rsa
</code></pre>
<p>ç»§ç»­æ‰§è¡Œ <code>ssh-copy-id -i .ssh/id_rsa.pub &lt;hostname&gt;</code> å‘½ä»¤ï¼Œå…¶ä¸­ hostname å¡«å†™ <strong>å¦å¤–ä¸¤å°ä¸»æœºçš„ä¸»æœºå</strong>ï¼Œè¿™é‡Œä»¥ <code>k8s-worker1</code> ä¸ºä¾‹ã€‚ æŒ‰ç…§æç¤ºè¾“å…¥ yesï¼Œæœ€åè¾“å…¥ç›®æ ‡ä¸»æœºçš„å¯†ç ã€‚</p>
<pre><code class="language-shell">$ ssh-copy-id -i .ssh/id_rsa.pub k8s-worker1
</code></pre>
<p>è¾“å…¥å¯†ç åï¼Œå¦‚æœæç¤ºä¸‹é¢å†…å®¹ï¼Œè¯´æ˜é…ç½®å…å¯†æˆåŠŸï¼Œæ‰§è¡Œ <code>ssh 'k8s-worker1'</code>ï¼Œå‘ç°æ— éœ€è¾“å…¥å¯†ç å³å¯ç›´æ¥ ssh åˆ°ç›®æ ‡ä¸»æœºã€‚</p>
<pre><code class="language-shell">Number of key(s) added: 1

Now try logging into the machine, with:   &quot;ssh 'k8s-worker1'&quot;
and check to make sure that only the key(s) you wanted were added.
</code></pre>
<p>æŒ‰ç…§ä¸Šé¢çš„æµç¨‹å¯¹æ¯å°ä¸»æœºæ‰§è¡Œç›¸åŒæ“ä½œï¼Œå®Œæˆ 3 å°ä¸»æœºç›¸äº’ä¹‹é—´çš„å…å¯†ç™»å½•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="å…³é—­é˜²ç«å¢™">å…³é—­é˜²ç«å¢™</h2>
<p>åœ¨æ¯å°ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<pre><code class="language-shell">$ systemctl disable --now ufw
</code></pre>
<p>æŸ¥çœ‹æ•ˆæœï¼š</p>
<pre><code class="language-shell">$ sudo ufw status
Status: inactive
</code></pre>
<h2 id="å…³é—­äº¤æ¢åˆ†åŒº">å…³é—­äº¤æ¢åˆ†åŒº</h2>
<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å…³é—­ swapï¼š</p>
<pre><code class="language-shell">sed -ri 's/.*swap.*/#&amp;/' /etc/fstab
swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
</code></pre>
<p>æŸ¥çœ‹æ•ˆæœï¼ŒSwap è¿™æ çš„ total ä¸º 0ï¼Œè¡¨ç¤ºå…³é—­æˆåŠŸã€‚ä¸Šé¢çš„å‘½ä»¤ä¼šæ°¸ä¹…ç¦ç”¨ Swapï¼Œå³ä½¿é‡å¯åä¹Ÿä¼šç”Ÿæ•ˆã€‚</p>
<pre><code class="language-shell">$ free -h
               total        used        free      shared  buff/cache   available
Mem:           7.7Gi       415Mi       6.5Gi       1.0Mi       851Mi       7.1Gi
Swap:             0B          0B          0B
</code></pre>
<blockquote>
<p>ğŸ¤”ï¸ ä¸ºä»€ä¹ˆå®‰è£… k8s è¦éœ€è¦å…³é—­ Swapï¼Ÿ</p>
<p>åœ¨å®‰è£… Kubernetes é›†ç¾¤æ—¶ï¼Œéœ€è¦å…³é—­ swapã€‚åŸå› æ˜¯ Kubernetes é€šè¿‡ cgroup æ¥å¯¹å®¹å™¨è¿›è¡Œèµ„æºé™åˆ¶ï¼Œè€Œ cgroup åªèƒ½æ§åˆ¶å®é™…å†…å­˜ï¼Œæ— æ³•æ§åˆ¶ swapï¼Œå› æ­¤å¼€å¯ swap åå¯èƒ½ä¼šå¯¼è‡´èµ„æºä¸å—é™åˆ¶ï¼Œè¿›è€Œå¯¼è‡´å®¹å™¨è¿è¡Œä¸ç¨³å®šæˆ–è€…å®•æœºã€‚å› æ­¤å…³é—­ swap å¯ä»¥æé«˜ Kubernetes é›†ç¾¤çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚</p>
</blockquote>
<h2 id="è®¾ç½®æ—¶é—´åŒæ­¥">è®¾ç½®æ—¶é—´åŒæ­¥</h2>
<p>åœ¨æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<pre><code class="language-shell"># æ‰“å¼€ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤å®‰è£…ntpdateå·¥å…·ã€‚
$ apt install ntpdate

# å†è¾“å…¥å‘½ä»¤è®¾ç½®ç³»ç»Ÿæ—¶é—´ä¸ç½‘ç»œæ—¶é—´åŒæ­¥ã€‚
$ ntpdate cn.pool.ntp.org

# æœ€åè¾“å…¥å‘½ä»¤å°†æ—¶é—´æ›´æ–°åˆ°ç¡¬ä»¶ä¸Šå³å¯ã€‚
$ hwclock --systohc
</code></pre>
<blockquote>
<p>ğŸ¤”ï¸ å®‰è£… k8s ä¸ºä»€ä¹ˆéœ€è¦è®¾ç½®æ—¶é—´åŒæ­¥ï¼Ÿ</p>
<p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦è¿›è¡Œåè°ƒå’Œé€šä¿¡ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå°†ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<ol>
<li>è¯ä¹¦é—®é¢˜ï¼šKubernetes ä½¿ç”¨ TLS è¯ä¹¦è¿›è¡ŒèŠ‚ç‚¹é—´çš„è®¤è¯å’Œé€šä¿¡ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½å¯¼è‡´è¯ä¹¦è¿‡æœŸæˆ–è€…æ— æ³•éªŒè¯ç­‰é—®é¢˜ã€‚</li>
<li>æ—¥å¿—é—®é¢˜ï¼šå„ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—éœ€è¦è¿›è¡Œæ—¶é—´æˆ³çš„è®°å½•ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½å¯¼è‡´æ—¥å¿—é¡ºåºé”™ä¹±æˆ–è€…æ— æ³•å®šä½é—®é¢˜ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œåœ¨å®‰è£… Kubernetes æ—¶éœ€è¦è®¾ç½®æ—¶é—´åŒæ­¥ï¼Œä¿è¯å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´æ˜¯ä¸€è‡´çš„ï¼Œä»è€Œé¿å…å‡ºç°ä»¥ä¸Šé—®é¢˜ã€‚</p>
</blockquote>
<h2 id="å®‰è£…-docker"><del>å®‰è£… Docker</del></h2>
<p><del>å› ä¸ºæˆ‘åœ¨å®‰è£… Ubuntu æ—¶å‹¾é€‰äº† Dockerï¼Œæ‰€ä»¥ç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…å¥½äº† Dockerã€‚</del></p>
<h2 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-containerd">æ‰€æœ‰èŠ‚ç‚¹å®‰è£… Containerd</h2>
<p>åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼Œmaster èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½éœ€è¦</p>
<pre><code class="language-shell">$ wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz

# åˆ›å»º cni æ’ä»¶æ‰€éœ€ç›®å½•
$ mkdir -p /etc/cni/net.d /opt/cni/bin 
# è§£å‹ cni äºŒè¿›åˆ¶åŒ…
$ tar xf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/
$ wget https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz
$ tar -C / -xzf cri-containerd-cni-1.6.4-linux-amd64.tar.gz

# åˆ›å»ºæœåŠ¡å¯åŠ¨æ–‡ä»¶
cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target
[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>é…ç½® Containerd æ‰€éœ€çš„æ¨¡å—</p>
<pre><code class="language-shell">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
</code></pre>
<p>åŠ è½½æ¨¡å—ï¼Œè®¾ç½®å¼€æœºå¯åŠ¨</p>
<pre><code class="language-shell">$ systemctl restart systemd-modules-load.service
</code></pre>
<p>é…ç½®Containerdæ‰€éœ€çš„å†…æ ¸</p>
<pre><code class="language-shell">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

# åŠ è½½å†…æ ¸ 
sysctl --system
</code></pre>
<p>åˆ›å»º Containerd çš„é…ç½®æ–‡ä»¶</p>
<pre><code class="language-shell"># åˆ›å»ºé…ç½®æ–‡ä»¶
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml

# ä¿®æ”¹ Containerd çš„é…ç½®æ–‡ä»¶
sed -i &quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot; /etc/containerd/config.toml

cat /etc/containerd/config.toml | grep SystemdCgroup

sed -i &quot;s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/abcdocker#g&quot; /etc/containerd/config.toml

cat /etc/containerd/config.toml | grep sandbox_image
</code></pre>
<p>æ‰‹åŠ¨åˆ é™¤ <code>/etc/containerd/config.toml</code> ä¸­çš„ <code>systemd_cgroup = false</code> è¿™ä¸€è¡Œ</p>
<pre><code class="language-shell">vim /etc/containerd/config.toml
</code></pre>
<p>è®¾ç½®å¼€æœºå¯åŠ¨</p>
<pre><code class="language-shell">systemctl daemon-reload
systemctl enable --now containerd
</code></pre>
<p>éªŒè¯</p>
<pre><code class="language-shell">$ ctr version
Client:
  Version:  v1.6.4
  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16
  Go version: go1.17.9
Server:
  Version:  v1.6.4
  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16
  UUID: f3171aee-67b0-4e01-871b-2e93674af2ad
</code></pre>
<h1 id="k8s-ç¯å¢ƒéƒ¨ç½²">k8s ç¯å¢ƒéƒ¨ç½²</h1>
<h2 id="ä¸‹è½½ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶">ä¸‹è½½ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶</h2>
<p>åœ¨ master èŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä¸‹è½½ k8s ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
<pre><code class="language-shell">$ wget https://dl.k8s.io/v1.24.3/kubernetes-server-linux-amd64.tar.gz
$ wget https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz
</code></pre>
<p>è§£å‹è·å¾—å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°†è§£å‹åˆ° <code>/usr/local/bin</code> ç›®å½•ä¸‹ï¼š</p>
<pre><code class="language-shell">$ tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}

$ tar -xf etcd-v3.5.4-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.4-linux-amd64/etcd{,ctl}
</code></pre>
<p>æ£€æŸ¥<code>/usr/local/bin</code>ä¸‹å†…å®¹</p>
<pre><code class="language-shell">$ ls /usr/local/bin/
cfssl      etcd     kube-apiserver           kubectl  kube-proxy
cfssljson  etcdctl  kube-controller-manager  kubelet  kube-scheduler
</code></pre>
<p>éªŒè¯äºŒè¿›åˆ¶</p>
<pre><code class="language-shell">$ kubelet --version
Kubernetes v1.24.3
$ etcdctl version
etcdctl version: 3.5.4
API version: 3.5
</code></pre>
<p>å°†åˆšåˆšè§£å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šï¼ˆå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯è®¡ç®—èŠ‚ç‚¹ï¼Œæ‰€ä»¥å…¶å®ä¸ç”¨æ‹·è´ etcd ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯ kubectl ä»€ä¹ˆçš„è¿˜æ˜¯éœ€è¦çš„ï¼Œæ‰€ä»¥å½±å“ä¸å¤§ï¼‰</p>
<pre><code class="language-shell">for i in k8s-worker1 k8s-worker2;do   
	scp /usr/local/bin/kube* root@$i:/usr/local/bin/    
	scp /usr/local/bin/{etcd,etcdctl}   root@$i:/usr/local/bin/
done
</code></pre>
<h2 id="å‡†å¤‡ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾è¯ä¹¦é…ç½®æ–‡ä»¶">å‡†å¤‡ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾è¯ä¹¦é…ç½®æ–‡ä»¶</h2>
<pre><code class="language-shell">$ mkdir pki
</code></pre>
<h2 id="ä¸‹è½½é…ç½®-cfssl-è¯ä¹¦">ä¸‹è½½é…ç½® cfssl è¯ä¹¦</h2>
<blockquote>
<p>âš ï¸ åªéœ€åœ¨æ§åˆ¶èŠ‚ç‚¹ k8s-master ä¸Šæ‰§è¡Œ</p>
</blockquote>
<pre><code class="language-shell">$ wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssl
$ wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssljson

$ chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre>
<h2 id="åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶">åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶</h2>
<pre><code class="language-shell">$ cd pki
</code></pre>
<p>ä¸‹é¢è¿™æ®µ shell æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ª admin ç”¨æˆ·çš„è¯ä¹¦ç­¾å‘è¯·æ±‚æ–‡ä»¶ <code>admin-csr.json</code>ï¼Œå…¶ä¸­åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li><code>CN</code>ï¼šCommon Nameï¼Œå³è¯ä¹¦çš„åç§°ï¼Œè¿™é‡Œæ˜¯ <code>admin</code>ã€‚</li>
<li><code>key</code>ï¼šç”¨äºæŒ‡å®šç”Ÿæˆå¯†é’¥çš„ç®—æ³•åŠé•¿åº¦ï¼Œè¿™é‡Œæ˜¯ <code>rsa</code> ç®—æ³•ï¼Œé•¿åº¦æ˜¯ <code>2048</code> ä½ã€‚</li>
<li><code>names</code>ï¼šç”¨äºæŒ‡å®šè¯ä¹¦ä¸­çš„ä¸»é¢˜ï¼ˆSubjectï¼‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›½å®¶ï¼ˆCï¼‰ã€çœï¼ˆSTï¼‰ã€åŸå¸‚ï¼ˆLï¼‰ã€ç»„ç»‡ï¼ˆOï¼‰å’Œç»„ç»‡å•ä½ï¼ˆOUï¼‰ï¼Œè¿™é‡Œä¸»è¦æŒ‡å®šäº†ç»„ç»‡ä¸º <code>system:masters</code>ï¼Œä¹Ÿå°±æ˜¯ Kubernetes çš„ç®¡ç†å‘˜ã€‚</li>
</ul>
<p>è¯¥è¯ä¹¦ç”¨äºéªŒè¯ç”¨æˆ· <code>admin</code> å¯¹ Kubernetes API Server çš„è®¿é—®æƒé™ï¼Œç”± Kubernetes çš„è¯ä¹¦ç®¡ç†å·¥å…· <code>cfssl</code> æ ¹æ®æ­¤æ–‡ä»¶ç”Ÿæˆè¯ä¹¦ã€‚</p>
<p>ï¼ˆä»¥ä¸Šå†…å®¹æ¥è‡ª ChatGPTã€‚ã€‚ã€‚ï¼‰</p>
<pre><code class="language-shell">$ cat &gt; admin-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
</code></pre>
<p>ä¸‹é¢è¿™æ®µ shell æ˜¯å®šä¹‰ CA çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œ&ldquo;signing&rdquo; å’Œ &ldquo;profiles&rdquo;ã€‚</p>
<p>å…¶ä¸­ï¼Œ&ldquo;signing&rdquo; éƒ¨åˆ†å®šä¹‰äº†é»˜è®¤çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®ä¸º 876000 å°æ—¶ï¼Œä¹Ÿå°±æ˜¯ 100 å¹´ã€‚è¿™ä¸ªæ—¶é—´å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚</p>
<p>&ldquo;profiles&rdquo; éƒ¨åˆ†å®šä¹‰äº†ä¸åŒ profile çš„é…ç½®ä¿¡æ¯ã€‚è¿™é‡Œåªå®šä¹‰äº†ä¸€ä¸ªå«åš &ldquo;kubernetes&rdquo; çš„ profileï¼Œè¯¥ profile çš„ç”¨é€”åŒ…æ‹¬ &ldquo;signing&rdquo;ã€&ldquo;key encipherment&rdquo;ã€&ldquo;server auth&rdquo; å’Œ &ldquo;client auth&rdquo;ï¼Œä¹Ÿå°±æ˜¯è¯¥ profile é€‚ç”¨äºç”¨äºç­¾å‘å’ŒéªŒè¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŒæ—¶ä¹Ÿèƒ½ç”¨äºåŠ å¯†ä¼ è¾“æ•°æ®ã€‚è¯¥ profile çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ä¹Ÿè®¾ç½®ä¸º 876000 å°æ—¶ï¼Œä¸é»˜è®¤çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ç›¸åŒã€‚</p>
<blockquote>
<p>CAï¼Œå³è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertificate Authorityï¼‰ï¼Œæ˜¯æŒ‡è´Ÿè´£ç­¾å‘ã€ç®¡ç†å’ŒåŠé”€æ•°å­—è¯ä¹¦çš„å¯ä¿¡æœºæ„ã€‚åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œæ•°å­—è¯ä¹¦èµ·åˆ°éªŒè¯é€šä¿¡åŒæ–¹èº«ä»½çš„ä½œç”¨ï¼ŒCA åˆ™æ˜¯è´Ÿè´£é¢å‘æ•°å­—è¯ä¹¦ï¼Œä»¥åŠéªŒè¯è¯ä¹¦çš„çœŸå®æ€§å’Œæœ‰æ•ˆæ€§ã€‚</p>
<p>CA é€šå¸¸ç”±æ”¿åºœã€å†›é˜Ÿã€é‡‘èæœºæ„ç­‰å…·æœ‰ä¸€å®šä¿¡èª‰å’Œå®‰å…¨ä¿éšœèƒ½åŠ›çš„æœºæ„æ‰€æ‹…ä»»ï¼Œä»¥ç¡®ä¿æ•°å­—è¯ä¹¦çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚é€šè¿‡ä½¿ç”¨CAï¼Œæ•°å­—è¯ä¹¦çš„é¢å‘å’ŒéªŒè¯å¾—ä»¥å½¢æˆä¸€ä¸ªé—­ç¯ï¼Œä½¿å¾—ç½‘ç»œé€šä¿¡è¿‡ç¨‹æ›´åŠ å®‰å…¨å’Œå¯é ã€‚</p>
</blockquote>
<pre><code class="language-shell">$ cat &gt; ca-config.json &lt;&lt; EOF 
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;876000h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;876000h&quot;
      }
    }
  }
}
EOF
</code></pre>
<p>ä¸‹é¢è¿™æ®µ shell æ˜¯ç”¨äºåˆ›å»º etcd CA è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œ&ldquo;CN&rdquo; æ˜¯è¯ä¹¦çš„é€šç”¨åç§°ï¼Œ&ldquo;key&rdquo; å®šä¹‰äº†åŠ å¯†ç®—æ³•å’Œå¯†é’¥é•¿åº¦ï¼Œ&ldquo;names&rdquo; åˆ—å‡ºäº†è¯ä¹¦çš„ä¸»é¢˜ï¼Œ&ldquo;ca&rdquo; å®šä¹‰äº†è¯ä¹¦é¢å‘æœºæ„çš„è¿‡æœŸæ—¶é—´ã€‚è¯¥æ–‡ä»¶ä¼šè¢«ç”¨äºç”Ÿæˆ etcd CA è¯ä¹¦ï¼Œç”¨äºç­¾å‘å’Œç®¡ç† etcd é›†ç¾¤ä¸­çš„å…¶ä»–è¯ä¹¦ï¼Œä¿è¯é›†ç¾¤é€šä¿¡çš„å®‰å…¨æ€§ã€‚</p>
<pre><code class="language-shell">$ cat &gt; etcd-ca-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;Etcd Security&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF
</code></pre>
<h3 id="è¿™éƒ¨åˆ†ç›´æ¥çœ‹è¿™é‡Œ">è¿™éƒ¨åˆ†ç›´æ¥çœ‹è¿™é‡Œ</h3>
<blockquote>
<p>å‘ç°è¿™éƒ¨åˆ† shell æœ‰ç‚¹å¤šï¼Œæ‡’å¾—ä¸€ä¸ªä¸€ä¸ªé—® ChatGPT ä»€ä¹ˆæ„æ€äº†ï¼Œæš‚æ—¶ä¹Ÿä¸å…³æ³¨è¿™äº›è¯ä¹¦ç›¸å…³çš„ä¸œè¥¿äº†ã€‚ã€‚ã€‚</p>
</blockquote>
<p>ç›´æ¥å°†ä¸‹é¢è¿™äº›å‘½ä»¤å¤åˆ¶åˆ° terminal å›è½¦å³å¯ï¼Œä¼šä¸€å¹¶åˆ›å»ºè¿™äº›æ–‡ä»¶ã€‚</p>
<pre><code class="language-shell">cat &gt; admin-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
cat &gt; ca-config.json &lt;&lt; EOF 
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;876000h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;876000h&quot;
      }
    }
  }
}
EOF
cat &gt; etcd-ca-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;Etcd Security&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF
cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
     &quot;algo&quot;: &quot;rsa&quot;,
     &quot;size&quot;: 2048
  },
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF
cat &gt; kubelet-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;system:node:\$NODE&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:nodes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
cat &gt; manager-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
cat &gt; apiserver-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;kube-apiserver&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;Kubernetes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
cat &gt; ca-csr.json   &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;Kubernetes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF
cat &gt; etcd-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;Etcd Security&quot;
    }
  ]
}
EOF
cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;front-proxy-client&quot;,
  &quot;key&quot;: {
     &quot;algo&quot;: &quot;rsa&quot;,
     &quot;size&quot;: 2048
  }
}
EOF
cat &gt; kube-proxy-csr.json  &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-proxy&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
cat &gt; scheduler-csr.json &lt;&lt; EOF 
{
  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-scheduler&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF
</code></pre>
<p>ç»§ç»­å¤åˆ¶æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚</p>
<pre><code class="language-shell">cd ..
mkdir bootstrap
cd bootstrap
cat &gt; bootstrap.secret.yaml &lt;&lt; EOF 
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: &quot;The default bootstrap token generated by 'kubelet '.&quot;
  token-id: c8ad9c
  token-secret: 2e4d610cf3e7426e
  usage-bootstrap-authentication: &quot;true&quot;
  usage-bootstrap-signing: &quot;true&quot;
  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubelet-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-bootstrapper
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-certificate-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - &quot;*&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
EOF
</code></pre>
<p>è¿™äº› Kubernetes é…ç½®åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li><code>bootstrap-token-c8ad9c</code>: ç”¨äºå¯åŠ¨ Kubernetes é›†ç¾¤çš„é»˜è®¤å¼•å¯¼ä»¤ç‰ŒåŠå…¶ç›¸å…³æƒé™ä¿¡æ¯ï¼ŒåŒ…æ‹¬æè¿°ä¿¡æ¯ã€ä»¤ç‰Œ IDã€ä»¤ç‰Œå¯†é’¥ä»¥åŠç”¨äºå¯åŠ¨è®¤è¯å’Œç­¾åç­‰æƒé™çš„æ ‡å¿—ã€‚</li>
<li><code>kubelet-bootstrap</code> ClusterRoleBindingï¼šå°† <code>system:node-bootstrapper</code> ClusterRole åˆ†é…ç»™ <code>system:bootstrappers:default-node-token</code> ç»„ï¼Œä»¥ä¾¿å…è®¸èŠ‚ç‚¹ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚</li>
<li><code>node-autoapprove-bootstrap</code> ClusterRoleBindingï¼šè‡ªåŠ¨æ‰¹å‡†ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå‘å‡ºçš„èŠ‚ç‚¹å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ã€‚</li>
<li><code>node-autoapprove-certificate-rotation</code> ClusterRoleBindingï¼šè‡ªåŠ¨æ‰¹å‡†ç”¨äºè‡ªç­¾åèŠ‚ç‚¹è¯ä¹¦è½®æ¢çš„ç­¾åè¯·æ±‚ã€‚</li>
<li><code>system:kube-apiserver-to-kubelet</code> ClusterRoleï¼šå®šä¹‰äº†ä¸€ä¸ªè§’è‰²ï¼Œè¯¥è§’è‰²å…è®¸ kube-apiserver è®¿é—® kubelet APIï¼Œä»¥ä¾¿å¯ä»¥ä» kube-apiserver å‘é€è¯·æ±‚åˆ°èŠ‚ç‚¹çš„ kubelet APIï¼Œä»¥è·å–èŠ‚ç‚¹ä¿¡æ¯å’Œæ‰§è¡Œæ“ä½œã€‚</li>
<li><code>system:kube-apiserver</code> ClusterRoleBindingï¼šå°† <code>system:kube-apiserver-to-kubelet</code> ClusterRole åˆ†é…ç»™ kube-apiserver ç”¨æˆ·ï¼Œä»¥ä¾¿åœ¨æ•´ä¸ª Kubernetes é›†ç¾¤èŒƒå›´å†…å…è®¸ kube-apiserver è®¿é—® kubelet APIã€‚</li>
</ol>
<h2 id="etcd-è¯ä¹¦">ETCD è¯ä¹¦</h2>
<blockquote>
<p>æœ¬èŠ‚æ“ä½œåªéœ€è¦ master èŠ‚ç‚¹æ‰§è¡Œå³å¯ã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºè¯ä¹¦æ–‡ä»¶">åˆ›å»ºè¯ä¹¦æ–‡ä»¶</h3>
<p>åˆ›å»ºç”¨äºå­˜æ”¾è¯ä¹¦çš„æ–‡ä»¶å¤¹</p>
<p>PSï¼šå› ä¸ºæˆ‘åªæœ‰ä¸€ä¸ªæ§åˆ¶é¢èŠ‚ç‚¹ k8s-masterï¼Œè€Œ etcd åªéœ€è¦éƒ¨ç½²åœ¨æ§åˆ¶é¢å³å¯ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨å…¶ä»–èŠ‚ç‚¹æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œç›´æ¥åœ¨æœ¬èŠ‚ç‚¹åˆ›å»º</p>
<p><del>for i in k8s-master k8s-worker1 k8s-worker2;do</del>
<del>ssh root@$i mkdir /etc/etcd/ssl -p</del>
<del>echo $i create done</del>
<del>done</del></p>
<pre><code class="language-shell">mkdir /etc/etcd/ssl -p
</code></pre>
<h3 id="ç”Ÿæˆ-etcd-è¯ä¹¦å’Œ-etcd-è¯ä¹¦çš„-key">ç”Ÿæˆ etcd è¯ä¹¦å’Œ etcd è¯ä¹¦çš„ key</h3>
<pre><code class="language-shell">$ cd pki
$ cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca
</code></pre>
<p>æ³¨æ„ <code>-hostname</code> è¿™é‡Œçš„å‚æ•°ï¼Œæ”¹æˆä½ å¯¹åº” master èŠ‚ç‚¹çš„ hostname å’Œ IPï¼Œåˆ«ç›´æ¥ cv è¿‡æ¥å°±æ‰§è¡Œï¼Œå¦‚æœä½ ä¸å°å¿ƒæ‰§è¡Œé”™äº†ï¼ˆå’Œæˆ‘ä¸€æ ·æ²¡æ³¨æ„ï¼Œç›´æ¥ cv è¿‡æ¥å°±æ‰§è¡Œï¼Œå¯¼è‡´åç»­ etcd ä¸è®¤è¿™ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œç›´æ¥ä¿®æ”¹ä¸‹é¢çš„ shell åå†é‡æ–°æ‰§è¡Œä¸€éå³å¯</p>
<pre><code class="language-shell">$ cfssl gencert \
   -ca=/etc/etcd/ssl/etcd-ca.pem \
   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \
   -config=ca-config.json \
   -hostname=k8s-master,192.168.223.128 \
   -profile=kubernetes \
   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
</code></pre>
<p>æ‰§è¡Œå®Œæˆåï¼Œå°†ä¼šåœ¨ <code>/etc/etcd/ssl</code> ç›®å½•ä¸‹ç”Ÿæˆè¿™äº›è¯ä¹¦æ–‡ä»¶ï¼š</p>
<pre><code class="language-shell">$ ls /etc/etcd/ssl
etcd-ca.csr  etcd-ca-key.pem  etcd-ca.pem  etcd.csr  etcd-key.pem  etcd.pem
</code></pre>
<h3 id="å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹">å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹</h3>
<p>æˆ‘çš„å•èŠ‚ç‚¹æ§åˆ¶é¢ç”¨ä¸ä¸Šäº†</p>
<p><del>for i in k8s-worker1 k8s-worker2;do</del>
<del>ssh $i &ldquo;mkdir -p /etc/etcd/ssl&rdquo;</del>
<del>scp /etc/etcd/ssl/* $i:/etc/etcd/ssl/</del>
<del>done</del></p>
<h2 id="k8s-é›†ç¾¤è¯ä¹¦">k8s é›†ç¾¤è¯ä¹¦</h2>
<blockquote>
<p>æœ¬èŠ‚æ“ä½œåªéœ€è¦ master èŠ‚ç‚¹æ‰§è¡Œå³å¯ã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºæ‰€æœ‰è¯ä¹¦çš„å­˜æ”¾ç›®å½•">åˆ›å»ºæ‰€æœ‰è¯ä¹¦çš„å­˜æ”¾ç›®å½•</h3>
<pre><code class="language-shell">$ mkdir -p /etc/kubernetes/pki
</code></pre>
<h3 id="ç”Ÿæˆä¸€ä¸ªæ ¹è¯ä¹¦">ç”Ÿæˆä¸€ä¸ªæ ¹è¯ä¹¦</h3>
<pre><code class="language-shell">$ cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca
</code></pre>
<h3 id="åˆ›å»º-api-server-å‡­è¯ä¸ç§é’¥">åˆ›å»º API Server å‡­è¯ä¸ç§é’¥</h3>
<p>10.96.0.1 æ˜¯ service ç½‘æ®µçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œhostname ä¸­æŒ‡å®šäº†ç”Ÿæˆçš„è¯ä¹¦çš„ Subject Alternative Names (SANs)ï¼Œå³è¯ä¹¦å…è®¸è¢«ä½¿ç”¨çš„ä¸»æœºåæˆ– IP åœ°å€ï¼Œè¿™é‡Œæˆ‘å¡«å†™äº† 3 å°è™šæ‹Ÿæœºçš„ hostname å’Œ IP</p>
<pre><code class="language-shell">$ cfssl gencert   \
-ca=/etc/kubernetes/pki/ca.pem   \
-ca-key=/etc/kubernetes/pki/ca-key.pem   \
-config=ca-config.json   \
-hostname=10.96.0.1,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,k8s-master,k8s-worker1,k8s-worker2,192.168.223.128,192.168.223.129,192.168.223.130   \
-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</code></pre>
<h3 id="ç”Ÿæˆ-apiserver">ç”Ÿæˆ apiserver</h3>
<pre><code class="language-shell">$ cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 

$ cfssl gencert  \
-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \
-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \
-config=ca-config.json   \
-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre>
<h3 id="ç”Ÿæˆ-controller-manage-è¯ä¹¦">ç”Ÿæˆ controller-manage è¯ä¹¦</h3>
<p>æ³¨æ„æ›¿æ¢ä¸‹é¢å‘½ä»¤ä¸­çš„ &ndash;serverï¼ŒIP å¡«å†™ api-server çš„ IPï¼Œåœ¨æˆ‘è¿™é‡Œæ˜¯ master èŠ‚ç‚¹çš„ IPï¼Œç«¯å£å¡«å†™ api-server çš„ portï¼Œè¿™ä¸ªå€¼åœ¨ api server é…ç½®ä¸­çš„ &ndash;secure-port=6443 æŒ‡å®š</p>
<blockquote>
<p>ç–‘é—®ï¼š</p>
<p>æˆ‘è¿™é‡Œåªæœ‰ä¸€ä¸ª master èŠ‚ç‚¹ï¼Œæ‰€ä»¥ api-server çš„ IP å°±æ˜¯è¯¥ master èŠ‚ç‚¹çš„ IPï¼Œé‚£å¦‚æœéƒ¨ç½²æ–¹å¼æ˜¯å¤šä¸ª master èŠ‚ç‚¹ï¼Œæ­¤æ—¶ api-server çš„ IP åˆè¯¥å¦‚ä½•å¡«å†™å‘¢ï¼Ÿ</p>
</blockquote>
<pre><code class="language-shell">$ cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
   
   
# è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹
kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://192.168.223.128:6443 \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
# è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡
kubectl config set-context system:kube-controller-manager@kubernetes \
    --cluster=kubernetes \
    --user=system:kube-controller-manager \
    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
# è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹
kubectl config set-credentials system:kube-controller-manager \
     --client-certificate=/etc/kubernetes/pki/controller-manager.pem \
     --client-key=/etc/kubernetes/pki/controller-manager-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
# è®¾ç½®é»˜è®¤ç¯å¢ƒ
kubectl config use-context system:kube-controller-manager@kubernetes \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://192.168.223.128:6443 \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
kubectl config set-credentials system:kube-scheduler \
     --client-certificate=/etc/kubernetes/pki/scheduler.pem \
     --client-key=/etc/kubernetes/pki/scheduler-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
kubectl config set-context system:kube-scheduler@kubernetes \
     --cluster=kubernetes \
     --user=system:kube-scheduler \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
kubectl config use-context system:kube-scheduler@kubernetes \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://192.168.223.128:6443     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig
kubectl config set-credentials kubernetes-admin  \
  --client-certificate=/etc/kubernetes/pki/admin.pem     \
  --client-key=/etc/kubernetes/pki/admin-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig
kubectl config set-context kubernetes-admin@kubernetes    \
  --cluster=kubernetes     \
  --user=kubernetes-admin     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig
kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig
</code></pre>
<h3 id="ç”Ÿæˆ-kube-proxy-è¯ä¹¦">ç”Ÿæˆ kube-proxy è¯ä¹¦</h3>
<p>æ³¨æ„æ›¿æ¢ä¸‹é¢å‘½ä»¤ä¸­çš„ &ndash;server</p>
<pre><code class="language-shell">cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy
kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://192.168.223.128:6443     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
kubectl config set-credentials kube-proxy  \
  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \
  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
kubectl config set-context kube-proxy@kubernetes    \
  --cluster=kubernetes     \
  --user=kube-proxy     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
</code></pre>
<h3 id="åˆ›å»º-serviceaccount-key">åˆ›å»º ServiceAccount Key</h3>
<pre><code class="language-shell">$ openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
$ openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</code></pre>
<p>å…¶ä»–èŠ‚ç‚¹åˆ›å»ºç›®å½•</p>
<pre><code class="language-shell">for i in k8s-worker1 k8s-worker2;do    
	ssh $i &quot;mkdir  /etc/kubernetes/pki/ -p&quot;    
	scp -r /etc/kubernetes/pki $i:/etc/kubernetes/
done
</code></pre>
<h3 id="æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦">æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦</h3>
<pre><code class="language-shell">$ ls /etc/kubernetes/pki/
admin.csr          ca.csr                      front-proxy-ca.csr          kube-proxy.csr      scheduler-key.pem
admin-key.pem      ca-key.pem                  front-proxy-ca-key.pem      kube-proxy-key.pem  scheduler.pem
admin.pem          ca.pem                      front-proxy-ca.pem          kube-proxy.pem
apiserver.csr      controller-manager.csr      front-proxy-client.csr      sa.key
apiserver-key.pem  controller-manager-key.pem  front-proxy-client-key.pem  sa.pub
apiserver.pem      controller-manager.pem      front-proxy-client.pem      scheduler.csr

# ä¸€å…± 26 ä¸ªå°±å¯¹äº†
$ ls /etc/kubernetes/pki/ |wc -l
26
</code></pre>
<h2 id="é…ç½®-etcd">é…ç½® ETCD</h2>
<h3 id="master-èŠ‚ç‚¹">master èŠ‚ç‚¹</h3>
<p>åœ¨ master èŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„ shellï¼Œæ³¨æ„å°†é…ç½®é‡Œçš„ IP æ”¹ä¸º master èŠ‚ç‚¹çš„ IPï¼Œhostname ä¹Ÿè¦ä¿®æ”¹æˆå¯¹åº”çš„ï¼Œinitial-cluster ä¿®æ”¹æˆå¯¹åº”çš„å‡ ä¸ªèŠ‚ç‚¹</p>
<pre><code class="language-shell"># å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯
cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.223.128:2380'
listen-client-urls: 'https://192.168.223.128:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.223.128:2380'
advertise-client-urls: 'https://192.168.223.128:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master=https://192.168.223.128:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h3 id="k8s-worker1-èŠ‚ç‚¹"><del>k8s-worker1 èŠ‚ç‚¹</del></h3>
<pre><code class="language-shell"># å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯
cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-worker1'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.223.129:2380'
listen-client-urls: 'https://192.168.223.129:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.223.129:2380'
advertise-client-urls: 'https://192.168.223.129:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h3 id="k8s-worker2-èŠ‚ç‚¹"><del>k8s-worker2 èŠ‚ç‚¹</del></h3>
<pre><code class="language-shell"># å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯
cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-worker2'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.223.130:2380'
listen-client-urls: 'https://192.168.223.130:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.223.130:2380'
advertise-client-urls: 'https://192.168.223.130:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<p>åˆ›å»º etcd å¯åŠ¨æœåŠ¡ï¼ˆéœ€è¦åœ¨æ‰€æœ‰ master èŠ‚ç‚¹æ“ä½œï¼‰</p>
<pre><code class="language-shell">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF
[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target
[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target
Alias=etcd3.service
EOF
</code></pre>
<p>æ‹·è´ ETCD è¯ä¹¦</p>
<pre><code class="language-shell">mkdir /etc/kubernetes/pki/etcd
ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl enable --now etcd
</code></pre>
<p>æŸ¥çœ‹ etcd çŠ¶æ€</p>
<pre><code class="language-shell">$ etcdctl --endpoints=&quot;k8s-master:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table
</code></pre>
<blockquote>
<p>ä¹‹å‰çš„é…ç½®æ–‡ä»¶å†™é”™äº†ï¼Œåº”è¯¥åªæœ‰ master èŠ‚ç‚¹éœ€è¦è¿è¡Œ etcdï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­çš„ initial-cluster éœ€è¦æ”¹ä¸º k8s-master=https://192.168.223.128:2380&rsquo;ï¼Œä¹Ÿå°±æ˜¯åªæ·»åŠ  master æœ¬èº«å³å¯ï¼Œåˆ æ‰ä¹‹å‰åŠ å…¥çš„ä¸¤ä¸ª worker èŠ‚ç‚¹ï¼Œä¿®æ”¹ä¸ºï¼š</p>
<p><code>initial-cluster: 'k8s-master=https://192.168.223.128:2380'</code></p>
<p>ç„¶åæ‰§è¡Œ</p>
<pre><code class="language-shell">$ systemctl daemon-reload
$ sudo systemctl restart etcd
</code></pre>
<p>é‡æ–°è¿è¡Œ etcdï¼Œä½†æ˜¯å‘ç°æ— æ³•è¿è¡Œï¼Œæ‰‹åŠ¨æ‰§è¡Œ etcd &ndash;config-file=/etc/etcd/etcd.config.ymlï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ <code>sudo journalctl -u etcd</code>ï¼‰ï¼Œå‘ç°æ—¥å¿—é‡Œè¾“å‡º &ldquo;error&rdquo;:&ldquo;dial tcp 192.168.223.129:2380: connect: connection refused&rdquo;ï¼Œè¿™è¡¨ç¤º etcd ä¾æ—§åœ¨å°è¯•è¿æ¥ worker1 çš„ etcdï¼Œæ˜æ˜æ”¹äº† initial-clusterï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆå‘¢ï¼Ÿ</p>
<p>æˆ‘é‡æ–°æ’æŸ¥æ—¥å¿—ï¼Œå‘ç°æœ‰è¿™ä¹ˆä¸€è¡Œæœ‰ç‚¹å¯ç–‘ï¼š</p>
<p>{&ldquo;level&rdquo;:&ldquo;info&rdquo;,&ldquo;ts&rdquo;:&ldquo;2023-04-15T16:58:41.252Z&rdquo;,&ldquo;caller&rdquo;:&ldquo;etcdmain/etcd.go:116&rdquo;,&ldquo;msg&rdquo;:&ldquo;server has been already initialized&rdquo;,&ldquo;data-dir&rdquo;:&quot;/var/lib/etcd&quot;,&ldquo;dir-type&rdquo;:&ldquo;member&rdquo;}</p>
<p>å°è¯•åˆ æ‰ /var/lib/etcd/memberï¼Œå†æ¬¡æ‰§è¡Œ sudo systemctl restart etcdï¼Œå‘ç°å‘½ä»¤ä¸ä¼šé˜»å¡äº†ï¼Œetcd æˆåŠŸè¿è¡Œã€‚ï¼ˆæ­¤æ—¶æˆ‘åªæƒ³å¤¸è‡ªå·±ä¸€å¥ç‰›é€¼ plusï¼‰</p>
</blockquote>
<p>å¦‚æœè¾“å‡ºä¸‹é¢è¿™äº›å†…å®¹ï¼Œè¯´æ˜ä½ æå¯¹äº†</p>
<pre><code class="language-shell">+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| k8s-master:2379 | 2918d818e481030f |   3.5.4 |   20 kB |      true |      false |         5 |         10 |                 10 |        |
+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre>
<h2 id="apiserver-é…ç½®">ApiServer é…ç½®</h2>
<p>åˆ›å»º apiserver æœåŠ¡å¯åŠ¨æ–‡ä»¶</p>
<p>éœ€è¦åœ¨æ¯å°èŠ‚ç‚¹è‡ªè¡Œä¿®æ”¹å¯¹åº”çš„ä¿¡æ¯</p>
<ul>
<li>&ndash;advertise-address å½“å‰èŠ‚ç‚¹ IP</li>
<li>&ndash;etcd-servers ETCD èŠ‚ç‚¹ä¿¡æ¯</li>
<li>&ndash;secure-port apiserver ç«¯å£å·</li>
</ul>
<pre><code class="language-shell">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target
[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --logtostderr=true  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.223.128 \
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108  \
      --feature-gates=IPv6DualStack=true  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://k8s-master:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User \
      --enable-aggregator-routing=true
      # --token-auth-file=/etc/kubernetes/token.csv
Restart=on-failure
RestartSec=10s
LimitNOFILE=65535
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>å¯åŠ¨ apiserverï¼ˆæ‰€æœ‰ master èŠ‚ç‚¹ï¼‰</p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do</del>
<del>ssh $i &ldquo;systemctl daemon-reload &amp;&amp; systemctl enable &ndash;now kube-apiserver&rdquo;</del>
<del>echo &ldquo;$i&rdquo;</del>
<del>sleep 5</del>
<del>ssh $i &ldquo;systemctl status kube-apiserver&rdquo;</del>
<del>done</del></p>
<p>å• master èŠ‚ç‚¹åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„ï¼š</p>
<pre><code class="language-shell">$ systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver
$ sleep 5
$ systemctl status kube-apiserver
</code></pre>
<p>å¦‚æœè¾“å‡ºç±»ä¼¼è¿™æ ·ï¼Œå³ Active: active (running)ï¼Œåˆ™ä»£è¡¨æˆåŠŸ</p>
<pre><code class="language-shell">â— kube-apiserver.service - Kubernetes API Server
     Loaded: loaded (/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2023-04-15 18:01:27 UTC; 6s ago
       Docs: https://github.com/kubernetes/kubernetes
   Main PID: 54969 (kube-apiserver)
      Tasks: 15 (limit: 9362)
     Memory: 290.8M
        CPU: 3.201s
</code></pre>
<h2 id="controller-manage-é…ç½®">Controller-Manage é…ç½®</h2>
<p>172.16.0.0/12 ä¸º pod ç½‘æ®µï¼ŒæŒ‰éœ€æ±‚è®¾ç½®ä½ è‡ªå·±çš„ç½‘æ®µ</p>
<pre><code class="language-shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target
[Service]
ExecStart=/usr/local/bin/kube-controller-manager \
      --v=2 \
      --logtostderr=true \
      --bind-address=127.0.0.1 \
      --root-ca-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --leader-elect=true \
      --use-service-account-credentials=true \
      --node-monitor-grace-period=40s \
      --node-monitor-period=5s \
      --pod-eviction-timeout=2m0s \
      --controllers=*,bootstrapsigner,tokencleaner \
      --allocate-node-cidrs=true \
      --feature-gates=IPv6DualStack=true \
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108 \
      --cluster-cidr=172.16.0.0/12,fc00::/48 \
      --node-cidr-mask-size-ipv4=24 \
      --node-cidr-mask-size-ipv6=64 \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem 
Restart=always
RestartSec=10s
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p><strong>é…ç½®æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹</strong></p>
<p><del>for i in k8s-02 k8s-03;do <br>
scp /usr/lib/systemd/system/kube-controller-manager.service  $i:/usr/lib/systemd/system/    	scp /etc/kubernetes/controller-manager.kubeconfig  $i:/etc/kubernetes/</del>
<del>done</del></p>
<p>æˆ‘è¿™è¾¹å°±ç”¨ä¸ç€äº†</p>
<p><strong>å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡</strong></p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do</del>
<del>ssh $i &ldquo;systemctl daemon-reload &amp;&amp; systemctl enable &ndash;now kube-controller-manager &amp;&amp; systemctl  status kube-controller-manager&rdquo;</del>
<del>done</del></p>
<p>æˆ‘è¿™é‡Œä¹Ÿç”¨ä¸ç€äº†ï¼Œåªéœ€è¦æ‰§è¡Œä¸‹é¢è¿™æ®µå³å¯</p>
<pre><code class="language-shell">$ systemctl daemon-reload &amp;&amp; systemctl enable --now kube-controller-manager &amp;&amp; systemctl  status kube-controller-manager
</code></pre>
<p>è¾“å‡ºç±»ä¼¼ä¸‹é¢è¿™æ ·</p>
<pre><code class="language-shell">Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service â†’ /lib/systemd/system/kube-controller-manager.service.
â— kube-controller-manager.service - Kubernetes Controller Manager
     Loaded: loaded (/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2023-04-15 18:14:05 UTC; 5ms ago
       Docs: https://github.com/kubernetes/kubernetes
   Main PID: 55081 (kube-controller)
      Tasks: 6 (limit: 9362)
     Memory: 1.6M
        CPU: 3ms
</code></pre>
<h2 id="scheduler-é…ç½®">Scheduler é…ç½®</h2>
<pre><code class="language-shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target
[Service]
ExecStart=/usr/local/bin/kube-scheduler \
      --v=2 \
      --logtostderr=true \
      --bind-address=127.0.0.1 \
      --leader-elect=true \
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
Restart=always
RestartSec=10s
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p><del>é…ç½®æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹</del></p>
<p><del>for i in k8s-02 k8s-03;do <br>
scp /usr/lib/systemd/system/kube-scheduler.service  $i:/usr/lib/systemd/system/ <br>
scp /etc/kubernetes/scheduler.kubeconfig $i:/etc/kubernetes/</del>
<del>done</del></p>
<p>å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡</p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do   <br>
ssh $i &ldquo;systemctl daemon-reload &amp;&amp; systemctl enable &ndash;now kube-scheduler &amp;&amp; systemctl  status kube-scheduler&rdquo;</del>
<del>done</del></p>
<pre><code class="language-shell">$ systemctl daemon-reload &amp;&amp; systemctl enable --now kube-scheduler &amp;&amp; systemctl  status kube-scheduler
</code></pre>
<h2 id="ä¸Šä¸‹æ–‡é…ç½®">ä¸Šä¸‹æ–‡é…ç½®</h2>
<pre><code class="language-shell">cd /root/bootstrap
kubectl config set-cluster kubernetes     \
--certificate-authority=/etc/kubernetes/pki/ca.pem     \
--embed-certs=true     
--server=https://192.168.223.128:6443     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-credentials tls-bootstrap-token-user     \
--token=c8ad9c.2e4d610cf3e7426e \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-context tls-bootstrap-token-user@kubernetes     \
--cluster=kubernetes     \
--user=tls-bootstrap-token-user     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config use-context tls-bootstrap-token-user@kubernetes     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
# tokençš„ä½ç½®åœ¨bootstrap.secret.yamlï¼Œå¦‚æœä¿®æ”¹çš„è¯åˆ°è¿™ä¸ªæ–‡ä»¶ä¿®æ”¹
mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre>
<p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p>
<pre><code class="language-shell">$ kubectl get cs

# è¿™æ ·å°±å¯¹äº†
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-0               Healthy   {&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;}
</code></pre>
<p>æ‰§è¡Œ</p>
<pre><code class="language-shell">$ kubectl create -f bootstrap.secret.yaml
</code></pre>
<h2 id="kubelet">kubelet</h2>
<h3 id="åˆ›å»º-kubelet-å¯åŠ¨æ–‡ä»¶">åˆ›å»º kubelet å¯åŠ¨æ–‡ä»¶</h3>
<pre><code class="language-shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service
[Service]
ExecStart=/usr/local/bin/kubelet \
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
    --config=/etc/kubernetes/kubelet-conf.yml \
    --container-runtime=remote  \
    --runtime-request-timeout=15m  \
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \
    --cgroup-driver=systemd \
    --node-labels=node.kubernetes.io/node='' \
    --feature-gates=IPv6DualStack=true
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h3 id="åˆ›å»º-kubelet-é…ç½®æ–‡ä»¶">åˆ›å»º kubelet é…ç½®æ–‡ä»¶</h3>
<pre><code class="language-shell">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
EOF
</code></pre>
<h3 id="æ‹·è´è¯ä¹¦åˆ°å…¶å®ƒèŠ‚ç‚¹"><del>æ‹·è´è¯ä¹¦åˆ°å…¶å®ƒèŠ‚ç‚¹</del></h3>
<p><del>for i in k8s-01 k8s-02 k8s-03;do<br>
ssh $i &ldquo;mkdir -p /var/lib/kubelet /var/log/kubernetes  /etc/kubernetes/manifests/&rdquo;   		scp /etc/kubernetes/kubelet-conf.yml $i:/etc/kubernetes/<br>
scp /usr/lib/systemd/system/kubelet.service  $i:/usr/lib/systemd/system/<br>
scp /etc/kubernetes/bootstrap-kubelet.kubeconfig $i:/etc/kubernetes/</del>
<del>done</del></p>
<pre><code class="language-shell">$ mkdir -p /var/lib/kubelet /var/log/kubernetes  /etc/kubernetes/manifests/
</code></pre>
<h3 id="å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</h3>
<pre><code class="language-shell">systemctl daemon-reload
systemctl enable --now kubelet
systemctl status kubelet
</code></pre>
<h3 id="æŸ¥çœ‹é›†ç¾¤">æŸ¥çœ‹é›†ç¾¤</h3>
<pre><code class="language-shell">$ kubectl get node

No resources found
</code></pre>
<p>å¤±è´¥äº†ã€‚ã€‚ã€‚æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://i4t.com/5636.html">https://i4t.com/5636.html</a></p>

</article>


      
        <div class="my-4">
    
    <a href="/tags/k8s/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#k8s</a>
    
</div>
      

      



      

      
  <div
    class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"
  >
    <div>
      
        <span class="text-primary-text block font-bold"
          >ä¸Šä¸€é¡µ</span
        >
        <a href="/posts/zhuangji-jilu/" class="block">è£…æœºè®°å½•</a>
      
    </div>
    <div class="mt-4 md:mt-0 md:text-right">
      
        <span class="text-primary-text block font-bold">ä¸‹ä¸€é¡µ</span>
        <a href="/posts/nginx-practice/" class="block">é€šè¿‡å®è·µå­¦ä¹  Nginx</a>
      
    </div>
  </div>


      



  <div id="valine-comments" class="mt-4"></div>
<script defer src="https://cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js" 
  integrity="sha384-e0&#43;DNUCJo75aOAzHQbFWYBCM9/S4f0BhRJXvEgbE3mMS85RM20MSSGStHuNdY2QK"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    new Valine({
      el: "#valine-comments",appId:"6KXGn05vaODkTMKM7zd5lWwl-gzGzoHsz",appKey:"qIMQwH4WrxTe8ds3Ua4HAbet",
    })
  });
</script>

    </div>
    
      <div class="col-span-2">
        
        
          <div
  class="
    bg-primary-bg
   prose sticky top-16 z-10 hidden px-6 py-4 lg:block"
>
  <h3>æœ¬é¡µå†…å®¹</h3>
</div>
<div
  class="sticky-toc  hidden px-6 pb-6 lg:block"
>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ç¯å¢ƒ">ç¯å¢ƒ</a></li>
    <li><a href="#åŸºç¡€ç¯å¢ƒå‡†å¤‡">åŸºç¡€ç¯å¢ƒå‡†å¤‡</a>
      <ul>
        <li><a href="#é…ç½®-hosts">é…ç½® hosts</a></li>
        <li><a href="#é…ç½®å…å¯†ç™»å½•">é…ç½®å…å¯†ç™»å½•</a></li>
        <li><a href="#å…³é—­é˜²ç«å¢™">å…³é—­é˜²ç«å¢™</a></li>
        <li><a href="#å…³é—­äº¤æ¢åˆ†åŒº">å…³é—­äº¤æ¢åˆ†åŒº</a></li>
        <li><a href="#è®¾ç½®æ—¶é—´åŒæ­¥">è®¾ç½®æ—¶é—´åŒæ­¥</a></li>
        <li><a href="#å®‰è£…-docker">å®‰è£… Docker</a></li>
        <li><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-containerd">æ‰€æœ‰èŠ‚ç‚¹å®‰è£… Containerd</a></li>
      </ul>
    </li>
    <li><a href="#k8s-ç¯å¢ƒéƒ¨ç½²">k8s ç¯å¢ƒéƒ¨ç½²</a>
      <ul>
        <li><a href="#ä¸‹è½½ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶">ä¸‹è½½ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶</a></li>
        <li><a href="#å‡†å¤‡ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾è¯ä¹¦é…ç½®æ–‡ä»¶">å‡†å¤‡ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾è¯ä¹¦é…ç½®æ–‡ä»¶</a></li>
        <li><a href="#ä¸‹è½½é…ç½®-cfssl-è¯ä¹¦">ä¸‹è½½é…ç½® cfssl è¯ä¹¦</a></li>
        <li><a href="#åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶">åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶</a>
          <ul>
            <li><a href="#è¿™éƒ¨åˆ†ç›´æ¥çœ‹è¿™é‡Œ">è¿™éƒ¨åˆ†ç›´æ¥çœ‹è¿™é‡Œ</a></li>
          </ul>
        </li>
        <li><a href="#etcd-è¯ä¹¦">ETCD è¯ä¹¦</a>
          <ul>
            <li><a href="#åˆ›å»ºè¯ä¹¦æ–‡ä»¶">åˆ›å»ºè¯ä¹¦æ–‡ä»¶</a></li>
            <li><a href="#ç”Ÿæˆ-etcd-è¯ä¹¦å’Œ-etcd-è¯ä¹¦çš„-key">ç”Ÿæˆ etcd è¯ä¹¦å’Œ etcd è¯ä¹¦çš„ key</a></li>
            <li><a href="#å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹">å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹</a></li>
          </ul>
        </li>
        <li><a href="#k8s-é›†ç¾¤è¯ä¹¦">k8s é›†ç¾¤è¯ä¹¦</a>
          <ul>
            <li><a href="#åˆ›å»ºæ‰€æœ‰è¯ä¹¦çš„å­˜æ”¾ç›®å½•">åˆ›å»ºæ‰€æœ‰è¯ä¹¦çš„å­˜æ”¾ç›®å½•</a></li>
            <li><a href="#ç”Ÿæˆä¸€ä¸ªæ ¹è¯ä¹¦">ç”Ÿæˆä¸€ä¸ªæ ¹è¯ä¹¦</a></li>
            <li><a href="#åˆ›å»º-api-server-å‡­è¯ä¸ç§é’¥">åˆ›å»º API Server å‡­è¯ä¸ç§é’¥</a></li>
            <li><a href="#ç”Ÿæˆ-apiserver">ç”Ÿæˆ apiserver</a></li>
            <li><a href="#ç”Ÿæˆ-controller-manage-è¯ä¹¦">ç”Ÿæˆ controller-manage è¯ä¹¦</a></li>
            <li><a href="#ç”Ÿæˆ-kube-proxy-è¯ä¹¦">ç”Ÿæˆ kube-proxy è¯ä¹¦</a></li>
            <li><a href="#åˆ›å»º-serviceaccount-key">åˆ›å»º ServiceAccount Key</a></li>
            <li><a href="#æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦">æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦</a></li>
          </ul>
        </li>
        <li><a href="#é…ç½®-etcd">é…ç½® ETCD</a>
          <ul>
            <li><a href="#master-èŠ‚ç‚¹">master èŠ‚ç‚¹</a></li>
            <li><a href="#k8s-worker1-èŠ‚ç‚¹">k8s-worker1 èŠ‚ç‚¹</a></li>
            <li><a href="#k8s-worker2-èŠ‚ç‚¹">k8s-worker2 èŠ‚ç‚¹</a></li>
          </ul>
        </li>
        <li><a href="#apiserver-é…ç½®">ApiServer é…ç½®</a></li>
        <li><a href="#controller-manage-é…ç½®">Controller-Manage é…ç½®</a></li>
        <li><a href="#scheduler-é…ç½®">Scheduler é…ç½®</a></li>
        <li><a href="#ä¸Šä¸‹æ–‡é…ç½®">ä¸Šä¸‹æ–‡é…ç½®</a></li>
        <li><a href="#kubelet">kubelet</a>
          <ul>
            <li><a href="#åˆ›å»º-kubelet-å¯åŠ¨æ–‡ä»¶">åˆ›å»º kubelet å¯åŠ¨æ–‡ä»¶</a></li>
            <li><a href="#åˆ›å»º-kubelet-é…ç½®æ–‡ä»¶">åˆ›å»º kubelet é…ç½®æ–‡ä»¶</a></li>
            <li><a href="#æ‹·è´è¯ä¹¦åˆ°å…¶å®ƒèŠ‚ç‚¹">æ‹·è´è¯ä¹¦åˆ°å…¶å®ƒèŠ‚ç‚¹</a></li>
            <li><a href="#å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</a></li>
            <li><a href="#æŸ¥çœ‹é›†ç¾¤">æŸ¥çœ‹é›†ç¾¤</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
</div>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    enableStickyToc();
  });
</script>

        
      </div>
    

    
    
      <div
        class=" bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"
      >
        <h3>ç›¸å…³</h3>
        
          <a href="/posts/k8s-secret/" class="no-underline">k8s Secret</a>
          <br />
        
          <a href="/posts/client-go-yuan-ma/" class="no-underline">k8s client-go æºç é˜…è¯»</a>
          <br />
        
          <a href="/posts/kubebuilder/" class="no-underline">kubebuilder å®è·µ</a>
          <br />
        
          <a href="/posts/k8s-statefulset/" class="no-underline">k8s StatefulSet</a>
          <br />
        
          <a href="/posts/k8s-configmap/" class="no-underline">k8s ConfigMap</a>
          <br />
        
          <a href="/posts/k8s-namespace/" class="no-underline">k8s namespace</a>
          <br />
        
      </div>
    
  </div>

  
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
      });
    </script>

          </div>
        </div>
      
    </main>
    <footer class="pl-scrollbar">
      <div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text">&copy; 0000 <a>null</a>
 &middot;  Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
    </footer>
  </body>
</html>
