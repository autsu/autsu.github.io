[{"contents":"èƒŒæ™¯ Source æ˜¯ Watches() çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨ä¸€ç§äº‹ä»¶æºï¼Œå®é™…ç±»å‹æ˜¯ä¸€ä¸ª interfaceï¼ŒåŸå‹ï¼š\ntype Source interface { Start(context.Context, handler.EventHandler, workqueue.RateLimitingInterface, ...predicate.Predicate) error } åªæœ‰ä¸€ä¸ª Start æ–¹æ³•\nTODO: Start æ–¹æ³•å‚æ•°çš„ä½œç”¨ï¼Œåœ¨å“ªé‡Œè¢«è°ƒç”¨ï¼Œå¦‚ä½•å·¥ä½œ\nå®è·µ è€å®è¯´å…‰çœ‹æ³¨é‡Šè¯´æ˜è¿˜æ˜¯æŒºæ‡µé€¼çš„ï¼Œåœ¨ç½‘ä¸Šä¹Ÿæ‰¾ä¸åˆ°å¤ªå¤šç›¸å…³çš„å†…å®¹ï¼Œä¸å°‘åšå®¢è®²çš„éƒ½æ˜¯åæ¦‚å¿µæ€§è´¨çš„ï¼Œå¯¹ Source è¿™ä¸ªä¸œè¥¿è¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œä¸çŸ¥é“åˆ°åº•æ˜¯å¹²å˜›çš„ï¼Œå®é™…è¯¥æ€ä¹ˆä½¿ç”¨ã€‚æ„Ÿè§‰æƒ³è¦å¿«é€Ÿäº†è§£ä¸€ä¸ªåŠŸèƒ½çš„ç”¨é€”ï¼Œè¿˜æ˜¯æƒ³åŠæ³•åšä¸€ä¸ª demo æœ€é è°±ï¼Œä¸‹é¢æˆ‘å°±åšäº†ä¸€ä¸ª demoï¼Œé€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ª Source äº‹ä»¶æºï¼Œæ¥è¾¾åˆ°ç›‘å¬æ–‡ä»¶çš„ç›®çš„ï¼Œå½“ç›‘å¬çš„æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ Reconcileã€‚\né¦–å…ˆå…ˆå®šä¹‰ä¸€ä¸ª struct æ¥å®ç° Source æ¥å£ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\nsource.go package main import ( \u0026quot;context\u0026quot; \u0026quot;os\u0026quot; \u0026quot;time\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/types\u0026quot; \u0026quot;k8s.io/client-go/util/workqueue\u0026quot; \u0026quot;k8s.io/klog/v2\u0026quot; ctrl \u0026quot;sigs.k8s.io/controller-runtime\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/handler\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/predicate\u0026quot; ) type FileWatch struct { p string f *os.File q workqueue.RateLimitingInterface lastModTime time.Time } func NewFileWatch(filepath string) *FileWatch { fw := new(FileWatch) fw.p = filepath f, err := os.Open(filepath) if err != nil { panic(err) } fw.f = f stat, err := f.Stat() if err != nil { panic(err) } fw.lastModTime = stat.ModTime() return fw } func (f *FileWatch) Sync() { ticket := time.NewTicker(time.Second * 3) go func() { for { select { case \u0026lt;-ticket.C: modify, modTime, err := f.FileIsModify() if err != nil { return } if modify { // Add çš„å‚æ•°å¿…é¡»æ˜¯ ctrl.Request ç±»å‹çš„ï¼Œå…¶ä»–ç±»å‹ä¼šç›´æ¥è¢« controller ä¸¢å¼ƒ f.q.Add(ctrl.Request{NamespacedName: types.NamespacedName{Name: f.p}}) f.lastModTime = modTime } } } }() } func (f *FileWatch) FileIsModify() (bool, time.Time, error) { stat, err := os.Stat(f.p) if err != nil { return false, time.Time{}, err } if stat.ModTime().After(f.lastModTime) { return true, stat.ModTime(), nil } return false, stat.ModTime(), nil } func (f *FileWatch) Start(ctx context.Context, h handler.EventHandler, queue workqueue.RateLimitingInterface, p ...predicate.Predicate) error { klog.Info(\u0026quot;fileWatch start...\u0026quot;) f.q = queue go f.Sync() return nil } æ–‡ä»¶ç›‘å¬ç›¸å…³çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸è¯´æ˜äº†ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œè¿™é‡Œä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯ Sync() é‡Œçš„ f.q.Add(ctrl.Request{NamespacedName: types.NamespacedName{Name: f.p}}) è¿™ä¸€è¡Œï¼Œè¡¨ç¤ºå½“æ–‡ä»¶å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œæ·»åŠ ä¸€ä¸ª ctrl.Request åˆ°é˜Ÿåˆ—ä¸­ï¼ŒRequest çš„ Name æ˜¯è¯¥æ–‡ä»¶çš„è·¯å¾„ï¼Œç„¶ååœ¨ Start() é‡Œï¼Œæˆ‘ä»¬è¿è¡Œäº† Sync() è¿™ä¸ªå‡½æ•°ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé˜Ÿåˆ—é‡Œæ·»åŠ çš„å¯¹è±¡ä¸€å®šè¦æ˜¯ ctrl.Request ç±»å‹çš„ï¼Œå¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œä¼šç›´æ¥è¢«å†…éƒ¨ controller ä¸¢å¼ƒï¼Œå…·ä½“çš„ä»£ç åœ¨ controller-runtime/pkg/internal/controller/controller.go çš„ reconcileHandler å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š\nfunc (c *Controller) reconcileHandler(ctx context.Context, obj interface{}) { //.... // Make sure that the object is a valid request. // åœ¨è¿™é‡Œè¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ Request ç±»å‹ä¼šç›´æ¥ä¸¢å¼ƒ req, ok := obj.(reconcile.Request) if !ok { // As the item in the workqueue is actually invalid, we call // Forget here else we'd go into a loop of attempting to // process a work item that is invalid. c.Queue.Forget(obj) } æ¥ä¸‹æ¥ç¼–å†™è°ƒåç›¸å…³çš„ä»£ç ï¼š\nctrl.go package main import ( \u0026quot;context\u0026quot; corev1 \u0026quot;k8s.io/api/core/v1\u0026quot; \u0026quot;k8s.io/klog/v2\u0026quot; ctrl \u0026quot;sigs.k8s.io/controller-runtime\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/event\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/handler\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/predicate\u0026quot; ) type Ctrl struct { fw *FileWatch } func (c *Ctrl) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) { klog.Info(\u0026quot;new modify event, file path: \u0026quot;, req.String()) return ctrl.Result{}, nil } func (c *Ctrl) SetupWithManager(mgr ctrl.Manager) error { return ctrl.NewControllerManagedBy(mgr). // controller-runtime å¿…é¡»è¦æŒ‡å®šä¸€ç§ç›‘å¬çš„èµ„æºï¼Œå¦åˆ™æ— æ³•å¯åŠ¨ï¼Œè¿™é‡Œè®¾ç½®ä¸º Pod For(\u0026amp;corev1.Pod{}). Watches(c.fw, \u0026amp;handler.EnqueueRequestForObject{}). WithEventFilter(\u0026amp;predicate.Funcs{ // åœ¨è¿™é‡Œè®¾ç½®è¿‡æ»¤äº‹ä»¶ï¼Œåªç›‘å¬æŒ‡å®š namespace çš„ pod çš„åˆ›å»ºäº‹ä»¶ï¼Œ // è¿™é‡Œçš„ namespace æˆ‘éšä¾¿è®¾ç½®äº†ä¸€ä¸ªï¼Œè¿›è€Œå¯ä»¥è¾¾åˆ°å¿½ç•¥ Pod äº‹ä»¶çš„ç›®çš„ï¼Œ // å› ä¸ºæˆ‘ä»¬çš„ä¸»è¦ç›®çš„æ˜¯è§‚å¯Ÿè‡ªå®šä¹‰ Source çš„æ•ˆæœï¼Œæ‰€ä»¥å°½é‡é¿å…å…¶ä»–èµ„æºçš„å¹²æ‰° CreateFunc: func(e event.CreateEvent) bool { return e.Object.GetNamespace() == \u0026quot;UNKNOWN_NAMESPACE\u0026quot; }, }). Complete(c) } åœ¨ Reconcile ä¸­ï¼Œæˆ‘ä»¬åªä¼šç®€å•è¾“å‡ºä¸€æ¡æ—¥å¿—ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†æ–‡ä»¶ä¿®æ”¹äº‹ä»¶ï¼Œåœ¨ SetupWithManager ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº† Watches çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º fwï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ Sourceã€‚\næœ€åæ˜¯ä¸»å‡½æ•° main.goã€‚\nmain.go package main import ( \u0026quot;os\u0026quot; \u0026quot;k8s.io/klog/v2\u0026quot; ctrl \u0026quot;sigs.k8s.io/controller-runtime\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/client/config\u0026quot; \u0026quot;sigs.k8s.io/controller-runtime/pkg/manager\u0026quot; ) func main() { filepath := os.Getenv(\u0026quot;FILE_PATH\u0026quot;) if filepath == \u0026quot;\u0026quot; { panic(\u0026quot;file path can't be nil\u0026quot;) } cfg, err := config.GetConfig() if err != nil { klog.Error(err, \u0026quot;unable to get kubeconfig\u0026quot;) os.Exit(1) } mgr, err := manager.New(cfg, manager.Options{}) if err != nil { klog.Error(err, \u0026quot;unable to set up manager\u0026quot;) os.Exit(1) } if err := (\u0026amp;Ctrl{ fw: NewFileWatch(filepath), }).SetupWithManager(mgr); err != nil { klog.Error(err) os.Exit(1) } klog.Info(\u0026quot;starting manager\u0026quot;) if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil { klog.Error(err, \u0026quot;problem running manager\u0026quot;) os.Exit(1) } } ç„¶åæˆ‘ä»¬å¯åŠ¨æ•´ä¸ªç¨‹åºï¼Œä½ éœ€è¦é€šè¿‡ç¯å¢ƒå˜é‡ FILE_PATH æ¥æŒ‡å®šä½ è¦ç›‘å¬çš„æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ã€‚\nFILE_PATH=testdata/test.txt go run . è¿è¡Œåï¼Œå¯¹ä½ ç›‘å¬çš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œè§‚å¯Ÿ terminal çš„è¾“å‡ºï¼š\nI0420 16:47:42.610297 3741467 main.go:35] starting manager I0420 16:47:42.610718 3741467 source.go:74] fileWatch start... I0420 16:48:00.611223 3741467 ctrl.go:19] new modify event, file path: /testdata/test.txt ","date":"2023å¹´04æœˆ21æ—¥","permalink":"/posts/controller-runtime-source/","summary":"èƒŒæ™¯ Source æ˜¯ Watches() çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨ä¸€ç§äº‹ä»¶æºï¼Œå®é™…ç±»å‹æ˜¯ä¸€ä¸ª interfaceï¼ŒåŸå‹ï¼š","title":"Controller-Runtime ä¹‹ Source "},{"contents":"æ­å»º NFS StorageClass æ­å»º NFS Server # å®‰è£… NFS æœåŠ¡ç«¯ sudo apt-get install nfs-kernel-server # åˆ›å»ºä¸€ä¸ª dir ä½œä¸º NFS å…±äº«ç›®å½• mkdir /share # ç¼–è¾‘é…ç½® sudo vim /etc/exports # åœ¨æœ€åä¸€è¡Œæ·»åŠ  /share *(rw,sync,no_root_squash,no_subtree_check) /share *(rw,sync,no_root_squash,no_subtree_check)\nå…¶ä¸­ /share å°±æ˜¯æˆ‘ä»¬çš„ NFS å…±äº«ç›®å½•\n*(rw,sync,no_root_squash,no_subtree_check) æ˜¯ä¸€æ¡é…ç½®è¡Œï¼Œç”¨äºæŒ‡å®š NFS å…±äº«ç›®å½•çš„æƒé™è®¾ç½®\nå…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š\n*: è¡¨ç¤ºå…è®¸ä»»ä½•å®¢æˆ·ç«¯è®¿é—®è¯¥å…±äº«ç›®å½•ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šç‰¹å®šçš„ IP åœ°å€ã€IP åœ°å€èŒƒå›´æˆ–åŸŸåç­‰æ¥é™åˆ¶å®¢æˆ·ç«¯çš„è®¿é—®ã€‚ (rw): è¡¨ç¤ºå…±äº«ç›®å½•ä»¥è¯»å†™ (read-write) æ¨¡å¼å…±äº«ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¯¹å…±äº«ç›®å½•è¿›è¡Œè¯»å–å’Œå†™å…¥æ“ä½œã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ (ro) è¡¨ç¤ºåªè¯» (read-only) æ¨¡å¼å…±äº«ï¼Œå®¢æˆ·ç«¯åªèƒ½å¯¹å…±äº«ç›®å½•è¿›è¡Œè¯»å–æ“ä½œã€‚ (sync): è¡¨ç¤ºä½¿ç”¨åŒæ­¥ (synchronous) æ¨¡å¼ï¼ŒNFS æœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯è¯·æ±‚å®Œæˆä¹‹å‰ä¼šç­‰å¾…å†™å…¥æ“ä½œåŒæ­¥åˆ°ç£ç›˜ä¸Šã€‚è¿™æ ·å¯ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚ (no_root_squash): è¡¨ç¤ºå…è®¸å®¢æˆ·ç«¯ä½¿ç”¨ root æƒé™è®¿é—®å…±äº«ç›®å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNFS æœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯ä½¿ç”¨ root æƒé™çš„è¯·æ±‚æ˜ å°„ä¸ºä½¿ç”¨åŒ¿åç”¨æˆ· (nobody) æƒé™ï¼Œè¿™æ ·å¯ä»¥æé«˜å®‰å…¨æ€§ã€‚ä½¿ç”¨ (no_root_squash) å‚æ•°å¯ä»¥ç¦ç”¨è¿™ç§æ˜ å°„ï¼Œå…è®¸å®¢æˆ·ç«¯ä½¿ç”¨ root æƒé™è®¿é—®å…±äº«ç›®å½•ã€‚ (no_subtree_check): è¡¨ç¤ºç¦ç”¨å­æ ‘æ£€æŸ¥ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«ç›®å½•å…±äº«çš„é€Ÿåº¦ã€‚å­æ ‘æ£€æŸ¥æ˜¯ä¸€ç§å®‰å…¨ç‰¹æ€§ï¼Œç”¨äºæ£€æŸ¥å…±äº«ç›®å½•çš„çˆ¶ç›®å½•å’Œç¥–å…ˆç›®å½•çš„æƒé™ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚ä½¿ç”¨ (no_subtree_check) å‚æ•°å¯ä»¥ç¦ç”¨è¿™ç§æ£€æŸ¥ã€‚ æµ‹è¯• é¦–å…ˆåœ¨å…±äº«ç›®å½• /share ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼š\n$ echo 123 \u0026gt; /share/123.txt åœ¨å¦ä¸€å°ä¸»æœºä¸Šï¼ŒæŒ‚è½½è¯¥å…±äº«ç›®å½•ï¼š\n$ sudo mount -t nfs 192.168.223.129:/share /mnt å…¶ä¸­ï¼Œ192.168.223.129 æ˜¯ NFS Server çš„ IPï¼Œ/share æ˜¯è¯¥ server çš„å…±äº«ç›®å½•ï¼Œ/mnt æ˜¯å®¢æˆ·ç«¯è¦æŒ‚è½½åˆ°æœ¬æœºçš„ç›®çš„ç›®å½•ã€‚\næ‰§è¡Œå®Œæˆåå¦‚æœæ²¡æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯åˆ™ä»£è¡¨æˆåŠŸï¼ŒæŸ¥çœ‹å½“å‰ä¸»æœºçš„ /mnt ç›®å½•ï¼š\n$ ls /mnt 123.txt $ cat /mnt/123.txt 123 å‘ç°ä¹‹å‰åœ¨ NFS Server çš„ /share é‡Œåˆ›å»ºçš„æ–‡ä»¶ï¼Œå‡ºç°åœ¨äº†å®¢æˆ·ç«¯ä¸»æœºçš„ /mnt ç›®å½•ä¸‹ï¼Œä»£è¡¨ NFS Server æ­å»ºæˆåŠŸã€‚\nRBAC apiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default #æ ¹æ®å®é™…ç¯å¢ƒè®¾å®šnamespace,ä¸‹é¢ç±»åŒ --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-client-provisioner-runner rules: - apiGroups: [\u0026quot;\u0026quot;] resources: [\u0026quot;persistentvolumes\u0026quot;] verbs: [\u0026quot;get\u0026quot;, \u0026quot;list\u0026quot;, \u0026quot;watch\u0026quot;, \u0026quot;create\u0026quot;, \u0026quot;delete\u0026quot;] - apiGroups: [\u0026quot;\u0026quot;] resources: [\u0026quot;persistentvolumeclaims\u0026quot;] verbs: [\u0026quot;get\u0026quot;, \u0026quot;list\u0026quot;, \u0026quot;watch\u0026quot;, \u0026quot;update\u0026quot;] - apiGroups: [\u0026quot;storage.k8s.io\u0026quot;] resources: [\u0026quot;storageclasses\u0026quot;] verbs: [\u0026quot;get\u0026quot;, \u0026quot;list\u0026quot;, \u0026quot;watch\u0026quot;] - apiGroups: [\u0026quot;\u0026quot;] resources: [\u0026quot;events\u0026quot;] verbs: [\u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;, \u0026quot;patch\u0026quot;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: run-nfs-client-provisioner subjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default roleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io --- kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default rules: - apiGroups: [\u0026quot;\u0026quot;] resources: [\u0026quot;endpoints\u0026quot;] verbs: [\u0026quot;get\u0026quot;, \u0026quot;list\u0026quot;, \u0026quot;watch\u0026quot;, \u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;, \u0026quot;patch\u0026quot;] --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner subjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default roleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.io éƒ¨ç½² provisioner-deployment âš ï¸ å¦‚æœä½ çš„ k8s ç‰ˆæœ¬å’Œæˆ‘ä¸€æ ·æ˜¯ v1.25.6ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ä¸‹é¢è¿™ä¸ªé•œåƒï¼š\ngcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0\nå¦åˆ™ pvc æ— æ³• boundï¼ŒæŠ¥é”™ selfLink was empty, can\u0026rsquo;t make reference\nä¸‹é¢è¿™ä¸ªé•œåƒæ— æ³•æ­£å¸¸å·¥ä½œ\nquay.io/external_storage/nfs-client-provisioner:latest\n# nft-provisioner-deployment.yaml # kubectl apply -f nft-provisioner-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nfs-client-provisioner labels: app: nfs-client-provisioner spec: replicas: 1 selector: matchLabels: app: nfs-client-provisioner strategy: type: Recreate selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner imagePullPolicy: IfNotPresent image: gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0 volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME # è‡ªå®šä¹‰ provisioner åç§° value: nfs-provisioner - name: NFS_SERVER # æ›¿æ¢ä¸º nfs æœåŠ¡å™¨åœ°å€ value: 192.168.223.129 - name: NFS_PATH # æ›¿æ¢ä¸º NFS å…±äº«æ–‡ä»¶è·¯å¾„ value: /share volumes: - name: nfs-client-root nfs: # æ›¿æ¢ä¸º nfs æœåŠ¡å™¨åœ°å€ server: 192.168.223.129 # æ›¿æ¢ä¸º NFS å…±äº«æ–‡ä»¶è·¯å¾„ path: /share StorageClass # nfs-storage.yaml # kubectl apply -f nfs-storage.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: nfs-storage # ä½¿ç”¨ä¸Šé¢çš„è‡ªå®šä¹‰ provisioner åç§° provisioner: nfs-provisioner parameters: # archiveOnDelete æŒ‡å®šä¸º false è¡¨ç¤ºåˆ é™¤ PVC å PV ä¹Ÿä¼šè¢«åˆ é™¤ã€‚ # å¦‚æœæƒ³åœ¨ PVC è¢«åˆ é™¤åä»æ—§ä¿ç•™æ•°æ®çš„ï¼Œå¯æŒ‡å®šä¸º true archiveOnDelete: \u0026quot;false\u0026quot; éªŒè¯ï¼š\nåˆ›å»º pvc\nkind: PersistentVolumeClaim apiVersion: v1 metadata: name: test-claim annotations: # ä¸ nfs-StorageClass.yaml metadata.name ä¿æŒä¸€è‡´ volume.beta.kubernetes.io/storage-class: \u0026quot;nfs-storage\u0026quot; spec: accessModes: - ReadWriteMany resources: requests: storage: 1Mi æŸ¥çœ‹æ˜¯å¦ Boundï¼š\n$ k get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE test-claim Bound pvc-969d9309-4510-46ac-90c1-8e9cc1d8f2ec 1Mi RWX nfs-storage 22m TODO æµ‹è¯• pod èƒ½å¦æŒ‚è½½ä¸Šè¿™ä¸ª pvc\nè®¾ç½®ä¸ºé»˜è®¤ storageclass $ kubectl patch storageclass \u0026lt;storageclass-name\u0026gt; -p '{\u0026quot;metadata\u0026quot;: {\u0026quot;annotations\u0026quot;:{\u0026quot;storageclass.kubernetes.io/is-default-class\u0026quot;:\u0026quot;true\u0026quot;}}}' æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªåä¸º nfs-storage çš„ scï¼Œè¦å°†å…¶è®¾ç½®ä¸ºé»˜è®¤ scï¼š\n$ k get sc NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE nfs-storage nfs-provisioner Delete Immediate false 41m $ kubectl patch storageclass nfs-storage -p '{\u0026quot;metadata\u0026quot;: {\u0026quot;annotations\u0026quot;:{\u0026quot;storageclass.kubernetes.io/is-default-class\u0026quot;:\u0026quot;true\u0026quot;}}}' æ‰§è¡Œåï¼Œå‘ç°åå­—åé¢å¤šäº†ä¸€ä¸ª (default)\n$ k get sc NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE nfs-storage (default) nfs-provisioner Delete Immediate false 46m ","date":"2023å¹´04æœˆ18æ—¥","permalink":"/posts/k8s-storageclass/","summary":"æ­å»º NFS StorageClass æ­å»º NFS Server # å®‰è£… NFS æœåŠ¡ç«¯ sudo apt-get install nfs-kernel-server # åˆ›å»ºä¸€ä¸ª dir ä½œä¸º NFS å…±äº«ç›®å½• mkdir /share # ç¼–è¾‘é…ç½® sudo vim /etc/exports # åœ¨æœ€åä¸€è¡Œæ·»åŠ  /share *(rw,sync,no_root_squash,no_subtree_check) /share *(rw,sync,no_root_squash,no_subtree_check)","title":"K8s Storageclass"},{"contents":" âš ï¸ å®‰è£…å‰æœ€å¥½ç¡®ä¿ä½ çš„ä¸»æœºå¤Ÿå¹²å‡€ï¼Œæˆ‘çš„è™šæ‹Ÿæœºå°±å› ä¸ºä¹‹å‰è‡ªè¡Œç”¨äºŒè¿›åˆ¶æ­å»ºè¿‡ï¼Œå¯¼è‡´ä½¿ç”¨ kubespray å®‰è£…å‡ºç°å„ç§å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ï¼Œæœ€ååˆ é™¤é‡æ–°åˆ›å»ºäº†ä¸€å°ï¼Œä¸€æ¬¡å°±å®‰è£…æˆåŠŸäº†\nåˆå§‹åŒ– apt install pip # ssh ç™»å½•è¦ç”¨ï¼Œä¸ç„¶æŠ¥é”™ \u0026quot;to use the 'ssh' connection type with passwords or pkcs11_provider, you must install the sshpass program apt install sshpass pip install netaddr # ä¸ç¡®å®šè¿™ç©æ„çš„å¿…è¦æ€§ï¼Œæœ€å¥½è¿˜æ˜¯è£…äº†å§ # ä¸è¦æ‰‹åŠ¨å®‰è£…ä¸‹é¢è¿™äº›ä¸œè¥¿ï¼Œæ‰‹åŠ¨å®‰è£…çš„ ansible å¯èƒ½ä¸ Kubespray è¦æ±‚çš„ç‰ˆæœ¬ä¸åŒ¹é… #pip install --upgrade jinja2 #apt install ansible # ä¸è¦ clone è¿™ä¸ªï¼Œå¯èƒ½æœ‰é—®é¢˜ #git clone https://github.com/kubernetes-incubator/kubespray.git # ä» release é‡Œä¸‹è½½ wget https://github.com/kubernetes-sigs/kubespray/archive/refs/tags/v2.21.0.tar.gz # è§£å‹ä¸Šé¢ä¸‹è½½ä¸‹æ¥çš„å‹ç¼©åŒ… tar -C . -xvf v2.21.0.tar.gz cd kubespray-2.21.0 # å®‰è£…ç¬¦åˆç‰ˆæœ¬çš„ä¾èµ–ï¼Œè¿™é‡Œä¼šå®‰è£… ansible pip install -U -r requirements.txt ä¿®æ”¹é…ç½® cd kubespray-2.21.0 # å¤åˆ¶ä¸€ä»½é…ç½®è¿›è¡Œä¿®æ”¹ cp -rfp inventory/sample inventory/k8s vim inventory/k8s/inventory.ini é…ç½®å¦‚ä¸‹ï¼Œä¿è¯ IP æ­£ç¡®ï¼Œå…¶ä¸­ master èŠ‚ç‚¹è¦æŒ‡å®š etcd_member_nameï¼Œworker èŠ‚ç‚¹è¯¥å€¼ç½®ä¸ºç©º\nåŒç†ï¼Œ[kube_control_plane] å’Œ [etcd] é‡Œå†™ master èŠ‚ç‚¹ï¼Œ[kube_node] é‡Œå†™ worker èŠ‚ç‚¹\n# ## Configure 'ip' variable to bind kubernetes services on a # ## different ip than the default iface [all] k8s-master ansible_host=192.168.223.128 ip=192.168.223.128 ansible_ssh_user=root ansible_ssh_pass=root etcd_member_name=k8s-master k8s-worker1 ansible_host=192.168.223.129 ip=192.168.223.129 etcd_member_name=\u0026quot;\u0026quot; k8s-worker2 ansible_host=192.168.223.130 ip=192.168.223.130 etcd_member_name=\u0026quot;\u0026quot; # node1 ansible_host=95.54.0.12 # ip=10.3.0.1 etcd_member_name=etcd1 # node2 ansible_host=95.54.0.13 # ip=10.3.0.2 etcd_member_name=etcd2 # node3 ansible_host=95.54.0.14 # ip=10.3.0.3 etcd_member_name=etcd3 # node4 ansible_host=95.54.0.15 # ip=10.3.0.4 etcd_member_name=etcd4 # node5 ansible_host=95.54.0.16 # ip=10.3.0.5 etcd_member_name=etcd5 # node6 ansible_host=95.54.0.17 # ip=10.3.0.6 etcd_member_name=etcd6 # ## configure a bastion host if your nodes are not directly reachable # [bastion] # bastion ansible_host=x.x.x.x ansible_user=some_user [kube_control_plane] k8s-master # node1 # node2 # node3 [etcd] k8s-master # node1 # node2 # node3 [kube_node] k8s-worker1 k8s-worker2 # node2 # node3 # node4 # node5 # node6 [calico_rr] [k8s_cluster:children] kube_control_plane kube_node calico_rr å¼€å§‹éƒ¨ç½² æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œéƒ¨ç½²ï¼Œä¸­é—´å¯èƒ½éœ€è¦ç­‰å¾… 10 åˆ†é’Ÿå·¦å³ã€‚\nansible-playbook -i inventory/k8s/inventory.ini cluster.yml -b -vvv æœ€ç»ˆå¦‚æœæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹ failed=0ï¼Œä»£è¡¨å®‰è£…æˆåŠŸ\nPLAY RECAP **************************************************************************************************** k8s-master : ok=728 changed=141 unreachable=0 failed=0 skipped=1260 rescued=0 ignored=8 k8s-worker1 : ok=479 changed=28 unreachable=0 failed=0 skipped=776 rescued=0 ignored=1 k8s-worker2 : ok=479 changed=28 unreachable=0 failed=0 skipped=775 rescued=0 ignored=1 localhost : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 é”™è¯¯è®°å½• 1 æŠ¥é”™ Ansible must be between 2.11.0 and 2.13.0 exclusive\næ‰§è¡Œ python3 -m pip install \u0026ndash;upgrade \u0026ndash;user ansible åè¿˜æ˜¯æŠ¥é”™ï¼Œå‘ç°æ˜¯ç‰ˆæœ¬åˆå¤ªé«˜äº†ï¼š\nansible \u0026ndash;version ansible [core 2.14.4]\n2 æŠ¥é”™ the output has been hidden due to the fact that \u0026rsquo;no_log: true\u0026rsquo; was specified for this result\nvim inventory/k8s/group_vars/all/all.yml\nä¿®æ”¹ä¸‹é¢è¿™è¡Œä¸º true\nunsafe_show_logs: true\n3 æŠ¥é”™ï¼š\nThe checksum for /tmp/releases/calico-v3.25.1-kdd-crds/v3.25.1.tar.gz did not match 361b0e0e6d64156f0e1b2fbfd18d13217d188eee614eec5de6b05ac0deaab372; it was 4d6b6653499f24f80a85a0a7dac28d9571cabfa25356b08f3b438fd97e322e2d.\nå°è¯•æ‰‹åŠ¨ä¸‹è½½\ncd /tmp/releases/calico-v3.25.1-kdd-crds\nwget https://github.com/projectcalico/calico/archive/v3.25.1.tar.gz\nä¸è¡Œï¼Œæ‰§è¡Œéƒ¨ç½²å‘½ä»¤ä¼šæ¸…ç©ºè¯¥ç›®å½•\nè§£å†³ï¼š\nä¸è¦ clone ä¸‹é¢è¿™ä¸ª master åˆ†æ”¯ï¼Œå¯èƒ½æœ‰é—®é¢˜\ngit clone https://github.com/kubernetes-incubator/kubespray.git\nä» release é‡Œä¸‹è½½\nwget https://github.com/kubernetes-sigs/kubespray/archive/refs/tags/v2.21.0.tar.gz\nåå®‰è£…å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†\n4 W0416 11:04:23.183824 468870 utils.go:69] The recommended value for \u0026quot;clusterDNS\u0026quot; in \u0026quot;KubeletConfiguration\u0026quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]\\nerror execution phase certs/apiserver: couldn\u0026rsquo;t load CA certificate ca: couldn\u0026rsquo;t load ca certificate authority from /etc/kubernetes/ssl\\nTo see the stack trace of this error execute with \u0026ndash;v=5 or higher\nä¸çŸ¥é“å•¥åŸå› ï¼Œå¯èƒ½æ˜¯å› ä¸ºä¹‹å‰æœºå™¨è£…è¿‡äºŒè¿›åˆ¶ k8s å¯¼è‡´ä¸€äº›è«åå…¶å¦™çš„å†²çª\nç–‘æƒ‘ å®‰è£…å®Œåªæœ‰ master èŠ‚ç‚¹å®‰è£…å¥½äº† kubectlï¼Œworker èŠ‚ç‚¹éƒ½æ²¡æœ‰å®‰è£…ï¼Œè¿™ä¸ªæ­£å¸¸å—ï¼Ÿ\n","date":"2023å¹´04æœˆ16æ—¥","permalink":"/posts/kubespray-install/","summary":"âš ï¸ å®‰è£…å‰æœ€å¥½ç¡®ä¿ä½ çš„ä¸»æœºå¤Ÿå¹²å‡€ï¼Œæˆ‘çš„è™šæ‹Ÿæœºå°±å› ä¸ºä¹‹å‰è‡ªè¡Œç”¨äºŒè¿›åˆ¶æ­å»ºè¿‡ï¼Œå¯¼è‡´ä½¿ç”¨ kubespray å®‰è£…å‡ºç°å„ç§å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ï¼Œæœ€ååˆ é™¤é‡æ–°åˆ›å»ºäº†ä¸€å°ï¼Œä¸€æ¬¡å°±å®‰è£…æˆåŠŸäº†","title":"é€šè¿‡ Kubespray æ­å»º k8s é›†ç¾¤"},{"contents":"æœ€è¿‘ç»„äº†å°å°å¼ï¼Œç”¨æ¥å½“åšè¿·ä½ æœåŠ¡å™¨ä½¿ç”¨ï¼Œå› ä¸ºæ˜¯è‡ªå·±ç¬¬ä¸€æ¬¡ç‹¬ç«‹è£…æœºï¼Œæ‰€ä»¥ç‰¹æ­¤è®°å½•ä¸€ä¸‹æœŸé—´çš„å¿ƒè·¯å†ç¨‹ã€‚\nå‘çˆ¹ 1ï¼šCPU å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸\nè€å®è¯´è¿™ç©æ„å®‰è£…è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸»è¦æ˜¯åŒ…è£…å’Œè¯´æ˜ä¹¦ä¸Šå„ç§è­¦å‘Šï¼Œè¿˜æœ‰ç½‘ä¸Šå„ç§å‹å¼¯é’ˆè„šçš„å¸–å­ï¼Œæå¾—äººå¿ƒæƒ¶æƒ¶çš„ï¼Œå…¶å®æ„Ÿè§‰é—®é¢˜ä¸å¤§ï¼ŒæŒ‰ç…§è¯´æ˜ä¹¦çš„æ­¥éª¤æ¥ï¼Œç¨å¾®å°å¿ƒä¸€ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±å®‰è£…å¥½äº†ã€‚\nå‘çˆ¹ 2ï¼š ä¸»æ¿ å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸\nä¸»æ¿æœ¬èº«çš„å®‰è£…æ²¡ä»€ä¹ˆéš¾çš„ï¼Œå¯¹å‡†èºä¸æŸ±ï¼Œæ‹§ä¸Šèºä¸å°± OK äº†ï¼Œè›‹ç–¼çš„æ˜¯è¿™ç©æ„ä¸èƒ½å¤ªæ—©å®‰è£…ï¼Œä½œä¸ºåˆæ¬¡è£…æœºçš„ç»ƒä¹ ç”Ÿï¼Œåœ¨è¿™ç‚¹ä¸Šå°±è¸©äº†å¤§å‘äº†ï¼Œå‰å‰ååè£…äº†æ‹†æ‹†äº†è£…äº†å¥½å‡ æ¬¡ï¼Œå°è±¡å¦‚ä¸‹ï¼š\nç¬¬ä¸€æ¬¡ï¼šä¸»æ¿ç”µæºæ’çº¿ï¼Œå‘ç°éœ€è¦ç”¨ç‚¹åŠ›æ‰èƒ½æ’è¿›å»ï¼Œä½†æ˜¯å› ä¸ºå·²ç»å›ºå®šåœ¨èºä¸æŸ±ä¸Šäº†ï¼Œè€Œæœ‰ä¸€éƒ¨åˆ†çº¿åˆéœ€è¦æ’åœ¨ä¸»æ¿è§’è½ï¼Œå®³æ€•æŠŠæŒä¸ä½æŠŠä¸»æ¿æå¼¯äº†ï¼Œä¿é™©èµ·è§åªèƒ½æŠŠä¸»æ¿æ‹†æ‰å†æ’çº¿\nç¬¬äºŒæ¬¡ï¼šå®‰è£…æ•£çƒ­ï¼Œå‘ç°æ•£çƒ­åº•åº§èºä¸æŸ±éœ€è¦ä»ä¸»æ¿èƒŒé¢å®‰è£…ï¼Œæ²¡åŠæ³•åˆå¾—æ‹†ä¸‹ä¸»æ¿\nç¬¬ä¸‰æ¬¡ï¼šå®‰è£…æœºç®±æŒ¡æ¿ï¼Œè¿™ç©æ„è¦å®‰è£…åœ¨æœºç®±å†…éƒ¨ï¼Œç„¶åå†ç”¨åŠ›å¾€å¤–å‹æ‰èƒ½å®Œæˆå®‰è£…ï¼Œæˆ‘ä¸€å¼€å§‹è¿˜ä»¥ä¸ºæ˜¯ä»å¤–åˆ°å†…å®‰è£…ã€‚ã€‚ã€‚æ²¡åŠæ³•åªèƒ½æ‹†æ‰ä¸»æ¿\nç¬¬å››æ¬¡ï¼šå®‰è£…ç½‘å¡ wifi-go ç›’å­ï¼ŒåŒæ ·ä¹Ÿæ˜¯è¦ä»ä¸»æ¿èƒŒé¢å®‰è£…èºä¸ï¼Œæ²¡åŠæ³•åˆå¾—æ‹†ä¸‹ä¸»æ¿\nå‘çˆ¹ 3ï¼šä¸»æ¿è·³çº¿ å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸â­ï¸\nè¿™ä¸ªä¹ä¸€çœ‹æŒºå¤æ‚çš„ï¼Œå…¶å®å¯¹ç€ç½‘ä¸Šçš„è§†é¢‘æ•™å­¦ï¼Œè¿˜æ˜¯ä¸éš¾çš„ï¼Œä¸è¿‡è¯è™½è¿™ä¹ˆè¯´ï¼Œä½†æˆ‘è¿˜æ˜¯æ²¡æœ‰ä¸€æ¬¡æˆåŠŸï¼Œè£…å¥½åç”µæºé”®æ²¡ååº”ï¼Œå½“æ—¶å“äº†æˆ‘ä¸€è·³ï¼Œè¿˜ä»¥ä¸ºç¡¬ä»¶æœ‰é—®é¢˜ï¼Œè¿˜å¥½æŠŠè·³çº¿å…¨éƒ¨æ‹”æ‰å†ç…§ç€è§†é¢‘æ’äº†ä¸€éåæˆåŠŸè§£å†³äº†ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯ä¸éš¾çš„\nå‘çˆ¹ 4ï¼šä¸»æ¿ç”µæºçº¿ å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸\næ’è¿™ç ´ç©æ„çš„æ—¶å€™ç›´æ¥è®©æˆ‘ç ´é˜²ï¼Œä¸»è¦æ˜¯å¤ªç´§äº†ï¼Œçœ‹è§†é¢‘è¦å…¨éƒ¨æ’åˆ°åº•æ‰ç®— OKï¼Œå¦åˆ™æœ‰çƒ§ä¸»æ¿çš„é£é™©ï¼Œä½†æ˜¯æƒ³æ’åˆ°åº•çœŸçš„æ˜¯è´¹åŠ²çš„ä¸€æ‰¹ï¼Œè€Œä¸”ç”¨å¤ªå¤§åŠ²åˆæ€•æŠŠé’ˆè„šç»™æå¼¯ï¼Œæçš„æ˜¯ç”¨åŠ²ä¸æ˜¯ï¼Œä¸ç”¨åŠ²ä¹Ÿä¸æ˜¯ï¼Œæœ€åç£¨äº†åŠå¤©æœ€åæ‰å®Œå…¨æ’è¿›å»ï¼Œå±å®æ˜¯æ¶å¿ƒ\nå‘çˆ¹ 5ï¼šç½‘å¡ å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸\nåƒç®—ä¸‡ç®—æ²¡æƒ³åˆ°ï¼Œè¿™ä¸ª jb ç©æ„æ˜¯æˆ‘å®‰è£…è¿‡ç¨‹ä¸­æœ€æ¶å¿ƒçš„ä¸€ä¸ªéƒ¨ä½ï¼Œé¦–å…ˆæ˜¯é‚£ä¸¤æ ¹ç ´çº¿ï¼Œå°±æ˜¯è¿æ¥å¤©çº¿å’Œç½‘å¡çš„é‚£æ ¹çº¿ï¼Œè¿æ¥çº½æ‰£å¤„å¤ªå°äº†ï¼Œéš¾è£…çš„ä¸€æ‰¹ï¼Œåæ¥çœ‹è§†é¢‘é‡Œçš„æ˜¯æ–œç€è£…çš„ï¼Œç„¶åè°ƒæ•´äº†åŠå¤©è§’åº¦æ‰æ‰£ä¸Šå»ï¼Œè£…å¥½ååˆå‘ç°ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä¸çŸ¥é“å¦‚ä½•å°†å¤©çº¿å›ºå®šåœ¨æœºç®±ï¼Œè™½ç„¶åŒ…è£…é‡Œç»™äº†ä¸¤ä¸ªå¸¦æ´çš„é“ç‰‡ï¼Œå¥½åƒæ˜¯ä»€ä¹ˆæŒ¡æ¿ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“è£…åœ¨æœºç®±çš„å“ªé‡Œï¼Œç½‘ä¸Šæ‰¾åˆ°çš„è§†é¢‘ä¹Ÿéƒ½æ˜¯ wifi-go ç›’å­å®‰è£…çš„ï¼ŒæŠ˜è…¾äº†åŠå¤©ä¹Ÿæ²¡å¤´ç»ªï¼Œæµªè´¹äº†å¥½å¤šæ—¶é—´ï¼Œæœ€åæ²¡åŠæ³•åªèƒ½å†ä¹°ä¸€ä¸ª wifi-go ç›’å­äº†ï¼Œä¸è¿‡æˆ‘å‘ç°å•ç½‘å¡ä¸æ’å¤©çº¿ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œç½‘é€Ÿä¹Ÿæœ‰ä¸ª 4 5M æ¯ç§’ã€‚\nå‘çˆ¹ 6ï¼šæœºç®±æŒ¡æ¿ å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸\nè¿™ç©æ„å…¶å®æ²¡å•¥å‘çˆ¹çš„ï¼Œå°±æ˜¯æŒ‰å‹çš„æ—¶å€™è¦ç”¨ç‚¹åŠ›ï¼Œå¬è§å’”åš“çš„å£°éŸ³å°±å¯ä»¥äº†\nå‚»ç“œçº§ï¼šå†…å­˜ï¼Œå›ºæ€ï¼Œç”µæº è¿™ä¸‰ç©æ„åŸºæœ¬éƒ½æ˜¯ç®€å•æ— è„‘ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒä¸å°å¿ƒè£…åäº†ä»€ä¹ˆçš„ï¼Œåƒå†…å­˜å’Œç”µæºéƒ½æœ‰é˜²å‘†ç¼ºå£ï¼Œç„¶åæ’è¿›å»å°± OK äº†ï¼Œç”µæºä¹Ÿæ˜¯ç›´æ¥å¯¹å‡†æœºç®±å±è‚¡æ‹§ä¸Šèºä¸å°±å¥½äº†ï¼Œä¸»è¦æ˜¯ç”µæºæ¥çº¿éº»çƒ¦ä¸€äº›ï¼Œç”µæºæœ¬èº«å®‰è£…éå¸¸ç®€å•\n","date":"2023å¹´04æœˆ14æ—¥","permalink":"/posts/zhuangji-jilu/","summary":"æœ€è¿‘ç»„äº†å°å°å¼ï¼Œç”¨æ¥å½“åšè¿·ä½ æœåŠ¡å™¨ä½¿ç”¨ï¼Œå› ä¸ºæ˜¯è‡ªå·±ç¬¬ä¸€æ¬¡ç‹¬ç«‹è£…æœºï¼Œæ‰€ä»¥ç‰¹æ­¤è®°å½•ä¸€ä¸‹æœŸé—´çš„å¿ƒè·¯å†ç¨‹ã€‚\nå‘çˆ¹ 1ï¼šCPU å‘çˆ¹æŒ‡æ•°ï¼šâ­ï¸\nè€å®è¯´è¿™ç©æ„å®‰è£…è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸»è¦æ˜¯åŒ…è£…å’Œè¯´æ˜ä¹¦ä¸Šå„ç§è­¦å‘Šï¼Œè¿˜æœ‰ç½‘ä¸Šå„ç§å‹å¼¯é’ˆè„šçš„å¸–å­ï¼Œæå¾—äººå¿ƒæƒ¶æƒ¶çš„ï¼Œå…¶å®æ„Ÿè§‰é—®é¢˜ä¸å¤§ï¼ŒæŒ‰ç…§è¯´æ˜ä¹¦çš„æ­¥éª¤æ¥ï¼Œç¨å¾®å°å¿ƒä¸€ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±å®‰è£…å¥½äº†ã€‚","title":"è£…æœºè®°å½•"},{"contents":"ç¯å¢ƒ ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š\nhostname os ip cpu mem disk k8s-master Ubuntu 22.04.2 LTS 192.168.223.128 4c 8g 50g k8s-worker1 Ubuntu 22.04.2 LTS 192.168.223.129 4c 8g 50g k8s-worker2 Ubuntu 22.04.2 LTS 192.168.223.130 4c 8g 50g åŸºç¡€ç¯å¢ƒå‡†å¤‡ é…ç½® hosts åœ¨ 3 å°ä¸»æœºçš„ /etc/hosts æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š\n192.168.223.128 k8s-master 192.168.223.129 k8s-worker1 192.168.223.130 k8s-worker2 é…ç½®å…å¯†ç™»å½• é¦–å…ˆåœ¨æ¯å°æœºå™¨ä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç”Ÿæˆ ssh ç§˜é’¥ï¼Œç›´æ¥å›è½¦åˆ°åº•ï¼š\n$ ssh-keygen -t rsa ç»§ç»­æ‰§è¡Œ ssh-copy-id -i .ssh/id_rsa.pub \u0026lt;hostname\u0026gt; å‘½ä»¤ï¼Œå…¶ä¸­ hostname å¡«å†™ å¦å¤–ä¸¤å°ä¸»æœºçš„ä¸»æœºåï¼Œè¿™é‡Œä»¥ k8s-worker1 ä¸ºä¾‹ã€‚ æŒ‰ç…§æç¤ºè¾“å…¥ yesï¼Œæœ€åè¾“å…¥ç›®æ ‡ä¸»æœºçš„å¯†ç ã€‚\n$ ssh-copy-id -i .ssh/id_rsa.pub k8s-worker1 è¾“å…¥å¯†ç åï¼Œå¦‚æœæç¤ºä¸‹é¢å†…å®¹ï¼Œè¯´æ˜é…ç½®å…å¯†æˆåŠŸï¼Œæ‰§è¡Œ ssh 'k8s-worker1'ï¼Œå‘ç°æ— éœ€è¾“å…¥å¯†ç å³å¯ç›´æ¥ ssh åˆ°ç›®æ ‡ä¸»æœºã€‚\nNumber of key(s) added: 1 Now try logging into the machine, with: \u0026quot;ssh 'k8s-worker1'\u0026quot; and check to make sure that only the key(s) you wanted were added. æŒ‰ç…§ä¸Šé¢çš„æµç¨‹å¯¹æ¯å°ä¸»æœºæ‰§è¡Œç›¸åŒæ“ä½œï¼Œå®Œæˆ 3 å°ä¸»æœºç›¸äº’ä¹‹é—´çš„å…å¯†ç™»å½•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nå…³é—­é˜²ç«å¢™ åœ¨æ¯å°ä¸»æœºä¸Šæ‰§è¡Œï¼š\n$ systemctl disable --now ufw æŸ¥çœ‹æ•ˆæœï¼š\n$ sudo ufw status Status: inactive å…³é—­äº¤æ¢åˆ†åŒº æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å…³é—­ swapï¼š\nsed -ri 's/.*swap.*/#\u0026amp;/' /etc/fstab swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 æŸ¥çœ‹æ•ˆæœï¼ŒSwap è¿™æ çš„ total ä¸º 0ï¼Œè¡¨ç¤ºå…³é—­æˆåŠŸã€‚ä¸Šé¢çš„å‘½ä»¤ä¼šæ°¸ä¹…ç¦ç”¨ Swapï¼Œå³ä½¿é‡å¯åä¹Ÿä¼šç”Ÿæ•ˆã€‚\n$ free -h total used free shared buff/cache available Mem: 7.7Gi 415Mi 6.5Gi 1.0Mi 851Mi 7.1Gi Swap: 0B 0B 0B ğŸ¤”ï¸ ä¸ºä»€ä¹ˆå®‰è£… k8s è¦éœ€è¦å…³é—­ Swapï¼Ÿ\nåœ¨å®‰è£… Kubernetes é›†ç¾¤æ—¶ï¼Œéœ€è¦å…³é—­ swapã€‚åŸå› æ˜¯ Kubernetes é€šè¿‡ cgroup æ¥å¯¹å®¹å™¨è¿›è¡Œèµ„æºé™åˆ¶ï¼Œè€Œ cgroup åªèƒ½æ§åˆ¶å®é™…å†…å­˜ï¼Œæ— æ³•æ§åˆ¶ swapï¼Œå› æ­¤å¼€å¯ swap åå¯èƒ½ä¼šå¯¼è‡´èµ„æºä¸å—é™åˆ¶ï¼Œè¿›è€Œå¯¼è‡´å®¹å™¨è¿è¡Œä¸ç¨³å®šæˆ–è€…å®•æœºã€‚å› æ­¤å…³é—­ swap å¯ä»¥æé«˜ Kubernetes é›†ç¾¤çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚\nè®¾ç½®æ—¶é—´åŒæ­¥ åœ¨æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼š\n# æ‰“å¼€ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤å®‰è£…ntpdateå·¥å…·ã€‚ $ apt install ntpdate # å†è¾“å…¥å‘½ä»¤è®¾ç½®ç³»ç»Ÿæ—¶é—´ä¸ç½‘ç»œæ—¶é—´åŒæ­¥ã€‚ $ ntpdate cn.pool.ntp.org # æœ€åè¾“å…¥å‘½ä»¤å°†æ—¶é—´æ›´æ–°åˆ°ç¡¬ä»¶ä¸Šå³å¯ã€‚ $ hwclock --systohc ğŸ¤”ï¸ å®‰è£… k8s ä¸ºä»€ä¹ˆéœ€è¦è®¾ç½®æ—¶é—´åŒæ­¥ï¼Ÿ\nåœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦è¿›è¡Œåè°ƒå’Œé€šä¿¡ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå°†ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š\nè¯ä¹¦é—®é¢˜ï¼šKubernetes ä½¿ç”¨ TLS è¯ä¹¦è¿›è¡ŒèŠ‚ç‚¹é—´çš„è®¤è¯å’Œé€šä¿¡ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½å¯¼è‡´è¯ä¹¦è¿‡æœŸæˆ–è€…æ— æ³•éªŒè¯ç­‰é—®é¢˜ã€‚ æ—¥å¿—é—®é¢˜ï¼šå„ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—éœ€è¦è¿›è¡Œæ—¶é—´æˆ³çš„è®°å½•ï¼Œå¦‚æœå„ä¸ªèŠ‚ç‚¹çš„æ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½å¯¼è‡´æ—¥å¿—é¡ºåºé”™ä¹±æˆ–è€…æ— æ³•å®šä½é—®é¢˜ã€‚ å› æ­¤ï¼Œåœ¨å®‰è£… Kubernetes æ—¶éœ€è¦è®¾ç½®æ—¶é—´åŒæ­¥ï¼Œä¿è¯å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´æ˜¯ä¸€è‡´çš„ï¼Œä»è€Œé¿å…å‡ºç°ä»¥ä¸Šé—®é¢˜ã€‚\nå®‰è£… Docker å› ä¸ºæˆ‘åœ¨å®‰è£… Ubuntu æ—¶å‹¾é€‰äº† Dockerï¼Œæ‰€ä»¥ç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…å¥½äº† Dockerã€‚\næ‰€æœ‰èŠ‚ç‚¹å®‰è£… Containerd åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼Œmaster èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½éœ€è¦\n$ wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz # åˆ›å»º cni æ’ä»¶æ‰€éœ€ç›®å½• $ mkdir -p /etc/cni/net.d /opt/cni/bin # è§£å‹ cni äºŒè¿›åˆ¶åŒ… $ tar xf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/ $ wget https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz $ tar -C / -xzf cri-containerd-cni-1.6.4-linux-amd64.tar.gz # åˆ›å»ºæœåŠ¡å¯åŠ¨æ–‡ä»¶ cat \u0026gt; /etc/systemd/system/containerd.service \u0026lt;\u0026lt;EOF [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/local/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=infinity TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target EOF é…ç½® Containerd æ‰€éœ€çš„æ¨¡å—\ncat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF åŠ è½½æ¨¡å—ï¼Œè®¾ç½®å¼€æœºå¯åŠ¨\n$ systemctl restart systemd-modules-load.service é…ç½®Containerdæ‰€éœ€çš„å†…æ ¸\ncat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # åŠ è½½å†…æ ¸ sysctl --system åˆ›å»º Containerd çš„é…ç½®æ–‡ä»¶\n# åˆ›å»ºé…ç½®æ–‡ä»¶ mkdir -p /etc/containerd containerd config default | tee /etc/containerd/config.toml # ä¿®æ”¹ Containerd çš„é…ç½®æ–‡ä»¶ sed -i \u0026quot;s#SystemdCgroup\\ \\=\\ false#SystemdCgroup\\ \\=\\ true#g\u0026quot; /etc/containerd/config.toml cat /etc/containerd/config.toml | grep SystemdCgroup sed -i \u0026quot;s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/abcdocker#g\u0026quot; /etc/containerd/config.toml cat /etc/containerd/config.toml | grep sandbox_image æ‰‹åŠ¨åˆ é™¤ /etc/containerd/config.toml ä¸­çš„ systemd_cgroup = false è¿™ä¸€è¡Œ\nvim /etc/containerd/config.toml è®¾ç½®å¼€æœºå¯åŠ¨\nsystemctl daemon-reload systemctl enable --now containerd éªŒè¯\n$ ctr version Client: Version: v1.6.4 Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16 Go version: go1.17.9 Server: Version: v1.6.4 Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16 UUID: f3171aee-67b0-4e01-871b-2e93674af2ad k8s ç¯å¢ƒéƒ¨ç½² ä¸‹è½½ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶ åœ¨ master èŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä¸‹è½½ k8s ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š\n$ wget https://dl.k8s.io/v1.24.3/kubernetes-server-linux-amd64.tar.gz $ wget https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz è§£å‹è·å¾—å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°†è§£å‹åˆ° /usr/local/bin ç›®å½•ä¸‹ï¼š\n$ tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $ tar -xf etcd-v3.5.4-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.4-linux-amd64/etcd{,ctl} æ£€æŸ¥/usr/local/binä¸‹å†…å®¹\n$ ls /usr/local/bin/ cfssl etcd kube-apiserver kubectl kube-proxy cfssljson etcdctl kube-controller-manager kubelet kube-scheduler éªŒè¯äºŒè¿›åˆ¶\n$ kubelet --version Kubernetes v1.24.3 $ etcdctl version etcdctl version: 3.5.4 API version: 3.5 å°†åˆšåˆšè§£å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šï¼ˆå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯è®¡ç®—èŠ‚ç‚¹ï¼Œæ‰€ä»¥å…¶å®ä¸ç”¨æ‹·è´ etcd ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯ kubectl ä»€ä¹ˆçš„è¿˜æ˜¯éœ€è¦çš„ï¼Œæ‰€ä»¥å½±å“ä¸å¤§ï¼‰\nfor i in k8s-worker1 k8s-worker2;do scp /usr/local/bin/kube* root@$i:/usr/local/bin/ scp /usr/local/bin/{etcd,etcdctl} root@$i:/usr/local/bin/ done å‡†å¤‡ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾è¯ä¹¦é…ç½®æ–‡ä»¶ $ mkdir pki ä¸‹è½½é…ç½® cfssl è¯ä¹¦ âš ï¸ åªéœ€åœ¨æ§åˆ¶èŠ‚ç‚¹ k8s-master ä¸Šæ‰§è¡Œ\n$ wget \u0026quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64\u0026quot; -O /usr/local/bin/cfssl $ wget \u0026quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64\u0026quot; -O /usr/local/bin/cfssljson $ chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶ $ cd pki ä¸‹é¢è¿™æ®µ shell æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ª admin ç”¨æˆ·çš„è¯ä¹¦ç­¾å‘è¯·æ±‚æ–‡ä»¶ admin-csr.jsonï¼Œå…¶ä¸­åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š\nCNï¼šCommon Nameï¼Œå³è¯ä¹¦çš„åç§°ï¼Œè¿™é‡Œæ˜¯ adminã€‚ keyï¼šç”¨äºæŒ‡å®šç”Ÿæˆå¯†é’¥çš„ç®—æ³•åŠé•¿åº¦ï¼Œè¿™é‡Œæ˜¯ rsa ç®—æ³•ï¼Œé•¿åº¦æ˜¯ 2048 ä½ã€‚ namesï¼šç”¨äºæŒ‡å®šè¯ä¹¦ä¸­çš„ä¸»é¢˜ï¼ˆSubjectï¼‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›½å®¶ï¼ˆCï¼‰ã€çœï¼ˆSTï¼‰ã€åŸå¸‚ï¼ˆLï¼‰ã€ç»„ç»‡ï¼ˆOï¼‰å’Œç»„ç»‡å•ä½ï¼ˆOUï¼‰ï¼Œè¿™é‡Œä¸»è¦æŒ‡å®šäº†ç»„ç»‡ä¸º system:mastersï¼Œä¹Ÿå°±æ˜¯ Kubernetes çš„ç®¡ç†å‘˜ã€‚ è¯¥è¯ä¹¦ç”¨äºéªŒè¯ç”¨æˆ· admin å¯¹ Kubernetes API Server çš„è®¿é—®æƒé™ï¼Œç”± Kubernetes çš„è¯ä¹¦ç®¡ç†å·¥å…· cfssl æ ¹æ®æ­¤æ–‡ä»¶ç”Ÿæˆè¯ä¹¦ã€‚\nï¼ˆä»¥ä¸Šå†…å®¹æ¥è‡ª ChatGPTã€‚ã€‚ã€‚ï¼‰\n$ cat \u0026gt; admin-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;admin\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:masters\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF ä¸‹é¢è¿™æ®µ shell æ˜¯å®šä¹‰ CA çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œ\u0026ldquo;signing\u0026rdquo; å’Œ \u0026ldquo;profiles\u0026rdquo;ã€‚\nå…¶ä¸­ï¼Œ\u0026ldquo;signing\u0026rdquo; éƒ¨åˆ†å®šä¹‰äº†é»˜è®¤çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®ä¸º 876000 å°æ—¶ï¼Œä¹Ÿå°±æ˜¯ 100 å¹´ã€‚è¿™ä¸ªæ—¶é—´å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚\n\u0026ldquo;profiles\u0026rdquo; éƒ¨åˆ†å®šä¹‰äº†ä¸åŒ profile çš„é…ç½®ä¿¡æ¯ã€‚è¿™é‡Œåªå®šä¹‰äº†ä¸€ä¸ªå«åš \u0026ldquo;kubernetes\u0026rdquo; çš„ profileï¼Œè¯¥ profile çš„ç”¨é€”åŒ…æ‹¬ \u0026ldquo;signing\u0026rdquo;ã€\u0026ldquo;key encipherment\u0026rdquo;ã€\u0026ldquo;server auth\u0026rdquo; å’Œ \u0026ldquo;client auth\u0026rdquo;ï¼Œä¹Ÿå°±æ˜¯è¯¥ profile é€‚ç”¨äºç”¨äºç­¾å‘å’ŒéªŒè¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŒæ—¶ä¹Ÿèƒ½ç”¨äºåŠ å¯†ä¼ è¾“æ•°æ®ã€‚è¯¥ profile çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ä¹Ÿè®¾ç½®ä¸º 876000 å°æ—¶ï¼Œä¸é»˜è®¤çš„è¯ä¹¦è¿‡æœŸæ—¶é—´ç›¸åŒã€‚\nCAï¼Œå³è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertificate Authorityï¼‰ï¼Œæ˜¯æŒ‡è´Ÿè´£ç­¾å‘ã€ç®¡ç†å’ŒåŠé”€æ•°å­—è¯ä¹¦çš„å¯ä¿¡æœºæ„ã€‚åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œæ•°å­—è¯ä¹¦èµ·åˆ°éªŒè¯é€šä¿¡åŒæ–¹èº«ä»½çš„ä½œç”¨ï¼ŒCA åˆ™æ˜¯è´Ÿè´£é¢å‘æ•°å­—è¯ä¹¦ï¼Œä»¥åŠéªŒè¯è¯ä¹¦çš„çœŸå®æ€§å’Œæœ‰æ•ˆæ€§ã€‚\nCA é€šå¸¸ç”±æ”¿åºœã€å†›é˜Ÿã€é‡‘èæœºæ„ç­‰å…·æœ‰ä¸€å®šä¿¡èª‰å’Œå®‰å…¨ä¿éšœèƒ½åŠ›çš„æœºæ„æ‰€æ‹…ä»»ï¼Œä»¥ç¡®ä¿æ•°å­—è¯ä¹¦çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚é€šè¿‡ä½¿ç”¨CAï¼Œæ•°å­—è¯ä¹¦çš„é¢å‘å’ŒéªŒè¯å¾—ä»¥å½¢æˆä¸€ä¸ªé—­ç¯ï¼Œä½¿å¾—ç½‘ç»œé€šä¿¡è¿‡ç¨‹æ›´åŠ å®‰å…¨å’Œå¯é ã€‚\n$ cat \u0026gt; ca-config.json \u0026lt;\u0026lt; EOF { \u0026quot;signing\u0026quot;: { \u0026quot;default\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; }, \u0026quot;profiles\u0026quot;: { \u0026quot;kubernetes\u0026quot;: { \u0026quot;usages\u0026quot;: [ \u0026quot;signing\u0026quot;, \u0026quot;key encipherment\u0026quot;, \u0026quot;server auth\u0026quot;, \u0026quot;client auth\u0026quot; ], \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } } } EOF ä¸‹é¢è¿™æ®µ shell æ˜¯ç”¨äºåˆ›å»º etcd CA è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œ\u0026ldquo;CN\u0026rdquo; æ˜¯è¯ä¹¦çš„é€šç”¨åç§°ï¼Œ\u0026ldquo;key\u0026rdquo; å®šä¹‰äº†åŠ å¯†ç®—æ³•å’Œå¯†é’¥é•¿åº¦ï¼Œ\u0026ldquo;names\u0026rdquo; åˆ—å‡ºäº†è¯ä¹¦çš„ä¸»é¢˜ï¼Œ\u0026ldquo;ca\u0026rdquo; å®šä¹‰äº†è¯ä¹¦é¢å‘æœºæ„çš„è¿‡æœŸæ—¶é—´ã€‚è¯¥æ–‡ä»¶ä¼šè¢«ç”¨äºç”Ÿæˆ etcd CA è¯ä¹¦ï¼Œç”¨äºç­¾å‘å’Œç®¡ç† etcd é›†ç¾¤ä¸­çš„å…¶ä»–è¯ä¹¦ï¼Œä¿è¯é›†ç¾¤é€šä¿¡çš„å®‰å…¨æ€§ã€‚\n$ cat \u0026gt; etcd-ca-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Etcd Security\u0026quot; } ], \u0026quot;ca\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } EOF è¿™éƒ¨åˆ†ç›´æ¥çœ‹è¿™é‡Œ å‘ç°è¿™éƒ¨åˆ† shell æœ‰ç‚¹å¤šï¼Œæ‡’å¾—ä¸€ä¸ªä¸€ä¸ªé—® ChatGPT ä»€ä¹ˆæ„æ€äº†ï¼Œæš‚æ—¶ä¹Ÿä¸å…³æ³¨è¿™äº›è¯ä¹¦ç›¸å…³çš„ä¸œè¥¿äº†ã€‚ã€‚ã€‚\nç›´æ¥å°†ä¸‹é¢è¿™äº›å‘½ä»¤å¤åˆ¶åˆ° terminal å›è½¦å³å¯ï¼Œä¼šä¸€å¹¶åˆ›å»ºè¿™äº›æ–‡ä»¶ã€‚\ncat \u0026gt; admin-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;admin\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:masters\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF cat \u0026gt; ca-config.json \u0026lt;\u0026lt; EOF { \u0026quot;signing\u0026quot;: { \u0026quot;default\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; }, \u0026quot;profiles\u0026quot;: { \u0026quot;kubernetes\u0026quot;: { \u0026quot;usages\u0026quot;: [ \u0026quot;signing\u0026quot;, \u0026quot;key encipherment\u0026quot;, \u0026quot;server auth\u0026quot;, \u0026quot;client auth\u0026quot; ], \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } } } EOF cat \u0026gt; etcd-ca-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Etcd Security\u0026quot; } ], \u0026quot;ca\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } EOF cat \u0026gt; front-proxy-ca-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;kubernetes\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;ca\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } EOF cat \u0026gt; kubelet-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;system:node:\\$NODE\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:nodes\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF cat \u0026gt; manager-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;system:kube-controller-manager\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:kube-controller-manager\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF cat \u0026gt; apiserver-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;kube-apiserver\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;Kubernetes\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF cat \u0026gt; ca-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;kubernetes\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;Kubernetes\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ], \u0026quot;ca\u0026quot;: { \u0026quot;expiry\u0026quot;: \u0026quot;876000h\u0026quot; } } EOF cat \u0026gt; etcd-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;etcd\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Etcd Security\u0026quot; } ] } EOF cat \u0026gt; front-proxy-client-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;front-proxy-client\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 } } EOF cat \u0026gt; kube-proxy-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;system:kube-proxy\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:kube-proxy\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF cat \u0026gt; scheduler-csr.json \u0026lt;\u0026lt; EOF { \u0026quot;CN\u0026quot;: \u0026quot;system:kube-scheduler\u0026quot;, \u0026quot;key\u0026quot;: { \u0026quot;algo\u0026quot;: \u0026quot;rsa\u0026quot;, \u0026quot;size\u0026quot;: 2048 }, \u0026quot;names\u0026quot;: [ { \u0026quot;C\u0026quot;: \u0026quot;CN\u0026quot;, \u0026quot;ST\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;L\u0026quot;: \u0026quot;Beijing\u0026quot;, \u0026quot;O\u0026quot;: \u0026quot;system:kube-scheduler\u0026quot;, \u0026quot;OU\u0026quot;: \u0026quot;Kubernetes-manual\u0026quot; } ] } EOF ç»§ç»­å¤åˆ¶æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚\ncd .. mkdir bootstrap cd bootstrap cat \u0026gt; bootstrap.secret.yaml \u0026lt;\u0026lt; EOF apiVersion: v1 kind: Secret metadata: name: bootstrap-token-c8ad9c namespace: kube-system type: bootstrap.kubernetes.io/token stringData: description: \u0026quot;The default bootstrap token generated by 'kubelet '.\u0026quot; token-id: c8ad9c token-secret: 2e4d610cf3e7426e usage-bootstrap-authentication: \u0026quot;true\u0026quot; usage-bootstrap-signing: \u0026quot;true\u0026quot; auth-extra-groups: system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kubelet-bootstrap roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-bootstrapper subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers:default-node-token --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: node-autoapprove-bootstrap roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:certificates.k8s.io:certificatesigningrequests:nodeclient subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers:default-node-token --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: node-autoapprove-certificate-rotation roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:nodes --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026quot;true\u0026quot; labels: kubernetes.io/bootstrapping: rbac-defaults name: system:kube-apiserver-to-kubelet rules: - apiGroups: - \u0026quot;\u0026quot; resources: - nodes/proxy - nodes/stats - nodes/log - nodes/spec - nodes/metrics verbs: - \u0026quot;*\u0026quot; --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: system:kube-apiserver namespace: \u0026quot;\u0026quot; roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:kube-apiserver-to-kubelet subjects: - apiGroup: rbac.authorization.k8s.io kind: User name: kube-apiserver EOF è¿™äº› Kubernetes é…ç½®åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\nbootstrap-token-c8ad9c: ç”¨äºå¯åŠ¨ Kubernetes é›†ç¾¤çš„é»˜è®¤å¼•å¯¼ä»¤ç‰ŒåŠå…¶ç›¸å…³æƒé™ä¿¡æ¯ï¼ŒåŒ…æ‹¬æè¿°ä¿¡æ¯ã€ä»¤ç‰Œ IDã€ä»¤ç‰Œå¯†é’¥ä»¥åŠç”¨äºå¯åŠ¨è®¤è¯å’Œç­¾åç­‰æƒé™çš„æ ‡å¿—ã€‚ kubelet-bootstrap ClusterRoleBindingï¼šå°† system:node-bootstrapper ClusterRole åˆ†é…ç»™ system:bootstrappers:default-node-token ç»„ï¼Œä»¥ä¾¿å…è®¸èŠ‚ç‚¹ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚ node-autoapprove-bootstrap ClusterRoleBindingï¼šè‡ªåŠ¨æ‰¹å‡†ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå‘å‡ºçš„èŠ‚ç‚¹å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ã€‚ node-autoapprove-certificate-rotation ClusterRoleBindingï¼šè‡ªåŠ¨æ‰¹å‡†ç”¨äºè‡ªç­¾åèŠ‚ç‚¹è¯ä¹¦è½®æ¢çš„ç­¾åè¯·æ±‚ã€‚ system:kube-apiserver-to-kubelet ClusterRoleï¼šå®šä¹‰äº†ä¸€ä¸ªè§’è‰²ï¼Œè¯¥è§’è‰²å…è®¸ kube-apiserver è®¿é—® kubelet APIï¼Œä»¥ä¾¿å¯ä»¥ä» kube-apiserver å‘é€è¯·æ±‚åˆ°èŠ‚ç‚¹çš„ kubelet APIï¼Œä»¥è·å–èŠ‚ç‚¹ä¿¡æ¯å’Œæ‰§è¡Œæ“ä½œã€‚ system:kube-apiserver ClusterRoleBindingï¼šå°† system:kube-apiserver-to-kubelet ClusterRole åˆ†é…ç»™ kube-apiserver ç”¨æˆ·ï¼Œä»¥ä¾¿åœ¨æ•´ä¸ª Kubernetes é›†ç¾¤èŒƒå›´å†…å…è®¸ kube-apiserver è®¿é—® kubelet APIã€‚ ETCD è¯ä¹¦ æœ¬èŠ‚æ“ä½œåªéœ€è¦ master èŠ‚ç‚¹æ‰§è¡Œå³å¯ã€‚\nåˆ›å»ºè¯ä¹¦æ–‡ä»¶ åˆ›å»ºç”¨äºå­˜æ”¾è¯ä¹¦çš„æ–‡ä»¶å¤¹\nPSï¼šå› ä¸ºæˆ‘åªæœ‰ä¸€ä¸ªæ§åˆ¶é¢èŠ‚ç‚¹ k8s-masterï¼Œè€Œ etcd åªéœ€è¦éƒ¨ç½²åœ¨æ§åˆ¶é¢å³å¯ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨å…¶ä»–èŠ‚ç‚¹æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œç›´æ¥åœ¨æœ¬èŠ‚ç‚¹åˆ›å»º\nfor i in k8s-master k8s-worker1 k8s-worker2;do ssh root@$i mkdir /etc/etcd/ssl -p echo $i create done done\nmkdir /etc/etcd/ssl -p ç”Ÿæˆ etcd è¯ä¹¦å’Œ etcd è¯ä¹¦çš„ key $ cd pki $ cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca æ³¨æ„ -hostname è¿™é‡Œçš„å‚æ•°ï¼Œæ”¹æˆä½ å¯¹åº” master èŠ‚ç‚¹çš„ hostname å’Œ IPï¼Œåˆ«ç›´æ¥ cv è¿‡æ¥å°±æ‰§è¡Œï¼Œå¦‚æœä½ ä¸å°å¿ƒæ‰§è¡Œé”™äº†ï¼ˆå’Œæˆ‘ä¸€æ ·æ²¡æ³¨æ„ï¼Œç›´æ¥ cv è¿‡æ¥å°±æ‰§è¡Œï¼Œå¯¼è‡´åç»­ etcd ä¸è®¤è¿™ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œç›´æ¥ä¿®æ”¹ä¸‹é¢çš„ shell åå†é‡æ–°æ‰§è¡Œä¸€éå³å¯\n$ cfssl gencert \\ -ca=/etc/etcd/ssl/etcd-ca.pem \\ -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \\ -config=ca-config.json \\ -hostname=k8s-master,192.168.223.128 \\ -profile=kubernetes \\ etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd æ‰§è¡Œå®Œæˆåï¼Œå°†ä¼šåœ¨ /etc/etcd/ssl ç›®å½•ä¸‹ç”Ÿæˆè¿™äº›è¯ä¹¦æ–‡ä»¶ï¼š\n$ ls /etc/etcd/ssl etcd-ca.csr etcd-ca-key.pem etcd-ca.pem etcd.csr etcd-key.pem etcd.pem å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ æˆ‘çš„å•èŠ‚ç‚¹æ§åˆ¶é¢ç”¨ä¸ä¸Šäº†\nfor i in k8s-worker1 k8s-worker2;do ssh $i \u0026ldquo;mkdir -p /etc/etcd/ssl\u0026rdquo; scp /etc/etcd/ssl/* $i:/etc/etcd/ssl/ done\nk8s é›†ç¾¤è¯ä¹¦ æœ¬èŠ‚æ“ä½œåªéœ€è¦ master èŠ‚ç‚¹æ‰§è¡Œå³å¯ã€‚\nåˆ›å»ºæ‰€æœ‰è¯ä¹¦çš„å­˜æ”¾ç›®å½• $ mkdir -p /etc/kubernetes/pki ç”Ÿæˆä¸€ä¸ªæ ¹è¯ä¹¦ $ cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca åˆ›å»º API Server å‡­è¯ä¸ç§é’¥ 10.96.0.1 æ˜¯ service ç½‘æ®µçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œhostname ä¸­æŒ‡å®šäº†ç”Ÿæˆçš„è¯ä¹¦çš„ Subject Alternative Names (SANs)ï¼Œå³è¯ä¹¦å…è®¸è¢«ä½¿ç”¨çš„ä¸»æœºåæˆ– IP åœ°å€ï¼Œè¿™é‡Œæˆ‘å¡«å†™äº† 3 å°è™šæ‹Ÿæœºçš„ hostname å’Œ IP\n$ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -hostname=10.96.0.1,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,k8s-master,k8s-worker1,k8s-worker2,192.168.223.128,192.168.223.129,192.168.223.130 \\ -profile=kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver ç”Ÿæˆ apiserver $ cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca $ cfssl gencert \\ -ca=/etc/kubernetes/pki/front-proxy-ca.pem \\ -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client ç”Ÿæˆ controller-manage è¯ä¹¦ æ³¨æ„æ›¿æ¢ä¸‹é¢å‘½ä»¤ä¸­çš„ \u0026ndash;serverï¼ŒIP å¡«å†™ api-server çš„ IPï¼Œåœ¨æˆ‘è¿™é‡Œæ˜¯ master èŠ‚ç‚¹çš„ IPï¼Œç«¯å£å¡«å†™ api-server çš„ portï¼Œè¿™ä¸ªå€¼åœ¨ api server é…ç½®ä¸­çš„ \u0026ndash;secure-port=6443 æŒ‡å®š\nç–‘é—®ï¼š\næˆ‘è¿™é‡Œåªæœ‰ä¸€ä¸ª master èŠ‚ç‚¹ï¼Œæ‰€ä»¥ api-server çš„ IP å°±æ˜¯è¯¥ master èŠ‚ç‚¹çš„ IPï¼Œé‚£å¦‚æœéƒ¨ç½²æ–¹å¼æ˜¯å¤šä¸ª master èŠ‚ç‚¹ï¼Œæ­¤æ—¶ api-server çš„ IP åˆè¯¥å¦‚ä½•å¡«å†™å‘¢ï¼Ÿ\n$ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager # è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.223.128:6443 \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ kubectl config set-context system:kube-controller-manager@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-controller-manager \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹ kubectl config set-credentials system:kube-controller-manager \\ --client-certificate=/etc/kubernetes/pki/controller-manager.pem \\ --client-key=/etc/kubernetes/pki/controller-manager-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®é»˜è®¤ç¯å¢ƒ kubectl config use-context system:kube-controller-manager@kubernetes \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.223.128:6443 \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-credentials system:kube-scheduler \\ --client-certificate=/etc/kubernetes/pki/scheduler.pem \\ --client-key=/etc/kubernetes/pki/scheduler-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-context system:kube-scheduler@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-scheduler \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config use-context system:kube-scheduler@kubernetes \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.223.128:6443 \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-credentials kubernetes-admin \\ --client-certificate=/etc/kubernetes/pki/admin.pem \\ --client-key=/etc/kubernetes/pki/admin-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-context kubernetes-admin@kubernetes \\ --cluster=kubernetes \\ --user=kubernetes-admin \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig ç”Ÿæˆ kube-proxy è¯ä¹¦ æ³¨æ„æ›¿æ¢ä¸‹é¢å‘½ä»¤ä¸­çš„ \u0026ndash;server\ncfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.223.128:6443 \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-credentials kube-proxy \\ --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \\ --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-context kube-proxy@kubernetes \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config use-context kube-proxy@kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig åˆ›å»º ServiceAccount Key $ openssl genrsa -out /etc/kubernetes/pki/sa.key 2048 $ openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub å…¶ä»–èŠ‚ç‚¹åˆ›å»ºç›®å½•\nfor i in k8s-worker1 k8s-worker2;do ssh $i \u0026quot;mkdir /etc/kubernetes/pki/ -p\u0026quot; scp -r /etc/kubernetes/pki $i:/etc/kubernetes/ done æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦ $ ls /etc/kubernetes/pki/ admin.csr ca.csr front-proxy-ca.csr kube-proxy.csr scheduler-key.pem admin-key.pem ca-key.pem front-proxy-ca-key.pem kube-proxy-key.pem scheduler.pem admin.pem ca.pem front-proxy-ca.pem kube-proxy.pem apiserver.csr controller-manager.csr front-proxy-client.csr sa.key apiserver-key.pem controller-manager-key.pem front-proxy-client-key.pem sa.pub apiserver.pem controller-manager.pem front-proxy-client.pem scheduler.csr # ä¸€å…± 26 ä¸ªå°±å¯¹äº† $ ls /etc/kubernetes/pki/ |wc -l 26 é…ç½® ETCD master èŠ‚ç‚¹ åœ¨ master èŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„ shellï¼Œæ³¨æ„å°†é…ç½®é‡Œçš„ IP æ”¹ä¸º master èŠ‚ç‚¹çš„ IPï¼Œhostname ä¹Ÿè¦ä¿®æ”¹æˆå¯¹åº”çš„ï¼Œinitial-cluster ä¿®æ”¹æˆå¯¹åº”çš„å‡ ä¸ªèŠ‚ç‚¹\n# å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: 'k8s-master' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.223.128:2380' listen-client-urls: 'https://192.168.223.128:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.223.128:2380' advertise-client-urls: 'https://192.168.223.128:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master=https://192.168.223.128:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF k8s-worker1 èŠ‚ç‚¹ # å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: 'k8s-worker1' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.223.129:2380' listen-client-urls: 'https://192.168.223.129:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.223.129:2380' advertise-client-urls: 'https://192.168.223.129:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF k8s-worker2 èŠ‚ç‚¹ # å¦‚æœè¦ç”¨ IPv6 é‚£ä¹ˆæŠŠ IPv4 åœ°å€ä¿®æ”¹ä¸º IPv6 å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: 'k8s-worker2' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.223.130:2380' listen-client-urls: 'https://192.168.223.130:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.223.130:2380' advertise-client-urls: 'https://192.168.223.130:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF åˆ›å»º etcd å¯åŠ¨æœåŠ¡ï¼ˆéœ€è¦åœ¨æ‰€æœ‰ master èŠ‚ç‚¹æ“ä½œï¼‰\ncat \u0026gt; /usr/lib/systemd/system/etcd.service \u0026lt;\u0026lt; EOF [Unit] Description=Etcd Service Documentation=https://coreos.com/etcd/docs/latest/ After=network.target [Service] Type=notify ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml Restart=on-failure RestartSec=10 LimitNOFILE=65536 [Install] WantedBy=multi-user.target Alias=etcd3.service EOF æ‹·è´ ETCD è¯ä¹¦\nmkdir /etc/kubernetes/pki/etcd ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/ systemctl daemon-reload systemctl enable --now etcd æŸ¥çœ‹ etcd çŠ¶æ€\n$ etcdctl --endpoints=\u0026quot;k8s-master:2379\u0026quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem endpoint status --write-out=table ä¹‹å‰çš„é…ç½®æ–‡ä»¶å†™é”™äº†ï¼Œåº”è¯¥åªæœ‰ master èŠ‚ç‚¹éœ€è¦è¿è¡Œ etcdï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­çš„ initial-cluster éœ€è¦æ”¹ä¸º k8s-master=https://192.168.223.128:2380\u0026rsquo;ï¼Œä¹Ÿå°±æ˜¯åªæ·»åŠ  master æœ¬èº«å³å¯ï¼Œåˆ æ‰ä¹‹å‰åŠ å…¥çš„ä¸¤ä¸ª worker èŠ‚ç‚¹ï¼Œä¿®æ”¹ä¸ºï¼š\ninitial-cluster: 'k8s-master=https://192.168.223.128:2380'\nç„¶åæ‰§è¡Œ\n$ systemctl daemon-reload $ sudo systemctl restart etcd é‡æ–°è¿è¡Œ etcdï¼Œä½†æ˜¯å‘ç°æ— æ³•è¿è¡Œï¼Œæ‰‹åŠ¨æ‰§è¡Œ etcd \u0026ndash;config-file=/etc/etcd/etcd.config.ymlï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ sudo journalctl -u etcdï¼‰ï¼Œå‘ç°æ—¥å¿—é‡Œè¾“å‡º \u0026ldquo;error\u0026rdquo;:\u0026ldquo;dial tcp 192.168.223.129:2380: connect: connection refused\u0026rdquo;ï¼Œè¿™è¡¨ç¤º etcd ä¾æ—§åœ¨å°è¯•è¿æ¥ worker1 çš„ etcdï¼Œæ˜æ˜æ”¹äº† initial-clusterï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆå‘¢ï¼Ÿ\næˆ‘é‡æ–°æ’æŸ¥æ—¥å¿—ï¼Œå‘ç°æœ‰è¿™ä¹ˆä¸€è¡Œæœ‰ç‚¹å¯ç–‘ï¼š\n{\u0026ldquo;level\u0026rdquo;:\u0026ldquo;info\u0026rdquo;,\u0026ldquo;ts\u0026rdquo;:\u0026ldquo;2023-04-15T16:58:41.252Z\u0026rdquo;,\u0026ldquo;caller\u0026rdquo;:\u0026ldquo;etcdmain/etcd.go:116\u0026rdquo;,\u0026ldquo;msg\u0026rdquo;:\u0026ldquo;server has been already initialized\u0026rdquo;,\u0026ldquo;data-dir\u0026rdquo;:\u0026quot;/var/lib/etcd\u0026quot;,\u0026ldquo;dir-type\u0026rdquo;:\u0026ldquo;member\u0026rdquo;}\nå°è¯•åˆ æ‰ /var/lib/etcd/memberï¼Œå†æ¬¡æ‰§è¡Œ sudo systemctl restart etcdï¼Œå‘ç°å‘½ä»¤ä¸ä¼šé˜»å¡äº†ï¼Œetcd æˆåŠŸè¿è¡Œã€‚ï¼ˆæ­¤æ—¶æˆ‘åªæƒ³å¤¸è‡ªå·±ä¸€å¥ç‰›é€¼ plusï¼‰\nå¦‚æœè¾“å‡ºä¸‹é¢è¿™äº›å†…å®¹ï¼Œè¯´æ˜ä½ æå¯¹äº†\n+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | k8s-master:2379 | 2918d818e481030f | 3.5.4 | 20 kB | true | false | 5 | 10 | 10 | | +-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ ApiServer é…ç½® åˆ›å»º apiserver æœåŠ¡å¯åŠ¨æ–‡ä»¶\néœ€è¦åœ¨æ¯å°èŠ‚ç‚¹è‡ªè¡Œä¿®æ”¹å¯¹åº”çš„ä¿¡æ¯\n\u0026ndash;advertise-address å½“å‰èŠ‚ç‚¹ IP \u0026ndash;etcd-servers ETCD èŠ‚ç‚¹ä¿¡æ¯ \u0026ndash;secure-port apiserver ç«¯å£å· cat \u0026gt; /usr/lib/systemd/system/kube-apiserver.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --logtostderr=true \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.223.128 \\ --service-cluster-ip-range=10.96.0.0/12,fd00::/108 \\ --feature-gates=IPv6DualStack=true \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://k8s-master:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User \\ --enable-aggregator-routing=true # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF å¯åŠ¨ apiserverï¼ˆæ‰€æœ‰ master èŠ‚ç‚¹ï¼‰\nfor i in k8s-01 k8s-02 k8s-03;do ssh $i \u0026ldquo;systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable \u0026ndash;now kube-apiserver\u0026rdquo; echo \u0026ldquo;$i\u0026rdquo; sleep 5 ssh $i \u0026ldquo;systemctl status kube-apiserver\u0026rdquo; done\nå• master èŠ‚ç‚¹åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„ï¼š\n$ systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now kube-apiserver $ sleep 5 $ systemctl status kube-apiserver å¦‚æœè¾“å‡ºç±»ä¼¼è¿™æ ·ï¼Œå³ Active: active (running)ï¼Œåˆ™ä»£è¡¨æˆåŠŸ\nâ— kube-apiserver.service - Kubernetes API Server Loaded: loaded (/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: enabled) Active: active (running) since Sat 2023-04-15 18:01:27 UTC; 6s ago Docs: https://github.com/kubernetes/kubernetes Main PID: 54969 (kube-apiserver) Tasks: 15 (limit: 9362) Memory: 290.8M CPU: 3.201s Controller-Manage é…ç½® 172.16.0.0/12 ä¸º pod ç½‘æ®µï¼ŒæŒ‰éœ€æ±‚è®¾ç½®ä½ è‡ªå·±çš„ç½‘æ®µ\ncat \u0026gt; /usr/lib/systemd/system/kube-controller-manager.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-controller-manager \\ --v=2 \\ --logtostderr=true \\ --bind-address=127.0.0.1 \\ --root-ca-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\ --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\ --leader-elect=true \\ --use-service-account-credentials=true \\ --node-monitor-grace-period=40s \\ --node-monitor-period=5s \\ --pod-eviction-timeout=2m0s \\ --controllers=*,bootstrapsigner,tokencleaner \\ --allocate-node-cidrs=true \\ --feature-gates=IPv6DualStack=true \\ --service-cluster-ip-range=10.96.0.0/12,fd00::/108 \\ --cluster-cidr=172.16.0.0/12,fc00::/48 \\ --node-cidr-mask-size-ipv4=24 \\ --node-cidr-mask-size-ipv6=64 \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF é…ç½®æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹\nfor i in k8s-02 k8s-03;do scp /usr/lib/systemd/system/kube-controller-manager.service $i:/usr/lib/systemd/system/ scp /etc/kubernetes/controller-manager.kubeconfig $i:/etc/kubernetes/ done\næˆ‘è¿™è¾¹å°±ç”¨ä¸ç€äº†\nå¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡\nfor i in k8s-01 k8s-02 k8s-03;do ssh $i \u0026ldquo;systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable \u0026ndash;now kube-controller-manager \u0026amp;\u0026amp; systemctl status kube-controller-manager\u0026rdquo; done\næˆ‘è¿™é‡Œä¹Ÿç”¨ä¸ç€äº†ï¼Œåªéœ€è¦æ‰§è¡Œä¸‹é¢è¿™æ®µå³å¯\n$ systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now kube-controller-manager \u0026amp;\u0026amp; systemctl status kube-controller-manager è¾“å‡ºç±»ä¼¼ä¸‹é¢è¿™æ ·\nCreated symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service â†’ /lib/systemd/system/kube-controller-manager.service. â— kube-controller-manager.service - Kubernetes Controller Manager Loaded: loaded (/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: enabled) Active: active (running) since Sat 2023-04-15 18:14:05 UTC; 5ms ago Docs: https://github.com/kubernetes/kubernetes Main PID: 55081 (kube-controller) Tasks: 6 (limit: 9362) Memory: 1.6M CPU: 3ms Scheduler é…ç½® cat \u0026gt; /usr/lib/systemd/system/kube-scheduler.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-scheduler \\ --v=2 \\ --logtostderr=true \\ --bind-address=127.0.0.1 \\ --leader-elect=true \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF é…ç½®æ–‡ä»¶æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹\nfor i in k8s-02 k8s-03;do scp /usr/lib/systemd/system/kube-scheduler.service $i:/usr/lib/systemd/system/ scp /etc/kubernetes/scheduler.kubeconfig $i:/etc/kubernetes/ done\nå¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡\nfor i in k8s-01 k8s-02 k8s-03;do ssh $i \u0026ldquo;systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable \u0026ndash;now kube-scheduler \u0026amp;\u0026amp; systemctl status kube-scheduler\u0026rdquo; done\n$ systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now kube-scheduler \u0026amp;\u0026amp; systemctl status kube-scheduler ä¸Šä¸‹æ–‡é…ç½® cd /root/bootstrap kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true --server=https://192.168.223.128:6443 \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-credentials tls-bootstrap-token-user \\ --token=c8ad9c.2e4d610cf3e7426e \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-context tls-bootstrap-token-user@kubernetes \\ --cluster=kubernetes \\ --user=tls-bootstrap-token-user \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config use-context tls-bootstrap-token-user@kubernetes \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig # tokençš„ä½ç½®åœ¨bootstrap.secret.yamlï¼Œå¦‚æœä¿®æ”¹çš„è¯åˆ°è¿™ä¸ªæ–‡ä»¶ä¿®æ”¹ mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config æŸ¥çœ‹é›†ç¾¤çŠ¶æ€\n$ kubectl get cs # è¿™æ ·å°±å¯¹äº† Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\u0026quot;health\u0026quot;:\u0026quot;true\u0026quot;,\u0026quot;reason\u0026quot;:\u0026quot;\u0026quot;} æ‰§è¡Œ\n$ kubectl create -f bootstrap.secret.yaml kubelet åˆ›å»º kubelet å¯åŠ¨æ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/kubelet.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes After=containerd.service Requires=containerd.service [Service] ExecStart=/usr/local/bin/kubelet \\ --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig \\ --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\ --config=/etc/kubernetes/kubelet-conf.yml \\ --container-runtime=remote \\ --runtime-request-timeout=15m \\ --container-runtime-endpoint=unix:///run/containerd/containerd.sock \\ --cgroup-driver=systemd \\ --node-labels=node.kubernetes.io/node='' \\ --feature-gates=IPv6DualStack=true [Install] WantedBy=multi-user.target EOF åˆ›å»º kubelet é…ç½®æ–‡ä»¶ cat \u0026gt; /etc/kubernetes/kubelet-conf.yml \u0026lt;\u0026lt;EOF apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration address: 0.0.0.0 port: 10250 readOnlyPort: 10255 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd cgroupsPerQOS: true clusterDNS: - 10.96.0.10 clusterDomain: cluster.local containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /etc/kubernetes/manifests streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s EOF æ‹·è´è¯ä¹¦åˆ°å…¶å®ƒèŠ‚ç‚¹ for i in k8s-01 k8s-02 k8s-03;do\nssh $i \u0026ldquo;mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/kubernetes/manifests/\u0026rdquo; scp /etc/kubernetes/kubelet-conf.yml $i:/etc/kubernetes/\nscp /usr/lib/systemd/system/kubelet.service $i:/usr/lib/systemd/system/\nscp /etc/kubernetes/bootstrap-kubelet.kubeconfig $i:/etc/kubernetes/ done\n$ mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/kubernetes/manifests/ å¯åŠ¨æœåŠ¡ systemctl daemon-reload systemctl enable --now kubelet systemctl status kubelet æŸ¥çœ‹é›†ç¾¤ $ kubectl get node No resources found å¤±è´¥äº†ã€‚ã€‚ã€‚æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹\nå‚è€ƒ https://i4t.com/5636.html\n","date":"2023å¹´04æœˆ13æ—¥","permalink":"/posts/k8s-binray-install/","summary":"ç¯å¢ƒ ä¸»æœºç³»ç»Ÿä¸º win11ï¼Œé€šè¿‡ vmware åˆ›å»ºäº† 3 å°è™šæ‹Ÿæœºï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š","title":"K8s äºŒè¿›åˆ¶å®‰è£…"},{"contents":"Nginx åä»£ package main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;net/http\u0026quot; ) var ( mark string ip string port string ) func main() { flag.StringVar(\u0026amp;mark, \u0026quot;m\u0026quot;, \u0026quot;001\u0026quot;, \u0026quot;mark\u0026quot;) flag.StringVar(\u0026amp;ip, \u0026quot;h\u0026quot;, \u0026quot;localhost\u0026quot;, \u0026quot;ip\u0026quot;) flag.StringVar(\u0026amp;port, \u0026quot;p\u0026quot;, \u0026quot;8080\u0026quot;, \u0026quot;port\u0026quot;) flag.Parse() fmt.Printf(\u0026quot;listen in %v:%v, mark: %v\\n\u0026quot;, ip, port, mark) http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(fmt.Sprintf(\u0026quot;You visited %s\u0026quot;, mark))) }) if err := http.ListenAndServe(fmt.Sprintf(\u0026quot;%s:%s\u0026quot;, ip, port), nil); err != nil { panic(err) } } $ go run http_server.go -m 001 -p 8081 \u0026amp; $ go run http_server.go -m 002 -p 8082 \u0026amp; $ go run http_server.go -m 003 -p 8083 \u0026amp; http { upstream myapp { server 127.0.0.1:8081; server 127.0.0.1:8082; server 127.0.0.1:8083; } server { listen 8000; server_name localhost; location / { proxy_pass http://myapp; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } } è®¿é—® localhost:8000ï¼Œä¼šéšæœºæ˜¾ç¤º You visited 001, You visited 002, You visited 003\nTODOï¼šè§‚å¯Ÿ 8080 çš„å“åº”å¤´\nä¿®æ”¹å“åº”ä½“ package main import ( \u0026quot;encoding/json\u0026quot; \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;net/http\u0026quot; ) var ( ip string port string ) type Resp struct { HTTPCode string Code string Msg string } func main() { flag.StringVar(\u0026amp;ip, \u0026quot;h\u0026quot;, \u0026quot;localhost\u0026quot;, \u0026quot;ip\u0026quot;) flag.StringVar(\u0026amp;port, \u0026quot;p\u0026quot;, \u0026quot;8080\u0026quot;, \u0026quot;port\u0026quot;) flag.Parse() fmt.Printf(\u0026quot;listen in %v:%v\\n\u0026quot;, ip, port) http.HandleFunc(\u0026quot;/suc\u0026quot;, func(w http.ResponseWriter, r *http.Request) { b, err := json.Marshal(\u0026amp;Resp{HTTPCode: \u0026quot;200\u0026quot;, Code: \u0026quot;10000\u0026quot;, Msg: \u0026quot;success.\u0026quot;}) if err != nil { w.WriteHeader(http.StatusInternalServerError) w.Write([]byte(err.Error())) return } w.WriteHeader(http.StatusOK) w.Write(b) }) http.HandleFunc(\u0026quot;/err\u0026quot;, func(w http.ResponseWriter, r *http.Request) { b, err := json.Marshal(\u0026amp;Resp{HTTPCode: \u0026quot;500\u0026quot;, Code: \u0026quot;20000\u0026quot;, Msg: \u0026quot;error.\u0026quot;}) if err != nil { w.WriteHeader(http.StatusInternalServerError) w.Write([]byte(err.Error())) return } w.WriteHeader(http.StatusInternalServerError) w.Write(b) }) if err := http.ListenAndServe(fmt.Sprintf(\u0026quot;%s:%s\u0026quot;, ip, port), nil); err != nil { panic(err) } } http { gzip on; gzip_types text/plain text/css application/json application/javascript; gzip_min_length 1000; gzip_proxied any; server { listen 80; server_name example.com; location /api { proxy_pass http://backend; sub_filter_types application/json; sub_filter 'foo': 'bar'; sub_filter_last_modified on; sub_filter_once off; proxy_set_header Accept-Encoding \u0026quot;\u0026quot;; proxy_set_header Connection \u0026quot;\u0026quot;; proxy_http_version 1.1; proxy_set_header Host $host; } } } ","date":"2023å¹´04æœˆ07æ—¥","permalink":"/posts/nginx-practice/","summary":"Nginx åä»£ package main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;net/http\u0026quot; ) var ( mark string ip string port string ) func main() { flag.","title":"é€šè¿‡å®è·µå­¦ä¹  Nginx"},{"contents":"Opaque Secret è¦æ±‚ value å¿…é¡»æ˜¯ base64 ç¼–ç çš„\næµ‹è¯•ï¼šå¦‚æœ value ä¸æ˜¯ base64 å‘¢ï¼Ÿ å‡†å¤‡å¦‚ä¸‹ yaml ç”¨æ¥åˆ›å»º secretï¼Œå…¶ä¸­ value ä¸æ˜¯ base64 æ ¼å¼çš„ï¼š\nsecret_not_base64.yaml\napiVersion: v1 kind: Secret metadata: name: mysecret-not-base64 type: Opaque data: user: root pass: 123r è¿è¡Œå¹¶æŸ¥çœ‹ï¼š\n$ kubectl apply -f secret_not_base64.yaml $ kubectl get secret NAME TYPE DATA AGE mysecret-not-base64 Opaque 2 42m $ kubectl get secret mysecret-not-base64 -oyaml apiVersion: v1 data: pass: 123r user: root kind: Secret metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | {\u0026quot;apiVersion\u0026quot;:\u0026quot;v1\u0026quot;,\u0026quot;data\u0026quot;:{\u0026quot;pass\u0026quot;:\u0026quot;123r\u0026quot;,\u0026quot;user\u0026quot;:\u0026quot;root\u0026quot;},\u0026quot;kind\u0026quot;:\u0026quot;Secret\u0026quot;,\u0026quot;metadata\u0026quot;:{\u0026quot;annotations\u0026quot;:{},\u0026quot;name\u0026quot;:\u0026quot;mysecret-not-base64\u0026quot;,\u0026quot;namespace\u0026quot;:\u0026quot;default\u0026quot;},\u0026quot;type\u0026quot;:\u0026quot;Opaque\u0026quot;} creationTimestamp: \u0026quot;2022-10-10T14:25:30Z\u0026quot; name: mysecret-not-base64 namespace: default resourceVersion: \u0026quot;158457\u0026quot; uid: 44ae7fda-3f7f-4da3-95b1-c3068727d765 type: Opaque è²Œä¼¼æ²¡ä»€ä¹ˆå½±å“å•Šï¼Ÿå¯ä»¥æ­£å¸¸åˆ›å»ºï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å…¶ä¸­çš„å€¼ï¼Œç»§ç»­æµ‹è¯•çœ‹çœ‹\nè¯¥ yaml ä»åä¸º mysecret-not-base64 çš„ secret ä¸­å¼•ç”¨å€¼ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œç„¶åä¼šæ‰§è¡Œ env å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿé‡Œçš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆbusybox æ˜¯ä¸€ä¸ªé›†æˆäº†ä¸€äº› linux åŒæ ·å‘½ä»¤çš„é•œåƒï¼‰\nsecret_not_base64_pod.yaml\napiVersion: v1 kind: Pod metadata: name: secret-not-base64-pod spec: containers: - name: secret1 image: busybox command: [ \u0026quot;/bin/sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;env\u0026quot; ] env: - name: USERNAME # è®¾ç½®åä¸º USERNAME çš„ç¯å¢ƒå˜é‡ï¼Œå…¶å€¼å¼•ç”¨ mysecret-not-base64 ä¸­çš„ user å­—æ®µ valueFrom: secretKeyRef: name: mysecret-not-base64 key: user - name: PASSWORD valueFrom: secretKeyRef: name: mysecret-not-base64 key: pass è¿è¡Œå¹¶æŸ¥çœ‹ï¼š\n$ kubectl apply -f secret_not_base64_pod.yaml $ kubectl logs secret-not-base64-pod KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://10.96.0.1:443 HOSTNAME=secret-not-base64-pod SHLVL=1 HOME=/root USERNAME=ï¿½ï¿½- KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 KUBERNETES_SERVICE_HOST=10.96.0.1 PWD=/ PASSWORD=ï¿½mï¿½ å‘ç°æˆ‘ä»¬è®¾ç½®çš„ä¸¤ä¸ªç¯å¢ƒå˜é‡ USERNAME å’Œ PASSWORD çš„å€¼éƒ½æ˜¾ç¤ºä¸ºä¹±ç ï¼Œè«éå¦‚æœå¼•ç”¨äº†Opaque ç±»å‹çš„ secret ä¸­çš„å­—æ®µï¼Œä¼šæ‰§è¡Œè§£ç æ“ä½œï¼Œå°†è§£ç å‡ºæ¥çš„å€¼ä½œä¸º value è¿›è¡Œè®¾ç½®å—ï¼Ÿ\nä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å†å°è¯•åšä¸€ä¸ª value æ˜¯ base64 ç¼–ç è¿‡çš„ secretï¼š\nsecret.yaml\napiVersion: v1 kind: Secret metadata: name: mysecret type: Opaque data: user: YWRtaW4= pass: MWYyZDFlMmU2N2Rm tipsï¼šlinux/mac è‡ªå¸¦äº† base64 å‘½ä»¤ï¼Œå¯ä»¥æ–¹ä¾¿çš„è·å–å€¼çš„ base64:\n$ echo -n \u0026quot;admin\u0026quot; | base64 YWRtaW4= $ echo -n \u0026quot;admin321\u0026quot; | base64 YWRtaW4zMjE= $ echo \u0026quot;YWRtaW4=\u0026quot; | base64 -d admin # è§£å¯† $ echo \u0026quot;MWYyZDFlMmU2N2Rm\u0026quot; | base64 -d 1f2d1e2e67df secret_base64_pod.yaml\napiVersion: v1 kind: Pod metadata: name: secret-base64-pod spec: containers: - name: secret1 image: busybox command: [ \u0026quot;/bin/sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;env\u0026quot; ] env: - name: USERNAME valueFrom: secretKeyRef: name: mysecret key: user - name: PASSWORD valueFrom: secretKeyRef: name: mysecret key: pass è¿è¡Œï¼š\n$ kubectl apply -f secret_base64_pod.yaml pod/secret-base64-pod created $ kubectl logs secret-base64-pod KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://10.96.0.1:443 HOSTNAME=secret-base64-pod SHLVL=1 HOME=/root USERNAME=admin KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 KUBERNETES_SERVICE_HOST=10.96.0.1 PWD=/ PASSWORD=1f2d1e2e67df å‘ç°ç¯å¢ƒå˜é‡ USERNAME å’Œ PASSWORD çš„å€¼éƒ½æ­£å¸¸æ˜¾ç¤ºäº†ï¼Œçœ‹æ¥ç¡®å®æ˜¯è¿™æ ·ï¼Œå½“å¼•ç”¨Opaque ç±»å‹çš„ secret ä¸­çš„å€¼æ—¶ï¼Œä¼šè‡ªåŠ¨åš base64 è§£ç æ“ä½œ\nå†è¯•è¯•ç”¨æŒ‚è½½çš„æ–¹å¼ï¼š\nè¿™é‡Œå°† mysecret è¿™ä¸ª secret ä¸‹çš„æ‰€æœ‰æ¡ç›®æŒ‚è½½åˆ°äº†å®¹å™¨å†…çš„ /projected-volume ç›®å½•ä¸‹ï¼Œmysecret å°±æ˜¯ä¸Šé¢å®šä¹‰çš„ secret.yamlï¼š\nsecret-test-pod.yaml\napiVersion: v1 kind: Pod metadata: name: test-projected-volume spec: containers: - name: test-secret-volume image: busybox args: - sleep - \u0026quot;86400\u0026quot; volumeMounts: - name: mysql-cred mountPath: \u0026quot;/projected-volume\u0026quot; readOnly: true volumes: - name: mysql-cred projected: sources: - secret: name: mysecret è¿è¡Œå¹¶æŸ¥çœ‹æ•ˆæœï¼š\n$ kubectl apply -f secret-test-pod.yaml pod/test-projected-volume created $ kubectl get po NAME READY STATUS RESTARTS AGE test-projected-volume 1/1 Running 0 7s $ kubectl exec -it test-projected-volume -- cat /projected-volume/pass 1f2d1e2e67df% $ kubectl exec -it test-projected-volume -- cat /projected-volume/user admin% å‘ç°è¿™é‡Œå°† secret ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½å•ç‹¬åšæˆäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”æ–‡ä»¶å†…å®¹éƒ½æ˜¯å·²ç»è§£ç è¿‡çš„å€¼\nå†è¯•è¯•æŒ‚è½½å¼•ç”¨ä¹‹å‰é‚£ä¸ª value ä¸æ˜¯ base64 çš„ secretï¼š\napiVersion: v1 kind: Pod metadata: name: test-projected-volume-not-base64 spec: containers: - name: test-secret-volume image: busybox args: - sleep - \u0026quot;86400\u0026quot; volumeMounts: - name: mysql-cred mountPath: \u0026quot;/projected-volume\u0026quot; readOnly: true volumes: - name: mysql-cred projected: sources: - secret: name: mysecret-not-base64 # ä¿®æ”¹è¿™é‡Œ è¿è¡Œï¼š\n$ kubectl exec -it test-projected-volume-not-base64 -- cat /projected-volume/user ??-% $ kubectl exec -it test-projected-volume-not-base64 -- cat /projected-volume/pass ?m?% å‘ç°ä¹±ç äº†\n","date":"2022å¹´10æœˆ10æ—¥","permalink":"/posts/k8s-secret/","summary":"Opaque Secret è¦æ±‚ value å¿…é¡»æ˜¯ base64 ç¼–ç çš„","title":"k8s Secret"},{"contents":"æ¶æ„ Informers ç”±å‡ ä¸ªæ ¸å¿ƒçš„ç»„ä»¶æ„æˆï¼š\nReflectorï¼šè´Ÿè´£ä» api-server listï¼ˆå…¨é‡æ‹‰å–æ•°æ®ï¼‰ and watchï¼ˆç›‘å¬æ•°æ®å˜æ›´ï¼‰ DeltaFIFOï¼šä¸€ä¸ªå­˜å‚¨äº‹ä»¶çš„é˜Ÿåˆ—ï¼Œé‡Œé¢è®°å½•äº†äº‹ä»¶çš„ç±»å‹ Indexerï¼šå­˜å‚¨æ•°æ®ï¼Œæ•°æ®æ¥æºæ˜¯ä» DeltaFIFO ä¸­ pop å‡ºæ¥çš„ï¼Œç„¶åä¼šæ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œå¯¹äºçš„æ“ä½œ sharedProcessorï¼šç”¨äºè¿è¡Œç”¨æˆ·è®¾ç½®çš„äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œé‡Œé¢ç”¨ map å­˜å‚¨äº†æ‰€æœ‰çš„ listenerï¼Œæ¯æ¬¡è°ƒç”¨ AddEventHandler éƒ½ä¼šåˆ›å»ºä¸€ä¸ª listenerï¼ŒåŒæ—¶è¿™ä¸ªå‡½æ•°å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¤šä¸ª listenerï¼Œå½“å‘é€äº‹ä»¶æ—¶ï¼Œä¼šè°ƒç”¨æ‰€æœ‰çš„ listener çš„å¯¹åº”å›è°ƒå‡½æ•° controllerï¼šä¸Šé¢æåˆ°çš„ Reflectorã€DeltaFIFOã€Indexer å„è‡ªæœ‰å„è‡ªçš„ä½œç”¨ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´è¿˜æ²¡æœ‰å…³è”èµ·æ¥ï¼Œè€Œ controller å°±æ˜¯è´Ÿè´£è¿™ä»¶äº‹çš„ï¼Œå®ƒæ˜¯è¿™ 3 ä¸ªç»„ä»¶çš„ masterï¼Œè®©å®ƒä»¬å¯ä»¥ååŒè¿ä½œï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼šå½“ Reflector watch åˆ°äº‹ä»¶æ—¶ä¼šå°†å…¶ä¿å­˜åˆ° DeltaFIFO ä¸­ï¼Œcontroller è¿™ä»¶ä¼šæŒç»­ä» DeltaFIFO ä¸­ pop å…ƒç´ ï¼Œç„¶åæ ¹æ®äº‹ä»¶ç±»å‹å¯¹ indexer è¿›è¡Œç›¸åº”æ“ä½œï¼ˆaddã€updateã€deleteï¼‰ï¼Œä½¿å¾— indexer ä¸­çš„æ•°æ®å’Œ api-server ä¸­çš„ä¸€è‡´ï¼ŒåŒæ—¶è¿˜ä¼šè°ƒç”¨ sharedProcessor çš„å¯¹åº”å›è°ƒï¼Œæ¥å®Œæˆç”¨æˆ·è®¾ç½®çš„å¯¹åº”äº‹ä»¶æ“ä½œã€‚ informers/factory.go types sharedInformerFactory type sharedInformerFactory struct { client kubernetes.Interface namespace string tweakListOptions internalinterfaces.TweakListOptionsFunc lock sync.Mutex defaultResync time.Duration customResync map[reflect.Type]time.Duration informers map[reflect.Type]cache.SharedIndexInformer // startedInformers is used for tracking which informers have been started. // This allows Start() to be called multiple times safely. startedInformers map[reflect.Type]bool // wg tracks how many goroutines were started. wg sync.WaitGroup // shuttingDown is true when Shutdown has been called. It may still be running // because it needs to wait for goroutines. shuttingDown bool } Start() // Start initializes all requested informers. func (f *sharedInformerFactory) Start(stopCh \u0026lt;-chan struct{}) { f.lock.Lock() defer f.lock.Unlock() // éå† factory ä¸­å·²æ³¨å†Œçš„ informerï¼Œå¦‚æœè¯¥ informer è¿˜æœªè¿è¡Œè¿‡ï¼Œåˆ™è¿è¡Œå®ƒ for informerType, informer := range f.informers { if !f.startedInformers[informerType] {\t// è¿˜æœªè¿è¡Œè¿‡ go informer.Run(stopCh)\t// è¿è¡Œè¯¥ informer f.startedInformers[informerType] = true\t// æ ‡è®°ä¸ºå·²è¿è¡Œ } } } InformerFor() InformerFor å¡«å…… sharedInformerFactory çš„ informers å­—æ®µ\nä¼šæ£€æŸ¥è¯¥ type æ˜¯å¦å·²ç»æ³¨å†Œï¼Œå¦‚æœæ²¡æ³¨å†Œåˆ™ä¼šè°ƒç”¨ä¼ é€’è¿›æ¥çš„ newFunc å›è°ƒå‡½æ•°è¿›è¡Œåˆ›å»ºï¼Œå¹¶æ³¨å†Œåˆ° informers ä¸­\n// InternalInformerFor returns the SharedIndexInformer for obj using an internal // client. func (f *sharedInformerFactory) InformerFor(obj runtime.Object, newFunc internalinterfaces.NewInformerFunc) cache.SharedIndexInformer { f.lock.Lock() defer f.lock.Unlock() // ä½¿ç”¨åå°„è·å– obj çš„ç±»å‹ informerType := reflect.TypeOf(obj) // æŸ¥çœ‹æ˜¯å¦å·²æ³¨å†Œè¿‡è¯¥ informerTypeï¼Œå¦‚æœæ³¨å†Œè¿‡åˆ™ç›´æ¥è¿”å›ï¼Œç¬¦åˆäº† shared çš„å®šä¹‰ informer, exists := f.informers[informerType] if exists { return informer } resyncPeriod, exists := f.customResync[informerType] if !exists { resyncPeriod = f.defaultResync } // èµ°åˆ°è¿™é‡Œè¯´æ˜ informerType è¿˜æœªæ³¨å†Œè¿‡ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ª informer å¹¶æ³¨å†Œ informer = newFunc(f.client, resyncPeriod) f.informers[informerType] = informer return informer } ç¤ºä¾‹ æ¯”å¦‚æœ‰ä¸€ä¸ª podInformerï¼Œå®ƒæœ‰ä¸€ä¸ª Informer æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ InformerFor\nfunc (f *podInformer) Informer() cache.SharedIndexInformer { return f.factory.InformerFor(\u0026amp;corev1.Pod{}, f.defaultInformer) } å®ƒä¼ é€’çš„å›è°ƒå‡½æ•°æ˜¯ f.defaultInformerï¼Œè¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\nfunc (f *podInformer) defaultInformer(client kubernetes.Interface, resyncPeriod time.Duration) cache.SharedIndexInformer { return NewFilteredPodInformer(client, f.namespace, resyncPeriod, cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}, f.tweakListOptions) } è¯¥å‡½æ•°åˆè°ƒç”¨äº† NewFilteredPodInformerï¼š\n// NewFilteredPodInformer constructs a new informer for Pod type. // Always prefer using an informer factory to get a shared informer instead of getting an independent // one. This reduces memory footprint and number of connections to the server. func NewFilteredPodInformer(client kubernetes.Interface, namespace string, resyncPeriod time.Duration, indexers cache.Indexers, tweakListOptions internalinterfaces.TweakListOptionsFunc) cache.SharedIndexInformer { return cache.NewSharedIndexInformer( \u0026amp;cache.ListWatch{ ListFunc: func(options metav1.ListOptions) (runtime.Object, error) { if tweakListOptions != nil { tweakListOptions(\u0026amp;options) } return client.CoreV1().Pods(namespace).List(context.TODO(), options) }, WatchFunc: func(options metav1.ListOptions) (watch.Interface, error) { if tweakListOptions != nil { tweakListOptions(\u0026amp;options) } return client.CoreV1().Pods(namespace).Watch(context.TODO(), options) }, }, \u0026amp;corev1.Pod{}, resyncPeriod, indexers, ) } è¿™ä¸ªå‡½æ•°åˆè°ƒç”¨äº† NewSharedIndexInformer ï¼Œæœ€ç»ˆä¼šåˆ›å»ºå‡ºä¸€ä¸ª SharedIndexInformerï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨ tools/cache/shared_informer.go\nfunctions NewSharedInformerFactory å®é™…è°ƒç”¨çš„æ˜¯ NewSharedInformerFactoryWithOptions\n// NewSharedInformerFactory constructs a new instance of sharedInformerFactory for all namespaces. func NewSharedInformerFactory(client kubernetes.Interface, defaultResync time.Duration) SharedInformerFactory { return NewSharedInformerFactoryWithOptions(client, defaultResync) } NewSharedInformerFactoryWithOptions // NewSharedInformerFactoryWithOptions constructs a new instance of a SharedInformerFactory with additional options. func NewSharedInformerFactoryWithOptions(client kubernetes.Interface, defaultResync time.Duration, options ...SharedInformerOption) SharedInformerFactory { factory := \u0026amp;sharedInformerFactory{ client: client, namespace: v1.NamespaceAll, defaultResync: defaultResync, informers: make(map[reflect.Type]cache.SharedIndexInformer), startedInformers: make(map[reflect.Type]bool), customResync: make(map[reflect.Type]time.Duration), } // Apply all options for _, opt := range options { factory = opt(factory) } return factory } tools/cache/shared_informer.go types sharedIndexInformer sharedIndexInformer ç»“æ„ä½“ï¼Œé‡Œé¢çš„å‡ ä¸ªæ ¸å¿ƒå±æ€§æ˜¯ç”¨æ¥ list-watch çš„ listerWatcherï¼Œè´Ÿè´£å­˜å‚¨çš„ indexerï¼Œè´Ÿè´£æ‰§è¡Œæ•´å¥—æµç¨‹çš„çš„ controllerï¼ˆä» reflector ä¸­ list-watchï¼Œä» DefltaFIFO ä¸­ pop å¹¶æ›´æ–° indexerï¼‰ï¼Œè´Ÿè´£æ‰§è¡Œç”¨æˆ·è®¾ç½®çš„ eventHandle çš„ processor\n// `*sharedIndexInformer` implements SharedIndexInformer and has three // main components. One is an indexed local cache, `indexer Indexer`. // The second main component is a Controller that pulls // objects/notifications using the ListerWatcher and pushes them into // a DeltaFIFO --- whose knownObjects is the informer's local cache // --- while concurrently Popping Deltas values from that fifo and // processing them with `sharedIndexInformer::HandleDeltas`. Each // invocation of HandleDeltas, which is done with the fifo's lock // held, processes each Delta in turn. For each Delta this both // updates the local cache and stuffs the relevant notification into // the sharedProcessor. The third main component is that // sharedProcessor, which is responsible for relaying those // notifications to each of the informer's clients. type sharedIndexInformer struct { indexer Indexer controller Controller processor *sharedProcessor cacheMutationDetector MutationDetector listerWatcher ListerWatcher // objectType is an example object of the type this informer is // expected to handle. Only the type needs to be right, except // that when that is `unstructured.Unstructured` the object's // `\u0026quot;apiVersion\u0026quot;` and `\u0026quot;kind\u0026quot;` must also be right. objectType runtime.Object // resyncCheckPeriod is how often we want the reflector's resync timer to fire so it can call // shouldResync to check if any of our listeners need a resync. resyncCheckPeriod time.Duration // defaultEventHandlerResyncPeriod is the default resync period for any handlers added via // AddEventHandler (i.e. they don't specify one and just want to use the shared informer's default // value). defaultEventHandlerResyncPeriod time.Duration // clock allows for testability clock clock.Clock started, stopped bool startedLock sync.Mutex // blockDeltas gives a way to stop all event distribution so that a late event handler // can safely join the shared informer. blockDeltas sync.Mutex // Called whenever the ListAndWatch drops the connection with an error. watchErrorHandler WatchErrorHandler transform TransformFunc } Run() Run ä¼šè°ƒç”¨ s.controller.Run\nfunc (s *sharedIndexInformer) Run(stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() if s.HasStarted() { klog.Warningf(\u0026quot;The sharedIndexInformer has started, run more than once is not allowed\u0026quot;) return } // åˆ›å»ºä¸€ä¸ª DeltaFIFO fifo := NewDeltaFIFOWithOptions(DeltaFIFOOptions{ KnownObjects: s.indexer, EmitDeltaTypeReplaced: true, }) // é…ç½®ç”¨æ¥åˆ›å»º controller çš„ Config cfg := \u0026amp;Config{ Queue: fifo, // è®¾ç½®ä¸º DeltaFIFO ListerWatcher: s.listerWatcher, ObjectType: s.objectType, FullResyncPeriod: s.resyncCheckPeriod, RetryOnError: false, ShouldResync: s.processor.shouldResync, Process: s.HandleDeltas, WatchErrorHandler: s.watchErrorHandler, } func() { s.startedLock.Lock() defer s.startedLock.Unlock() // åˆ›å»º controller s.controller = New(cfg) s.controller.(*controller).clock = s.clock s.started = true }() // Separate stop channel because Processor should be stopped strictly after controller processorStopCh := make(chan struct{}) var wg wait.Group defer wg.Wait() // Wait for Processor to stop defer close(processorStopCh) // Tell Processor to stop wg.StartWithChannel(processorStopCh, s.cacheMutationDetector.Run) wg.StartWithChannel(processorStopCh, s.processor.run) defer func() { s.startedLock.Lock() defer s.startedLock.Unlock() s.stopped = true // Don't want any new listeners }() // è¿è¡Œ controller s.controller.Run(stopCh) } HandleDeltas() å¯¹ DeltaFIFO ä¸­ pop å‡ºçš„å…ƒç´ è¿›è¡Œå¤„ç†\nfunc (s *sharedIndexInformer) HandleDeltas(obj interface{}) error { s.blockDeltas.Lock() defer s.blockDeltas.Unlock() if deltas, ok := obj.(Deltas); ok { // åˆè°ƒç”¨äº† processDeltasï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„æ˜¯ indexer return processDeltas(s, s.indexer, s.transform, deltas) } return errors.New(\u0026quot;object given as Process argument is not Deltas\u0026quot;) } AddEventHandler() æ·»åŠ äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä½†å‘ç”Ÿäº‹ä»¶æ—¶ï¼ˆaddï¼Œupdateï¼Œdeleteï¼‰ä¼šè°ƒç”¨å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œå®é™…è°ƒç”¨çš„æ˜¯AddEventHandlerWithResyncPeriodï¼Œè¯¥å‡½æ•°å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼ˆä¹Ÿå°±æ˜¯ add å¤šä¸ª EventHandlerï¼‰ï¼Œæ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ª listenerï¼Œå½“å‘ç”Ÿäº‹ä»¶æ—¶ï¼Œä¼šä¸€å¹¶é€šçŸ¥æ‰€æœ‰çš„ listener\nfunc (s *sharedIndexInformer) AddEventHandler(handler ResourceEventHandler) (ResourceEventHandlerRegistration, error) { return s.AddEventHandlerWithResyncPeriod(handler, s.defaultEventHandlerResyncPeriod) } AddEventHandlerWithResyncPeriod() è¯¥å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ª listener\nfunc (s *sharedIndexInformer) AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration) (ResourceEventHandlerRegistration, error) { s.startedLock.Lock() defer s.startedLock.Unlock() if s.stopped { return nil, fmt.Errorf(\u0026quot;handler %v was not added to shared informer because it has stopped already\u0026quot;, handler) } if resyncPeriod \u0026gt; 0 { if resyncPeriod \u0026lt; minimumResyncPeriod { klog.Warningf(\u0026quot;resyncPeriod %v is too small. Changing it to the minimum allowed value of %v\u0026quot;, resyncPeriod, minimumResyncPeriod) resyncPeriod = minimumResyncPeriod } if resyncPeriod \u0026lt; s.resyncCheckPeriod { if s.started { klog.Warningf(\u0026quot;resyncPeriod %v is smaller than resyncCheckPeriod %v and the informer has already started. Changing it to %v\u0026quot;, resyncPeriod, s.resyncCheckPeriod, s.resyncCheckPeriod) resyncPeriod = s.resyncCheckPeriod } else { // if the event handler's resyncPeriod is smaller than the current resyncCheckPeriod, update // resyncCheckPeriod to match resyncPeriod and adjust the resync periods of all the listeners // accordingly s.resyncCheckPeriod = resyncPeriod s.processor.resyncCheckPeriodChanged(resyncPeriod) } } } // åˆ›å»ºä¸€ä¸ª listener listener := newProcessListener(handler, resyncPeriod, determineResyncPeriod(resyncPeriod, s.resyncCheckPeriod), s.clock.Now(), initialBufferSize) if !s.started { return s.processor.addListener(listener), nil } // in order to safely join, we have to // 1. stop sending add/update/delete notifications // 2. do a list against the store // 3. send synthetic \u0026quot;Add\u0026quot; events to the new handler // 4. unblock s.blockDeltas.Lock() defer s.blockDeltas.Unlock() // å°† listener æ·»åŠ åˆ° s.processor handle := s.processor.addListener(listener) // éå†å½“å‰ indexer é‡Œçš„æ‰€æœ‰æ•°æ®ï¼Œå¯¹æ‰€æœ‰çš„ listener è¿›è¡Œé€šçŸ¥ for _, item := range s.indexer.List() { listener.add(addNotification{newObj: item}) } return handle, nil } OnAdd() // Conforms to ResourceEventHandler func (s *sharedIndexInformer) OnAdd(obj interface{}) { // Invocation of this function is locked under s.blockDeltas, so it is // save to distribute the notification s.cacheMutationDetector.AddObject(obj) s.processor.distribute(addNotification{newObj: obj}, false) } OnUpdate() // Conforms to ResourceEventHandler func (s *sharedIndexInformer) OnUpdate(old, new interface{}) { isSync := false // If is a Sync event, isSync should be true // If is a Replaced event, isSync is true if resource version is unchanged. // If RV is unchanged: this is a Sync/Replaced event, so isSync is true if accessor, err := meta.Accessor(new); err == nil { if oldAccessor, err := meta.Accessor(old); err == nil { // Events that didn't change resourceVersion are treated as resync events // and only propagated to listeners that requested resync isSync = accessor.GetResourceVersion() == oldAccessor.GetResourceVersion() } } // Invocation of this function is locked under s.blockDeltas, so it is // save to distribute the notification s.cacheMutationDetector.AddObject(new) s.processor.distribute(updateNotification{oldObj: old, newObj: new}, isSync) } OnDelete() // Conforms to ResourceEventHandler func (s *sharedIndexInformer) OnDelete(old interface{}) { // Invocation of this function is locked under s.blockDeltas, so it is // save to distribute the notification s.processor.distribute(deleteNotification{oldObj: old}, false) } sharedProcessor // sharedProcessor has a collection of processorListener and can // distribute a notification object to its listeners. There are two // kinds of distribute operations. The sync distributions go to a // subset of the listeners that (a) is recomputed in the occasional // calls to shouldResync and (b) every listener is initially put in. // The non-sync distributions go to every listener. type sharedProcessor struct { listenersStarted bool listenersLock sync.RWMutex // Map from listeners to whether or not they are currently syncing listeners map[*processorListener]bool clock clock.Clock wg wait.Group } addListener() func (p *sharedProcessor) addListener(listener *processorListener) { p.listenersLock.Lock() defer p.listenersLock.Unlock() p.addListenerLocked(listener) if p.listenersStarted { p.wg.Start(listener.run) p.wg.Start(listener.pop) } } distribute() func (p *sharedProcessor) distribute(obj interface{}, sync bool) { p.listenersLock.RLock() defer p.listenersLock.RUnlock() for listener, isSyncing := range p.listeners { switch { case !sync: // non-sync messages are delivered to every listener listener.add(obj) case isSyncing: // sync messages are delivered to every syncing listener listener.add(obj) default: // skipping a sync obj for a non-syncing listener } } } processorListener // processorListener relays notifications from a sharedProcessor to // one ResourceEventHandler --- using two goroutines, two unbuffered // channels, and an unbounded ring buffer. The `add(notification)` // function sends the given notification to `addCh`. One goroutine // runs `pop()`, which pumps notifications from `addCh` to `nextCh` // using storage in the ring buffer while `nextCh` is not keeping up. // Another goroutine runs `run()`, which receives notifications from // `nextCh` and synchronously invokes the appropriate handler method. // // processorListener also keeps track of the adjusted requested resync // period of the listener. type processorListener struct { nextCh chan interface{} addCh chan interface{} handler ResourceEventHandler // pendingNotifications is an unbounded ring buffer that holds all notifications not yet distributed. // There is one per listener, but a failing/stalled listener will have infinite pendingNotifications // added until we OOM. // TODO: This is no worse than before, since reflectors were backed by unbounded DeltaFIFOs, but // we should try to do something better. pendingNotifications buffer.RingGrowing // requestedResyncPeriod is how frequently the listener wants a // full resync from the shared informer, but modified by two // adjustments. One is imposing a lower bound, // `minimumResyncPeriod`. The other is another lower bound, the // sharedIndexInformer's `resyncCheckPeriod`, that is imposed (a) only // in AddEventHandlerWithResyncPeriod invocations made after the // sharedIndexInformer starts and (b) only if the informer does // resyncs at all. requestedResyncPeriod time.Duration // resyncPeriod is the threshold that will be used in the logic // for this listener. This value differs from // requestedResyncPeriod only when the sharedIndexInformer does // not do resyncs, in which case the value here is zero. The // actual time between resyncs depends on when the // sharedProcessor's `shouldResync` function is invoked and when // the sharedIndexInformer processes `Sync` type Delta objects. resyncPeriod time.Duration // nextResync is the earliest time the listener should get a full resync nextResync time.Time // resyncLock guards access to resyncPeriod and nextResync resyncLock sync.Mutex } newProcessListener() è¯¥å‡½æ•°åœ¨ sharedIndexInformer.AddEventHandlerWithResyncPeriod ä¸­è°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ listener\nfunc newProcessListener(handler ResourceEventHandler, requestedResyncPeriod, resyncPeriod time.Duration, now time.Time, bufferSize int) *processorListener { ret := \u0026amp;processorListener{ nextCh: make(chan interface{}), addCh: make(chan interface{}), handler: handler, pendingNotifications: *buffer.NewRingGrowing(bufferSize), requestedResyncPeriod: requestedResyncPeriod, resyncPeriod: resyncPeriod, } ret.determineNextResync(now) return ret } functions NewSharedIndexInformer // NewSharedIndexInformer creates a new instance for the listwatcher. // The created informer will not do resyncs if the given // defaultEventHandlerResyncPeriod is zero. Otherwise: for each // handler that with a non-zero requested resync period, whether added // before or after the informer starts, the nominal resync period is // the requested resync period rounded up to a multiple of the // informer's resync checking period. Such an informer's resync // checking period is established when the informer starts running, // and is the maximum of (a) the minimum of the resync periods // requested before the informer starts and the // defaultEventHandlerResyncPeriod given here and (b) the constant // `minimumResyncPeriod` defined in this file. func NewSharedIndexInformer(lw ListerWatcher, exampleObject runtime.Object, defaultEventHandlerResyncPeriod time.Duration, indexers Indexers) SharedIndexInformer { realClock := \u0026amp;clock.RealClock{} sharedIndexInformer := \u0026amp;sharedIndexInformer{ processor: \u0026amp;sharedProcessor{clock: realClock}, indexer: NewIndexer(DeletionHandlingMetaNamespaceKeyFunc, indexers), listerWatcher: lw, objectType: exampleObject, resyncCheckPeriod: defaultEventHandlerResyncPeriod, defaultEventHandlerResyncPeriod: defaultEventHandlerResyncPeriod, cacheMutationDetector: NewCacheMutationDetector(fmt.Sprintf(\u0026quot;%T\u0026quot;, exampleObject)), clock: realClock, } return sharedIndexInformer } tools/cache/controller.go types controller // `*controller` implements Controller type controller struct { config Config reflector *Reflector reflectorMutex sync.RWMutex clock clock.Clock } processLoop() processLoop ä¼šä¸æ–­ä» DeltaFIFO ä¸­ pop å‡ºå…ƒç´ ï¼Œå¹¶è°ƒç”¨ c.config.Process å¯¹ pop å‡ºçš„å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ª Process å®é™…æ˜¯ HandleDeltas\n// processLoop drains the work queue. // TODO: Consider doing the processing in parallel. This will require a little thought // to make sure that we don't end up processing the same object multiple times // concurrently. // // TODO: Plumb through the stopCh here (and down to the queue) so that this can // actually exit when the controller is stopped. Or just give up on this stuff // ever being stoppable. Converting this whole package to use Context would // also be helpful. func (c *controller) processLoop() { for { obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process)) if err != nil { if err == ErrFIFOClosed { return } if c.config.RetryOnError { // This is the safe way to re-enqueue. c.config.Queue.AddIfNotPresent(obj) } } } } Run() sharedIndexInformer.Run é‡Œä¼šåˆ›å»ºä¸€ä¸ª DeltaFIFOï¼Œå¹¶å°† config.Queue è®¾ç½®ä¸ºè¿™ä¸ª DeltaFIFO\n// Run begins processing items, and will continue until a value is sent down stopCh or it is closed. // It's an error to call Run more than once. // Run blocks; call via go. func (c *controller) Run(stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() go func() { \u0026lt;-stopCh c.config.Queue.Close() }() // åˆ›å»ºä¸€ä¸ª reflector ç”¨æ¥ list-watch // è¿™é‡Œçš„ c.config.Queue å®é™…æ˜¯ä¸€ä¸ª DeltaFIFO r := NewReflector( c.config.ListerWatcher, c.config.ObjectType, c.config.Queue, c.config.FullResyncPeriod, ) r.ShouldResync = c.config.ShouldResync r.WatchListPageSize = c.config.WatchListPageSize r.clock = c.clock if c.config.WatchErrorHandler != nil { r.watchErrorHandler = c.config.WatchErrorHandler } c.reflectorMutex.Lock() c.reflector = r c.reflectorMutex.Unlock() var wg wait.Group wg.StartWithChannel(stopCh, r.Run) wait.Until(c.processLoop, time.Second, stopCh) wg.Wait() } Config type Config struct { // The queue for your objects - has to be a DeltaFIFO due to // assumptions in the implementation. Your Process() function // should accept the output of this Queue's Pop() method. // åº”è¯¥ä¼ é€’ä¸€ä¸ª DeltaFIFO ç±»å‹çš„ queueï¼ŒProcess() ä¸­ä¼šä»è¯¥ queue // ä¸­ pop å…ƒç´ è¿›è¡Œå¤„ç† Queue // Something that can list and watch your objects. ListerWatcher // Something that can process a popped Deltas. // Pop å‡ºæ¥çš„ obj å¤„ç†å‡½æ•° Process ProcessFunc // ObjectType is an example object of the type this controller is // expected to handle. Only the type needs to be right, except // that when that is `unstructured.Unstructured` the object's // `\u0026quot;apiVersion\u0026quot;` and `\u0026quot;kind\u0026quot;` must also be right. ObjectType runtime.Object // FullResyncPeriod is the period at which ShouldResync is considered. FullResyncPeriod time.Duration // ShouldResync is periodically used by the reflector to determine // whether to Resync the Queue. If ShouldResync is `nil` or // returns true, it means the reflector should proceed with the // resync. ShouldResync ShouldResyncFunc // If true, when Process() returns an error, re-enqueue the object. // TODO: add interface to let you inject a delay/backoff or drop // the object completely if desired. Pass the object in // question to this interface as a parameter. This is probably moot // now that this functionality appears at a higher level. RetryOnError bool // Called whenever the ListAndWatch drops the connection with an error. WatchErrorHandler WatchErrorHandler // WatchListPageSize is the requested chunk size of initial and relist watch lists. WatchListPageSize int64 } ProcessFunc // ProcessFunc processes a single object. type ProcessFunc func(obj interface{}) error functions New // New makes a new Controller from the given Config. func New(c *Config) Controller { ctlr := \u0026amp;controller{ config: *c, clock: \u0026amp;clock.RealClock{}, } return ctlr } processDeltas å¦‚æœæ˜¯ HandleDeltas è°ƒç”¨è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„æ˜¯ indexerï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šæ ¹æ® pop çš„äº‹ä»¶ç±»å‹å¯¹ indexer è¿›è¡Œç›¸åº”æ“ä½œï¼ŒåŒæ—¶è¿˜ä¼ é€’äº†ä¸€ä¸ª handler å‚æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œéœ€è¦å®ç° OnAddã€OnUpdateã€OnDelete ä¸‰ä¸ªæ–¹æ³•ï¼ŒsharedIndexInformer å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå®é™…ä¼šè°ƒç”¨ sharedProcessor çš„ OnAdd ç­‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ˜¯ç”¨æˆ·è‡ªå·±è®¾ç½®çš„å›è°ƒå‡½æ•°\n// Multiplexes updates in the form of a list of Deltas into a Store, and informs // a given handler of events OnUpdate, OnAdd, OnDelete func processDeltas( // Object which receives event notifications from the given deltas handler ResourceEventHandler, clientState Store, transformer TransformFunc, deltas Deltas, ) error { // from oldest to newest for _, d := range deltas { obj := d.Object if transformer != nil { var err error obj, err = transformer(obj) if err != nil { return err } } switch d.Type { case Sync, Replaced, Added, Updated: if old, exists, err := clientState.Get(obj); err == nil \u0026amp;\u0026amp; exists { // æ›´æ–° indexer é‡Œçš„æ•°æ® if err := clientState.Update(obj); err != nil { return err } // åŒæ—¶æ‰§è¡Œç”¨æˆ·è®¾ç½®çš„å›è°ƒå‡½æ•° handler.OnUpdate(old, obj) } else { if err := clientState.Add(obj); err != nil { return err } handler.OnAdd(obj) } case Deleted: if err := clientState.Delete(obj); err != nil { return err } handler.OnDelete(obj) } } return nil } tools/cache/reflector.go types functions watchHandler å½“ watch åˆ°æœ‰äº‹ä»¶äº§ç”Ÿæ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°å¯¹äº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†\n// watchHandler watches w and sets setLastSyncResourceVersion func watchHandler(start time.Time, w watch.Interface, store Store, // çœç•¥å…¶ä»–å‚æ•°... ) error { eventCount := 0 // Stopping the watcher should be idempotent and if we return from this function there's no way // we're coming back in with the same watch interface. defer w.Stop() loop: for { select { // çœç•¥... // æœ‰äº‹ä»¶äº§ç”Ÿäº† case event, ok := \u0026lt;-w.ResultChan(): if !ok { break loop } if event.Type == watch.Error { return apierrors.FromObject(event.Object) } // çœç•¥... // åˆ¤æ–­äº‹ä»¶ç±»å‹ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç† switch event.Type { case watch.Added: // è¿™é‡Œçš„ store å®é™…æ˜¯ DeltaFIFOï¼Œè°ƒç”¨çš„æ˜¯ DeltaFIFO.Add() err := store.Add(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026quot;%s: unable to add watch event object (%#v) to store: %v\u0026quot;, name, event.Object, err)) } case watch.Modified: err := store.Update(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026quot;%s: unable to update watch event object (%#v) to store: %v\u0026quot;, name, event.Object, err)) } case watch.Deleted: // TODO: Will any consumers need access to the \u0026quot;last known // state\u0026quot;, which is passed in event.Object? If so, may need // to change this. err := store.Delete(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026quot;%s: unable to delete watch event object (%#v) from store: %v\u0026quot;, name, event.Object, err)) } case watch.Bookmark: // A `Bookmark` means watch has synced here, just update the resourceVersion default: utilruntime.HandleError(fmt.Errorf(\u0026quot;%s: unable to understand watch event %#v\u0026quot;, name, event)) } setLastSyncResourceVersion(resourceVersion) if rvu, ok := store.(ResourceVersionUpdater); ok { rvu.UpdateResourceVersion(resourceVersion) } eventCount++ } } // çœç•¥... } tools/cache/delta_fifo.go types DeltaFIFO // DeltaFIFO is like FIFO, but differs in two ways. One is that the // accumulator associated with a given object's key is not that object // but rather a Deltas, which is a slice of Delta values for that // object. Applying an object to a Deltas means to append a Delta // except when the potentially appended Delta is a Deleted and the // Deltas already ends with a Deleted. In that case the Deltas does // not grow, although the terminal Deleted will be replaced by the new // Deleted if the older Deleted's object is a // DeletedFinalStateUnknown. // // The other difference is that DeltaFIFO has two additional ways that // an object can be applied to an accumulator: Replaced and Sync. // If EmitDeltaTypeReplaced is not set to true, Sync will be used in // replace events for backwards compatibility. Sync is used for periodic // resync events. // // DeltaFIFO is a producer-consumer queue, where a Reflector is // intended to be the producer, and the consumer is whatever calls // the Pop() method. // // DeltaFIFO solves this use case: // - You want to process every object change (delta) at most once. // - When you process an object, you want to see everything // that's happened to it since you last processed it. // - You want to process the deletion of some of the objects. // - You might want to periodically reprocess objects. // // DeltaFIFO's Pop(), Get(), and GetByKey() methods return // interface{} to satisfy the Store/Queue interfaces, but they // will always return an object of type Deltas. List() returns // the newest object from each accumulator in the FIFO. // // A DeltaFIFO's knownObjects KeyListerGetter provides the abilities // to list Store keys and to get objects by Store key. The objects in // question are called \u0026quot;known objects\u0026quot; and this set of objects // modifies the behavior of the Delete, Replace, and Resync methods // (each in a different way). // // A note on threading: If you call Pop() in parallel from multiple // threads, you could end up with multiple threads processing slightly // different versions of the same object. type DeltaFIFO struct { // lock/cond protects access to 'items' and 'queue'. lock sync.RWMutex cond sync.Cond // `items` maps a key to a Deltas. // Each such Deltas has at least one Delta. items map[string]Deltas // `queue` maintains FIFO order of keys for consumption in Pop(). // There are no duplicates in `queue`. // A key is in `queue` if and only if it is in `items`. queue []string // populated is true if the first batch of items inserted by Replace() has been populated // or Delete/Add/Update/AddIfNotPresent was called first. populated bool // initialPopulationCount is the number of items inserted by the first call of Replace() initialPopulationCount int // keyFunc is used to make the key used for queued item // insertion and retrieval, and should be deterministic. keyFunc KeyFunc // knownObjects list keys that are \u0026quot;known\u0026quot; --- affecting Delete(), // Replace(), and Resync() knownObjects KeyListerGetter // Used to indicate a queue is closed so a control loop can exit when a queue is empty. // Currently, not used to gate any of CRUD operations. closed bool // emitDeltaTypeReplaced is whether to emit the Replaced or Sync // DeltaType when Replace() is called (to preserve backwards compat). emitDeltaTypeReplaced bool } Add() å®é™…è°ƒç”¨çš„æ˜¯ queueActionLocked æ–¹æ³•\n// Add inserts an item, and puts it in the queue. The item is only enqueued // if it doesn't already exist in the set. func (f *DeltaFIFO) Add(obj interface{}) error { f.lock.Lock() defer f.lock.Unlock() f.populated = true return f.queueActionLocked(Added, obj) } queueActionLocked() queueActionLocked ä¼šå°† actionType å’Œ obj å°è£…ä¸ºä¸€ä¸ª Delta å¯¹è±¡ï¼Œå¹¶ push åˆ° DeltaFIFO\n// queueActionLocked appends to the delta list for the object. // Caller must lock first. func (f *DeltaFIFO) queueActionLocked(actionType DeltaType, obj interface{}) error { id, err := f.KeyOf(obj) if err != nil { return KeyError{obj, err} } oldDeltas := f.items[id] newDeltas := append(oldDeltas, Delta{actionType, obj}) newDeltas = dedupDeltas(newDeltas) if len(newDeltas) \u0026gt; 0 { if _, exists := f.items[id]; !exists { f.queue = append(f.queue, id) } f.items[id] = newDeltas f.cond.Broadcast() } else { // This never happens, because dedupDeltas never returns an empty list // when given a non-empty list (as it is here). // If somehow it happens anyway, deal with it but complain. if oldDeltas == nil { klog.Errorf(\u0026quot;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; ignoring\u0026quot;, id, oldDeltas, obj) return nil } klog.Errorf(\u0026quot;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; breaking invariant by storing empty Deltas\u0026quot;, id, oldDeltas, obj) f.items[id] = newDeltas return fmt.Errorf(\u0026quot;Impossible dedupDeltas for id=%q: oldDeltas=%#+v, obj=%#+v; broke DeltaFIFO invariant by storing empty Deltas\u0026quot;, id, oldDeltas, obj) } return nil } functions å‚è€ƒèµ„æ–™ K8s ç³»åˆ—(å››) - æµ…è°ˆ Informer.md\næ·±å…¥äº†è§£ Kubernetes Informer\n","date":"2022å¹´10æœˆ07æ—¥","permalink":"/posts/client-go-yuan-ma/","summary":"æ¶æ„ Informers ç”±å‡ ä¸ªæ ¸å¿ƒçš„ç»„ä»¶æ„æˆï¼š\nReflectorï¼šè´Ÿè´£ä» api-server listï¼ˆå…¨é‡æ‹‰å–æ•°æ®ï¼‰ and watchï¼ˆç›‘å¬æ•°æ®å˜æ›´ï¼‰ DeltaFIFOï¼šä¸€ä¸ªå­˜å‚¨äº‹ä»¶çš„é˜Ÿåˆ—ï¼Œé‡Œé¢è®°å½•äº†äº‹ä»¶çš„ç±»å‹ Indexerï¼šå­˜å‚¨æ•°æ®ï¼Œæ•°æ®æ¥æºæ˜¯ä» DeltaFIFO ä¸­ pop å‡ºæ¥çš„ï¼Œç„¶åä¼šæ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œå¯¹äºçš„æ“ä½œ sharedProcessorï¼šç”¨äºè¿è¡Œç”¨æˆ·è®¾ç½®çš„äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œé‡Œé¢ç”¨ map å­˜å‚¨äº†æ‰€æœ‰çš„ listenerï¼Œæ¯æ¬¡è°ƒç”¨ AddEventHandler éƒ½ä¼šåˆ›å»ºä¸€ä¸ª listenerï¼ŒåŒæ—¶è¿™ä¸ªå‡½æ•°å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¤šä¸ª listenerï¼Œå½“å‘é€äº‹ä»¶æ—¶ï¼Œä¼šè°ƒç”¨æ‰€æœ‰çš„ listener çš„å¯¹åº”å›è°ƒå‡½æ•° controllerï¼šä¸Šé¢æåˆ°çš„ Reflectorã€DeltaFIFOã€Indexer å„è‡ªæœ‰å„è‡ªçš„ä½œç”¨ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´è¿˜æ²¡æœ‰å…³è”èµ·æ¥ï¼Œè€Œ controller å°±æ˜¯è´Ÿè´£è¿™ä»¶äº‹çš„ï¼Œå®ƒæ˜¯è¿™ 3 ä¸ªç»„ä»¶çš„ masterï¼Œè®©å®ƒä»¬å¯ä»¥ååŒè¿ä½œï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼šå½“ Reflector watch åˆ°äº‹ä»¶æ—¶ä¼šå°†å…¶ä¿å­˜åˆ° DeltaFIFO ä¸­ï¼Œcontroller è¿™ä»¶ä¼šæŒç»­ä» DeltaFIFO ä¸­ pop å…ƒç´ ï¼Œç„¶åæ ¹æ®äº‹ä»¶ç±»å‹å¯¹ indexer è¿›è¡Œç›¸åº”æ“ä½œï¼ˆaddã€updateã€deleteï¼‰ï¼Œä½¿å¾— indexer ä¸­çš„æ•°æ®å’Œ api-server ä¸­çš„ä¸€è‡´ï¼ŒåŒæ—¶è¿˜ä¼šè°ƒç”¨ sharedProcessor çš„å¯¹åº”å›è°ƒï¼Œæ¥å®Œæˆç”¨æˆ·è®¾ç½®çš„å¯¹åº”äº‹ä»¶æ“ä½œã€‚ informers/factory.","title":"k8s client-go æºç é˜…è¯»"},{"contents":"å¿«é€Ÿå…¥é—¨ ä¸‹è½½ kubebuiler $ os=$(go env GOOS) $ arch=$(go env GOARCH) $ curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/${os}/${arch} $ chmod +x kubebuilder $ sudo mv ./kubebuilder /usr/local/bin åˆ›å»ºä¸€ä¸ªé¡¹ç›® $ mkdir operator $ cd operator $ go mod init operator.example.com # æˆ‘ä»¬å°†ä½¿ç”¨ my.domain åŸŸï¼Œ # æ‰€ä»¥æ‰€æœ‰çš„ API ç»„å°†æ˜¯\u0026lt;group\u0026gt;.my.domain. $ kubebuilder init --domain my.domain åˆ›å»ºä¸€ä¸ª API è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ APIï¼ˆç»„/ç‰ˆæœ¬ï¼‰ä¸º â€œwebapp/v1â€ï¼Œå¹¶åœ¨ä¸Šé¢åˆ›å»ºæ–°çš„ Kind(CRD) â€œGuestbookâ€ã€‚\n$ kubebuilder create api --group webapp --version v1 --kind Guestbook å®‰è£… kustomize # cd åˆ°å½“å‰é¡¹ç›®ç›®å½•çš„ bin ç›®å½•ä¸‹ $ cd bin # go versionâ‰¥go1.17 $ GOBIN=$(pwd)/ GO111MODULE=on go install sigs.k8s.io/kustomize/kustomize/v4@latest # æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ˜¯å¦ä¸‹è½½å¥½ kustomize $ ls controller-gen kustomize æµ‹è¯• å°† CRD å®‰è£…åˆ°é›†ç¾¤ä¸­\nè¿™æ­¥æ“ä½œéœ€è¦ä½ å·²ç»å®‰è£…å¥½ kustomize\n$ make install è¿è¡Œæ§åˆ¶å™¨ï¼š\n$ make run go fmt ./... go vet ./... go run ./main.go 1.664805588618038e+09 INFO controller-runtime.metrics Metrics server is starting to listen {\u0026quot;addr\u0026quot;: \u0026quot;:8080\u0026quot;} 1.664805588619189e+09 INFO setup starting manager 1.664805588620343e+09 INFO Starting server {\u0026quot;path\u0026quot;: \u0026quot;/metrics\u0026quot;, \u0026quot;kind\u0026quot;: \u0026quot;metrics\u0026quot;, \u0026quot;addr\u0026quot;: \u0026quot;[::]:8080\u0026quot;} 1.664805588620474e+09 INFO Starting server {\u0026quot;kind\u0026quot;: \u0026quot;health probe\u0026quot;, \u0026quot;addr\u0026quot;: \u0026quot;[::]:8081\u0026quot;} 1.664805588620887e+09 INFO controller.guestbook Starting EventSource {\u0026quot;reconciler group\u0026quot;: \u0026quot;webapp.my.domain\u0026quot;, \u0026quot;reconciler kind\u0026quot;: \u0026quot;Guestbook\u0026quot;, \u0026quot;source\u0026quot;: \u0026quot;kind source: *v1.Guestbook\u0026quot;} 1.664805588620948e+09 INFO controller.guestbook Starting Controller {\u0026quot;reconciler group\u0026quot;: \u0026quot;webapp.my.domain\u0026quot;, \u0026quot;reconciler kind\u0026quot;: \u0026quot;Guestbook\u0026quot;} 1.6648055887228339e+09 INFO controller.guestbook Starting workers {\u0026quot;reconciler group\u0026quot;: \u0026quot;webapp.my.domain\u0026quot;, \u0026quot;reconciler kind\u0026quot;: \u0026quot;Guestbook\u0026quot;, \u0026quot;worker count\u0026quot;: 1} è¿è¡Œè¿™ä¸ª CRDï¼š\n$ kubectl apply -f config/samples/ guestbook.webapp.my.domain/guestbook-sample created $ kubectl get Guestbook NAME AGE guestbook-sample 33s å®è·µ ç»§ç»­æ²¿ç”¨ å¿«é€Ÿå…¥é—¨ é‡Œå·²ç»åˆ›å»ºå¥½çš„é¡¹ç›®\næ³¨æ„è¿™é‡Œçš„ group å¿…é¡»è¦æŒ‡å®šä¸ºå’Œ å¿«é€Ÿå…¥é—¨ ä¸­ç›¸åŒçš„ webappï¼Œå¦‚æœæŒ‡å®šä¸ºåˆ«çš„ï¼Œä¼šæŠ¥é”™ï¼šError: failed to create API: unable to inject the resource to \u0026quot;base.go.kubebuilder.io/v3\u0026quot;: multiple groups are not allowed by default, to enable multi-group visit https://kubebuilder.io/migration/multi-group.html\n$ kubebuilder create api --group webapp --version v1 --kind CronJob ","date":"2022å¹´10æœˆ03æ—¥","permalink":"/posts/kubebuilder/","summary":"å¿«é€Ÿå…¥é—¨ ä¸‹è½½ kubebuiler $ os=$(go env GOOS) $ arch=$(go env GOARCH) $ curl -L -o kubebuilder https://go.","title":"kubebuilder å®è·µ"},{"contents":"docker tag ç›¸å½“äºå¯¹é•œåƒåšä¸€æ¬¡å¤‡ä»½ï¼Œå°†å½“å‰çš„é•œåƒï¼ˆæ¯”å¦‚ tag:latestï¼‰å¤‡ä»½å‡ºå»ä¸€ä»½ï¼ˆæ¯”å¦‚ tag: v1ï¼‰ï¼Œç„¶åå¦‚æœå¼€å‘äº†æ–°çš„é•œåƒï¼Œå¯ä»¥ç›´æ¥è¦†ç›–æ‰å½“å‰çš„ï¼ˆtag:latestï¼‰ï¼Œç„¶åå†ç»™ latest æ‰“ä¸ªæ ‡ç­¾ï¼štag:v2ï¼Œç›¸å½“äºåˆå¤‡ä»½äº†ä¸€ä»½ï¼Œç°åœ¨å°±æœ‰äº† v1ï¼Œv2ï¼Œlatest ä¸‰ä¸ªé•œåƒï¼Œä½¿ç”¨ tag ä¸ä»…å¯ä»¥å¤‡ä»½é•œåƒï¼Œè¿˜å¯ä»¥å¯¹é•œåƒåšæ ‡æ³¨åŒºåˆ†ã€‚\nè¯¦ç»†å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š\n$ mkdir hello-world-go $ vim Dockerfile # å†™å…¥ä»¥ä¸‹å†…å®¹ FROM golang:alpine AS builder # ä¸ºæˆ‘ä»¬çš„é•œåƒè®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ ENV GO111MODULE=on \\ CGO_ENABLED=0 \\ GOOS=linux \\ GOARCH=arm64 # ç§»åŠ¨åˆ°å·¥ä½œç›®å½•ï¼š/build WORKDIR /build # å°†ä»£ç å¤åˆ¶åˆ°å®¹å™¨ä¸­ COPY . . # å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ app RUN go build -o app . ################### # æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªå°é•œåƒ ################### FROM scratch # ä»builderé•œåƒä¸­æŠŠ/dist/app æ‹·è´åˆ°å½“å‰ç›®å½• COPY --from=builder /build/app / # éœ€è¦è¿è¡Œçš„å‘½ä»¤ ENTRYPOINT [\u0026quot;/app\u0026quot;] $ vim hello.go # å†™å…¥ä»¥ä¸‹å†…å®¹ package main import ( \u0026quot;fmt\u0026quot; ) func main() { fmt.Println(\u0026quot;[v1] hello, world!\u0026quot;) } # åˆ›å»º go.mod $ go mod init helloworld go: creating new go.mod: module helloworld # æ„å»ºé•œåƒ $ docker build -t hello-world . Sending build context to Docker daemon 4.608kB Step 1/8 : FROM golang:alpine AS builder ---\u0026gt; 97a79d0cc013 Step 2/8 : ENV GO111MODULE=on CGO_ENABLED=0 GOOS=linux GOARCH=arm64 ---\u0026gt; Using cache ---\u0026gt; accc05f16e78 Step 3/8 : WORKDIR /build ---\u0026gt; Using cache ---\u0026gt; 3cbd504d7581 Step 4/8 : COPY . . ---\u0026gt; 2bb03068056c Step 5/8 : RUN go build -o app . ---\u0026gt; Running in 6077f4d304a4 Removing intermediate container 6077f4d304a4 ---\u0026gt; c9509017f175 Step 6/8 : FROM scratch ---\u0026gt; Step 7/8 : COPY --from=builder /build/app / ---\u0026gt; d97340567693 Step 8/8 : ENTRYPOINT [\u0026quot;/app\u0026quot;] ---\u0026gt; Running in 7f5508753fa9 Removing intermediate container 7f5508753fa9 ---\u0026gt; 1b57ca8ce7d2 Successfully built 1b57ca8ce7d2 Successfully tagged hello-world:latest # æŸ¥çœ‹é•œåƒ $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE hello-world latest 1b57ca8ce7d2 4 seconds ago 1.82MB # ç»™é•œåƒæ‰“ä¸ª tag $ docker tag 1b57 hello-world:v1 # å†æ¬¡æŸ¥çœ‹é•œåƒï¼Œå‘ç°å·²ç»æœ‰äº†ä¸€ä¸ªæ–°çš„ tag ä¸º v1 çš„é•œåƒï¼Œå¹¶ä¸” ID å’Œ latest ç›¸åŒï¼Œç›¸å½“äºæœ‰äº†ä¸€ä»½å¤‡ä»½ $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE hello-world latest 1b57ca8ce7d2 2 minutes ago 1.82MB hello-world v1 1b57ca8ce7d2 2 minutes ago 1.82MB # è¿è¡Œé•œåƒæŸ¥çœ‹æ•ˆæœ $ docker run hello-world:v1 hello, world! # ç°åœ¨å¯ä»¥å†æ¬¡å¼€å‘é•œåƒäº†ï¼Œä¿®æ”¹ hello.goï¼Œå°†è¾“å‡ºå†…å®¹ä¿®æ”¹ä¸º [v2] $ vim hello.go package main import ( \u0026quot;fmt\u0026quot; ) func main() { fmt.Println(\u0026quot;[v2] hello, world!\u0026quot;) } # å†æ¬¡æ„å»ºæ–°ç‰ˆæœ¬çš„é•œåƒ $ docker build -t hello-world . Sending build context to Docker daemon 4.608kB Step 1/8 : FROM golang:alpine AS builder ---\u0026gt; 97a79d0cc013 Step 2/8 : ENV GO111MODULE=on CGO_ENABLED=0 GOOS=linux GOARCH=arm64 ---\u0026gt; Using cache ---\u0026gt; accc05f16e78 Step 3/8 : WORKDIR /build ---\u0026gt; Using cache ---\u0026gt; 3cbd504d7581 Step 4/8 : COPY . . ---\u0026gt; Using cache ---\u0026gt; 6ee29a59885a Step 5/8 : RUN go build -o app . ---\u0026gt; Running in 9e6388ccd40c Removing intermediate container 9e6388ccd40c ---\u0026gt; 78cb76e165de Step 6/8 : FROM scratch ---\u0026gt; Step 7/8 : COPY --from=builder /build/app / ---\u0026gt; 9fbd2d306353 Step 8/8 : ENTRYPOINT [\u0026quot;/app\u0026quot;] ---\u0026gt; Running in 49e410971798 Removing intermediate container 49e410971798 ---\u0026gt; 245cbeaf290f Successfully built 245cbeaf290f Successfully tagged hello-world:latest # å†æ¬¡æŸ¥çœ‹é•œåƒï¼Œæ–°çš„é•œåƒè¦†ç›–æ‰äº†ä¹‹å‰çš„ hello-world:latest $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE hello-world latest 245cbeaf290f 11 seconds ago 1.82MB hello-world v1 1b57ca8ce7d2 37 minutes ago 1.82MB # æŸ¥çœ‹æ–°é•œåƒçš„è¿è¡Œæ•ˆæœ $ docker run hello-world [v2] hello, world! # å†æ¬¡ç»™æ–°é•œåƒæ‰“ tagï¼Œç›¸å½“äºåšä¸€æ¬¡å¤‡ä»½ $ docker tag 245cbeaf290f hello-world:v2 # æŸ¥çœ‹ç°åœ¨çš„ iamge $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE hello-world latest 245cbeaf290f 49 seconds ago 1.82MB hello-world v2 245cbeaf290f 49 seconds ago 1.82MB hello-world v1 1b57ca8ce7d2 38 minutes ago 1.82MB # æŸ¥çœ‹æ–°é•œåƒçš„è¿è¡Œæ•ˆæœ $ docker run hello-world:v2 [v2] hello, world! $ docker run hello-world:v1 [v1] hello, world! # ç°åœ¨å°±å·²ç»æœ‰äº†ä¸¤ä¸ªç‰ˆæœ¬çš„é•œåƒäº† ","date":"2022å¹´09æœˆ29æ—¥","permalink":"/posts/docker-tag/","summary":"docker tag ç›¸å½“äºå¯¹é•œåƒåšä¸€æ¬¡å¤‡ä»½ï¼Œå°†å½“å‰çš„é•œåƒï¼ˆæ¯”å¦‚ tag:latestï¼‰å¤‡ä»½å‡ºå»ä¸€ä»½ï¼ˆæ¯”å¦‚ tag: v1ï¼‰ï¼Œç„¶åå¦‚æœå¼€å‘äº†æ–°çš„é•œåƒï¼Œå¯ä»¥ç›´æ¥è¦†ç›–æ‰å½“å‰çš„ï¼ˆtag:latestï¼‰ï¼Œç„¶åå†ç»™ latest æ‰“ä¸ªæ ‡ç­¾ï¼štag:v2ï¼Œç›¸å½“äºåˆå¤‡ä»½äº†ä¸€ä»½ï¼Œç°åœ¨å°±æœ‰äº† v1ï¼Œv2ï¼Œlatest ä¸‰ä¸ªé•œåƒï¼Œä½¿ç”¨ tag ä¸ä»…å¯ä»¥å¤‡ä»½é•œåƒï¼Œè¿˜å¯ä»¥å¯¹é•œåƒåšæ ‡æ³¨åŒºåˆ†ã€‚","title":"docker tag çš„ç”¨å¤„"},{"contents":"æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€ æ— çŠ¶æ€åº”ç”¨ï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡Œæ—¶ä¸éœ€è¦ç»´æŠ¤æˆ–è·Ÿè¸ªä»»ä½•ç‰¹å®šçŠ¶æ€çš„åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼ŒWeb æœåŠ¡å™¨æˆ– API æœåŠ¡å™¨é€šå¸¸å¯ä»¥å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œæ— éœ€äº†è§£ä»¥å‰çš„è¯·æ±‚æˆ–å®¢æˆ·ç«¯çŠ¶æ€ã€‚è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°æ°´å¹³æ‰©å±•ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦å…±äº«çŠ¶æ€ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚åƒ Deployment ä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæ— çŠ¶æ€åº”ç”¨â€ï¼Œå®ƒä¼šæŒ‰ç…§äº‹å…ˆå£°æ˜çš„æ¨¡æ¿åˆ›å»ºå‡º podï¼Œè¿™è¡¨ç¤ºæ¯ä¸ª pod çš„å®šä¹‰å°†ä¼šæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ­¤å¤–ï¼Œè¿™äº› pod ä¹‹é—´æ²¡æœ‰ä¹‹é—´æ²¡æœ‰é¡ºåºç›¸å…³æ€§ï¼ˆä»€ä¹ˆäº‹æœ‰é¡ºåºç›¸å…³æ€§ï¼Ÿæ¯”å¦‚ä¸€äº›é›†ç¾¤åº”ç”¨åŒ…å«ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼Œè€Œä¸»èŠ‚ç‚¹å¿…é¡»å…ˆäºä»èŠ‚ç‚¹å¯åŠ¨ï¼Œè¿™ä¾¿æ˜¯é¡ºåºç›¸å…³æ€§ï¼‰ï¼Œä¹Ÿæ— æ‰€è°“åœ¨å“ªå°å®¿ä¸»æœºä¸Šè¿è¡Œï¼Œä»»ä½•ä¸€ä¸ª pod éƒ½å¯ä»¥æä¾›å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ï¼Œä¸éœ€è¦æ—¶ï¼Œä¹Ÿå¯ä»¥ç»“æŸä»»æ„ä¸€ä¸ª podã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼Œæœ‰çŠ¶æ€ï¼ŒæŒ‡çš„æ˜¯é‚£äº›åœ¨è¿è¡Œæ—¶éœ€è¦ç»´æŠ¤å’Œè·Ÿè¸ªç‰¹å®šçŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚æ•°æ®åº“æˆ–ç¼“å­˜ã€‚è¿™äº›åº”ç”¨ç¨‹åºéœ€è¦å°†æ•°æ®æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­ï¼Œå¹¶ä¸”éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥æ ‡è¯†å®ƒä»¬çš„çŠ¶æ€ã€‚è¿™æ„å‘³ç€å½“åº”ç”¨ç¨‹åºé‡æ–°å¯åŠ¨æˆ–è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹æ—¶ï¼Œå¿…é¡»èƒ½å¤Ÿé‡æ–°è·å–å…¶ä»¥å‰çš„çŠ¶æ€ã€‚\nStatefulSet yaml æ¨¡æ¿ ä¸‹é¢å°±æ˜¯ä¸€ä¸ª StatefulSet çš„ yaml æ¨¡æ¿ï¼Œè¿™ä¸ª StatefulSet ä¸­å®šä¹‰äº†ä¸€ä¸ªåŒ…å« 3 ä¸ªå‰¯æœ¬çš„ Nginx Podï¼Œæ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ª PVC æŒ‚è½½åˆ° /data ç›®å½•ï¼Œç”¨äºå­˜å‚¨åº”ç”¨ç¨‹åºæ•°æ®ã€‚å®ƒè¿˜å®šä¹‰äº†ä¸€ä¸ª Headless Serviceï¼Œåä¸º exampleï¼Œç”¨äºä¸º Pod æä¾›å”¯ä¸€çš„ç¨³å®š DNS åç§°ã€‚\napiVersion: apps/v1 kind: StatefulSet metadata: name: nginx spec: serviceName: nginx replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 volumeMounts: - name: data mountPath: /data volumeClaimTemplates: - metadata: name: data spec: accessModes: [ \u0026quot;ReadWriteOnce\u0026quot; ] resources: requests: storage: 1Gi ä¹ä¸€çœ‹å’Œ deployment çš„æ¨¡æ¿éå¸¸ç±»ä¼¼ï¼Œåªæ˜¯å¤šäº† serviceName å’Œ volumeClaimTemplates è¿™ä¸¤ä¸ªå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µçš„ä½œç”¨å¦‚ä¸‹ï¼š\nserviceName æŒ‡å®šäº†ä¸ StatefulSet ç›¸å…³è”çš„ Headless Service çš„åç§°ï¼Œç”¨äº DNS è§£æã€‚ volumeClaimTemplates æŒ‡å®šäº† StatefulSet ä¸­æ¯ä¸ª Pod å¯¹åº”çš„ PersistentVolumeClaim æ¨¡æ¿ï¼Œç”¨äºä¸ºæ¯ä¸ª Pod åˆ›å»ºå¯¹åº”çš„ PVCã€‚è¿™äº› PVC å¯ä»¥ç”¨äºå­˜å‚¨ StatefulSet ä¸­çš„æ•°æ®ï¼Œä»è€Œå®ç° StatefulSet çš„æŒä¹…åŒ–å­˜å‚¨ã€‚ æ‰€ä»¥è¦æƒ³åˆ›å»º StatefulSetï¼Œè¿˜éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª headless serviceï¼Œç”¨å¦‚ä¸‹çš„ yaml æ¥åˆ›å»ºä¸€ä¸ª headless serviceï¼š\napiVersion: v1 kind: Service metadata: name: nginx spec: clusterIP: None ports: - port: 80 # è¯¥ service çš„ç«¯å£ï¼Œä¸æŒ‡å®š targetPortï¼Œåˆ™é»˜è®¤ä¸ port ç›¸åŒ name: web selector: app: nginx åˆ›å»ºå®Œæˆåï¼Œé¢„æœŸç»“æœå¦‚ä¸‹ï¼š\n$ kubectl get sts NAME READY AGE nginx 3/3 18m $ kubectl get po NAME READY STATUS RESTARTS AGE nginx-0 1/1 Running 0 18m nginx-1 1/1 Running 0 17m nginx-2 1/1 Running 0 16m ç°åœ¨æˆ‘ä»¬è¦é‡ç‚¹è§‚å¯Ÿçš„æ˜¯ volumeClaimTemplates è¿™ä¸ªå­—æ®µçš„ä½œç”¨ï¼Œå®ƒä¼š ä¸ºæ¯ä¸ªç”± StatefulSet åˆ›å»ºçš„æ¥çš„ pod åˆ›å»ºä¸€ä¸ª pvcï¼Œå¹¶è¿›è¡Œç»‘å®šï¼š\næŸ¥çœ‹æ‰€æœ‰çš„ pvcï¼Œå‘ç°ç°åœ¨å·²ç»æœ‰ 3 ä¸ª pvc äº†ï¼Œå¹¶ä¸”å®ƒä»¬çš„å‘½åæ ¼å¼éƒ½æ˜¯ \u0026lt;volumeClaimTemplates.metadata.name\u0026gt;-\u0026lt;statefulSet.name\u0026gt;-\u0026lt;è¿ç»­çš„åºå·\u0026gt;ã€‚\n$ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE data-nginx-0 Bound pvc-03e2e475-c81b-47c6-932f-40a758640628 1Gi RWO local-path 21m data-nginx-1 Bound pvc-71776884-824a-4773-8a4d-a626b0381329 1Gi RWO local-path 20m data-nginx-2 Bound pvc-bf9d7f67-f59a-42e9-a1c1-03c29887dbbf 1Gi RWO local-path 20m æˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹æ¯ä¸ª pod ç»‘å®šçš„ pvcï¼š\n$ kubectl get pods -l app=nginx -o=jsonpath='{range .items[*]}{\u0026quot;Pod Name: \u0026quot;}{.metadata.name} {\u0026quot;\\t\u0026quot;} {\u0026quot;PVC Name: \u0026quot;}{.spec.volumes[*].persistentVolumeClaim.claimName}{\u0026quot;\\n\u0026quot;}{end}' Pod Name: nginx-0 PVC Name: data-nginx-0 Pod Name: nginx-1 PVC Name: data-nginx-1 Pod Name: nginx-2 PVC Name: data-nginx-2 å‘ç°äº†å—ï¼Œæ¯ä¸ª pod ç»‘å®šçš„ pvc çš„åå­—éƒ½æ˜¯æœ‰è§„å¯å¾ªçš„ï¼Œ\nçªå‘å¥‡æƒ³ï¼šå¦‚æœåˆ é™¤æŸä¸ª pvc ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\nå®è·µäº†ä¸€ä¸‹ï¼Œå‘ç°æ‰§è¡Œäº† kubectl delete pvc data-nginx-0 åï¼Œä¼šè¾“å‡º persistentvolumeclaim \u0026quot;data-nginx-0\u0026quot; deletedï¼Œç„¶åæ•´ä¸ªç»ˆç«¯å°±é˜»å¡äº†ï¼ŒæŒ‰ Ctrl+c å¼ºåˆ¶é€€å‡ºåï¼Œè¿™ä¸ª pvc çš„ Status å˜ä¸º Terminatingï¼Œä½†æ˜¯å¯¹åº”çš„ pod ä»ç„¶ä¸º Running çŠ¶æ€\nç„¶åæˆ‘ä»¬å†å°è¯•å‘ pod æŒ‚è½½çš„ç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶åƒæ–‡ä»¶å†…å†™å…¥ä¸€æ¡æ•°æ®ï¼Œç„¶ååˆ é™¤è¿™ä¸ª podï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚\né¦–å…ˆå…ˆåˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬è¿™é‡Œå†™å…¥çš„å¯¹è±¡ pod æ˜¯ nginx-0ï¼š\n$ kubectl exec -it nginx-0 -- /bin/bash # cd åˆ°æŒ‚è½½ç›®å½• root@nginx-0:/# cd /data root@nginx-0:/data# ls # åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹ root@nginx-0:/data# echo \u0026quot;test\u0026quot; \u0026gt; test.txt root@nginx-0:/data# ls test.txt root@nginx-0:/data# cat test.txt test ç„¶ååˆ é™¤è¿™ä¸ª podï¼š\n# åˆ é™¤å‰å…ˆçœ‹ä¸€ä¸‹å½“å‰æ‰€æœ‰çš„ pod $ kubectl get po NAME READY STATUS RESTARTS AGE nginx-0 1/1 Running 0 4d22h nginx-1 1/1 Running 0 4d22h nginx-2 1/1 Running 0 4d22h # åˆ æ‰ nginx-0 $ kubectl delete po nginx-0 pod \u0026quot;nginx-0\u0026quot; deleted # æŸ¥çœ‹åˆ é™¤åæ•ˆæœ $ kubectl get po NAME READY STATUS RESTARTS AGE nginx-1 1/1 Running 0 4d22h nginx-2 1/1 Running 0 4d22h nginx-0 0/1 Pending 0 3s # ç­‰å¾…ä¸€ä¼šï¼Œnginx-0 ä¼šé‡æ–°å»ºå‡ºæ¥ $ kubectl get po -w NAME READY STATUS RESTARTS AGE nginx-1 1/1 Running 0 4d22h nginx-2 1/1 Running 0 4d22h nginx-0 0/1 ContainerCreating 0 5s nginx-0 1/1 Running 0 5s # å†æ¬¡æŸ¥çœ‹ pod çš„æŒ‚è½½ç›®å½• $ kubectl exec -it nginx-0 -- ls /data test.txt $ kubectl exec -it nginx-0 -- cat /data/test.txt test é€šè¿‡ä¸Šé¢çš„å®è·µï¼Œæˆ‘ä»¬å‘ç°åˆ é™¤ pod åï¼ŒStatefulSet ä¼šè‡ªåŠ¨é‡å»º podï¼Œå¹¶ä¸”é‡è¦çš„æ˜¯ï¼Œé‡å»ºçš„ pod åå­—å’Œå…ˆå‰çš„ä¼šä¿æŒä¸€è‡´ï¼Œæˆ‘ä»¬åˆ æ‰äº† nginx-0 ï¼Œç„¶åé‡å»ºå‡ºæ¥çš„ pod ä¹Ÿå« nginx-0ï¼Œåˆå› ä¸ºåå­—å’Œå…ˆå‰çš„ä¸€è‡´ï¼ŒæŒ‰ç…§ pvc çš„ç»‘å®šè§„åˆ™ï¼Œå®ƒä¾ç„¶ä¼šç»‘å®šåˆ° data-nginx-0 è¿™ä¸ª pvcï¼Œè¿›è€ŒæŒ‚è½½åˆ°å’Œè¿™ä¸ª pvc ç»‘å®šçš„ pvã€‚è¿™ä¹Ÿè¡¨æ˜ï¼Œåˆ é™¤ pod å¹¶ä¸ä¼šåˆ é™¤å…¶å¯¹åº”çš„ pvc å’Œ pvï¼Œæ‰€ä»¥ pod å¯¹åº”çš„æ•°æ®æ‰ä¼šå®‰å…¨çš„ä¿å­˜ã€‚\nå®è·µ åˆ›å»ºä¸€ä¸ª handless serviceï¼š\nkubia-service-headless.yaml\napiVersion: v1 kind: Service metadata: name: kubia spec: clusterIP: None selector: app: kubia ports: - name: http port: 80 è¿è¡Œï¼š\n$ kubectl apply -f kubia-service-headless.yaml service/kubia created $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 32h kubia ClusterIP None \u0026lt;none\u0026gt; 80/TCP 9s å‡†å¤‡ä¸€ä¸ªç¨‹åºç”¨æ¥æµ‹è¯•ï¼Œè¿™æ˜¯ä¸€ä¸ª HTTP ç¨‹åºï¼Œå¦‚æœå‘é€ POST è¯·æ±‚ï¼Œé‚£ä¹ˆä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åˆ›å»º/æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†è¯·æ±‚ä½“å†…å®¹å†™å…¥è¯¥æ–‡ä»¶ï¼›å¦‚æœå‘é€ GET è¯·æ±‚ï¼Œä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶ä½œä¸º response è¿”å›ï¼š\nconst http = require('http'); const os = require('os'); const fs = require('fs'); const dataFile = \u0026quot;/var/data/kubia.txt\u0026quot;; function fileExists(file) { try { fs.statSync(file); return true; } catch (e) { return false; } } var handler = function(request, response) { if (request.method == 'POST') { var file = fs.createWriteStream(dataFile); file.on('open', function (fd) { request.pipe(file); console.log(\u0026quot;New data has been received and stored.\u0026quot;); response.writeHead(200); response.end(\u0026quot;Data stored on pod \u0026quot; + os.hostname() + \u0026quot;\\n\u0026quot;); }); } else { var data = fileExists(dataFile) ? fs.readFileSync(dataFile, 'utf8') : \u0026quot;No data posted yet\u0026quot;; response.writeHead(200); response.write(\u0026quot;You've hit \u0026quot; + os.hostname() + \u0026quot;\\n\u0026quot;); response.end(\u0026quot;Data stored on this pod: \u0026quot; + data + \u0026quot;\\n\u0026quot;); } }; var www = http.createServer(handler); www.listen(8080); å¯¹åº”çš„ Dockerfileï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ arm64 ç±»å‹çš„é•œåƒï¼š\nFROM arm64v8/node:7 ADD app.js /app.js ENTRYPOINT [\u0026quot;node\u0026quot;, \u0026quot;app.js\u0026quot;] kubia-statefulset.yaml\napiVersion: apps/v1 kind: StatefulSet metadata: name: kubia spec: serviceName: kubia replicas: 2 selector: matchLabels: app: kubia # has to match .spec.template.metadata.labels template: metadata: labels: app: kubia spec: containers: - name: kubia image: stdoutt/kubia-pet-arm64 # æ³¨æ„è¿™é‡Œæ›´æ¢æˆäº† arm64 æ¶æ„çš„ ports: - name: http containerPort: 8080 volumeMounts: - name: data mountPath: /var/data volumeClaimTemplates: - metadata: name: data spec: resources: requests: storage: 1Mi accessModes: - ReadWriteOnce è¿è¡Œï¼š\n$ kubectl apply -f kubia-statefulset.yaml statefulset.apps/kubia created $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-0 1/1 Running 0 61s kubia-1 1/1 Running 0 26s $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4 50Mi RWO local-path 21h data-kubia-0 Bound pvc-b2742307-c5d5-4402-a9a6-54730d60c4a3 1Mi RWO local-path 62m data-kubia-1 Bound pvc-28570e23-c08a-4610-8b6e-cc35434ded21 1Mi RWO local-path 61m ä½¿ç”¨ API server è®¿é—® podï¼š\n$ kubectl proxy Starting to serve on 127.0.0.1:8001 $ curl localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/ You've hit kubia-0 Data stored on this pod: No data posted yet æœ¬æ¬¡å‘é€çš„æ˜¯ GET è¯·æ±‚ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å‘é€è¿‡ POST è¯·æ±‚ï¼Œæ‰€ä»¥æ–‡ä»¶è¿˜ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿”å› No data posted yet\nå‘é€ä¸€ä¸ª POST è¯·æ±‚ï¼š\n$ curl -X POST -d \u0026quot;Hey there! This greeting was submitted to kubia-0.\u0026quot; localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/ Data stored on pod kubia-0 æ­¤æ—¶å·²ç»å°†è¯·æ±‚ä½“é‡Œçš„å†…å®¹ä¿å­˜åœ¨äº†å®¹å™¨å†…\nå†æ¬¡å‘é€ GET è¯·æ±‚ï¼š\n$ curl localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/ You've hit kubia-0 Data stored on this pod: Hey there! This greeting was submitted to kubia-0. å†æ¬¡å‘é€è¯·æ±‚ï¼Œå‘ç°å¯ä»¥è¾“å‡ºæ–‡ä»¶å†…å®¹äº†\nç°åœ¨åˆ é™¤ä¸€ä¸ª statefulsetï¼Œçœ‹çœ‹å…¶ä¿å­˜çš„æ•°æ®ä¼šä¸ä¼šä¸¢å¤±ï¼š\n$ kubectl delete po kubia-0 pod \u0026quot;kubia-0\u0026quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-1 1/1 Running 0 12h kubia-0 1/1 Running 0 27s $ curl localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/ You've hit kubia-0 Data stored on this pod: Hey there! This greeting was submitted to kubia-0. å‘ç°è¯¥ po è¢«åˆ é™¤åç«‹é©¬å°±é‡æ–°åˆ›å»ºå‡ºäº†ä¸€ä¸ªæ–°çš„ï¼Œå¹¶ä¸”åå­—ä¸ä¸ä¹‹å‰è¢«åˆ é™¤çš„ pod å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”å…¶å­˜å‚¨çš„æ•°æ®ä¹Ÿæ²¡æœ‰ä¸¢å¤±\nåœ¨ statefulset ä¸­å‘ç°ä¼™ä¼´èŠ‚ç‚¹ ä¹‹å‰ä»¥å·²ç»åˆ›å»ºäº†ä¸€ä¸ª handless serviceï¼Œé€šè¿‡è§£æï¼ˆlookupï¼‰è¿™ä¸ª service çš„ dns ä¾¿å¯è·å–å…¶ç®¡è¾–çš„æ‰€æœ‰ pod çš„ ipï¼Œé‚£ä¹ˆ pod å°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥è·å–åŒå±äºä¸€ä¸ª service ä¸‹çš„å…¶ä»– pod çš„åœ°å€ï¼Œè¿›è€Œå®Œæˆé€šä¿¡ã€‚ä¸‹é¢å°±æ¥å®è·µä¸€ä¸‹ï¼š\né¦–å…ˆæ¥å°è¯•ä¸€ä¸‹è·å– handless service ä¸‹æ‰€æœ‰ pod çš„ SRV è®°å½•ï¼š\nä»€ä¹ˆæ˜¯ SRV è®°å½•ï¼Ÿ\næŸ¥çœ‹ handless service çš„ SRV è®°å½•ï¼š\nPS: ä¹¦é‡Œå†™çš„æ˜¯ \u0026ndash;image=tutum/dnstuilsï¼Œä½†æ˜¯è¿™ä¸ªé•œåƒæ˜¯ amd64 çš„ï¼Œæ‰€ä»¥æˆ‘é‡æ–°åšäº†ä¸€ä¸ªé•œåƒï¼šstdoutt/dnstuils-arm64\né™„ï¼šè¯¥é•œåƒçš„ Dockerfile\nFROM ubuntu:trusty RUN apt-get update \u0026amp;\u0026amp; apt-get install -yq dnsutils \u0026amp;\u0026amp; apt-get clean \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists å…·ä½“æ“ä½œï¼š\n# å…ˆçœ‹ä¸€ä¸‹ handless service çš„ name $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 2d3h kubia ClusterIP None \u0026lt;none\u0026gt; 80/TCP 12s # æŸ¥çœ‹ kubia è¿™ä¸ª service çš„ SRV è®°å½•ï¼ˆè¯¥ service çš„å®Œæ•´åŸŸåæ˜¯ kubia.default.svc.cluster.local ï¼‰ï¼Œè¿™ä¸ª pod åœ¨ # è¿è¡Œå®Œæ¯•åä¼šç«‹é©¬åˆ é™¤ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ stdoutt/dnsutils-arm64 è¿™ä¸ªé€‚ç”¨äº arm64 çš„é•œåƒ $ kubectl run -it srvlookup --image=stdoutt/dnsutils-arm64 --rm --restart=Never -- dig SRV kubia.default.svc.cluster.local ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.9.5-3ubuntu0.19-Ubuntu \u0026lt;\u0026lt;\u0026gt;\u0026gt; SRV kubia.default.svc.cluster.local ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 24375 ;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 3 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;kubia.default.svc.cluster.local. IN\tSRV ;; ANSWER SECTION: kubia.default.svc.cluster.local. 5 IN\tSRV\t0 50 80 kubia-0.kubia.default.svc.cluster.local. kubia.default.svc.cluster.local. 5 IN\tSRV\t0 50 80 kubia-1.kubia.default.svc.cluster.local. # è¿™é‡Œä¾¿è·å–åˆ°äº†è¯¥ service ä¸‹çš„æ‰€æœ‰ pod çš„ ip åœ°å€ ;; ADDITIONAL SECTION: kubia-1.kubia.default.svc.cluster.local. 5 IN A\t10.42.0.22 kubia-0.kubia.default.svc.cluster.local. 5 IN A\t10.42.0.23 ;; Query time: 12 msec ;; SERVER: 10.43.0.10#53(10.43.0.10) ;; WHEN: Mon Sep 26 16:37:29 UTC 2022 ;; MSG SIZE rcvd: 350 pod \u0026quot;srvlookup\u0026quot; deleted ä½¿ç”¨ StatefulSet æ­å»ºä¸€ä¸ª MySQL é›†ç¾¤ ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éœ€è¦ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª configmap å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œå®šä¹‰äº† master.cnf å’Œ slave.cnf ä¸¤ä¸ª MySQL çš„é…ç½®æ–‡ä»¶ã€‚\nmaster.cnf å¼€å¯äº† log-binï¼Œå³ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œä¸»ä»å¤åˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è®¾ç½®ã€‚ slave.cnf å¼€å¯äº† super-read-onlyï¼Œè¡¨ç¤ºä»èŠ‚ç‚¹ä¼šæ‹’ç»é™¤ä¸»èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥æ“ä½œå¤–çš„æ‰€æœ‰å†™æ“ä½œï¼Œå³å®ƒå¯¹ç”¨æˆ·æ˜¯åªè¯»çš„ã€‚ mysql-configmap.yaml\napiVersion: v1 kind: ConfigMap metadata: name: mysql labels: app: mysql app.kubernetes.io/name: mysql data: primary.cnf: | # ä»…åœ¨ä¸»æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] log-bin replica.cnf: | # ä»…åœ¨å‰¯æœ¬æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] super-read-only psï¼šä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ \u0026lt;\u0026lt;EOF å†™å…¥åˆ°æ–‡ä»¶ï¼Œå®ƒå°†æŒç»­è¯»å–ä½ çš„å¤šè¡Œè¾“å…¥ï¼Œç›´åˆ°ä½ è¾“å…¥ä¸€ä¸ª EOFã€‚\ncat \u0026lt;\u0026lt;EOF \u0026gt; mysql-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: mysql labels: app: mysql app.kubernetes.io/name: mysql data: primary.cnf: | # ä»…åœ¨ä¸»æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] log-bin replica.cnf: | # ä»…åœ¨å‰¯æœ¬æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] super-read-only EOF åˆ›å»ºè¿™ä¸ª cmï¼š\n$ kubectl apply -f mysql-configmap.yaml configmap/mysql created $ kubectl get cm NAME DATA AGE kube-root-ca.crt 1 5d22h mysql 2 27s æ¥ä¸‹æ¥ï¼Œéœ€è¦åˆ›å»ºä¸¤ä¸ª Service æ¥ä¾› StatefulSet ä»¥åŠç”¨æˆ·ä½¿ç”¨ã€‚è¿™ä¸¤ä¸ª Service çš„å®šä¹‰å¦‚ä¸‹ï¼š\n# ä¸º StatefulSet æˆå‘˜æä¾›ç¨³å®šçš„ DNS è¡¨é¡¹çš„æ— å¤´æœåŠ¡ï¼ˆHeadless Serviceï¼‰ apiVersion: v1 kind: Service metadata: name: mysql labels: app: mysql app.kubernetes.io/name: mysql spec: ports: - name: mysql port: 3306 clusterIP: None selector: app: mysql --- # ç”¨äºè¿æ¥åˆ°ä»»ä¸€ MySQL å®ä¾‹æ‰§è¡Œè¯»æ“ä½œçš„å®¢æˆ·ç«¯æœåŠ¡ # å¯¹äºå†™æ“ä½œï¼Œä½ å¿…é¡»è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼šmysql-0.mysql apiVersion: v1 kind: Service metadata: name: mysql-read labels: app: mysql app.kubernetes.io/name: mysql readonly: \u0026quot;true\u0026quot; spec: ports: - name: mysql port: 3306 selector: app: mysql è¿™ä¸¤ä¸ª Service éƒ½ä»£ç†äº†å«æœ‰ label app: mysql çš„ Podï¼Œç«¯å£æ˜ å°„éƒ½æ˜¯ç”¨ Service çš„ 3306 ç«¯å£å¯¹åº” Pod çš„ 3306 ç«¯å£ï¼Œå¹¶ä¸”å…¶ä¸­ä¸€ä¸ª Service æ˜¯ Headless Serviceï¼ˆå³ ClusterIP ä¸º Noneï¼‰ï¼Œå®ƒå°†ä¸ºå…¶ä»£ç†çš„ Pod åˆ†é…ä¸€ä¸ª DNS è®°å½•æ¥å›ºå®šå…¶æ‹“æ‰‘çŠ¶æ€\n","date":"2022å¹´09æœˆ11æ—¥","permalink":"/posts/k8s-statefulset/","summary":"æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€ æ— çŠ¶æ€åº”ç”¨ï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡Œæ—¶ä¸éœ€è¦ç»´æŠ¤æˆ–è·Ÿè¸ªä»»ä½•ç‰¹å®šçŠ¶æ€çš„åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼ŒWeb æœåŠ¡å™¨æˆ– API æœåŠ¡å™¨é€šå¸¸å¯ä»¥å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œæ— éœ€äº†è§£ä»¥å‰çš„è¯·æ±‚æˆ–å®¢æˆ·ç«¯çŠ¶æ€ã€‚è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°æ°´å¹³æ‰©å±•ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦å…±äº«çŠ¶æ€ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚åƒ Deployment ä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæ— çŠ¶æ€åº”ç”¨â€ï¼Œå®ƒä¼šæŒ‰ç…§äº‹å…ˆå£°æ˜çš„æ¨¡æ¿åˆ›å»ºå‡º podï¼Œè¿™è¡¨ç¤ºæ¯ä¸ª pod çš„å®šä¹‰å°†ä¼šæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ­¤å¤–ï¼Œè¿™äº› pod ä¹‹é—´æ²¡æœ‰ä¹‹é—´æ²¡æœ‰é¡ºåºç›¸å…³æ€§ï¼ˆä»€ä¹ˆäº‹æœ‰é¡ºåºç›¸å…³æ€§ï¼Ÿæ¯”å¦‚ä¸€äº›é›†ç¾¤åº”ç”¨åŒ…å«ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼Œè€Œä¸»èŠ‚ç‚¹å¿…é¡»å…ˆäºä»èŠ‚ç‚¹å¯åŠ¨ï¼Œè¿™ä¾¿æ˜¯é¡ºåºç›¸å…³æ€§ï¼‰ï¼Œä¹Ÿæ— æ‰€è°“åœ¨å“ªå°å®¿ä¸»æœºä¸Šè¿è¡Œï¼Œä»»ä½•ä¸€ä¸ª pod éƒ½å¯ä»¥æä¾›å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ï¼Œä¸éœ€è¦æ—¶ï¼Œä¹Ÿå¯ä»¥ç»“æŸä»»æ„ä¸€ä¸ª podã€‚","title":"k8s StatefulSet"},{"contents":"ä½¿ç”¨ snap å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„å®‰è£… dockerï¼Œä½†æ˜¯æœ‰ä¸€æ¬¡å‡ºç°äº† k8s pod æ— æ³•æ‹‰å–é•œåƒçš„é—®é¢˜ï¼Œçœ‹äº†ä¸‹ pod describeï¼Œå‘ç°æ˜¯å› ä¸ºèµ°ä»£ç†çš„é—®é¢˜ï¼ˆæˆ‘ä½¿ç”¨çš„æ˜¯ ubuntu è™šæ‹Ÿæœºï¼Œè¿æ¥å®¿ä¸»æœºçš„ clashx è¿›è¡Œä»£ç†ï¼‰ï¼Œè¿æ¥çš„ä»£ç†æ˜¯å®¿ä¸»æœºçš„è€åœ°å€ 192.168.2.5ï¼Œä½†æ˜¯å› ä¸ºé‡å¯è¿‡è·¯ç”±å™¨ï¼Œæ‰€ä»¥å®¿ä¸»æœºçš„åœ°å€å˜æ›´ä¸ºäº† 192.168.2.3ï¼Œä»£ç†ä¸é€šè‡ªç„¶ä¹Ÿæ‹‰å–ä¸äº†é•œåƒäº†ï¼ŒæŠ¥é”™ï¼š\nFailed to pull image \u0026quot;redis\u0026quot;: rpc error: code = Unknown desc = Error response from daemon: Get \u0026quot;https://registry-1.docker.io/v2/\u0026quot;: proxyconnect tcp: dial tcp 192.168.2.5:7890: connect: connection refused è™½ç„¶æˆ‘é‡æ–°è®¾ç½®äº† https_proxy ç­‰ç›¸å…³ç¯å¢ƒå˜é‡ï¼Œå¹¶ä¸” curl google å¯ä»¥æ­£å¸¸è¿”å›ï¼Œä½†æ˜¯ pod è¿™è¾¹ä¾æ—§æ— æ³•æ‹‰å–ï¼Œèµ°çš„è¿˜æ˜¯ 192.168.2.5 è¿™ä¸ªåœ°å€ã€‚\näºæ˜¯æˆ‘å°±å°è¯•é‡å¯ä¸€ä¸‹ docker çœ‹èƒ½ä¸èƒ½è§£å†³ï¼ŒæŒ‰ç…§ç½‘ä¸Šæä¾›çš„å‡ ä¸ªæ–¹æ¡ˆï¼Œsystemctl restart dockerï¼ŒæŠ¥é”™ï¼šFailed to restart docker.service: Unit docker.service not found.ï¼Œäºæ˜¯æˆ‘åˆå°è¯•ä½¿ç”¨ snap restart dockerï¼Œå‘ç°å¯ä»¥é‡å¯æˆåŠŸï¼Œè¾“å‡ºä¿¡æ¯ï¼š\nRun service command \u0026quot;restart\u0026quot; for running services of snap \u0026quot;docker\u0026quot; Restarted. çœ‹èµ·æ¥å·²ç»é‡å¯æˆåŠŸäº†ï¼Œä½†æ˜¯ç­‰æˆ‘æ‰§è¡Œ docker ps æ—¶ï¼Œç›´æ¥æŠ¥é”™ï¼šdocker ps Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?ï¼Œæ ¹æœ¬å°±æ²¡é‡å¯æˆåŠŸï¼äºæ˜¯æˆ‘åˆå°è¯•æ‰§è¡Œ snap start docker å‘½ä»¤ï¼Œè¿”å› Started.ï¼Œä½†æ˜¯ç„¶å¹¶åµï¼Œä¾ç„¶æŠ¥ä¹‹å‰çš„é”™è¯¯ï¼Œå®å±æ˜¯ä¸ªå‘çˆ¹ç©æ„ã€‚\næ²¡å¾—åŠæ³•ï¼Œåªèƒ½ä» snap ä¸­åˆ æ‰ dockerï¼Œå†é‡æ–°ä½¿ç”¨ apt-get å®‰è£…äº†ï¼Œä½†æ˜¯ apt-get å®‰è£…å°±ç•¥æœ‰ç¹çäº†ï¼Œå‚ç…§ è¿™ç¯‡æ–‡ç«  ï¼š\n$ sudo apt update $ sudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # æ³¨æ„è¿™ä¸€æ­¥ï¼Œarch è¿™é‡Œï¼Œè¦æ ¹æ®ä½ çš„æœºå™¨æ¶æ„æ¥æŒ‡å®šï¼Œæ¯”å¦‚ arm64 æˆ–è€…æ˜¯ amd64ï¼Œæˆ‘ä¸€å¼€å§‹å°±æ˜¯ç›´æ¥å¤åˆ¶æ–‡ç« ä¸­çš„å‘½ä»¤ï¼Œå¯¼è‡´åŠ å…¥çš„æ˜¯ # amd64 çš„è½¯ä»¶æºï¼Œè€Œæˆ‘çš„æœºå™¨æ˜¯ arm çš„ï¼Œå¯¼è‡´åé¢å®‰è£… docker å¤±è´¥ # å¯ä»¥ä½¿ç”¨ uname -c æŸ¥çœ‹æœºå™¨çš„æ¶æ„ $ sudo add-apt-repository \u0026quot;deb [arch=arm64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\u0026quot; $ sudo apt update $ sudo apt install docker-ce docker-ce-cli containerd.io ä½¿ç”¨ apt-get å®‰è£…çš„ docker å°±å¯ä»¥ä½¿ç”¨ systemctl æ“ä½œäº†ã€‚\n$ systemctl restart docker ","date":"2022å¹´09æœˆ10æ—¥","permalink":"/posts/ubuntu-arm64-an-zhuang-docker/","summary":"ä½¿ç”¨ snap å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„å®‰è£… dockerï¼Œä½†æ˜¯æœ‰ä¸€æ¬¡å‡ºç°äº† k8s pod æ— æ³•æ‹‰å–é•œåƒçš„é—®é¢˜ï¼Œçœ‹äº†ä¸‹ pod describeï¼Œå‘ç°æ˜¯å› ä¸ºèµ°ä»£ç†çš„é—®é¢˜ï¼ˆæˆ‘ä½¿ç”¨çš„æ˜¯ ubuntu è™šæ‹Ÿæœºï¼Œè¿æ¥å®¿ä¸»æœºçš„ clashx è¿›è¡Œä»£ç†ï¼‰ï¼Œè¿æ¥çš„ä»£ç†æ˜¯å®¿ä¸»æœºçš„è€åœ°å€ 192.","title":"ubuntu arm64 ä½¿ç”¨ apt-get å®‰è£… dockerï¼Œä»¥åŠ snap çš„ä¸€äº›é—®é¢˜è®°å½•"},{"contents":"ç¯å¢ƒï¼š\næœºå™¨ï¼šMacBook Air (M1, 2020) ç³»ç»Ÿï¼šMacOS 12.5.1 Goland ç‰ˆæœ¬ï¼š2022.2.2 Idea ç‰ˆæœ¬ï¼š2022.1.1 ä»Šå¤©å¯åŠ¨ GoLand å‘ç°ä¼šç«‹é©¬é—ªé€€ï¼Œæç¤ºç¨‹åºæ„å¤–é€€å‡ºï¼Œåæ¥åˆè¯•äº†ä¸‹ Idea å’Œ Clionï¼Œå‘ç°å…¨éƒ¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå°è¯•åœ¨ç»ˆç«¯å¯åŠ¨æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼š\n$ cd ~/Library/Application\\ Support/JetBrains/Toolbox/apps/Goland/ch-0/222.3739.57/GoLand.app/Contents/MacOS $ ./goland 2022-09-07 22:53:36.422 goland[12904:58283] allVms required 1.8*,1.8+ 2022-09-07 22:53:36.425 goland[12904:58286] Current Directory: /Users/zenghao/Library/Application Support/JetBrains/Toolbox/apps/Goland/ch-0/222.3739.57/GoLand.app/Contents/MacOS 2022-09-07 22:53:36.425 goland[12904:58286] parseVMOptions: GOLAND_VM_OPTIONS = /Users/zenghao/Downloads/jetbra/vmoptions/goland.vmoptions 2022-09-07 22:53:36.428 goland[12904:58286] parseVMOptions: platform=-1 user=-1 file=(null) 2022-09-07 22:53:36.531 goland[12904:58286] *** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'NSWindow drag regions should only be invalidated on the Main Thread!' *** First throw call stack: ( 0 CoreFoundation 0x00000001c26951a8 __exceptionPreprocess + 240 1 libobjc.A.dylib 0x00000001c23dfe04 objc_exception_throw + 60 2 CoreFoundation 0x00000001c26c0128 _CFBundleGetValueForInfoKey + 0 3 AppKit 0x00000001c51a3930 -[NSWindow(NSWindow_Theme) _postWindowNeedsToResetDragMarginsUnlessPostingDisabled] + 372 4 AppKit 0x00000001c518e92c -[NSWindow _initContent:styleMask:backing:defer:contentView:] + 948 5 AppKit 0x00000001c533607c -[NSPanel _initContent:styleMask:backing:defer:contentView:] + 48 6 AppKit 0x00000001c518e56c -[NSWindow initWithContentRect:styleMask:backing:defer:] + 56 7 AppKit 0x00000001c5336030 -[NSPanel initWithContentRect:styleMask:backing:defer:] + 48 8 AppKit 0x00000001c518cd94 -[NSWindowTemplate nibInstantiate] + 292 9 AppKit 0x00000001c51579e8 -[NSIBObjectData instantiateObject:] + 236 10 AppKit 0x00000001c515726c -[NSIBObjectData nibInstantiateWithOwner:options:topLevelObjects:] + 392 11 AppKit 0x00000001c514b800 loadNib + 416 12 AppKit 0x00000001c514ad30 +[NSBundle(NSNibLoading) _loadNibFile:nameTable:options:withZone:ownerBundle:] + 800 13 AppKit 0x00000001c514a934 -[NSBundle(NSNibLoading) loadNibNamed:owner:topLevelObjects:] + 220 14 AppKit 0x00000001c54b4674 -[NSAlert init] + 148 15 goland 0x0000000100415270 -[Launcher buildArgsFor:] + 1144 16 goland 0x0000000100415878 -[Launcher launch] + 312 17 Foundation 0x00000001c34f060c __NSThread__start__ + 808 18 libsystem_pthread.dylib 0x00000001c254826c _pthread_start + 148 19 libsystem_pthread.dylib 0x00000001c254308c thread_start + 8 ) libc++abi: terminating with uncaught exception of type NSException [1] 12904 abort ./goland å‘ç°æŠ¥é”™ä¿¡æ¯æ˜¯ NSInternalInconsistencyExceptionï¼Œæœ€ç»ˆæ‰¾åˆ°äº† è§£å†³æ–¹æ³•\nè¿™ä¸ª issue ä¸‹é¢æœ‰ä¸€æ¡å›å¤ï¼š\nhey I could fix this issue with following instructions:\nopen this file /Users/{USER_NAME}/Library/LaunchAgents/jetbrains.vmoptions.plist\nand then remove all launchctl setenv \u0026quot;*_OPTIONS\u0026quot;.\nsave and close it.\nreboot your mac.\nnow you can use jetbrain :)\næµç¨‹ï¼š\n# 1. $ cd ~/Library/LaunchAgents # 2. $ open jetbrains.vmoptions.plist # 3. # åˆ é™¤æ‰€æœ‰ä»¥ launchctl setenv å¼€å¤´çš„è¡Œï¼Œä¹Ÿå°±æ˜¯é™¤ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œå¤–çš„æ‰€æœ‰å†…å®¹ # 4. # é‡å¯ mac # 5. # å¤§åŠŸå‘Šæˆ ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Œä¸ªäººæ„Ÿè§‰å¤§æ¦‚ç‡æ˜¯å› ä¸ºç”¨äº†ç ´è§£çš„ç¼˜æ•…ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æµç¨‹é‡å¯ä»¥åä¼šå‘ç°è®¤è¯ä¿¡æ¯å·²ç»æ²¡æœ‰äº†ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œç ´è§£è„šæœ¬å¹¶è¾“å…¥æ¿€æ´»ç ã€‚\n","date":"2022å¹´09æœˆ08æ—¥","permalink":"/posts/jetbrain_crash/","summary":"ç¯å¢ƒï¼š\næœºå™¨ï¼šMacBook Air (M1, 2020) ç³»ç»Ÿï¼šMacOS 12.","title":"GoLand/Idea å¯åŠ¨é—ªé€€ï¼ŒæŠ¥é”™ NSInternalInconsistencyException çš„è§£å†³æ–¹æ³•"},{"contents":"ä»‹ç» veth-pair æ˜¯ä»€ä¹ˆ ä¸¤ä¸ª namespace é—´é€šä¿¡ ç›´æ¥è¿æ¥ # åˆ›å»º 2 ä¸ª namespace $ ip netns add ns1 $ ip netns add ns2 # æŸ¥çœ‹åˆ›å»ºçš„ namespace $ ip netns ns2 ns1 # åˆ›å»ºä¸€å¯¹ veth-pair veth0 veth1 $ ip l a veth0 type veth peer name veth1 # ä¹Ÿå¯ä»¥å†™æˆï¼š # ip link add veth0 type veth peer name veth1 # å°† veth0 veth1 åˆ†åˆ«åŠ å…¥ä¸¤ä¸ª ns $ ip l s veth0 netns ns1 $ ip l s veth1 netns ns2 # ç»™ä¸¤ä¸ª veth0 veth1 é…ä¸Š IP å¹¶å¯ç”¨ $ ip netns exec ns1 ip a a 10.1.1.2/24 dev veth0 $ ip netns exec ns1 ip l s veth0 up $ ip netns exec ns2 ip a a 10.1.1.3/24 dev veth1 $ ip netns exec ns2 ip l s veth1 up # ä» veth0 ping veth1 $ ip netns exec ns1 ping 10.1.1.3 PING 10.1.1.3 (10.1.1.3) 56(84) bytes of data. 64 bytes from 10.1.1.3: icmp_seq=1 ttl=64 time=0.997 ms 64 bytes from 10.1.1.3: icmp_seq=2 ttl=64 time=0.102 ms 64 bytes from 10.1.1.3: icmp_seq=3 ttl=64 time=0.063 ms ^C --- 10.1.1.3 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2026ms rtt min/avg/max/mdev = 0.063/0.387/0.997/0.431 ms å‚è€ƒ https://www.cnblogs.com/bakari/p/10613710.html\nhttps://segmentfault.com/a/1190000009251098\nhttps://mp.weixin.qq.com/s/dP12ptPlsxS35qPr0mDjCw\n","date":"2022å¹´09æœˆ06æ—¥","permalink":"/posts/linux_veth_pair/","summary":"ä»‹ç» veth-pair æ˜¯ä»€ä¹ˆ ä¸¤ä¸ª namespace é—´é€šä¿¡ ç›´æ¥è¿æ¥ # åˆ›å»º 2 ä¸ª namespace $ ip netns add ns1 $ ip netns add ns2 # æŸ¥çœ‹åˆ›å»ºçš„ namespace $ ip netns ns2 ns1 # åˆ›å»ºä¸€å¯¹ veth-pair veth0 veth1 $ ip l a veth0 type veth peer name veth1 # ä¹Ÿå¯ä»¥å†™æˆï¼š # ip link add veth0 type veth peer name veth1 # å°† veth0 veth1 åˆ†åˆ«åŠ å…¥ä¸¤ä¸ª ns $ ip l s veth0 netns ns1 $ ip l s veth1 netns ns2 # ç»™ä¸¤ä¸ª veth0 veth1 é…ä¸Š IP å¹¶å¯ç”¨ $ ip netns exec ns1 ip a a 10.","title":"Linux è™šæ‹Ÿç½‘ç»œè®¾å¤‡ veth-pair [æœªå®Œ]"},{"contents":"ä»Šå¤©æ›´æ–°äº†ä¸€ä¸‹ä¹‹å‰å†™çš„ tcp serverï¼Œç»“æœæµ‹è¯•çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªååˆ†è¯¡å¼‚çš„ BUGï¼šå®¢æˆ·ç«¯è¿™è¾¹å‘é€å®Œæ•°æ®ï¼Œè¿›ç¨‹éƒ½å·²ç»é€€å‡ºäº†ï¼Œä½†æ˜¯æœåŠ¡ç«¯å´ä¾ç„¶æºæºä¸æ–­çš„æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œè€Œä¸”æ•°æ®åŒ…çš„å¤§å°éƒ½ä¸º 0ï¼Œè¿™ä¸ª BUG èŠ±è´¹äº†æˆ‘å¤§åŠå¤©çš„æ—¶é—´ï¼Œç»ˆäºæ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨ï¼Œç‰¹æ­¤è®°å½•ã€‚\né—®é¢˜å…³é”®å°±æ˜¯å¯¹ io.EOF çš„åˆ¤æ–­é€»è¾‘å‡ºäº†é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†ä»£ç ï¼š\né”™è¯¯ï¼š\nfunc (t *TCPConn) UnpackHeader(d *DataPack) (*Message, error) { head := make([]byte, d.HeadSize()) _, err := io.ReadFull(t.socketConn, head) if err != nil \u0026amp;\u0026amp; err != io.EOF { log.Println(\u0026quot;read head error: \u0026quot;, err) return nil, err } body, err := d.UnPack(head) if err != nil { return nil, err } return body, nil } func (t *TCPConn) Receive() (*Message, error) { pack := NewDataPack() header, err := t.UnpackHeader(pack) if err != nil { return nil, err } dataLen := header.dataLen msgType := header.typ } UnpackHeader è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘æ˜¯ if err != nil \u0026amp;\u0026amp; err != io.EOFï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œå¦‚æœ err æ˜¯ EOFï¼Œé‚£ä¹ˆå°±ä¸æ»¡è¶³æ¡ä»¶ï¼Œä¹Ÿå°±ä¸ä¼š return errï¼Œè€Œæ˜¯ç»§ç»­èµ°ä¸‹é¢çš„ä»£ç ï¼Œæœ€ç»ˆçš„ error return ä¸º nilã€‚EOF ä»£è¡¨å·²ç»æ— æ•°æ®å¯è¯»äº†ï¼Œæ‰€ä»¥è¿”å›çš„ Message ä¸ºç©ºï¼Œæ²¡æœ‰è¯»åˆ°ä»»ä½•ä¸œè¥¿ã€‚\nç„¶å Receive åˆè°ƒç”¨äº† UnpackHeaderï¼Œå› ä¸º err == nilï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œåˆ° dataLen := header.dataLen è¿™é‡Œï¼Œåˆå› ä¸º EOF å¯¼è‡´ dataLen == 0ï¼Œè¿™ä¾¿æ˜¯ä¸ºä½•è°ƒè¯•æ—¶å‘ç°æ•°æ®åŒ…å¤§å°ä¸º 0 çš„åŸå› ã€‚\nè€Œå› ä¸ºæ²¡æœ‰å¯¹ EOF é”™è¯¯è¿›è¡Œ return errorï¼Œå¯¼è‡´ Receive è¿™è¾¹ä¸€ç›´è¿”å›ç©ºåŒ…ï¼Œè€Œæˆ‘åˆåœ¨å¦ä¸€ä¸ªå‡½æ•° Handle ä¸­é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯æ¥æŒç»­è°ƒç”¨ Receiveï¼Œè¿™å°±å¯¼è‡´æœåŠ¡ç«¯å¯ä»¥æºæºä¸æ–­çš„æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œå®é™…ä¸Šè¿™æ˜¯å› ä¸ºæ²¡æœ‰å¯¹ EOF è¿›è¡Œåˆç†çš„å¤„ç†ã€‚\næ­£ç¡®ï¼š\nfunc (t *TCPConn) UnpackHeader(d *DataPack) (*Message, error) { head := make([]byte, d.HeadSize()) _, err := io.ReadFull(t.socketConn, head) if err != nil { if err != io.EOF { log.Println(\u0026quot;read head error: \u0026quot;, err) } return nil, err } body, err := d.UnPack(head) if err != nil { return nil, err } return body, nil } åªéœ€è¦å°†åˆ¤æ–­é€»è¾‘ä¿®æ”¹ä¸€ä¸‹å³å¯ï¼š\nif err != nil { if err != io.EOF { log.Println(\u0026quot;read head error: \u0026quot;, err) } return nil, err } åªè¦äº§ç”Ÿäº†é”™è¯¯å°±å¿…é¡» return errï¼Œå¦‚æœä¸æ˜¯ EOF çš„è¯è¦é¢å¤–è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚\n","date":"2022å¹´09æœˆ06æ—¥","permalink":"/posts/eof_cuo_wu/","summary":"ä»Šå¤©æ›´æ–°äº†ä¸€ä¸‹ä¹‹å‰å†™çš„ tcp serverï¼Œç»“æœæµ‹è¯•çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªååˆ†è¯¡å¼‚çš„ BUGï¼šå®¢æˆ·ç«¯è¿™è¾¹å‘é€å®Œæ•°æ®ï¼Œè¿›ç¨‹éƒ½å·²ç»é€€å‡ºäº†ï¼Œä½†æ˜¯æœåŠ¡ç«¯å´ä¾ç„¶æºæºä¸æ–­çš„æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œè€Œä¸”æ•°æ®åŒ…çš„å¤§å°éƒ½ä¸º 0ï¼Œè¿™ä¸ª BUG èŠ±è´¹äº†æˆ‘å¤§åŠå¤©çš„æ—¶é—´ï¼Œç»ˆäºæ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨ï¼Œç‰¹æ­¤è®°å½•ã€‚","title":"ä¸€ä¸ª EOF å¼•å‘çš„ä½çº§é”™è¯¯"},{"contents":"ç®€ä»‹ tcp çš„ç²˜åŒ…æ‹†åŒ…ä¹Ÿå±äºè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œè™½ç„¶ä¸å°‘äººéƒ½é„™å¤·çš„è®¤ä¸ºç²˜åŒ…æ˜¯ä¸€ä¸ªé”™è¯¯çš„è¯´æ³•ï¼Œå› ä¸º tcp æ˜¯é¢å‘æµä¼ è¾“çš„ï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œç²˜åŒ…è¿™ä¸ªè¯éƒ½å·²ç»ç®—å¾—ä¸Šæ˜¯æ·±å…¥äººå¿ƒäº†ã€‚\ntcp çš„æµå¼ä¼ è¾“ï¼Œç®€å•çš„è¯´å°±æ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œè®°å½•ï¼Œæ¯”å¦‚å‘é€ç«¯ä¸ºäº†å°†å¤šä¸ªå‘å¾€æ¥æ”¶ç«¯çš„åŒ…ï¼Œæ›´æœ‰æ•ˆçš„å‘åˆ°å¯¹æ–¹ï¼Œä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ³•ï¼ˆNagleç®—æ³•ï¼‰ï¼Œå°†å¤šæ¬¡é—´éš”è¾ƒå°ã€æ•°æ®é‡å°çš„æ•°æ®åŒ…ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€(æŠŠå‘é€ç«¯çš„ç¼“å†²åŒºå¡«æ»¡ä¸€æ¬¡æ€§å‘é€ã€‚è¿™æ ·æ¥æ”¶ç«¯æ”¶åˆ°çš„æ•´ä¸ªæ•°æ®ä¸­å…¶å®æ˜¯åŒ…å«äº†å¤šä¸ªå°åŒ…ï¼Œéœ€è¦å°†æ•°æ®æ‹†åˆ†ï¼Œè¿˜åŸæˆå°åŒ…ï¼Œä»è€Œæ‰èƒ½è¿›è¡Œå¤„ç†ï¼Œä½†å› ä¸ºæ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œè®°å½•ï¼Œæ‰€ä»¥å¦‚ä½•è¿˜åŸå°±æˆäº†ä¸€ä¸ªé—®é¢˜ã€‚\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œtcp å°†å¤šæ¬¡å†™å…¥ç¼“å†²åŒºçš„æ•°æ®åŒ…åˆå¹¶ä¸ºä¸€æ¬¡å‘é€ï¼Œå°±æ˜¯ ç²˜åŒ… é—®é¢˜ã€‚\næ­¤å¤– tcp è¿˜å­˜åœ¨ æ‹†åŒ… é—®é¢˜ï¼Œå°±æ˜¯å‘é€åŒ…çš„å¤§å°è¶…è¿‡äº†ç¼“å†²åŒºå¤§å°æˆ–è€… MSSï¼Œæ¯”å¦‚å‘é€ç«¯ä½¿ç”¨ protobuf ç¼–ç æ•°æ®ï¼Œç„¶åä½¿ç”¨ tcp è¿›è¡Œä¼ è¾“ï¼Œè¿™ä¸ªç¼–ç çš„æ•°æ®å¤§å°æ˜¯ 10000 byteï¼Œè¶…è¿‡äº† tcp çš„å‘é€ç¼“å­˜åŒºå¤§å° 5000 byteï¼ˆéšä¾¿å†™çš„æ•°å­—ï¼‰ï¼Œä¸€æ¬¡æ€§æ— æ³•å…¨éƒ¨å‘é€ï¼Œæ‰€ä»¥ä¾¿ä¼šå‘ç”Ÿæ‹†åŒ…ï¼Œåˆ†ä¸¤æ¬¡å‘é€ï¼Œæ¥æ”¶ç«¯è¿™è¾¹ç¬¬ä¸€æ¬¡åªæ”¶åˆ°äº† 5000 byte æ•°æ®ï¼Œå› ä¸ºæ•°æ®ä½¿ç”¨ protobuf ç¼–ç çš„ï¼Œä¸åŒäºæ–‡æœ¬æ¶ˆæ¯ï¼Œå¿…é¡»è¦æ‹¿åˆ°ä¸å¤šä¸å°‘åˆšåˆšå¥½çš„ 10000 byte å¤§å°çš„æ•°æ®ï¼Œæ‰èƒ½ååºåˆ—åŒ–å‡ºåŸå§‹çš„æ•°æ®ï¼Œä½†å› ä¸º tcp ä¸è®°å½•æ¶ˆæ¯é•¿åº¦ï¼Œæ‰€ä»¥æ¥æ”¶ç«¯è¿™è¾¹æ— æ³•çŸ¥é“åˆ°åº•è¦æ‹¿å¤šå°‘æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚\nå¯ä»¥çœ‹åˆ°å‘ç”Ÿç²˜åŒ…å’Œæ‹†åŒ…çš„åŸå› éƒ½æ˜¯å› ä¸º tcp ä¸è®°å½•æ¶ˆæ¯è¾¹ç•Œï¼ˆä¹Ÿå°±æ˜¯æ¶ˆæ¯é•¿åº¦ï¼‰ï¼Œæ—¢ç„¶ tcp è‡ªèº«ä¸è®°å½•ï¼Œé‚£å°±åªèƒ½ç”¨æˆ·è‡ªå·±è§£å†³äº†ï¼Œæ¯”å¦‚å†™ä¸€ä¸ªåè®®ï¼Œä¸ºæ¶ˆæ¯æ·»åŠ ä¸Šæ¶ˆæ¯å¤´ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­è®°å½•æ¶ˆæ¯çš„é•¿åº¦ï¼Œç„¶åå°†æ¶ˆæ¯å¤´ + æ¶ˆæ¯æœ¬ä½“ä½œä¸ºä¸€ä¸ªæ•´ä½“å‘é€ï¼Œï¼ˆè¿™é‡Œçš„æ¶ˆæ¯å¤´æ˜¯éœ€è¦å®šé•¿çš„ï¼Œæ¯”å¦‚å›ºå®šä¸º 10 byteï¼‰ï¼Œæ¥æ”¶ç«¯è¿™è¾¹æ ¹æ®åè®®å®šä¹‰ï¼Œå»è¯»å–è¿™ä¸ªå®šé•¿çš„æ¶ˆæ¯å¤´ï¼Œä»é‡Œé¢è·å–åˆ°æ¶ˆæ¯æœ¬ä½“çš„é•¿åº¦ï¼Œç°åœ¨çŸ¥é“äº†æ¶ˆæ¯çš„é•¿åº¦å°±å¥½è§£å†³ä¸Šé¢çš„é—®é¢˜äº†ã€‚\næ‹†åŒ…æ¼”ç¤ºç¨‹åº ä¸‹é¢å…ˆä½¿ç”¨ä¸€ä¸ªé”™è¯¯çš„ protobuf çš„ç¤ºä¾‹ç¨‹åºæ¥æ¼”ç¤ºä¸€ä¸‹æ‹†åŒ…é—®é¢˜ï¼š\nserver ç«¯ server è´Ÿè´£è¯»å–æŠ¥æ–‡ï¼Œç„¶åé€šè¿‡ proto.Unmarshal è¿˜åŸå‡ºåŸå§‹çš„æ•°æ®ã€‚å…¶ä¸­å°†ç¼“å†²åŒºå¤§å°è®¾ç½®ä¸ºäº† client è¦å‘é€çš„å¤§å° 279896ã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;net\u0026quot; \u0026quot;protobuftest/pb/pbfile\u0026quot; \u0026quot;google.golang.org/protobuf/proto\u0026quot; ) func main() { lis, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;:7788\u0026quot;) assert(err, \u0026quot;listen error: %v\u0026quot;) for { conn, err := lis.Accept() if err != nil { fmt.Println(err) continue } for { // b := make([]byte, 1024)\t// proto: cannot parse invalid wire-format data b := make([]byte, 279896) n, err := conn.Read(b) if err != nil { fmt.Println(err) break } fmt.Printf(\u0026quot;read %v bytes\\n\u0026quot;, n) var m pbfile.Message if err := proto.Unmarshal(b, \u0026amp;m); err != nil { fmt.Println(err) break } fmt.Println(m.Uid) } } } func assert(err error, format string) { if err != nil { panic(fmt.Sprintf(format, err.Error())) } } client ç«¯ client ä½¿ç”¨ protobuf åºåˆ—åŒ– struct pbfile.Messageï¼Œç„¶åä½¿ç”¨ tcp å‘é€ï¼Œè¿™ä¸ª struct ä¸­æœ‰ä¸€ä¸ª Data å­—æ®µï¼Œè¿™é‡Œæˆ‘å°†ä¸€å¼  140k çš„å›¾ç‰‡è¯»å–å‡ºæ¥ï¼Œç„¶åå°† Data å­—æ®µè®¾ç½®ä¸ºè¯»å–å‡ºçš„ []byte ã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;google.golang.org/protobuf/proto\u0026quot; \u0026quot;google.golang.org/protobuf/types/known/wrapperspb\u0026quot; \u0026quot;net\u0026quot; \u0026quot;os\u0026quot; \u0026quot;path/filepath\u0026quot; \u0026quot;protobuftest/pb/pbfile\u0026quot; ) func main() { home := os.Getenv(\u0026quot;HOME\u0026quot;) fp := filepath.Join(home, \u0026quot;Downloads/jDKUARa.jpg\u0026quot;) f, err := os.Open(fp) assert(err, \u0026quot;open file error: %v\u0026quot;) defer f.Close() file, err := os.ReadFile(fp) assert(err, \u0026quot;read file error: %v\u0026quot;) msg := pbfile.Message{ Uid: wrapperspb.UInt64(10086), Data: file, MessageType: wrapperspb.String(\u0026quot;image\u0026quot;), } conn, err := net.Dial(\u0026quot;tcp\u0026quot;, \u0026quot;:7788\u0026quot;) assert(err, \u0026quot;dial error: %v\u0026quot;) defer conn.Close() b, err := proto.Marshal(\u0026amp;msg) assert(err, \u0026quot;proto marshal error: %v\u0026quot;) fmt.Printf(\u0026quot;proto marshal size: %v\\n\u0026quot;, len(b)) n, err := conn.Write(b) assert(err, \u0026quot;write to conn error: %v\u0026quot;) fmt.Printf(\u0026quot;write %v bytes\\n\u0026quot;, n) } func assert(err error, format string) { if err != nil { panic(fmt.Sprintf(format, err.Error())) } } proto syntax=\u0026quot;proto3\u0026quot;; option go_package = \u0026quot;/pbfile\u0026quot;; import \u0026quot;google/protobuf/wrappers.proto\u0026quot;; message Message { google.protobuf.UInt64Value uid = 1; bytes data = 2; google.protobuf.StringValue messageType = 3; } è¿è¡Œç»“æœ åˆ†åˆ«è¿è¡Œ server å’Œ clientï¼Œè¾“å‡ºï¼š\n# client $ ./client proto marshal size: 279896 write 279896 bytes # server $ ./server read 81660 bytes proto: cannot parse invalid wire-format data å¯ä»¥çœ‹åˆ° client è¿™è¾¹å‘é€äº† 279896 å­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯ server è¿™è¾¹åªè¯»åˆ°äº† 81660 å­—èŠ‚ï¼Œå› ä¸º protobuf ä½¿ç”¨äºŒè¿›åˆ¶ç¼–ç ï¼Œæ‰€ä»¥å¦‚æœæ•°æ®ä¸å®Œæ•´ä¼šæ— æ³•è§£æï¼Œä»è€ŒæŠ¥é”™ï¼šproto: cannot parse invalid wire-format data\néƒ¨åˆ†æµ‹è¯•ç»“æœå¯ä»¥å°è¯è¿™ä¸€ç‚¹ï¼Œåªè¦è¯»å–çš„é•¿åº¦ä¸ç­‰äº 279896 å°±ä¼šè§£æå¤±è´¥ï¼š\nread 97992 bytes proto: cannot parse invalid wire-format data read 81660 bytes proto: cannot parse invalid wire-format data read 130656 bytes proto: cannot parse invalid wire-format data ä½†æ˜¯æœ‰æ—¶å€™åˆæ˜¯æ­£å¸¸çš„ï¼š\n# client $ ./client proto marshal size: 279896 write 279896 bytes # server $ read 279896 bytes value:10086 EOF ç–‘é—® è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œæ—¢ç„¶ server çš„ç¼“å†²åŒºå·²ç»å°†é•¿åº¦è®¾ç½®ä¸ºäº† 279896ï¼Œåˆšå¥½ç­‰äº client è¦å‘é€çš„åŒ…çš„å¤§å°ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå‡ºç°æ²¡æœ‰è¯»å–æ»¡çš„æƒ…å†µï¼Ÿ\nå¯èƒ½æ˜¯å› ä¸ºï¼šå‘é€æ–¹è™½ç„¶å‘é€äº† 279896 é•¿åº¦çš„æ•°æ®ï¼Œä½†æ˜¯è¿™äº›æ•°æ®ä¸ä¼šç›´æ¥é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œè€Œæ˜¯å…ˆæ·»åŠ åˆ° socket å‘é€ç¼“å†²åŒºï¼Œè‡³äºä»€ä¹ˆæ—¶å€™å‘é€ï¼Œå‘é€å¤šå°‘ï¼Œéƒ½æ˜¯ç”±ç³»ç»Ÿå†…æ ¸æ¥å†³å®šçš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¯¸å¦‚ä¸Šé¢è¿™ç§æ²¡æœ‰å®Œå…¨å‘å®Œçš„æƒ…å†µï¼Œå¶å°”åˆä¼šå‡ºç°å…¨éƒ¨å‘é€çš„æƒ…å†µã€‚\nç²˜åŒ…æ¼”ç¤ºç¨‹åº server æœåŠ¡ç«¯è¯•å›¾ä»æ”¶åˆ°çš„åŒ…ä¸­ååºåˆ—åŒ–å‡ºåŸå§‹æ•°æ®ã€‚\nfunc main() { lis, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;:7788\u0026quot;) assert(err, \u0026quot;listen error: %v\u0026quot;) for { conn, err := lis.Accept() if err != nil { fmt.Println(err) continue } for { b := make([]byte, 1024) n, err := conn.Read(b) if err != nil { fmt.Println(err) break } fmt.Printf(\u0026quot;read %v bytes\\n\u0026quot;, n) var m pbfile.Message if err := proto.Unmarshal(b, \u0026amp;m); err != nil { fmt.Println(err) break } fmt.Println(m.Uid) } } } client å®¢æˆ·ç«¯å‘é€ 10 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯è®¾ç½®ä¸åŒçš„ Uidï¼Œä¸”åºåˆ—åŒ–çš„å¯¹è±¡éƒ½æ¯”è¾ƒå°ã€‚\nfunc main() { conn, err := net.Dial(\u0026quot;tcp\u0026quot;, \u0026quot;:7788\u0026quot;) assert(err, \u0026quot;dial error: %v\u0026quot;) defer conn.Close() var totalN int for i := 0; i \u0026lt; 10; i++ { msg := pbfile.Message{ Uid: wrapperspb.UInt64(uint64(i)), Data: []byte(\u0026quot;hello\u0026quot;), MessageType: wrapperspb.String(\u0026quot;text\u0026quot;), } b, err := proto.Marshal(\u0026amp;msg) assert(err, \u0026quot;proto marshal error: %v\u0026quot;) fmt.Printf(\u0026quot;proto marshal size: %v\\n\u0026quot;, len(b)) n, err := conn.Write(b) totalN += n assert(err, \u0026quot;write to conn error: %v\u0026quot;) fmt.Printf(\u0026quot;write %v bytes\\n\u0026quot;, n) } fmt.Printf(\u0026quot;total write %v bytes\\n\u0026quot;, totalN) } è¿è¡Œç»“æœ $ go run server.go read 74 bytes proto: cannot parse invalid wire-format data $ go run client.go proto marshal size: 17 write 17 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes proto marshal size: 19 write 19 bytes total write 188 bytes å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯è¿™è¾¹æ¯æ¬¡å‘é€çš„æŠ¥æ–‡é•¿åº¦åŸºæœ¬éƒ½æ˜¯ 19 ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ˜¯ 17ï¼Œä¸€å…±å‘é€äº† 188 bytes çš„æ•°æ®ï¼Œè€ŒæœåŠ¡ç«¯è¿™è¾¹ï¼Œç¬¬ä¸€æ¬¡ä»è¿æ¥ä¸­æ¥æ”¶åˆ°çš„æ•°æ®å¤§å°æ˜¯ 74 bytesï¼Œè¿™æ˜¾ç„¶æ˜¯æœ‰å‡ ä¸ªåŒ… â€œç²˜â€ åœ¨äº†ä¸€èµ·ï¼Œæœ€ç»ˆæ˜¾ç„¶ä¹Ÿæ˜¯æ— æ³•ååºåˆ—åŒ–æˆåŠŸçš„ã€‚\nè§£å†³æ–¹æ³• æˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„ tcp server åº“ï¼Œé‡Œé¢è§£å†³äº†ä¸Šé¢çš„ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼Œæ€è·¯æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªåè®®ï¼Œåè®®çš„å¤´éƒ¨è®°å½•äº†æ•°æ®çš„é•¿åº¦ï¼Œç„¶åæ¥æ”¶ç«¯åœ¨æ”¶åˆ°æŠ¥æ–‡åï¼Œå…ˆè§£æå‡ºå¤´éƒ¨ï¼Œè·å–åˆ°æ•°æ®çš„é•¿åº¦ï¼Œåœ¨è¿›è¡Œä¸‹ä¸€æ­¥è¯»å–ã€‚ä¸ºäº†ä¿è¯è¯»æ»¡ï¼Œå¯ä»¥ä½¿ç”¨ io.ReadFull è¿™ä¸ªå‡½æ•°ï¼Œå¤§è‡´çš„è¯»å–é€»è¾‘å¦‚ä¸‹ï¼š\né¦–å…ˆæ˜¯è¯»å–åè®®å¤´éƒ¨çš„å‡½æ•°ï¼š\nfunc (t *TCPConn) UnpackHeader(d *DataPack) (*Message, error) { head := make([]byte, d.HeadSize()) _, err := io.ReadFull(t.socketConn, head) if err != nil { if err != io.EOF { log.Println(\u0026quot;read head error: \u0026quot;, err) } return nil, err } body, err := d.UnPack(head) if err != nil { return nil, err } return body, nil } ç„¶åæ˜¯è¯»å–æ•°æ®ï¼š\nfunc (t *TCPConn) Receive() (*Message, error) { pack := NewDataPack() header, err := t.UnpackHeader(pack) if err != nil { return nil, err } dataLen := header.dataLen var ( tmpBuf = make([]byte, 0, 4096) needN = dataLen // è¿˜å‰©å¤šå°‘éœ€è¦è¯»å– readN int64 // æ€»å…±éœ€è¦è¯»å–å¤šå°‘ ) for { buf := make([]byte, needN) // å¿…é¡»è¯»æ»¡ len(buf)ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ª err n, err := io.ReadFull(t.socketConn, buf) // æ²¡æœ‰è¯»æ»¡ buf if err != nil { // è™½ç„¶æ²¡è¯»æ»¡ï¼Œä½†æ˜¯è¿”å›äº† EOF é”™è¯¯ï¼Œè¯´æ˜æ²¡æœ‰æ•°æ®å¯è¯»äº†ï¼Œå¯èƒ½æ˜¯å¯¹æ–¹å·²ç»æ–­å¼€äº†è¿æ¥ï¼Œ // æ­¤æ—¶å°±ä¸éœ€è¦å†å°è¯•è¯»å–äº† if err == io.EOF { return nil, err } // å°†å½“å‰è¯»çš„è¿™éƒ¨åˆ†æ·»åŠ åˆ° tmp ä¸­ï¼Œæš‚æ—¶ä¿å­˜ tmpBuf = append(tmpBuf, buf[:n]...) needN -= uint64(n) // æ›´æ–° needN çš„å€¼ readN += int64(n) continue } // è¯»æ»¡äº† tmpBuf = append(tmpBuf, buf...) readN += int64(n) if readN == int64(dataLen) { break } } m := NewMessage(tmpBuf, msgType) return m, nil } æµ‹è¯•äº†å‰é¢çš„ç²˜åŒ…æ‹†åŒ…ä»£ç ï¼Œå‘ç°ç»“æœéƒ½æ­£ç¡®ï¼Œè¯´æ˜å¯ä»¥è§£å†³è¿™ç±»é—®é¢˜ï¼Œä½†æ˜¯ç›®å‰æµ‹è¯•çš„ä¾æ®è¾ƒå°‘ï¼Œä¹Ÿå¯èƒ½ä¸ä¸€å®šå‡†ç¡®ã€‚\né™„ï¼š\né¡¹ç›®åœ°å€\nç”¨ protobuf æ¥è¿›è¡Œç²˜åŒ…æ‹†åŒ…çš„æµ‹è¯•ä»£ç \n","date":"2022å¹´09æœˆ05æ—¥","permalink":"/posts/tcp_zhan_bao/","summary":"ç®€ä»‹ tcp çš„ç²˜åŒ…æ‹†åŒ…ä¹Ÿå±äºè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œè™½ç„¶ä¸å°‘äººéƒ½é„™å¤·çš„è®¤ä¸ºç²˜åŒ…æ˜¯ä¸€ä¸ªé”™è¯¯çš„è¯´æ³•ï¼Œå› ä¸º tcp æ˜¯é¢å‘æµä¼ è¾“çš„ï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œç²˜åŒ…è¿™ä¸ªè¯éƒ½å·²ç»ç®—å¾—ä¸Šæ˜¯æ·±å…¥äººå¿ƒäº†ã€‚","title":"tcp ç²˜åŒ…/æ‹†åŒ…é—®é¢˜"},{"contents":"çœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç çš„è¿è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;net\u0026quot; ) func main() { lis, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;:7788\u0026quot;) assert(err, \u0026quot;listen error: %v\u0026quot;, err.Error()) _ = lis } func assert(err error, format, msg string) { if err != nil { panic(fmt.Sprintf(format, msg)) } } ç»†å¿ƒçœ¼å°–çš„ä½ ä¸€å®šç«‹é©¬æƒ³åˆ°äº†ï¼š\n$ go run nil_pointer.go panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: segmentation violation code=0x2 addr=0x18 pc=0x100412238] goroutine 1 [running]: main.main() /Users/zenghao/pj/justtest/nil_pointer.go:10 +0x38 exit status 2 æ²¡é”™ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç©ºæŒ‡é’ˆé”™è¯¯ï¼Œå‘ç”Ÿåœ¨ err.Error() è¿™é‡Œï¼Œå¦‚æœ net.Listen æ²¡æœ‰äº§ç”Ÿé”™è¯¯ï¼Œé‚£ä¹ˆ err == nilï¼Œerr.Error() è‡ªç„¶å°±ä¼šäº§ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸äº†ã€‚ä½†è¿™ä¸ªé”™è¯¯å±…ç„¶å›°æ‰°äº†è®¸ä¹…ï¼Œè™½ç„¶ panic æç¤ºäº†ä»£ç è¡Œæ•°ï¼Œä½†æ˜¯æˆ‘ä¸€å¼€å§‹ç¡¬æ˜¯æ²¡æ³¨æ„åˆ° err.Error() è¿™é‡Œï¼ŒåŠ ä¸Š [signal SIGSEGV: segmentation violation code=0x2 addr=0x18 pc=0x100412238] è¿™é‡Œæ··æ·†äº†æˆ‘ï¼ˆå› ä¸ºä¹‹å‰è·‘è¿‡ä¸€ä¸ªé¡¹ç›®ï¼Œä¹Ÿæ˜¯è¿è¡Œå°±ä¼š panicï¼Œæç¤ºçš„ä¹Ÿæ˜¯ SIG ä¹‹ç±»çš„ï¼Œä½†æ˜¯è¿™ä¸ªé¡¹ç›® panic çš„åŸå› æ˜¯æœ‰äº›åŒ…æ²¡æœ‰é€‚é…å½“æ—¶æœ€æ–°çš„ go1.17 ç‰ˆæœ¬ï¼Œéœ€è¦ä½¿ç”¨ go get -u æ¥æ›´æ–°éƒ¨åˆ†åŒ…ï¼Œå³å¯è§£å†³é—®é¢˜ï¼‰ï¼Œå¯¼è‡´æˆ‘æœç€ä¸€ä¸ªé”™è¯¯çš„æ–¹å‘è§£å†³é—®é¢˜ã€‚\né—®é¢˜åˆ°è¿™é‡Œå°±ç®—ç»“æŸäº†ï¼Œä½†æ˜¯è¿™ç§ä½çº§é”™è¯¯è€½è¯¯äº†è®¸å¤šæ—¶é—´ï¼Œæˆ‘åœ¨æƒ³æœ‰æ²¡æœ‰ä»€ä¹ˆå·¥å…·å¯ä»¥å¯¹è¿™ç§ç©ºæŒ‡é’ˆé”™è¯¯è¿›è¡Œæ£€æµ‹å‘¢ï¼Ÿ\nä½¿ç”¨ go vetï¼š\n$ go vet nil_pointer.go æ²¡æœ‰è¾“å‡ºä»»ä½•ä¿¡æ¯\næ­¤å¤–ï¼ŒGoLand å’Œ Vscode ä¹Ÿæ²¡æœ‰ä»»ä½• warning è­¦å‘Š\nä½¿ç”¨ golangci-lintï¼š\n$ golangci-lint run nil_pointer.go ä¹Ÿæ²¡æœ‰è¾“å‡ºä»»ä½•ä¿¡æ¯\næš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ£€æµ‹è¿™ç±»é—®é¢˜çš„å·¥å…·ï¼Œè™½ç„¶ Goland å¯ä»¥å¯¹éƒ¨åˆ†æ½œåœ¨çš„ nil pointer é—®é¢˜è¿›è¡Œè­¦å‘Šï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« çš„ä»£ç ä¸­æ— æ•ˆã€‚\n","date":"2022å¹´09æœˆ05æ—¥","permalink":"/posts/go_nil_pointer/","summary":"çœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç çš„è¿è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;net\u0026quot; ) func main() { lis, err := net.","title":"ä¸€ä¸ª go nil pointer é”™è¯¯è®°å½•"},{"contents":"å†™è¿™ç¯‡æ–‡ç« æ˜¯å› ä¸ºæœ€è¿‘åœ¨çœ‹ go netpoll çš„æºç ï¼Œé‡Œé¢æœ‰ä¸€éƒ¨åˆ†ä»£ç æ˜¯åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œä¸€å¼€å§‹æ²¡æœ‰ææ‡‚ç”¨æ„ä½•åœ¨ï¼Œåæ¥æŸ¥é˜…äº†ç½‘ä¸Šçš„æ–‡ç« ï¼Œæœ‰è¯´æ³•æ˜¯è¿™ä¸ªç®¡é“æ˜¯ä¸ºäº†æ‰“æ–­ epoll_wait çš„ç­‰å¾…ï¼Œå°†è¿™ä¸ªç®¡é“çš„ fd æ·»åŠ åˆ° epoll ä¸­ï¼Œå¦‚æœæƒ³ä¸»åŠ¨æ‰“æ–­ epoll_waitï¼Œé‚£ä¹ˆå°±å¾€ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç„¶ååœ¨ epoll_wait å¤„å°±ä¼šäº§ç”Ÿäº‹ä»¶ï¼Œç»ˆæ­¢é˜»å¡ã€‚\næœç´¢ epoll æ‰“æ–­ï¼Œå‘ç°èµ„æ–™éå¸¸å°‘ï¼Œgo netpoll è¿™éƒ¨åˆ†çš„æºç è®²è§£ä¹Ÿæ¯”è¾ƒå°‘ï¼ˆä¸»è¦æ˜¯ netpollBreak è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œè¿™å¯¼è‡´æˆ‘ä¸æ˜ç™½ä¸ºä»€ä¹ˆéœ€è¦æ‰“æ–­ epollï¼Œæˆ‘çš„çŒœæµ‹æ˜¯ï¼šå¯èƒ½æ˜¯ä¸ºäº†é¿å…è®©æŸæ¡çº¿ç¨‹æŒç»­é˜»å¡åœ¨ epoll_waitï¼Œè¿™æ ·ä¼šå¯¼è‡´è¿™æ¡çº¿ç¨‹æ¯”è¾ƒé—²ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿçš„ä»»åŠ¡æ¯”è¾ƒç¹å¿™ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½å°±éœ€è¦è®©æ¯æ¡çº¿ç¨‹éƒ½ â€œå¿™â€ èµ·æ¥ï¼Œå°±éœ€è¦ä¸»åŠ¨æ‰“æ–­è¿™äº›é˜»å¡åœ¨ epoll_wait çš„çº¿ç¨‹ï¼Œå…ˆç»™å®ƒä»¬åˆ†é…ä¸€äº›ä»»åŠ¡ï¼Œè®©å®ƒä»¬å¿™èµ·æ¥ã€‚\nåœ¨ä¸€ç¯‡åšå®¢ä¸Šè¿˜çœ‹åˆ°äº†ä¸€ç§è¯´æ³•ï¼š\nå’Œpoll/epollæ­é…ä½¿ç”¨ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¤šç”Ÿäº§è€…åœºæ™¯ å®é™…è¿™ç§ä½¿ç”¨åœºæ™¯ä¼šå¤šä¸€ç‚¹ï¼Œç”Ÿäº§è€…æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡ eventfd_write å”¤é†’æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…æ˜¯å•ä¸ªçº¿ç¨‹ï¼Œåå° loop å¤„ç†ã€‚ä½¿ç”¨ epoll ç›‘å¬ eventfd çš„å¯è¯»äº‹ä»¶ï¼Œè¿™æ ·èƒ½åšåˆ°ä¸€æ—¦æœ‰è¯·æ±‚å…¥é˜Ÿï¼Œæ¶ˆè´¹è€…å°±ç«‹é©¬å”¤é†’å¤„ç†ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥æ€»ç»“å‡º eventfd åœ¨å®é™…åœºæ™¯ä¸­å¯ä»¥ç»“åˆä¸šåŠ¡ï¼Œåšä¸€ä¸ªäº‹ä»¶é€šçŸ¥çš„é€šä¿¡æœºåˆ¶ï¼Œéå¸¸å·§å¦™ï¼Œè€Œä¸ç”¨è½®è¯¢è¿™ç§è€—æ—¶è€— cpu çš„æœºåˆ¶ã€‚è¿™å—å°±ä¸è¯¦ç»†å†™ç¤ºä¾‹äº†ã€‚\næ„Ÿè§‰è¯´çš„æŒºæœ‰é“ç†çš„ï¼Œè¿™ç§ç”¨ epoll å”¤é†’æ¥æè¿°æ›´ä¸ºåˆé€‚ï¼Œè€Œä¸æ˜¯ epoll æ‰“æ–­ï¼Œä¸ªäººçš„è§è§£ï¼ševentfd å…¶å®å’Œ socket ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯ç”¨äºåŒä¸€å°æœºå™¨ä¸Šçš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œè€Œ socket å› ä¸ºæ˜¯ç½‘ç»œä¼ è¾“æ‰€ä»¥å¯ä»¥è·¨æœºå™¨ã€‚\nä½¿ç”¨ç®¡é“ åˆ›å»ºä¸€ä¸ªåŒ¿åç®¡é“ï¼Œç”¨ epoll ç›‘å¬ç®¡é“çš„è¯»ç«¯ï¼Œç„¶å fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹åœ¨ sleep å‡ ç§’åä¼šå‘ç®¡é“å†™å…¥æ•°æ®ï¼Œç„¶åçˆ¶è¿›ç¨‹çš„ epoll_wait å°±ä¼šè¢«è§¦å‘äº‹ä»¶ï¼Œè¿›è€Œè·³å‡ºæ­»å¾ªç¯ï¼Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼ˆè¿™é‡Œé€»è¾‘å¯èƒ½ä¸å¤ªåˆç†ï¼‰ã€‚\n#include \u0026lt;sys/epoll.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #define EVENTS_SIZE 128 #define BUF_SIZE 1024 int main() { int pipefd[2]; int epfd = epoll_create(1024); struct epoll_event event1, event2, events[EVENTS_SIZE]; char buf[BUF_SIZE]; event1.events = EPOLLIN; event1.data.fd = STDIN_FILENO; int ret = epoll_ctl(epfd, EPOLL_CTL_ADD, STDIN_FILENO, \u0026amp;event1); if (ret != 0 ) { printf(\u0026quot;epoll_ctl error: %s\\n\u0026quot;, strerror(errno)); return 0; } if (pipe(pipefd) == -1) { perror(\u0026quot;pipe\u0026quot;); exit(EXIT_FAILURE); } // æ³¨æ„è¦å…ˆè°ƒç”¨ pipe() åˆ›å»ºç®¡é“ï¼Œå†æ·»åŠ åˆ° epollï¼Œå¦åˆ™æŠ¥é”™ Bad file descriptor event2.events = EPOLLIN; event2.data.fd = pipefd[0]; ret = epoll_ctl(epfd, EPOLL_CTL_ADD, pipefd[0], \u0026amp;event2); // å°†ç®¡é“çš„è¯»ç«¯æ·»åŠ åˆ° epoll ç›‘å¬é˜Ÿåˆ— if (ret != 0) { printf(\u0026quot;epoll_ctl error: %s\\n\u0026quot;, strerror(errno)); return 0; } pid_t cpid = fork(); switch (cpid) { case -1: perror(\u0026quot;fork\u0026quot;); exit(EXIT_FAILURE); case 0:\t// child // å‘ç°ä¸€ä¸ªæ–°å‘ï¼šå¦‚æœä½¿ç”¨ printf è¿›è¡Œè°ƒè¯•ï¼Œå¿…é¡»æ·»åŠ  \\n æ¢è¡Œç¬¦ï¼Œå¦åˆ™ç»ˆç«¯ä¸ä¼šè¾“å‡º // æå¾—æˆ‘è¿˜ä»¥ä¸ºå­è¿›ç¨‹æ²¡æœ‰æ‰§è¡Œ // printf(\u0026quot;child in\\n\u0026quot;); close(pipefd[0]);\t// å…³é—­ç®¡é“çš„è¯»ç«¯ï¼Œå› ä¸ºå­è¿›ç¨‹åªè´Ÿè´£å‘ç®¡é“å†™å…¥æ•°æ® sleep(3); char *s = \u0026quot;break\u0026quot;; write(pipefd[1], s, strlen(s)); printf(\u0026quot;child send sign to pipe\\n\u0026quot;); close(pipefd[1]); exit(0);\t// å¿…é¡»è¦å†™è¿™å¥ï¼Œä¸ç„¶ä¼šå‡ºç°ç¨‹åºå·²ç»é€€å‡ºï¼ˆç»ˆç«¯è¾“å‡ºå®Œæ¯•ï¼Œå·²ç»æ˜¾ç¤ºæ–°è¡Œï¼‰ï¼Œ // ä½†æ˜¯è¿›ç¨‹ä¾ç„¶åœ¨æ‰§è¡Œçš„è¿·æƒ‘æƒ…å†µï¼ˆç»ˆç«¯è¾“å…¥å…¨éƒ¨ä¼šè¢«å½“æˆ epoll äº‹ä»¶ï¼‰ default: // parent close(pipefd[1]);\t// å…³é—­ç®¡é“çš„å†™ç«¯ï¼Œå› ä¸ºçˆ¶è¿›ç¨‹åªè´Ÿè´£ä»ç®¡é“ä¸­è¯»å– while (1) { printf(\u0026quot;epoll is wait\\n\u0026quot;); int n = epoll_wait(epfd, events, EVENTS_SIZE, -1); // æ— é™é˜»å¡ for (int i = 0; i \u0026lt; n; i++) { //printf(\u0026quot;event fd: %d\\n\u0026quot;, events[i].data.fd); if (events[i].data.fd == STDIN_FILENO) { memset(buf, '\\0', BUF_SIZE); read(events[i].data.fd, buf, BUF_SIZE); printf(\u0026quot;read from stdin: %s\\n\u0026quot;, buf); } else if (events[i].data.fd == pipefd[0]) { printf(\u0026quot;pipe break epoll_wait!\\n\u0026quot;); memset(buf, '\\0', BUF_SIZE); read(events[i].data.fd, buf, BUF_SIZE);\t// æ¶ˆè´¹æ‰äº‹ä»¶ close(pipefd[0]); goto STOP_WAIT; } } } STOP_WAIT: printf(\u0026quot;do something\\n\u0026quot;); exit(0); } } ç»“æœï¼š\n$ clang pipe_break_epoll.c $ ./a.out epoll is wait pipe break epoll_wait! do something child send sign to pipe è¾“å‡ºé¡ºåºæœ‰ç‚¹é—®é¢˜ï¼Œä½†æ˜¯æ— ä¼¤å¤§é›…\nä½¿ç”¨ eventfd ","date":"2022å¹´09æœˆ02æ—¥","permalink":"/posts/epoll_zhong_duan/","summary":"å†™è¿™ç¯‡æ–‡ç« æ˜¯å› ä¸ºæœ€è¿‘åœ¨çœ‹ go netpoll çš„æºç ï¼Œé‡Œé¢æœ‰ä¸€éƒ¨åˆ†ä»£ç æ˜¯åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œä¸€å¼€å§‹æ²¡æœ‰ææ‡‚ç”¨æ„ä½•åœ¨ï¼Œåæ¥æŸ¥é˜…äº†ç½‘ä¸Šçš„æ–‡ç« ï¼Œæœ‰è¯´æ³•æ˜¯è¿™ä¸ªç®¡é“æ˜¯ä¸ºäº†æ‰“æ–­ epoll_wait çš„ç­‰å¾…ï¼Œå°†è¿™ä¸ªç®¡é“çš„ fd æ·»åŠ åˆ° epoll ä¸­ï¼Œå¦‚æœæƒ³ä¸»åŠ¨æ‰“æ–­ epoll_waitï¼Œé‚£ä¹ˆå°±å¾€ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç„¶ååœ¨ epoll_wait å¤„å°±ä¼šäº§ç”Ÿäº‹ä»¶ï¼Œç»ˆæ­¢é˜»å¡ã€‚","title":"epoll æ‰“æ–­/å”¤é†’"},{"contents":" æ¥æºï¼šhttps://www.cnblogs.com/Anker/p/3271773.html\nåŸºæœ¬æ¦‚å¿µ å­¤å„¿è¿›ç¨‹ï¼šä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹(è¿›ç¨‹å·ä¸º 1 )æ‰€æ”¶å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚\nåƒµå°¸è¿›ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ fork åˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ wait æˆ– waitpid è·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚\nå±å®³ unix æä¾›äº†ä¸€ç§æœºåˆ¶å¯ä»¥ä¿è¯åªè¦çˆ¶è¿›ç¨‹æƒ³çŸ¥é“å­è¿›ç¨‹ç»“æŸæ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œ å°±å¯ä»¥å¾—åˆ°ã€‚è¿™ç§æœºåˆ¶å°±æ˜¯: åœ¨æ¯ä¸ªè¿›ç¨‹é€€å‡ºçš„æ—¶å€™,å†…æ ¸é‡Šæ”¾è¯¥è¿›ç¨‹æ‰€æœ‰çš„èµ„æº,åŒ…æ‹¬æ‰“å¼€çš„æ–‡ä»¶,å ç”¨çš„å†…å­˜ç­‰ã€‚ ä½†æ˜¯ä»ç„¶ä¸ºå…¶ä¿ç•™ä¸€å®šçš„ä¿¡æ¯(åŒ…æ‹¬è¿›ç¨‹å· the process ID,é€€å‡ºçŠ¶æ€ the termination status of the process,è¿è¡Œæ—¶é—´ the amount of CPU time taken by the processç­‰)ã€‚ç›´åˆ°çˆ¶è¿›ç¨‹é€šè¿‡ wait / waitpid æ¥å–æ—¶æ‰é‡Šæ”¾ã€‚ ä½†è¿™æ ·å°±å¯¼è‡´äº†é—®é¢˜ï¼Œå¦‚æœè¿›ç¨‹ä¸è°ƒç”¨ wait / waitpid çš„è¯ï¼Œ é‚£ä¹ˆä¿ç•™çš„é‚£æ®µä¿¡æ¯å°±ä¸ä¼šé‡Šæ”¾ï¼Œå…¶è¿›ç¨‹å·å°±ä¼šä¸€ç›´è¢«å ç”¨ï¼Œä½†æ˜¯ç³»ç»Ÿæ‰€èƒ½ä½¿ç”¨çš„è¿›ç¨‹å·æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå¤§é‡çš„äº§ç”Ÿåƒµæ­»è¿›ç¨‹ï¼Œå°†å› ä¸ºæ²¡æœ‰å¯ç”¨çš„è¿›ç¨‹å·è€Œå¯¼è‡´ç³»ç»Ÿä¸èƒ½äº§ç”Ÿæ–°çš„è¿›ç¨‹. æ­¤å³ä¸ºåƒµå°¸è¿›ç¨‹çš„å±å®³ï¼Œåº”å½“é¿å…ã€‚\nå­¤å„¿è¿›ç¨‹æ˜¯æ²¡æœ‰çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ï¼Œå­¤å„¿è¿›ç¨‹è¿™ä¸ªé‡ä»»å°±è½åˆ°äº†initè¿›ç¨‹èº«ä¸Šï¼Œinitè¿›ç¨‹å°±å¥½åƒæ˜¯ä¸€ä¸ªæ°‘æ”¿å±€ï¼Œä¸“é—¨è´Ÿè´£å¤„ç†å­¤å„¿è¿›ç¨‹çš„å–„åå·¥ä½œã€‚æ¯å½“å‡ºç°ä¸€ä¸ªå­¤å„¿è¿›ç¨‹çš„æ—¶å€™ï¼Œå†…æ ¸å°±æŠŠå­¤å„¿è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è®¾ç½®ä¸ºinitï¼Œè€Œinitè¿›ç¨‹ä¼šå¾ªç¯åœ°wait()å®ƒçš„å·²ç»é€€å‡ºçš„å­è¿›ç¨‹ã€‚è¿™æ ·ï¼Œå½“ä¸€ä¸ªå­¤å„¿è¿›ç¨‹å‡„å‡‰åœ°ç»“æŸäº†å…¶ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œinitè¿›ç¨‹å°±ä¼šä»£è¡¨å…šå’Œæ”¿åºœå‡ºé¢å¤„ç†å®ƒçš„ä¸€åˆ‡å–„åå·¥ä½œã€‚å› æ­¤å­¤å„¿è¿›ç¨‹å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå±å®³ã€‚\n**ä»»ä½•ä¸€ä¸ªå­è¿›ç¨‹(inité™¤å¤–)åœ¨exit()ä¹‹åï¼Œå¹¶éé©¬ä¸Šå°±æ¶ˆå¤±æ‰ï¼Œè€Œæ˜¯ç•™ä¸‹ä¸€ä¸ªç§°ä¸ºåƒµå°¸è¿›ç¨‹(Zombie)çš„æ•°æ®ç»“æ„ï¼Œç­‰å¾…çˆ¶è¿›ç¨‹å¤„ç†ã€‚**è¿™æ˜¯æ¯ä¸ª å­è¿›ç¨‹åœ¨ç»“æŸæ—¶éƒ½è¦ç»è¿‡çš„é˜¶æ®µã€‚å¦‚æœå­è¿›ç¨‹åœ¨exit()ä¹‹åï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰æ¥å¾—åŠå¤„ç†ï¼Œè¿™æ—¶ç”¨pså‘½ä»¤å°±èƒ½çœ‹åˆ°å­è¿›ç¨‹çš„çŠ¶æ€æ˜¯â€œZâ€ã€‚å¦‚æœçˆ¶è¿›ç¨‹èƒ½åŠæ—¶ å¤„ç†ï¼Œå¯èƒ½ç”¨pså‘½ä»¤å°±æ¥ä¸åŠçœ‹åˆ°å­è¿›ç¨‹çš„åƒµå°¸çŠ¶æ€ï¼Œä½†è¿™å¹¶ä¸ç­‰äºå­è¿›ç¨‹ä¸ç»è¿‡åƒµå°¸çŠ¶æ€ã€‚ å¦‚æœçˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸä¹‹å‰é€€å‡ºï¼Œåˆ™å­è¿›ç¨‹å°†ç”±initæ¥ç®¡ã€‚initå°†ä¼šä»¥çˆ¶è¿›ç¨‹çš„èº«ä»½å¯¹åƒµå°¸çŠ¶æ€çš„å­è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚\nåƒµå°¸è¿›ç¨‹å±å®³åœºæ™¯ï¼š\nä¾‹å¦‚æœ‰ä¸ªè¿›ç¨‹ï¼Œå®ƒå®šæœŸçš„äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªå­è¿›ç¨‹éœ€è¦åšçš„äº‹æƒ…å¾ˆå°‘ï¼Œåšå®Œå®ƒè¯¥åšçš„äº‹æƒ…ä¹‹åå°±é€€å‡ºäº†ï¼Œå› æ­¤è¿™ä¸ªå­è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ï¼Œä½†æ˜¯ï¼Œçˆ¶è¿›ç¨‹åªç®¡ç”Ÿæˆæ–°çš„å­è¿›ç¨‹ï¼Œè‡³äºå­è¿›ç¨‹é€€å‡ºä¹‹åçš„äº‹æƒ…ï¼Œåˆ™ä¸€æ¦‚ä¸é—»ä¸é—®ï¼Œè¿™æ ·ï¼Œç³»ç»Ÿè¿è¡Œä¸Šä¸€æ®µæ—¶é—´ä¹‹åï¼Œç³»ç»Ÿä¸­å°±ä¼šå­˜åœ¨å¾ˆå¤šçš„åƒµæ­»è¿›ç¨‹ï¼Œå€˜è‹¥ç”¨ ps å‘½ä»¤æŸ¥çœ‹çš„è¯ï¼Œå°±ä¼šçœ‹åˆ°å¾ˆå¤šçŠ¶æ€ä¸º Z çš„è¿›ç¨‹ã€‚ ä¸¥æ ¼åœ°æ¥è¯´ï¼Œåƒµæ­»è¿›ç¨‹å¹¶ä¸æ˜¯é—®é¢˜çš„æ ¹æºï¼Œç½ªé­ç¥¸é¦–æ˜¯äº§ç”Ÿå‡ºå¤§é‡åƒµæ­»è¿›ç¨‹çš„é‚£ä¸ªçˆ¶è¿›ç¨‹ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬å¯»æ±‚å¦‚ä½•æ¶ˆç­ç³»ç»Ÿä¸­å¤§é‡çš„åƒµæ­»è¿›ç¨‹æ—¶ï¼Œç­”æ¡ˆå°±æ˜¯ æŠŠäº§ç”Ÿå¤§é‡åƒµæ­»è¿›ç¨‹çš„é‚£ä¸ªå…ƒå‡¶æªæ¯™æ‰ï¼ˆä¹Ÿå°±æ˜¯é€šè¿‡ kill å‘é€ SIGTERM æˆ–è€… SIGKILL ä¿¡å·å•¦ï¼‰ã€‚æªæ¯™äº†å…ƒå‡¶è¿›ç¨‹ä¹‹åï¼Œå®ƒäº§ç”Ÿçš„åƒµæ­»è¿›ç¨‹å°±å˜æˆäº†å­¤å„¿è¿›ç¨‹ï¼Œè¿™äº›å­¤å„¿è¿›ç¨‹ä¼šè¢« init è¿›ç¨‹æ¥ç®¡ï¼Œinit è¿›ç¨‹ä¼š wait() è¿™äº›å­¤å„¿è¿›ç¨‹ï¼Œé‡Šæ”¾å®ƒä»¬å ç”¨çš„ç³»ç»Ÿè¿›ç¨‹è¡¨ä¸­çš„èµ„æºï¼Œè¿™æ ·ï¼Œè¿™äº›å·²ç»åƒµæ­»çš„å­¤å„¿è¿›ç¨‹å°±èƒ½ç‘ç›®è€Œå»äº†ã€‚\næµ‹è¯• å­¤å„¿è¿›ç¨‹æµ‹è¯•ç¨‹åº #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; int main() { pid_t pid; //åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ pid = fork(); //åˆ›å»ºå¤±è´¥ if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } //å­è¿›ç¨‹ if (pid == 0) { printf(\u0026quot;I am the child process.\\n\u0026quot;); //è¾“å‡ºè¿›ç¨‹IDå’Œçˆ¶è¿›ç¨‹ID printf(\u0026quot;pid: %d\\tppid:%d\\n\u0026quot;,getpid(),getppid()); printf(\u0026quot;I will sleep five seconds.\\n\u0026quot;); //ç¡çœ 5sï¼Œä¿è¯çˆ¶è¿›ç¨‹å…ˆé€€å‡º sleep(5); printf(\u0026quot;pid: %d\\tppid:%d\\n\u0026quot;,getpid(),getppid()); printf(\u0026quot;child process is exited.\\n\u0026quot;); } //çˆ¶è¿›ç¨‹ else { printf(\u0026quot;I am father process.\\n\u0026quot;); //çˆ¶è¿›ç¨‹ç¡çœ 1sï¼Œä¿è¯å­è¿›ç¨‹è¾“å‡ºè¿›ç¨‹id sleep(1); printf(\u0026quot;father process is exited.\\n\u0026quot;); } return 0; } å¤§è‡´é€»è¾‘å°±æ˜¯è®©å­è¿›ç¨‹ç¡çœ æ›´é•¿çš„æ—¶é—´ï¼Œä»¥è¾¾åˆ°æ¯”çˆ¶è¿›ç¨‹åé€€å‡ºçš„æ•ˆæœï¼Œä»è€Œå˜æˆå­¤å„¿è¿›ç¨‹ã€‚\nè¿è¡Œç»“æœï¼š\n$ ./a.out I am father process. I am the child process. pid: 15625\tppid:15618 I will sleep five seconds. father process is exited. âœ justtest git:(master) âœ— pid: 15625\tppid:1 child process is exited. ä» pid: 15625 ppid:1 è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºå­è¿›ç¨‹è¢« init è¿›ç¨‹æ¥ç®¡äº†ï¼ˆinit è¿›ç¨‹çš„ pid ä¸º 1ï¼Œpid ä»£è¡¨å½“å‰è¿›ç¨‹çš„ idï¼Œppid ä»£è¡¨å½“å‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹çš„ idï¼‰ã€‚\nï¼ˆâœ justtest git:(master) âœ— pid: 15625\tppid:1 è¿™ä¸€è¡Œæ˜¯å› ä¸ºçˆ¶è¿›ç¨‹é€€å‡ºåï¼Œç»ˆç«¯ä¼šç»“æŸè¾“å‡ºï¼Œå˜æˆå¾…è¾“å…¥çŠ¶æ€ï¼Œæ‰€ä»¥ä¼šå‡ºç° justtest git:(master) âœ— è¿™éƒ¨åˆ†ï¼Œä½†æ˜¯ç­‰å‡ ç§’åå­è¿›ç¨‹åˆä¼šè¾“å‡º pid: 15625\tppid:1ï¼Œæ‰€ä»¥å°±å˜æˆäº†è¿™æ ·çš„æ˜¾ç¤ºæ•ˆæœã€‚è€Œä¸”åœ¨è¾“å‡ºäº† child process is exited. è¿™å¥è¯ä¹‹åç»ˆç«¯ä¼šå¡ä½ï¼Œæ­¤æ—¶åªéœ€è¦æŒ‰ä¸€ä¸‹å›è½¦å³å¯ã€‚ï¼‰\nåƒµå°¸è¿›ç¨‹æµ‹è¯•ç¨‹åº #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { pid_t pid; pid = fork(); if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } else if (pid == 0) { printf(\u0026quot;I am child process.I am exiting.\\n\u0026quot;); exit(0); } printf(\u0026quot;I am father process.I will sleep two seconds\\n\u0026quot;); //ç­‰å¾…å­è¿›ç¨‹å…ˆé€€å‡º sleep(2); //è¾“å‡ºè¿›ç¨‹ä¿¡æ¯ system(\u0026quot;ps -o pid,ppid,state,tty,command\u0026quot;); printf(\u0026quot;father process is exiting.\\n\u0026quot;); return 0; } è¿™æ®µç¨‹åºè®©å­è¿›ç¨‹å…ˆé€€å‡ºï¼ŒåŒæ—¶ä¸é€‚ç”¨ wait æˆ–è€… waitpid æ¥å›æ”¶ã€‚\nè¾“å‡ºï¼š\n./a.out I am father process.I will sleep two seconds I am child process.I am exiting. PID PPID STAT TTY COMMAND 7766 7750 S+ ttys000 -zsh 7771 7751 S ttys001 -zsh 91947 7771 S+ ttys001 ./a.out 91956 91947 Z+ ttys001 (a.out) # åƒµå°¸è¿›ç¨‹ å…¶ä¸­ STAT ä¸º Z+ çš„å°±æ˜¯åƒµå°¸è¿›ç¨‹\nåƒµå°¸è¿›ç¨‹æµ‹è¯•2 çˆ¶è¿›ç¨‹å¾ªç¯åˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹é€€å‡ºï¼Œé€ æˆå¤šä¸ªåƒµå°¸è¿›ç¨‹ï¼Œç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;errno.h\u0026gt; int main() { pid_t pid; //å¾ªç¯åˆ›å»ºå­è¿›ç¨‹ while(1) { pid = fork(); if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } else if (pid == 0) { printf(\u0026quot;I am a child process.\\nI am exiting.\\n\u0026quot;); //å­è¿›ç¨‹é€€å‡ºï¼Œæˆä¸ºåƒµå°¸è¿›ç¨‹ exit(0); } else { //çˆ¶è¿›ç¨‹ä¼‘çœ 20sç»§ç»­åˆ›å»ºå­è¿›ç¨‹ sleep(20); continue; } } return 0; } è¿è¡Œç»“æœï¼š\nåƒµå°¸è¿›ç¨‹è§£å†³æ–¹æ³• fork ä¸¤æ¬¡ #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;errno.h\u0026gt; int main() { pid_t pid; //åˆ›å»ºç¬¬ä¸€ä¸ªå­è¿›ç¨‹ pid = fork(); if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } //ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ else if (pid == 0) { //å­è¿›ç¨‹å†åˆ›å»ºå­è¿›ç¨‹ï¼ˆç¬¬äºŒä¸ªå­è¿›ç¨‹ï¼‰ printf(\u0026quot;I am the first child process.pid:%d\\tppid:%d\\n\u0026quot;,getpid(),getppid()); pid = fork(); if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } // è®©ç¬¬ä¸€ä¸ªå­è¿›ç¨‹é€€å‡º else if (pid \u0026gt; 0) { printf(\u0026quot;first procee is exited.\\n\u0026quot;); exit(0); } //ç¬¬äºŒä¸ªå­è¿›ç¨‹ //ç¡çœ 3sä¿è¯ç¬¬ä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºï¼Œè¿™æ ·ç¬¬äºŒä¸ªå­è¿›ç¨‹çš„çˆ¶äº²å°±æ˜¯initè¿›ç¨‹é‡Œ sleep(3); printf(\u0026quot;I am the second child process.pid: %d\\tppid:%d\\n\u0026quot;,getpid(),getppid()); exit(0); } //çˆ¶è¿›ç¨‹å¤„ç†ç¬¬ä¸€ä¸ªå­è¿›ç¨‹é€€å‡º if (waitpid(pid, NULL, 0) != pid) { perror(\u0026quot;waitepid error:\u0026quot;); exit(1); } exit(0); return 0; } å¤§è‡´æ€è·¯å°±æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå†è®©è¿™ä¸ªå­è¿›ç¨‹å†åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆä»£ç§°ä¸ºå­™å­è¿›ç¨‹ï¼‰ï¼Œç„¶åè®©å­è¿›ç¨‹ç«‹é©¬é€€å‡ºï¼Œè¿™æ ·å­™å­è¿›ç¨‹å°±ä¼šè¢« init æ¥ç®¡ã€‚ï¼ˆä½¿ç”¨å­™å­è¿›ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼‰\nä¿¡å· å­è¿›ç¨‹é€€å‡ºæ—¶å‘çˆ¶è¿›ç¨‹å‘é€SIGCHILDä¿¡å·ï¼Œçˆ¶è¿›ç¨‹å¤„ç†SIGCHILDä¿¡å·ã€‚åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨waitè¿›è¡Œå¤„ç†åƒµå°¸è¿›ç¨‹ã€‚æµ‹è¯•ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;signal.h\u0026gt; static void sig_child(int signo); int main() { pid_t pid; //åˆ›å»ºæ•æ‰å­è¿›ç¨‹é€€å‡ºä¿¡å· signal(SIGCHLD,sig_child); pid = fork(); if (pid \u0026lt; 0) { perror(\u0026quot;fork error:\u0026quot;); exit(1); } else if (pid == 0) { printf(\u0026quot;I am child process,pid id %d.I am exiting.\\n\u0026quot;,getpid()); exit(0); } printf(\u0026quot;I am father process.I will sleep two seconds\\n\u0026quot;); //ç­‰å¾…å­è¿›ç¨‹å…ˆé€€å‡º sleep(2); //è¾“å‡ºè¿›ç¨‹ä¿¡æ¯ system(\u0026quot;ps -o pid,ppid,state,tty,command\u0026quot;); printf(\u0026quot;father process is exiting.\\n\u0026quot;); return 0; } static void sig_child(int signo) { pid_t pid; int stat; //å¤„ç†åƒµå°¸è¿›ç¨‹ while ((pid = waitpid(-1, \u0026amp;stat, WNOHANG)) \u0026gt;0) printf(\u0026quot;child %d terminated.\\n\u0026quot;, pid); } ","date":"2022å¹´08æœˆ31æ—¥","permalink":"/posts/gu_er_jin_cheng_he_jiang_shi_jin_cheng/","summary":"æ¥æºï¼šhttps://www.cnblogs.com/Anker/p/3271773.html\nåŸºæœ¬æ¦‚å¿µ å­¤å„¿è¿›ç¨‹ï¼šä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹(è¿›ç¨‹å·ä¸º 1 )æ‰€æ”¶å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚","title":"å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹"},{"contents":"å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ å­˜åœ¨çš„é—®é¢˜ï¼š\næ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜å¤±è´¥\nå¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ï¼Œå¦‚ä¸‹ï¼ˆçºµè½´ä»£è¡¨æ—¶é—´çº¿ï¼‰ï¼š\nA B æ›´æ–° DB x = 1 æ›´æ–° DBï¼Œx = 2 æ›´æ–°ç¼“å­˜ï¼Œx = 2 æ›´æ–°ç¼“å­˜ï¼Œx = 1 å¯ä»¥çœ‹åˆ°å› ä¸ºå¹¶å‘æ“ä½œå¯¼è‡´ A æŠŠ B çš„æ›´æ–°ç¼“å­˜ç»“æœç»™è¦†ç›–äº†ï¼Œæœ€ç»ˆä½¿å¾—æ•°æ®åº“ç»“æœï¼ˆx = 2ï¼‰å’Œç¼“å­˜ç»“æœï¼ˆx = 1ï¼‰ä¸ä¸€è‡´\nå…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ å­˜åœ¨çš„é—®é¢˜ï¼š\nå’Œ å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–° ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚\nå…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ å­˜åœ¨çš„é—®é¢˜ï¼š\nåˆ é™¤ç¼“å­˜æˆåŠŸï¼Œæ›´æ–°æ•°æ®åº“å¤±è´¥\nå¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ï¼Œå¦‚ä¸‹ï¼ˆçºµè½´ä»£è¡¨æ—¶é—´çº¿ï¼‰ï¼š\nA B C åˆ ç¼“å­˜ è¯»ç¼“å­˜ï¼Œmiss è¯» DBï¼Œx = 1 å†™å…¥ç¼“å­˜ï¼Œx = 1 æ›´æ–° dbï¼Œx = 2 è¯»ç¼“å­˜ï¼Œx = 1ï¼Œä½†æ­¤æ—¶ db ä¸­ x = 2ï¼Œä¸ä¸€è‡´ å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ å­˜åœ¨çš„é—®é¢˜ï¼š\næ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥ å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ï¼Œå¦‚ä¸‹ï¼ˆçºµè½´ä»£è¡¨æ—¶é—´çº¿ï¼‰ï¼š A B è¯»ç¼“å­˜ï¼Œmiss è¯» DBï¼Œx = 1 æ›´æ–° DBï¼Œx = 2 åˆ é™¤ç¼“å­˜ å†™å…¥ç¼“å­˜ï¼Œx = 1 æ­¤æ—¶æ•°æ®åº“ä¸­çš„ x = 2ï¼Œä½†ç¼“å­˜ä¸­ x = 1ï¼Œå­˜åœ¨ä¸ä¸€è‡´\nä½†æ˜¯è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡éå¸¸ä½ï¼Œå› ä¸ºç¼“å­˜çš„å†™å…¥é€Ÿåº¦å¤§æ¦‚ç‡æ˜¯è¦å¿«äºæ•°æ®åº“çš„å†™å…¥é€Ÿåº¦çš„ï¼ˆä¸Šè¡¨ä¸­å°±æ˜¯å› ä¸ºæ›´æ–°æ•°æ®åº“æ“ä½œå¿«äºç¼“å­˜å†™å…¥æ“ä½œï¼Œæ‰å¯¼è‡´æœ€ç»ˆä¸ä¸€è‡´ï¼‰\nå»¶è¿ŸåŒåˆ  åŸºäº å…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“\nA B C åˆ ç¼“å­˜ è¯»ç¼“å­˜ï¼Œmiss è¯» DBï¼Œx = 1 å†™å…¥ç¼“å­˜ï¼Œx = 1 æ›´æ–° dbï¼Œx = 2ï¼ˆæ­¤æ—¶ç¼“å­˜å’Œ db ä¸ä¸€è‡´ï¼‰ å»¶è¿Ÿä¸€ä¼šï¼Œåˆ é™¤ç¼“å­˜ è¯»ç¼“å­˜ï¼Œmissï¼Œä» db è¯»å–å¹¶å†™å…¥ç¼“å­˜ï¼Œæ­¤æ—¶ä¸€è‡´ ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿä¸€ä¼šï¼Ÿ\nå¦‚æœä¸å»¶è¿Ÿè€Œæ˜¯æ›´æ–° db åç«‹é©¬åˆ é™¤ï¼Œå¯èƒ½å­˜åœ¨ä¸‹é¢çš„æƒ…å†µï¼š\nA B åˆ ç¼“å­˜ è¯»ç¼“å­˜ï¼Œmiss è¯» DBï¼Œx = 1 æ›´æ–° dbï¼Œx = 2 ç«‹é©¬åˆ é™¤ç¼“å­˜ å†™å…¥ç¼“å­˜ï¼Œx = 1 æœ€ç»ˆ db ä¸­çš„ x = 2ï¼Œè€Œç¼“å­˜ä¸­çš„ x = 1ï¼ŒäºŒè€…åˆä¸ä¸€è‡´äº†ã€‚å¦‚æœè®© A å»¶è¿Ÿä¸€ä¼šï¼Œç­‰åˆ° B å†™å®Œç¼“å­˜åå†åˆ ï¼Œå°±ä¸ä¼šå‡ºç°ä¸Šé¢çš„é—®é¢˜äº†ã€‚\nä½†é—®é¢˜æ¥äº†ï¼Œéœ€è¦å»¶è¿Ÿå¤šé•¿æ—¶é—´æ‰èƒ½è¾¾åˆ°å‰é¢æ‰€è¯´çš„æ•ˆæœå‘¢ï¼Ÿæ¯•ç«Ÿ B ä»€ä¹ˆæ—¶å€™èƒ½å†™å®Œç¼“å­˜å¯æ˜¯ä¸å¯é¢„æ–™çš„ï¼Œè€Œä¸”å¦‚æœå»¶è¿Ÿæ—¶é—´è®¾ç½®çš„è¿‡é•¿ï¼Œä¹Ÿä¼šå¯¼è‡´ç³»ç»Ÿçš„å»¶è¿Ÿå˜é«˜ã€‚\n","date":"2022å¹´08æœˆ27æ—¥","permalink":"/posts/huan_cun_yi_zhi_xing/","summary":"å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ å­˜åœ¨çš„é—®é¢˜ï¼š\næ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜å¤±è´¥\nå¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ï¼Œå¦‚ä¸‹ï¼ˆçºµè½´ä»£è¡¨æ—¶é—´çº¿ï¼‰ï¼š\nA B æ›´æ–° DB x = 1 æ›´æ–° DBï¼Œx = 2 æ›´æ–°ç¼“å­˜ï¼Œx = 2 æ›´æ–°ç¼“å­˜ï¼Œx = 1 å¯ä»¥çœ‹åˆ°å› ä¸ºå¹¶å‘æ“ä½œå¯¼è‡´ A æŠŠ B çš„æ›´æ–°ç¼“å­˜ç»“æœç»™è¦†ç›–äº†ï¼Œæœ€ç»ˆä½¿å¾—æ•°æ®åº“ç»“æœï¼ˆx = 2ï¼‰å’Œç¼“å­˜ç»“æœï¼ˆx = 1ï¼‰ä¸ä¸€è‡´","title":"å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§"},{"contents":"Goç›¸å…³ mapã€channelã€slice çš„åº•å±‚å®ç° map map ä½¿ç”¨çš„æ˜¯æ‹‰é“¾æ³•ï¼Œç”¨å“ˆå¸Œæ¡¶æ¥ä¿å­˜é”®å€¼å¯¹ï¼Œæ¯ä¸ªæ¡¶å¯ä»¥ä¿å­˜ 8 ä¸ªé”®å€¼å¯¹ï¼Œå®ƒä¼šç”¨å“ˆå¸Œç®—æ³•è®¡ç®—å‡º key çš„ hash å€¼ï¼Œç„¶åç”¨è¿™ä¸ªå“ˆå¸Œå€¼çš„é«˜ 8 ä½ä½œä¸º tophashï¼Œç”¨äºåœ¨ä¸€ä¸ªæ¡¶ä¸­åŒºåˆ«å‡º keyï¼Œç„¶åæ¡¶çš„æ•°é‡æ˜¯ 2^b ï¼Œç”¨ä½ b ä½æ¥å†³å®šè¿™ä¸ª key æ”¾åˆ°å“ªä¸ªæ¡¶ã€‚æ¯ä¸ªæ¡¶è¿˜ä¼šè¿æ¥ä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œå¦‚æœä¸€ä¸ªæ¡¶å·²ç»æ»¡äº†ï¼Œä½†æ˜¯ä¾ç„¶æœ‰ key è½å…¥åˆ°è¿™ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶æ”¾åˆ°æº¢å‡ºæ¡¶ä¸­ã€‚\nmap çš„é»˜è®¤è´Ÿè½½å› å­æ˜¯ 6.5ï¼Œè´Ÿè½½å› å­è¡¨ç¤ºçš„æ˜¯å½“å‰é”®å€¼å¯¹çš„æ•°é‡ / å½“å‰æ¡¶çš„æ•°é‡ï¼Œå¦‚æœ map çš„è´Ÿè½½å› å­è¾¾åˆ°äº† 6.5ï¼Œé‚£ä¹ˆå°±è¯´æ˜æ­¤æ—¶å¯èƒ½æ‰€æœ‰æ¡¶éƒ½å¿«è£…æ»¡äº†ï¼Œå¦‚æœå†æ·»åŠ é”®å€¼å¯¹ï¼Œå¤§æ¦‚ç‡ä¼šæ”¾åˆ°æº¢å‡ºæ¡¶ä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶å°±éœ€è¦è¿›è¡Œæ‰©å®¹äº†ï¼Œå¯¹åº”çš„æ‰©å®¹ç­–ç•¥æ˜¯ï¼šåˆ›å»ºæ•°é‡æ˜¯ä¹‹å‰æ¡¶çš„ 2 å€çš„æ–°æ¡¶ï¼Œç„¶åå°†æ—§æ¡¶ä¸­çš„å€¼è¿ç§»åˆ°æ–°æ¡¶ä¸­ï¼ˆè¿ç§»çš„ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿrehashï¼‰ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤šï¼Œå¯èƒ½çš„åŸå› æ˜¯é”®å€¼å¯¹æ•°é‡å°‘ï¼Œä½†è¿‡äºåˆ†æ•£ï¼Œå¯¼è‡´æ¡¶çš„æ•°é‡å¤šï¼Œè§£å†³åŠæ³•æ˜¯åˆ›å»ºåŒæ ·æ•°é‡çš„æ–°æ¡¶ï¼Œå°†æ—§æ¡¶ä¸­çš„æ•°æ®è¿ç§»åˆ°è¿™äº›æ–°æ¡¶ä¸­ï¼Œä½¿æ•´ä½“é”®å€¼å¯¹çš„æ’å¸ƒæ›´ç´§å‡‘ã€‚\næ­¤å¤– go map æ‰©å®¹é‡‡ç”¨çš„æ¸è¿›å¼æ‰©å®¹ï¼Œå½“æ‰§è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œæ—¶è¿›è¡Œå°éƒ¨åˆ†æ‰©å®¹ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ¡¶è¿›è¡Œè¿ç§»ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ¬è¿æ“ä½œå¯¹æ€§èƒ½çš„å½±å“ã€‚\nchannel channel åº•å±‚ä¸»è¦ç”±ä¸€ä¸ªå‘é€é˜»å¡é˜Ÿåˆ—å’Œä¸€ä¸ªæ¥æ”¶é˜»å¡é˜Ÿåˆ—ï¼Œä»¥åŠä¸€æŠŠäº’æ–¥é”ç»„æˆï¼Œå‘é€é˜»å¡é˜Ÿåˆ—å­˜å‚¨çš„æ˜¯å› ä¸ºå‘é€æ“ä½œè€Œè¢«é˜»å¡çš„ goroutineï¼Œæ¥æ”¶é˜»å¡é˜Ÿåˆ—åŒç†ï¼Œè¿™é‡Œé¢å­˜å‚¨çš„éƒ½æ˜¯è¢«æŒ‚èµ·çš„ goroutineï¼Œå½“æ‰§è¡Œå‘é€æ“ä½œæ—¶ï¼Œä¼šå…ˆæ£€æŸ¥æ¥æ”¶é˜»å¡é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰å€¼ï¼Œæœ‰çš„è¯ä»é˜Ÿå¤´å–å‡ºï¼Œå¹¶å°†è¿™ä¸ª goroutine å”¤é†’ï¼Œå¹¶å°†æ•°æ®æ‹·è´ç»™å®ƒï¼Œæ‰§è¡Œæ¥æ”¶æ“ä½œåŒç†ã€‚äº’æ–¥é”ç”¨æ¥ä¿è¯ chan çš„çº¿ç¨‹å®‰å…¨ã€‚æ­¤å¤–å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ chanï¼Œè¿˜ä¼šå­˜åœ¨ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œ\nsync.mapã€sync.poolã€sync.Onceçš„åŸç† GCçš„è¿‡ç¨‹ã€å†™å±éšœçš„å«ä¹‰åŠä½œç”¨ GMP æ¨¡å‹ï¼Œè§¦å‘ Goroutine åˆ‡æ¢çš„åŸå› æœ‰å“ªäº›ï¼Ÿfor æ­»å¾ªç¯ä¼šæ€ä¹ˆæ ·ï¼Ÿå…¨å±€ goroutine é‡Œé¢å­˜å‚¨ä»€ä¹ˆï¼Ÿ interface çš„åº•å±‚å®ç°ï¼Œæ€ä¹ˆåˆ¤ç©ºï¼Ÿ reflect çš„ä½¿ç”¨ é€ƒé€¸åˆ†æ contextçš„ä½¿ç”¨ go æ€§èƒ½é—®é¢˜çš„å®šä½è¿‡ç¨‹ï¼ˆpprofçš„ä½¿ç”¨ï¼‰ åç¨‹æ± çš„ä½¿ç”¨ Redisç›¸å…³ redisçš„æ•°æ®ç±»å‹ä»¥åŠæ—¥å¸¸çš„åº”ç”¨ string å­—ç¬¦ä¸²ç±»å‹ hashmap å“ˆå¸Œè¡¨ list åŒå‘é“¾è¡¨ set å»é‡é›†åˆ zset æ’åº set redisçš„å‘å¸ƒ/è®¢é˜…çš„åŸç† zsetçš„åº•å±‚å®ç° zset åº•å±‚ä½¿ç”¨è·³è¡¨ + å“ˆå¸Œè¡¨å®ç°ï¼Œ\næ•°æ®ç¼“å­˜è¿‡æœŸç­–ç•¥ redisçš„éƒ¨ç½²æ¨¡å¼ redisä¸ºä»€ä¹ˆé€Ÿåº¦æ¯”è¾ƒå¿« reidsçš„å¤§keyã€çƒ­keyçš„å¤„ç† å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”çš„ æŒä¹…åŒ–ç­–ç•¥åŠå…¶å¯¹æ¯” ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€ ","date":"2022å¹´08æœˆ18æ—¥","permalink":"/posts/mian_shi_ti_shou_ji1/","summary":"Goç›¸å…³ mapã€channelã€slice çš„åº•å±‚å®ç° map map ä½¿ç”¨çš„æ˜¯æ‹‰é“¾æ³•ï¼Œç”¨å“ˆå¸Œæ¡¶æ¥ä¿å­˜é”®å€¼å¯¹ï¼Œæ¯ä¸ªæ¡¶å¯ä»¥ä¿å­˜ 8 ä¸ªé”®å€¼å¯¹ï¼Œå®ƒä¼šç”¨å“ˆå¸Œç®—æ³•è®¡ç®—å‡º key çš„ hash å€¼ï¼Œç„¶åç”¨è¿™ä¸ªå“ˆå¸Œå€¼çš„é«˜ 8 ä½ä½œä¸º tophashï¼Œç”¨äºåœ¨ä¸€ä¸ªæ¡¶ä¸­åŒºåˆ«å‡º keyï¼Œç„¶åæ¡¶çš„æ•°é‡æ˜¯ 2^b ï¼Œç”¨ä½ b ä½æ¥å†³å®šè¿™ä¸ª key æ”¾åˆ°å“ªä¸ªæ¡¶ã€‚æ¯ä¸ªæ¡¶è¿˜ä¼šè¿æ¥ä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œå¦‚æœä¸€ä¸ªæ¡¶å·²ç»æ»¡äº†ï¼Œä½†æ˜¯ä¾ç„¶æœ‰ key è½å…¥åˆ°è¿™ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶æ”¾åˆ°æº¢å‡ºæ¡¶ä¸­ã€‚","title":"é¢è¯•é¢˜æ”¶é›† 1"},{"contents":"é¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªé—®é¢˜ï¼š\n347. å‰ K ä¸ªé«˜é¢‘å…ƒç´  ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•° k ï¼Œè¯·ä½ è¿”å›å…¶ä¸­å‡ºç°é¢‘ç‡å‰ k é«˜çš„å…ƒç´ ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: nums = [1,1,1,2,2,3], k = 2 è¾“å‡º: [1,2]\nç¤ºä¾‹ 2:\nè¾“å…¥: nums = [1], k = 1 è¾“å‡º: [1]\næç¤ºï¼š\n1 \u0026lt;= nums.length \u0026lt;= 105 k çš„å–å€¼èŒƒå›´æ˜¯ [1, æ•°ç»„ä¸­ä¸ç›¸åŒçš„å…ƒç´ çš„ä¸ªæ•°] é¢˜ç›®æ•°æ®ä¿è¯ç­”æ¡ˆå”¯ä¸€ï¼Œæ¢å¥è¯è¯´ï¼Œæ•°ç»„ä¸­å‰ k ä¸ªé«˜é¢‘å…ƒç´ çš„é›†åˆæ˜¯å”¯ä¸€çš„\nè¿›é˜¶ï¼šä½ æ‰€è®¾è®¡ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ å¿…é¡» ä¼˜äº O(n log n) ï¼Œå…¶ä¸­ n æ˜¯æ•°ç»„å¤§å°ã€‚\n692. å‰ K ä¸ªé«˜é¢‘å•è¯ ç»™å®šä¸€ä¸ªå•è¯åˆ—è¡¨ words å’Œä¸€ä¸ªæ•´æ•° k ï¼Œè¿”å›å‰ k ä¸ªå‡ºç°æ¬¡æ•°æœ€å¤šçš„å•è¯ã€‚\nè¿”å›çš„ç­”æ¡ˆåº”è¯¥æŒ‰å•è¯å‡ºç°é¢‘ç‡ç”±é«˜åˆ°ä½æ’åºã€‚å¦‚æœä¸åŒçš„å•è¯æœ‰ç›¸åŒå‡ºç°é¢‘ç‡ï¼Œ æŒ‰å­—å…¸é¡ºåº æ’åºã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥: words = [\u0026ldquo;i\u0026rdquo;, \u0026ldquo;love\u0026rdquo;, \u0026ldquo;leetcode\u0026rdquo;, \u0026ldquo;i\u0026rdquo;, \u0026ldquo;love\u0026rdquo;, \u0026ldquo;coding\u0026rdquo;], k = 2 è¾“å‡º: [\u0026ldquo;i\u0026rdquo;, \u0026ldquo;love\u0026rdquo;] è§£æ: \u0026ldquo;i\u0026rdquo; å’Œ \u0026ldquo;love\u0026rdquo; ä¸ºå‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¸¤ä¸ªå•è¯ï¼Œå‡ä¸º2æ¬¡ã€‚ æ³¨æ„ï¼ŒæŒ‰å­—æ¯é¡ºåº \u0026ldquo;i\u0026rdquo; åœ¨ \u0026ldquo;love\u0026rdquo; ä¹‹å‰ã€‚\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥: [\u0026ldquo;the\u0026rdquo;, \u0026ldquo;day\u0026rdquo;, \u0026ldquo;is\u0026rdquo;, \u0026ldquo;sunny\u0026rdquo;, \u0026ldquo;the\u0026rdquo;, \u0026ldquo;the\u0026rdquo;, \u0026ldquo;the\u0026rdquo;, \u0026ldquo;sunny\u0026rdquo;, \u0026ldquo;is\u0026rdquo;, \u0026ldquo;is\u0026rdquo;], k = 4 è¾“å‡º: [\u0026ldquo;the\u0026rdquo;, \u0026ldquo;is\u0026rdquo;, \u0026ldquo;sunny\u0026rdquo;, \u0026ldquo;day\u0026rdquo;] è§£æ: \u0026ldquo;the\u0026rdquo;, \u0026ldquo;is\u0026rdquo;, \u0026ldquo;sunny\u0026rdquo; å’Œ \u0026ldquo;day\u0026rdquo; æ˜¯å‡ºç°æ¬¡æ•°æœ€å¤šçš„å››ä¸ªå•è¯ï¼Œ å‡ºç°æ¬¡æ•°ä¾æ¬¡ä¸º 4, 3, 2 å’Œ 1 æ¬¡ã€‚\næ³¨æ„ï¼š\n1 \u0026lt;= words.length \u0026lt;= 500 1 \u0026lt;= words[i] \u0026lt;= 10 words[i] ç”±å°å†™è‹±æ–‡å­—æ¯ç»„æˆã€‚ k çš„å–å€¼èŒƒå›´æ˜¯ [1, ä¸åŒ words[i] çš„æ•°é‡]\nè¿›é˜¶ï¼šå°è¯•ä»¥ O(n log k) æ—¶é—´å¤æ‚åº¦å’Œ O(n) ç©ºé—´å¤æ‚åº¦è§£å†³ã€‚\nå‘ç°è¿™ä¸¤ä¸ªé—®é¢˜æœ‰ç‚¹ç±»ä¼¼ï¼ˆä»åå­—éƒ½èƒ½çœ‹å‡ºæ¥ï¼‰ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯ä» int æ•°ç»„é‡Œæ‰¾ï¼Œä¸”ç»“æœå¯¹é¡ºåºæ²¡æœ‰è¦æ±‚ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰ä¸¤ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ç›¸åŒï¼Œé‚£ä¹ˆä¸éœ€è¦è€ƒè™‘å®ƒä»¬çš„é¡ºåºé—®é¢˜ï¼Œè°å‰è°åéƒ½å¯ä»¥ï¼‰ï¼›å¦ä¸€ä¸ªæ˜¯ä» string æ•°ç»„é‡Œæ‰¾ï¼Œå¦‚æœä¸¤ä¸ªå•è¯å‡ºç°æ¬¡æ•°ç›¸åŒï¼Œé‚£ä¹ˆéœ€è¦æŒ‰å­—å…¸åºè¿›è¡Œæ’åºï¼Œæ¯”å¦‚ a å’Œ b éƒ½å‡ºç°äº† 10 æ¬¡ï¼Œé‚£ä¹ˆ a è¦æ’åœ¨å‰é¢ã€‚\nåƒè¿™ç§ topk é—®é¢˜ï¼Œè²Œä¼¼éƒ½å¯ä»¥ä½¿ç”¨ å † æ¥è§£å†³ï¼Œå¤§è‡´é€»è¾‘æ˜¯ï¼šç”¨æœ€å°å †æ¥è§£å†³ï¼Œå»ºä¸€ä¸ªå¤§å°ä¸º K çš„å †ï¼Œç„¶åéå†æ•°ç»„ï¼Œå¦‚æœå½“å‰å †çš„å…ƒç´ ä¸åˆ° K ä¸ªï¼Œåˆ™ç›´æ¥å°†å…ƒç´ æ·»åŠ åˆ°å †ä¸­ï¼Œå¦‚æœå †çš„å…ƒç´  \u0026gt;= Kï¼Œæ­¤æ—¶å †é¡¶ä¿å­˜çš„æ˜¯æ•´ä¸ªå †ä¸­æœ€å°çš„å…ƒç´ ï¼Œé‚£ä¹ˆå°±æ¯”è¾ƒå½“å‰å…ƒç´ æ˜¯å¦å°äºå †é¡¶ï¼Œå¦‚æœæ¯”å †é¡¶è¿˜å°ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡ï¼Œå¦‚æœå¤§äºå †é¡¶ï¼Œé‚£ä¹ˆå¯ä»¥å°†å †é¡¶è¿™ä¸ªæœ€å°çš„å…ƒç´  pop æ‰ï¼Œç„¶åæŠŠ push å½“å‰å…ƒç´ ï¼Œå› ä¸ºå †ä¼šè‡ªåŠ¨è°ƒæ•´ç»“æ„ï¼Œæ‰€ä»¥ push åå †é¡¶ä¾ç„¶æ˜¯æ•´ä¸ªå †ä¸­æœ€å°çš„å…ƒç´ ã€‚å½“æ•°ç»„éå†å®Œåï¼Œæ•´ä¸ªå †ä¸­ä¿å­˜çš„å°±æ˜¯æœ€å¤§çš„ K ä¸ªå…ƒç´ ã€‚\nä»¥ä¸Šåªæ˜¯å¤§è‡´çš„é€»è¾‘ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œåªæ˜¯æ¯”è¾ƒçš„è§„åˆ™éœ€è¦è°ƒæ•´ä¸€ä¸‹ï¼ŒæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘å†™ä¸€ä¸‹è¿™ä¸¤é“é¢˜ã€‚\n347 ä»£ç  type myheap struct { s []int mp map[int]int } func (m myheap) Swap(i, j int) { m.s[i], m.s[j] = m.s[j], m.s[i] } func (m myheap) Len() int { return len(m.s) } func (m myheap) Less(i, j int) bool { return m.mp[m.s[i]] \u0026lt; m.mp[m.s[j]] } func (m *myheap) Push(x interface{}) { m.s = append(m.s, x.(int)) } func (m *myheap) Pop() interface{} { p := m.s[len(m.s)-1] m.s = m.s[:len(m.s)-1] return p } func topKFrequent(nums []int, k int) (res []int) { h := \u0026amp;myheap{mp : make(map[int]int)} for _, v := range nums { h.mp[v]++ } for v := range h.mp { if h.Len() \u0026lt; k { heap.Push(h, v) } else { if h.mp[h.s[0]] \u0026lt; h.mp[v] { heap.Pop(h) heap.Push(h, v) } } } return h.s } ï¼ˆä¸å¾—ä¸åæ§½ä¸€ä¸‹ go çš„å®¹å™¨åº“ï¼Œå®åœ¨å¤ªè›‹ç–¼äº†ï¼Œæ²¡æœ‰æ³›å‹å°±ç®—äº†ï¼Œåªæä¾›ä¸€ä¸ªæœ€åŸºæœ¬çš„ heapï¼Œéœ€è¦è‡ªå·±å®ç° 2 ä¸ªæ¥å£ 5 ä¸ªæ–¹æ³•ï¼Œå†™èµ·æ¥å®åœ¨ç¹çï¼Œä¸åƒå…¶ä»–è¯­è¨€çš„ä¼˜å…ˆé˜Ÿåˆ—ç”¨èµ·æ¥é‚£ä¹ˆæ–¹ä¾¿ ï¼‰\nå› ä¸ºé¢˜ç›®è¦æ±‚çš„æ˜¯å‡ºç°æ¬¡æ•°ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ª map æ¥ä¿å­˜æ‰€æœ‰å…ƒç´ çš„å‡ºç°æ¬¡æ•°ï¼Œç„¶ååŸºäºè¿™ä¸ª map æ¥è¿›è¡Œæ¯”è¾ƒï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Less() è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å®ç°é€»è¾‘æ˜¯ return m.mp[m.s[i]] \u0026lt; m.mp[m.s[j]]ï¼Œä¹Ÿå°±æ˜¯åŸºäºå…ƒç´ çš„å‡ºç°æ¬¡æ•°æ¥ä½œä¸ºå †çš„æ¯”è¾ƒä¾æ®ï¼›è¿˜æœ‰å½“å‰å…ƒç´ å’Œå †é¡¶çš„æ¯”è¾ƒé€»è¾‘ h.mp[h.s[0]] \u0026lt; h.mp[v] ä¹Ÿæ˜¯åŸºäºå…ƒç´ çš„å‡ºç°æ¬¡æ•°è¿›è¡Œæ¯”è¾ƒã€‚é™¤äº†è¿™ä¸¤ç‚¹ä»¥å¤–ï¼ŒåŸºæœ¬å’Œä¹‹å‰çš„é€šç”¨é€»è¾‘ç›¸ä¼¼ã€‚\n692 ä»£ç  type myheap struct { s []string mp map[string]int } func (m myheap) Swap(i, j int) { m.s[i], m.s[j] = m.s[j], m.s[i] } func (m myheap) Len() int { return len(m.s) } func (m myheap) Less(i, j int) (res bool) { o1 := m.s[i] o2 := m.s[j] m1 := m.mp[o1] m2 := m.mp[o2] if m1 == m2 { return o1 \u0026gt; o2 // å¦‚æœå‡ºç°é¢‘ç‡ç›¸åŒï¼ŒæŒ‰å­—å…¸åºæ’åˆ— } return m1 \u0026lt; m2 } func (m *myheap) Push(x interface{}) { m.s = append(m.s, x.(string)) } func (m *myheap) Pop() interface{} { p := m.s[len(m.s)-1] m.s = m.s[:len(m.s)-1] return p } func topKFrequent(words []string, k int) (res []string) { m := \u0026amp;myheap{ mp: make(map[string]int), } for _, v := range words { m.mp[v]++ } for v := range m.mp { if m.Len() \u0026lt; k { heap.Push(m, v) } else { if (m.mp[v] == m.mp[m.s[0]] \u0026amp;\u0026amp; v \u0026lt; m.s[0]) || m.mp[v] \u0026gt; m.mp[m.s[0]] { heap.Pop(m) heap.Push(m, v) } } } res = make([]string, m.Len()) for i := k; i \u0026gt; 0; i-- { res[i-1] = heap.Pop(m).(string) } //for i := 0; i \u0026lt; k; i++ { // res = append(res, heap.Pop(m).(string)) //} // å› ä¸ºæ˜¯å°é¡¶å †ï¼Œå †é¡¶ä¸ºå‡ºç°æ¬¡æ•°æœ€å°çš„ï¼Œè€Œé¢˜ç›®è¦æ±‚æ¬¡æ•°å¤šçš„æ’åœ¨å‰é¢ï¼Œæ‰€ä»¥éœ€è¦åè½¬ç»“æœ //for i, j := 0, len(res)-1; i \u0026lt; j; i++ { // res[i], res[j] = res[j], res[i] // j-- //} return } è¿™é“é¢˜ç›¸æ¯” 347 è¦éº»çƒ¦ä¸€äº›ï¼Œå½“æ—¶å†™çš„æ—¶å€™æœ‰ä¸€ä¸ªæ¯”è¾ƒè¿·çš„åœ°æ–¹ï¼Œå°±æ˜¯ Less() é‡Œçš„åˆ¤æ–­é€»è¾‘ï¼š\no1 := m.s[i] o2 := m.s[j] m1 := m.mp[o1] m2 := m.mp[o2] if m1 == m2 { return o1 \u0026gt; o2 // å¦‚æœå‡ºç°é¢‘ç‡ç›¸åŒï¼ŒæŒ‰å­—å…¸åºæ’åˆ— } å½“æ—¶æ²¡ææ‡‚ä¸ºä»€ä¹ˆæ˜¯ o1 \u0026gt; o2ï¼Œå…¶å®è¿™é‡Œéœ€è¦ç†è§£ go heap çš„åº•å±‚å®ç°ï¼ŒLess() æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦äº¤æ¢å…ƒç´ çš„ï¼Œå¦‚æœ Less è¿”å› true æ‰éœ€è¦äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ o1 \u0026gt; o2ï¼ˆè¿™æ˜¯ä¸¤ä¸ª stringï¼Œä¸” o1 å¯¹åº”ä¸‹æ ‡ iï¼Œo2 å¯¹åº”ä¸‹æ ‡ jï¼Œè¿™é‡Œå‡è®¾ i åœ¨å‰ï¼Œj åœ¨åï¼‰ï¼Œé‚£ä¹ˆæŒ‰ç…§å­—å…¸åºæ’åˆ—ï¼Œåº”è¯¥æ˜¯å°åœ¨å‰å¤§åœ¨åï¼ˆä¹Ÿå°±æ˜¯ i å¯¹åº”çš„å…ƒç´ è¦å°äº j å¯¹åº”çš„å…ƒç´ ï¼‰ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œäº¤æ¢ï¼ŒæŠŠå°çš„ o2 æ¢åˆ°å‰é¢ï¼Œå¤§çš„ o1 æ¢åˆ°åé¢ã€‚\næ­¤å¤–è¿˜æœ‰å’Œå †é¡¶æ¯”è¾ƒçš„é€»è¾‘ï¼š\nif (m.mp[v] == m.mp[m.s[0]] \u0026amp;\u0026amp; v \u0026lt; m.s[0]) || m.mp[v] \u0026gt; m.mp[m.s[0]] è¿™é‡Œä¸ºä»€ä¹ˆåˆæ˜¯ v \u0026lt; m.s[0]) å‘¢ï¼Ÿè¿˜æ˜¯å› ä¸ºå­—å…¸åºã€‚æ¯”å¦‚ [\u0026ldquo;i\u0026rdquo;,\u0026ldquo;love\u0026rdquo;,\u0026ldquo;leetcode\u0026rdquo;,\u0026ldquo;i\u0026rdquo;,\u0026ldquo;love\u0026rdquo;,\u0026ldquo;coding\u0026rdquo;]ï¼Œk=3 è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯[\u0026ldquo;i\u0026rdquo;,\u0026ldquo;love\u0026rdquo;,\u0026ldquo;coding\u0026rdquo;]ï¼Œleetcode å’Œ coding éƒ½å‡ºç°äº† 1 æ¬¡ï¼Œæ‰€ä»¥è¦æ¯”è¾ƒå®ƒä»¬çš„å­—å…¸åºï¼Œè€Œ coding \u0026lt; leetcodeï¼Œæ‰€ä»¥é€‰æ‹© coding è¿™ä¸ªè¾ƒå°çš„ã€‚å¯¹åº”åˆ°å †ï¼Œå¦‚æœæ­¤æ—¶å †é¡¶ä¸º leetcodeï¼Œç°åœ¨è¦æ·»åŠ  coding åˆ°å †ä¸­ï¼Œéœ€è¦åˆ¤æ–­é€»è¾‘ä¸ºï¼šåœ¨å‡ºç°æ¬¡æ•°ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå¦‚æœå½“å‰å…ƒç´ çš„å­—å…¸åºå°äºå †é¡¶ï¼Œåˆ™ pop å †é¡¶ï¼Œå¹¶ push å½“å‰å…ƒç´ ï¼Œè¿™æ ·æ‰èƒ½è®©è¿™ä¸ªè¾ƒå°çš„å…ƒç´ å…¥å †ã€‚\næ­¤å¤–ï¼Œå› ä¸ºé¢˜ç›®è¦æ±‚è¿”å›çš„ç­”æ¡ˆæŒ‰å•è¯å‡ºç°é¢‘ç‡ç”±é«˜åˆ°ä½æ’åºï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½åƒ 347 é‚£æ ·ï¼Œç›´æ¥æŠŠå †ä¸­çš„å…ƒç´ è¿”å›ï¼Œå› ä¸ºå †æ˜¯ä¸ä¿è¯æ•´ä½“æœ‰åºçš„ï¼Œå®ƒåªä¿è¯ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½å°äºï¼ˆå¤§äºï¼‰çˆ¶èŠ‚ç‚¹ï¼Œé‚£å¦‚ä½•è®©å…¶æœ‰åºå‘¢ï¼Ÿåªéœ€è¦ä¸æ–­ pop å³å¯ï¼Œè¿™é‡Œ go heap çš„ pop æ¥å£å®ç°çœ‹èµ·æ¥æœ‰ç‚¹è¯¡å¼‚ï¼š\nfunc (m *myheap) Pop() interface{} { p := m.s[len(m.s)-1] m.s = m.s[:len(m.s)-1] return p } çœ‹åˆ°è¿™é‡Œéš¾å…ä¼šæœ‰ç‚¹çº³é—·ï¼Œæˆ‘æ˜æ˜æ˜¯è¦ pop å †é¡¶å…ƒç´ ï¼Œä¸åº”è¯¥æ˜¯ç§»é™¤ m.s[0] æ‰å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œè¦ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ ï¼Ÿè¿™é‡Œåˆå¾—çœ‹æºç äº†ï¼š\nfunc Pop(h Interface) any { n := h.Len() - 1 h.Swap(0, n) down(h, 0, n) return h.Pop() } è¿™ä¸‹æ˜ç™½äº†ï¼ŒåŸæ¥åº•å±‚å®ç°ä¼šå°†å †é¡¶æ¢åˆ°å †å°¾ï¼Œæ‰€ä»¥æ‰éœ€è¦ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ ã€‚åŒæ—¶ä¹ŸçŸ¥é“äº†ï¼Œåœ¨äº¤æ¢å †é¡¶åˆ°å †å°¾åï¼Œä¼šä»å †é¡¶å¼€å§‹ï¼Œæ‰§è¡Œ down æ“ä½œï¼Œè°ƒæ•´æ•´ä½“çš„å †ï¼Œè®©å †é¡¶ç»§ç»­æ˜¯æ•´ä¸ªå †ä¸­æœ€å°çš„å…ƒç´ ï¼ˆä¼šå¿½ç•¥æœ«å°¾å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšè¢«æ¢åˆ°æœ«å°¾çš„é‚£ä¸ªæœ€å°çš„å…ƒç´ ï¼‰ï¼Œæ‰€ä»¥æ¯æ¬¡ pop éƒ½æ˜¯å½“å‰å †ä¸­æœ€å°çš„é‚£ä¸ªå…ƒç´ ï¼Œè¿›è€Œä¿è¯æœ‰åºã€‚\nä»£ç é‡Œå°† pop çš„å…ƒç´ ä¿å­˜åˆ°ä¸€ä¸ª slice é‡Œé¢ï¼Œå› ä¸ºæ˜¯å°é¡¶å †ï¼Œæ‰€ä»¥ pop çš„å…ƒç´ æ˜¯ç”±å°åˆ°å¤§çš„ï¼Œè€Œè¿™ä¸æ»¡è¶³é¢˜ç›® â€œç”±å¤§åˆ°å°â€ çš„è¦æ±‚ï¼Œéœ€è¦å°† slice ç¿»è½¬ï¼Œå˜æˆé™åºæ’åˆ—ã€‚å…¶å®è¿™é‡Œç”¨ä¸€ä¸ªé“¾è¡¨ä¿å­˜æ›´åˆç†ï¼Œæ¯æ¬¡ pop å¾€é“¾è¡¨å¤´éƒ¨æ·»åŠ å³å¯ï¼Œå¦‚æœæ˜¯ slice çš„è¯ï¼Œæ¯æ¬¡éƒ½å¾€å¤´éƒ¨æ·»åŠ ä¼šå¯¼è‡´å¼€é”€ç‰¹åˆ«å¤§ï¼ˆé¢‘ç¹çš„åˆ†é…æ‹·è´ï¼Œæ•ˆç‡è¿˜ä¸å¦‚æ•´ä½“ç¿»è½¬ï¼‰ï¼Œä½†æ˜¯é¢˜ç›®ç»™çš„å®šä¹‰æ˜¯è¿”å›ä¸€ä¸ª sliceï¼Œä¹Ÿåªèƒ½è¿™ä¹ˆåšäº†ï¼ˆjava ç‰ˆæœ¬çš„é¢˜ç›®å®šä¹‰è¿”å›çš„å°±æ˜¯ä¸€ä¸ª linkedlistï¼‰ã€‚ è€Œé¢˜ç›®è¦æ±‚çš„æ˜¯ç”±å¤§åˆ°å°ï¼Œåªéœ€è¦å…ˆé¢„åˆ†é… slice çš„ç©ºé—´ä¸ºå †çš„é•¿åº¦ï¼Œç„¶åä»å°¾éƒ¨å‘å¤´éƒ¨æ·»åŠ å°±å¯ä»¥äº†ã€‚\nå¦ä¸€ç§æ¨¡æ¿ çœ‹äº†ä¸€äº›é¢˜è§£ï¼Œå‘ç°ä»–ä»¬çš„å†™æ³•ç•¥æœ‰ä¸åŒï¼Œä¸»è¦æ˜¯åœ¨æ·»åŠ åˆ°å †çš„é€»è¾‘è¿™é‡Œï¼Œä¸éœ€è¦å’Œå †é¡¶å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œè€Œæ˜¯å…ˆ push è¿›å»ï¼Œå¦‚æœå‘ç°é•¿åº¦å¤§äº K äº†ï¼Œåˆ™æ‰§è¡Œ popï¼Œæ„Ÿè§‰è¿™ç§å†™æ³•çš„ä»£ç ä¼šæ¯”è¾ƒç®€æ´æ˜äº†å®¹æ˜“ç†è§£ï¼Œä½†æ˜¯å¯èƒ½æ•ˆç‡ä¼šä½ä¸€äº›ï¼Œåƒä¹‹å‰çš„é€»è¾‘ä¼šå’Œå †é¡¶è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸æ»¡è¶³æŸäº›æ¡ä»¶ä¼šç›´æ¥è·³è¿‡ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œè€Œè¿™é‡Œçš„é€»è¾‘æ˜¯éå†çš„æ¯ä¸ªå…ƒç´ éƒ½å…ˆæ— è„‘ push è¿›å»ï¼Œpush è¿˜éœ€è¦æ‰§è¡Œå †çš„è°ƒæ•´æ“ä½œï¼Œæ‰€ä»¥ç›¸æ¯”å«è€Œè¨€ä¼šå¤šåšä¸€äº›æ— ç”¨åŠŸã€‚\n692 type myheap struct { s []string mp map[string]int } func (m myheap) Swap(i, j int) { m.s[i], m.s[j] = m.s[j], m.s[i] } func (m myheap) Len() int { return len(m.s) } func (m myheap) Less(i, j int) bool { o1 := m.s[i] o2 := m.s[j] m1 := m.mp[o1] m2 := m.mp[o2] if m1 == m2 { return o1 \u0026gt; o2 // å¦‚æœå‡ºç°é¢‘ç‡ç›¸åŒï¼ŒæŒ‰å­—å…¸åºæ’åˆ— } return m1 \u0026lt; m2 } func (m *myheap) Push(x interface{}) { m.s = append(m.s, x.(string)) } func (m *myheap) Pop() interface{} { p := m.s[len(m.s)-1] m.s = m.s[:len(m.s)-1] return p } func topKFrequent(words []string, k int) (res []string) { m := \u0026amp;myheap{ mp: make(map[string]int), } for _, v := range words { m.mp[v]++ } for v := range m.mp { heap.Push(m, v) if m.Len() \u0026gt; k { heap.Pop(m) } } res = make([]string, m.Len()) for i := k; i \u0026gt; 0; i-- { res[i-1] = heap.Pop(m).(string) } return } ä¸å¾—ä¸è¯´ç¡®å®ç®€æ´å¾ˆå¤šï¼Œä¸»è¦æ˜¯ range m.mp è¿™é‡Œçš„é€»è¾‘ï¼Œå¯¹æ¯”ä¸€ä¸‹ï¼š\n// ç¬¬ä¸€ç§å†™æ³• for v := range m.mp { if m.Len() \u0026lt; k { heap.Push(m, v) } else { if (m.mp[v] == m.mp[m.s[0]] \u0026amp;\u0026amp; v \u0026lt; m.s[0]) || m.mp[v] \u0026gt; m.mp[m.s[0]] { heap.Pop(m) heap.Push(m, v) } } } // ç¬¬äºŒç§å†™æ³• for v := range m.mp { heap.Push(m, v) if m.Len() \u0026gt; k { heap.Pop(m) } } 347 type myheap struct { s []int mp map[int]int } func (m myheap) Swap(i, j int) { m.s[i], m.s[j] = m.s[j], m.s[i] } func (m myheap) Len() int { return len(m.s) } func (m myheap) Less(i, j int) bool { return m.mp[m.s[i]] \u0026lt; m.mp[m.s[j]] } func (m *myheap) Push(x interface{}) { m.s = append(m.s, x.(int)) } func (m *myheap) Pop() interface{} { p := m.s[len(m.s)-1] m.s = m.s[:len(m.s)-1] return p } func topKFrequent(nums []int, k int) (res []int) { h := \u0026amp;myheap{mp : make(map[int]int)} for _, v := range nums { h.mp[v]++ } for v := range h.mp { heap.Push(h, v) if h.Len() \u0026gt; k { heap.Pop(h) } } return h.s } ","date":"2022å¹´08æœˆ17æ—¥","permalink":"/posts/leetcode_347_and_692/","summary":"é¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªé—®é¢˜ï¼š\n347. å‰ K ä¸ªé«˜é¢‘å…ƒç´  ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•° k ï¼Œè¯·ä½ è¿”å›å…¶ä¸­å‡ºç°é¢‘ç‡å‰ k é«˜çš„å…ƒç´ ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚","title":"ä¸¤ä¸ªç±»ä¼¼çš„å †é—®é¢˜ï¼šleetcode 347 å‰ K ä¸ªé«˜é¢‘å…ƒç´  å’Œ 692. å‰ K ä¸ªé«˜é¢‘å•è¯ "},{"contents":"ä¸€ä¸ªç¤ºä¾‹ demoï¼š\npackage main import ( \u0026quot;bytes\u0026quot; \u0026quot;encoding/binary\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; ) type I interface { Do() } type S struct { Id int64 Name [10]byte } func (s *S) Do() { fmt.Println(\u0026quot;Do\u0026quot;) } var _ I = \u0026amp;S{} func write(b io.Writer, i I) { if err := binary.Write(b, binary.BigEndian, i); err != nil { panic(err) } } func read(b io.Reader, i I) { if err := binary.Read(b, binary.BigEndian, i); err != nil { panic(err) } } func main() { var ( buf = new(bytes.Buffer) //_buf = make([]byte, 4096) //buf = bytes.NewBuffer(_buf) è¿™æ ·å†™ä¼šå¯¼è‡´æ— æ³• read å‡ºæ•°æ®ï¼ŒåŸå› æœªçŸ¥ s = \u0026amp;S{ Id: 10001, Name: [10]byte{'a', 'b', 'c'}, } s_ = \u0026amp;S{} ) write(buf, s) read(buf, s_) fmt.Println(s_) s_.Do() } è¿è¡Œç»“æœï¼š\n\u0026amp;{10001 [97 98 99 0 0 0 0 0 0 0]} Do æ³¨æ„äº‹é¡¹ 1. å¦‚æœå†™å…¥çš„æ˜¯ç»“æ„ä½“ï¼Œé‚£ä¹ˆç»“æ„ä½“ä¸­ä¸èƒ½æœ‰éå®šé•¿çš„æ•°æ®ç±»å‹ æ¯”å¦‚ int å’Œ stringï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯ä¸å®šé•¿çš„ï¼Œint ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿæ¥å†³å®šé•¿åº¦ï¼Œè€Œ string ä»£è¡¨çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä»¥è¿›è¡Œæ‹¼æ¥/åˆ é™¤ç­‰æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯å®šé•¿çš„ï¼Œè¿™äº›ç±»å‹éƒ½æ— æ³•é€šè¿‡ binary.Write è¿›è¡Œå†™å…¥ã€‚å¦‚æœæƒ³å†™å…¥ int ç±»å‹çš„å˜é‡ï¼Œåº”è¯¥æ˜¾ç¤ºæŒ‡å®šå…¶é•¿åº¦ï¼Œæ¯”å¦‚ int64ã€‚åˆ‡ç‰‡ç±»å‹ä¹Ÿæ˜¯ä¸å®šé•¿çš„ï¼Œæ‰€ä»¥åªèƒ½ä¼ å…¥éœ€è¦æŒ‡å®šé•¿åº¦çš„æ•°ç»„ã€‚\nå¦‚æœå°† demo ä¸­çš„ç»“æ„ä½“ S ä¿®æ”¹ä¸ºï¼š\ntype S struct { pri int64 Id int64 Name []byte } è¿è¡Œç»“æœï¼š\npanic: binary.Write: invalid type *main.S\n2. ä½†æ˜¯å¯ä»¥å•ç‹¬å†™å…¥ []byte æ¯”å¦‚ä¸‹é¢çš„ç¨‹åºï¼š\npackage main import ( \u0026quot;encoding/binary\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;bytes\u0026quot; ) func main() { b := []byte(\u0026quot;123\u0026quot;) //b := \u0026quot;123456\u0026quot; buf := new(bytes.Buffer) bb := make([]byte, len(b), len(b)) if err := binary.Write(buf, binary.BigEndian, b); err != nil { panic(err) } if err := binary.Read(buf, binary.BigEndian, bb); err != nil { panic(err) } fmt.Println(b, bb) } // Output: // [49 50 51] [49 50 51] è¿™é‡Œå•ç‹¬å°† b å†™å…¥ï¼Œå‘ç°æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ï¼Œä½†æ˜¯ string ç±»å‹ä¾ç„¶ä¸èƒ½å†™å…¥ï¼Œä¼šæŠ¥é”™ï¼španic: binary.Write: invalid type string\n3. å¦‚æœå†™å…¥çš„æ˜¯ structï¼Œéœ€è¦ä¿è¯æ‰€æœ‰å­—æ®µä¸º publicï¼Œä½†æ˜¯ç»“æ„ä½“æœ¬èº«å¯ä»¥ä¸º private æ³¨æ„æ˜¯ æ‰€æœ‰å­—æ®µï¼Œå¦‚æœæœ‰éå¯¼å‡ºï¼ˆprivateï¼‰å­—æ®µï¼Œä¼šæŠ¥é”™ï¼šreflect: reflect.Value.SetInt using value obtained using unexported field\n4. å¯ä»¥å†™å…¥æ¥å£ç±»å‹ é€šè¿‡å¼€å¤´çš„ç¤ºä¾‹ç¨‹åºï¼Œè¯´æ˜æ˜¯å¯ä»¥å†™å…¥æ¥å£ç±»å‹çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œbinary.Read å’Œ binary.Write çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥æ¥å£ç±»å‹ï¼‰ã€‚\n","date":"2022å¹´08æœˆ08æ—¥","permalink":"/posts/go_binary/","summary":"ä¸€ä¸ªç¤ºä¾‹ demoï¼š\npackage main import ( \u0026quot;bytes\u0026quot; \u0026quot;encoding/binary\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; ) type I interface { Do() } type S struct { Id int64 Name [10]byte } func (s *S) Do() { fmt.","title":"go binary ä½¿ç”¨æŒ‡å— "},{"contents":"å‘é€æ–¹ç»´æŠ¤ä¸€ä¸ªå«åš æ‹¥å¡çª—å£ cwnd çš„çŠ¶æ€å˜é‡ï¼Œå…¶å€¼ å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ï¼Œå¹¶ä¸” åŠ¨æ€å˜åŒ–ã€‚\næ‹¥å¡çª—å£ cwnd çš„ç»´æŠ¤åŸåˆ™ï¼šåªè¦ç½‘ç»œ æ²¡æœ‰å‡ºç°æ‹¥å¡ï¼Œæ‹¥å¡çª—å£ å°±å† å¢å¤§ ä¸€äº›ï¼›ä½†åªè¦ç½‘ç»œ å‡ºç°æ‹¥å¡ï¼Œæ‹¥å¡çª—å£å°±å‡å°‘ä¸€äº›ã€‚ åˆ¤æ–­å‡ºç° ç½‘ç»œæ‹¥å¡çš„ä¾æ®ï¼šæ²¡æœ‰æŒ‰æ—¶æ”¶åˆ°åº”å½“åˆ°è¾¾çš„ç¡®è®¤æŠ¥æ–‡ï¼ˆå³å‘ç”Ÿè¶…æ—¶é‡ä¼ ï¼‰ã€‚ å‘é€æ–¹å°†æ‹¥å¡çª—å£ä½œä¸º å‘é€çª—å£ swndï¼Œå³ swnd = cwndã€‚æ‹¥å¡çª—å£çš„å¤§å°ä¹Ÿå°±æ˜¯å‘é€æ–¹èƒ½å‘é€çš„æŠ¥æ–‡çš„æ•°é‡ï¼Œå³ï¼šcwndå¢åŠ 1ä¹Ÿå°±æ˜¯ç›¸å½“äºå­—èŠ‚æ•°å¢åŠ 1ä¸ªMSSå¤§å° ï¼ˆè¿™é‡Œå­˜ç–‘ï¼Œæ˜¯æ•°é‡è¿˜æ˜¯æ€»å¤§å°ï¼Ÿï¼‰ã€‚\nç»´æŠ¤ä¸€ä¸ª æ…¢å¼€å§‹é—¨é™ ssthresh çŠ¶æ€å˜é‡ï¼š\nå½“ cwnd \u0026lt; ssthresh æ—¶ï¼Œä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼› å½“ cwnd \u0026gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œè¯¥ç”¨æ‹¥å¡é¿å…ç®—æ³•ï¼› å½“ cwnd = ssthresh æ—¶ï¼Œå³å¯ä»¥ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ‹¥å¡é¿å…ç®—æ³•ï¼› 1. æ…¢å¼€å§‹ å‘é€æ–¹å‘é€æŠ¥æ–‡åï¼Œå¦‚æœæ”¶åˆ°äº†å¯¹æ–¹çš„ç¡®è®¤æŠ¥æ–‡ï¼ˆå¯ä»¥ç®€ç§°ä¸ºä¸€ä¸ª ä¼ è¾“è½®æ¬¡ï¼‰ï¼Œé‚£ä¹ˆå°±å°†è‡ªå·±çš„ cwnd åœ¨ åŸåŸºç¡€ä¸Šä¹˜ä»¥ 2ï¼Œæ¯”å¦‚ä» 1 å¼€å§‹ï¼Œä¹‹åçš„çª—å£å¤§å°ä¾æ¬¡æ˜¯ï¼š2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ32ï¼Œ64\u0026hellip;ï¼ˆæŒ‰æŒ‡æ•°è§„å¾‹å¢é•¿ï¼‰\næ…¢å¼€å§‹å¯ä»¥ç†è§£ä¸º â€œåœ¨æ­»äº¡è¾¹ç¼˜ä¸æ–­è¯•æ¢â€ï¼Œä¸€å¼€å§‹è¯•æ¢æ€§çš„å‘ç½‘ç»œä¸­å‘é€å°‘é‡æŠ¥æ–‡ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°æ‹¥å¡ï¼Œå°± â€œå¾—å¯¸è¿›å°ºâ€ çš„å¤šå‘é€ä¸€äº›ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ‰€ä»¥ä¸è¦è¢«æ…¢å¼€å§‹çš„â€œæ…¢â€å­—ç»™æ¬ºéª—äº†ï¼Œå®ƒå¯ä¸€ç‚¹éƒ½ä¸æ…¢ï¼Œæ…¢å¼€å§‹å¹¶ä¸æ˜¯æŒ‡ cwnd çš„å¢é•¿é€Ÿåº¦æ…¢ï¼Œè€Œæ˜¯æŒ‡ä¸€å¼€å§‹å‘ç½‘ç»œæ³¨å…¥çš„æŠ¥æ–‡æ®µå°‘ã€‚\næ…¢å¼€å§‹ä½•æ—¶ç»“æŸï¼Ÿ æ—¢ç„¶æ…¢å¼€å§‹çš„å¢é•¿é€Ÿåº¦å¦‚æ­¤ä¹‹å¿«ï¼Œé‚£ä¹ˆè‚¯å®šä¸èƒ½è®©å…¶æ— é™åˆ¶å¢é•¿ï¼Œå½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œä¼šåœæ­¢æ…¢å¼€å§‹é˜¶æ®µï¼Œè¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µï¼š\nå½“ cwnd è¾¾åˆ° ssthresh æ—¶ï¼Œä¼šè¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚\nå‘é€è¶…æ—¶é‡ä¼ æ—¶ï¼Œæ­¤æ—¶ç½‘ç»œå¯èƒ½å‡ºç°äº†é˜»å¡ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒTCP åˆ¤æ–­ç½‘ç»œæ˜¯å¦é˜»å¡çš„ä¾æ®æ˜¯æ˜¯å¦å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼‰\nç–‘é—®ï¼šsshthresh çš„å€¼é»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ\nåœ¨ä¸€ç‰‡åšå®¢ä¸Šçœ‹çš„ç­”æ¡ˆæ˜¯ï¼šå¯¹äºå¤§å¤šæ•° TCP å®ç°æ¥è¯´ï¼Œssthresh çš„å€¼æ˜¯ 65536(åŒæ ·ä»¥å­—èŠ‚è®¡ç®—)ï¼Œè¿™é‡Œçš„å­—èŠ‚è®¡ç®—æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ˜¯ cwnd çš„é—¨é™å€¼ = 65535/mss çš„æ„æ€å—ï¼Ÿ\n2. æ‹¥å¡é¿å… åˆ°äº†æ‹¥å¡é¿å…é˜¶æ®µï¼Œå°±è¯´æ˜å‘é€æŠ¥æ–‡çš„æ•°é‡å¯èƒ½å¿«å¼•èµ·æ‹¥å¡äº†ï¼ˆcwnd = ssthreshï¼‰ï¼Œæˆ–è€…å¯èƒ½å·²ç»å‡ºç°äº†æ‹¥å¡ï¼ˆå‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼‰ï¼Œæ­¤æ—¶çš„æ‹¥å¡çª—å£å€¼å°±ä¸èƒ½å†åƒæ…¢å¼€å§‹é‚£æ ·å¿«é€Ÿå¢é•¿äº†ï¼Œå¯¹äºè¿™ä¸¤ç§æƒ…å†µï¼Œæœ‰ä¸åŒçš„å¤„ç†æ–¹æ³•ã€‚\nå½“ cwnd è¾¾åˆ° ssthresh æ—¶ æ­¤æ—¶è¯´æ˜å‘é€æŠ¥æ–‡çš„æ•°é‡å¯èƒ½å¿«å¼•èµ·æ‹¥å¡äº†ï¼Œä¸èƒ½å†æŒ‡æ•°çº§å¢é•¿äº†ï¼Œå˜ä¸ºçº¿æ€§å¢é•¿ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªä¼ è¾“è½®æ¬¡åªå°† cwnd + 1ã€‚\nå‘é€è¶…æ—¶é‡ä¼  å¦‚æœ å‘é€æ–¹å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œé‚£ä¹ˆè¯´æ˜æ­¤æ—¶ç½‘ç»œå¯èƒ½å·²ç»å‡ºç°æ‹¥å¡ï¼Œæ­¤æ—¶éœ€è¦åšä»¥ä¸‹å·¥ä½œï¼š\nå°†æ…¢å¼€å§‹é—¨é™å€¼ ssthresh æ›´æ–°ä¸ºå‘ç”Ÿæ‹¥å¡æ—¶æ‹¥å¡çª—å£å€¼çš„ä¸€åŠã€‚æ¯”å¦‚åœ¨ cwnd=24 æ—¶å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œé‚£ä¹ˆå°±ä¼šå°† ssthresh æ›´æ–°ä¸º 12. å°† cwnd æ›´æ–°ä¸º 1ï¼Œå¹¶é‡æ–°å¼€å§‹æ…¢å¼€å§‹ç®—æ³•ã€‚ æ‹¥å¡é¿å… å¹¶éæŒ‡å®Œå…¨èƒ½å¤Ÿé¿å…æ‹¥å¡ï¼Œè€Œæ˜¯æŒ‡åœ¨æ‹¥å¡é¿å…é˜¶æ®µå°† æ‹¥å¡çª—å£æ§åˆ¶ä¸ºæŒ‰çº¿æ€§è§„å¾‹å¢é•¿ï¼Œä½¿ç½‘ç»œä¸å®¹æ˜“å‡ºç°æ‹¥å¡ã€‚\næ‹¥å¡æ§åˆ¶çš„æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nï¼ˆå›¾ç‰‡å‡ºè‡ªï¼šè®¡ç®—æœºç½‘ç»œå¾®è¯¾å ‚ï¼ˆæœ‰å­—å¹•æ— èƒŒæ™¯éŸ³ä¹ç‰ˆï¼‰ï¼‰\n3. å¿«é‡ä¼  æŠ¥æ–‡å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œå¹¶ä¸ä¸€å®šå°±ä»£è¡¨ç½‘ç»œå‘ç”Ÿäº†æ‹¥å¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åˆ«çš„åŸå› ï¼Œæ¯”å¦‚å› ä¸ºè¯¯ç ï¼Œè¢«è·¯ç”±å™¨ç»™æ‰”äº†ï¼Œæˆ–è€…ç½‘ç»œå‡ºç°äº†å»¶è¿Ÿï¼Œå¦‚æœç›´æ¥ç®€å•ç²—æš´çš„è¿›å…¥åˆ°æ‹¥å¡é¿å…é˜¶æ®µï¼Œè®© cwnd å›å½’åˆ° 1ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œçš„ä¼ è¾“æ•ˆç‡é™ä½ã€‚\nå¿«é‡ä¼ ç®—æ³•å¯ä»¥è®©å‘é€æ–¹å°½æ—©çŸ¥é“å‘ç”Ÿäº†ä¸ªåˆ«æŠ¥æ–‡æ®µçš„ä¸¢å¤±ã€‚\næ‰€è°“å¿«é‡ä¼ ï¼Œå°±æ˜¯ä½¿å‘é€æ–¹ å°½å¿«è¿›è¡Œé‡ä¼ ï¼Œè€Œ ä¸æ˜¯ç­‰å¾…è¶…æ—¶é‡ä¼ è®¡æ—¶å™¨è¶…æ—¶ å†é‡ä¼ ã€‚\nè¦æ±‚æ¥æ”¶æ–¹ä¸è¦ç­‰å¾…è‡ªå·±å‘é€æ•°æ®æ—¶æ‰è¿›è¡Œæå¸¦ç¡®è®¤ï¼Œè€Œæ˜¯è¦ç«‹å³å‘é€ç¡®è®¤ï¼› å³ä½¿æ”¶åˆ°äº†å¤±åºçš„æŠ¥æ–‡æ®µä¹Ÿè¦ç«‹å³å‘å‡ºå¯¹å·²æ”¶åˆ°çš„æŠ¥æ–‡æ®µçš„é‡å¤ç¡®è®¤ã€‚ å‘é€æ–¹ä¸€æ—¦æ”¶åˆ° 3 ä¸ªè¿ç»­çš„é‡å¤ç¡®è®¤ï¼Œå°±å°†ç›¸åº”çš„æŠ¥æ–‡æ®µç«‹å³é‡ä¼ ï¼Œè€Œä¸æ˜¯ç­‰è¯¥æŠ¥æ–‡æ®µçš„è¶…æ—¶é‡ä¼ è®¡æ—¶å™¨è¶…æ—¶å†é‡ä¼ ã€‚ æ¯”å¦‚ä¸‹å›¾çš„æƒ…å†µï¼ŒM3 åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±äº†ï¼Œæ¥æ”¶æ–¹åœ¨æ”¶åˆ° M4 åï¼Œå‘ç° M3 è¿˜æ²¡æ”¶åˆ°ï¼Œäºæ˜¯å›å¤ ACK=2ï¼Œè¡¨ç¤ºå·²ç»æ”¶åˆ° M2 åŒ…äº†ï¼Œå¸Œæœ›æ¥ä¸‹æ¥æ”¶åˆ° M3 åŒ…ï¼Œä¹‹åå‘é€çš„ M4ï¼ŒM5 ä¹Ÿéƒ½æ˜¯å¦‚æ­¤ã€‚æ­¤æ—¶å‘é€æ–¹å‘ç°æ”¶åˆ°äº† 3 ä¸ª ACK=2ï¼ŒçŸ¥é“äº† M2 è¿™ä¸ªåŒ…å¯¹æ–¹æ²¡æœ‰æ”¶åˆ°ï¼Œäºæ˜¯å°±å¯ä»¥ç«‹é©¬é‡ä¼ äº†ï¼Œè€Œä¸æ˜¯ç­‰åˆ° M3 çš„è¶…æ—¶é‡ä¼ åˆ°æœŸåå†é‡ä¼ ã€‚\nè¿™æ ·å¯¹äºä¸ªåˆ«ä¸¢å¤±çš„æŠ¥æ–‡æ®µï¼Œå‘é€æ–¹å°±ä¸ä¼šå‡ºç°è¶…æ—¶é‡ä¼ ï¼Œä¹Ÿå°±ä¸ä¼šè¯¯è®¤ä¸ºå‡ºç°äº†æ‹¥å¡ï¼Œé¿å…äº†å°†æ‹¥å¡çª—å£ cwnd é™ä½ä¸º 1ã€‚ä½¿ç”¨å¿«é‡ä¼ å¯ä»¥ä½¿æ•´ä¸ªç½‘ç»œçš„ååé‡æé«˜çº¦ 20 %ã€‚\n4. å¿«æ¢å¤ å‘é€æ–¹ä¸€æ—¦ æ”¶åˆ° 3 ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±çŸ¥é“ç°åœ¨åªæ˜¯ä¸¢å¤±äº†ä¸ªåˆ«çš„æŠ¥æ–‡æ®µã€‚äºæ˜¯ä¸å¯åŠ¨æ…¢å¼€å§‹ç®—æ³•ï¼Œè€Œ æ‰§è¡Œå¿«æ¢å¤ç®—æ³•ï¼›\nå‘é€æ–¹å°†æ…¢å¼€å§‹é—¨é™ ssthresh å€¼å’Œæ‹¥å¡çª—å£ cwnd å€¼è°ƒæ•´ä¸ºå½“å‰çª—å£çš„ä¸€åŠï¼›å¼€å§‹æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ã€‚\nä¹Ÿæœ‰çš„å¿«æ¢å¤å®ç°æ˜¯æŠŠå¿«æ¢å¤å¼€å§‹æ—¶çš„æ‹¥å¡çª—å£ cwnd å€¼å†å¢å¤§ä¸€äº›ï¼Œå³ç­‰äºæ–°çš„ ssthresh +3ã€‚\næ—¢ç„¶å‘é€æ–¹æ”¶åˆ°3ä¸ªé‡å¤çš„ç¡®è®¤ï¼Œå°±è¡¨æ˜æœ‰3ä¸ªæ•°æ®æŠ¥æ–‡æ®µå·±ç»ç¦»å¼€äº†ç½‘ç»œï¼š\nè¿™3ä¸ªæŠ¥æ–‡æ®µä¸å†æ¶ˆè€—ç½‘ç»œèµ„æºè€Œæ˜¯åœç•™åœ¨æ¥æ”¶æ–¹çš„æ¥æ”¶ç¼“å­˜ä¸­ï¼›\nå¯è§ç°åœ¨ç½‘ç»œä¸­ä¸æ˜¯å †ç§¯äº†æŠ¥æ–‡æ®µè€Œæ˜¯å‡å°‘äº†3ä¸ªæŠ¥æ–‡æ®µã€‚å› æ­¤å¯ä»¥é€‚å½“æŠŠæ‹¥å¡çª—å£æ‰©å¤§äº›ã€‚\nä¸‹å›¾æè¿°äº†æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å¿«æ¢å¤æ˜¯å°† cwnd è°ƒæ•´ä¸ºå‘ç”Ÿé‡å¤ç¡®è®¤æ—¶ï¼Œçª—å£çš„ä¸€åŠï¼Œè€Œä¸æ˜¯åƒæ‹¥å¡é¿å…ç›´æ¥å°† cwnd è°ƒæ•´ä¸º 1ï¼Œä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†ååç‡ã€‚\nå‚è€ƒ/å¼•ç”¨ è®¡ç®—æœºç½‘ç»œå¾®è¯¾å ‚ï¼ˆæœ‰å­—å¹•æ— èƒŒæ™¯éŸ³ä¹ç‰ˆï¼‰\nTCPæ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤\n","date":"2022å¹´08æœˆ02æ—¥","permalink":"/posts/tcp_yong_se_kong_zhi/","summary":"å‘é€æ–¹ç»´æŠ¤ä¸€ä¸ªå«åš æ‹¥å¡çª—å£ cwnd çš„çŠ¶æ€å˜é‡ï¼Œå…¶å€¼ å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ï¼Œå¹¶ä¸” åŠ¨æ€å˜åŒ–ã€‚","title":"TCP æ‹¥å¡æ§åˆ¶"},{"contents":"å¦‚æœæ²¡æœ‰è°ƒç”¨ make æ¥å¯¹ä¸€ä¸ª chan è¿›è¡Œåˆå§‹åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ª chan å°±æ˜¯ nil chanã€‚\nå¯¹äº nil chanï¼š\nä» nil chan æ¥æ”¶å°†æ°¸è¿œé˜»å¡ å‘é€å€¼åˆ° nil chan ä¼šæ°¸è¿œé˜»å¡ close ä¸€ä¸ª nil chan ä¼šå¼•å‘ panic çœ‹åˆ°è¿™é‡Œæˆ‘ä¸ç¦æœ‰ç‚¹ç–‘é—®ï¼Œè¿™æ ·è®¾è®¡çš„æ„ä¹‰åœ¨å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆå†™å…¥å’Œè¯»å–è¦é˜»å¡ï¼Œè€Œä¸æ˜¯åƒ nil map ä¸€æ ·ç›´æ¥ panicï¼Ÿ\nå¸¦ç€è¿™ä¸ªé—®é¢˜æ‰¾åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼šWhy are there nil channels in Go?\nä¸­è¯‘ç‰ˆï¼šä¸ºä»€ä¹ˆ Go ä¼šæœ‰ nil channels\né‡Œé¢æåˆ°äº† nil chan çš„æ„ä¹‰ï¼Œè¿™é‡Œç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼š\nnil chan ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ select çš„ç©ºè½¬ã€‚\næ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š\nfunc fn(c1 chan int, c2 chan int) { for { select { case v := \u0026lt;- c1: case v := \u0026lt;- c2: } } } å¦‚æœæŸä¸ªæ—¶é—´ c1ï¼Œc2 éƒ½è¢«å…³é—­äº†ï¼ŒæŒ‰ç…§ chan çš„è§„åˆ™ï¼Œå¦‚æœå°è¯•è¯»å–ä¸€ä¸ªå·²å…³é—­çš„ chanï¼Œå°†ä¼šè¯»å–å‡ºç±»å‹çš„ç©ºå€¼ï¼Œæ‰€ä»¥æ­¤æ—¶çš„ case v := \u0026lt;- c1: å’Œ case v := \u0026lt;- c2: åˆ†æ”¯ä¾ç„¶æ˜¯ä¼šè¢«é€‰æ‹©çš„ï¼Œè€Œä¸€ä¸ª chan è¢«å…³é—­åˆ™è¯´æ˜æˆ‘ä»¬å·²ç»ä¸éœ€è¦å®ƒäº†ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸€ä¸ªå¤šä½™çš„æ“ä½œã€‚\nè€Œ select çš„è§„åˆ™æ˜¯ï¼Œå¦‚æœæ‰€æœ‰ case éƒ½æ»¡è¶³ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªï¼Œæ­¤æ—¶çš„ c1ï¼Œc2 ä¾ç„¶æ»¡è¶³æ¡ä»¶ï¼Œæ‰€ä»¥ select ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªï¼Œåˆå› ä¸º select å®šä¹‰åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œé¢ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ cpu ç©ºè½¬ã€‚\nç°åœ¨ç»ˆäºçŸ¥é“ nil chan é˜»å¡çš„æ„ä¹‰ä½•åœ¨äº†ï¼Œå°†ä¸Šé¢çš„ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š\nfunc fn(c1 chan int, c2 chan int) { for { select { case v, ok := \u0026lt;- c1: if !ok {c1 = nil} case v, ok := \u0026lt;- c2: if !ok {c2 = nil} default: return } } } å¦‚æœæŸä¸ª chan è¢« close äº†ï¼Œé‚£ä¹ˆå°†å…¶è®¾ç½®ä¸º nilï¼Œè€Œ nil chan çš„è¯»å–ä¼šé˜»å¡ï¼Œæ‰€ä»¥ select å°±ä¸ä¼šé€‰æ‹©è¿™ä¸ªåˆ†æ”¯äº†ï¼Œè¿™æ ·å°±é¿å…äº†ä¸Šè¿°æƒ…å†µçš„ç©ºå‡†ï¼Œä½†æ˜¯ä¸è¦å¿˜è®°åŠ ä¸€ä¸ª default åˆ†æ”¯ï¼Œä¸ç„¶è¿™ä¸ª select å°±è¢«æ°¸ä¹…é˜»å¡äº†ã€‚\n","date":"2022å¹´07æœˆ18æ—¥","permalink":"/posts/wei-shen-me-go-you-nil-chan/","summary":"å¦‚æœæ²¡æœ‰è°ƒç”¨ make æ¥å¯¹ä¸€ä¸ª chan è¿›è¡Œåˆå§‹åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ª chan å°±æ˜¯ nil chanã€‚","title":"ä¸ºä»€ä¹ˆ go éœ€è¦ nil chan"},{"contents":"è®¾ç½®ä»£ç†åï¼Œminikube kubectl æ— å“åº” åœ¨ç»™è™šæ‹Ÿæœºè®¾ç½®äº†ä»£ç†åï¼Œæ•´ä¸ªç½‘ç»œä½“éªŒçˆ½å¿«å¤šäº†ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ‹‰ä¸ä¸‹æ¥åŒ…äº†ã€‚ã€‚ã€‚\nåªéœ€è¦å°†è™šæ‹Ÿæœºçš„ç½‘ç»œè®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼ï¼Œç„¶åå¼€å¯ clashx çš„ â€œå…è®¸å±€åŸŸç½‘è¿æ¥â€ï¼ˆéå¸¸é‡è¦çš„ä¸€æ­¥ï¼Œä¹‹å‰å°±æ˜¯å› ä¸ºå¿½ç•¥äº†è¿™ä¸€æ­¥ï¼Œå¯¼è‡´è™šæ‹Ÿæœºæ— æ³•ä½¿ç”¨å®¿ä¸»æœºä»£ç†ï¼‰ï¼Œç„¶åå†ç‚¹å‡» clashx çš„ â€œå¤åˆ¶ç»ˆç«¯ä»£ç†å‘½ä»¤â€ï¼Œå°†é‡Œé¢çš„ 127.0.0.1 æ›¿æ¢ä¸ºå®¿ä¸»æœºçš„ ipï¼Œç„¶åç²˜è´´åˆ°è™šæ‹Ÿæœºçš„ç»ˆç«¯ä¸Šå…è®¸ï¼Œå³å¯æˆåŠŸå¼€å¯ä»£ç†ã€‚\nä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥å°è£…æˆä¸¤ä¸ªå‡½æ•°ï¼Œæ”¾åˆ° .zshrcï¼ˆæˆ–è€… .bashrcï¼‰é‡Œé¢ï¼š\nhost_ip=\u0026quot;192.168.2.5\u0026quot; # å®¿ä¸»æœº IP function proxy_on() { export https_proxy=http://$host_ip:7890 http_proxy=http://$host_ip:7890 all_proxy=socks5://$host_ip:7890 # curl https://www.google.com/ # echo -e \u0026quot;\\n\u0026quot; echo -e \u0026quot;\\033[32må·²å¼€å¯ä»£ç†\\033[0m\u0026quot; } function proxy_off() { unset http_proxy unset https_proxy unset all_proxy echo -e \u0026quot;å·²å…³é—­ä»£ç†\u0026quot; } ç„¶åé‡æ–°è½½å…¥ï¼š\nsource ~/.zshrc ç°åœ¨åœ¨ç»ˆç«¯å¯ä»¥è¾“å…¥ proxy_on æ¥å¼€å¯ä»£ç†äº†ï¼ŒåŒæ ·å¯ä»¥è¾“å…¥ proxy_off æ¥å…³é—­ã€‚\nä½†æ˜¯ä¹‹åå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œkubectl å‘½ä»¤æ— å“åº”ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨ snap ä¸‹è½½çš„ kubectlï¼Œè¿˜æ˜¯ä½¿ç”¨ minikube kubectl ä¸‹è½½çš„ kubectl éƒ½æ˜¯å¦‚æ­¤ã€‚\nå¦‚æœæ‰§è¡Œ kubectl get po ä¼šä¸€ç›´é˜»å¡ï¼Œä½†æ˜¯ kubectl version åœ¨ç­‰å¾…ä¸€ä¼šåä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼š\n$ minikube kubectl version WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short. Use --output=yaml|json to get the full version. Client Version: version.Info{Major:\u0026quot;1\u0026quot;, Minor:\u0026quot;24\u0026quot;, GitVersion:\u0026quot;v1.24.3\u0026quot;, GitCommit:\u0026quot;aef86a93758dc3cb2c658dd9657ab4ad4afc21cb\u0026quot;, GitTreeState:\u0026quot;clean\u0026quot;, BuildDate:\u0026quot;2022-07-13T14:30:46Z\u0026quot;, GoVersion:\u0026quot;go1.18.3\u0026quot;, Compiler:\u0026quot;gc\u0026quot;, Platform:\u0026quot;linux/arm64\u0026quot;} Kustomize Version: v4.5.4 error: Get \u0026quot;https://192.168.49.2:8443/version?timeout=32s\u0026quot;: context deadline exceeded - error from a previous attempt: read tcp 192.168.2.2:35044-\u0026gt;192.168.2.5:7890: read: connection reset by peer çœ‹åˆ°è¿™é‡Œçš„ 192.168.2.2:35044-\u0026gt;192.168.2.5:7890ï¼Œæˆ‘æ‰å‘ç°æœ‰ç‚¹ä¸å¯¹åŠ²ï¼Œè¿™ä¸æ˜¯æˆ‘è®¾ç½®çš„ä»£ç†åœ°å€å—ï¼Ÿéš¾é“é—®é¢˜å‡ºåœ¨è¿™é‡Œï¼Ÿ\nç„¶åæŸ¥é˜…äº†ä¸€ä¸‹ minikube çš„å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°é‡Œé¢ä¸“é—¨ æœ‰ä¸€èŠ‚ ä¸“é—¨æåˆ°äº†ä»£ç†çš„é—®é¢˜ï¼š\né‡Œé¢ç‰¹åˆ«æåˆ°äº†ï¼š\nå¦‚æœéœ€è¦ HTTP ä»£ç†æ¥è®¿é—®äº’è”ç½‘ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡å°†ä»£ç†è¿æ¥ä¿¡æ¯ä¼ é€’ç»™ minikube å’Œ Dockerï¼š\nHTTP_PROXY- æ‚¨çš„ HTTP ä»£ç†çš„ URL HTTPS_PROXY- HTTPS ä»£ç†çš„ URL NO_PROXY- ä¸åº”é€šè¿‡ä»£ç†çš„ä¸»æœºçš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚ è¿™é‡Œçš„ NO_PROXY å˜é‡å¾ˆé‡è¦ï¼šå¦‚æœä¸è®¾ç½®å®ƒï¼Œminikube å¯èƒ½æ— æ³•è®¿é—® VM å†…çš„èµ„æºã€‚minikube ä½¿ç”¨å››ä¸ªé»˜è®¤ IP èŒƒå›´ï¼Œå®ƒä»¬ä¸åº”é€šè¿‡ä»£ç†ï¼š\n192.168.59.0/24ï¼šç”± minikube VM ä½¿ç”¨ã€‚å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸ºæŸäº›ç®¡ç†ç¨‹åºé…ç½®--host-only-cidr 192.168.39.0/24ï¼šç”± minikube kvm2 é©±åŠ¨ç¨‹åºä½¿ç”¨ã€‚ 192.168.49.0/24ï¼šç”± minikube docker é©±åŠ¨ç¨‹åºçš„ç¬¬ä¸€ä¸ªé›†ç¾¤ä½¿ç”¨ã€‚ 10.96.0.0/12ï¼šç”±æœåŠ¡é›†ç¾¤ IP ä½¿ç”¨ã€‚å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½® --service-cluster-ip-range å¹¶ä¸”ç»™å‡ºäº†ç¤ºä¾‹ï¼š\nexport HTTP_PROXY=http://\u0026lt;proxy hostname:port\u0026gt; export HTTPS_PROXY=https://\u0026lt;proxy hostname:port\u0026gt; export NO_PROXY=localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24 ç°åœ¨ç…§çŒ«ç”»è™ï¼Œä¿®æ”¹ä¹‹å‰çš„ proxy_on å‡½æ•°ï¼ˆè¿™é‡Œæˆ‘åŒæ ·åˆ é™¤äº† all_proxy é…ç½®ï¼Œä¸çŸ¥é“è¿™ä¸ªé…ç½®æ˜¯å¦æœ‰å½±å“ï¼‰ï¼š\nhost_ip=\u0026quot;192.168.2.5\u0026quot; function proxy_on() { export no_proxy=localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24 export https_proxy=http://$host_ip:7890 export http_proxy=http://$host_ip:7890 # curl https://www.google.com/ # echo -e \u0026quot;\\n\u0026quot; echo -e \u0026quot;\\033[32må·²å¼€å¯ä»£ç†\\033[0m\u0026quot; } ç°åœ¨ kubectl å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚\næ›´æ–°ï¼š\næœ€è¿‘å‘ç°åˆå‡ºç°è¿™ä¸ªé—®é¢˜äº†ï¼Œæˆ‘çš„ proxy_on å‡½æ•°ä¹Ÿæ²¡æœ‰å‘ç”Ÿä»»ä½•ä¿®æ”¹ï¼ŒæŠ¥é”™ï¼š\n$ kubectl version WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short. Use --output=yaml|json to get the full version. Client Version: version.Info{Major:\u0026quot;1\u0026quot;, Minor:\u0026quot;24\u0026quot;, GitVersion:\u0026quot;v1.24.4\u0026quot;, GitCommit:\u0026quot;95ee5ab382d64cfe6c28967f36b53970b8374491\u0026quot;, GitTreeState:\u0026quot;clean\u0026quot;, BuildDate:\u0026quot;2022-08-18T02:40:28Z\u0026quot;, GoVersion:\u0026quot;go1.18.5\u0026quot;, Compiler:\u0026quot;gc\u0026quot;, Platform:\u0026quot;linux/arm64\u0026quot;} Kustomize Version: v4.5.4 error: Get \u0026quot;https://192.168.58.2:8443/version?timeout=32s\u0026quot;: context deadline exceeded - error from a previous attempt: read tcp 192.168.2.4:45562-\u0026gt;192.168.2.3:7890: read: connection reset by peer è¿™é‡Œæˆ‘æ³¨æ„åˆ°äº† \u0026ldquo;https://192.168.58.2:8443/version?timeout=32s\u0026rdquo; è¿™éƒ¨åˆ†ï¼Œå‘ç°è¯·æ±‚çš„æ˜¯ 192.168.58.2 è¿™ä¸ªåœ°å€ï¼Œæˆ‘å°è¯•å°†è¿™ä¸ªåœ°å€æ®µï¼ˆä¹Ÿå°±æ˜¯ 192.168.58.0/24ï¼‰ä¹Ÿæ·»åŠ åˆ° no_proxy åˆ—è¡¨ä¸­ï¼š\nfunction proxy_on() { export no_proxy=localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24,192.168.58.0/24 export https_proxy=http://$host_ip:7890 export http_proxy=http://$host_ip:7890 # curl https://www.google.com/ # echo -e \u0026quot;\\n\u0026quot; echo \u0026quot;host_ip: $host_ip\u0026quot; echo -e \u0026quot;\\033[32må·²å¼€å¯ä»£ç†\\033[0m\u0026quot; } æ·»åŠ å source .zshrcï¼Œproxy_off ä¸€ä¸‹ï¼Œå†é‡æ–° proxy_onï¼Œå‘ç° kubectl å¯ä»¥æ­£å¸¸æ‰§è¡Œäº†ã€‚\nä¸è¿‡å…·ä½“åŸå› è¿˜ä¸æ¸…æ¥šï¼Œæˆ‘çš„ minikube version æ˜¯ v1.26.1ï¼Œæ˜¯å®˜æ–¹æ–‡æ¡£ä¸è¿™ä¸ªç‰ˆæœ¬ä¸åŒ¹é…å—ï¼Ÿæˆ–è€…å¯èƒ½æ˜¯å› ä¸º 192.168.59.0 è¿™ä¸ªç½‘æ®µè¢«å ç”¨äº†ï¼Œå¯¼è‡´ minikube é‡æ–°é€‰æ‹©äº† 192.168.58.0 è¿™ä¸ªç½‘æ®µï¼Ÿæš‚æ—¶ä¸çŸ¥é“åŸå› ï¼Œä¸è¿‡åªè¦æŒ‰ç…§ kubectl version é‡Œçš„æŠ¥é”™ä¿¡æ¯ï¼Œå°†è¯·æ±‚çš„ç½‘æ®µæ·»åŠ åˆ° no_proxy ç¯å¢ƒå˜é‡é‡Œå°±å¯ä»¥è§£å†³é—®é¢˜äº†ã€‚\nminikube æ— æ³•å¯åŠ¨ é‡è£…äº†ä¸€ä¸‹ dockerï¼Œå‘ç° minikube æ— æ³•å¯åŠ¨äº†ï¼Œéƒ¨åˆ†æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š\n[kubelet-check] Initial timeout of 40s passed. Unfortunately, an error has occurred: timed out waiting for the condition This error is likely caused by: - The kubelet is not running - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled) If you are on a systemd-powered system, you can try to troubleshoot the error with the following commands: - 'systemctl status kubelet' - 'journalctl -xeu kubelet' è§£å†³æ–¹æ³•ï¼Œå‚è€ƒè¿™é‡Œï¼š\n$ minikube delete $ minikube start --kubernetes-version=v1.23.8 å¯èƒ½æ˜¯ kubernetes 1.24 çš„é—®é¢˜å¯¼è‡´çš„\nåˆ›å»º pod é”™è¯¯ï¼ŒError: ImagePullBackOff ä¸€ä¸ª redis yaml å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod metadata: name: redis labels: app: redis spec: containers: - name: redis image: redis ports: - containerPort: 6379 hostPort: 6379 è¿™æ˜¯æˆ‘ä¹‹å‰ä½¿ç”¨è¿‡çš„ redis yamlï¼Œyaml æœ¬èº«åº”è¯¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯ kubectl apply -f redis.yaml åï¼Œpod æ— æ³•åˆ›å»ºæˆåŠŸï¼Œå¤„äº ImagePullBackOff çŠ¶æ€ï¼ŒæŸ¥çœ‹ describeï¼ŒæŠ¥é”™ä¿¡æ¯ï¼š\nEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 9m47s default-scheduler Successfully assigned default/redis to minikube Warning Failed 9m31s kubelet Failed to pull image \u0026quot;redis\u0026quot;: rpc error: code = Unknown desc = Error response from daemon: Get \u0026quot;https://registry-1.docker.io/v2/\u0026quot;: context deadline exceeded (Client.Timeout exceeded while awaiting headers) Warning Failed 8m21s (x2 over 9m2s) kubelet Failed to pull image \u0026quot;redis\u0026quot;: rpc error: code = Unknown desc = Error response from daemon: Get \u0026quot;https://registry-1.docker.io/v2/\u0026quot;: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers) Normal Pulling 7m26s (x4 over 9m47s) kubelet Pulling image \u0026quot;redis\u0026quot; Warning Failed 7m11s (x4 over 9m31s) kubelet Error: ErrImagePull Warning Failed 7m11s kubelet Failed to pull image \u0026quot;redis\u0026quot;: rpc error: code = Unknown desc = Error response from daemon: Get \u0026quot;https://registry-1.docker.io/v2/\u0026quot;: dial tcp 54.242.59.189:443: i/o timeout Warning Failed 6m56s (x6 over 9m31s) kubelet Error: ImagePullBackOff Normal BackOff 4m37s (x14 over 9m31s) kubelet Back-off pulling image \u0026quot;redis\u0026quot; ä½†æ˜¯æˆ‘ä½¿ç”¨ docker pull redis æ˜¯æˆåŠŸçš„ï¼š\n$ docker pull redis Using default tag: latest latest: Pulling from library/redis 5b1423465504: Pull complete 4216a986e3df: Pull complete f74254280149: Pull complete 64dfe9963acc: Pull complete 097894d6d055: Pull complete b9381c45e088: Pull complete Digest: sha256:495732ba570db6a3626370a1fb949e98273a13d41eb3e26f7ecb1f6e31ad4041 Status: Downloaded newer image for redis:latest docker.io/library/redis:latest è€Œä¸”æˆ‘æ³¨æ„åˆ° docker pull çš„åœ°å€æ˜¯ library/redisï¼Œè€Œ k8s pod get çš„åœ°å€æ˜¯ registry-1.docker.io/v2/ï¼Œå› ä¸ºè™šæ‹Ÿæœºæˆ‘æŒ‚äº†ä»£ç†ï¼Œåº”è¯¥ä¹Ÿä¸æ˜¯ç½‘ç»œçš„é—®é¢˜ã€‚æˆ‘åˆå°† redis.yaml é‡Œé¢çš„ spec.containers[0].image æ”¹ä¸ºäº† library/redisï¼Œä¾æ—§åˆ›å»ºå¤±è´¥ï¼Œè¿˜æ˜¯ä¼š Get https://registry-1.docker.io/v2/ è¿™ä¸ªåœ°å€ã€‚\nä¸çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œè¯•äº†ä¸‹ç”¨ k3s æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œå¯ä»¥åˆ›å»ºæˆåŠŸ\n","date":"2022å¹´07æœˆ14æ—¥","permalink":"/posts/minikube_wen_ti_hui_zong/","summary":"è®¾ç½®ä»£ç†åï¼Œminikube kubectl æ— å“åº” åœ¨ç»™è™šæ‹Ÿæœºè®¾ç½®äº†ä»£ç†åï¼Œæ•´ä¸ªç½‘ç»œä½“éªŒçˆ½å¿«å¤šäº†ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ‹‰ä¸ä¸‹æ¥åŒ…äº†ã€‚ã€‚ã€‚\nåªéœ€è¦å°†è™šæ‹Ÿæœºçš„ç½‘ç»œè®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼ï¼Œç„¶åå¼€å¯ clashx çš„ â€œå…è®¸å±€åŸŸç½‘è¿æ¥â€ï¼ˆéå¸¸é‡è¦çš„ä¸€æ­¥ï¼Œä¹‹å‰å°±æ˜¯å› ä¸ºå¿½ç•¥äº†è¿™ä¸€æ­¥ï¼Œå¯¼è‡´è™šæ‹Ÿæœºæ— æ³•ä½¿ç”¨å®¿ä¸»æœºä»£ç†ï¼‰ï¼Œç„¶åå†ç‚¹å‡» clashx çš„ â€œå¤åˆ¶ç»ˆç«¯ä»£ç†å‘½ä»¤â€ï¼Œå°†é‡Œé¢çš„ 127.","title":"minikube é—®é¢˜æ±‡æ€»"},{"contents":" æœ¬ç¬”è®°ä¸»è¦è®°å½• go rabbitmq åº“çš„ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒæ—¶ç»“åˆå­¦ä¹  rabbitmq\nä¸€ä¸ªåŸºæœ¬çš„å‘å¸ƒ/è®¢é˜…ç¨‹åºç¤ºä¾‹ é¦–å…ˆå¯ä»¥é€šè¿‡ä¸€ä¸ªæœ€åŸºç¡€çš„ç¨‹åºï¼Œæ¥ä¸€è§ˆ rabbitmq çš„å¤§è‡´é¢è²Œï¼š\nç”Ÿäº§è€… ä»£ç å¦‚ä¸‹ï¼š\npackage main import ( \u0026quot;bufio\u0026quot; amqp \u0026quot;github.com/rabbitmq/amqp091-go\u0026quot; \u0026quot;log\u0026quot; \u0026quot;os\u0026quot; ) func Assert(err error, msg string) { if err != nil { log.Panicf(\u0026quot;%s: %s\u0026quot;, msg, err) } } func main() { // 1. å°è¯•è¿æ¥ RabbitMQï¼Œå»ºç«‹è¿æ¥ // è¯¥è¿æ¥æŠ½è±¡äº†å¥—æ¥å­—è¿æ¥ï¼Œå¹¶ä¸ºæˆ‘ä»¬å¤„ç†åè®®ç‰ˆæœ¬åå•†å’Œè®¤è¯ç­‰ã€‚ conn, err := amqp.Dial(\u0026quot;amqp://guest:guest@localhost:5672/\u0026quot;) Assert(err, \u0026quot;Failed to connect to RabbitMQ\u0026quot;) defer conn.Close() // 2. æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œå¤§å¤šæ•° API éƒ½æ˜¯ç”¨è¿‡è¯¥é€šé“æ“ä½œçš„ã€‚ ch, err := conn.Channel() Assert(err, \u0026quot;Failed to open a channel\u0026quot;) defer ch.Close() // 3. å£°æ˜æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ— q, err := ch.QueueDeclare( \u0026quot;hello\u0026quot;, // name false, // durable æ˜¯å¦ä¸ºæŒä¹…åŒ–é˜Ÿåˆ— false, // delete when unused false, // exclusive false, // no-wait nil, // arguments ) Assert(err, \u0026quot;Failed to declare a queue\u0026quot;) log.Printf(\u0026quot;Enter q or Q to exit.\u0026quot;) scanner := bufio.NewScanner(os.Stdin) for scanner.Scan() { if scanner.Err() != nil { Assert(scanner.Err(), \u0026quot;read stdin error\u0026quot;) } body := scanner.Bytes() if string(body) == \u0026quot;q\u0026quot; || string(body) == \u0026quot;Q\u0026quot; { log.Printf(\u0026quot;bye^\u0026quot;) break } // 4.å°†æ¶ˆæ¯å‘å¸ƒåˆ°å£°æ˜çš„é˜Ÿåˆ— err = ch.Publish( \u0026quot;\u0026quot;, // exchange q.Name, // routing key false, // mandatory false, // immediate amqp.Publishing{ ContentType: \u0026quot;text/plain\u0026quot;, Body: body, // æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯ï¼Œç¬æ€ï¼ˆ0 æˆ– 1ï¼‰æˆ–æŒä¹…ï¼ˆ2ï¼‰ DeliveryMode: amqp.Transient, }) Assert(err, \u0026quot;Failed to publish a message\u0026quot;) } } æ¶ˆè´¹è€… package main import ( amqp \u0026quot;github.com/rabbitmq/amqp091-go\u0026quot; \u0026quot;log\u0026quot; ) func Assert(err error, msg string) { if err != nil { log.Panicf(\u0026quot;%s: %s\u0026quot;, msg, err) } } func main() { conn, err := amqp.Dial(\u0026quot;amqp://guest:guest@localhost:5672/\u0026quot;) Assert(err, \u0026quot;Failed to connect to RabbitMQ\u0026quot;) defer conn.Close() ch, err := conn.Channel() Assert(err, \u0026quot;Failed to open a channel\u0026quot;) defer ch.Close() q, err := ch.QueueDeclare( \u0026quot;hello\u0026quot;, // name false, // durable false, // delete when unused false, // exclusive false, // no-wait nil, // arguments ) Assert(err, \u0026quot;Failed to declare a queue\u0026quot;) msgs, err := ch.Consume( q.Name, // queue \u0026quot;\u0026quot;, // consumer true, // auto-ack false, // exclusive false, // no-local false, // no-wait nil, // args ) Assert(err, \u0026quot;Failed to register a consumer\u0026quot;) var forever chan struct{} go func() { for d := range msgs { log.Printf(\u0026quot;Received a message: %s\u0026quot;, d.Body) } }() log.Printf(\u0026quot; [*] Waiting for messages. To exit press CTRL+C\u0026quot;) \u0026lt;-forever } æ ¸å¿ƒæ–¹æ³• é€šè¿‡ä¸Šé¢çš„ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç ä¸­æœ‰å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š\nQueueDeclare ç”¨äºåˆ›å»ºä¸€ä¸ª é˜Ÿåˆ—ï¼Œæˆ–è€…è¿æ¥åˆ°ä¸€ä¸ªå·²å­˜åœ¨çš„é˜Ÿåˆ—ï¼Œéœ€è¦æä¾›ä»¥ä¸‹å‚æ•°ï¼š\nnameï¼šæŒ‡å®šé˜Ÿåˆ—çš„åç§°ï¼Œå¦‚æœç•™ç©ºä¸”æ‰§è¡Œçš„æ˜¯åˆ›å»ºæ“ä½œï¼Œåˆ™ä¼šéšæœºåˆ†é…ä¸€ä¸ªåç§° durableï¼šæ˜¯å¦æŒä¹…åŒ– autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤é˜Ÿåˆ—ï¼Œå¦‚æœä¸º true è¡¨ç¤ºæ²¡æœ‰æ¶ˆæ¯ä¹Ÿæ²¡æœ‰æ¶ˆè´¹è€…è¿æ¥è‡ªåŠ¨åˆ é™¤é˜Ÿåˆ— exclusive: æ˜¯å¦ç‹¬å ï¼Œå³å½“å‰å£°æ˜é˜Ÿåˆ—çš„è¿æ¥å…³é—­åå³è¢«åˆ é™¤ noWait: æ˜¯å¦ç­‰å¾…æœåŠ¡å™¨è¿”å› ok args: Consume queueï¼šè¦æ¶ˆè´¹çš„é˜Ÿåˆ—çš„åå­— consumerï¼š autoAckï¼šå¦‚æœä¸º trueï¼Œä»£è¡¨ mq ä¼šè‡ªåŠ¨æŠŠå‘é€å‡ºå»çš„æ¶ˆæ¯ç½®ä¸ºç¡®è®¤ï¼Œä¸ä¼šè€ƒè™‘æ¶ˆè´¹è€…æ˜¯å¦çœŸæ­£çš„æ¶ˆè´¹äº†è¿™æ¡æ¶ˆæ¯ exclusive noLocal noWait args Publish exchangeï¼šäº¤æ¢æœºçš„åç§°ï¼Œç”¨äºç¡®å®šæ¶ˆæ¯è¦æŠ•æ”¾åˆ°å“ªä¸ªäº¤æ¢æœº keyï¼šè·¯ç”±é”®ï¼Œç±»ä¼¼è·¯ç”±çš„åŠŸèƒ½ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªäº¤æ¢æœºå®šä¹‰å¤šä¸ªè·¯ç”±é”®ï¼Œé€šè¿‡ä¸åŒè·¯ç”±é”®è¿æ¥åˆ°ä¸åŒçš„é˜Ÿåˆ— mandatory ï¼š immediate ï¼š msgï¼šè¦æ¨é€çš„æ¶ˆæ¯ï¼Œå­—èŠ‚ç±»å‹ ä¸´æ—¶é˜Ÿåˆ— exchange äº¤æ¢å™¨ exchange æ˜¯æ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™,è·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚\næ¯”å¦‚ä¸‹å›¾ï¼Œx å°±æ˜¯ä¸€ä¸ªäº¤æ¢æœºï¼Œå®ƒå®šä¹‰äº† 3 ä¸ª routing_keyï¼Œrouting_key å°±æ˜¯ä¸Šé¢è¯´çš„è§„åˆ™ï¼Œä¸åŒçš„ routing_key å…³è”åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåœ¨ä¸‹å›¾ä¸­ï¼Œorange è¿™ä¸ª key å…³è”åˆ°äº†é˜Ÿåˆ— Q1ï¼Œblack å’Œ green è¿™ä¸¤ä¸ª key å…³è”åˆ°äº†é˜Ÿåˆ— Q2ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ ¹æ® routing_key æ¥æ¶ˆè´¹ä¸åŒçš„é˜Ÿåˆ—ã€‚\nexchange çš„ç¨‹åºå¤§è‡´æµç¨‹æ˜¯ï¼š\nç”Ÿäº§è€…ï¼š\nå®šä¹‰æˆ–è€…è¿æ¥ä¸€ä¸ª exchange æ¨é€æ¶ˆæ¯åˆ°è¿™ä¸ª exchange æ¶ˆè´¹è€…ï¼š\nå®šä¹‰ä¸€ä¸ªé˜Ÿåˆ— å°†é˜Ÿåˆ—å’Œä¸Šé¢çš„ exchange ç»‘å®š ç„¶åå°±å¯ä»¥ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹äº† å…¶å®ä¸Šé¢çš„æµç¨‹ä¸æ˜¯å›ºå®šçš„ï¼Œåªéœ€è¦è®°ä½ä¸€ä¸ªå›ºå®šçš„è§„åˆ™å³å¯ï¼šæ¶ˆè´¹è€…åªèƒ½ä»é˜Ÿåˆ—æ¶ˆè´¹ï¼Œé˜Ÿåˆ—å¿…é¡»ç»‘å®šä¸€ä¸ª exchangeï¼Œæ‰€ä»¥é˜Ÿåˆ—çš„å®šä¹‰å’Œç»‘å®šï¼ˆä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…æµç¨‹çš„ 1ï¼Œ2 æ­¥ï¼‰å®Œå…¨ä¹Ÿå¯ä»¥è®©ç”Ÿäº§è€…å»åšï¼Œæ¶ˆè´¹è€…ç›´æ¥è¿›è¡Œæ¶ˆè´¹å°±å¯ä»¥äº†ï¼Œåªè¦ä¿è¯ rabbitmq ä¸­å­˜åœ¨è¿™ä¸ªå·²ç»ç»‘å®šåˆ° exchange çš„é˜Ÿåˆ—å³å¯ã€‚\nè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šåœ¨æ–‡ç« æœ€å¼€å§‹çš„ç¤ºä¾‹ä¸­ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºä¸€ä¸ª exchangeï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œç»‘å®šæ“ä½œï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯ç›´æ¥æ“ä½œé˜Ÿåˆ—ï¼Œè¿™æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿå…¶å®åœ¨ rabbitmq ä¸­å­˜åœ¨ä¸€ä¸ª é»˜è®¤çš„ exchangeï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š exchangeï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨è¿™ä¸ªé»˜è®¤äº¤æ¢å™¨ï¼Œå¯¹äº routing key ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ã€‚\nç»‘å®šè°ƒç”¨çš„å‡½æ•°æ˜¯ QueueBindï¼Œå…¶ç­¾åå¦‚ä¸‹ï¼š\nQueueBind name key exchange noWait args exchange æœ‰å¤šç§ç±»å‹ï¼Œä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªé€šç”¨çš„ç¨‹åºï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥å®šä¹‰ä¸åŒçš„ exchange\né€šç”¨ä»£ç  ç”Ÿäº§è€… package main import ( \u0026quot;bufio\u0026quot; \u0026quot;bytes\u0026quot; \u0026quot;errors\u0026quot; \u0026quot;flag\u0026quot; amqp \u0026quot;github.com/rabbitmq/amqp091-go\u0026quot; \u0026quot;log\u0026quot; \u0026quot;os\u0026quot; ) type ExchangeKind = string const ( ExchangeKind_Direct ExchangeKind = \u0026quot;direct\u0026quot; ExchangeKind_Topic ExchangeKind = \u0026quot;topic\u0026quot; ExchangeKind_Headers ExchangeKind = \u0026quot;headers\u0026quot; ExchangeKind_Fanout ExchangeKind = \u0026quot;fanout\u0026quot; ) func Assert(err error, msg string) { if err != nil { log.Panicf(\u0026quot;%s: %s\u0026quot;, msg, err) } } // æ£€æŸ¥è¾“å…¥çš„ exchange kind æ˜¯å¦åˆæ³• func checkExchangeKind(kind string) error { m := map[string]bool{ ExchangeKind_Direct: true, ExchangeKind_Topic: true, ExchangeKind_Headers: true, ExchangeKind_Fanout: true, } if exist := m[kind]; exist { return nil } return errors.New(\u0026quot;not found this kind\u0026quot;) } func main() { log.Printf(\u0026quot;usage: ./main -e [exchange name] -k [exchange kind]\u0026quot;) var ( exchangeName = flag.String(\u0026quot;e\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;exchange name\u0026quot;) exchangeKind = flag.String(\u0026quot;k\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;exchange kind\u0026quot;) ) flag.Parse() if err := checkExchangeKind(*exchangeKind); err != nil { Assert(err, \u0026quot;check exchange kind error: \u0026quot;) } log.Printf(\u0026quot;exchangeName: %v, exchangeKind: %v\\n\u0026quot;, *exchangeName, *exchangeKind) // 1. å°è¯•è¿æ¥ RabbitMQï¼Œå»ºç«‹è¿æ¥ // è¯¥è¿æ¥æŠ½è±¡äº†å¥—æ¥å­—è¿æ¥ï¼Œå¹¶ä¸ºæˆ‘ä»¬å¤„ç†åè®®ç‰ˆæœ¬åå•†å’Œè®¤è¯ç­‰ã€‚ conn, err := amqp.Dial(\u0026quot;amqp://guest:guest@localhost:5672/\u0026quot;) Assert(err, \u0026quot;Failed to connect to RabbitMQ\u0026quot;) defer conn.Close() // 2. æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œå¤§å¤šæ•° API éƒ½æ˜¯ç”¨è¿‡è¯¥é€šé“æ“ä½œçš„ã€‚ ch, err := conn.Channel() Assert(err, \u0026quot;Failed to open a channel\u0026quot;) defer ch.Close() // å£°æ˜ä¸€ä¸ªäº¤æ¢å™¨ exchange err = ch.ExchangeDeclare( *exchangeName, // name äº¤æ¢å™¨å *exchangeKind, // type äº¤æ¢å™¨ç±»å‹ true, // durable false, // auto-deleted false, // internal false, // no-wait nil, // arguments ) Assert(err, \u0026quot;Failed to declare a exchange\u0026quot;) log.Printf(\u0026quot;Enter q or Q to exit.\u0026quot;) log.Printf(\u0026quot;usage: \u0026lt;routing_key\u0026gt;:\u0026lt;message\u0026gt;\u0026quot;) scanner := bufio.NewScanner(os.Stdin) for scanner.Scan() { if scanner.Err() != nil { Assert(scanner.Err(), \u0026quot;read stdin error\u0026quot;) } body := scanner.Bytes() if string(body) == \u0026quot;q\u0026quot; || string(body) == \u0026quot;Q\u0026quot; { log.Printf(\u0026quot;bye^\u0026quot;) break } // è¾“å…¥çš„æ ¼å¼ï¼š\u0026lt;è·¯ç”±é”®\u0026gt;:\u0026lt;æ¶ˆæ¯å®ä½“\u0026gt; before, after, found := bytes.Cut(body, []byte(\u0026quot;:\u0026quot;)) if !found { log.Printf(\u0026quot;usage: \u0026lt;routing_key\u0026gt;:\u0026lt;message\u0026gt;\u0026quot;) continue } log.Printf(\u0026quot;routingKey: %s, message: %s\\n\u0026quot;, before, after) // 4.å°†æ¶ˆæ¯å‘å¸ƒåˆ° exchange è€Œä¸æ˜¯æŸä¸ªå•ç‹¬çš„é˜Ÿåˆ— err = ch.Publish( *exchangeName, // exchange string(before), // routing key false, // mandatory false, // immediate amqp.Publishing{ ContentType: \u0026quot;text/plain\u0026quot;, Body: after, // æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯ï¼Œç¬æ€ï¼ˆ0 æˆ– 1ï¼‰æˆ–æŒä¹…ï¼ˆ2ï¼‰ DeliveryMode: amqp.Transient, }) Assert(err, \u0026quot;Failed to publish a message\u0026quot;) } } ä½¿ç”¨æ–¹æ³•ï¼š\n./producer_exchange -e [exchange name] -k [exchange kind] ä½¿ç”¨ç¤ºä¾‹ï¼š\n# æ¨é€æ¶ˆæ¯åˆ°åä¸º logs_direct ï¼Œç±»å‹ä¸º direct çš„ exchange ./producer_exchange -e logs_direct -k direct # æ¨é€æ¶ˆæ¯åˆ°åä¸º logs_topic ï¼Œç±»å‹ä¸º topic çš„ exchange ./producer_exchange -e logs_topic -k topic æ¶ˆè´¹è€… package main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; amqp \u0026quot;github.com/rabbitmq/amqp091-go\u0026quot; \u0026quot;log\u0026quot; . \u0026quot;rabbitmq\u0026quot; \u0026quot;strings\u0026quot; ) type routingKeys []string func (s *routingKeys) String() string { return fmt.Sprintf(\u0026quot;%v\u0026quot;, *s) } func (s *routingKeys) Set(value string) error { ss := strings.Split(value, \u0026quot;,\u0026quot;) *s = append(*s, ss...) return nil } func Assert(err error, msg string) { if err != nil { log.Panicf(\u0026quot;%s: %s\u0026quot;, msg, err) } } func main() { log.Printf(` usage: ./main -q [queue name] -e [exchange name] -r [routing key, can provide more, use ',' to sep, example: info,error,warning (don't have space) ] `) var ( exchangeName = flag.String(\u0026quot;e\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;exchange name\u0026quot;) queueName = flag.String(\u0026quot;q\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;queue name\u0026quot;) rks routingKeys ) flag.Var(\u0026amp;rks, \u0026quot;r\u0026quot;, \u0026quot;routing key\u0026quot;) flag.Parse() log.Printf(\u0026quot;queueName: %v, exchangeName: %v, routingKey: %v\\n\u0026quot;, *queueName, *exchangeName, \u0026amp;rks) conn, err := amqp.Dial(\u0026quot;amqp://guest:guest@localhost:5672/\u0026quot;) Assert(err, \u0026quot;Failed to connect to RabbitMQ\u0026quot;) defer conn.Close() ch, err := conn.Channel() Assert(err, \u0026quot;Failed to open a channel\u0026quot;) defer ch.Close() // å£°æ˜ä¸€ä¸ªä¸´æ—¶é˜Ÿåˆ—ï¼Œä¸€æ—¦æ¶ˆè´¹è€…æ–­å¼€è¿æ¥ï¼Œè¯¥é˜Ÿåˆ—å°±ä¼šè¢«åˆ é™¤ q, err := ch.QueueDeclare( *queueName, // name ç©ºå­—ç¬¦ä¸²ä½œä¸ºé˜Ÿåˆ—åç§°ï¼Œè¡¨ç¤ºä½¿ç”¨éšæœºåç§° false, // durable false, // delete when unused true, // exclusive ç‹¬å é˜Ÿåˆ—ï¼ˆå½“å‰å£°æ˜é˜Ÿåˆ—çš„è¿æ¥å…³é—­åå³è¢«åˆ é™¤ï¼‰ false, // no-wait nil, // arguments ) Assert(err, \u0026quot;Failed to declare a queue\u0026quot;) if len(rks) == 0 { err = ch.QueueBind( q.Name, \u0026quot;\u0026quot;, *exchangeName, false, nil, ) Assert(err, \u0026quot;Failed to bind a queue\u0026quot;) } else { for _, key := range rks { // å°† queue ç»‘å®šåˆ°å¯¹åº”çš„ exchangeï¼Œä½¿ç”¨ exchangeName + routingKeys è¿›è¡ŒåŒ¹é… err = ch.QueueBind( q.Name, key, *exchangeName, false, nil, ) Assert(err, \u0026quot;Failed to bind a queue\u0026quot;) } } msgs, err := ch.Consume( q.Name, // queue \u0026quot;\u0026quot;, // consumer true, // auto-ack false, // exclusive false, // no-local false, // no-wait nil, // args ) Assert(err, \u0026quot;Failed to register a consumer\u0026quot;) var forever chan struct{} go func() { for d := range msgs { // å¦‚æœæ‚¨è°ƒç”¨ Channel.Consume æ—¶å°† autoAck è®¾ç½®ä¸º trueï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†è‡ªåŠ¨ç¡®è®¤ // æ¯æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸åº”è°ƒç”¨æ­¤æ–¹æ³•ã€‚å¦åˆ™ï¼Œæ‚¨å¿…é¡»åœ¨æˆåŠŸå¤„ç†æ­¤äº¤ä»˜åè°ƒç”¨ Delivery.Ackã€‚ // å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ // d.Ack(false) log.Printf(\u0026quot;Received a message: %s\u0026quot;, d.Body) } }() log.Printf(\u0026quot; [*] Waiting for messages. To exit press CTRL+C\u0026quot;) \u0026lt;-forever } ä½¿ç”¨æ–¹æ³•ï¼š\nusage: ./main -q [queue name] -e [exchange name] -r [routing key, å¯ä»¥æä¾›å¤šä¸ª, ä½¿ç”¨ , æ¥åˆ†éš”, æ¯”å¦‚: info,error,warning (æ³¨æ„ , å‰åä¸è¦æœ‰ç©ºæ ¼) ] ä½¿ç”¨ç¤ºä¾‹ï¼š\n// ./consumer_exchange -e logs_direct -r error // ./consumer_exchange -e logs_direct -r error,info,warning // // ./consumer_exchange -e logs_topic -r \u0026quot;*.orange.*\u0026quot; // ./consumer_exchange -e logs_topic -r \u0026quot;*.*.rabbit\u0026quot;,\u0026quot;lazy.#\u0026quot; fanout fanout ç±»å‹çš„ exchange æä¾›å¹¿æ’­åŠŸèƒ½ï¼Œå³å°†æ¶ˆæ¯æŠ•é€’åˆ°æ‰€æœ‰ä¸è¯¥ exchange æ‰€ç»‘å®šçš„ queue ä¸Šï¼Œæ­¤æ—¶æŒ‡å®šçš„ routing key ä¼šè¢«å¿½ç•¥\nç¤ºä¾‹ è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸Šé¢çš„é€šç”¨ä»£ç ï¼Œåªè¦åœ¨è¿è¡Œæ—¶æŒ‡å®šä¸åŒçš„ flag å³å¯\nç”Ÿäº§è€… ./producer_exchange -e logs -k fanout æ¶ˆè´¹è€… 1 å› ä¸º fanout ä¼šå¿½ç•¥ routing keyï¼Œæ‰€ä»¥ -r ä¹Ÿä¸éœ€è¦æŒ‡å®šäº†\n./consumer_exchange -e logs æ¶ˆè´¹è€… 2 ./consumer_exchange -e logs å…ˆæ‰§è¡Œç”Ÿäº§è€…ï¼Œå†æ‰§è¡Œæ¶ˆè´¹è€…1ï¼Œ2\nç”Ÿäº§è€…æ‰§è¡Œååœ¨ç»ˆç«¯è¾“å…¥æ¶ˆæ¯ï¼ˆæ¶ˆæ¯æ ¼å¼æ˜¯ \u0026lt;è·¯ç”±é”®\u0026gt;:\u0026lt;æ¶ˆæ¯\u0026gt;ï¼Œå› ä¸ºæ˜¯ fanout ç±»å‹ï¼Œæ‰€ä»¥æ— éœ€æŒ‡å®šè·¯ç”±é”®ï¼‰ï¼š\n$ ./producer_exchange -e logs -k fanout 2022/07/24 12:16:22 usage: ./main -e [exchange name] -k [exchange kind] 2022/07/24 12:16:22 exchangeName: logs, exchangeKind: fanout 2022/07/24 12:16:22 Enter q or Q to exit. 2022/07/24 12:16:22 usage: \u0026lt;routing_key\u0026gt;:\u0026lt;message\u0026gt; :123 2022/07/24 12:20:27 routingKey: , message: 123 ä¹‹åè§‚å¯Ÿä¸¤ä¸ªæ¶ˆè´¹è€…çš„ terminalï¼Œå‘ç°éƒ½æ”¶åˆ°äº†æ¶ˆæ¯ï¼š\n$ ./consumer_exchange -e logs 2022/07/24 12:20:23 usage: ./main -q [queue name] -e [exchange name] -r [routing key, can provide more, use ',' to sep, example: info,error,warning (don't have space) ] 2022/07/24 12:20:23 queueName: , exchangeName: logs, routingKey: [] 2022/07/24 12:20:23 [*] Waiting for messages. To exit press CTRL+C 2022/07/24 12:20:27 Received a message: 123 direct direct ç±»å‹çš„ exchange ä¼šä¸¥æ ¼æŒ‰ç…§ routing key è¿›è¡Œç²¾å‡†åŒ¹é…\ntopic topic ç±»å‹çš„ exchange æä¾›äº† routing key çš„é€šé…ç¬¦åŒ¹é…åŠŸèƒ½ï¼Œæ”¯æŒ * å’Œ # è¯­æ³•ï¼Œ\u0026quot;#\u0026quot; ä»£è¡¨åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ï¼Œ\u0026quot;*\u0026quot; åˆ™åŒ¹é…ä¸å¤šä¸å°‘åˆšå¥½ä¸€ä¸ªå•è¯\nç¤ºä¾‹ è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸Šé¢çš„é€šç”¨ä»£ç ï¼Œåªè¦åœ¨è¿è¡Œæ—¶æŒ‡å®šä¸åŒçš„ flag å³å¯\nç”Ÿäº§è€… $ ./producer_exchange -e logs_topic -k topic # å¼€å§‹è¾“å…¥ quick.orange.rabbit:666 lazy.orange.elephant:aaa quick.orange.fox:888 æ¶ˆè´¹è€… 1 è¿™ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ routing key åŒ¹é… *.orange.* çš„æ¶ˆæ¯ï¼Œè¡¨ç¤ºå•è¯ä¸ªæ•°å¿…é¡»æ˜¯ 3 ä¸ªï¼Œä¸”ä¸­é—´çš„å¿…é¡»æ˜¯ orange\n$ ./consumer_exchange -e logs_topic -r \u0026quot;*.orange.*\u0026quot; æ¶ˆè´¹è€… 2 æ³¨æ„è¿™é‡Œè¦ç”¨ \u0026quot;\u0026quot; å°† routing key åŒ…è£¹èµ·æ¥ï¼Œå¦åˆ™ * ä¼šè¢« shell é”™è¯¯è§£æ\n*.*.rabbit\tè¡¨ç¤ºå•è¯ä¸ªæ•°å¿…é¡»æ˜¯ 3 ä¸ªï¼Œä¸”æœ€åä¸€ä¸ªå•è¯å¿…é¡»æ˜¯ rabbit\nlazy.# è¡¨ç¤ºçš„æ˜¯åªè¦ç¬¬ä¸€ä¸ªå•è¯ä¸º lazy å³å¯ï¼Œä¹‹åçš„å†…å®¹å¿½ç•¥\n$ ./consumer_exchange -e logs_topic -r \u0026quot;*.*.rabbit\u0026quot;,\u0026quot;lazy.#\u0026quot; åŒ¹é…æƒ…å†µï¼š\n// \u0026gt; quick.orange.rabbit:666\t=\u0026gt; *.orange.* | *.*.rabbit //\t\u0026gt; lazy.orange.elephant:aaa\t=\u0026gt;\t*.orange.* //\t\u0026gt; quick.orange.fox:888\t=\u0026gt;\t*.orange.* //\t\u0026gt; lazy.brown.fox:666\t=\u0026gt;\tlazy.# //\t\u0026gt; lazy.pink.rabbit:xxx\t=\u0026gt;\tlazy.# | *.*.rabbit //\t\u0026gt; quick.brown.fox:yyy\t=\u0026gt; //\t\u0026gt; orange:ccc\t=\u0026gt; // \u0026gt; quick.orange.male.rabbit:bbb\t=\u0026gt; //\t\u0026gt; lazy.orange.male.rabbit:ooo\t=\u0026gt;\tlazy.# //\t\u0026gt; lazy.orange.male.rabbit.io:zzz\t=\u0026gt;\tlazy.# å¯ä»¥æŒ‰ç…§ä¸Šè¡¨çš„å†…å®¹è‡ªå·±å®è·µä¸€ä¸‹ï¼Œçœ‹çœ‹ä¸åŒçš„ routing_key ä¼šä¼ é€’ç»™å“ªä¸ªæ¶ˆè´¹è€…\nå»¶è¿Ÿé˜Ÿåˆ— å»¶è¿Ÿé˜Ÿåˆ—å¯ä»¥ç”¨äºè®¢å•è¶…æ—¶å–æ¶ˆçš„åœºæ™¯ï¼Œå¯ä»¥ç”¨ rabbitmq çš„æ­»ä¿¡é˜Ÿåˆ—æ¥å®ç°ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—ã€‚\næ­»ä¿¡é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç”¨æ¥å­˜å‚¨é‚£äº›æ— æ³•è¢«æ¶ˆè´¹çš„ï¼Œå·²ç»â€œæ­»æ‰â€œçš„æ¶ˆæ¯ï¼Œå’Œæ™®é€šé˜Ÿåˆ—ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç”± exchangeã€routing_key å’Œ queue ä¸‰å¤§ç»„ä»¶æ„æˆçš„ã€‚\nä»€ä¹ˆæ¡ä»¶ä¸‹ä¼šå°†æ¶ˆæ¯æ”¾åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ\næ¶ˆæ¯è¢«æ‹’ç»ï¼Œå¹¶ä¸” requeue å‚æ•°ä¸º falseï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦å°†è¢«æ‹’ç»çš„æ¶ˆæ¯é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œè®©å…¶ä»–æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ æ¶ˆæ¯çš„ TTL è¿‡æœŸ é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦æˆ–é˜Ÿåˆ—ç©ºé—´å·²æ»¡ï¼Œæ­¤æ—¶éœ€è¦ queue çš„æ‹’ç»ç­–ç•¥è®¾ç½®ä¸º reject-public-dlxï¼Œåç»­æŠ•é€’è‡³è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯ä¼šé‡æ–°æŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šæ¶ˆæ¯çš„ TTL å’Œæ¶ˆæ¯çš„ ACK æ˜¯ä¸ç›¸å¹²çš„ï¼Œæ¯”å¦‚è®¾ç½®äº†æ¶ˆæ¯çš„ TTL ä¸º 5sï¼Œä½†æ˜¯æ¶ˆæ¯è¶…è¿‡ 5s æ²¡æœ‰å›å¤ ACKï¼Œæ­¤æ—¶æ˜¯ä¸ä¼šåˆ¤å®šè¿™æ¡æ¶ˆæ¯è¿‡æœŸçš„ï¼Œå¼•ç”¨ä¹¦ä¸Šçš„ä¸€æ®µè¯ï¼šRabbitMQ ä¸ä¼šä¸ºæœªç¡®è®¤çš„æ¶ˆæ¯è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå®ƒåˆ¤æ–­æ­¤æ¶ˆæ¯æ˜¯å¦éœ€è¦é‡æ–°æŠ•é€’ç»™æ¶ˆè´¹è€…çš„å”¯ä¸€ä¾æ®æ˜¯æ¶ˆè´¹è¯¥æ¶ˆæ¯çš„æ¶ˆè´¹è€…è¿æ¥æ˜¯å¦å·±ç»æ–­å¼€ï¼Œè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯ RabbitMQ å…è®¸æ¶ˆè´¹è€…è´¹ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´å¯ä»¥å¾ˆä¹…å¾ˆä¹…ã€‚\næ¶ˆæ¯è¿‡æœŸçš„ä¾æ®æ˜¯ï¼šå¦‚æœä¸€æ¡æ¶ˆæ¯è¶…è¿‡ TTL è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåˆ™åˆ¤æ–­ä¸ºè¿‡æœŸã€‚è€Œ ACK æ˜¯åœ¨å·²ç»æ¶ˆè´¹çš„æƒ…å†µä¸‹æ‰èƒ½å›å¤çš„ä¸œè¥¿ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªä¸œè¥¿å½“ç„¶ä¸ç›¸å¹²ã€‚\nä¹‹æ‰€ä»¥ä¼šè®°å½•ä¸Šé¢çš„é—®é¢˜ï¼Œæ˜¯å› ä¸ºæˆ‘åœ¨å†™ä»£ç æ—¶çŠ¯äº†è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘åœ¨æ¶ˆè´¹è€…å¼€äº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ¶ˆè´¹æ™®é€šé˜Ÿåˆ—å’Œæ­»ä¿¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…è¿™è¾¹ä¼šå…ˆå°†æ¶ˆæ¯æŠ•æ”¾åˆ°æ™®é€šé˜Ÿåˆ—ï¼Œç„¶åæˆ‘çš„é€»è¾‘æ˜¯æ¶ˆæ¯æ™®é€šé˜Ÿåˆ—çš„æ—¶å€™åŠ ä¸€ä¸ªéšæœºçš„ sleepï¼Œè®©éƒ¨åˆ†æ¶ˆæ¯çš„ ACK è¶…è¿‡ TTL çš„æ—¶é—´ï¼Œä»è€Œè®©æ¶ˆæ¯è¶…æ—¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿è¡Œæ—¶æˆ‘å‘ç°æ¶ˆæ¯å§‹ç»ˆä¸ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œé™¤éæ˜¯ç›´æ¥ç»“æŸæ‰æ¶ˆè´¹è€…è¿›ç¨‹ï¼Œç„¶åç”Ÿäº§è€…è¿™è¾¹æŠ•æ”¾å‡ æ¡æ¶ˆæ¯ï¼Œç­‰è¿‡äº† TTL æ—¶é—´åå†è¿è¡Œæ¶ˆè´¹è€…è¿›ç¨‹ï¼Œæ­¤æ—¶å°±ä¼šä»æ­»ä¿¡é˜Ÿåˆ—é‡Œæ¶ˆè´¹åˆ°è¿‡æœŸæ¶ˆæ¯ã€‚\nå®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„åŸºæœ¬é€»è¾‘\nç”Ÿäº§è€…ï¼š\nåˆ›å»ºä¸€ä¸ªæ­£å¸¸äº¤æ¢æœº åˆ›å»ºä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœº åˆ›å»ºä¸€ä¸ªæ­£å¸¸é˜Ÿåˆ—ï¼Œå¹¶ç»‘å®šæ­£å¸¸äº¤æ¢æœºå’Œ routing_keyï¼ŒåŒæ—¶è®¾ç½®ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼š \u0026quot;x-message-ttl\u0026quot;: 5000, // æ¶ˆæ¯è¿‡æœŸæ—¶é—´,æ¯«ç§’ \u0026quot;x-dead-letter-exchange\u0026quot;: dlxExchangeName, // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº \u0026quot;x-dead-letter-routing-key\u0026quot;: dlxRoutingKey, // æŒ‡å®šæ­»ä¿¡ routing-key åˆ›å»ºä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—ï¼Œå¹¶ç»‘å®šæ­»ä¿¡äº¤æ¢æœºå’Œ routing_key æ¨é€æ¶ˆæ¯åˆ°æ­£å¸¸äº¤æ¢æœº æ¶ˆè´¹è€…ï¼š\nå› ä¸ºé˜Ÿåˆ—å’Œäº¤æ¢æœºéƒ½å·²ç»ç”±ç”Ÿäº§è€…åˆ›å»ºå¥½äº†ï¼Œæ‰€ä»¥æ¶ˆè´¹è€…è¿™è¾¹ç›´æ¥æ¶ˆè´¹å³å¯ï¼Œå¹¶ä¸”åªéœ€è¦ä»æ­»ä¿¡äº¤æ¢æœºè¿›è¡Œæ¶ˆè´¹å³å¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”Ÿäº§è€…æ”¾åˆ°æ­£å¸¸é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯åœ¨ TTL ä¹‹åè¿‡æœŸï¼Œä¼šæ”¾åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œè¿™æ ·æ¶ˆè´¹è€…å°±å¯ä»¥ç›´æ¥è¿›è¡Œæ¶ˆè´¹äº†ã€‚\næ¯”å¦‚è®¢å•è¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆçš„åœºæ™¯ï¼Œå½“ç”¨æˆ·æäº¤è®¢å•æ—¶ï¼Œç”Ÿäº§è€…å°†è®¢å•ä¿¡æ¯æ”¾åˆ°æ­£å¸¸é˜Ÿåˆ—ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå½“åˆ°è¾¾æ—¶é—´åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…è¿™è¾¹å°±å¯ä»¥å¼€å§‹è¿›è¡Œæ¶ˆè´¹äº†ï¼Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ¯”å¦‚å¯ä»¥æŸ¥è¯¢ä¸€ä¸‹è®¢å• IDï¼Œçœ‹æ”¯ä»˜çŠ¶æ€æ˜¯å¦ä¸ºæœªæ”¯ä»˜ï¼Œå¦‚æœæœªæ”¯ä»˜å°±è¯´æ˜å¯ä»¥å–æ¶ˆè¿™ä¸ªè®¢å•äº†ã€‚\næ¶æ„åŠç»„ä»¶ ","date":"2022å¹´07æœˆ14æ—¥","permalink":"/posts/go-rabbitmq/","summary":"æœ¬ç¬”è®°ä¸»è¦è®°å½• go rabbitmq åº“çš„ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒæ—¶ç»“åˆå­¦ä¹  rabbitmq","title":"rabbitmq å­¦ä¹ ç¬”è®°"},{"contents":" æ³¨ï¼šä»¥ä¸‹å†…å®¹å¼•ç”¨è‡ª cloudflare å­¦ä¹ ä¸­å¿ƒ\nTLS æ¡æ‰‹æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ TLS æ¡æ‰‹æ˜¯ç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤æ¢çš„ä¸€ç³»åˆ—æ•°æ®æŠ¥æˆ–æ¶ˆæ¯ã€‚TLS æ¡æ‰‹æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œå› ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¦äº¤æ¢å®Œæˆæ¡æ‰‹å’Œè¿›è¡Œè¿›ä¸€æ­¥å¯¹è¯æ‰€éœ€çš„ä¿¡æ¯ã€‚\nTLS æ¡æ‰‹çš„ç¡®åˆ‡æ­¥éª¤å°†æ ¹æ®æ‰€ä½¿ç”¨çš„å¯†é’¥äº¤æ¢ç®—æ³•çš„ç±»å‹ä»¥åŠåŒæ–¹æ”¯æŒçš„å¯†ç å¥—ä»¶è€Œæœ‰æ‰€ä¸åŒã€‚RSA å¯†é’¥äº¤æ¢ç®—æ³•æœ€ä¸ºå¸¸ç”¨ã€‚å…·ä½“å¦‚ä¸‹ï¼š\nâ€œå®¢æˆ·ç«¯é—®å€™ï¼ˆclient helloï¼‰â€ æ¶ˆæ¯ï¼š å®¢æˆ·ç«¯é€šè¿‡å‘æœåŠ¡å™¨å‘é€â€œé—®å€™â€æ¶ˆæ¯æ¥å¼€å§‹æ¡æ‰‹ã€‚è¯¥æ¶ˆæ¯å°†åŒ…å« å®¢æˆ·ç«¯æ”¯æŒçš„ TLS ç‰ˆæœ¬ï¼Œæ”¯æŒçš„å¯†ç å¥—ä»¶ï¼Œä»¥åŠç§°ä¸ºä¸€ä¸²ç§°ä¸ºâ€œå®¢æˆ·ç«¯éšæœºæ•°ï¼ˆclient randomï¼‰â€çš„éšæœºå­—èŠ‚ã€‚\nâ€œæœåŠ¡å™¨é—®å€™ï¼ˆserver helloï¼‰â€æ¶ˆæ¯ï¼š ä½œä¸ºå¯¹ client hello æ¶ˆæ¯çš„å›å¤ï¼ŒæœåŠ¡å™¨å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå†…å«æœåŠ¡å™¨çš„ SSL è¯ä¹¦ã€æœåŠ¡å™¨é€‰æ‹©çš„å¯†ç å¥—ä»¶ï¼ˆä»å®¢æˆ·ç«¯æ”¯æŒçš„å¥—ä»¶ä¸­é€‰æ‹©ï¼‰ï¼Œä»¥åŠâ€œæœåŠ¡å™¨éšæœºæ•°ï¼ˆserver randomï¼‰â€ï¼Œå³ç”±æœåŠ¡å™¨ç”Ÿæˆçš„å¦ä¸€ä¸²éšæœºå­—èŠ‚ã€‚\nèº«ä»½éªŒè¯ï¼š å®¢æˆ·ç«¯ä½¿ç”¨é¢å‘è¯¥è¯ä¹¦çš„è¯ä¹¦é¢å‘æœºæ„éªŒè¯æœåŠ¡å™¨çš„ SSL è¯ä¹¦ã€‚æ­¤ä¸¾ç¡®è®¤æœåŠ¡å™¨æ˜¯å…¶å£°ç§°çš„èº«ä»½ï¼Œä¸”å®¢æˆ·ç«¯æ­£åœ¨ä¸è¯¥åŸŸçš„å®é™…æ‰€æœ‰è€…è¿›è¡Œäº¤äº’ã€‚\né¢„ä¸»å¯†é’¥ï¼š å®¢æˆ·ç«¯å†å‘é€ä¸€ä¸²éšæœºå­—èŠ‚ï¼Œå³â€œé¢„ä¸»å¯†é’¥ï¼ˆpremaster secretï¼‰â€ã€‚é¢„ä¸»å¯†é’¥æ˜¯ä½¿ç”¨å…¬é’¥åŠ å¯†çš„ï¼Œåªèƒ½ä½¿ç”¨æœåŠ¡å™¨çš„ç§é’¥è§£å¯†ã€‚ï¼ˆå®¢æˆ·ç«¯ä»æœåŠ¡å™¨çš„ SSL è¯ä¹¦ä¸­è·å¾—å…¬é’¥ã€‚ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨å…¬é’¥åŠ å¯†é¢„ä¸»å¯†é’¥ï¼Œç„¶åå‘é€ç»™æœåŠ¡ç«¯ã€‚\nç§é’¥è¢«ä½¿ç”¨ï¼šæœåŠ¡å™¨ä½¿ç”¨è‡ªå·±çš„ ç§é’¥ å¯¹é¢„ä¸»å¯†é’¥è¿›è¡Œè§£å¯†ã€‚\nç”Ÿæˆä¼šè¯å¯†é’¥ï¼šè‡³æ­¤ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç»è¿‡ä¸€ç³»åˆ—ä¿¡æ¯äº¤æ¢åï¼Œå„è‡ªéƒ½æ‹¥æœ‰äº†ä»¥ä¸‹æ•°æ®ï¼š\nå®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºæ•°\næœåŠ¡ç«¯ç”Ÿæˆçš„éšæœºæ•°\né¢„ä¸»å¯†é’¥\nç„¶åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‡ä½¿ç”¨å®¢æˆ·ç«¯éšæœºæ•°ã€æœåŠ¡å™¨éšæœºæ•°å’Œé¢„ä¸»å¯†é’¥ç”Ÿæˆ ä¼šè¯å¯†é’¥ã€‚åŒæ–¹åº”å¾—åˆ°ç›¸åŒçš„ç»“æœã€‚\nå®¢æˆ·ç«¯å°±ç»ªï¼šå®¢æˆ·ç«¯å‘é€ä¸€æ¡â€œå·²å®Œæˆâ€æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ã€‚\næœåŠ¡å™¨å°±ç»ªï¼šæœåŠ¡å™¨å‘é€ä¸€æ¡â€œå·²å®Œæˆâ€æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ã€‚\nå®ç°å®‰å…¨å¯¹ç§°åŠ å¯†ï¼šå·²å®Œæˆæ¡æ‰‹ï¼Œå¹¶ä½¿ç”¨ ä¼šè¯å¯†é’¥ ç»§ç»­è¿›è¡Œé€šä¿¡ï¼Œä¹‹åçš„é€šä¿¡éƒ½ä¼šä½¿ç”¨è¯¥å¯†é’¥ï¼Œä»¥ å¯¹ç§°åŠ å¯† çš„æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚\nå…·ä½“çš„æµç¨‹å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¦‚æ‹¬ï¼š\nå›¾ç‰‡æ¥æºï¼šhttps://segmentfault.com/a/1190000021559557\nç–‘é—® ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨éå¯¹ç§°åŠ å¯†è¿›è¡Œé€šä¿¡ï¼Ÿ\néå¯¹ç§°åŠ å¯†çš„è®¡ç®—é‡æ¯”è¾ƒå¤§ï¼ŒåŠ è§£å¯†é€Ÿåº¦è¾ƒæ…¢ï¼Œå› æ­¤åœ¨æ•°æ®é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨éå¯¹ç§°åŠ å¯†è¿›è¡ŒåŠ è§£å¯†ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä¸åˆ©äºé«˜æ•ˆçš„é€šä¿¡ã€‚è€Œå¯¹ç§°åŠ å¯†çš„è®¡ç®—é‡è¾ƒå°ï¼ŒåŠ è§£å¯†é€Ÿåº¦è¾ƒå¿«ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ»¡è¶³æ•°æ®ä¼ è¾“çš„éœ€æ±‚ã€‚å› æ­¤ï¼ŒTLS åœ¨æ¡æ‰‹é˜¶æ®µä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥åå•†å¯¹ç§°å¯†é’¥ï¼Œå¹¶ä¸”ä¹‹åçš„é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨å¯¹ç§°åŠ å¯†æ–¹å¼ï¼Œä»¥ä¿è¯é€šä¿¡çš„å®‰å…¨æ€§å’Œé«˜æ•ˆæ€§ã€‚\n","date":"2022å¹´07æœˆ14æ—¥","permalink":"/posts/tls_wo_shou/","summary":"æ³¨ï¼šä»¥ä¸‹å†…å®¹å¼•ç”¨è‡ª cloudflare å­¦ä¹ ä¸­å¿ƒ\nTLS æ¡æ‰‹æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ TLS æ¡æ‰‹æ˜¯ç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤æ¢çš„ä¸€ç³»åˆ—æ•°æ®æŠ¥æˆ–æ¶ˆæ¯ã€‚TLS æ¡æ‰‹æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œå› ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¦äº¤æ¢å®Œæˆæ¡æ‰‹å’Œè¿›è¡Œè¿›ä¸€æ­¥å¯¹è¯æ‰€éœ€çš„ä¿¡æ¯ã€‚","title":"TLS æ¡æ‰‹æµç¨‹"},{"contents":" ä»è¯·æ±‚ URL ä¸­è·å–è¯·æ±‚åŸŸåï¼Œé€šè¿‡ DNS è·å–åŸŸåå¯¹åº”çš„ IP åœ°å€\né¦–å…ˆéœ€è¦çŸ¥é“ DNS åŸŸåæœåŠ¡å™¨ çš„ IP åœ°å€ï¼Œè¿™æ ·æ‰èƒ½ç»™å®ƒå‘é€ DNS è¯·æ±‚æŠ¥æ–‡ï¼Œè€Œæ ¹æ®ç½‘ç»œæ¨¡å‹ï¼Œå…‰æœ‰ IP åœ°å€æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦çŸ¥é“ MAC åœ°å€æ‰èƒ½æ„å»ºæ•°æ®é“¾è·¯å±‚çš„æŠ¥æ–‡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ ARP åè®®æ¥æ ¹æ® IP è·å–å¯¹åº”çš„ MAC åœ°å€ã€‚åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€ä¸€èˆ¬æ˜¯é»˜è®¤é…ç½®å¥½çš„ï¼Œæ‰€ä»¥è¿™é‡Œå‡å®šå·²ç»çŸ¥é“äº† IP åœ°å€ï¼Œåªéœ€è¦è·å– MAC åœ°å€ã€‚\né¦–å…ˆï¼Œä¸»æœºä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„ ARP è¡¨ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¯¥ IP ç¼“å­˜è®°å½•ï¼Œæœ‰çš„è¯å¯ä»¥ç›´æ¥è·å–åˆ°å¯¹åº”çš„ MAC åœ°å€ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±éœ€è¦æ„å»ºä¸€ä¸ª ARP è¯·æ±‚æŠ¥æ–‡ï¼Œæº IP å’Œæº MAC å¡«å†™è‡ªå·±çš„ï¼Œç›®çš„ IP å¡«å†™åŸŸåæœåŠ¡å™¨çš„ï¼Œç›®çš„ MAC å¡«å†™å¹¿æ’­åœ°å€ï¼ˆFF-FF-FF-FF-FF-FF-FFï¼‰ï¼Œç„¶åè¿™ä¸ªæŠ¥æ–‡ä¼šå‘é€ç»™å½“å‰å­ç½‘çš„æ‰€æœ‰ä¸»æœºï¼Œæ¯ä¸ªä¸»æœºä¼šæŸ¥çœ‹æŠ¥æ–‡é‡Œçš„ç›®çš„ IP åœ°å€æ˜¯å¦ä¸è‡ªå·±çš„ IP åœ°å€ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œå°±ä¼šå›å¤ ARP å“åº”æŠ¥æ–‡ï¼Œé‡Œé¢æœ‰è‡ªå·±çš„ MAC åœ°å€ï¼›å¦‚æœä¸ç›¸åŒåˆ™ä¼šç›´æ¥ä¸¢å¼ƒæŠ¥æ–‡ã€‚ä¸»æœºè·å¾—åŸŸåæœåŠ¡å™¨çš„ MAC åœ°å€åï¼Œè®°å½•åˆ°è‡ªå·±çš„ ARP è¡¨ä¸­ï¼Œè‡³æ­¤ï¼Œä¸»æœºå·²ç»è·å–åˆ°åŸŸåæœåŠ¡å™¨çš„ MAC åœ°å€äº†ã€‚\nçŸ¥é“äº†åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€å’Œ MAC åœ°å€åï¼Œå°±å¯ä»¥å‘å…¶å‘é€ DNS è¯·æ±‚æŠ¥æ–‡äº†ï¼ŒDNS è¯·æ±‚æŠ¥æ–‡åœ¨è¿è¾“å±‚è¢«å°è£…ä¸º UDP ç”¨æˆ·æ•°æ®æŠ¥ï¼Œç›®çš„ç«¯å£å·ä¸º 53ï¼›UDP ç”¨æˆ·æ•°æ®æŠ¥åœ¨ç½‘ç»œå±‚è¢«å°è£…ä¸º IP æ•°æ®åŒ…ï¼Œç›®çš„ IP åœ°å€ä¸ºåŸŸåæœåŠ¡å™¨çš„ IP åœ°å€ï¼›IP æ•°æ®æŠ¥è¢«å°è£…åœ¨ä»¥å¤ªå•æ’­å¸§ä¸­å‘é€ï¼Œç›®çš„ MAC åœ°å€ä¸ºä¹‹å‰ ARP è¯·æ±‚è·å¾—çš„ MAC åœ°å€ï¼Œè¯¥å•æ’­å¸§é€šè¿‡äº¤æ¢æœºè½¬å‘ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œæœ¬åœ°åŸŸåæœåŠ¡å™¨åœ¨æ”¶åˆ°æŠ¥æ–‡åé€å±‚è§£å°ï¼ŒçŸ¥é“è¿™æ˜¯ä¸€ä¸ª DNS è¯·æ±‚ï¼Œäºæ˜¯è¿›å…¥åŸŸåè§£æé˜¶æ®µã€‚ç»™ä¸»æœºå‘é€ DNS å“åº”æŠ¥æ–‡ï¼Œé‡Œé¢åŒ…å«äº†åŸŸåå¯¹åº”çš„ IP åœ°å€ã€‚\nåŸŸåè§£æ\næ ¹æ®åŸŸåçš„å±‚çº§å…³ç³»ï¼Œç”±å¤§åˆ°å°ä¸ºï¼šæ ¹åŸŸã€é¡¶çº§åŸŸã€æƒå¨åŸŸï¼Œå±‚çº§ä»£è¡¨çš„æ„æ€æ˜¯ï¼šé«˜å±‚çº§é‡Œé¢ä¿å­˜äº†ä¸‹ä¸€å±‚çº§çš„åŸŸååˆ° IP çš„æ˜ å°„è®°å½•ï¼Œå¯¹åº”åˆ°åŸŸåæ˜¯ä»å³å¾€å·¦ï¼Œä¹Ÿå°±æ˜¯å³è¾¹æœ€å¤§ï¼Œå·¦è¾¹æœ€å°ï¼Œæ¯”å¦‚ www.baidu.com è¿™ä¸ªåŸŸåï¼Œï¼ˆæœ€é«˜å±‚çš„æ ¹åŸŸåœ¨è¿™ä¸ªåŸŸåé‡Œæ²¡æœ‰ä½“ç°å‡ºæ¥ï¼Œçœ‹äº†ä¸‹åˆ«çš„åšå®¢ï¼Œè¯´çš„æ˜¯å®é™…æ˜¯æœ€åè¿˜æœ‰ä¸€ä¸ªéšè—çš„ . ä»£è¡¨çš„å°±æ˜¯æ ¹åŸŸåï¼Œè¿™é‡Œæš‚æ—¶å…ˆä¸ç ”ç©¶äº†ï¼‰ï¼Œæ ¹åŸŸé‡Œä¿å­˜çš„ä¸‹ä¸€çº§é¡¶çº§åŸŸçš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯æœ€å³è¾¹çš„ .com çš„è®°å½•ï¼Œè€Œ .com åˆä¿å­˜äº† baidu.com è¿™ä¸ªæƒå¨åŸŸçš„è®°å½•ï¼Œæœ€ç»ˆå†ä» baidu.com è¿™ä¸ªæƒå¨åŸŸé‡Œé¢æ‰¾åˆ°æœ€ç»ˆçš„åŸŸå www.baidu.com çš„è®°å½• æ„å»º HTTP è¯·æ±‚æŠ¥æ–‡\nè¿è¾“å±‚å°è£…åº”ç”¨å±‚çš„ HTTP æŠ¥æ–‡\nå› ä¸º HTTP åº•å±‚ä½¿ç”¨çš„è¿è¾“å±‚åè®®æ˜¯ TCPï¼Œæ‰€ä»¥ä¼šå°†åº”ç”¨å±‚çš„æŠ¥æ–‡å°è£…åˆ°ä¸€ä¸ª TCP æŠ¥æ–‡ä¸­ï¼Œç„¶åæ·»åŠ ä¸Š TCP çš„æŠ¥æ–‡å¤´ï¼Œç›®çš„ç«¯å£é€šè¿‡è¯·æ±‚çš„ URL è·å–ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä½¿ç”¨ HTTP é»˜è®¤çš„ 80 ç«¯å£ï¼Œæˆ–è€… HTTPS çš„é»˜è®¤ç«¯å£ 443ï¼Œæºç«¯å£å–å†³äºæ˜¯å¦æ˜¾å¼æŒ‡å®šï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šç”±ç³»ç»Ÿéšæœºåˆ†é…ä¸€ä¸ªã€‚ ç„¶åå°±å¯ä»¥å‘èµ·ä¸‰æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥äº† ç½‘ç»œå±‚å°è£…ä¼ è¾“å±‚çš„ TCP æŠ¥æ–‡\nå’Œè¿è¾“å±‚ç±»ä¼¼ï¼Œå°† TCP æŠ¥æ–‡å°è£…åˆ°ä¸€ä¸ª IP æ•°æ®æŠ¥ä¸­ï¼Œæ·»åŠ ä¸Š IP çš„æŠ¥æ–‡å¤´ï¼Œæºåœ°å€å¡«å†™è‡ªå·±çš„ IPï¼Œç›®çš„åœ°å€å¡«å†™ä¹‹å‰ä» DNS è·å–åˆ°çš„ IP MAC\nå¯ä»¥é€šè¿‡ ARP è·å–è¯·æ±‚ IP å¯¹åº”çš„ MAC åœ°å€ï¼Œè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šARP åªèƒ½åœ¨ä¸€ä¸ªå­ç½‘å†…å·¥ä½œï¼Œå¦‚æœè¯·æ±‚çš„ IP ä¸æ˜¯ä¸€ä¸ªå­ç½‘å†…çš„ï¼Œæ­¤æ—¶è¯¥å¦‚ä½•è·å–å¯¹åº”çš„ MAC åœ°å€å‘¢ï¼ŸåŸæ¥åœ¨æ¯ä¸ªå­ç½‘ä¸­ï¼Œéƒ½é…ç½®äº†ä¸€å°ç½‘å…³è·¯ç”±å™¨ï¼Œå®ƒè¿æ¥äº†å…¶ä»–å‡ ä¸ªå­ç½‘çš„äº¤æ¢æœºï¼Œå½“è¯·æ±‚çš„ IP ä¸å±äºåŒä¸€ä¸ªå­ç½‘æ—¶ï¼Œå°±éœ€è¦è¿™å°ç½‘å…³è·¯ç”±å™¨æ¥åšè½¬å‘ï¼ˆä¹Ÿå°±æ˜¯å°† MAC åœ°å€å¡«å†™ä¸ºè¿™ä¸ªç½‘å…³è·¯ç”±å™¨çš„ MAC åœ°å€ï¼‰ï¼Œä¼ é€’åˆ°å¦ä¸€ä¸ªå­ç½‘ï¼Œå…·ä½“å¦‚ä½•è½¬å‘å–å†³äºè·¯ç”±è¡¨ï¼Œæ•´ä¸ªæµç¨‹å°±åƒåå…¬äº¤ä½¿ç”¨åœ°å›¾å¯¼èˆªä¸€æ ·ï¼Œé€‰æ‹©ä¸€æ¡è·¯å¾„ï¼Œåœ¨ä¸åŒçš„å…¬äº¤ç«™é—´ç©¿æ¢­å‰è¿›ï¼Œç½‘ç»œä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå¤šä¸ªå­ç½‘ç›¸äº’è¿æ¥ç»„æˆä¸€ä¸ªå¤§ç½‘ç»œï¼Œæ•°æ®æŠ¥åœ¨è¿™äº›äº’è”çš„å­ç½‘ä¸­é€‰æ‹©ä¸€æ¡é“è·¯å‰è¿›ï¼Œç»è¿‡ä¸€ä¸ªä¸ªå­ç½‘ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®çš„åœ°ã€‚è¿™é‡Œä¹Ÿå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼š**åœ¨ç½‘ç»œåŒ…ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæº IP å’Œç›®æ ‡ IP å§‹ç»ˆæ˜¯ä¸ä¼šå˜çš„ï¼Œä¸€ç›´å˜åŒ–çš„æ˜¯ MAC åœ°å€ï¼Œå› ä¸ºéœ€è¦ MAC åœ°å€åœ¨ä»¥å¤ªç½‘å†…è¿›è¡Œä¸¤ä¸ªè®¾å¤‡ä¹‹é—´çš„åŒ…ä¼ è¾“ã€‚**å¯èƒ½è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦ IP å’Œ MAC ä¸¤ä¸ªåœ°å€çš„ä¸€ç‚¹åŸå› ã€‚ ","date":"2022å¹´07æœˆ14æ—¥","permalink":"/posts/url_dao_xian_shi_wang_ye_fa_shen_le_shen_me/","summary":"ä»è¯·æ±‚ URL ä¸­è·å–è¯·æ±‚åŸŸåï¼Œé€šè¿‡ DNS è·å–åŸŸåå¯¹åº”çš„ IP åœ°å€","title":"è¾“å…¥ url åˆ°æµè§ˆå™¨æ˜¾ç¤ºç½‘é¡µï¼ŒæœŸé—´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆæœªå®Œï¼‰"},{"contents":" å‚è€ƒï¼š https://www.bilibili.com/video/BV15V411n7fM?p=2\u0026amp;spm_id_from=pageDriver\u0026amp;vd_source=2ff613424b86c58a71ba91b7304ffe9b\næ€»è§ˆ mutex çš„æ•°æ®ç»“æ„ï¼š\ntype Mutex struct { state int32 sema uint32 } mutex é›¶å€¼å¯ç”¨ï¼Œä»£è¡¨ä¸€ä¸ªæœªé”å®šçš„é”ã€‚\nstate å­˜å‚¨çš„æ˜¯äº’æ–¥é”çš„çŠ¶æ€ï¼ŒåŠ é”å’Œè§£é”éƒ½æ˜¯é€šè¿‡ cas æ¥å®ç°çš„ åŠ é”ï¼šatomic.CompareAndSwapInt32(\u0026amp;m.state, 0, mutexLocked)ï¼Œå…¶ä¸­ mutexLocked = 1 è§£é”ï¼šatomic.AddInt32(\u0026amp;m.state, -mutexLocked)ï¼Œä»£è¡¨å°† state å˜ä¸º 0ï¼Œå› ä¸ºåªæœ‰åŠ é”çŠ¶æ€ä¸‹æ‰èƒ½è§£é”ï¼Œå¦‚æœå¯¹ä¸€ä¸ªæœªåŠ é”çš„é”æ‰§è¡Œè§£é”æ“ä½œä¼š panicï¼Œè€ŒåŠ é”çŠ¶æ€ä¸‹çš„ state = 1ï¼Œè¿™ä¸ªæ“ä½œåˆæ˜¯å°† state - 1ï¼Œæ‰€ä»¥ä¼šå°† state å˜ä¸º 0ã€‚\nsema ç”¨ä½œä¸€ä¸ªä¿¡å·é‡ï¼Œä¸»è¦ç”¨ä½œç­‰å¾…é˜Ÿåˆ—\nmutex æœ‰ä¸¤ç§æ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼ å’Œ é¥¥é¥¿æ¨¡å¼\nåœ¨ æ­£å¸¸æ¨¡å¼ ä¸‹ï¼Œä¸€ä¸ªå°è¯•åŠ é”çš„ goroutine ä¼šå…ˆè‡ªæ—‹å‡ æ¬¡ï¼Œå°è¯•é€šè¿‡åŸå­æ“ä½œè·å¾—é”ï¼Œè‹¥å‡ æ¬¡è‡ªæ—‹åä»ç„¶ä¸èƒ½è·å¾—é”ï¼Œåˆ™é€šè¿‡ä¿¡å·é‡æ’é˜Ÿç­‰å¾…ï¼ˆï¼Ÿå•¥å«é€šè¿‡ä¿¡å·é‡æ’é˜Ÿï¼Œä¿¡å·é‡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿï¼‰ï¼Œæ‰€æœ‰çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ’é˜Ÿã€‚\nä½†æ˜¯å½“é”é‡Šæ”¾ï¼Œç¬¬ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå¹¶ä¸ä¼šç›´æ¥æ‹¥æœ‰é”ï¼Œè€Œæ˜¯è¦å’Œåæ¥è€…ç«äº‰ï¼Œåæ¥è€…ä¹Ÿå°±æ˜¯æ–°çš„ goroutineï¼Œå®ƒä»¬å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œä¸”å°šæœªæ’é˜Ÿï¼Œè¿™äº›åæ¥è€…å› ä¸ºå æœ‰äº† CPUï¼Œä¸”æ•°é‡å¯èƒ½ä¸å°‘ï¼Œè€Œé˜Ÿåˆ—ä¸­è¢«å”¤é†’çš„ goroutine åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„ goroutine å¤§æ¦‚ç‡æŠ¢ä¸åˆ°é”ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¼šé‡æ–°æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚\nå½“ä¸€ä¸ª goroutine æœ¬æ¬¡åŠ é”ç­‰å¾…æ—¶é—´è¶…è¿‡äº† 1ms åï¼Œå®ƒä¼šæŠŠå½“å‰ mutex ä»æ­£å¸¸æ¨¡å¼åˆ‡æ¢åˆ° é¥¥é¥¿æ¨¡å¼ï¼Œåœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œmutex çš„æ‰€æœ‰æƒä»æ‰§è¡Œ unlock çš„ goroutine ç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨çš„ goroutineï¼Œåæ¥è€…ä¸ä¼šè‡ªæ—‹ï¼Œä¹Ÿä¸ä¼šå°è¯•è·å¾—é”ï¼Œè€Œæ˜¯ç›´æ¥åˆ°é˜Ÿå°¾æ’é˜Ÿç­‰å¾…ã€‚\nä½•æ—¶ä»é¥¥é¥¿æ¨¡å¼åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼ å½“ä¸€ä¸ªç­‰å¾…è€…è·å¾—é”ä¹‹åï¼Œå®ƒä¼šåœ¨ä»¥ä¸‹æƒ…å†µå°†é”ä»é¥¥é¥¿æ¨¡å¼åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼ï¼š\nå®ƒçš„ç­‰å¾…æ—¶é—´å°äº 1ms å®ƒæ˜¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯é™¤è‡ªå·±ä»¥å¤–æ²¡æœ‰å…¶ä»–ç­‰å¾…è€…äº†ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰é¥¥é¥¿çš„ goroutine äº†ã€‚ æ­£å¸¸æ¨¡å¼ä¸‹æ€§èƒ½æ›´å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°é˜Ÿåˆ—å°¾ç«¯çš„ goroutine è¿Ÿè¿ŸæŠ¢ä¸åˆ°é”çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å°¾ç«¯å»¶è¿Ÿï¼Œè€Œé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œgoroutine ä¸å†è‡ªæ—‹ï¼Œæ‰€æœ‰ goroutine éƒ½è¦æ’é˜Ÿï¼Œä¸¥æ ¼çš„å…ˆæ¥ååˆ°ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³å°¾ç«¯å»¶è¿Ÿé—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½ä¼šå·®ä¸€äº›ã€‚\n","date":"2022å¹´07æœˆ12æ—¥","permalink":"/posts/go-mutex-yuan-ma/","summary":"å‚è€ƒï¼š https://www.bilibili.com/video/BV15V411n7fM?p=2\u0026amp;spm_id_from=pageDriver\u0026amp;vd_source=2ff613424b86c58a71ba91b7304ffe9b\næ€»è§ˆ mutex çš„æ•°æ®ç»“æ„ï¼š","title":"go mutex åŸç†"},{"contents":"chan åŸç†ï¼ˆäººè¯ç‰ˆï¼‰ è¯´æ˜ï¼šè¿™é‡Œåªæ˜¯ç”¨å¤§ç™½è¯æ¥é˜è¿° chan çš„å¤§è‡´åŸç†ï¼Œä¸ä¿è¯ä¸¥è°¨æ€§ï¼Œä¹Ÿä¸è€ƒè™‘ä¸€äº›ç¹æç»†èŠ‚ï¼ˆæ¯”å¦‚ sudogï¼Œgoparkï¼Œgoreadyï¼‰ï¼Œä»…ä½œä¸ºä¸€ä¸ªç®€å•çš„å‚è€ƒç†è§£ï¼Œå¦‚æœæƒ³æ·±å…¥ç†è§£ chan çš„åº•å±‚å®ç°ï¼Œè¯·è‡ªè¡Œå‚é˜…å…¶ä»–åšå®¢\nchan åº•å±‚æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼šsendq å’Œ recvqï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¿å­˜çš„éƒ½æ˜¯è¢«é˜»å¡çš„ goroutineï¼ˆç®€ç§° gï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œsendq é‡Œé¢ä¿å­˜çš„æ˜¯å› ä¸ºå‘é€æ“ä½œè€Œè¢«é˜»å¡çš„ gï¼Œè€Œ recvq ä¿å­˜çš„æ˜¯å› ä¸ºæ¥æ”¶æ“ä½œè¢«é˜»å¡çš„ gï¼Œæ¯”å¦‚ï¼š\nfunc main() { ch := make(chan int) ch \u0026lt;- 1 } å› ä¸ºæ²¡æœ‰æ¥æ”¶è€…ï¼Œæ‰€ä»¥ ch \u0026lt;- 1 è¿™ä¸ªæ“ä½œä¼šè¢«é˜»å¡ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠæ‰§è¡Œè¿™ä¸ª chan çš„ g ç»™æ”¾åˆ° sendq ä¸­\nå½“æ‰§è¡Œ å‘é€ æ“ä½œæ—¶ï¼Œä¼šå…ˆçœ‹çœ‹ recvq ä¸­æœ‰æ²¡æœ‰å› ä¸ºæ¥æ”¶æ“ä½œè€Œè¢«é˜»å¡çš„ gï¼Œå¦‚æœæœ‰çš„è¯ï¼Œé‚£ä¹ˆå‡ºé˜Ÿ gï¼Œå¹¶å°†æ•°æ®æ‹·è´ç»™å®ƒï¼Œä¹‹åå†å°†å…¶å”¤é†’ï¼›\nåŒç†ï¼Œå½“æ‰§è¡Œ æ¥æ”¶ æ“ä½œæ—¶ï¼Œä¼šå…ˆçœ‹çœ‹ sendq ä¸­æœ‰æ²¡æœ‰å› ä¸ºå‘é€è€Œè¢«é˜»å¡çš„ gï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ‰§è¡Œå’Œä¸Šé¢ç›¸åŒçš„æ“ä½œã€‚\næ¯”å¦‚ï¼š\nfunc main() { ch := make(chan int) ch \u0026lt;- 1 go func() { v := \u0026lt;-ch }() } ch \u0026lt;- 1 è¿™ä¸ªæ“ä½œå¯¹åº”çš„ main goroutine è¢«é˜»å¡ï¼Œä¼šæ”¾åˆ° ch çš„ sendq ä¸­ï¼Œä¹‹åçš„ \u0026lt;-ch ä¼šæ£€æŸ¥ ch çš„ sendqï¼Œå‘ç°é‡Œé¢æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªå…ƒç´ å–å‡ºæ¥ï¼Œå¹¶å°†å€¼æ‹·è´ç»™æ¥æ”¶è€… vï¼Œå¹¶å”¤é†’ main goroutine ï¼Œè®©å…¶ä¸å†æ˜¯é˜»å¡çŠ¶æ€ã€‚\nç”¨è¿‡ chan çš„åŒå­¦éƒ½çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆè¿™é‡Œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿå…¶å®ä¹Ÿæ˜¯åŠ é”ï¼Œchan çš„åº•å±‚æœ‰ä¸€ä¸ª mutex é”æ¥å¯¹å…¶ä»–å­—æ®µè¿›è¡Œä¿æŠ¤ã€‚\næ­¤å¤–ï¼Œä¸Šé¢æåˆ°çš„å‘é€å’Œæ¥æ”¶æ“ä½œéƒ½æ˜¯åŸºäºæ— ç¼“å­˜çš„ chanï¼Œå¦‚æœæ˜¯æœ‰ç¼“å­˜çš„ chanï¼Œé‚£ä¹ˆæµç¨‹ä¼šæœ‰æ‰€ä¸åŒã€‚\nç¼“å­˜ï¼ˆç®€ç§° bufï¼‰åœ¨åº•å±‚å…¶å®æ˜¯ä¸€ä¸ª ç¯å½¢é˜Ÿåˆ—ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œè¿™é‡Œå°±ä¸å¤šé˜è¿°äº†ï¼Œå‘é€å’Œæ¥æ”¶çš„æµç¨‹å¦‚ä¸‹ï¼š\nå‘é€ï¼š\nå…ˆçœ‹çœ‹ recvq ä¸­æœ‰æ²¡æœ‰å…ƒç´ ï¼Œæœ‰çš„è¯ç›´æ¥æŒ‰ç…§ä¹‹å‰çš„æ“ä½œï¼Œå°†æ•°æ®æ‹·è´ç»™å¯¹åº”çš„æ¥æ”¶è€…ï¼Œå°±ä¸éœ€è¦ç»è¿‡ç¼“å­˜è¿™ä¸€éƒ¨åˆ†äº† å¦‚æœ recvq ä¸­æ²¡æœ‰å…ƒç´ ï¼Œåˆ™å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦å·²æ»¡ï¼Œåˆ™å°†æ•°æ®æ‹·è´åˆ°ç¼“å­˜ä¸­ï¼›å¦‚æœç¼“å­˜å·²æ»¡ï¼Œé‚£ä¹ˆå°†å½“å‰çš„ g é˜»å¡å¹¶æ”¾åˆ° sendq ä¸­ æ¥æ”¶ï¼š\nå¦‚æœ sendq ä¸­æœ‰å…ƒç´ ï¼Œæ­¤æ—¶åˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š æ— ç¼“å­˜ chanï¼Œç›´æ¥å–å‡º sendq ä¸­çš„é˜Ÿå¤´ gï¼Œå¹¶å°† g çš„æ•°æ®æ‹·è´ç»™å½“å‰çš„æ¥æ”¶è€…ï¼Œå¹¶å”¤é†’è¯¥ g æœ‰ç¼“å­˜ chanï¼Œå…ˆä»ç¼“å­˜ä¸­å–å‡ºä¸€ä¸ªæ•°æ®ï¼ˆé€šè¿‡ recvx å–å‡ºï¼‰ï¼Œå¹¶æ‹·è´ç»™æ¥æ”¶è€…ï¼Œæ­¤æ—¶ç¼“å­˜ä¸­ç›¸å½“äºç©ºäº†ä¸€ä¸ªä½ç½®ï¼ˆç¯å½¢é˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨è¦†ç›–å€¼ä»£æ›¿æ˜¾å¼åˆ é™¤ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å–å‡º sendq ä¸­çš„é˜Ÿå¤´å…ƒç´ ï¼Œæ”¾åˆ°è¿™ä¸ªç©ºä½é‡Œ å¦‚æœ sendq ä¸ºç©ºï¼š çœ‹ç¼“å­˜é‡Œæœ‰æ²¡æœ‰å€¼ï¼Œæœ‰çš„è¯åˆ™å–å‡ºï¼Œå¹¶æ‰§è¡Œæ‹·è´æ“ä½œ ç¼“å­˜ä¸­æ²¡æœ‰å€¼ï¼Œå°†å½“å‰æ‰§è¡Œæ¥æ”¶æ“ä½œçš„ g é˜»å¡å¹¶æ”¾åˆ° recvq ä¸­ buf åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡ä¸¤ä¸ªå˜é‡ sendx å’Œ recvx æ¥å®Œæˆ ç¯å½¢ çš„æ“ä½œï¼Œé€šè¿‡ä¸‹å›¾æ¥è¿›è¡Œè¯´æ˜ï¼š\né™„ï¼šéƒ¨åˆ†æºç æ³¨é‡Š hchan // channel çš„æ•°æ®ç»“æ„ type hchan struct { // ç¯å½¢é˜Ÿåˆ—ï¼ˆbufï¼‰ä¸­å…ƒç´ çš„ä¸ªæ•° qcount uint // total data in the queue // ç¯å½¢é˜Ÿåˆ—å®¹é‡ï¼Œå³å¯ä»¥å­˜æ”¾çš„å…ƒç´ ä¸ªæ•° // å³ make(chan int, 2) çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä¸º 0 dataqsiz uint // size of the circular queue // æŒ‡é’ˆï¼ŒæŒ‡å‘ç¯å½¢é˜Ÿåˆ—å¤´èŠ‚ç‚¹ buf unsafe.Pointer // points to an array of dataqsiz elements // é˜Ÿåˆ—ä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å° elemsize uint16 // chan æ˜¯å¦å…³é—­ closed uint32 // é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°æ®ç±»å‹ elemtype *_type // element type // é˜Ÿåˆ—å·²å‘é€ä½ç½®çš„ç´¢å¼• sendx uint // send index // é˜Ÿåˆ—å·²æ¥æ”¶ä½ç½®çš„ç´¢å¼• recvx uint // receive index // sendq å’Œ recvq å­˜å‚¨äº†å½“å‰ Channel ç”±äºç¼“å†²åŒºç©ºé—´ä¸è¶³è€Œé˜»å¡çš„ Goroutine åˆ—è¡¨ï¼Œ // è¿™äº›ç­‰å¾…é˜Ÿåˆ—ä½¿ç”¨åŒå‘é“¾è¡¨ runtime.waitq è¡¨ç¤ºï¼š // type waitq struct { //\tfirst *sudog //\tlast *sudog // } // // é“¾è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯ runtime.sudog ç»“æ„ï¼š // ç­‰å¾…è¯»æ¶ˆæ¯çš„ goroutine é˜Ÿåˆ— // å­˜å‚¨è¯•å›¾ä» channel æ¥æ”¶æ•°æ®(\u0026lt;-ch)çš„é˜»å¡ goroutines recvq waitq // list of recv waiters // ç­‰å¾…å†™æ¶ˆæ¯çš„ goroutine é˜Ÿåˆ— // å­˜å‚¨è¯•å›¾å‘é€æ•°æ®(ch\u0026lt;-)åˆ° channel çš„é˜»å¡ goroutines sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G's status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex } chansend // å‘é€æ•°æ®åˆ° channel æ—¶ï¼Œç›´è§‚çš„ç†è§£æ˜¯å°†æ•°æ®æ”¾åˆ° chan çš„ç¯å½¢é˜Ÿåˆ—ä¸­ï¼Œä¸è¿‡ go åšäº†ä¸€äº›ä¼˜åŒ–ï¼š // å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç­‰å¾…æ¥æ”¶æ•°æ®çš„ groutineï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥å°†æ•°æ®å‘ç»™ Groutineï¼Œå”¤é†’ groutineï¼Œ // å°±ä¸æ”¾å…¥é˜Ÿåˆ—ä¸­äº†ã€‚å½“ç„¶è¿˜æœ‰å¦å¤–ä¸€ç§æƒ…å†µå°±æ˜¯ï¼šbuf å¦‚æœæ»¡äº†ï¼Œé‚£å°±åªèƒ½æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æœ‰ // æ•°æ®è¢«å–èµ°æ‰èƒ½å‘é€ã€‚ // æ ¸å¿ƒé€»è¾‘ï¼š // å¦‚æœ recvq ä¸ä¸ºç©ºï¼Œä» recvq ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…æ¥æ”¶æ•°æ®çš„ Groutineï¼Œå°†æ•°æ®å‘é€ç»™è¯¥ Groutine // å¦‚æœ recvq ä¸ºç©ºï¼Œæ‰å°†æ•°æ®æ”¾å…¥ buf ä¸­ // å¦‚æœ buf å·²æ»¡ï¼Œåˆ™å°†è¦å‘é€çš„æ•°æ®å’Œå½“å‰çš„ Groutine æ‰“åŒ…æˆ Sudog å¯¹è±¡æ”¾å…¥ sendqï¼Œ // å¹¶å°† groutine ç½®ä¸ºç­‰å¾…çŠ¶æ€ // ep æŒ‡å‘è¦å‘é€æ•°æ®çš„é¦–åœ°å€ // c chan // block æ˜¯å¦é˜»å¡ // callerpc è°ƒç”¨åœ°å€ // // æ¯”è¾ƒè¿·æƒ‘çš„æ˜¯è¿™ä¸ª block å‚æ•°ï¼Œblock æ˜¯ä¸ºäº†å®ç°å¦‚ä¸‹ä»£ç çš„è¯­ä¹‰ï¼š // å› ä¸ºåŠ äº† defaultï¼Œæ‰€ä»¥æ˜¯éé˜»å¡ // c := make(chan int) // // ... // select { // case \u0026lt;-c: // // ... // default: // // ... // } // // ä¸Šé¢è¿™æ®µä»£ç è¢«ç¼–è¯‘æˆå¯¹ selectnbsend çš„è°ƒç”¨ï¼š // if selectnbsend(c, v) { // ... foo //\t} else { // ... bar //\t} // // selectnbsend çš„å®ç°å¦‚ä¸‹ // func selectnbsend(c *hchan, elem unsafe.Pointer) (selected bool) { // block è®¾ç½®ä¸º false // return chansend(c, elem, false, getcallerpc()) // éé˜»å¡çš„å‘é€ // } func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { if c == nil { if !block { return false } gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\u0026quot;unreachable\u0026quot;) } if debugChan { print(\u0026quot;chansend: chan=\u0026quot;, c, \u0026quot;\\n\u0026quot;) } if raceenabled { racereadpc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(chansend)) } // Fast path: check for failed non-blocking operation without acquiring the lock. // // After observing that the channel is not closed, we observe that the channel is // not ready for sending. Each of these observations is a single word-sized read // (first c.closed and second full()). // Because a closed channel cannot transition from 'ready for sending' to // 'not ready for sending', even if the channel is closed between the two observations, // they imply a moment between the two when the channel was both not yet closed // and not ready for sending. We behave as if we observed the channel at that moment, // and report that the send cannot proceed. // // It is okay if the reads are reordered here: if we observe that the channel is not // ready for sending and then observe that it is not closed, that implies that the // channel wasn't closed during the first observation. However, nothing here // guarantees forward progress. We rely on the side effects of lock release in // chanrecv() and closechan() to update this thread's view of c.closed and full(). if !block \u0026amp;\u0026amp; c.closed == 0 \u0026amp;\u0026amp; full(c) { return false } var t0 int64 if blockprofilerate \u0026gt; 0 { t0 = cputicks() } // åŠ é” lock(\u0026amp;c.lock) // å¦‚æœå‘å·²å…³é—­çš„ channel ä¸­å‘é€æ•°æ®ï¼Œä¼šå¼•å‘ panic if c.closed != 0 { unlock(\u0026amp;c.lock) panic(plainError(\u0026quot;send on closed channel\u0026quot;)) } // blog1. ä»æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼ˆå­˜æ”¾ç­‰å¾…æ¥æ”¶çš„ goroutineï¼‰å–å‡º goroutineï¼Œ // å¦‚æœå–åˆ°æ•°æ®ï¼Œå°±å°†æ•°æ®ä¼ è¿‡å» // blog3. å¦‚æœç›®æ ‡ Channel æ²¡æœ‰è¢«å…³é—­å¹¶ä¸”å·²ç»æœ‰å¤„äºè¯»ç­‰å¾…çš„ Goroutineï¼Œ // é‚£ä¹ˆ runtime.chansend ä¼šä»æ¥æ”¶é˜Ÿåˆ— recvq ä¸­å–å‡ºæœ€å…ˆé™·å…¥ç­‰å¾…çš„ Goroutine // å¹¶ç›´æ¥å‘å®ƒå‘é€æ•°æ®ï¼š // å¦‚æœ recvq ä¸ä¸ºç©ºï¼Œä» recvq ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…æ¥æ”¶æ•°æ®çš„ Groutineï¼Œå°†æ•°æ®å‘é€ç»™è¯¥ Groutine if sg := c.recvq.dequeue(); sg != nil { // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). // æ‰¾åˆ°ä¸€ä¸ªç­‰å¾…çš„æ¥æ”¶è€…ã€‚æˆ‘ä»¬å°†è¦å‘é€çš„å€¼ç›´æ¥ä¼ é€’ç»™æ¥æ”¶è€…ï¼Œç»•è¿‡ chan bufï¼ˆå¦‚æœæœ‰ï¼‰ send(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) return true // è¿”å› } // åˆ°è¿™é‡Œè¯´æ˜ recvq ä¸ºç©ºï¼Œæ²¡æœ‰ç­‰å¾…æ¥æ”¶çš„ goroutineï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­ hchan.buf æ˜¯å¦å¯ç”¨ // å¯¹äºæœ‰ç¼“å†²çš„ channel æ¥è¯´ï¼Œå¦‚æœå½“å‰ç¼“å†²åŒº hchan.buf æœ‰å¯ç”¨ç©ºé—´ï¼Œé‚£ä¹ˆä¼šå°†æ•°æ®æ‹·è´è‡³ç¼“å†²åŒº // å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯æ— ç¼“å†² channelï¼Œåˆ™ c.dataqsiz = 0ï¼Œä¸æ»¡è¶³ c.qcount \u0026lt; c.dataqsiz æ¡ä»¶ if c.qcount \u0026lt; c.dataqsiz { // c.sendx æ˜¯å·²å‘é€çš„ç´¢å¼•ä½ç½®ï¼Œè¿™ä¸ªæ–¹æ³•é€šè¿‡æŒ‡é’ˆåç§»æ‰¾åˆ°ç´¢å¼•ä½ç½® // ç›¸å½“äº c.buf[c.sendx] // è®¡ç®—å‡ºä¸‹ä¸€ä¸ªå¯ä»¥å­˜å‚¨æ•°æ®çš„ä½ç½® // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) if raceenabled { racenotify(c, c.sendx, nil) } // typememmove ä¼šè°ƒç”¨ memmove æ–¹æ³•ï¼Œå®Œæˆæ•°æ®çš„æ‹·è´å·¥ä½œï¼Œæ˜¯ç”¨æ±‡ç¼–å®ç°çš„ // å°†è¦å‘é€çš„æ•°æ®æ‹·è´åˆ° buf ä¸­ typedmemmove(c.elemtype, qp, ep) // å‘é€ç´¢å¼•å· + 1 c.sendx++ // å› ä¸ºå­˜å‚¨æ•°æ®å…ƒç´ çš„ç»“æ„æ˜¯å¾ªç¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥å½“å½“å‰ç´¢å¼•å·å·²ç»åˆ°é˜Ÿæœ«æ—¶ï¼Œå°†ç´¢å¼•å·è°ƒæ•´åˆ°é˜Ÿå¤´ if c.sendx == c.dataqsiz { c.sendx = 0 } // å½“å‰å¾ªç¯é˜Ÿåˆ—ä¸­å­˜å‚¨å…ƒç´ æ•° + 1 c.qcount++ unlock(\u0026amp;c.lock) return true } // èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ç¼“å†²åŒºä¹Ÿå†™æ»¡äº† // å¯¹äºéé˜»å¡çš„æƒ…å†µï¼Œç›´æ¥è¿”å› if !block { unlock(\u0026amp;c.lock) return false } // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œæ„å‘³ç€ï¼š // 1. å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ channelï¼Œåˆ™å½“å‰ hchan.buf å·²æ»¡ï¼› // 2. å¦‚æœæ˜¯æ— ç¼“å†²çš„ channelï¼Œåˆ™å½“å‰æ²¡æœ‰æ¥æ”¶çš„ goroutine // æ­¤æ—¶ä¼šå°†å½“å‰å‘é€ goroutine ç½®äº sendq ä¸­æ’é˜Ÿï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸­æŒ‚èµ·ã€‚ // Block on the channel. Some receiver will complete our operation for us. gp := getg() // è·å–å½“å‰æ‰§è¡Œçš„ goroutine // æ‰§è¡Œ runtime.acquireSudog è·å– runtime.sudog ç»“æ„å¹¶è®¾ç½®è¿™ä¸€æ¬¡é˜»å¡å‘é€çš„ç›¸å…³ä¿¡æ¯ï¼Œ // ä¾‹å¦‚å‘é€çš„ Channelã€æ˜¯å¦åœ¨ select ä¸­å’Œå¾…å‘é€æ•°æ®çš„å†…å­˜åœ°å€ç­‰ mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil mysg.g = gp mysg.isSelect = false mysg.c = c gp.waiting = mysg gp.param = nil // å°†è¦å‘é€çš„æ•°æ®å’Œå½“å‰ goroutine æ‰“åŒ…æˆ sudog å¯¹è±¡æ”¾å…¥åˆ° sendq ä¸­ c.sendq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026amp;gp.parkingOnChan, 1) // gopark å°†å½“å‰ goroutine è½¬ä¸º waiting æ€ // åœ¨ç”¨æˆ·çœ‹æ¥ï¼Œå‘ channel å‘é€æ•°æ®çš„ä»£ç è¯­å¥ä¼šé˜»å¡ gopark(chanparkcommit, unsafe.Pointer(\u0026amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, 2) // Ensure the value being sent is kept alive until the // receiver copies it out. The sudog has a pointer to the // stack object, but sudogs aren't considered as roots of the // stack tracer. KeepAlive(ep) // someone woke us up. if mysg != gp.waiting { throw(\u0026quot;G waiting list is corrupted\u0026quot;) } gp.waiting = nil gp.activeStackChans = false closed := !mysg.success gp.param = nil if mysg.releasetime \u0026gt; 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg) if closed { if c.closed == 0 { throw(\u0026quot;chansend: spurious wakeup\u0026quot;) } panic(plainError(\u0026quot;send on closed channel\u0026quot;)) } return true } send // send processes a send operation on an empty channel c. // The value ep sent by the sender is copied to the receiver sg. // The receiver is then woken up to go on its merry way. // Channel c must be empty and locked. send unlocks c with unlockf. // sg must already be dequeued from c. // ep must be non-nil and point to the heap or the caller's stack. // // send åœ¨ recvq ä¸ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œsg å°±æ˜¯ä» recvq ä¸­å–å‡ºçš„ func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if raceenabled { if c.dataqsiz == 0 { racesync(c, sg) } else { // Pretend we go through the buffer, even though // we copy directly. Note that we need to increment // the head/tail locations only when raceenabled. racenotify(c, c.recvx, nil) racenotify(c, c.recvx, sg) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } } if sg.elem != nil { // ep -\u0026gt; sg sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) sg.success = true if sg.releasetime != 0 { sg.releasetime = cputicks() } // ä½¿å¾—ä¹‹å‰åœ¨æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª goroutine çš„çŠ¶æ€å˜ä¸º runnableï¼Œ // è¿™æ · go çš„è°ƒåº¦å™¨å°±å¯ä»¥é‡æ–°è®©è¯¥ goroutine å¾—åˆ°æ‰§è¡Œã€‚ goready(gp, skip+1) } chanrecv // chanrecv receives on channel c and writes the received data to ep. // ep may be nil, in which case received data is ignored. // If block == false and no elements are available, returns (false, false). // Otherwise, if c is closed, zeros *ep and returns (true, false). // Otherwise, fills in *ep with an element and returns (true, true). // A non-nil ep must point to the heap or the caller's stack. // // åœ¨é€šé“ c ä¸Šæ¥æ”¶å¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®å†™å…¥ epï¼Œep å¯èƒ½ä¸º nilï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®ä¼šè¢«å¿½ç•¥ï¼Œ // å¦‚æœ block == false å¹¶ä¸”æ²¡æœ‰å¯ç”¨çš„å…ƒç´ ï¼Œåˆ™è¿”å› (false, false)ï¼Œ // å¦åˆ™ï¼Œå¦‚æœ c å…³é—­ï¼Œåˆ™å°† ep æ¸…é›¶å¹¶è¿”å› (true, false)ã€‚ // å¦åˆ™ï¼Œç”¨ä¸€ä¸ªå…ƒç´ å¡«å…… ep å¹¶è¿”å› (true, true)ã€‚ // é nil ep å¿…é¡»æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚ // block è²Œä¼¼æ˜¯ç”¨äº select func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { // raceenabled: don't need to check ep, as it is always on the stack // or is new memory allocated by reflect. if debugChan { print(\u0026quot;chanrecv: chan=\u0026quot;, c, \u0026quot;\\n\u0026quot;) } if c == nil { // å¦‚æœ c ä¸ºç©ºä¸”æ˜¯éé˜»å¡è°ƒç”¨ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› (false,false) if !block { return } // é˜»å¡è°ƒç”¨ç›´æ¥ç­‰å¾… gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\u0026quot;unreachable\u0026quot;) } // Fast path: check for failed non-blocking operation without acquiring the lock. if !block \u0026amp;\u0026amp; empty(c) { // After observing that the channel is not ready for receiving, we observe whether the // channel is closed. // // Reordering of these checks could lead to incorrect behavior when racing with a close. // For example, if the channel was open and not empty, was closed, and then drained, // reordered reads could incorrectly indicate \u0026quot;open and empty\u0026quot;. To prevent reordering, // we use atomic loads for both checks, and rely on emptying and closing to happen in // separate critical sections under the same lock. This assumption fails when closing // an unbuffered channel with a blocked send, but that is an error condition anyway. if atomic.Load(\u0026amp;c.closed) == 0 { // Because a channel cannot be reopened, the later observation of the channel // being not closed implies that it was also not closed at the moment of the // first observation. We behave as if we observed the channel at that moment // and report that the receive cannot proceed. return } // The channel is irreversibly closed. Re-check whether the channel has any pending data // to receive, which could have arrived between the empty and closed checks above. // Sequential consistency is also required here, when racing with such a send. if empty(c) { // The channel is irreversibly closed and empty. if raceenabled { raceacquire(c.raceaddr()) } if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } } var t0 int64 if blockprofilerate \u0026gt; 0 { t0 = cputicks() } lock(\u0026amp;c.lock) if c.closed != 0 \u0026amp;\u0026amp; c.qcount == 0 { if raceenabled { raceacquire(c.raceaddr()) } unlock(\u0026amp;c.lock) if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } // å¦‚æœ sendq ä¸­æœ‰ goroutineï¼Œåˆ™å–å‡ºä¸€ä¸ªï¼Œå°†æ•°æ®å‘é€ç»™å®ƒ if sg := c.sendq.dequeue(); sg != nil { // Found a waiting sender. If buffer is size 0, receive value // directly from sender. Otherwise, receive from head of queue // and add sender's value to the tail of the queue (both map to // the same buffer slot because the queue is full). // // å¦‚æœæ˜¯æ— ç¼“å†² chanï¼Œåˆ™ç›´æ¥ä» sg ä¸­æ¥æ”¶æ•°æ®ï¼Œ // å¦‚æœæ˜¯æœ‰ç¼“å†² chanï¼Œåˆ™æ¥æ”¶ buf ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ•°æ®ï¼Œå¹¶å°† sg ä¸­çš„æ•°æ®æ”¾åˆ° buf çš„æœ«å°¾ recv(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) return true, true } // åˆ°è¿™é‡Œè¯´æ˜ sendq ä¸­æ²¡æœ‰ç­‰å¾…çš„ goroutine // å¦‚æœç¼“å†²åŒºä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±ä» buf ä¸­è·å– if c.qcount \u0026gt; 0 { // Receive directly from queue qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) } // ä»ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ° ep if ep != nil { typedmemmove(c.elemtype, ep, qp) } // typedmemclr çš„ä½œç”¨æ˜¯å°† ep æŒ‡å‘çš„ç±»å‹ä¸º elemtype çš„å†…å­˜å—ç½®ä¸º 0 å€¼ã€‚ // è¿™é‡Œå°±æ˜¯å°† buf[recvx] ç½®ä¸º 0ï¼Œå› ä¸ºè¿™é‡Œçš„å…ƒç´ å·²ç»æ‹·è´ç»™äº† ep typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- unlock(\u0026amp;c.lock) return true, true } // éé˜»å¡ï¼Œç›´æ¥è¿”å› if !block { unlock(\u0026amp;c.lock) return false, false } // åˆ°è¿™é‡Œè¯´æ˜å³æ²¡æœ‰ç­‰å¾…çš„ groutineï¼Œç¯å½¢é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œåˆ™é˜»å¡è¯¥ groutineï¼Œ // å¹¶å°† goroutine æ‰“åŒ…ä¸º sudog åŠ å…¥åˆ° recevq ç­‰å¾…é˜Ÿåˆ—ä¸­ // no sender available: block on this channel. gp := getg() // åˆ›å»º sudog mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg mysg.g = gp mysg.isSelect = false mysg.c = c gp.param = nil c.recvq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026amp;gp.parkingOnChan, 1) gopark(chanparkcommit, unsafe.Pointer(\u0026amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2) // someone woke us up if mysg != gp.waiting { throw(\u0026quot;G waiting list is corrupted\u0026quot;) } gp.waiting = nil gp.activeStackChans = false if mysg.releasetime \u0026gt; 0 { blockevent(mysg.releasetime-t0, 2) } success := mysg.success gp.param = nil mysg.c = nil releaseSudog(mysg) return true, success } recv // recv processes a receive operation on a full channel c. // There are 2 parts: // 1) The value sent by the sender sg is put into the channel // and the sender is woken up to go on its merry way. // 2) The value received by the receiver (the current G) is // written to ep. // For synchronous channels, both values are the same. // For asynchronous channels, the receiver gets its data from // the channel buffer and the sender's data is put in the // channel buffer. // Channel c must be full and locked. recv unlocks c with unlockf. // sg must already be dequeued from c. // A non-nil ep must point to the heap or the caller's stack. // // recv è¢« chanrecv() è°ƒç”¨ï¼Œè°ƒç”¨æ¡ä»¶æ˜¯ sendq ä¸­æœ‰ç­‰å¾…çš„ g // c: chan // sg: sendq ä¸­çš„ç­‰å¾… goroutine // ep: ç”¨æ¥æ¥æ”¶æ•°æ® func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { // å¦‚æœæ˜¯æ— ç¼“å†²åŒº chan if c.dataqsiz == 0 { if raceenabled { racesync(c, sg) } if ep != nil { // copy data from sender // å°† sgï¼ˆsendq ä¸­çš„å¯¹è±¡ï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ° ep ä¸­ recvDirect(c.elemtype, sg, ep) } // æœ‰ç¼“å†²åŒºchan } else { // Queue is full. Take the item at the // head of the queue. Make the sender enqueue // its item at the tail of the queue. Since the // queue is full, those are both the same slot. // // ç”±äºæœ‰å‘é€è€…åœ¨ç­‰å¾…ï¼Œæ‰€ä»¥ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡çš„ï¼Œå› ä¸º recv çš„ç¬¬äºŒä¸ªå‚æ•° sudog // ä¼ å…¥çš„æ˜¯è¢«é˜»å¡çš„å‘é€è€…ï¼Œåœ¨ chanrecv ä¸­çš„è¡¨ç°æ˜¯ï¼š // if sg := c.sendq.dequeue(); sg != nil { // recv(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) //\treturn true, true // } // qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) racenotify(c, c.recvx, sg) } // copy data from queue to receiver // å…ˆå°† buf ä¸­çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼ˆrecvxï¼‰ç§»åŠ¨åˆ° ep if ep != nil { typedmemmove(c.elemtype, ep, qp) } // copy data from sender to queue // å› ä¸ºå·²ç»å°† buf ä¸­çš„ä¸€ä¸ªæ•°æ®æ‹·è´ç»™ ep äº†ï¼Œç­‰äºæ­¤æ—¶çš„ ep å·²ç»ç©ºäº†ä¸€ä¸ª // ä½ç½®äº†ï¼Œæ‰€ä»¥å¯ä»¥å°† sudog ä¸­çš„å…ƒç´ æ”¾åˆ°è¿™ä¸ªç©ºä½ç½®é‡Œ // ä¸‹é¢çš„é€»è¾‘ä¹Ÿæ²¡æœ‰å¯¹ c.qcount è¿›è¡Œæ›´æ–°ï¼Œå› ä¸ºç§»é™¤äº†ä¸€ä¸ªååˆæ–°æ·»åŠ äº†ä¸€ä¸ª, // ç›¸å½“äºé•¿åº¦æ²¡æœ‰å‘ç”Ÿæ”¹å˜ typedmemmove(c.elemtype, qp, sg.elem) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } sg.elem = nil gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) sg.success = true if sg.releasetime != 0 { sg.releasetime = cputicks() } goready(gp, skip+1) } ","date":"2022å¹´06æœˆ26æ—¥","permalink":"/posts/go-chan-yuan-ma/","summary":"chan åŸç†ï¼ˆäººè¯ç‰ˆï¼‰ è¯´æ˜ï¼šè¿™é‡Œåªæ˜¯ç”¨å¤§ç™½è¯æ¥é˜è¿° chan çš„å¤§è‡´åŸç†ï¼Œä¸ä¿è¯ä¸¥è°¨æ€§ï¼Œä¹Ÿä¸è€ƒè™‘ä¸€äº›ç¹æç»†èŠ‚ï¼ˆæ¯”å¦‚ sudogï¼Œgoparkï¼Œgoreadyï¼‰ï¼Œä»…ä½œä¸ºä¸€ä¸ªç®€å•çš„å‚è€ƒç†è§£ï¼Œå¦‚æœæƒ³æ·±å…¥ç†è§£ chan çš„åº•å±‚å®ç°ï¼Œè¯·è‡ªè¡Œå‚é˜…å…¶ä»–åšå®¢","title":"go chan åŸç†ï¼ˆäººè¯ç‰ˆï¼‰"},{"contents":"127.0.0.1 127.0.0.1 æ˜¯ å›ç¯åœ°å€ï¼Œå½“æŠ¥æ–‡çš„ç›®çš„åœ°å€æ˜¯å›ç¯åœ°å€æ—¶ï¼Œä¾ç„¶ä¼šèµ°ä¸€éç½‘ç»œåè®®æ ˆï¼Œä½†æ˜¯ä¸ä¼šç»è¿‡ç‰©ç†ç½‘å¡ï¼Œè€Œæ˜¯ç»è¿‡ä¸€ä¸ªåä¸º lo çš„è™šæ‹Ÿç½‘å¡ï¼ˆmac ä¸Šäº¤ lo0ï¼‰ï¼Œå…·ä½“çš„æµç¨‹æ˜¯ï¼š\nä»åº”ç”¨å±‚åˆ°ä¼ è¾“å±‚å†åˆ°ç½‘ç»œå±‚ï¼Œåˆ°äº†ç½‘ç»œå±‚ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç›®çš„IPï¼Œåœ¨è·¯ç”±è¡¨ä¸­è·å–å¯¹åº”çš„è·¯ç”±ä¿¡æ¯ï¼Œè€Œè¿™å…¶ä¸­å°±åŒ…å«é€‰æ‹©å“ªä¸ªç½‘å¡æŠŠæ¶ˆæ¯å‘å‡ºã€‚\nå½“å‘ç° ç›®æ ‡IPæ˜¯å¤–ç½‘IP æ—¶ï¼Œä¼šä»\u0026quot;çœŸç½‘å¡\u0026quot;å‘å‡ºã€‚\nå½“å‘ç° ç›®æ ‡IPæ˜¯å›ç¯åœ°å€ æ—¶ï¼Œå°±ä¼šé€‰æ‹© æœ¬åœ°ç½‘å¡ã€‚\næœ¬åœ°ç½‘å¡ï¼Œå…¶å®å°±æ˜¯ä¸ª**\u0026ldquo;å‡ç½‘å¡\u0026rdquo;**ï¼Œå®ƒä¸åƒ\u0026quot;çœŸç½‘å¡\u0026quot;é‚£æ ·æœ‰ä¸ªring bufferä»€ä¹ˆçš„ï¼Œ\u0026ldquo;å‡ç½‘å¡\u0026quot;ä¼šæŠŠæ•°æ®æ¨åˆ°ä¸€ä¸ªå« input_pkt_queue çš„ é“¾è¡¨ ä¸­ã€‚è¿™ä¸ªé“¾è¡¨ï¼Œå…¶å®æ˜¯æ‰€æœ‰ç½‘å¡å…±äº«çš„ï¼Œä¸Šé¢æŒ‚ç€å‘ç»™æœ¬æœºçš„å„ç§æ¶ˆæ¯ã€‚æ¶ˆæ¯è¢«å‘é€åˆ°è¿™ä¸ªé“¾è¡¨åï¼Œä¼šå†è§¦å‘ä¸€ä¸ª è½¯ä¸­æ–­ã€‚\nä¸“é—¨å¤„ç†è½¯ä¸­æ–­çš„å·¥å…·äºº**\u0026ldquo;ksoftirqd\u0026rdquo;** ï¼ˆè¿™æ˜¯ä¸ªå†…æ ¸çº¿ç¨‹ï¼‰ï¼Œå®ƒåœ¨æ”¶åˆ°è½¯ä¸­æ–­åå°±ä¼šç«‹é©¬å»é“¾è¡¨é‡ŒæŠŠæ¶ˆæ¯å–å‡ºï¼Œç„¶åé¡ºç€æ•°æ®é“¾è·¯å±‚ã€ç½‘ç»œå±‚ç­‰å±‚å±‚å¾€ä¸Šä¼ é€’æœ€åç»™åˆ°åº”ç”¨ç¨‹åºã€‚\n**ä¹‹æ‰€ä»¥127.0.0.1å«æœ¬åœ°å›ç¯åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸ºï¼Œæ¶ˆæ¯å‘å‡ºåˆ°è¿™ä¸ªåœ°å€ä¸Šçš„è¯ï¼Œå°±ä¸ä¼šå‡ºç½‘ç»œï¼Œåœ¨æœ¬æœºæ‰“ä¸ªè½¬å°±åˆå›æ¥äº†ã€‚**æ‰€ä»¥æ–­ç½‘ï¼Œä¾ç„¶èƒ½ ping é€š 127.0.0.1ã€‚\nä»¥ä¸Šå†…å®¹æ‘˜è‡ªï¼š\nç¡¬æ ¸å›¾è§£ï¼æ–­ç½‘äº†ï¼Œè¿˜èƒ½pingé€š 127.0.0.1 å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿhttps://www.eet-china.com/mp/a67490.html\né—®é¢˜è®°å½•ï¼š\nping 127.0.0.1 èµ°ä¸èµ°ç‰©ç†ç½‘å¡ï¼Ÿ\nç½‘ä¸Šçš„åšå®¢æœ‰è¯´èµ°çš„ï¼ˆhttps://blog.csdn.net/bandaoyu/article/details/87259631ï¼Œ 127.0.0.1 å›ç¯åœ°å€ï¼Œä¸ç»è¿‡[é“¾è·¯å±‚ï¼Œç‰©ç†å±‚](ç½‘ç»œæ¥å£å±‚ï¼‰ï¼Œåœ¨IPå±‚å°±å›å»ï¼Œä¾èµ–ç½‘å¡ï¼Œå¹¶å—åˆ°ç½‘ç»œé˜²ç«å¢™å’Œç½‘å¡ç›¸å…³çš„é™åˆ¶ï¼‰ï¼Œä¹Ÿæœ‰è¯´ä¸èµ°çš„ï¼Œè¿™æ—¶åªèƒ½è‡ªå·±åŠ¨æ‰‹æµ‹è¯•äº†ï¼Œåˆšå¥½æœ‰å°é—²ç½®çš„ windows ç¬”è®°æœ¬å¯ä»¥æ‹¿æ¥æµ‹è¯•ï¼Œæ‰§è¡Œ netsh interface set interface wlan diable æ¥å…³é—­ç½‘å¡ï¼Œæ­¤æ—¶æ‰§è¡Œ ping 127.0.0.1ï¼Œå‘ç°æ˜¯å¯ä»¥ ping é€šçš„ï¼Œè¯´æ˜ 127.0.0.1 æ˜¯ä¸èµ°ç‰©ç†ç½‘å¡çš„ï¼Œä½†æ˜¯ä¼šèµ° lo è™šæ‹Ÿç½‘å¡\nhttps://www.zhihu.com/question/43590414\nlocalhost localhostæ˜¯ä¸ª åŸŸå ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª ip åœ°å€ã€‚ä¹‹æ‰€ä»¥æˆ‘ä»¬ç»å¸¸æŠŠ localhost ä¸ 127.0.0.1 è®¤ä¸ºæ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„å¤§å¤šæ•°ç”µè„‘ä¸Šéƒ½å°† localhost æŒ‡å‘äº†127.0.0.1è¿™ä¸ªåœ°å€ï¼Œåœ¨ linux ä¸­è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®æ˜¯ /etc/hosts ï¼š\n$ cat /etc/hosts # Your system has configured 'manage_etc_hosts' as True. # As a result, if you wish for changes to this file to persist # then you will need to either # a.) make changes to the master file in /etc/cloud/templates/hosts.debian.tmpl # b.) change or remove the value of 'manage_etc_hosts' in # /etc/cloud/cloud.cfg or cloud-config from user-data # 127.0.1.1 primary primary 127.0.0.1 localhost 0.0.0.0 0.0.0.0 å¯ä»¥ä½œä¸ºç›‘å¬åœ°å€ä½¿ç”¨ï¼Œä»£è¡¨ç›‘å¬æœ¬æœºçš„æ‰€æœ‰ IP åœ°å€ï¼ˆå¦‚æœä¸€å°æœºå™¨ä¸Šæœ‰å¤šä¸ªç½‘å¡ï¼Œå°±ä¼šæœ‰å¤šä¸ª IP åœ°å€ï¼‰ï¼Œå¯ä»¥åšä¸€ä¸ªå®è·µæµ‹è¯•ä¸€ä¸‹ï¼š\nå®è·µ åˆ›å»ºä¸€å—è™šæ‹Ÿç½‘å¡ï¼ˆåœ¨è™šæ‹Ÿæœºä¸Šï¼‰ï¼š\n$ ifconfig enp0s1:0 192.168.64.8 up è¯­å¥æ ¼å¼æ˜¯ï¼šifconfig [ç°æœ‰ç½‘å¡åç§°]:[ä»»æ„å€¼,ä¹Ÿå¯ä»¥ä¸ºç©º] [è™šæ‹Ÿç½‘å¡çš„ IP] up\næŒ‰ç…§ä¸Šé¢çš„æ ¼å¼ï¼Œç»§ç»­åˆ›å»ºå¤šå—è™šæ‹Ÿç½‘å¡ï¼š\n$ ifconfig enp0s1: 192.168.64.9 up $ ifconfig enp0s1:__ 192.168.64.10 up æŸ¥çœ‹ç°åœ¨çš„ç½‘å¡æƒ…å†µï¼š\n$ ifconfig enp0s1: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 192.168.64.7 netmask 255.255.255.0 broadcast 192.168.64.255 inet6 fe80::5054:ff:fe97:e2bd prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; inet6 fd02:feab:6557:b7c6:5054:ff:fe97:e2bd prefixlen 64 scopeid 0x0\u0026lt;global\u0026gt; ether 52:54:00:97:e2:bd txqueuelen 1000 (Ethernet) RX packets 45586 bytes 61327352 (61.3 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 27086 bytes 2915213 (2.9 MB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 enp0s1:0: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 192.168.64.8 netmask 255.255.255.0 broadcast 192.168.64.255 ether 52:54:00:97:e2:bd txqueuelen 1000 (Ethernet) enp0s1:: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 192.168.64.9 netmask 255.255.255.0 broadcast 192.168.64.255 ether 52:54:00:97:e2:bd txqueuelen 1000 (Ethernet) enp0s1:__: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 192.168.64.10 netmask 255.255.255.0 broadcast 192.168.64.255 ether 52:54:00:97:e2:bd txqueuelen 1000 (Ethernet) ç”¨ Go å†™ä¸€ä¸ª TCP server è¿›è¡Œæµ‹è¯•ï¼š\npackage main import ( \u0026quot;net\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;flag\u0026quot; ) var host = flag.String(\u0026quot;h\u0026quot;, \u0026quot;127.0.0.1\u0026quot;, \u0026quot;listen host\u0026quot;) var port = flag.String(\u0026quot;p\u0026quot;, \u0026quot;8080\u0026quot;, \u0026quot;listen port\u0026quot;) func main() { flag.Parse() addr := fmt.Sprintf(\u0026quot;%v:%v\u0026quot;, *host, *port) l, err := net.Listen(\u0026quot;tcp\u0026quot;, addr) if err != nil { panic(err) } fmt.Printf(\u0026quot;listen in %v\\n\u0026quot;, addr) for { conn, err := l.Accept() if err != nil { fmt.Println(\u0026quot;accept error: \u0026quot;, err) continue } if _, err := conn.Write([]byte(\u0026quot;Hello\\n\u0026quot;)); err != nil { fmt.Println(\u0026quot;write error: \u0026quot;, err) continue } conn.Close() } } è¿è¡Œç¨‹åºï¼ˆè™šæ‹Ÿæœºä¸Šï¼‰ï¼š\n$ go run hello_tcpserver.go -h 0.0.0.0 listen in 0.0.0.0:8080 åœ¨ å®¿ä¸»æœº ä¸Šæµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼š\n$ nc 192.168.64.7 8080 Hello $ nc 192.168.64.8 8080 Hello $ nc 192.168.64.9 8080 Hello $ nc 192.168.64.10 8080 Hello å‘ç°ä½¿ç”¨ä»»æ„ä¸€ä¸ª IP åœ°å€éƒ½å¯ä»¥è®¿é—®åˆ°æœåŠ¡\næ­¤å¤–ï¼Œæœ‰çš„åšå®¢é‡Œè¯´ 0.0.0.0 æ˜¯ ping ä¸é€šçš„ï¼Œä½†æ˜¯åœ¨æˆ‘çš„è™šæ‹Ÿæœºä¸Šå´å¹¶éå¦‚æ­¤ï¼š\n$ uname -a Linux primary 5.4.0-120-generic #136-Ubuntu SMP Fri Jun 10 13:46:10 UTC 2022 aarch64 aarch64 aarch64 GNU/Linux $ ping 0.0.0.0 PING 0.0.0.0 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.299 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.091 ms 64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.076 ms 64 bytes from 127.0.0.1: icmp_seq=4 ttl=64 time=0.108 ms ^C --- 0.0.0.0 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3244ms rtt min/avg/max/mdev = 0.076/0.143/0.299/0.090 ms ä¸çŸ¥é“ä»€ä¹ˆæƒ…å†µ\nç›‘å¬ 127.0.0.1 å’Œ ç›‘å¬ 0.0.0.0 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\nç›‘å¬ 127.0.0.1 çš„è¯å°±åªèƒ½åœ¨æœ¬åœ°è®¿é—®äº†ï¼Œå¤–éƒ¨æ˜¯æ— æ³•è®¿é—®çš„ï¼Œlocalhost å½“ç„¶ä¹Ÿæ˜¯ä¸€æ ·çš„\næµ‹è¯•ï¼š\n$ go run hello_tcpserver.go -h localhost listen in localhost:8080 åœ¨å®¿ä¸»æœºä¸Šï¼š\n$ nc -v 192.168.64.9 8080 nc: connectx to 192.168.64.9 port 8080 (tcp) failed: Connection refused è¯´åˆ°è¿™é‡Œåˆè®©æˆ‘æƒ³èµ·äº†ä¸€ä»¶äº‹ï¼šä¹‹å‰æˆ‘éƒ¨ç½²è¿‡ä¸€ä¸ª Go HTTP å°ç¨‹åºåˆ°è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šï¼Œå½“æ—¶ listen çš„åœ°å€å°±æ˜¯ localhostï¼Œä½†æ˜¯ä»å¤–éƒ¨ä¾ç„¶èƒ½å¤Ÿè®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œè²Œä¼¼æ˜¯å› ä¸ºå½“æ—¶æ˜¯ç”¨ docker éƒ¨ç½²çš„ï¼Œåšäº†ç«¯å£æ˜ å°„ï¼Œæ‰€ä»¥æ‰å¯ä»¥è®¿é—®åˆ°\n","date":"2022å¹´06æœˆ24æ—¥","permalink":"/posts/127.0.0.1_localhost_0.0.0.0/","summary":"127.0.0.1 127.0.0.1 æ˜¯ å›ç¯åœ°å€ï¼Œå½“æŠ¥æ–‡çš„ç›®çš„åœ°å€æ˜¯å›ç¯åœ°å€æ—¶ï¼Œä¾ç„¶ä¼šèµ°ä¸€éç½‘ç»œåè®®æ ˆï¼Œä½†æ˜¯ä¸ä¼šç»è¿‡ç‰©ç†ç½‘å¡ï¼Œè€Œæ˜¯ç»è¿‡ä¸€ä¸ªåä¸º lo çš„è™šæ‹Ÿç½‘å¡ï¼ˆmac ä¸Šäº¤ lo0ï¼‰ï¼Œå…·ä½“çš„æµç¨‹æ˜¯ï¼š","title":"127.0.0.1ï¼Œlocalhostï¼Œ0.0.0.0 çš„åŒºåˆ«ï¼ˆåŒ…å«è™šæ‹Ÿç½‘å¡ç›¸å…³æ“ä½œï¼‰"},{"contents":" è¯¥æ–‡ç« ä»…ä½œä¸ºæœ¬äººç¬”è®°ï¼Œä¸å…·å¤‡å¤ªå¤§çš„å‚è€ƒä»·å€¼\nè¯¥æ–‡ç« ç€é‡è®°å½•æºç ï¼Œæ²¡æœ‰å¯¹ç†”æ–­å™¨è¿™ä¸€æ¦‚å¿µåšè¿‡å¤šç†å¿µä¸Šçš„è¯´æ˜è§£é‡Š\nè¯¥æ–‡ç« æ’ç‰ˆã€æ€è·¯è¾ƒä¸ºæ··ä¹±ï¼Œåç»­å¯èƒ½ä¼šè¿›è¡Œä¿®æ”¹\nç¤ºä¾‹ å®˜æ–¹ç¤ºä¾‹ å®˜æ–¹ç¤ºä¾‹æœ‰ç‚¹å¤ªç®€å•äº†ï¼Œå®Œå…¨æ— æ³•ä½“ä¼šåˆ° ç†”æ–­ è¿™ä¸€æ¦‚å¿µ\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;github.com/sony/gobreaker\u0026quot; ) var cb *gobreaker.CircuitBreaker func init() { var st gobreaker.Settings st.Name = \u0026quot;HTTP GET\u0026quot; st.ReadyToTrip = func(counts gobreaker.Counts) bool { failureRatio := float64(counts.TotalFailures) / float64(counts.Requests) return counts.Requests \u0026gt;= 3 \u0026amp;\u0026amp; failureRatio \u0026gt;= 0.6 } cb = gobreaker.NewCircuitBreaker(st) } // Get wraps http.Get in CircuitBreaker. func Get(url string) ([]byte, error) { body, err := cb.Execute(func() (interface{}, error) { resp, err := http.Get(url) if err != nil { return nil, err } defer resp.Body.Close() body, err := ioutil.ReadAll(resp.Body) if err != nil { return nil, err } return body, nil }) if err != nil { return nil, err } return body.([]byte), nil } func main() { body, err := Get(\u0026quot;http://www.google.com/robots.txt\u0026quot;) if err != nil { log.Fatal(err) } fmt.Println(string(body)) } æˆ‘çš„ç¤ºä¾‹ å…ˆå†™ä¸€ä¸ª http serverï¼Œä»–ä¼šéšæœºä¸ºè¯·æ±‚è¿”å› 200 æˆ–è€… 500\npackage main import ( \u0026quot;math/rand\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;time\u0026quot; ) var canVisit bool func main() { rand.Seed(time.Now().Unix()) go func() { for { t := rand.Int63n(10) select { case \u0026lt;-time.After(time.Duration(t) * time.Second): canVisit = !canVisit } } }() http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { if canVisit { w.WriteHeader(http.StatusInternalServerError) w.Write([]byte(\u0026quot;server error\u0026quot;)) } else { w.WriteHeader(http.StatusOK) w.Write([]byte(\u0026quot;success\u0026quot;)) } }) if err := http.ListenAndServe(\u0026quot;:9000\u0026quot;, nil); err != nil { panic(err) } } ç†”æ–­å™¨ç¨‹åºï¼Œä¼šä¸€ç›´è®¿é—®ä¸Šé¢çš„ http serverï¼Œè¿”å› 200 ç®—è¯·æ±‚æˆåŠŸï¼Œ500 ç®—å¤±è´¥ï¼Œæ¥è§‚å¯Ÿç†”æ–­å™¨çš„çŠ¶æ€å’Œæ•ˆæœï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;time\u0026quot; \u0026quot;github.com/sony/gobreaker\u0026quot; ) var cb *gobreaker.CircuitBreaker func init() { var st gobreaker.Settings st.Name = \u0026quot;HTTP GET\u0026quot; st.ReadyToTrip = func(counts gobreaker.Counts) bool { failureRatio := float64(counts.TotalFailures) / float64(counts.Requests) return counts.Requests \u0026gt;= 3 \u0026amp;\u0026amp; failureRatio \u0026gt;= 0.5 } st.Timeout = time.Second * 10\t// ä»å¼€å¯åˆ‡æ¢åˆ°åŠå¼€çš„æ—¶é—´ st.OnStateChange = func(name string, from, to gobreaker.State) { log.Printf(\u0026quot;state change: [%v] -\u0026gt; [%v]\\n\u0026quot;, from, to) } cb = gobreaker.NewCircuitBreaker(st) } func Get(url string) ([]byte, error) { body, err := cb.Execute(func() (interface{}, error) { resp, err := http.Get(url) if err != nil { return nil, err } defer resp.Body.Close() if resp.StatusCode \u0026gt;= 400 { return nil, fmt.Errorf(\u0026quot;[%v]%v\u0026quot;, resp.StatusCode, http.StatusText(resp.StatusCode)) } body, err := ioutil.ReadAll(resp.Body) if err != nil { return nil, err } return body, nil }) if err != nil { return nil, err } return body.([]byte), nil } func main() { for { body, err := Get(\u0026quot;http://localhost:9000\u0026quot;) if err != nil { log.Println(err) } log.Printf(\u0026quot;%v, %+v\\n\u0026quot;, cb.State(), cb.Counts()) fmt.Println(string(body)) time.Sleep(time.Millisecond * 500) } } è¾“å‡ºæ—¥å¿—ï¼š\n2022/06/10 22:02:36 closed, {Requests:1 TotalSuccesses:1 TotalFailures:0 ConsecutiveSuccesses:1 ConsecutiveFailures:0} .... 2022/06/10 22:03:26 [500]Internal Server Error 2022/06/10 22:03:26 closed, {Requests:101 TotalSuccesses:51 TotalFailures:50 ConsecutiveSuccesses:0 ConsecutiveFailures:8} 2022/06/10 22:03:26 state change: [closed] -\u0026gt; [open] 2022/06/10 22:03:26 [500]Internal Server Error 2022/06/10 22:03:26 open, {Requests:0 TotalSuccesses:0 TotalFailures:0 ConsecutiveSuccesses:0 ConsecutiveFailures:0} ç¬¬äºŒæ®µæ—¥å¿—è®°å½•äº†é”™è¯¯ï¼Œæ­¤æ—¶çš„æ€»è¯·æ±‚æ¬¡æ•°æ˜¯ 101ï¼Œæ€»é”™è¯¯æ˜¯ 50ï¼Œè¿˜æ²¡è¾¾åˆ° ReadyToTrip çš„æ¡ä»¶ï¼ˆé”™è¯¯ç‡ \u0026gt;= 50%ï¼‰ï¼Œç„¶åç¬¬ä¸‰æ®µæ—¥å¿—ï¼Œå‘ç°æ­¤æ—¶è¯·æ±‚ä¾ç„¶å¤±è´¥ï¼Œæ­¤æ—¶æ€»è¯·æ±‚ 102ï¼Œæ€»é”™è¯¯ 51ï¼Œè¾¾åˆ°äº† 50%ï¼Œæ‰€ä»¥å‘ç”Ÿäº†çŠ¶æ€è½¬æ¢ï¼Œç†”æ–­å™¨è¿›è¡Œå¼€å¯æ¨¡å¼ã€‚\nåç»­åº”è¯¥ä¼šä¸€ç›´ä¿æŒå¼€å¯çŠ¶æ€ï¼Œç›´åˆ° 10s ååˆ‡æ¢ä¸ºåŠå¼€çŠ¶æ€ï¼Œè¿™é‡Œæ—¥å¿—å°±æ²¡è®°å½•äº†ã€‚\nç†”æ–­å™¨çš„ 3 ç§çŠ¶æ€ // State is a type that represents a state of CircuitBreaker. type State int // These constants are states of CircuitBreaker. // ç†”æ–­å™¨çš„çŠ¶æ€ const ( // StateClosed è¡¨ç¤ºå…³é—­çŠ¶æ€ï¼Œæ­¤æ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ StateClosed State = iota // StateHalfOpen åŠå¼€çŠ¶æ€ï¼Œä¼šæ ¹æ®æƒ…å†µå˜æ›´ä¸ºå¼€å¯æˆ–è€…å…³é—­çŠ¶æ€ StateHalfOpen // StateOpen å¼€å¯çŠ¶æ€ï¼Œæ­¤æ—¶ä¼šæ‹’ç»æ‰€æœ‰è¯·æ±‚ StateOpen ) ç†”æ–­å™¨æœ‰ä¸‰ç§çŠ¶æ€ï¼š\nå¼€å¯ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä¼šæ‹’ç» å…³é—­ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ åŠå¼€å¯ï¼šå¼€å¯çŠ¶æ€è‡ªç„¶ä¸èƒ½ä¸€ç›´ç»´æŒï¼Œéœ€è¦æŸä¸ªæ¡ä»¶å°†å…¶åˆ‡æ¢åˆ°ä¸€ç§ä¸­é—´çŠ¶æ€ï¼šä¹Ÿå°±æ˜¯è¿™é‡Œçš„åŠå¼€å¯çŠ¶æ€ã€‚å½“å¼€å¯çŠ¶æ€æŒç»­äº†ä¸€æ®µæ—¶é—´åï¼Œå°±ä¼šå˜æ›´ä¸ºåŠå¼€å¯çŠ¶æ€ï¼Œè¡¨ç¤ºå¯ä»¥åšè¯•æ¢äº†ï¼Œå¦‚æœæ­¤æ—¶è¯·æ±‚ä¾ç„¶å¤±è´¥ï¼Œåˆ™å˜æ›´ä¸ºå¼€å¯çŠ¶æ€ï¼›å¦‚æœæˆåŠŸæ¬¡æ•°è¾¾åˆ°äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ™å˜æ›´ä¸ºå…³é—­çŠ¶æ€ è®¡æ•°å™¨ è®¡æ•°å™¨ä¿å­˜äº†ç†”æ–­å™¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå…·ä½“å±æ€§å¦‚ä¸‹ï¼š\n// Counts ä¿å­˜è¯·æ±‚çš„æ•°é‡åŠå…¶æˆåŠŸå¤±è´¥çš„æ¬¡æ•°ã€‚ // CircuitBreaker åœ¨çŠ¶æ€æ›´æ”¹æˆ–å…³é—­çŠ¶æ€é—´éš”æ—¶æ¸…é™¤å†…éƒ¨è®¡æ•°ã€‚ // Counts ä¼šå¿½ç•¥åœ¨æ¸…é™¤ä¹‹å‰å‘é€çš„è¯·æ±‚çš„ç»“æœã€‚ type Counts struct { Requests uint32 // æ€»è¯·æ±‚æ¬¡æ•° TotalSuccesses uint32 // æ€»æˆåŠŸæ¬¡æ•° TotalFailures uint32 // æ€»å¤±è´¥æ¬¡æ•° ConsecutiveSuccesses uint32 // è¿ç»­æˆåŠŸæ¬¡æ•° ConsecutiveFailures uint32 // è¿ç»­å¤±è´¥æ¬¡æ•° } æ­¤å¤–è¿˜æä¾›äº†ä¸€äº›åˆ—æ›´æ–°è®¡æ•°çš„æ–¹æ³•ï¼š\nfunc (c *Counts) onRequest() { c.Requests++ } func (c *Counts) onSuccess() { c.TotalSuccesses++ c.ConsecutiveSuccesses++ c.ConsecutiveFailures = 0 } func (c *Counts) onFailure() { c.TotalFailures++ c.ConsecutiveFailures++ c.ConsecutiveSuccesses = 0 } func (c *Counts) clear() { c.Requests = 0 c.TotalSuccesses = 0 c.TotalFailures = 0 c.ConsecutiveSuccesses = 0 c.ConsecutiveFailures = 0 } ç†”æ–­å™¨ CircuitBreaker å®šä¹‰äº†ç†”æ–­å™¨ç»“æ„ä½“ï¼Œè¿™ä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„ç»“æ„ä½“\n// CircuitBreaker is a state machine to prevent sending requests that are likely to fail. type CircuitBreaker struct { // è™šçº¿å†…çš„å±æ€§å’Œ Settings ä¸­çš„ç›¸åŒï¼Œå¦‚æœ Settings ä¸­æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å…… // ================== name string // æ¯”è¾ƒè¿·çš„ä¸€ä¸ªå˜é‡ï¼Œæºç é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š // 1. è¯·æ±‚æ€»æ•°ï¼ˆRequestsï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆä¼šè¿”å›è¯·æ±‚è¿‡å¤šçš„é”™è¯¯ // 2. è¿ç»­æˆåŠŸæ¬¡æ•°ï¼ˆConsecutiveSuccessesï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆå˜æ›´ä¸ºå…³é—­çŠ¶æ€ // 1 åœ¨ beforeRequest() å‡½æ•°ä¸­ï¼Œ2 åœ¨ afterRequest() -\u0026gt; onSuccess() çš„ HalfOpen åˆ†æ”¯ä¸­ // ä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚å‰ä¼šç¡®ä¿è¯·æ±‚æ€»æ•°ä¸è¶…è¿‡ MaxRequestï¼Œè¯·æ±‚åå¦‚æœå¤„äºåŠå¼€çŠ¶æ€ä¸”è¿ç»­æˆåŠŸæ•° \u0026gt;= MaxRequest // é‚£ä¹ˆä¼šå˜æ›´ä¸ºå…³é—­çŠ¶æ€ maxRequests uint32 // å…³é—­çŠ¶æ€ä¸‹å®šæœŸæ¸…ç©ºè®¡æ•°çš„æ—¶é—´ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ä¸æ¸…ç©º // è¿™é‡Œæˆ‘ä¸å¤ªæ˜ç™½æ¸…ç©ºè®¡æ•°çš„åŸå› ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªåˆ†æï¼Œæ„æ€æ˜¯å¦‚æœä¸€ç›´å¤„äºæˆåŠŸçŠ¶æ€ï¼Œ // é‚£ä¹ˆè®¡æ•°çš„æ„ä¹‰å°±ä¸æ˜¯å¾ˆå¤§ï¼Œæ­¤å¤–å¦‚æœè¯·æ±‚é‡è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´æº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦å®šæœŸæ¸…ç©º interval time.Duration // æ‰“å¼€çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œåˆ°æ—¶åä¼šå˜æ›´ä¸ºåŠæ‰“å¼€çŠ¶æ€ã€‚ timeout time.Duration // å…³é—­çŠ¶æ€ä¸‹ä¼šè°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿”å› trueï¼Œåˆ™è¿›å…¥æ‰“å¼€çŠ¶æ€ readyToTrip func(counts Counts) bool // ç”¨æ¥åˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸçš„å›è°ƒå‡½æ•° isSuccessful func(err error) bool // å‘ç”ŸçŠ¶æ€å˜æ›´æ—¶çš„å›è°ƒå‡½æ•° onStateChange func(name string, from State, to State) // ==================== mutex sync.Mutex state State generation uint64 counts Counts // è¿™ä¸ªå˜é‡è²Œä¼¼æœ‰ä¸¤ç§æƒ…å†µï¼š // 1. å¼€å¯çŠ¶æ€ä¸‹ï¼Œä»£è¡¨åˆ‡æ¢åˆ°åŠå¼€å¯çš„ç»å¯¹æ—¶é—´ï¼ˆtime.Time ä»£è¡¨ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼‰ // å…·ä½“å€¼æ˜¯ time.Now + timeout // 2. å…³é—­çŠ¶æ€ä¸‹ï¼Œä»£è¡¨è¿›å…¥ä¸‹ä¸€ä¸ªå‘¨æœŸçš„ç»å¯¹æ—¶é—´ï¼ˆè¿›å…¥ä¸‹ä¸€ä¸ªå‘¨æœŸä¼šæ¸…ç©ºè®¡æ•°ï¼‰ // å…·ä½“å€¼æ˜¯ time.Now + interval expiry time.Time } å…¶ä¸­çš„ä¸€éƒ¨åˆ†å€¼æ˜¯é€šè¿‡é…ç½®ç±»æ¥æŒ‡å®šçš„ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä¼šè®¾ç½®ä¸ºé»˜è®¤é…ç½®ï¼š\nfunc NewCircuitBreaker(st Settings) *CircuitBreaker { cb := new(CircuitBreaker) cb.name = st.Name cb.onStateChange = st.OnStateChange if st.MaxRequests == 0 { cb.maxRequests = 1 } else { cb.maxRequests = st.MaxRequests } if st.Interval \u0026lt;= 0 { cb.interval = defaultInterval } else { cb.interval = st.Interval } if st.Timeout \u0026lt;= 0 { cb.timeout = defaultTimeout } else { cb.timeout = st.Timeout } if st.ReadyToTrip == nil { cb.readyToTrip = defaultReadyToTrip } else { cb.readyToTrip = st.ReadyToTrip } if st.IsSuccessful == nil { cb.isSuccessful = defaultIsSuccessful } else { cb.isSuccessful = st.IsSuccessful } cb.toNewGeneration(time.Now()) return cb } é…ç½®ç±» type Settings struct { // ç†”æ–­å™¨çš„åç§° Name string // MaxRequests æ˜¯ CircuitBreaker åŠå¼€æ—¶å…è®¸é€šè¿‡çš„æœ€å¤§è¯·æ±‚æ•°ã€‚ // å¦‚æœ MaxRequests ä¸º 0ï¼Œåˆ™ CircuitBreaker åªå…è®¸ 1 ä¸ªè¯·æ±‚ã€‚ // FIXME æ¯”è¾ƒè¿·çš„ä¸€ä¸ªå˜é‡ï¼Œæºç é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š // 1. è¯·æ±‚æ€»æ•°ï¼ˆRequestsï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆä¼šè¿”å›è¯·æ±‚è¿‡å¤šçš„é”™è¯¯ // 2. è¿ç»­æˆåŠŸæ¬¡æ•°ï¼ˆConsecutiveSuccessesï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆå˜æ›´ä¸ºå…³é—­çŠ¶æ€ // 1 åœ¨ beforeRequest() å‡½æ•°ä¸­ï¼Œ2 åœ¨ afterRequest() -\u0026gt; onSuccess() çš„ HalfOpen åˆ†æ”¯ä¸­ // ä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚å‰ä¼šç¡®ä¿è¯·æ±‚æ€»æ•°ä¸è¶…è¿‡ MaxRequestï¼Œè¯·æ±‚åå¦‚æœå¤„äºåŠå¼€çŠ¶æ€ä¸”è¿ç»­æˆåŠŸæ•° \u0026gt;= MaxRequest // é‚£ä¹ˆä¼šå˜æ›´ä¸ºå…³é—­çŠ¶æ€ MaxRequests uint32 // Interval æ˜¯ç†”æ–­å™¨å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼Œå®šæœŸæ¸…é™¤å†…éƒ¨ Counts çš„æ—¶é—´ã€‚ // å¦‚æœ Interval å°äºæˆ–ç­‰äº 0ï¼ŒCircuitBreaker åœ¨å…³é—­çŠ¶æ€æœŸé—´ä¸ä¼šæ¸…é™¤å†…éƒ¨è®¡æ•°ã€‚ // FIXME è¿™ä¸ªä¸œè¥¿æš‚æ—¶æ²¡å‘ç°ç”¨å¤„ä½•åœ¨ // åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªåˆ†æï¼Œæ„æ€æ˜¯å¦‚æœä¸€ç›´å¤„äºæˆåŠŸçŠ¶æ€ï¼Œé‚£ä¹ˆè®¡æ•°çš„æ„ä¹‰å°±ä¸æ˜¯å¾ˆå¤§ï¼Œ // éœ€è¦å®šæœŸæ¸…ç©ºï¼Œä¸ç„¶å¯èƒ½ä¼šæº¢å‡º Interval time.Duration // Timeout æ˜¯æ‰“å¼€çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œåˆ°æ—¶åä¼šå˜æ›´ä¸ºåŠæ‰“å¼€çŠ¶æ€ã€‚ // å¦‚æœ Timeout å°äºæˆ–ç­‰äº 0ï¼Œåˆ™å°† CircuitBreaker çš„è¶…æ—¶å€¼è®¾ç½®ä¸º 60 ç§’ã€‚ Timeout time.Duration // æ¯å½“è¯·æ±‚åœ¨å…³é—­çŠ¶æ€ä¸‹å¤±è´¥æ—¶ï¼Œå°±ä¼šè°ƒç”¨ ReadyToTripï¼Œå‚æ•°ä¼ é€’çš„æ˜¯ Counts çš„å‰¯æœ¬ã€‚ // å¦‚æœ ReadyToTrip è¿”å› trueï¼ŒCircuitBreaker å°†è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚ // å¦‚æœ ReadyToTrip ä¸º nilï¼Œåˆ™ä½¿ç”¨é»˜è®¤ ReadyToTripã€‚ // å½“è¿ç»­å¤±è´¥æ¬¡æ•°è¶…è¿‡ 5 æ¬¡æ—¶ï¼Œé»˜è®¤ ReadyToTrip è¿”å› trueã€‚ ReadyToTrip func(counts Counts) bool // OnStateChange æ˜¯ç†”æ–­å™¨çŠ¶æ€å˜æ›´æ—¶çš„å›è°ƒå‡½æ•° OnStateChange func(name string, from State, to State) // IsSuccessful åˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œä¼ å…¥çš„ err æ˜¯æ‰§è¡Œç”¨æˆ·è¯·æ±‚å‡½æ•°åè¿”å›çš„ã€‚ // ï¼ˆä¹Ÿå°±æ˜¯ CircuitBreaker.Execute çš„å‚æ•° reqï¼‰ // å¦‚æœ IsSuccessful è¿”å› trueï¼Œ åˆ™è¯´æ˜è¯·æ±‚å‘ç”Ÿäº†é”™è¯¯ï¼Œå¦åˆ™è¯´æ˜æ²¡æœ‰é”™è¯¯ã€‚ // å¦‚æœ IsSuccessful ä¸º nilï¼Œ åˆ™ä½¿ç”¨é»˜è®¤ IsSuccessfulï¼Œè¯¥é»˜è®¤å‡½æ•°çš„é€»è¾‘æ˜¯ï¼š // if err == nil { return true } IsSuccessful func(err error) bool } é»˜è®¤é…ç½®ï¼š\nconst defaultInterval = time.Duration(0) * time.Second const defaultTimeout = time.Duration(60) * time.Second func defaultReadyToTrip(counts Counts) bool { return counts.ConsecutiveFailures \u0026gt; 5 } func defaultIsSuccessful(err error) bool { return err == nil } çŠ¶æ€è½¬æ¢ ä¸€å…±æœ‰ä¸€ä¸‹å‡ ç§çŠ¶æ€è½¬æ¢ï¼š\nå…³é—­ -\u0026gt; å¼€å¯ å¼€å¯ -\u0026gt; åŠå¼€ åŠå¼€ -\u0026gt; å¼€å¯ åŠå¼€ -\u0026gt; å…³é—­ gobreaker å®šä¹‰äº†ä¸€äº›æ–¹æ³•æ¥å®Œæˆä¸Šé¢çš„çŠ¶æ€è½¬æ¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nCircuitBreaker.onSuccess è¿™ä¸ªå‡½æ•°å®šä¹‰äº† åŠå¼€ -\u0026gt; å…³é—­ çš„çŠ¶æ€è½¬æ¢ ï¼Œæ˜¯é€šè¿‡ cb.setState æ¥å®Œæˆçš„\n// ç†”æ–­å™¨è¯·æ±‚æˆåŠŸæ—¶è°ƒç”¨è¯¥å‡½æ•° func (cb *CircuitBreaker) onSuccess(state State, now time.Time) { switch state { case StateClosed: // å¦‚æœæ­¤æ—¶æ˜¯å…³é—­çŠ¶æ€ï¼Œåˆ™æ›´æ–°è®¡æ•° cb.counts.onSuccess() case StateHalfOpen: // åŠå¼€çŠ¶æ€ cb.counts.onSuccess() // æ›´æ–°è®¡æ•° // è¿ç»­æˆåŠŸæ€»æ•°è¶…è¿‡äº†è®¾ç½®çš„ maxRequestsï¼Œå˜æ›´ä¸ºå…³é—­çŠ¶æ€ if cb.counts.ConsecutiveSuccesses \u0026gt;= cb.maxRequests { cb.setState(StateClosed, now) } } } CircuitBreaker.onFailure è¿™ä¸ªå‡½æ•°å®šä¹‰äº† **åŠå¼€ -\u0026gt; å¼€å¯ ** å’Œ å…³é—­ -\u0026gt; å¼€å¯ çš„çŠ¶æ€è½¬æ¢\n// ç†”æ–­å™¨è¯·æ±‚å¤±è´¥æ—¶è°ƒç”¨è¯¥å‡½æ•° func (cb *CircuitBreaker) onFailure(state State, now time.Time) { switch state { // å…³é—­çŠ¶æ€ä¸‹è¯·æ±‚å¤±è´¥äº† case StateClosed: cb.counts.onFailure() // æ›´æ–°è®¡æ•° // å¦‚æœå›è°ƒå‡½æ•° readyToTrip è¿”å› true // å› ä¸ºä¸€æ¬¡å¤±è´¥å¯èƒ½ä¸è¶³ä»¥ç›´æ¥åˆ¤å®šä¸ºéœ€è¦ç†”æ–­ï¼Œæ‰€ä»¥å¯èƒ½å¤±è´¥å¤šæ¬¡åæ‰ä¼šè¿”å› true // æ¯”å¦‚å®˜æ–¹ç¤ºä¾‹ä¸­è®¾ç½®çš„å›è°ƒå‡½æ•°æ˜¯ï¼š // st.ReadyToTrip = func(counts gobreaker.Counts) bool { //\tfailureRatio := float64(counts.TotalFailures) / float64(counts.Requests) //\treturn counts.Requests \u0026gt;= 3 \u0026amp;\u0026amp; failureRatio \u0026gt;= 0.6 //\t} // å¯ä»¥çœ‹åˆ°è¿™é‡Œéœ€è¦è¯·æ±‚æ¬¡æ•°å¤§äº3ï¼Œä¸”æ€»å¤±è´¥ç‡å¤§äºç­‰äº 60% æ‰ä¼šè¿”å› true if cb.readyToTrip(cb.counts) { cb.setState(StateOpen, now) // å˜æ›´ç†”æ–­å™¨ä¸ºå¼€å¯çŠ¶æ€ } case StateHalfOpen: // åŠå¼€çŠ¶æ€ä¸‹å¤±è´¥äº†ï¼Œå˜æ›´ä¸ºå¼€å¯çŠ¶æ€ cb.setState(StateOpen, now) } } CircuitBreaker.currentState è¿™ä¸ªå‡½æ•°å®šä¹‰äº† å¼€å¯ -\u0026gt; åŠå¼€ çš„çŠ¶æ€è½¬æ¢ï¼š\n// currentState è¿”å›ç†”æ–­å™¨å½“å‰çš„çŠ¶æ€ï¼Œnow ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†çŠ¶æ€å˜æ›´ func (cb *CircuitBreaker) currentState(now time.Time) (State, uint64) { // func toNewGeneration // case StateClosed: // if cb.interval == 0 { // cb.expiry = zero // } else { // cb.expiry = now.Add(cb.interval) // } switch cb.state { // å¦‚ä¸Šé¢çš„æ³¨é‡Šä»£ç æ‰€ç¤ºï¼Œå¦‚æœ cb.interval ä¸º 0ï¼Œé‚£ä¹ˆ cb.expiry ä¼šè®¾ç½®ä¸º zeroï¼Œ // æ­¤æ—¶ä¸‹é¢çš„ if æ¡ä»¶å°±ä¸æ»¡è¶³äº†ï¼Œå…³é—­çŠ¶æ€ä¸‹ä¹Ÿä¸ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° // å¦‚æœè®¾ç½®äº† cb.intervalï¼Œé‚£ä¹ˆä¼šè®¾ç½® cb.expiry çš„æ—¶é—´ï¼Œå¦‚æœå¤„äºå…³é—­çŠ¶æ€ä¸”è¾¾åˆ°äº† // expiry çš„æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° case StateClosed: if !cb.expiry.IsZero() \u0026amp;\u0026amp; cb.expiry.Before(now) { cb.toNewGeneration(now) } case StateOpen: // è¶…è¿‡äº† expiry çš„æ—¶é—´ï¼Œå¯ä»¥åˆ‡æ¢åˆ°åŠå¼€çŠ¶æ€äº† if cb.expiry.Before(now) { cb.setState(StateHalfOpen, now) } } return cb.state, cb.generation } æ ¸å¿ƒæ–¹æ³• Execute è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç†”æ–­å™¨çš„æ‰§è¡Œæ–¹æ³•ï¼Œç”¨æˆ·ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œç†”æ–­å™¨ä¼šæ ¹æ®å½“å‰çŠ¶æ€è¿›è¡Œç›¸åº”çš„æ“ä½œ\nfunc (cb *CircuitBreaker) Execute(req func() (interface{}, error)) (interface{}, error) { generation, err := cb.beforeRequest() if err != nil { return nil, err } defer func() { e := recover() if e != nil { cb.afterRequest(generation, false) panic(e) } }() result, err := req() cb.afterRequest(generation, cb.isSuccessful(err)) return result, err } å¯ä»¥çœ‹åˆ°å…¶ä¸­è°ƒç”¨äº†ç”¨æˆ·ä¼ å…¥çš„å‡½æ•°ï¼Œæ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªå‡½æ•°ï¼šbeforeRequest() å’Œ afterRequest() ä»£è¡¨æ‰§è¡Œè¯·æ±‚å‰å’Œæ‰§è¡Œè¯·æ±‚åï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å†…éƒ¨ä¼šæ›´æ–°ç†”æ–­å™¨çš„è®¡æ•°ä»¥åŠçŠ¶æ€\nbeforeRequest func (cb *CircuitBreaker) beforeRequest() (uint64, error) { cb.mutex.Lock() defer cb.mutex.Unlock() now := time.Now() state, generation := cb.currentState(now) // å¦‚æœç†”æ–­å™¨å¤„äºå¼€å¯çŠ¶æ€ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼Œå› ä¸ºè¯¥æ–¹æ³•åœ¨ Execute ä¸­å…ˆäºç”¨æˆ·è¯·æ±‚æ‰§è¡Œï¼Œ // ä¸”é€»è¾‘æ˜¯æœ‰ err ç›´æ¥ returnï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œä¹‹åçš„ä»£ç ï¼Œå…·ä½“æŸ¥çœ‹ Executeï¼Œä¸‹é¢æ˜¯æˆªå–çš„éƒ¨åˆ†ï¼š // generation, err := cb.beforeRequest() //\tif err != nil { //\treturn nil, err //\t} if state == StateOpen { return generation, ErrOpenState // è¯·æ±‚å‰å¦‚æœå¤„äºåŠå¼€çŠ¶æ€ï¼Œä¼šè¿›è¡Œé™æµæ“ä½œ } else if state == StateHalfOpen \u0026amp;\u0026amp; cb.counts.Requests \u0026gt;= cb.maxRequests { return generation, ErrTooManyRequests } cb.counts.onRequest() // æ›´æ–°è®¡æ•° return generation, nil } afterRequest func (cb *CircuitBreaker) afterRequest(before uint64, success bool) { cb.mutex.Lock() defer cb.mutex.Unlock() now := time.Now() state, generation := cb.currentState(now) if generation != before { return } // æ›´æ–°çŠ¶æ€å’Œè®¡æ•° if success { cb.onSuccess(state, now) } else { cb.onFailure(state, now) } } è¿™ä¸¤ä¸ªå‡½æ•°åˆè°ƒç”¨äº†åŒä¸€ä¸ªå‡½æ•° cb.currentState\ncurrentState // currentState è¿”å›ç†”æ–­å™¨å½“å‰çš„çŠ¶æ€ï¼Œnow ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒæŸäº›æ“ä½œï¼Œè¿™äº›æ“ä½œåŒ…æ‹¬ï¼š // 1. å…³é—­çŠ¶æ€ä¸‹æ¸…ç©ºè®¡æ•°ï¼ˆå¦‚æœè®¾ç½®äº† interval ä¸”è¾¾åˆ°äº†æ¸…ç©ºæ—¶é—´ï¼‰ // 2. å¼€å¯çŠ¶æ€è½¬æ¢ä¸ºåŠå¼€å¯çŠ¶æ€ï¼ˆåˆ°è¾¾äº†è½¬æ¢æ—¶é—´ï¼‰ func (cb *CircuitBreaker) currentState(now time.Time) (State, uint64) { // func toNewGeneration // case StateClosed: //\tif cb.interval == 0 { //\tcb.expiry = zero //\t} else { //\tcb.expiry = now.Add(cb.interval) //\t} switch cb.state { // å¦‚ä¸Šé¢çš„æ³¨é‡Šä»£ç æ‰€ç¤ºï¼Œå¦‚æœ cb.interval ä¸º 0ï¼Œé‚£ä¹ˆ cb.expiry ä¼šè®¾ç½®ä¸º zeroï¼Œ // æ­¤æ—¶ä¸‹é¢çš„ if æ¡ä»¶å°±ä¸æ»¡è¶³äº†ï¼Œå…³é—­çŠ¶æ€ä¸‹ä¹Ÿä¸ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° // å¦‚æœè®¾ç½®äº† cb.intervalï¼Œé‚£ä¹ˆä¼šè®¾ç½® cb.expiry çš„æ—¶é—´ï¼Œå¦‚æœå¤„äºå…³é—­çŠ¶æ€ä¸”è¾¾åˆ°äº† // expiry çš„æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° case StateClosed: if !cb.expiry.IsZero() \u0026amp;\u0026amp; cb.expiry.Before(now) { cb.toNewGeneration(now) } case StateOpen: // è¶…è¿‡äº† expiry çš„æ—¶é—´ï¼Œå¯ä»¥åˆ‡æ¢åˆ°åŠå¼€çŠ¶æ€äº† if cb.expiry.Before(now) { cb.setState(StateHalfOpen, now) } } return cb.state, cb.generation } è¿™ä¸ªå‡½æ•°åˆè°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•° toNewGeneration\ntoNewGeneration // è¿›å…¥ä¸€ä¸ªæ–°å‘¨æœŸï¼Œä¼šæ¸…ç©ºè®¡æ•°ï¼Œå¹¶å¯¹ cb.expiry è¿›è¡Œæ›´æ–° // è¯¥å‡½æ•°ä¼šåœ¨ setStateã€currentStateã€NewCircuitBreaker è°ƒç”¨ func (cb *CircuitBreaker) toNewGeneration(now time.Time) { cb.generation++ cb.counts.clear() var zero time.Time switch cb.state { case StateClosed: if cb.interval == 0 { cb.expiry = zero } else { cb.expiry = now.Add(cb.interval) } case StateOpen: cb.expiry = now.Add(cb.timeout) // è®¾ç½® open -\u0026gt; halfOpen çš„ç»å¯¹æ—¶é—´ default: // StateHalfOpen cb.expiry = zero } } æ€»ç»“ å…‰çœ‹æ–‡æ¡£æ„Ÿè§‰ç†”æ–­å™¨å¹¶ä¸æ˜¯ä¸€ä¸ªå¤šä¹ˆå¤æ‚çš„ä¸œè¥¿ï¼Œä½†æ˜¯ç­‰å®é™…é˜…è¯»ä»£ç æ‰å‘ç°è¿˜æ˜¯æœ‰ç‚¹å°å¤æ‚çš„ï¼Œä½•å†µè¿™ä¸ªå¼€æºåº“è¿˜åªæ˜¯å¯¹ç†”æ–­å™¨çš„ä¸€ä¸ªæœ€ç²¾ç®€å®ç°ï¼Œè¿˜æœ‰å…¶ä»–çš„æ›´å¤æ‚çš„å®ç°åº“ï¼Œé˜…è¯»è¿™ä¸ªæºç ä¸»è¦æœ‰ä¸€äº›ä¸æ¸…æ¥šçš„ç‚¹åœ¨äºï¼Œé‡Œé¢çš„å±æ€§ CircuitBreaker.expiry å’Œ CircuitBreaker.maxRequests åœ¨ä¸åŒæƒ…å†µä¸‹æœ‰ä¸åŒçš„æ„ä¹‰ï¼Œå¯¼è‡´çœ‹çš„æœ‰ç‚¹å¤´ç–¼ï¼ŒçŠ¶æ€çš„è½¬æ¢çœ‹ç€ä¹Ÿæœ‰ç‚¹ç»•ï¼Œè¿˜æœ‰ä¸€å¼€å§‹å¯¹ CircuitBreaker.interval è¿™ä¸ªå±æ€§çš„æ„ä¹‰ä¹Ÿä¸å¤ªç†è§£\nå®Œæ•´æºç æ³¨é‡Š https://github.com/youseebiggirl/gobreaker_annotation\n// Package gobreaker implements the Circuit Breaker pattern. // See https://msdn.microsoft.com/en-us/library/dn589784.aspx. package gobreaker import ( \u0026quot;errors\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;sync\u0026quot; \u0026quot;time\u0026quot; ) // State is a type that represents a state of CircuitBreaker. type State int // These constants are states of CircuitBreaker. // ç†”æ–­å™¨çš„çŠ¶æ€ const ( // StateClosed è¡¨ç¤ºå…³é—­çŠ¶æ€ï¼Œæ­¤æ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ StateClosed State = iota // StateHalfOpen åŠå¼€çŠ¶æ€ï¼Œä¼šæ ¹æ®æƒ…å†µå˜æ›´ä¸ºå¼€å¯æˆ–è€…å…³é—­çŠ¶æ€ StateHalfOpen // StateOpen å¼€å¯çŠ¶æ€ï¼Œæ­¤æ—¶ä¼šæ‹’ç»æ‰€æœ‰è¯·æ±‚ StateOpen ) var ( // ErrTooManyRequests is returned when the CB state is half open and the requests count is over the cb maxRequests // è¯¥é”™è¯¯åœ¨çŠ¶æ€ä¸ºåŠå¼€ä¸”è¯·æ±‚æ•°è¶…è¿‡ maxRequests æ—¶è¿”å› ErrTooManyRequests = errors.New(\u0026quot;too many requests\u0026quot;) // ErrOpenState is returned when the CB state is open // è¯¥é”™è¯¯åœ¨çŠ¶æ€ä¸ºå¼€å¯æ—¶è¿”å› ErrOpenState = errors.New(\u0026quot;circuit breaker is open\u0026quot;) ) // String implements stringer interface. // String ç»§æ‰¿äº† stringer æ¥å£ï¼Œç›¸å½“äºè‡ªå®šä¹‰äº† fmt.Println(State) çš„è¾“å‡º func (s State) String() string { switch s { case StateClosed: return \u0026quot;closed\u0026quot; case StateHalfOpen: return \u0026quot;half-open\u0026quot; case StateOpen: return \u0026quot;open\u0026quot; default: return fmt.Sprintf(\u0026quot;unknown state: %d\u0026quot;, s) } } // Counts holds the numbers of requests and their successes/failures. // CircuitBreaker clears the internal Counts either // on the change of the state or at the closed-state intervals. // Counts ignores the results of the requests sent before clearing. // Counts ä¿å­˜è¯·æ±‚çš„æ•°é‡åŠå…¶æˆåŠŸå¤±è´¥çš„æ¬¡æ•°ã€‚ // CircuitBreaker åœ¨çŠ¶æ€æ›´æ”¹æˆ–å…³é—­çŠ¶æ€é—´éš”æ—¶æ¸…é™¤å†…éƒ¨è®¡æ•°ã€‚ // Counts ä¼šå¿½ç•¥åœ¨æ¸…é™¤ä¹‹å‰å‘é€çš„è¯·æ±‚çš„ç»“æœã€‚ type Counts struct { Requests uint32 // æ€»è¯·æ±‚æ¬¡æ•° TotalSuccesses uint32 // æ€»æˆåŠŸæ¬¡æ•° TotalFailures uint32 // æ€»å¤±è´¥æ¬¡æ•° ConsecutiveSuccesses uint32 // è¿ç»­æˆåŠŸæ¬¡æ•° ConsecutiveFailures uint32 // è¿ç»­å¤±è´¥æ¬¡æ•° } func (c *Counts) onRequest() { c.Requests++ } func (c *Counts) onSuccess() { c.TotalSuccesses++ c.ConsecutiveSuccesses++ c.ConsecutiveFailures = 0 } func (c *Counts) onFailure() { c.TotalFailures++ c.ConsecutiveFailures++ c.ConsecutiveSuccesses = 0 } func (c *Counts) clear() { c.Requests = 0 c.TotalSuccesses = 0 c.TotalFailures = 0 c.ConsecutiveSuccesses = 0 c.ConsecutiveFailures = 0 } // Settings configures CircuitBreaker: // // Name is the name of the CircuitBreaker. // // MaxRequests is the maximum number of requests allowed to pass through // when the CircuitBreaker is half-open. // If MaxRequests is 0, the CircuitBreaker allows only 1 request. // // Interval is the cyclic period of the closed state // for the CircuitBreaker to clear the internal Counts. // If Interval is less than or equal to 0, the CircuitBreaker doesn't clear internal Counts during the closed state. // // Timeout is the period of the open state, // after which the state of the CircuitBreaker becomes half-open. // If Timeout is less than or equal to 0, the timeout value of the CircuitBreaker is set to 60 seconds. // // ReadyToTrip is called with a copy of Counts whenever a request fails in the closed state. // If ReadyToTrip returns true, the CircuitBreaker will be placed into the open state. // If ReadyToTrip is nil, default ReadyToTrip is used. // Default ReadyToTrip returns true when the number of consecutive failures is more than 5. // // OnStateChange is called whenever the state of the CircuitBreaker changes. // // IsSuccessful is called with the error returned from a request. // If IsSuccessful returns true, the error is counted as a success. // Otherwise the error is counted as a failure. // If IsSuccessful is nil, default IsSuccessful is used, which returns false for all non-nil errors. type Settings struct { // ç†”æ–­å™¨çš„åç§° Name string // MaxRequests æ˜¯ CircuitBreaker åŠå¼€æ—¶å…è®¸é€šè¿‡çš„æœ€å¤§è¯·æ±‚æ•°ã€‚ // å¦‚æœ MaxRequests ä¸º 0ï¼Œåˆ™ CircuitBreaker åªå…è®¸ 1 ä¸ªè¯·æ±‚ã€‚ // FIXME æ¯”è¾ƒè¿·çš„ä¸€ä¸ªå˜é‡ï¼Œæºç é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š // 1. è¯·æ±‚æ€»æ•°ï¼ˆRequestsï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆä¼šè¿”å›è¯·æ±‚è¿‡å¤šçš„é”™è¯¯ // 2. è¿ç»­æˆåŠŸæ¬¡æ•°ï¼ˆConsecutiveSuccessesï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆå˜æ›´ä¸ºå…³é—­çŠ¶æ€ // 1 åœ¨ beforeRequest() å‡½æ•°ä¸­ï¼Œ2 åœ¨ afterRequest() -\u0026gt; onSuccess() çš„ HalfOpen åˆ†æ”¯ä¸­ // ä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚å‰ä¼šç¡®ä¿è¯·æ±‚æ€»æ•°ä¸è¶…è¿‡ MaxRequestï¼Œè¯·æ±‚åå¦‚æœå¤„äºåŠå¼€çŠ¶æ€ä¸”è¿ç»­æˆåŠŸæ•° \u0026gt;= MaxRequest // é‚£ä¹ˆä¼šå˜æ›´ä¸ºå…³é—­çŠ¶æ€ MaxRequests uint32 // Interval æ˜¯ç†”æ–­å™¨å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼Œå®šæœŸæ¸…é™¤å†…éƒ¨ Counts çš„æ—¶é—´ã€‚ // å¦‚æœ Interval å°äºæˆ–ç­‰äº 0ï¼ŒCircuitBreaker åœ¨å…³é—­çŠ¶æ€æœŸé—´ä¸ä¼šæ¸…é™¤å†…éƒ¨è®¡æ•°ã€‚ // FIXME è¿™ä¸ªä¸œè¥¿æš‚æ—¶æ²¡å‘ç°ç”¨å¤„ä½•åœ¨ // åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªåˆ†æï¼Œæ„æ€æ˜¯å¦‚æœä¸€ç›´å¤„äºæˆåŠŸçŠ¶æ€ï¼Œé‚£ä¹ˆè®¡æ•°çš„æ„ä¹‰å°±ä¸æ˜¯å¾ˆå¤§ï¼Œ // éœ€è¦å®šæœŸæ¸…ç©ºï¼Œä¸ç„¶å¯èƒ½ä¼šæº¢å‡º Interval time.Duration // Timeout æ˜¯æ‰“å¼€çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œåˆ°æ—¶åä¼šå˜æ›´ä¸ºåŠæ‰“å¼€çŠ¶æ€ã€‚ // å¦‚æœ Timeout å°äºæˆ–ç­‰äº 0ï¼Œåˆ™å°† CircuitBreaker çš„è¶…æ—¶å€¼è®¾ç½®ä¸º 60 ç§’ã€‚ Timeout time.Duration // æ¯å½“è¯·æ±‚åœ¨å…³é—­çŠ¶æ€ä¸‹å¤±è´¥æ—¶ï¼Œå°±ä¼šè°ƒç”¨ ReadyToTripï¼Œå‚æ•°ä¼ é€’çš„æ˜¯ Counts çš„å‰¯æœ¬ã€‚ // å¦‚æœ ReadyToTrip è¿”å› trueï¼ŒCircuitBreaker å°†è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚ // å¦‚æœ ReadyToTrip ä¸º nilï¼Œåˆ™ä½¿ç”¨é»˜è®¤ ReadyToTripã€‚ // å½“è¿ç»­å¤±è´¥æ¬¡æ•°è¶…è¿‡ 5 æ¬¡æ—¶ï¼Œé»˜è®¤ ReadyToTrip è¿”å› trueã€‚ ReadyToTrip func(counts Counts) bool // OnStateChange æ˜¯ç†”æ–­å™¨çŠ¶æ€å˜æ›´æ—¶çš„å›è°ƒå‡½æ•° OnStateChange func(name string, from State, to State) // IsSuccessful åˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œä¼ å…¥çš„ err æ˜¯æ‰§è¡Œç”¨æˆ·è¯·æ±‚å‡½æ•°åè¿”å›çš„ã€‚ // ï¼ˆä¹Ÿå°±æ˜¯ CircuitBreaker.Execute çš„å‚æ•° reqï¼‰ // å¦‚æœ IsSuccessful è¿”å› trueï¼Œ åˆ™è¯´æ˜è¯·æ±‚å‘ç”Ÿäº†é”™è¯¯ï¼Œå¦åˆ™è¯´æ˜æ²¡æœ‰é”™è¯¯ã€‚ // å¦‚æœ IsSuccessful ä¸º nilï¼Œ åˆ™ä½¿ç”¨é»˜è®¤ IsSuccessfulï¼Œè¯¥é»˜è®¤å‡½æ•°çš„é€»è¾‘æ˜¯ï¼š // if err == nil { return true } IsSuccessful func(err error) bool } // CircuitBreaker is a state machine to prevent sending requests that are likely to fail. type CircuitBreaker struct { // è™šçº¿å†…çš„å±æ€§å’Œ Settings ä¸­çš„ç›¸åŒï¼Œå¦‚æœ Settings ä¸­æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å…… // ================== name string // æ¯”è¾ƒè¿·çš„ä¸€ä¸ªå˜é‡ï¼Œæºç é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š // 1. è¯·æ±‚æ€»æ•°ï¼ˆRequestsï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆä¼šè¿”å›è¯·æ±‚è¿‡å¤šçš„é”™è¯¯ // 2. è¿ç»­æˆåŠŸæ¬¡æ•°ï¼ˆConsecutiveSuccessesï¼‰ \u0026gt;= MaxRequestsï¼Œé‚£ä¹ˆå˜æ›´ä¸ºå…³é—­çŠ¶æ€ // 1 åœ¨ beforeRequest() å‡½æ•°ä¸­ï¼Œ2 åœ¨ afterRequest() -\u0026gt; onSuccess() çš„ HalfOpen åˆ†æ”¯ä¸­ // ä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚å‰ä¼šç¡®ä¿è¯·æ±‚æ€»æ•°ä¸è¶…è¿‡ MaxRequestï¼Œè¯·æ±‚åå¦‚æœå¤„äºåŠå¼€çŠ¶æ€ä¸”è¿ç»­æˆåŠŸæ•° \u0026gt;= MaxRequest // é‚£ä¹ˆä¼šå˜æ›´ä¸ºå…³é—­çŠ¶æ€ maxRequests uint32 // å…³é—­çŠ¶æ€ä¸‹å®šæœŸæ¸…ç©ºè®¡æ•°çš„æ—¶é—´ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ä¸æ¸…ç©º // è¿™é‡Œæˆ‘ä¸å¤ªæ˜ç™½æ¸…ç©ºè®¡æ•°çš„åŸå› ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªåˆ†æï¼Œæ„æ€æ˜¯å¦‚æœä¸€ç›´å¤„äºæˆåŠŸçŠ¶æ€ï¼Œ // é‚£ä¹ˆè®¡æ•°çš„æ„ä¹‰å°±ä¸æ˜¯å¾ˆå¤§ï¼Œæ­¤å¤–å¦‚æœè¯·æ±‚é‡è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´æº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦å®šæœŸæ¸…ç©º interval time.Duration // æ‰“å¼€çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œåˆ°æ—¶åä¼šå˜æ›´ä¸ºåŠæ‰“å¼€çŠ¶æ€ã€‚ timeout time.Duration // å…³é—­çŠ¶æ€ä¸‹ä¼šè°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿”å› trueï¼Œåˆ™è¿›å…¥æ‰“å¼€çŠ¶æ€ readyToTrip func(counts Counts) bool // ç”¨æ¥åˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸçš„å›è°ƒå‡½æ•° isSuccessful func(err error) bool // å‘ç”ŸçŠ¶æ€å˜æ›´æ—¶çš„å›è°ƒå‡½æ•° onStateChange func(name string, from State, to State) // ==================== mutex sync.Mutex state State generation uint64 counts Counts // è¿™ä¸ªå˜é‡è²Œä¼¼æœ‰ä¸¤ç§æƒ…å†µï¼š // 1. å¼€å¯çŠ¶æ€ä¸‹ï¼Œä»£è¡¨åˆ‡æ¢åˆ°åŠå¼€å¯çš„ç»å¯¹æ—¶é—´ï¼ˆtime.Time ä»£è¡¨ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼‰ // å…·ä½“å€¼æ˜¯ time.Now + timeout // 2. å…³é—­çŠ¶æ€ä¸‹ï¼Œä»£è¡¨è¿›å…¥ä¸‹ä¸€ä¸ªå‘¨æœŸçš„ç»å¯¹æ—¶é—´ï¼ˆè¿›å…¥ä¸‹ä¸€ä¸ªå‘¨æœŸä¼šæ¸…ç©ºè®¡æ•°ï¼‰ // å…·ä½“å€¼æ˜¯ time.Now + interval expiry time.Time } // TwoStepCircuitBreaker is like CircuitBreaker but instead of surrounding a function // with the breaker functionality, it only checks whether a request can proceed and // expects the caller to report the outcome in a separate step using a callback. type TwoStepCircuitBreaker struct { cb *CircuitBreaker } // NewCircuitBreaker returns a new CircuitBreaker configured with the given Settings. func NewCircuitBreaker(st Settings) *CircuitBreaker { cb := new(CircuitBreaker) cb.name = st.Name cb.onStateChange = st.OnStateChange if st.MaxRequests == 0 { cb.maxRequests = 1 } else { cb.maxRequests = st.MaxRequests } if st.Interval \u0026lt;= 0 { cb.interval = defaultInterval } else { cb.interval = st.Interval } if st.Timeout \u0026lt;= 0 { cb.timeout = defaultTimeout } else { cb.timeout = st.Timeout } if st.ReadyToTrip == nil { cb.readyToTrip = defaultReadyToTrip } else { cb.readyToTrip = st.ReadyToTrip } if st.IsSuccessful == nil { cb.isSuccessful = defaultIsSuccessful } else { cb.isSuccessful = st.IsSuccessful } cb.toNewGeneration(time.Now()) return cb } // NewTwoStepCircuitBreaker returns a new TwoStepCircuitBreaker configured with the given Settings. func NewTwoStepCircuitBreaker(st Settings) *TwoStepCircuitBreaker { return \u0026amp;TwoStepCircuitBreaker{ cb: NewCircuitBreaker(st), } } const defaultInterval = time.Duration(0) * time.Second const defaultTimeout = time.Duration(60) * time.Second func defaultReadyToTrip(counts Counts) bool { return counts.ConsecutiveFailures \u0026gt; 5 } func defaultIsSuccessful(err error) bool { return err == nil } // Name returns the name of the CircuitBreaker. func (cb *CircuitBreaker) Name() string { return cb.name } // State returns the current state of the CircuitBreaker. func (cb *CircuitBreaker) State() State { cb.mutex.Lock() defer cb.mutex.Unlock() now := time.Now() state, _ := cb.currentState(now) return state } // Counts returns internal counters func (cb *CircuitBreaker) Counts() Counts { cb.mutex.Lock() defer cb.mutex.Unlock() return cb.counts } // Execute runs the given request if the CircuitBreaker accepts it. // Execute returns an error instantly if the CircuitBreaker rejects the request. // Otherwise, Execute returns the result of the request. // If a panic occurs in the request, the CircuitBreaker handles it as an error // and causes the same panic again. func (cb *CircuitBreaker) Execute(req func() (interface{}, error)) (interface{}, error) { // æ‰§è¡Œè¯·æ±‚å‰ generation, err := cb.beforeRequest() if err != nil { return nil, err } defer func() { e := recover() if e != nil { cb.afterRequest(generation, false) panic(e) } }() result, err := req() // æ‰§è¡Œè¯·æ±‚å cb.afterRequest(generation, cb.isSuccessful(err)) return result, err } // Name returns the name of the TwoStepCircuitBreaker. func (tscb *TwoStepCircuitBreaker) Name() string { return tscb.cb.Name() } // State returns the current state of the TwoStepCircuitBreaker. func (tscb *TwoStepCircuitBreaker) State() State { return tscb.cb.State() } // Counts returns internal counters func (tscb *TwoStepCircuitBreaker) Counts() Counts { return tscb.cb.Counts() } // Allow checks if a new request can proceed. It returns a callback that should be used to // register the success or failure in a separate step. If the circuit breaker doesn't allow // requests, it returns an error. func (tscb *TwoStepCircuitBreaker) Allow() (done func(success bool), err error) { generation, err := tscb.cb.beforeRequest() if err != nil { return nil, err } return func(success bool) { tscb.cb.afterRequest(generation, success) }, nil } func (cb *CircuitBreaker) beforeRequest() (uint64, error) { cb.mutex.Lock() defer cb.mutex.Unlock() now := time.Now() state, generation := cb.currentState(now) // å¦‚æœç†”æ–­å™¨å¤„äºå¼€å¯çŠ¶æ€ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼Œå› ä¸ºè¯¥æ–¹æ³•åœ¨ Execute ä¸­å…ˆäºç”¨æˆ·è¯·æ±‚æ‰§è¡Œï¼Œ // ä¸”é€»è¾‘æ˜¯æœ‰ err ç›´æ¥ returnï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œä¹‹åçš„ä»£ç ï¼Œå…·ä½“æŸ¥çœ‹ Executeï¼Œä¸‹é¢æ˜¯æˆªå–çš„éƒ¨åˆ†ï¼š // generation, err := cb.beforeRequest() //\tif err != nil { //\treturn nil, err //\t} if state == StateOpen { return generation, ErrOpenState // è¯·æ±‚å‰å¦‚æœå¤„äºåŠå¼€çŠ¶æ€ï¼Œä¼šè¿›è¡Œé™æµæ“ä½œ } else if state == StateHalfOpen \u0026amp;\u0026amp; cb.counts.Requests \u0026gt;= cb.maxRequests { return generation, ErrTooManyRequests } cb.counts.onRequest() // æ›´æ–°è®¡æ•° return generation, nil } func (cb *CircuitBreaker) afterRequest(before uint64, success bool) { cb.mutex.Lock() defer cb.mutex.Unlock() now := time.Now() state, generation := cb.currentState(now) if generation != before { return } // æ›´æ–°çŠ¶æ€å’Œè®¡æ•° if success { cb.onSuccess(state, now) } else { cb.onFailure(state, now) } } // ç†”æ–­å™¨è¯·æ±‚æˆåŠŸæ—¶è°ƒç”¨è¯¥å‡½æ•° func (cb *CircuitBreaker) onSuccess(state State, now time.Time) { switch state { case StateClosed: // å¦‚æœæ­¤æ—¶æ˜¯å…³é—­çŠ¶æ€ï¼Œåˆ™æ›´æ–°è®¡æ•° cb.counts.onSuccess() case StateHalfOpen: // åŠå¼€çŠ¶æ€ cb.counts.onSuccess() // æ›´æ–°è®¡æ•° // è¿ç»­æˆåŠŸæ€»æ•°è¶…è¿‡äº†è®¾ç½®çš„ maxRequestsï¼Œå˜æ›´ä¸ºå…³é—­çŠ¶æ€ if cb.counts.ConsecutiveSuccesses \u0026gt;= cb.maxRequests { cb.setState(StateClosed, now) } } } // ç†”æ–­å™¨è¯·æ±‚å¤±è´¥æ—¶è°ƒç”¨è¯¥å‡½æ•° func (cb *CircuitBreaker) onFailure(state State, now time.Time) { switch state { // å…³é—­çŠ¶æ€ä¸‹è¯·æ±‚å¤±è´¥äº† case StateClosed: cb.counts.onFailure() // æ›´æ–°è®¡æ•° // å¦‚æœå›è°ƒå‡½æ•° readyToTrip è¿”å› true // å› ä¸ºä¸€æ¬¡å¤±è´¥å¯èƒ½ä¸è¶³ä»¥ç›´æ¥åˆ¤å®šä¸ºéœ€è¦ç†”æ–­ï¼Œæ‰€ä»¥å¯èƒ½å¤±è´¥å¤šæ¬¡åæ‰ä¼šè¿”å› true // æ¯”å¦‚å®˜æ–¹ç¤ºä¾‹ä¸­è®¾ç½®çš„å›è°ƒå‡½æ•°æ˜¯ï¼š // st.ReadyToTrip = func(counts gobreaker.Counts) bool { //\tfailureRatio := float64(counts.TotalFailures) / float64(counts.Requests) //\treturn counts.Requests \u0026gt;= 3 \u0026amp;\u0026amp; failureRatio \u0026gt;= 0.6 //\t} // å¯ä»¥çœ‹åˆ°è¿™é‡Œéœ€è¦è¯·æ±‚æ¬¡æ•°å¤§äº3ï¼Œä¸”æ€»å¤±è´¥ç‡å¤§äºç­‰äº 60% æ‰ä¼šè¿”å› true if cb.readyToTrip(cb.counts) { cb.setState(StateOpen, now) // å˜æ›´ç†”æ–­å™¨ä¸ºå¼€å¯çŠ¶æ€ } case StateHalfOpen: // åŠå¼€çŠ¶æ€ä¸‹å¤±è´¥äº†ï¼Œå˜æ›´ä¸ºå¼€å¯çŠ¶æ€ cb.setState(StateOpen, now) } } // currentState è¿”å›ç†”æ–­å™¨å½“å‰çš„çŠ¶æ€ï¼Œnow ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒæŸäº›æ“ä½œï¼Œè¿™äº›æ“ä½œåŒ…æ‹¬ï¼š // 1. å…³é—­çŠ¶æ€ä¸‹æ¸…ç©ºè®¡æ•°ï¼ˆå¦‚æœè®¾ç½®äº† interval ä¸”è¾¾åˆ°äº†æ¸…ç©ºæ—¶é—´ï¼‰ // 2. å¼€å¯çŠ¶æ€è½¬æ¢ä¸ºåŠå¼€å¯çŠ¶æ€ï¼ˆåˆ°è¾¾äº†è½¬æ¢æ—¶é—´ï¼‰ func (cb *CircuitBreaker) currentState(now time.Time) (State, uint64) { // func toNewGeneration // case StateClosed: //\tif cb.interval == 0 { //\tcb.expiry = zero //\t} else { //\tcb.expiry = now.Add(cb.interval) //\t} switch cb.state { // å¦‚ä¸Šé¢çš„æ³¨é‡Šä»£ç æ‰€ç¤ºï¼Œå¦‚æœ cb.interval ä¸º 0ï¼Œé‚£ä¹ˆ cb.expiry ä¼šè®¾ç½®ä¸º zeroï¼Œ // æ­¤æ—¶ä¸‹é¢çš„ if æ¡ä»¶å°±ä¸æ»¡è¶³äº†ï¼Œå…³é—­çŠ¶æ€ä¸‹ä¹Ÿä¸ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° // å¦‚æœè®¾ç½®äº† cb.intervalï¼Œé‚£ä¹ˆä¼šè®¾ç½® cb.expiry çš„æ—¶é—´ï¼Œå¦‚æœå¤„äºå…³é—­çŠ¶æ€ä¸”è¾¾åˆ°äº† // expiry çš„æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨ cb.toNewGeneration æ¥æ¸…ç©ºè®¡æ•° case StateClosed: if !cb.expiry.IsZero() \u0026amp;\u0026amp; cb.expiry.Before(now) { cb.toNewGeneration(now) } case StateOpen: // è¶…è¿‡äº† expiry çš„æ—¶é—´ï¼Œå¯ä»¥åˆ‡æ¢åˆ°åŠå¼€çŠ¶æ€äº† if cb.expiry.Before(now) { cb.setState(StateHalfOpen, now) } } return cb.state, cb.generation } func (cb *CircuitBreaker) setState(state State, now time.Time) { if cb.state == state { return } prev := cb.state cb.state = state cb.toNewGeneration(now) // è®¾ç½®æ–°çŠ¶æ€åæ›´æ–°è®¡æ•° if cb.onStateChange != nil { cb.onStateChange(cb.name, prev, state) } } // è¿›å…¥ä¸€ä¸ªæ–°å‘¨æœŸï¼Œä¼šæ¸…ç©ºè®¡æ•°ï¼Œå¹¶å¯¹ cb.expiry è¿›è¡Œæ›´æ–° // è¯¥å‡½æ•°ä¼šåœ¨ setStateã€currentStateã€NewCircuitBreaker è°ƒç”¨ func (cb *CircuitBreaker) toNewGeneration(now time.Time) { cb.generation++ cb.counts.clear() var zero time.Time switch cb.state { case StateClosed: if cb.interval == 0 { cb.expiry = zero } else { cb.expiry = now.Add(cb.interval) } case StateOpen: cb.expiry = now.Add(cb.timeout) // è®¾ç½® open -\u0026gt; halfOpen çš„ç»å¯¹æ—¶é—´ default: // StateHalfOpen cb.expiry = zero } } ","date":"2022å¹´06æœˆ11æ—¥","permalink":"/posts/gobreaker/","summary":"è¯¥æ–‡ç« ä»…ä½œä¸ºæœ¬äººç¬”è®°ï¼Œä¸å…·å¤‡å¤ªå¤§çš„å‚è€ƒä»·å€¼\nè¯¥æ–‡ç« ç€é‡è®°å½•æºç ï¼Œæ²¡æœ‰å¯¹ç†”æ–­å™¨è¿™ä¸€æ¦‚å¿µåšè¿‡å¤šç†å¿µä¸Šçš„è¯´æ˜è§£é‡Š\nè¯¥æ–‡ç« æ’ç‰ˆã€æ€è·¯è¾ƒä¸ºæ··ä¹±ï¼Œåç»­å¯èƒ½ä¼šè¿›è¡Œä¿®æ”¹\nç¤ºä¾‹ å®˜æ–¹ç¤ºä¾‹ å®˜æ–¹ç¤ºä¾‹æœ‰ç‚¹å¤ªç®€å•äº†ï¼Œå®Œå…¨æ— æ³•ä½“ä¼šåˆ° ç†”æ–­ è¿™ä¸€æ¦‚å¿µ","title":"go ç†”æ–­å™¨ gobreaker æºç é˜…è¯»"},{"contents":"å¼•å­ æœ€è¿‘ä¹°äº†å—æœºæ¢°ç¡¬ç›˜ä½œä¸ºä»“åº“ç›˜ï¼Œç”¨ç¡¬ç›˜ç›’è¿æ¥åˆ° macï¼Œä½†æ˜¯è¿™å—ç¡¬ç›˜è²Œä¼¼æœ‰ä¼‘çœ æœºåˆ¶ï¼ˆä¸ç¡®å®šï¼‰ï¼Œå¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰è¯»å†™æ“ä½œå°±ä¼šåœè½¬ï¼Œç­‰åˆ°éœ€è¦æ“ä½œæ—¶æ‰ä¼šå”¤é†’ï¼Œå”¤é†’ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ç£ç›˜å¯åŠ¨å£°éŸ³ï¼Œå¹¶ä¸”éœ€è¦ç­‰å¾… 5s å·¦å³æ‰èƒ½ä½¿ç”¨ã€‚\nä½†è›‹ç–¼çš„æ˜¯ä¸çŸ¥é“æ˜¯ç³»ç»ŸåŸå› è¿˜æ˜¯ä»€ä¹ˆï¼Œæ¯æ¬¡ç¡¬ç›˜ä¼‘çœ åå³ä¾¿æˆ‘æ²¡æœ‰å¯¹å…¶è¿›è¡Œæ“ä½œä»ç„¶ä¼šè‡ªè¡Œå”¤é†’ï¼Œå¯¼è‡´æˆ‘æ€»æ˜¯èƒ½é¢‘ç¹å¬åˆ°ç¡¬ç›˜çš„å¯åœå£°ï¼Œæˆ‘è¿˜ä¸“é—¨è§‚å¯Ÿäº†ä¸€ä¸‹ï¼Œå°±ç®—æˆ‘èººåœ¨åºŠä¸Šç©æ‰‹æœºï¼Œå®Œå…¨ä¸ç¢°ç”µè„‘ï¼Œè¿™å—ç¡¬ç›˜ä»ç„¶ä¼šé¢‘ç¹çš„å¯åœï¼Œå…ˆä¸è¯´è¿™çƒ¦äººçš„å£°éŸ³ï¼Œç½‘ä¸ŠæŸ¥äº†ä¸‹ï¼Œè²Œä¼¼è¿™æ ·é¢‘ç¹å¯åœè¿˜ä¼šæŸå®³ç¡¬ç›˜å¥åº·ï¼Œè¿˜ä¸å¦‚ä¸€ç›´é€šç”µè¿è¡Œï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ‰“ç®—å†™ä¸ªå°ç¨‹åºï¼ŒæœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ã€‚\né—®é¢˜1 è¯»ä¸å‡ºæ–‡ä»¶å†…å®¹ å…·ä½“æµç¨‹æ˜¯å…ˆåœ¨è¿™å—ç¡¬ç›˜ä¸Šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶è·å– fdï¼Œç„¶åç”¨è¿™ä¸ª fd å†™å…¥ä¸€æ®µæ–‡å­—ï¼Œå†åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œä¸æ–­è¯»å–è¿™ä¸ª fdï¼Œæˆ‘æƒ³çš„æ˜¯è¿™æ ·ä¸æ–­è¯»å–ç¡¬ç›˜ï¼Œæ¥è¾¾åˆ°ç¦æ­¢ä¼‘çœ çš„æ•ˆæœï¼Œç»“æœå‘ç°å†™å…¥æˆåŠŸï¼Œä½†æ˜¯è¯»ç›´æ¥æŠ¥ EOFï¼Œåæ¥ç ”ç©¶å‘ç°ï¼Œè²Œä¼¼æ˜¯å†™å…¥åå¯¼è‡´ fd åç§»é‡æ”¹å˜ç§»åˆ°æœ«å°¾ï¼Œæ­¤æ—¶å†è¯»å–å°±ä¼šç›´æ¥æŠ¥ EOFï¼Œæ‰€ä»¥åœ¨è¯»å–å‰éœ€è¦è°ƒç”¨ Seek æ¥é‡ç½®åç§»é‡ã€‚\npackage main import ( \u0026quot;io\u0026quot; \u0026quot;log\u0026quot; \u0026quot;os\u0026quot; \u0026quot;time\u0026quot; ) func main() { p := \u0026quot;/Volumes/4t/DO_NOT_SLEEP\u0026quot; f, err := os.OpenFile(p, os.O_CREATE|os.O_RDWR, 0777) if err != nil { panic(err) } defer f.Close() _, err = f.WriteString(\u0026quot;123\u0026quot;) if err != nil { panic(err) } log.Println(\u0026quot;DO_NOT_SLEEP is ready\u0026quot;) // æ³¨æ„ï¼šä¸Šé¢çš„å†™å…¥æ“ä½œä¼šæ”¹å˜åç§»é‡ï¼Œå¯¼è‡´åç»­çš„è¯»å–æ“ä½œä¸º EOF // éœ€è¦è°ƒç”¨ Seek æ¥é‡ç½®åç§»é‡ï¼Œè¿™é‡Œè®¾ç½®ä¸º SEEK_SET + 0 ä¹Ÿå°±æ˜¯ä»å¤´å¼€å§‹è¯» f.Seek(0, os.SEEK_SET) b := make([]byte, 10) for { n, err := f.Read(b) if err != nil { log.Println(err) if err == io.EOF { break } continue } log.Println(n, string(b[:n])) f.Seek(0, os.SEEK_SET) time.Sleep(time.Second * 3) } } é—®é¢˜2 è™½ç„¶åœ¨ä¸æ–­è¯»å–ï¼Œä½†ç¡¬ç›˜ä¾ç„¶ä¼šä¼‘çœ  è¿˜æ˜¯ä¸Šé¢çš„ç¨‹åºï¼Œæˆ‘è·‘èµ·æ¥ä»¥åå‘ç°ç»ˆç«¯åœ¨ä¸æ–­æ‰“å°è¯»å–åˆ°çš„å†…å®¹ï¼Œæœ¬ä»¥ä¸º ok äº†ï¼Œç»“æœè¿‡äº†å‡ åˆ†é’Ÿç¡¬ç›˜åˆç»™ä¼‘çœ äº†ï¼Œæœ€ç¦»è°±çš„æ˜¯æ­¤æ—¶ç»ˆç«¯è¿˜åœ¨ä¸æ–­æ‰“å°æ—¥å¿—ã€‚ã€‚ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿéš¾ä¸æˆ fd æ‰“å¼€åï¼Œä¼šæŠŠæ–‡ä»¶å†…å®¹ç¼“å­˜ï¼Œä¹‹åç›´æ¥ä»ç¼“å­˜ä¸­è¯»ï¼Ÿæˆ‘åˆå°è¯•äº†åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œä¸æ–­è°ƒç”¨ os.OpenFileï¼Œä½†æ˜¯ç„¶å¹¶åµï¼Œç£ç›˜ä¾ç„¶ä¼šä¼‘çœ ï¼Œè¿™ä¸ªé—®é¢˜è¿˜æœ‰å¾…ç ”ç©¶ï¼Œä¸çŸ¥é“æ˜¯ go runtime çš„è®¾è®¡é—®é¢˜ï¼Œè¿˜æ˜¯ linux fd çš„æœºåˆ¶é—®é¢˜\nè§£å†³ æ—¢ç„¶è¯»è§£å†³ä¸äº†é—®é¢˜ï¼Œé‚£æˆ‘åªèƒ½è¯•è¯•å†™äº†ï¼Œæ„Ÿè§‰å†™é—®é¢˜åº”è¯¥ä¸å¤§ï¼Œå…¶å®æˆ‘ä¸€å¼€å§‹å°±æ˜¯æƒ³ç”¨å†™æ“ä½œæ¥è§£å†³é—®é¢˜çš„ï¼Œä½†æ˜¯äº†è§£åˆ°è¯»æ“ä½œå¯¹ç¡¬ç›˜æ˜¯æ— æŸå®³çš„ï¼Œè€Œå†™æ“ä½œä¼šæŸå®³ç¡¬ç›˜å¯¿å‘½ï¼Œæ‰€ä»¥æ‰å°è¯•ç”¨è¯»æ“ä½œè§£å†³ï¼Œ\nå¤§è‡´æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸æ–­å‘è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥æ–‡æœ¬å³å¯ï¼Œè¿™é‡Œæˆ‘æŠŠ open ä¹Ÿæ”¾åˆ°äº†æ­»å¾ªç¯ä¸­ï¼Œå› ä¸ºæˆ‘ä¸çŸ¥é“åœ¨æ­»å¾ªç¯ä¸­æ“ä½œåŒä¸€ä¸ª fd ä¼šä¸ä¼šå‡ºç°ä¸Šé¢çš„ç¡¬ç›˜ä¾ç„¶ä¼‘çœ çš„é—®é¢˜\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;os\u0026quot; \u0026quot;time\u0026quot; ) func main() { p := \u0026quot;/Volumes/4t/DO_NOT_SLEEP\u0026quot; for { f, err := os.OpenFile(p, os.O_CREATE|os.O_RDWR, 0777) if err != nil { panic(err) } f.WriteString(\u0026quot;123\u0026quot;) log.Println(\u0026quot;write ok\u0026quot;) f.Close() time.Sleep(time.Second * 5) } } å¯èƒ½çš„åŸå›  æ— æ„é—´çœ‹åˆ°ä¸€ç›˜ é¡µç¼“å­˜ çš„æ–‡ç« ï¼Œé‡Œé¢è¯´ç³»ç»Ÿä¼šæŠŠç£ç›˜é‡Œçš„å†…å®¹æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œä¸‹æ¬¡å¦‚æœè®¿é—®åŒæ ·çš„å†…å®¹ï¼Œåˆ™ä¸éœ€è¦è¯»å–ç¡¬ç›˜ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–å³å¯ï¼Œè¿™æ ·å°±é¿å…äº† IO çš„å¼€é”€ï¼Œæé«˜äº†æ€§èƒ½ã€‚å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£ä¹ˆé—®é¢˜2 å°±è§£é‡Šçš„é€šäº†\n","date":"2022å¹´06æœˆ08æ—¥","permalink":"/posts/go_seek/","summary":"å¼•å­ æœ€è¿‘ä¹°äº†å—æœºæ¢°ç¡¬ç›˜ä½œä¸ºä»“åº“ç›˜ï¼Œç”¨ç¡¬ç›˜ç›’è¿æ¥åˆ° macï¼Œä½†æ˜¯è¿™å—ç¡¬ç›˜è²Œä¼¼æœ‰ä¼‘çœ æœºåˆ¶ï¼ˆä¸ç¡®å®šï¼‰ï¼Œå¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰è¯»å†™æ“ä½œå°±ä¼šåœè½¬ï¼Œç­‰åˆ°éœ€è¦æ“ä½œæ—¶æ‰ä¼šå”¤é†’ï¼Œå”¤é†’ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ç£ç›˜å¯åŠ¨å£°éŸ³ï¼Œå¹¶ä¸”éœ€è¦ç­‰å¾… 5s å·¦å³æ‰èƒ½ä½¿ç”¨ã€‚","title":"go æ–‡ä»¶æ“ä½œçš„\"å‘\"ä¹‹ Seek()"},{"contents":" è¯´æ˜ï¼šæ–‡ç« çš„éƒ¨åˆ†åœ°æ–¹ä¼šç”¨ cm æ¥æŒ‡ä»£ ConfigMap\nå¼•å­ åšè¿‡å¼€å‘çš„åŒå­¦éƒ½é‡åˆ°è¿‡ç»™ç¨‹åºè¿›è¡Œé…ç½®çš„åœºæ™¯ï¼Œæ¯”å¦‚éå¸¸å¸¸è§çš„é…ç½®æ–‡ä»¶ï¼Œå°† Mysql çš„åœ°å€ã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯å†™åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶é‡Œï¼Œç„¶åç¨‹åºå†…éƒ¨é€šè¿‡è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶æ¥è·å–ä¿¡æ¯ï¼Œé˜²æ­¢äº†ç¡¬ç¼–ç ä¿¡æ¯åˆ°ç¨‹åºå†…éƒ¨ï¼Œè¿™æ ·å¦‚æœå‘ç”Ÿå˜åŠ¨åªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ•´ä¸ªç¨‹åºï¼›å¦ä¸€ç§å¸¸è§çš„æ–¹å¼æ˜¯è¿è¡Œç¨‹åºæ—¶æŒ‡å®šå‚æ•°æ¥è¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚ Go æ ‡å‡†åº“é‡Œçš„ flag åŒ…å°±å¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œå‚æ•°æŒ‡å®šï¼Œç„¶åè¿è¡Œæ—¶åªè¦ä½¿ç”¨è¯¸å¦‚ go run main.go -a 123 -b 456 è¿™æ ·çš„æ–¹å¼ï¼Œä¾¿å¯è¯»å–åˆ°é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨è¿™ä¸ªä¾‹å­é‡Œä¼ é€’äº†ä¸¤ä¸ªå‚æ•°ï¼ša=123ï¼Œb=456\né‚£ä¹ˆåœ¨ k8s ä¸­å¦‚ä½•å¯¹å®¹å™¨è¿›è¡Œé…ç½®å‘¢ï¼Ÿ\nåœ¨ docker ä¸­å®šä¹‰å‘½ä»¤ä¸å‚æ•° å®¹å™¨ä¸­è¿è¡Œçš„å®Œæ•´æŒ‡ä»¤ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå‘½ä»¤å’Œå‚æ•°ï¼Œæ¯”å¦‚ ./main -a 123ï¼Œmain å°±æ˜¯å‘½ä»¤ï¼Œ-a å°±æ˜¯å‚æ•°ï¼Œåœ¨ Dockerfile ä¸­åˆ†åˆ«å¯¹åº”çš„æ˜¯ ENTRYPOINTï¼ˆå‘½ä»¤ï¼‰å’Œ CMDï¼ˆå‚æ•°ï¼‰ã€‚\nå®æˆ˜ï¼š\nè¿™ä¸ª image ä¼šè°ƒç”¨ fortuneloop.shï¼š\nFROM ubuntu:latest RUN apt-get update ; apt-get -y install fortune # å®‰è£… fortune ADD fortuneloop.sh /bin/fortuneloop.sh ENTRYPOINT [\u0026quot;/bin/fortuneloop.sh\u0026quot;] CMD [\u0026quot;10\u0026quot;] # æ¯éš” 10s è¾“å‡ºä¸€æ¬¡ è¿™é‡ŒæŒ‡å®šäº† ENTRYPOINT å’Œ CMDï¼Œç­‰åŒäºå‘½ä»¤ /bin/fortuneloop.sh 10\né™„ï¼šfortuneloop.sh æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n#!/bin/bash trap \u0026quot;exit\u0026quot; SIGINT INTERVAL=$1 # è¯»å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ¯”å¦‚æ‰§è¡Œ fortuneloop.sh 10ï¼Œé‚£ä¹ˆ $1=10 echo Configured to generate new fortune every $INTERVAL seconds mkdir -p /var/htdocs while : do echo $(date) Writing fortune to /var/htdocs/index.html /usr/games/fortune \u0026gt; /var/htdocs/index.html # æ‰§è¡Œ fortune å‘½ä»¤ï¼Œå°†è¾“å‡ºçš„å†…å®¹å†™å…¥åˆ° index.html sleep $INTERVAL # ç¡çœ æŒ‡å®šçš„æ—¶é—´ done æ¥ä¸‹æ¥æ„å»ºå¹¶è¿è¡Œï¼š\n# æ„å»ºé•œåƒ $ docker build -t stdoutt/fortune-args-arm64 . # è¿è¡Œ $ docker run -it stdoutt/fortune-args-arm6 # è§‚å¯Ÿæ•ˆæœ # æ¯éš” 10s å°±ä¼šæ‰“å°ä¸€æ¬¡ Configured to generate new fortune every 10 seconds Sun Sep 25 02:23:01 UTC 2022 Writing fortune to /var/htdocs/index.html Sun Sep 25 02:23:11 UTC 2022 Writing fortune to /var/htdocs/index.html å› ä¸ºåœ¨ Dockerfile çš„ CMD ä¸­æŒ‡å®šå€¼ä¸º 10ï¼Œæ‰€ä»¥é»˜è®¤ä¼šæ¯éš” 10 ç§’æ‰“å°ä¸€æ¬¡ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šå€¼å°†é»˜è®¤å€¼è¦†ç›–æ‰ï¼š\n$ docker run -it stdoutt/fortune-args-arm6 1 Configured to generate new fortune every 1 seconds Sun Sep 25 02:24:55 UTC 2022 Writing fortune to /var/htdocs/index.html Sun Sep 25 02:24:56 UTC 2022 Writing fortune to /var/htdocs/index.html Sun Sep 25 02:24:57 UTC 2022 Writing fortune to /var/htdocs/index.html ç°åœ¨æ¯é—´éš” 1s å°±ä¼šæ‰“å°ä¸€æ¬¡\nåœ¨ k8s ä¸­å®šä¹‰å‘½ä»¤ä¸å‚æ•° åœ¨ k8s ä¸­å®šä¹‰å®¹å™¨æ—¶ï¼Œå¯ä»¥è¦†ç›–æ‰é•œåƒçš„ ENTRYPOINT å’Œ CMDï¼Œé€šè¿‡ command å’Œ args æ¥æŒ‡å®šï¼Œç±»ä¼¼ä¸€ä¸‹è¿™ç§å½¢å¼ï¼š\nkind: Pod spec: containers: - image: some/image command: [\u0026quot;/bin/command\u0026quot;] # ç­‰åŒäº Dockerfile ä¸­çš„ ENTRYPOINT args: [\u0026quot;argl\u0026quot;, \u0026quot;arg2\u0026quot;, \u0026quot;arg3\u0026quot;] # ç­‰åŒäº Dockerfile ä¸­çš„ CMD å…¶ä¸­ command ç­‰åŒäº Dockerfile ä¸­çš„ ENTRYPOINTï¼Œargs ç­‰åŒäº Dockerfile ä¸­çš„ CMD\nå®æˆ˜ yaml å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod metadata: name: fortune2s spec: containers: - image: stdoutt/fortune-args-arm64 # æ³¨æ„æ­¤ image ä»…é€‚ç”¨äº arm64 args: [\u0026quot;2\u0026quot;] # ç­‰åŒäº Dockerfile ä¸­çš„ CMD name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} æµ‹è¯•æ•ˆæœï¼š\n# åˆ›å»º pod $ kubectl apply -f fortune-pod-args.yaml pod/fortune2s created # å¼€å¯ç«¯å£è½¬å‘ $ kubectl port-forward fortune2s 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 # æ¯éš” 2s ï¼ˆå’Œ args ä¸­å®šä¹‰çš„ä¸€æ ·ï¼‰curl ä¸€æ¬¡ï¼Œå› ä¸º args ä¹Ÿå®šä¹‰ä¸º 2sï¼Œä»£è¡¨æ¯ 2s å†™å…¥ä¸€æ¬¡è°šè¯­ï¼Œæ‰€ä»¥ # æ¯æ¬¡ curl éƒ½åº”è¯¥è¾“å‡ºä¸åŒçš„å†…å®¹ $ while true;do curl localhost:8080;sleep 2s;done Wagner's music is better than it sounds. -- Mark Twain You plan things that you do not even attempt because of your extreme caution. You never hesitate to tackle the most difficult problems. The lovely woman-child Kaa was mercilessly chained to the cruel post of the warrior-chief Beast, with his barbarian tribe now stacking wood at her nubile feet, when the strong clear voice of the poetic and heroic Handsomas roared, 'Flick your Bic, crisp that chick, and you'll feel my steel through your last meal!' -- Winning sentence, 1984 Bulwer-Lytton bad fiction contest. åœ¨å®¹å™¨å®šä¹‰ä¸­æŒ‡å®šç¯å¢ƒå˜é‡ Dockerfile\nFROM ubuntu:latest RUN apt-get update ; apt-get -y install fortune ADD fortuneloop.sh /bin/fortuneloop.sh ENTRYPOINT [\u0026quot;/bin/fortuneloop.sh\u0026quot;] fortuneloop.sh\n#!/bin/bash trap \u0026quot;exit\u0026quot; SIGINT echo Configured to generate new fortune every $INTERVAL seconds mkdir -p /var/htdocs while : do echo $(date) Writing fortune to /var/htdocs/index.html /usr/games/fortune \u0026gt; /var/htdocs/index.html sleep $INTERVAL # è¯»å– INTERVAL è¿™ä¸ªç¯å¢ƒå˜é‡ done fortune-pod-env.yaml\napiVersion: v1 kind: Pod metadata: name: fortune-env spec: containers: - image: stdoutt/fortune-env-arm64 # æ³¨æ„æ­¤ image ä»…é€‚ç”¨äº arm64 env: # åœ¨è¿™é‡Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨äº fortuneloop.sh çš„è¯»å– - name: INTERVAL value: \u0026quot;5\u0026quot; name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} æµ‹è¯•æ•ˆæœï¼š\n$ kubectl apply -f fortune-env.yaml pod/fortune-env created $ kubectl get po NAME READY STATUS RESTARTS AGE fortune2s 2/2 Running 0 84m fortune-env 2/2 Running 0 18s $ kubectl port-forward fortune-env 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 $ while true;do curl localhost:8080;sleep 5s;done # sleep åŒæ ·çš„æ—¶é—´ It may or may not be worthwhile, but it still has to be done. When I reflect upon the number of disagreeable people who I know who have gone to a better world, I am moved to lead a different life. -- Mark Twain, \u0026quot;Pudd'nhead Wilson's Calendar\u0026quot; # è¿™é‡Œé¢å¤–æµ‹è¯•ä¸€ä¸‹ï¼Œç¯å¢ƒå˜é‡é‡Œè®¾ç½®çš„å€¼æ˜¯ 5ï¼Œä¹Ÿå°±æ˜¯æ¯ 5s ç”Ÿæˆä¸€å¥æ–°è°šè¯­å¹¶å†™å…¥ index.htmlï¼Œ # ä½†æ˜¯è¿™é‡Œæ¯éš” 1s å°± curl ä¸€æ¬¡ï¼Œä¼šå‘ç°å‰ 5 æ­¤è¾“å‡ºçš„å†…å®¹éƒ½ç›¸åŒ $ while true;do curl localhost:8080;sleep 1s;done You will be surrounded by luxury. You will be surrounded by luxury. You will be surrounded by luxury. You will be surrounded by luxury. You will be surrounded by luxury. Q:\tWhat happens when four WASPs find themselves in the same room? A:\tA dinner party. ConfigMap ä¸Šé¢çš„æ–¹å¼éƒ½æ˜¯ç›´æ¥åœ¨ pod ä¸­ç¡¬ç¼–ç çš„ï¼Œå°±åƒ - name: INTERVAL value: \u0026quot;5\u0026quot; è¿™æ ·ï¼Œå¦‚æœä¹‹åéœ€è¦æ›´æ”¹ value çš„å€¼ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹ pod çš„ yamlï¼Œç„¶ååˆ é™¤æ—§çš„é‡æ–°åˆ›å»ºæ–°çš„ï¼ˆè¿™é‡Œè¿˜å¾…éªŒè¯ï¼‰ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚\nConfigMap å°†é…ç½®ç›¸å…³çš„å†…å®¹æŠ½å–å‡ºæ¥åšæˆäº†ä¸€ä¸ªå•ç‹¬çš„éƒ¨åˆ†ï¼Œç„¶å pod å†å¼•ç”¨ ConfigMap å³å¯ï¼ˆåˆæ˜¯ä¸‡èƒ½çš„è§£å†³æ–¹æ³•ï¼šåŠ ä¸€å±‚ä¸­é—´å±‚ï¼‰ï¼Œç›¸æ¯”è¾ƒç›´æ¥åœ¨ pod spec ä¸­çš„ç¡¬ç¼–ç è€Œè¨€æ›´åŠ çµæ´»ã€‚\nå‘½ä»¤ ä½¿ç”¨ create å‘½ä»¤è€Œä¸æ˜¯ yaml æ¥åˆ›å»ºä¸€ä¸ª configmapï¼ˆä¹‹åç®€ç§°ä¸º cmï¼‰ï¼Œé€šè¿‡ --from-literal æ¥æŒ‡å®šé”®å€¼å¯¹ï¼ˆkvï¼‰ï¼Œå½¢å¼ä¸ºï¼š\u0026ndash;from-literal=[key]=[value]\n$ kubectl create configmap fortune-config --from-literal=sleep-interval=25 configmap/fortune-config created é€šè¿‡æŒ‡å®šå¤šä¸ª --from-literal æ¥æ·»åŠ å¤šä¸ª kvï¼š\n$ kubectl create configmap myconfigmap --from-literal=foo=bar --from-literal=bar=baz --from-literal=one=two configmap/myconfigmap created æŸ¥çœ‹ cm çš„ yamlï¼š\n$ kubectl get cm myconfigmap -o yaml apiVersion: v1 data: bar: baz foo: bar one: two kind: ConfigMap metadata: creationTimestamp: \u0026quot;2022-06-07T11:39:32Z\u0026quot; name: myconfigmap namespace: default resourceVersion: \u0026quot;73938\u0026quot; uid: c9814e7e-f3f9-4149-8530-74ea963420d9 å‘ç°å…¶å®å®šä¹‰çš„ kv éƒ½åœ¨ data é‡Œï¼Œmetadata é‡Œå”¯ä¸€éœ€è¦æ˜ç¡®æŒ‡å®šçš„æ˜¯ nameï¼Œæ‰€ä»¥é€šè¿‡ yaml çš„å½¢å¼æ¥åˆ›å»º cm ä¹Ÿæ¯”è¾ƒç®€å•\nå¦‚æœæ·»åŠ ä¸¤ä¸ªåŒæ ·çš„ key ä¼šæ€æ ·ï¼Ÿ\n$ kubectl create configmap fortune-config1 --from-literal=sleep-interval=25 --from-literal=sleep-interval=30 error: cannot add key \u0026quot;sleep-interval\u0026quot;, another key by that name already exists in Data for ConfigMap \u0026quot;fortune-config1\u0026quot; å¯ä»¥çœ‹åˆ°ç›´æ¥åˆ›å»ºå¤±è´¥äº†\ncm è¿˜å¯ä»¥å°†æŸä¸ªæ–‡ä»¶çš„å†…å®¹ä½œä¸º value å€¼ï¼Œä½¿ç”¨ --from-file æ¥å¼•ç”¨æ–‡ä»¶ï¼š\n$ kubectl create cm my-config --from-file=conf.conf configmap/my-config created conf.conf å†…å®¹å¦‚ä¸‹ï¼š\na:a a:a b:b c:c d:d æŸ¥çœ‹è¯¥ cm çš„ yamlï¼š\n$ kubectl get cm my-config -o yaml apiVersion: v1 data: conf.conf: | a:a b:b c:c d:d kind: ConfigMap metadata: creationTimestamp: \u0026quot;2022-06-07T12:58:09Z\u0026quot; name: my-config namespace: default resourceVersion: \u0026quot;77327\u0026quot; uid: 2937d396-8692-4c16-8798-236fc4015299 å‘ç°è¿™é‡Œæ˜¯ç”¨æ–‡ä»¶åæ¥åš key çš„ï¼Œvalue å°±æ˜¯æ–‡ä»¶çš„å†…å®¹ï¼Œåªä¸è¿‡ä¸æ˜¯å¸¸è§„çš„ key:value å½¢å¼ï¼Œè€Œæ˜¯åœ¨ key: åå¤šåŠ äº†ä¸€ä¸ª |ï¼Œä¹‹åæ‰æ˜¯ value\nåŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå¤šä¸ª --from-file æ¥å¼•ç”¨å¤šä¸ªæ–‡ä»¶ä½œä¸º cm çš„æ¡ç›®ï¼Œæ¯”å¦‚ï¼ˆè¿™é‡Œæˆ‘è¿˜ä¸“é—¨æµ‹è¯•äº†ä¸€ä¸‹è¯¥ flag æ˜¯å¦å¯¹æ–‡ä»¶åç¼€æœ‰è¦æ±‚ï¼Œæˆ‘ä¼ å…¥äº†ä¸€ä¸ª txtï¼Œè¿™ä¸æ˜¯å¸¸è§çš„é…ç½®æ–‡ä»¶åç¼€ï¼‰ï¼š\n$ kubectl create cm my-config1 --from-file=conf.conf --from-file conf.txt configmap/my-config1 created æŸ¥çœ‹ yamlï¼š\n$ kubectl get cm my-config1 -o yaml apiVersion: v1 data: conf.conf: | a:a b:b c:c d:d conf.txt: | å¤§æ•°æ®æ–­å¼€äº†æ’’å¨‡æ¼æ‰“å¡æ‰€ç»å†çš„å¡æ‰€ç»å†çš„ kind: ConfigMap metadata: creationTimestamp: \u0026quot;2022-06-07T13:13:16Z\u0026quot; name: my-config1 namespace: default resourceVersion: \u0026quot;77980\u0026quot; uid: 3332d608-4184-48bc-8481-bd78ccf8b312 è²Œä¼¼è¿™é‡Œæ˜¯ç›´æ¥ç®€å•ç²—æš´çš„æŠŠæ–‡ä»¶å†…å®¹ä½œä¸º value äº†ï¼Œè‡³äºæ–‡ä»¶åç¼€æ˜¯ä»€ä¹ˆï¼Œcm ä¸ä¼šå»è€ƒè™‘ï¼Œä¸è¿‡æƒ³æƒ³ç¡®å®ä¹Ÿåªèƒ½è¿™ä¹ˆåšï¼Œæ¯•ç«Ÿé…ç½®æ–‡ä»¶åç¼€éå¸¸å¤šï¼Œconfã€yamlã€toml ç­‰ç­‰ï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›å†·é—¨çš„æ ¼å¼ï¼Œå¦‚æœè¦ä¸“é—¨ç»´æŠ¤ä¸€ä¸ªå…è®¸çš„åç¼€åˆ—è¡¨æ˜¾ç„¶å¤ªéº»çƒ¦äº†ï¼Œä¹Ÿæ²¡å•¥å¤ªå¤§å¿…è¦ã€‚\nä¸Šé¢çš„ key éƒ½æ˜¯ç›´æ¥ä½¿ç”¨æ–‡ä»¶åï¼Œå¦‚æœæƒ³è‡ªè¡ŒæŒ‡å®šï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„è¯­å¥ï¼š\n$ kubectl create cm my-config1 --from-file=myconf=conf.conf è¿™é‡Œè®¾ç½® key ä¸º myconfï¼Œä¹Ÿå°±æ˜¯è¯´æ ¼å¼æ˜¯ï¼š\u0026ndash;from-file=[è‡ªå®šä¹‰ key å]=[value]\nç»™å®¹å™¨ä¼ é€’ ConfigMap ä½œä¸ºç¯å¢ƒå˜é‡ fortune-pod-env-configmap.yaml\napiVersion: v1 kind: Pod metadata: name: fortune-env-from-configmap spec: containers: - image: stdoutt/fortune-env-arm64 # æ³¨æ„è¯¥ image ä»…é€‚ç”¨äº arm64 env: - name: INTERVAL valueFrom: configMapKeyRef: name: fortune-config key: sleep-interval name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} å¦‚æœå¼•ç”¨çš„ ConfigMap ä¸å­˜åœ¨ä¼šæ€æ · æµ‹è¯•ï¼š\n$ kubectl apply -f fortune-pod-env-configmap.yaml pod/fortune-env-from-configmap created $ kubectl get po NAME READY STATUS RESTARTS AGE fortune2s 2/2 Running 0 117m fortune-env 2/2 Running 0 33m fortune-env-from-configmap 1/2 CreateContainerConfigError 0 2m27s å‘ç°å½“å‰ pod çš„çŠ¶æ€æ˜¯ CreateContainerConfigErrorï¼Œè¿™æ˜¯è‚¯å®šçš„ï¼Œenv ä¼šä»åä¸º keyfortune-config çš„ configMap ä¸­è¯»å–ï¼Œä½†æ˜¯ç°åœ¨æ²¡æœ‰åˆ›å»ºè¿™ä¸ª configMapï¼Œæ‰€ä»¥å½“ç„¶æ— æ³•æ­£å¸¸å¯åŠ¨\næŸ¥çœ‹ describe ä¹Ÿä¼šå‘ç°æœ‰ç›¸åº”çš„è­¦å‘Šï¼š\nWarning Failed 80s (x7 over 2m28s) kubelet Error: configmap \u0026quot;fortune-config\u0026quot; not found éœ€è¦åˆ›å»ºä¸€ä¸ª configMap æ¥è§£å†³ï¼š\n# åˆ›å»ºä¸€ä¸ª configMapï¼ŒåŒæ—¶å‘å…¶ä¸­å†™å…¥ sleep-interval=5 $ kubectl create configmap fortune-config --from-literal=sleep-interval=5 configmap/fortune-config created # åœ¨åˆ›å»ºå®Œ configMap ä¹‹åï¼Œä¹‹å‰çš„ pod ç«‹é©¬æˆåŠŸè¿è¡Œäº† $ kubectl get po NAME READY STATUS RESTARTS AGE fortune2s 2/2 Running 0 121m fortune-env 2/2 Running 0 37m fortune-env-from-configmap 2/2 Running 0 7m3s ä¹Ÿå°±æ˜¯è¯´å¦‚æœå¼•ç”¨çš„ ConfigMap ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆ pod ä¼šåˆ›å»ºå¤±è´¥ï¼Œå½“æ‰€éœ€è¦çš„ ConfigMap è¢«åˆ›å»ºåï¼Œè¿™ä¸ªå¤±è´¥çš„ pod ä¼šè‡ªåŠ¨é‡å¯ï¼Œæ— é¡»é‡æ–°åˆ›å»º podã€‚\n$ kubectl port-forward fortune-env 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 $ while true;do curl localhost:8080;sleep 5s;done You'll feel much better once you've given up hope. When I reflect upon the number of disagreeable people who I know who have gone to a better world, I am moved to lead a different life. -- Mark Twain, \u0026quot;Pudd'nhead Wilson's Calendar\u0026quot; ç»™å®¹å™¨ä¼ é€’ ConfigMap ä½œä¸ºå‚æ•° pod.spec.containers.args ä¸èƒ½ç›´æ¥å¼•ç”¨ ConfigMap ä¸­çš„æ¡ç›®ï¼Œä½†æ˜¯å¯ä»¥â€æ›²çº¿æ•‘å›½â€œï¼Œå°† ConfigMap ä¸­çš„æ¡ç›®è®¾ç½®ä¸ºä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œç„¶åå†è®© args æ¥å¼•ç”¨è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œä¾¿å¯è¾¾åˆ°æ•ˆæœã€‚\nfortune-pod-args-configmap.yaml\napiVersion: v1 kind: Pod metadata: name: fortune-args-from-configmap spec: containers: - image: stdoutt/fortune-args-arm64 # æ³¨æ„è¯¥ image ä»…é€‚ç”¨äº arm64 env: - name: INTERVAL # è¿™ä¸ªç¯å¢ƒå˜é‡å¼•ç”¨äº† fortune-config ä¸­çš„ sleep-interval æ¡ç›® valueFrom: configMapKeyRef: name: fortune-config key: sleep-interval args: [\u0026quot;$(INTERVAL)\u0026quot;] # å¼•ç”¨ INTERVAL è¿™ä¸ªç¯å¢ƒå˜é‡ name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} æµ‹è¯•æ•ˆæœï¼š\n$ kubectl apply -f fortune-pod-args-configmap.yaml pod/fortune-args-from-configmap created $ kubectl get po NAME READY STATUS RESTARTS AGE fortune2s 2/2 Running 0 7h13m fortune-env 2/2 Running 0 5h49m fortune-env-from-configmap 2/2 Running 0 5h18m fortune-args-from-configmap 2/2 Running 0 5s $ kubectl port-forward fortune-env 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 $ while true;do curl localhost:8080;sleep 5s;done What good is an obscenity trial except to popularize literature? -- Nero Wolfe, \u0026quot;The League of Frightened Men\u0026quot; They spell it \u0026quot;da Vinci\u0026quot; and pronounce it \u0026quot;da Vinchy\u0026quot;. Foreigners always spell better than they pronounce. -- Mark Twain Give your very best today. Heaven knows it's little enough. ä½¿ç”¨ ConfigMap å· å‰é¢æåˆ°çš„ç¯å¢ƒå˜é‡æˆ–è€…æ˜¯å‚æ•°çš„æ–¹å¼æ¯”è¾ƒé€‚ç”¨äºé…ç½®æ•°é‡è¾ƒå°‘çš„æƒ…å†µï¼Œå¦‚æœé…ç½®æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆå°±ä¸å¤ªé€‚åˆäº†ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œæ¯”å¦‚ nginx ï¼Œä¹Ÿä¸å¤ªé€‚åˆã€‚ï¼ˆå¾…ä¿®æ”¹ï¼‰\nè¿˜å¯ä»¥å°† ConfigMap æŒ‚è½½ï¼ˆæ„Ÿè§‰æŒ‚è½½è¿™ä¸ªè¯æœ‰ç‚¹ä¸å¤ªåˆé€‚ï¼‰ åšæˆä¸€ä¸ª å·ï¼Œç„¶åpod ä¸­çš„å®¹å™¨å¯ä»¥å°†è¿™ä¸ªå·æŒ‚è½½åˆ°è‡ªå·±çš„æŸä¸ªç›®å½•ä¸‹ï¼Œæ¥å®Œæˆé…ç½®ï¼Œæ¯”å¦‚ä¸€ä¸ª nginx å®¹å™¨å¯ä»¥å°†å·æŒ‚è½½åˆ°è‡ªå·±çš„ /etc/nginx/conf.d ç›®å½•ä¸‹ï¼Œå°±å¯ä»¥è¯»å–å·ä¸­çš„é…ç½®ä¿¡æ¯ã€‚\nconfigMapå·ä¼šå°† ConfigMap ä¸­çš„æ¯ä¸ªæ¡ç›®å‡æš´éœ²æˆä¸€ä¸ªæ–‡ä»¶ã€‚ è¿è¡Œåœ¨å®¹å™¨ä¸­çš„è¿›ç¨‹å¯é€šè¿‡è¯»å–æ–‡ä»¶å†…å®¹è·å¾—å¯¹åº”çš„æ¡ç›®å€¼ ã€‚\nå®è·µ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ configmap-filesï¼š\n$ mkdir configmap-files ç„¶åå‘é‡Œé¢å†™å…¥ä¸‹é¢çš„è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼š\nmy-nginx-config.conf\nserver { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } sleep-interval\n25 æŸ¥çœ‹æ–‡ä»¶å¤¹ï¼š\n$ tree . â”œâ”€â”€ my-nginx-config.conf â””â”€â”€ sleep-interval åˆ›å»ºä¸€ä¸ª cmï¼Œå°†è¿™ä¸ªæ–‡ä»¶å¤¹ä½œä¸º value\n$ kubectl create configmap fortune-config --from-file=configmap-files error: failed to create configmap: configmaps \u0026quot;fortune-config\u0026quot; already exists å‘ç°ä¹‹å‰ä»¥åŠå­˜åœ¨åŒåçš„ cm äº†ï¼Œçœ‹æ¥é‡å¤åˆ›å»º cm ä¸èƒ½è¦†ç›–æ›´æ–°ï¼Œå¿…é¡»è¦åˆ é™¤æ—§çš„æ‰èƒ½åˆ›å»ºæ–°çš„ï¼š\n$ kubectl get cm NAME DATA AGE kube-root-ca.crt 1 21h fortune-config 1 6h4m $ kubectl delete cm fortune-config configmap \u0026quot;fortune-config\u0026quot; deleted $ kubectl create configmap fortune-config --from-file=configmap-files configmap/fortune-config created # æŸ¥çœ‹ cm $ kubectl get cm fortune-config -o yaml apiVersion: v1 data: my-nginx-config.conf: | server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } sleep-interval: | 25 kind: ConfigMap metadata: creationTimestamp: \u0026quot;2022-09-25T11:05:49Z\u0026quot; name: fortune-config namespace: default resourceVersion: \u0026quot;12886\u0026quot; uid: c9f5ee8a-9078-46cc-955a-3ec72c6ceb62 å‘ç°è¯¥ cm æœ‰ä¸¤ä¸ªæ¡ç›®ï¼Œæ¡ç›®åå°±æ˜¯ç›®æ ‡æ–‡ä»¶å¤¹ä¸‹çš„æ¯ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åï¼Œvalue å°±æ˜¯æ–‡ä»¶å†…å®¹\næ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ª podï¼Œè¿™ä¸ª pod é‡Œçš„ nginx å®¹å™¨ä¼šå°† configMap å·æŒ‚è½½åˆ°è‡ªå·±çš„ /etc/nginx/conf.d ç›®å½•ä¸‹ï¼Œè€Œ nginx ä¼šè‡ªåŠ¨å°†è¯¥è·¯å¾„ä¸‹çš„æ‰€æœ‰ä»¥ conf ä¸ºåç¼€çš„æ–‡ä»¶åµŒå…¥åˆ°é»˜è®¤é…ç½®æ–‡ä»¶ä¸­ï¼Œè€Œ configMap å·é‡Œé¢åˆšå¥½æœ‰æˆ‘ä»¬å®šä¹‰çš„å¼€å¯äº† gzip çš„é…ç½®æ–‡ä»¶ my-nginx-config.confï¼Œnginx è¯»å–è¿™ä¸ªæ–‡ä»¶æ¥å¼€å¯ gzipï¼Œè€Œå·ä¸­çš„å¦ä¸€ä¸ªæ–‡ä»¶ sleep-interval å› ä¸ºä¸æ˜¯ä»¥ conf ä¸ºåç¼€çš„ï¼Œæ‰€ä»¥ nginx ä¸ä¼šå°†å…¶å†…å®¹åµŒå…¥åˆ°é…ç½®æ–‡ä»¶ã€‚\nfortune-configmap-volume\napiVersion: v1 kind: Pod metadata: name: fortune-configmap-volume spec: containers: - image: stdoutt/fortune-env-arm64 env: - name: INTERVAL # ä» fortune-config è¿™ä¸ª configmap ä¸­è¯»å– sleep-intervalï¼Œç”¨å…¶å€¼å¡«å……ç¯å¢ƒå˜é‡ INTERVAL valueFrom: configMapKeyRef: name: fortune-config key: sleep-interval name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true - name: config mountPath: /etc/nginx/conf.d # å°† config å·æŒ‚è½½åˆ°è¯¥è·¯å¾„ä¸‹ readOnly: true - name: config mountPath: /tmp/whole-fortune-config-volume # å°† config å·æŒ‚è½½åˆ°è¯¥è·¯å¾„ä¸‹ readOnly: true ports: - containerPort: 80 name: http protocol: TCP volumes: - name: html emptyDir: {} - name: config # å®šä¹‰ä¸€ä¸ªåä¸º config çš„å·ï¼Œå·å¼•ç”¨äº† fortune-config è¿™ä¸ª cm é‡Œçš„å†…å®¹ï¼Œä¼šå°†æ¯ä¸ªæ¡ç›®åšæˆä¸€ä¸ªæ–‡ä»¶ configMap: name: fortune-config æµ‹è¯•æ•ˆæœï¼š\n$ kubectl apply -f fortune-pod-configmap-volume.yaml $ kubectl get po NAME READY STATUS RESTARTS AGE fortune-configmap-volume 2/2 Running 0 13s $ kubectl port-forward fortune-configmap-volume 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 $ curl -H \u0026quot;Accept-Encoding: gzip\u0026quot; -I localhost:8080 HTTP/1.1 200 OK Server: nginx/1.23.1 Date: Sun, 25 Sep 2022 11:38:16 GMT Content-Type: text/html Last-Modified: Sun, 25 Sep 2022 11:38:06 GMT Connection: keep-alive ETag: W/\u0026quot;63303d9e-135\u0026quot; Content-Encoding: gzip # è¿™é‡Œè¯´æ˜å·²ç»å¼€å¯äº† gzip å‹ç¼©ï¼Œé…ç½®æ–‡ä»¶å·²ç»ç”Ÿæ•ˆ éªŒè¯æŒ‚è½½ï¼š\nå‰é¢æåˆ°è¿‡ ConfigMap å·ä¼šå°† config ä¸­çš„æ¯ä¸ªæ¡ç›®å•ç‹¬åšæˆä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å®é™…éªŒè¯ä¸€ä¸‹ï¼š\n# è¿›å…¥ web-server è¿™ä¸ªå®¹å™¨ $ kubectl exec -it fortune-configmap-volume -c web-server -- /bin/sh # çœ‹ä¸€ä¸‹æŒ‚è½½è·¯å¾„ / # ls /tmp/whole-fortune-config-volume/ my-nginx-config.conf sleep-interval / # ls /etc/nginx/conf.d my-nginx-config.conf sleep-interval # å‘ç° configMap å·å…¨éƒ¨éƒ½è¢«æŒ‚è½½äº†ï¼Œä¸”é‡Œé¢æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº” cm ä¸­çš„ä¸€ä¸ªæ¡ç›® # è¾“å‡ºä¸€ä¸‹æ–‡ä»¶å†…å®¹ / # cat /etc/nginx/conf.d/sleep-interval 25 / # cat /tmp/whole-fortune-config-volume/my-nginx-config.conf server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } åªæŒ‚è½½ ConfigMap ä¸­çš„éƒ¨åˆ†æ¡ç›® ä¸Šé¢çš„ä¾‹å­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šsleep-interval è¿™ä¸ªé…ç½®æ–‡ä»¶ä¹Ÿè¢«æŒ‚è½½åˆ°äº† nginx çš„ç›®å½•ä¸‹ï¼Œä½†æ˜¯è¯¥é…ç½®æ–‡ä»¶ä¸ nginx æ˜¯æ²¡ä»»ä½•å…³ç³»çš„ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ç”¨æŒ‡å®š items çš„æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š\nfortune-pod-configmap-volume-with-items\napiVersion: v1 kind: Pod metadata: name: fortune-configmap-volume-with-items spec: containers: - image: stdoutt/fortune-env-arm64 name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true - name: config mountPath: /etc/nginx/conf.d/ readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} - name: config configMap: name: fortune-config items: - key: my-nginx-config.conf # å¼•ç”¨ cm ä¸­çš„ my-nginx-config.conf è¿™æ¡æ¡ç›® path: gzip.conf # å°†è¿™æ¡æ¡ç›®çš„å†…å®¹æ”¾åˆ°ä¸€ä¸ªåä¸º gzip.conf çš„æ–‡ä»¶ä¸­ æµ‹è¯•æ•ˆæœï¼š\n$ kubectl apply -f fortune-pod-configmap-volume-with-items $ kubectl get po NAME READY STATUS RESTARTS AGE fortune2s 2/2 Running 0 10h fortune-env 2/2 Running 0 8h fortune-env-from-configmap 2/2 Running 0 8h fortune-args-from-configmap 2/2 Running 0 171m fortune-configmap-volume 2/2 Running 0 92m fortune-configmap-volume-with-items 2/2 Running 0 14s $ kubectl exec -it fortune-configmap-volume-with-items -c web-server -- /bin/sh / # ls /etc/nginx/ conf.d/ fastcgi_params modules/ scgi_params fastcgi.conf mime.types nginx.conf uwsgi_params / # ls /etc/nginx/conf.d gzip.conf / # cat /etc/nginx/conf.d/gzip.conf server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } å¯ä»¥çœ‹åˆ°æŒ‚è½½çš„ç›®å½• /etc/nginx/conf.d ä¸‹åªæœ‰ gzip.conf è¿™ä¸€ä¸ªæ–‡ä»¶äº†ï¼Œä¹‹å‰çš„ sleep-interval æ–‡ä»¶å·²ç»æ²¡æœ‰äº†ï¼Œå¹¶ä¸” gzip.conf æ–‡ä»¶çš„å†…å®¹å°±æ˜¯ configMap ä¸­ my-nginx-config.conf è¿™ä¸ªæ¡ç›®çš„å†…å®¹ã€‚\nçƒ­æ›´æ–° ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–è€…å‘½ä»¤è¡Œå‚æ•°ä½œä¸ºé…ç½®æºçš„å¼Šç«¯åœ¨äºæ— æ³•åœ¨è¿›ç¨‹è¿è¡Œæ—¶æ›´æ–°é…ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœé…ç½®ä¿¡æ¯å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡å¯åº”ç”¨æ¥é‡æ–°è¯»å–ï¼Œè¾¾åˆ°æ›´æ–°çš„æ•ˆæœã€‚ è€Œå°† ConfigMap æš´éœ²ä¸ºå·å¯ä»¥è¾¾åˆ°é…ç½®çƒ­æ›´æ–°çš„æ•ˆæœï¼Œä¹Ÿå°±æ˜¯æ— é¡»é‡æ–°åˆ›å»º pod æˆ–è€…é‡å¯å®¹å™¨ã€‚\nä½¿ç”¨ kubectl edit ä¿®æ”¹ ConfigMapï¼š\n$ kubectl edit cm fortune-config # Please edit the object below. Lines beginning with a '#' will be ignored, # and an empty file will abort the edit. If an error occurs while saving this f # reopened with the relevant failures. # apiVersion: v1 data: my-nginx-config.conf: | server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } sleep-interval: | 25 kind: ConfigMap metadata: creationTimestamp: \u0026quot;2022-09-25T11:05:49Z\u0026quot; name: fortune-config namespace: default resourceVersion: \u0026quot;12886\u0026quot; uid: c9f5ee8a-9078-46cc-955a-3ec72c6ceb62 ~ ~ ~ - /tmp/kubectl-edit-4270724913.yaml 12/29 41% å’Œ vim ä¸€æ ·ï¼ŒæŒ‰ä¸‹ iï¼Œå°† gzip on ä¿®æ”¹ä¸º gzip offï¼Œç„¶å escï¼Œè¾“å…¥ :wqï¼Œé€€å‡ºå¹¶ä¿å­˜ï¼Œè¾“å‡º configmap/fortune-config edited\næŸ¥çœ‹ä¿®æ”¹æ˜¯å¦ç”Ÿæ•ˆï¼š\n$ kubectl exec -it fortune-configmap-volume-with-items -c web-server -- cat /etc/nginx/conf.d/gzip.conf server { listen 80; server_name www.kubia-example.com; gzip off; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } å‘ç°ä¿®æ”¹å·²ç»ç”Ÿæ•ˆ\né…ç½®æ–‡ä»¶å·²ç»ä¿®æ”¹ï¼Œç»§ç»­æµ‹è¯•ä¸€ä¸‹ nginx è¿™è¾¹æ˜¯å¦ç”Ÿæ•ˆï¼š\n$ kubectl port-forward fortune-configmap-volume 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 $ curl -H \u0026quot;Accept-Encoding: gzip\u0026quot; -I localhost:8080 HTTP/1.1 200 OK Server: nginx/1.23.1 Date: Sun, 25 Sep 2022 13:27:14 GMT Content-Type: text/html Last-Modified: Sun, 25 Sep 2022 13:26:55 GMT Connection: keep-alive ETag: W/\u0026quot;6330571f-c6\u0026quot; Content-Encoding: gzip å‘ç°ä¾ç„¶è¾“å‡ºäº† Content-Encoding: gzip ï¼Œè¿™æ˜¯å› ä¸ºè™½ç„¶ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯ nginx å¹¶ä¸ä¼šç›‘å¬é…ç½®æ–‡ä»¶å¹¶ä½œå‡ºå“åº”ï¼Œæ‰€ä»¥ä¸ä¼šæ›´æ–° gzip çš„çŠ¶æ€å°†å…¶ offï¼Œéœ€è¦æ‰‹åŠ¨é€šçŸ¥ nginx ï¼Œå‘Šè¯‰å®ƒé…ç½®æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦ä½ é‡æ–°è¯»å–ä¸€ä¸‹ï¼š\n$ kubectl exec -it fortune-configmap-volume-with-items -c web-server -- nginx -s reload 2022/09/25 13:30:40 [notice] 39#39: signal process started $ curl -H \u0026quot;Accept-Encoding: gzip\u0026quot; -I localhost:8080 HTTP/1.1 200 OK Server: nginx/1.23.1 Date: Sun, 25 Sep 2022 13:32:37 GMT Content-Type: text/html Content-Length: 27 Last-Modified: Sun, 25 Sep 2022 13:32:37 GMT Connection: keep-alive ETag: \u0026quot;63305875-1b\u0026quot; Accept-Ranges: bytes æ­¤æ—¶å‘ç° Content-Encoding: gzip å·²ç»æ²¡æœ‰äº†ï¼Œè¡¨ç¤º nginx è¿™è¾¹ä¹Ÿå·²ç»ç”Ÿæ•ˆäº†\næ•´ä¸ªè¿‡ç¨‹éƒ½æ²¡æœ‰é‡å¯æˆ–è€…é‡å»ºè¿‡ podï¼Œä½†æ˜¯æœ€ç»ˆä¹Ÿè¾¾åˆ°äº†æ›´æ–°é…ç½®çš„æ•ˆæœï¼Œæ‰€ä»¥å¯ä»¥åšåˆ°çƒ­æ›´æ–°ã€‚\nä½†æ˜¯å¯¹ k8s è€Œè¨€ï¼Œå®ƒåªæ˜¯ä¿è¯åœ¨æ›´æ–° ConfigMap ååŒæ­¥ä¿®æ”¹å…¶å¯¹åº”çš„ ConfigMap å·ï¼Œä½†æ˜¯å¯¹äºå¼•ç”¨è¿™ä¸ª ConfigMap çš„åº”ç”¨ï¼Œk8s å°±ç®¡ä¸åˆ°äº†ï¼Œå¦‚æœåº”ç”¨ä¸ä¼šå¯¹é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ä½œå‡ºå“åº”ï¼Œæˆ–è€…ç±»ä¼¼ nginx æä¾›ä¸€ä¸ªé‡æ–°è½½å…¥çš„å‘½ä»¤ï¼Œé‚£ä¹ˆå¯èƒ½æœ€ç»ˆè¿˜æ˜¯éœ€è¦é‡å¯æˆ–è€…é‡å»º podï¼ˆä¸ªäººçŒœæµ‹ï¼‰\n","date":"2022å¹´06æœˆ07æ—¥","permalink":"/posts/k8s-configmap/","summary":"è¯´æ˜ï¼šæ–‡ç« çš„éƒ¨åˆ†åœ°æ–¹ä¼šç”¨ cm æ¥æŒ‡ä»£ ConfigMap","title":"k8s ConfigMap"},{"contents":"ä¸»æµçš„åƒåœ¾å›æ”¶ç®—æ³• å¼•ç”¨è®¡æ•°æ³• æ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›æ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯è®¡æ•°é¢‘ç¹æ›´æ–°ä¼šå¸¦æ¥æ›´å¤šå¼€é”€ï¼Œä¸”æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚\nä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œå›æ”¶é€Ÿåº¦å¿« ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç©ºé—´å­˜æ”¾è®¡æ•°ï¼Œæ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼› æ ‡è®°æ¸…é™¤æ³• æ ‡è®°å‡ºæ‰€æœ‰ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ã€‚\nä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆå¯å›æ”¶å¯¹è±¡ä¸å¤šçš„åœºæ™¯ ç¼ºç‚¹ï¼šä¼šé€ æˆä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼ˆå†…å­˜ç¢ç‰‡ï¼‰ï¼Œå¯¼è‡´æœ‰å¤§çš„å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œæ˜æ˜å†…å­˜ä¸­æ€»å†…å­˜æ˜¯å¤Ÿçš„ï¼Œä½†æ˜¯ç©ºé—´ä¸æ˜¯è¿ç»­çš„é€ æˆå¯¹è±¡æ— æ³•åˆ†é…ï¼Œæ­¤å¤–è¿˜éœ€è¦ STW æ¥ç¡®ä¿æ ‡è®°æ¸…é™¤è¿‡ç¨‹ä¸è¢«å¤–éƒ¨å½±å“ï¼ˆæ¯”å¦‚ gc å‰è„šåˆšæŠŠä¸€ä¸ªå¯¹è±¡æ ‡è®°ä¸ºå¯è¾¾ï¼Œç”¨æˆ·ç¨‹åºåè„šå°±é‡Šæ”¾äº†å®ƒï¼‰ï¼› ï¼ˆå†…å­˜ç¢ç‰‡) STWï¼ˆStop The Worldï¼ŒStart The Worldï¼‰\né€šå¸¸æ„ä¹‰ä¸ŠæŒ‡çš„æ˜¯ä»Stop The Worldåˆ°Start The Worldè¿™ä¸€æ®µæ—¶é—´é—´éš”ã€‚åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ä¸ºäº†ä¿è¯å‡†ç¡®æ€§ã€é˜²æ­¢æ— æ­¢å¢ƒçš„å†…å­˜å¢é•¿ç­‰é—®é¢˜è€Œä¸å¯é¿å…çš„éœ€è¦åœæ­¢èµ‹å€¼å™¨è¿›ä¸€æ­¥æ“ä½œå¯¹è±¡å›¾ä»¥å®Œæˆåƒåœ¾å›æ”¶ã€‚STWæ—¶é—´è¶Šé•¿ï¼Œå¯¹ç”¨æˆ·ä»£ç é€ æˆçš„å½±å“è¶Šå¤§ã€‚\næ ‡è®°æ•´ç†æ³• è¿™ç§ç®—æ³•ç”¨äºè§£å†³ æ ‡è®°æ¸…é™¤æ³• çš„å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå®ƒçš„æ ‡è®°é˜¶æ®µä¸æ ‡è®°æ¸…é™¤æ³•ç›¸åŒï¼Œä½†æ˜¯ä¼šåœ¨å®Œæˆæ ‡è®°å·¥ä½œåï¼Œç§»åŠ¨éåƒåœ¾æ•°æ®ï¼Œä½¿å®ƒä»¬å°½å¯èƒ½ç´§å‡‘çš„æ”¾åœ¨å†…å­˜ä¸­ã€‚ ä¼˜ç‚¹ï¼šè§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ ç¼ºç‚¹ï¼šæ€§èƒ½ä½ï¼Œå› ä¸ºåœ¨ç§»åŠ¨å¯¹è±¡çš„æ—¶å€™ä¸ä»…éœ€è¦ç§»åŠ¨å¯¹è±¡è¿˜è¦ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œå¯èƒ½éœ€è¦å¯¹å†…å­˜ç»è¿‡å‡ æ¬¡æ‰«ææ‰èƒ½å®Œæˆ å¤åˆ¶å›æ”¶æ³• å’Œ æ ‡è®°æ•´ç†æ³• ä¸€æ ·ï¼Œè¿™ç§ç®—æ³•ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œä¹Ÿä¼šç§»åŠ¨æ•°æ®ï¼Œå®ƒæŠŠå †å†…å­˜åˆ’åˆ†ä¸ºä¸¤ä¸ªç›¸ç­‰çš„ç©ºé—´ From å’Œ Toï¼Œç¨‹åºæ‰§è¡Œæ—¶ä½¿ç”¨ From ç©ºé—´ï¼Œåƒåœ¾å›æ”¶æ‰§è¡Œæ—¶ï¼Œä¼šæ‰«æ From ç©ºé—´ï¼ŒæŠŠèƒ½è¿½è¸ªåˆ°çš„æ•°æ®å¤åˆ¶åˆ° To ç©ºé—´ï¼Œå½“æ‰€æœ‰æœ‰ç”¨çš„æ•°æ®éƒ½å¤åˆ¶åˆ° To ç©ºé—´åï¼ŒæŠŠ From å’Œ To ç©ºé—´çš„è§’è‰²äº¤æ¢ä¸€ä¸‹ï¼ŒåŸæ¥çš„ From ç©ºé—´å¯ä»¥å…¨éƒ¨å›æ”¶ä½œä¸ºæ–°çš„ To ç©ºé—´ï¼›åŸæ¥çš„ To ç©ºé—´å› ä¸ºä¿å­˜çš„éƒ½æ˜¯æœ‰ç”¨çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºæ–°çš„ From ç©ºé—´ã€‚ ä¼˜ç‚¹ï¼šè§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œæ¯æ¬¡æ¸…é™¤é’ˆå¯¹çš„éƒ½æ˜¯æ•´å—å†…å­˜ï¼Œä½†æ˜¯å› ä¸ºç§»åŠ¨å¯¹è±¡éœ€è¦è€—è´¹æ—¶é—´ï¼Œæ•ˆç‡ä½äºæ ‡è®°æ¸…é™¤æ³•ï¼› ç¼ºç‚¹ï¼šåªæœ‰ä¸€åŠçš„å †å†…å­˜å¯ä»¥ä½¿ç”¨ï¼Œå¯¼è‡´å †å†…å­˜ä½¿ç”¨æ•ˆç‡ä½ã€‚ä¸ºäº†æé«˜å†…å­˜çš„ä½¿ç”¨ç‡ï¼Œé€šå¸¸ä¼šå’Œå…¶ä»–åƒåœ¾å›æ”¶ç®—æ³•æ­é…ä½¿ç”¨ï¼Œåªåœ¨ä¸€éƒ¨åˆ†å †å†…å­˜ä¸­ä½¿ç”¨å¤åˆ¶å›æ”¶ï¼Œ åˆ†ä»£å¼ å°†å¯¹è±¡æ ¹æ®å­˜æ´»æ—¶é—´çš„é•¿çŸ­è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ´»æ—¶é—´å°äºæŸä¸ªå€¼çš„ä¸ºå¹´è½»ä»£ï¼Œå­˜æ´»æ—¶é—´å¤§äºæŸä¸ªå€¼çš„ä¸ºè€å¹´ä»£ï¼Œæ°¸è¿œä¸ä¼šå‚ä¸å›æ”¶çš„å¯¹è±¡ä¸ºæ°¸ä¹…ä»£ã€‚å¹¶æ ¹æ®åˆ†ä»£å‡è®¾ï¼ˆå¦‚æœä¸€ä¸ªå¯¹è±¡å­˜æ´»æ—¶é—´ä¸é•¿åˆ™å€¾å‘äºè¢«å›æ”¶ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»å­˜æ´»å¾ˆé•¿æ—¶é—´åˆ™å€¾å‘äºå­˜æ´»æ›´é•¿æ—¶é—´ï¼‰å¯¹å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚\nä¸‰è‰²æ ‡è®°æ³• åˆ°è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„é‡å¤´æˆï¼Œå› ä¸º Go é‡‡ç”¨çš„æ­£æ˜¯è¿™ç§ GC ç®—æ³•ã€‚\nä¸‰è‰²æ ‡è®°æ³•å°†å¯¹è±¡çš„é¢œè‰²åˆ†ä¸ºäº†é»‘ã€ç°ã€ç™½ï¼Œä¸‰ç§é¢œè‰²ã€‚\né»‘è‰²ï¼šè¯¥å¯¹è±¡å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä¸”è¯¥å¯¹è±¡ä¸‹çš„å±æ€§ä¹Ÿå…¨éƒ¨éƒ½è¢«æ ‡è®°è¿‡äº†ï¼ˆç¨‹åºæ‰€éœ€è¦çš„å¯¹è±¡ï¼‰ï¼› ç°è‰²ï¼šè¯¥å¯¹è±¡å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä½†è¯¥å¯¹è±¡ä¸‹çš„å±æ€§æ²¡æœ‰å…¨è¢«æ ‡è®°å®Œï¼ˆGCéœ€è¦ä»æ­¤å¯¹è±¡ä¸­å»å¯»æ‰¾åƒåœ¾ï¼‰ï¼› ç™½è‰²ï¼šè¯¥å¯¹è±¡æ²¡æœ‰è¢«æ ‡è®°è¿‡ï¼ˆåƒåœ¾å¯¹è±¡ï¼‰ï¼› åœ¨åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œæ—¶ï¼Œä» GC Roots å¼€å§‹è¿›è¡Œéå†è®¿é—®ï¼Œè®¿é—®æ­¥éª¤å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ æ­¥ï¼š\nGC Roots æ ¹å¯¹è±¡ä¼šè¢«æ ‡è®°æˆç°è‰²ï¼› ç„¶åä»ç°è‰²é›†åˆä¸­è·å–å¯¹è±¡ï¼Œå°†å…¶æ ‡è®°ä¸ºé»‘è‰²ï¼Œå°†è¯¥å¯¹è±¡å¼•ç”¨åˆ°çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼› é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°æ²¡æœ‰ç°è‰²é›†åˆå¯ä»¥æ ‡è®°ä¸ºæ­¢ï¼› ç»“æŸåï¼Œå‰©ä¸‹çš„æ²¡æœ‰è¢«æ ‡è®°çš„ç™½è‰²å¯¹è±¡å³ä¸º GC Roots ä¸å¯è¾¾ï¼Œå¯ä»¥è¿›è¡Œå›æ”¶ã€‚ â“gc root èŠ‚ç‚¹å…·ä½“æŒ‡å“ªäº›ï¼Ÿ è¯´æ³•1ï¼Œæ¥æºï¼š https://www.bilibili.com/video/BV1n5411H7qS?spm_id_from=333.999.0.0ï¼Œ2:30 ç§’\nå¯ä»¥æŠŠæ ˆã€æ•°æ®æ®µï¼ˆ.dataï¼Œå…¨å±€å˜é‡ï¼‰ä¸Šçš„æ•°æ®å¯¹è±¡ä½œä¸º root\nè¯´æ³• 2ï¼Œæ¥æºï¼šhttps://www.luozhiyun.com/archives/475\nGC æ‰§è¡Œæ ¹èŠ‚ç‚¹çš„æ ‡è®°ï¼Œè¿™åŒ…æ‹¬æ‰«ææ‰€æœ‰çš„æ ˆã€å…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚\nè¯´æ³• 3ï¼Œæ¥æºï¼šhttps://www.bookstack.cn/read/qcrao-Go-Questions/spilt.2.GC-GC.md\næ ¹å¯¹è±¡åœ¨åƒåœ¾å›æ”¶çš„æœ¯è¯­ä¸­åˆå«åšæ ¹é›†åˆï¼Œå®ƒæ˜¯åƒåœ¾å›æ”¶å™¨åœ¨æ ‡è®°è¿‡ç¨‹æ—¶æœ€å…ˆæ£€æŸ¥çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ï¼š\nå…¨å±€å˜é‡ï¼šç¨‹åºåœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šçš„é‚£äº›å­˜åœ¨äºç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚ æ‰§è¡Œæ ˆï¼šæ¯ä¸ª goroutine éƒ½åŒ…å«è‡ªå·±çš„æ‰§è¡Œæ ˆï¼Œè¿™äº›æ‰§è¡Œæ ˆä¸ŠåŒ…å«æ ˆä¸Šçš„å˜é‡åŠæŒ‡å‘åˆ†é…çš„å †å†…å­˜åŒºå—çš„æŒ‡é’ˆã€‚ å¯„å­˜å™¨ï¼šå¯„å­˜å™¨çš„å€¼å¯èƒ½è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆï¼Œå‚ä¸è®¡ç®—çš„è¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘æŸäº›èµ‹å€¼å™¨åˆ†é…çš„å †å†…å­˜åŒºå—ã€‚ å‰é¢æåˆ°è¿‡ï¼Œè¿™ç±»æ ‡è®°æ¸…ç†ç®—æ³•éƒ½éœ€è¦ STW æ¥ä¿è¯åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸å—å½±å“ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰ STW ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\né—®é¢˜1ï¼šå¤šæ ‡\né€šä¿—çš„è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªæœ¬è¯¥è¢«å›æ”¶çš„å¯¹è±¡ï¼ˆç™½è‰²ï¼‰ï¼Œå´è¢«é”™è¯¯çš„æ ‡è®°æˆäº†éç™½è‰²ï¼Œå¯¼è‡´æœ¬è½® gc æ²¡æœ‰æ­£ç¡®å›æ”¶ï¼Œå¯¼è‡´äº§ç”Ÿæµ®åŠ¨åƒåœ¾ã€‚\næ¯”å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼š åœ¨æ­¥éª¤2ä¸­ï¼Œgc å°† D æ ‡è®°ä¸ºäº†é»‘è‰²ï¼Œå°† D çš„å¯è¾¾å¯¹è±¡ E æ ‡è®°ä¸ºäº†ç°è‰²ï¼Œä½†åœ¨æ‰§è¡Œæ­¥éª¤3å‰ï¼Œç”¨æˆ·ç¨‹åºæ–­å¼€äº† D åˆ° E çš„å¼•ç”¨ï¼ˆæ¯”å¦‚ä» D = E å˜æˆ D = nullï¼‰ï¼Œæ­¤æ—¶ E åŠå…¶å¼•ç”¨çš„ Fï¼ŒG éƒ½ä¼šå˜ä¸ºåƒåœ¾ï¼Œå› ä¸ºå®ƒä»¬éƒ½ä¸å†å¯è¾¾äº†ï¼Œä½†æ˜¯å› ä¸º D å·²ç»æ ‡è®°æˆé»‘è‰²ï¼Œä¸ä¼šå†æ¬¡å¯¹å…¶è¿›è¡Œæ‰«æäº†ï¼Œè¿™ä¼šå¯¼è‡´ gc ç»§ç»­æ ‡è®°ï¼Œå°† E ä»ç°è‰²å˜ä¸ºé»‘è‰²ï¼ŒE çš„å¼•ç”¨å¯¹è±¡ F å’Œ G æ ‡è®°ä¸ºç°è‰²ï¼Œæœ€åå°† F å’Œ G æ ‡è®°ä¸ºé»‘è‰²ã€‚è‡³æ­¤ï¼Œè¯¥è½® gc ç»“æŸï¼ŒEï¼ŒFï¼ŒG éƒ½è¢«é”™è¯¯çš„æ ‡è®°ä¸ºäº†é»‘è‰²è€Œæ²¡æœ‰è¢«åŠæ—¶å›æ”¶ã€‚\nâ“å†™å±éšœå¯ä»¥è§£å†³ä¸Šé¢è¿™ç§æƒ…å†µå—ï¼Ÿ\né—®é¢˜2ï¼šæ¼æ ‡\né€šä¿—çš„è¯´ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªæœ‰ç”¨çš„å¯¹è±¡ç»™é”™è¯¯çš„å›æ”¶æ‰äº†ï¼Œä¹Ÿå°±æ˜¯æ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ã€‚\næ¯”å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼š åœ¨æ­¥éª¤2ä¸­ï¼ŒE å·²ç»å˜ä¸ºç°è‰²ï¼Œä½†åœ¨ gc è¿›ä¸€æ­¥æ ‡è®°ä¹‹å‰ï¼Œç”¨æˆ·ç¨‹åºæ–­å¼€äº† E åˆ° G çš„å¼•ç”¨ï¼ŒåŒæ—¶å·²ç»æ ‡è®°ä¸ºé»‘è‰²çš„ D æ–°å¢äº†å¯¹ G çš„å¼•ç”¨ï¼Œä¹‹å gc æ ‡è®°æ—¶å‘ç° E åˆ° G å·²ç»ä¸å¯è¾¾ï¼Œä¾¿ä¸ä¼šå°† G æ ‡è®°ä¸ºç°è‰²ï¼Œè€Œå› ä¸º D å·²ç»æ˜¯é»‘è‰²ä¸ä¼šå†æ¬¡æ‰«æï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå¯¹ G è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆï¼ŒG ä¾ç„¶ä¿æŒç€ç™½è‰²ï¼Œå¯¼è‡´æœ€åè¢« gc æ¸…ç†ã€‚\nç°åœ¨é—®é¢˜æ¥äº†ï¼Œç”¨ STW ä¼šå¯¼è‡´ gc è¿‡ç¨‹ä¸­æ•´ä¸ªç¨‹åºä¸å¯ç”¨ï¼Œä¸ç”¨ STW åˆä¼šå‡ºç°å†…å­˜é”™è¯¯ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥å°½å¯èƒ½çš„è®©ç”¨æˆ·ç¨‹åºå’Œ gc äº¤æ›¿ï¼ˆå¹¶å‘ï¼‰æ‰§è¡Œï¼Œå‡å°‘ STW é€ æˆçš„å½±å“ï¼ŒåŒæ—¶åˆä¸ä¼šå‡ºç°å†…å­˜é”™è¯¯å‘¢ï¼Ÿæ¯”å¦‚ å¢é‡å¼å›æ”¶ï¼Œå°±æ˜¯å°† gc è¿‡ç¨‹åˆ†å¤šæ¬¡å®Œæˆï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç¨‹åºä¸åƒåœ¾å›æ”¶äº¤æ›¿æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾ï¼š åªè¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå°±å¯ä»¥é¿å…ä¹‹å‰çš„å†…å­˜é—®é¢˜äº†ï¼š\nå¼ºä¸‰è‰²ä¸å˜å¼ é»‘è‰²å¯¹è±¡ä¸ä¼šå¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œç§°ä¸º å¼ºä¸‰è‰²ä¸å˜å¼ï¼Œæ¯”å¦‚åœ¨ é—®é¢˜2ï¼šæ¼æ ‡ ä¸­ï¼Œå¦‚æœé¿å…é»‘è‰²å¯¹è±¡ D åˆ°ç™½è‰²å¯¹è±¡ G çš„å¼•ç”¨ï¼Œå°±ä¸ä¼šå‡ºç°é”™è¯¯å›æ”¶çš„é—®é¢˜äº†ã€‚\nå¼±ä¸‰è‰²ä¸å˜å¼ é»‘è‰²å¯¹è±¡å¯ä»¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œå‰ææ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªç°è‰²å¯¹è±¡æŠµè¾¾è¯¥ç™½è‰²å¯¹è±¡ï¼Œæ¯”å¦‚ Aï¼ˆé»‘ï¼‰å¼•ç”¨äº† Bï¼ˆç™½è‰²ï¼‰ï¼Œè€Œ Cï¼ˆç°è‰²ï¼‰ å¼•ç”¨äº† Dï¼ˆç™½è‰²ï¼‰ï¼ŒD ï¼ˆç™½è‰²ï¼‰åˆå¼•ç”¨äº† Bï¼ˆç™½è‰²ï¼‰ï¼Œè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡ C -\u0026gt; D -\u0026gt; B æŠµè¾¾ Bï¼Œè¿™æ · B è™½ç„¶è¢«ä¸€ä¸ªé»‘è‰²å¯¹è±¡å¼•ç”¨ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯å¯è¾¾ï¼Œä¸ä¼šè¢«é—æ¼ï¼Œè¿™ç§æƒ…å†µç§°ä¸º å¼±ä¸‰è‰²ä¸å˜æ€§ ã€‚\nå®ç°å¼ºå¼±ä¸‰è‰²ä¸å˜å¼çš„é€šå¸¸åšæ³•æ˜¯å»ºç«‹ è¯»/å†™å±éšœã€‚\nå†™å±éšœ å†™å±éšœ ä¼šåœ¨å†™æ“ä½œä¸­æ’å…¥æŒ‡ä»¤ï¼Œç›®çš„æ˜¯æŠŠå¯¹è±¡çš„ä¿®æ”¹é€šçŸ¥åˆ°åƒåœ¾å›æ”¶å™¨ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªé»‘è‰²å¯¹è±¡å°è¯•å¼•ç”¨ä¸€ä¸ªç™½è‰²å¯¹è±¡æ—¶ï¼Œå°±ä¼šè§¦å‘å†™å±éšœï¼Œæ­¤æ—¶ä¸ºäº†ä¿è¯ å¼ºä¸‰è‰²ä¸å˜å¼ï¼Œå°±ä¼šå°†è¢«å¼•ç”¨çš„ç™½è‰²å¯¹è±¡å˜ä¸ºç°è‰²ï¼Œæˆ–è€…å°†å¼•ç”¨ç™½è‰²å¯¹è±¡çš„é»‘è‰²å¯¹è±¡å˜ä¸ºç°è‰²ï¼Œè¿™ç§å†™å±éšœå±äº æ’å…¥å†™å±éšœ ï¼›åˆæˆ–è€…æ˜¯ä¸€ä¸ªç°è‰²å¯¹è±¡å°è¯•å»é™¤å¯¹ä¸€ä¸ªç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸ºäº†ä¿è¯ å¼±ä¸‰è‰²ä¸å˜å¼ï¼Œä¼šå°†è¿™ä¸ªç™½è‰²å¯¹è±¡å˜ä¸ºç°è‰²ï¼Œè¿™ç§å†™å±éšœå±äº åˆ é™¤å†™å±éšœã€‚\næ’å…¥å†™å±éšœçš„ç¼ºç‚¹ **æ’å…¥å†™å±éšœ **è™½ç„¶å®ç°éå¸¸ç®€å•å¹¶ä¸”ä¹Ÿèƒ½ä¿è¯å¼ºä¸‰è‰²ä¸å˜æ€§ï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰æ˜æ˜¾çš„ç¼ºç‚¹ã€‚å› ä¸ºæ ˆä¸Šçš„å¯¹è±¡åœ¨åƒåœ¾æ”¶é›†ä¸­ä¹Ÿä¼šè¢«è®¤ä¸ºæ˜¯æ ¹å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯å†…å­˜çš„å®‰å…¨ï¼Œå¿…é¡»ï¼š\nä¸ºæ ˆä¸Šçš„å¯¹è±¡å¢åŠ å†™å±éšœ æˆ–è€…\nåœ¨æ ‡è®°é˜¶æ®µå®Œæˆé‡æ–°å¯¹æ ˆä¸Šçš„å¯¹è±¡è¿›è¡Œæ‰«æ è¿™ä¸¤ç§æ–¹æ³•å„æœ‰å„çš„ç¼ºç‚¹ï¼Œå‰è€…ä¼šå¤§å¹…åº¦å¢åŠ å†™å…¥æŒ‡é’ˆçš„é¢å¤–å¼€é”€ï¼Œåè€…é‡æ–°æ‰«ææ ˆå¯¹è±¡æ—¶éœ€è¦æš‚åœç¨‹åºï¼Œåƒåœ¾æ”¶é›†ç®—æ³•çš„è®¾è®¡è€…éœ€è¦åœ¨è¿™ä¸¤è€…ä¹‹é—´åšå‡ºæƒè¡¡ã€‚\nåˆ é™¤å†™å±éšœçš„ç¼ºç‚¹ è€Œ åˆ é™¤å†™å±éšœ ä¼šå­˜åœ¨ å›æ”¶æ•ˆç‡ä½ çš„é—®é¢˜ï¼Œå› ä¸ºå½“åˆ é™¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œä¼šç›´æ¥å°†ç™½è‰²å¯¹è±¡èµ‹ä¸ºç°è‰²ï¼Œä½†æ˜¯è¿™ä¸ªç™½è‰²å¯¹è±¡å¯èƒ½æœ¬èº«æ˜¯åƒåœ¾ï¼Œå¯ä»¥åœ¨æœ¬è½®è¢«æ¸…é™¤äº†ï¼Œä½†æ˜¯å´é€ƒè¿‡äº†æœ¬è½®çš„æ¸…ç†ã€‚æ¯”å¦‚ï¼š\né»‘ \u0026mdash;\u0026ndash;\u0026gt; ç° \u0026mdash;\u0026ndash;\u0026gt; ç™½\nå¦‚æœåœ¨æ‰«æåˆ°ç™½ä¹‹å‰ï¼Œæ–­å¼€ç°åˆ°ç™½çš„è¿æ¥ï¼Œæ­¤æ—¶å› ä¸ºç™½æ˜¯æ•´ä¸ªè°ƒç”¨é“¾çš„æœ€åä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å°†ä¼šæˆä¸ºåƒåœ¾ï¼Œä½†æ˜¯å› ä¸ºåˆ é™¤å†™å±éšœçš„å­˜åœ¨ï¼Œä¼šå°†è¯¥ç™½è‰²å¯¹è±¡å˜ä¸ºç°è‰²ï¼Œå¯¼è‡´æœ¬è½® GC æœªè¢«æ¸…ç†ã€‚\nè¯»å±éšœ è¯»å±éšœ é€‚ç”¨äºç§»åŠ¨å¼åƒåœ¾å›æ”¶ï¼Œéç§»åŠ¨å¼åƒåœ¾å›æ”¶å¤©ç„¶çš„ä¸éœ€è¦è¯»å±éšœã€‚åƒå¤åˆ¶å¼å›æ”¶è¿™æ ·ä¼šç§»åŠ¨æ•°æ®æ¥é¿å…ç¢ç‰‡åŒ–ï¼Œé‚£ä¹ˆ gc å’Œç”¨æˆ·ç¨‹åºäº¤æ›¿æ‰§è¡Œæ—¶ï¼Œè¯»æ•°æ®ä¾¿ä¹Ÿä¸é‚£ä¹ˆå®‰å…¨äº†ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š å›æ”¶å™¨å·²ç»å°† A ä» From å¤åˆ¶åˆ° To ç©ºé—´äº†ï¼Œä¹‹åäº¤æ›¿æ‰§è¡Œçš„ç”¨æˆ·ç¨‹åºå´è¯»å–äº† From ç©ºé—´ä¸­çš„è€å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å¯¹è±¡ B ä¸­å¼•ç”¨äº†è¿™ä¸ªè€å¯¹è±¡ Aï¼Œè€Œåç»­å›æ”¶å™¨å¤åˆ¶ B åˆ° To ç©ºé—´åï¼ŒB çš„æ–°å‰¯æœ¬æŒæœ‰çš„ä¾ç„¶æ˜¯ A çš„è€å¯¹è±¡æŒ‡é’ˆï¼Œå½“ From ç©ºé—´æ•´ä½“è¢«å›æ”¶æ—¶ï¼Œå› ä¸º B æŒ‡å‘çš„ä¾ç„¶æ˜¯ From ç©ºé—´çš„ Aï¼Œæ‰€ä»¥è®¿é—®ä¾¿ä¼šå‡ºé”™ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦å»ºç«‹è¯»å±éšœï¼Œç¡®ä¿ç”¨æˆ·ç¨‹åºä¸ä¼šè®¿é—®åˆ°è€å¯¹è±¡ï¼Œä¾‹å¦‚åœ¨æ£€æµ‹åˆ°å¼•ç”¨å¯¹è±¡å·²ç»å­˜åœ¨æ–°å‰¯æœ¬æ—¶ï¼Œè½¬è€Œè¯»å– To ç©ºé—´çš„æ–°å‰¯æœ¬ã€‚\nGo GC Go çš„ GC ç»“åˆäº†æ’å…¥å†™å±éšœå’Œåˆ é™¤å†™å±éšœçš„ä¼˜ç‚¹ï¼Œç§°ä¹‹ä¸º æ··åˆå†™å±éšœï¼Œå®ƒçš„è§„åˆ™å¦‚ä¸‹ï¼š\nGC å¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰²ï¼› GC æœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ï¼› è¢«åˆ é™¤çš„å †å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼› è¢«æ·»åŠ çš„å †å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼› Go å›¢é˜Ÿåœ¨æœ€ç»ˆå®ç°æ—¶ï¼Œæ²¡æœ‰ä¸ºæ‰€æœ‰æ ˆä¸Šçš„æŒ‡é’ˆå†™æ“ä½œå¯ç”¨å†™å±éšœï¼Œè€Œæ˜¯å½“å‘ç”Ÿæ ˆä¸Šçš„å†™æ“ä½œæ—¶ï¼Œå°†æ ˆæ ‡è®°ä¸ºç°è‰²ï¼Œä½†æ­¤ä¸¾äº§ç”Ÿäº† ç°è‰²èµ‹å€¼å™¨ï¼Œå°†ä¼šéœ€è¦æ ‡è®°ç»ˆæ­¢é˜¶æ®µ STW æ—¶å¯¹è¿™äº›æ ˆè¿›è¡Œ é‡æ–°æ‰«æï¼ˆv1.7 ç‰ˆæœ¬ä¹‹å‰ï¼‰ã€‚\nä¸€äº›ä¾‹å­ï¼š\nçœ‹åˆ°è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œè¿™é‡Œå°±ç®—ä¸æŠŠå¯¹è±¡ 7 å˜æˆç°è‰²ï¼Œè²Œä¼¼ä¹Ÿä¸ä¼šå½±å“ä»€ä¹ˆï¼Œå› ä¸ºå®ƒçš„ä¸Šæ¸¸å¯¹è±¡å¯¹è±¡ 4 ä¾ç„¶æ˜¯ç°è‰²è€Œä¸æ˜¯é»‘è‰²ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ‰«æåˆ°å¯¹è±¡ 7ï¼Œç„¶åå†ç»§ç»­æ‰«æåˆ°å¯¹è±¡ 6ï¼Œä¸ºä»€ä¹ˆä¼šè¯´å¯¹è±¡ 6 è¢«ä¿æŠ¤å‘¢ï¼Ÿ\nç„¶åæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼šåœ¨å¯¹è±¡ 4 å‡†å¤‡æ‰«æå¯¹è±¡ 7ä¹‹å‰ï¼Œç”¨æˆ·ç¨‹åºæ–­å¼€äº†å¯¹è±¡ 4 åˆ°å¯¹è±¡ 7 çš„å¼•ç”¨ï¼Œå¯¼è‡´æ­¤æ—¶çš„å¯¹è±¡ 7 ä¾ç„¶æ˜¯ç™½è‰²ï¼Œå¦‚æœè¿™æ—¶é»‘è‰²å¯¹è±¡ 10 å†å¼•ç”¨ç™½è‰²å¯¹è±¡ 7ï¼Œä¸ºäº†ä¿è¯å¼ºä¸‰è‰²ä¸å˜æ€§ï¼Œå°±éœ€è¦å°†å¯¹è±¡ 7 å˜ä¸ºç°è‰²ã€‚\nå‚è€ƒï¼ˆæŠ„è¢­ï¼‰ Goè¯­è¨€GCå®ç°åŸç†åŠæºç åˆ†æ https://www.luozhiyun.com/archives/475\nGolangåƒåœ¾å›æ”¶(GC)ä»‹ç» https://liangyaopei.github.io/2021/01/02/golang-gc-intro/\nhttps://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/\nhttps://www.bilibili.com/video/BV1n5411H7qS?spm_id_from=333.999.0.0\n","date":"2022å¹´06æœˆ01æ—¥","permalink":"/posts/go-gc/","summary":"ä¸»æµçš„åƒåœ¾å›æ”¶ç®—æ³• å¼•ç”¨è®¡æ•°æ³• æ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›æ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯è®¡æ•°é¢‘ç¹æ›´æ–°ä¼šå¸¦æ¥æ›´å¤šå¼€é”€ï¼Œä¸”æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚\nä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œå›æ”¶é€Ÿåº¦å¿« ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç©ºé—´å­˜æ”¾è®¡æ•°ï¼Œæ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼› æ ‡è®°æ¸…é™¤æ³• æ ‡è®°å‡ºæ‰€æœ‰ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ã€‚","title":"go gc ç™½è¯ç‰ˆ"},{"contents":"ç®€ä»‹ Namespace æ˜¯å¯¹ä¸€ç»„èµ„æºå’Œå¯¹è±¡çš„æŠ½è±¡é›†åˆï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥å°†ç³»ç»Ÿå†…éƒ¨çš„å¯¹è±¡åˆ’åˆ†ä¸ºä¸åŒçš„é¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚å¸¸è§çš„ pods, services, replication controllers å’Œ deployments ç­‰éƒ½æ˜¯å±äºæŸä¸€ä¸ª namespace çš„ï¼ˆé»˜è®¤æ˜¯defaultï¼‰ï¼Œè€Œ node, persistentVolumes ç­‰åˆ™ä¸å±äºä»»ä½• namespaceã€‚\nNamespace å¸¸ç”¨æ¥éš”ç¦»ä¸åŒçš„ç”¨æˆ·ï¼Œæ¯”å¦‚ Kubernetes è‡ªå¸¦çš„æœåŠ¡ä¸€èˆ¬è¿è¡Œåœ¨ kube-system namespace ä¸­ã€‚\nNamespace é€‚ç”¨äºå­˜åœ¨å¾ˆå¤šè·¨å¤šä¸ªå›¢é˜Ÿæˆ–é¡¹ç›®çš„ç”¨æˆ·çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨å‘½åç©ºé—´æ¥åˆ’åˆ†åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªç¯å¢ƒä¸­ç»´æŠ¤åˆ©ç”¨åŒæ ·çš„åç§°ç»´æŠ¤ç›¸åŒå¯¹è±¡çš„å‰¯æœ¬ã€‚\nåŒä¸€ namespace å†…çš„èµ„æºåç§°è¦å”¯ä¸€ï¼Œä½†è·¨ namespace æ—¶æ²¡æœ‰è¿™ä¸ªè¦æ±‚ï¼Œé€šä¿—çš„è¯´ï¼Œå°±æ˜¯ä¸¤ä¸ªèµ„æºå¦‚æœåç§°ç›¸åŒï¼Œä½†æ˜¯æ‰€åœ¨çš„å‘½åç©ºé—´ä¸åŒæ˜¯å¯ä»¥çš„ã€‚\nç–‘é—®ï¼š\nlabelï¼ˆæ ‡ç­¾ï¼‰ä¹Ÿå¯ä»¥å¯¹èµ„æºè¿›è¡Œåˆ†ç±»ï¼Œå®ƒå’Œ namespace æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\nç”±äºæ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå› æ­¤è¿™äº›å¯¹è±¡ç»„å¯ä»¥é‡å ã€‚å¦å¤–ï¼Œå½“åœ¨é›†ç¾¤ä¸­å·¥ä½œ(ä¾‹å¦‚é€šè¿‡ kubectl )æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬æ€»èƒ½çœ‹åˆ°æ‰€æœ‰å¯¹è±¡ã€‚è€Œ namespace å¯ä»¥å°†èµ„æºåˆ†å‰²ä¸ºå®Œå…¨ç‹¬ç«‹ä¸é‡å çš„ç»„ï¼Œæˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œnamespace æä¾›äº†æ¯” label æ›´ä¸¥æ ¼çš„èµ„æºåˆ†ç±»ï¼Œå…¶ä¸»è¦é’ˆå¯¹çš„æ˜¯ä¸åŒç”¨æˆ·é—´çš„åˆ’åˆ†ï¼Œè€Œ label åˆ™å€¾å‘äºè¯¸å¦‚å¯¹åŒä¸€è½¯ä»¶ä¸åŒç‰ˆæœ¬è¿™ç§æƒ…å†µè¿›è¡Œåˆ’åˆ†ã€‚\nä½¿ç”¨ æŸ¥çœ‹æ‰€æœ‰çš„ namespace $ kubectl get ns NAME STATUS AGE default Active 24d kube-system Active 24d kube-public Active 24d kube-node-lease Active 24d Kubernetes ä¼šåˆ›å»ºå››ä¸ªåˆå§‹ namespaceï¼š\ndefault å¦‚æœèµ„æºæ²¡æœ‰æ˜ç¡®æŒ‡å®šå…¶æ‰€å±çš„ namespaceï¼Œåˆ™ä¼šé»˜è®¤ä½¿ç”¨è¯¥ namespace kube-system Kubernetes ç³»ç»Ÿåˆ›å»ºå¯¹è±¡æ‰€ä½¿ç”¨çš„ namespace kube-public è¿™ä¸ª namespace æ˜¯è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬æœªç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼‰éƒ½å¯ä»¥è¯»å–å®ƒã€‚ è¿™ä¸ª namespace ä¸»è¦ç”¨äºé›†ç¾¤ä½¿ç”¨ï¼Œä»¥é˜²æŸäº›èµ„æºåœ¨æ•´ä¸ªé›†ç¾¤ä¸­åº”è¯¥æ˜¯å¯è§å’Œå¯è¯»çš„ã€‚ è¿™ä¸ª namespace çš„å…¬å…±æ–¹é¢åªæ˜¯ä¸€ç§çº¦å®šï¼Œè€Œä¸æ˜¯è¦æ±‚ã€‚ kube-node-lease æ­¤ namespace ç”¨äºä¸å„ä¸ªèŠ‚ç‚¹ç›¸å…³çš„ ç§Ÿçº¦ï¼ˆLeaseï¼‰å¯¹è±¡ã€‚ èŠ‚ç‚¹ç§ŸæœŸå…è®¸ kubelet å‘é€å¿ƒè·³ï¼Œç”±æ­¤æ§åˆ¶é¢èƒ½å¤Ÿæ£€æµ‹åˆ°èŠ‚ç‚¹æ•…éšœã€‚ æŒ‡å®š namespace å¯ä»¥å°† namespace ä½œä¸ºç­›é€‰/å±æ€§ï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢ pod æ“ä½œä½¿ç”¨ namespace ä½œä¸ºç­›é€‰æ¡ä»¶\n$ kubectl get po -n kube-system NAME READY STATUS RESTARTS AGE helm-install-traefik-crd-q62cm 0/1 Completed 0 24d helm-install-traefik-l2wcr 0/1 Completed 1 24d svclb-traefik-f4w7g 2/2 Running 12 (50m ago) 24d traefik-df4ff85d6-2rbl2 1/1 Running 15 (50m ago) 24d coredns-d76bd69b-7bkb4 1/1 Running 18 (50m ago) 24d local-path-provisioner-6c79684f77-qjq26 1/1 Running 7 (50m ago) 24d metrics-server-7cd5fcb6b7-b72lz 1/1 Running 25 (50m ago) 24d ä¹Ÿå¯ä»¥ä½¿ç”¨ \u0026ndash;namespace å‘½ä»¤ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™é»˜è®¤ä¸º default\nä¹Ÿå¯ä»¥åœ¨åˆ›å»ºèµ„æºçš„æ—¶å€™ä¸ºå…¶æŒ‡å®š namespaceï¼š\n$ kubectl create -f kubia-manual.yam1 -n custom-namespace pod â€kubia-manual\u0026quot; created åˆ›å»º namespace $ kubectl create ns ns-test namespace/ns-test created åˆ é™¤ namespace $ kubectl delete ns ns-test namespace \u0026quot;ns-test\u0026quot; deleted Warning: è¿™ä¼šåˆ é™¤åå­—ç©ºé—´ä¸‹çš„ æ‰€æœ‰å†…å®¹ ï¼\nnamespace ä¸ DNS å½“ä½ åˆ›å»ºæœåŠ¡æ—¶ï¼ŒKubernetes ä¼šåˆ›å»ºç›¸åº”çš„ DNS æ¡ç›®ã€‚ æ­¤æ¡ç›®çš„æ ¼å¼ä¸º \u0026lt;æœåŠ¡åç§°\u0026gt;.\u0026lt;åå­—ç©ºé—´åç§°\u0026gt;.svc.cluster.localã€‚ è¿™æ„å‘³ç€å¦‚æœå®¹å™¨ä½¿ç”¨ \u0026lt;æœåŠ¡åç§°\u0026gt;ï¼Œå®ƒå°†è§£æä¸ºåå­—ç©ºé—´æœ¬åœ°çš„æœåŠ¡ã€‚ è¿™å¯¹äºåœ¨å¤šä¸ªåå­—ç©ºé—´ï¼ˆå¦‚å¼€å‘ã€æš‚å­˜å’Œç”Ÿäº§ï¼‰ä¸­ä½¿ç”¨ç›¸åŒçš„é…ç½®éå¸¸æœ‰ç”¨ã€‚ å¦‚æœè¦è·¨åå­—ç©ºé—´è®¿é—®ï¼Œåˆ™éœ€è¦ä½¿ç”¨å®Œå…¨é™å®šçš„åŸŸåï¼ˆFQDNï¼‰ã€‚\n","date":"2022å¹´05æœˆ31æ—¥","permalink":"/posts/k8s-namespace/","summary":"ç®€ä»‹ Namespace æ˜¯å¯¹ä¸€ç»„èµ„æºå’Œå¯¹è±¡çš„æŠ½è±¡é›†åˆï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥å°†ç³»ç»Ÿå†…éƒ¨çš„å¯¹è±¡åˆ’åˆ†ä¸ºä¸åŒçš„é¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚å¸¸è§çš„ pods, services, replication controllers å’Œ deployments ç­‰éƒ½æ˜¯å±äºæŸä¸€ä¸ª namespace çš„ï¼ˆé»˜è®¤æ˜¯defaultï¼‰ï¼Œè€Œ node, persistentVolumes ç­‰åˆ™ä¸å±äºä»»ä½• namespaceã€‚","title":"k8s namespace"},{"contents":"ç®€ä»‹ errgroup æ˜¯ WaitGroup çš„å¼ºåŒ–ç‰ˆï¼Œå…¶åœ¨ WaitGroup çš„åŸºç¡€ä¸Šæ·»åŠ äº†é”™è¯¯å¤„ç†çš„åŠŸèƒ½ï¼šå¦‚æœä¸€ç»„ goroutine ä¸­çš„æŸä¸€ä¸ªå‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£ä¹ˆåç»­çš„æ‰€æœ‰ gorouine éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚\nç¤ºä¾‹ ç¤ºä¾‹ 1 ä¸€å…±å¼€å¯ 10 ä¸ª goroutine æ‰§è¡Œä»»åŠ¡ï¼Œå…¶ä¸­ç¬¬ä¸‰ä¸ª goroutine ä¼šå‡ºé”™ï¼Œä½¿ç”¨ errgroup å¯ä»¥ä¿è¯ç¬¬ä¸‰ä¸ªä¹‹åçš„æ‰€æœ‰ goroutine éƒ½ä¸ä¼šæ‰§è¡Œ\nfunc main() { group, ctx := errgroup.WithContext(context.Background()) count := 50 for i := 0; i \u0026lt; count; i++ { i := i // é—­åŒ…é‡æ–°æ•è·å˜é‡ i group.Go(func() error { select { case \u0026lt;-ctx.Done(): log.Printf(\u0026quot;[%d] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ\\n\u0026quot;, i) return nil default: } if i == 3 { log.Printf(\u0026quot;[%d] error\\n\u0026quot;, i) return fmt.Errorf(\u0026quot;[%d] error\u0026quot;, i) } log.Printf(\u0026quot;[%d] success\\n\u0026quot;, i) return nil }) time.Sleep(time.Millisecond * 10) } if err := group.Wait(); err != nil { log.Println(err) } } // Output: // 2022/05/29 00:02:51 [0] success // 2022/05/29 00:02:51 [1] success // 2022/05/29 00:02:51 [2] success // 2022/05/29 00:02:51 [3] error // 2022/05/29 00:02:51 [4] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ // 2022/05/29 00:02:51 [5] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ // 2022/05/29 00:02:51 [6] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ // 2022/05/29 00:02:51 [7] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ // 2022/05/29 00:02:51 [8] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ // 2022/05/29 00:02:51 [9] group é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡ä¸ä¼šæ‰§è¡Œ //2022/05/29 00:02:51 [3] error ç¤ºä¾‹ 2 æ¥æºï¼šhttps://lailin.xyz/post/go-training-week3-errgroup.html\nå› ä¸ºæˆ‘æ˜¯è·³è¿‡æ–‡ç« å‰é¢çš„å†…å®¹ç›´æ¥çœ‹ç¤ºä¾‹çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹æœ‰ç‚¹çœ‹ä¸æ‡‚æ³¨é‡Šå†™çš„æ„æ€ï¼Œåæ¥ç¿»äº†ä¸€ä¸‹æºç æ‰æ˜ç™½ï¼Œå¯¹æ³¨é‡Šé’ˆå¯¹è‡ªå·±çš„ç®€ä»‹è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚\nè¿™ä¸ªç¤ºä¾‹çš„å¤§è‡´æ„æ€æ˜¯ï¼šä½¿ç”¨ errgroup å¼€å¯äº† 3 ä¸ª goroutineï¼Œç¬¬ä¸€ä¸ªè¿è¡Œ HTTP æœåŠ¡ï¼Œç¬¬äºŒä¸ªç›‘å¬ shutdown æ¥å£ç”¨æ¥å…³é—­ HTTP æœåŠ¡ï¼Œç¬¬ä¸‰ä¸ªç›‘å¬ ctrl+c å’Œ kill è¿™ä¸¤ä¸ªä¿¡å·ã€‚è¿™ä¸‰ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªå‘ç”Ÿé”™è¯¯é€€å‡ºï¼Œéƒ½ä¼šè®©å¦å¤–ä¸¤ä¸ª goroutine ä¹Ÿé€€å‡ºï¼ˆå‡†ç¡®çš„è¯´ï¼Œè¿è¡Œ HTTP æœåŠ¡çš„ goroutine æ˜¯ä¸ä¼šä¸»åŠ¨é€€å‡ºçš„ï¼Œåªæœ‰ç¬¬äºŒä¸ªèƒ½å°†å…¶ç»“æŸï¼Œå¦å¤–ä¸¤ä¸ªéƒ½å¯ä»¥ä¸»åŠ¨ç»“æŸï¼Œç¬¬äºŒä¸ªæ‰§è¡Œ curl localhost:8080/shutdown å¯ä»¥è§¦å‘ï¼Œç¬¬ä¸‰ä¸ªä½¿ç”¨ ctrl+c æˆ–è€… kill éƒ½å¯ä»¥è§¦å‘ï¼‰\nfunc main() { // WithContext() é‡Œé¢ç”¨ context.Cancel åŒ…è£…äº†ä¼ å…¥çš„ contextï¼Œå¹¶è¿”å›åŒ…è£…å // çš„ ctxï¼Œè€Œå¦ä¸€ä¸ªè¿”å›å€¼ cancel åˆ™æ˜¯æ”¾åˆ°äº† errgroup.Group é‡Œé¢ // å¦‚æœ g.Go(func() error) é‡Œé¢çš„ func è¿”å›äº†é”™è¯¯ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ Group.cancel // å°†åŒ…è£…çš„ ctx å–æ¶ˆ g, ctx := errgroup.WithContext(context.Background()) mux := http.NewServeMux() mux.HandleFunc(\u0026quot;/ping\u0026quot;, func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\u0026quot;pong\u0026quot;)) }) // æ¨¡æ‹Ÿå•ä¸ªæœåŠ¡é”™è¯¯é€€å‡º serverOut := make(chan struct{}) mux.HandleFunc(\u0026quot;/shutdown\u0026quot;, func(w http.ResponseWriter, r *http.Request) { serverOut \u0026lt;- struct{}{} }) server := http.Server{ Handler: mux, Addr: \u0026quot;:8080\u0026quot;, } // g1 // g1 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ // g1 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼ˆè¿™è¯ç¬¬ä¸€çœ¼æ²¡çœ‹æ‡‚ï¼Œcontext è¿˜ä¼šè¢«é˜»å¡ï¼Ÿï¼‰ï¼Œg2, g3 éƒ½ä¼šéšä¹‹é€€å‡º // ä¿®æ”¹ç‰ˆæ³¨é‡Šï¼šg1 åªæœ‰åœ¨ g2 è°ƒç”¨ Shutdown() åæ‰ä¼šé€€å‡ºï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ª error // ä¹‹å ctx è¢« cancelï¼Œå…¶ä»– goroutine çš„ select éƒ½ä¼šèµ° case \u0026lt;-ctx.Done() åˆ†æ”¯ï¼Œ // ä»è€Œè¾¾åˆ°é€€å‡ºçš„ç›®çš„ï¼ˆå› ä¸º select æ²¡æœ‰åŠ  default åˆ†æ”¯ï¼Œæ‰€ä»¥ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ª case // æ»¡è¶³æ¡ä»¶ï¼Œæ‰€ä»¥ä¸Šé¢è¯´çš„ context å°†ä¸å†é˜»å¡ï¼Œå®é™…åº”è¯¥æ˜¯ select ä¸å†é˜»å¡ï¼‰ // ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º g.Go(func() error { // g2 çš„ Shutdown ä¼šè®©è¿™é‡Œåœæ­¢é˜»å¡å¹¶è¿”å›ä¸€ä¸ª err // ä¹‹å ctx ä¼šè¢« cancel æ‰ï¼Œg3 ä¹Ÿä¼šåœæ­¢ if err := server.ListenAndServe(); err != nil { log.Println(\u0026quot;g1 error: \u0026quot;, err) return err } return nil }) // g2 // g2 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ // g2 é€€å‡ºæ—¶ï¼Œè°ƒç”¨äº† shutdownï¼Œg1 ä¼šé€€å‡º // g2 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼Œg3 ä¼šéšä¹‹é€€å‡º // ä¿®æ”¹ï¼šg2 é€€å‡ºå, g1 cancel æ‰äº† ctxï¼Œg3 çš„ select å°†ä¸å†é˜»å¡ï¼Œg3 ä¼šéšä¹‹é€€å‡º // ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º g.Go(func() error { select { case \u0026lt;-ctx.Done(): log.Println(\u0026quot;errgroup exit...\u0026quot;) case \u0026lt;-serverOut: // curl localhost:8080/shutdown log.Println(\u0026quot;server will out...\u0026quot;) } cancelCtx, cancel := context.WithCancel(context.Background()) // è¿™é‡Œä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ _ çš„è¯é™æ€æ‰«æå·¥å…·ä¼šæŠ¥é”™ï¼ŒåŠ ä¸Šä¹Ÿæ— ä¼¤å¤§é›… defer cancel() log.Println(\u0026quot;shutting down server...\u0026quot;) // Shutdown() ä¼šåœæ­¢ g1ï¼ŒåŒæ—¶ g1 çš„ ListenAndServe() ä¼šè¿”å›ä¸€ä¸ª error if err := server.Shutdown(cancelCtx); err != nil { log.Println(\u0026quot;g2 error: \u0026quot;, err) return err } return nil }) // g3 // g3 æ•è·åˆ° os é€€å‡ºä¿¡å·å°†ä¼šé€€å‡º // g3 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ // g3 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼Œg2 ä¼šéšä¹‹é€€å‡º // ä¿®æ”¹ï¼šg3 æ”¶åˆ°ä¿¡å·è¿”å›ä¸€ä¸ª error å¹¶é€€å‡ºï¼Œctx ä¼šè¢« cancel æ‰ï¼Œç„¶å g2 çš„ select // åœæ­¢é˜»å¡ï¼Œæ‰§è¡Œä¸‹é¢çš„æµç¨‹ // g2 é€€å‡ºæ—¶ï¼Œè°ƒç”¨äº† shutdownï¼Œg1 ä¼šé€€å‡º // ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º g.Go(func() error { quit := make(chan os.Signal, 0) signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM) select { case \u0026lt;-ctx.Done(): log.Println(\u0026quot;g3: ctx is done\u0026quot;) return ctx.Err() case sig := \u0026lt;-quit: return errors.Errorf(\u0026quot;get os signal: %v\u0026quot;, sig) } }) fmt.Printf(\u0026quot;errgroup exiting: %+v\\n\u0026quot;, g.Wait()) } ç¤ºä¾‹ 3 errgroup è¿˜å¯ä»¥é™åˆ¶åŒæ—¶å¼€å¯çš„ goroutine æ•°é‡ï¼Œå…¶å®æœ¬è´¨ä¹Ÿæ˜¯ä½¿ç”¨ WaitGroup + channel æ¥å®ç°çš„ã€‚\nä¸‹é¢çš„ä»£ç ä¿è¯æœ€å¤šåªå¼€å¯ 2 ä¸ª goroutineï¼Œå…¶ä»–çš„éƒ½ä¼šé˜»å¡ç­‰å¾…ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒGroup å³ä¾¿æ˜¯é›¶å€¼ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼Œåªæ˜¯æ²¡æœ‰äº† cancel çš„èƒ½åŠ›ã€‚\nfunc main() { eg := errgroup.Group{} count := 20 mostRunning := 2 eg.SetLimit(mostRunning) for i := 0; i \u0026lt; count; i++ { i := i eg.Go(func() error { log.Println(i) time.Sleep(300 * time.Millisecond) return nil }) } eg.Wait() } æºç åˆ†æ Group // A Group is a collection of goroutines working on subtasks that are part of // the same overall task. // // A zero Group is valid and does not cancel on error. // // Group æ˜¯ä¸€ç»„ goroutinesï¼Œå®ƒä»¬å¤„ç†å±äºåŒä¸€æ•´ä½“ä»»åŠ¡çš„å­ä»»åŠ¡ã€‚é›¶å€¼æ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”ä¸ä¼šå› é”™è¯¯è€Œå–æ¶ˆã€‚ // å› ä¸ºé›¶å€¼çš„ cancel æ˜¯ nilï¼Œæ‰€ä»¥è‡ªç„¶ä¸ä¼šè¢«æ‰§è¡Œ type Group struct { cancel func()\t// å‘ç”Ÿé”™è¯¯æ—¶ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå°† WithContext åˆ›å»ºçš„ ctx å–æ¶ˆ wg sync.WaitGroup sem chan token\t// å¸¦ç¼“å­˜çš„ chanï¼Œç”¨æ¥é™åˆ¶å¯ä»¥åˆ›å»ºçš„ goroutine æ•°é‡ï¼Œtoken æ˜¯ struct{} çš„åˆ«å errOnce sync.Once\t// ç¡®ä¿åªæœ‰ç¬¬ä¸€æ¬¡å‘ç”Ÿé”™è¯¯æ—¶æ‰æ‰§è¡ŒæŸäº›æ“ä½œ err error\t// è®°å½•ç¬¬ä¸€æ¬¡å‘ç”Ÿçš„é”™è¯¯ } WithContext // WithContext returns a new Group and an associated Context derived from ctx. // // The derived Context is canceled the first time a function passed to Go // returns a non-nil error or the first time Wait returns, whichever occurs // first. // // WithContext è¿”å›ä¸€ä¸ª Group å’Œä¸€ä¸ªä» ctx æ´¾ç”Ÿçš„å…³è”ä¸Šä¸‹æ–‡ã€‚æ´¾ç”Ÿçš„ Context åœ¨ Go å‡½æ•°ç¬¬ä¸€æ¬¡è¿” // å›é”™è¯¯æˆ– Wait ç¬¬ä¸€æ¬¡è¿”å›æ—¶è¢«å–æ¶ˆï¼Œä»¥å…ˆå‘ç”Ÿè€…ä¸ºå‡†ã€‚ func WithContext(ctx context.Context) (*Group, context.Context) { // ç”¨ WithCancel åŒ…è£…äº†ä¼ å…¥çš„ ctx ctx, cancel := context.WithCancel(ctx) // å°† cancel ä¿å­˜åˆ° Cancel å±æ€§ return \u0026amp;Group{cancel: cancel}, ctx } Go // Go calls the given function in a new goroutine. // It blocks until the new goroutine can be added without the number of // active goroutines in the group exceeding the configured limit. // // The first call to return a non-nil error cancels the group; its error will be // returned by Wait. // // Go åœ¨ä¸€ä¸ªæ–°çš„ goroutine ä¸­è°ƒç”¨ç»™å®šçš„å‡½æ•°ã€‚å¦‚æœå½“å‰è¿è¡Œçš„ goroutine æ•°é‡è¾¾åˆ°äº† limit çš„ä¸Šé™ï¼Œåˆ™ä¼šé˜» // å¡ï¼Œç›´åˆ°å¯ä»¥æ·»åŠ ã€‚å¦‚æœè°ƒç”¨ f è¿”å›äº†é”™è¯¯ï¼Œåˆ™ä¼šå–æ¶ˆè¯¥ç»„ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ Group.cancelï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å‘ç”Ÿé”™è¯¯æ—¶ // ä¼šæ‰§è¡Œè¯¥æ“ä½œï¼‰ï¼ŒWait ä¼šè¿”å›å®ƒçš„é”™è¯¯ã€‚ func (g *Group) Go(f func() error) { if g.sem != nil { g.sem \u0026lt;- token{}\t// å¦‚æœå½“å‰å¼€å¯çš„ goroutine æ•°é‡å¤§äº limit åˆ™ä¼šè¢«é˜»å¡ } g.wg.Add(1) go func() { defer g.done() if err := f(); err != nil { // åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¿è¯åªæœ‰ç¬¬ä¸€æ¬¡å‘ç”Ÿé”™è¯¯æ—¶æ‰§è¡Œ g.errOnce.Do(func() { g.err = err\t// ä¿å­˜é”™è¯¯ï¼ŒWait() ä¼šè¿”å›è¿™ä¸ªé”™è¯¯ if g.cancel != nil { g.cancel()\t// cancel æ‰ WithContext() åˆ›å»ºçš„ ctx } }) } }() } SetLimit // SetLimit limits the number of active goroutines in this group to at most n. // A negative value indicates no limit. // // Any subsequent call to the Go method will block until it can add an active // goroutine without exceeding the configured limit. // // The limit must not be modified while any goroutines in the group are active. // // SetLimit å°†è¿™ä¸ªç»„ä¸­çš„æ´»åŠ¨ goroutine çš„æ•°é‡é™åˆ¶ä¸ºæœ€å¤š nã€‚è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ã€‚ // å¯¹ Go æ–¹æ³•çš„ä»»ä½•åç»­è°ƒç”¨éƒ½å°†é˜»å¡ï¼Œç›´åˆ°å®ƒå¯ä»¥æ·»åŠ ä¸€ä¸ªæ´»åŠ¨çš„ goroutine è€Œä¸ä¼š // è¶…è¿‡é…ç½®çš„é™åˆ¶ã€‚å½“ç»„ä¸­çš„ä»»ä½• goroutine å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œä¸å¾—ä¿®æ”¹é™åˆ¶ã€‚ func (g *Group) SetLimit(n int) { if n \u0026lt; 0 { g.sem = nil return } if len(g.sem) != 0 { panic(fmt.Errorf(\u0026quot;errgroup: modify limit while %v goroutines in the group are still active\u0026quot;, len(g.sem))) } g.sem = make(chan token, n)\t// ä½¿ç”¨å¸¦ç¼“å­˜çš„ chan } TryGo // TryGo calls the given function in a new goroutine only if the number of // active goroutines in the group is currently below the configured limit. // // The return value reports whether the goroutine was started. // // ä»…å½“ç»„ä¸­å½“å‰æ´»åŠ¨çš„ goroutine çš„æ•°é‡ä½äºé…ç½®çš„é™åˆ¶æ—¶ï¼ŒTryGo æ‰ä¼šåœ¨æ–°çš„ goroutine ä¸­è°ƒç”¨ç»™å®šçš„å‡½æ•°ã€‚ // è¿”å›å€¼æŠ¥å‘Š goroutine æ˜¯å¦å·²å¯åŠ¨ã€‚ func (g *Group) TryGo(f func() error) bool { if g.sem != nil { select { case g.sem \u0026lt;- token{}: // Note: this allows barging iff channels in general allow barging. default: return false } } g.wg.Add(1) go func() { defer g.done() if err := f(); err != nil { g.errOnce.Do(func() { g.err = err if g.cancel != nil { g.cancel() } }) } }() return true } Wait // Wait blocks until all function calls from the Go method have returned, then // returns the first non-nil error (if any) from them. // // é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ¥è‡ª Go æ–¹æ³•çš„æ‰€æœ‰å‡½æ•°è°ƒç”¨éƒ½è¿”å›ï¼Œç„¶åä»å®ƒä»¬è¿”å›ç¬¬ä¸€ä¸ªéé›¶é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ func (g *Group) Wait() error { g.wg.Wait() if g.cancel != nil { g.cancel() } return g.err } æ€»çš„æ¥çœ‹ï¼Œæºç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“é˜…è¯»ã€‚\n","date":"2022å¹´05æœˆ28æ—¥","permalink":"/posts/errgroup/","summary":"ç®€ä»‹ errgroup æ˜¯ WaitGroup çš„å¼ºåŒ–ç‰ˆï¼Œå…¶åœ¨ WaitGroup çš„åŸºç¡€ä¸Šæ·»åŠ äº†é”™è¯¯å¤„ç†çš„åŠŸèƒ½ï¼šå¦‚æœä¸€ç»„ goroutine ä¸­çš„æŸä¸€ä¸ªå‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£ä¹ˆåç»­çš„æ‰€æœ‰ gorouine éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚","title":"Go errgroup ä½¿ç”¨"},{"contents":"ä¸€ä¸ª echo server ç¤ºä¾‹ï¼š\npackage main import ( \u0026quot;log\u0026quot; . \u0026quot;syscall\u0026quot; ) const eventNum = 10 func init() { log.SetFlags(log.Lshortfile | log.Ldate) } func main() { sfd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { panic(err) } //log.Printf(\u0026quot;listen fd: %v\\n\u0026quot;, sfd) if err := Bind(sfd, \u0026amp;SockaddrInet4{Port: 8080, Addr: [4]byte{127, 0, 0, 1}}); err != nil { panic(err) } if err := Listen(sfd, 1024); err != nil { panic(err) } kfd, err := Kqueue() if err != nil { panic(err) } change := Kevent_t{ Ident: uint64(sfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, } _, err = Kevent(kfd, []Kevent_t{change}, nil, nil)\t// æ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ ç©º if err != nil { panic(err) } for { events := make([]Kevent_t, eventNum) // è·å–å°±ç»ªäº‹ä»¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ ç©º readyEventNum, err := Kevent(kfd, nil, events, nil) // æ— é™ç­‰å¾…ç›´åˆ°æœ‰äº‹ä»¶äº§ç”Ÿ //fmt.Printf(\u0026quot;readyEventNum: %v\\n\u0026quot;, readyEventNum) if err != nil \u0026amp;\u0026amp; err != EINTR { panic(err) } for i := 0; i \u0026lt; readyEventNum; i++ { event := events[i] log.Printf(\u0026quot;event fd: %v \\n\u0026quot;, event.Ident) efd := int(event.Ident) if efd == sfd { nfd, _, err := Accept(sfd) if err != nil { log.Println(err) continue } log.Printf(\u0026quot;accept event, fd: %v\\n\u0026quot;, nfd) if err := SetNonblock(nfd, true); err != nil { log.Println(err) continue //panic(err) } change := Kevent_t{ Ident: uint64(nfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, } // æ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ ç©º _, err = Kevent(kfd, []Kevent_t{change}, nil, nil) if err != nil { panic(err) } } else { log.Printf(\u0026quot;read event\\n\u0026quot;) b := make([]byte, 1024) _, err := Read(efd, b) if err != nil { log.Println(err) Close(efd) continue } _, err = Write(efd, b) if err != nil { log.Println(err) Close(efd) continue } } } } } è¸©å‘è®°å½• é”™è¯¯ç‰ˆæœ¬ï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;log\u0026quot; . \u0026quot;syscall\u0026quot; ) const eventNum = 10 func init() { log.SetFlags(log.Lshortfile | log.Ldate) } // BUG è®°å½•ï¼š // 1. å®¢æˆ·ç«¯æ–­å¼€è¿æ¥åï¼ŒæœåŠ¡ç«¯ä»ç„¶ä¼šäº§ç”Ÿè¯»äº‹ä»¶ // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥åï¼ŒæœåŠ¡ç«¯çš„ Read ä¼šå‘ç”Ÿ connection reset by peer é”™è¯¯å¹¶è¿›å…¥é”™è¯¯å¤„ç†åˆ†æ”¯ï¼Œ Close æ‰è¿™ // ä¸ªè¿æ¥ï¼Œä½†æ˜¯å› ä¸ºé”™è¯¯å¤„ç†é‡‡ç”¨çš„æ˜¯ continue è€Œä¸æ˜¯ breakï¼ˆå› ä¸ºå¯èƒ½ä¼šåŒæ—¶äº§ç”Ÿå¤šä¸ªäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ kevent çš„è¿” // å›å€¼ï¼Œå¦‚æœä½¿ç”¨ breakï¼Œä¼šå¯¼è‡´åé¢çš„äº‹ä»¶å…¨éƒ¨è¢«æ”¾å¼ƒå¤„ç†ï¼Œå› ä¸ºå¤šä¸ªäº‹ä»¶ä¸­çš„æŸä¸€ä¸ªäº‹ä»¶äº§ç”Ÿé”™è¯¯ï¼Œè€Œç›´æ¥è·³è¿‡åç»­äº‹ // ä»¶çš„å¤„ç†ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼‰ï¼Œä¼šé‡æ–°è¿›å…¥å¤–å±‚çš„æ­»å¾ªç¯ï¼Œåˆå› ä¸ºä¼šç»§ç»­äº§ç”Ÿè¯»äº‹ä»¶ï¼Œå¯¼è‡´ Kevent å‡½æ•°æˆåŠŸè¿”å›ï¼Œè¿› // å…¥åˆ°è¯»äº‹ä»¶åˆ†æ”¯ï¼Œè¿›è¡Œ Read æ“ä½œï¼Œæ­¤æ—¶ä¼šæŠ¥é”™ bad file descriptorï¼Œcontinue åˆ°æœ€å¤–å±‚æ­»å¾ªç¯ï¼Œå¦‚æ­¤åå¤ï¼Œ // ç›´åˆ°å¾ªç¯å¾ˆå¤šæ¬¡ä»¥åä¼šæŠ›å‡ºä¸€ä¸ª panic func main() { sfd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { panic(err) } log.Printf(\u0026quot;listen fd: %v\\n\u0026quot;, sfd) if err := Bind(sfd, \u0026amp;SockaddrInet4{Port: 8080, Addr: [4]byte{127, 0, 0, 1}}); err != nil { panic(err) } if err := Listen(sfd, 1024); err != nil { panic(err) } var ( changes = make([]Kevent_t, 0) // ç›‘å¬åˆ—è¡¨ events = make([]Kevent_t, eventNum) // å‘ç”Ÿçš„äº‹ä»¶åˆ—è¡¨ï¼Œlen ä¸èƒ½ä¸º 0 ) kfd, err := Kqueue() if err != nil { panic(err) } readEvent := Kevent_t{ Ident: uint64(sfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, } changes = append(changes, readEvent) // BUG1 è§£å†³æ­¥éª¤1 ï¼šæ–°å¢ä¸‹é¢è¿™ä¸ªå‡½æ•°è°ƒç”¨ // _, err = Kevent(kfd, changes, nil, nil) // if err != nil { // panic(err) // } for { // BUG1 è§£å†³æ­¥éª¤2ï¼š // è¿™é‡Œçš„ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»ä¼  nilï¼Œå¦‚æœä¼  changes å°±ä¼šå‡ºç° BUG1 çš„æƒ…å†µ readyEventNum, err := Kevent(kfd, changes, events, nil) // æ— é™ç­‰å¾…ç›´åˆ°æœ‰äº‹ä»¶äº§ç”Ÿ fmt.Printf(\u0026quot;readyEventNum: %v\\n\u0026quot;, readyEventNum) if err != nil \u0026amp;\u0026amp; err != EINTR { panic(err) } log.Printf(\u0026quot;events: %v \\n\u0026quot;, events) log.Printf(\u0026quot;changes: %v \\n\u0026quot;, changes) log.Printf(\u0026quot;readyEventNum: %v\\n\u0026quot;, readyEventNum) for i := 0; i \u0026lt; readyEventNum; i++ { event := events[i] log.Printf(\u0026quot;event fd: %v \\n\u0026quot;, event.Ident) efd := int(event.Ident) if efd == sfd { nfd, _, err := Accept(sfd) if err != nil { log.Println(err) continue } log.Printf(\u0026quot;accept event, fd: %v\\n\u0026quot;, nfd) if err := SetNonblock(nfd, true); err != nil { log.Println(err) continue //panic(err) } changes = append(changes, Kevent_t{ Ident: uint64(nfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, }) // BUG1 è§£å†³æ­¥éª¤3 ï¼šæ–°å¢ä¸‹é¢è¿™ä¸ªå‡½æ•°è°ƒç”¨ // _, err = Kevent(kfd, changes, nil, nil) // if err != nil { // panic(err) // } } else /*if event.Filter == EVFILT_READ*/ { log.Printf(\u0026quot;read event\\n\u0026quot;) b := make([]byte, 1024) _, err := Read(efd, b) if err != nil { log.Println(err) Close(efd) continue } _, err = Write(efd, b) if err != nil { log.Println(err) Close(efd) continue } } } } } æ­£ç¡®ç‰ˆæœ¬ï¼š\næŒ‰ç…§æ³¨é‡Šä¸Šçš„æ ‡æ³¨è¿›è¡Œä¿®æ”¹ï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;log\u0026quot; . \u0026quot;syscall\u0026quot; ) const eventNum = 10 func init() { log.SetFlags(log.Lshortfile | log.Ldate) } func main() { sfd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { panic(err) } log.Printf(\u0026quot;listen fd: %v\\n\u0026quot;, sfd) if err := Bind(sfd, \u0026amp;SockaddrInet4{Port: 8080, Addr: [4]byte{127, 0, 0, 1}}); err != nil { panic(err) } if err := Listen(sfd, 1024); err != nil { panic(err) } var ( changes = make([]Kevent_t, 0) // ç›‘å¬åˆ—è¡¨ events = make([]Kevent_t, eventNum) // å‘ç”Ÿçš„äº‹ä»¶åˆ—è¡¨ï¼Œlen ä¸èƒ½ä¸º 0 ) kfd, err := Kqueue() if err != nil { panic(err) } readEvent := Kevent_t{ Ident: uint64(sfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, } changes = append(changes, readEvent) // BUG1 è§£å†³æ­¥éª¤1 ï¼šæ–°å¢ä¸‹é¢è¿™ä¸ªå‡½æ•°è°ƒç”¨ _, err = Kevent(kfd, changes, nil, nil) if err != nil { panic(err) } for { // BUG1 è§£å†³æ­¥éª¤2ï¼š // è¿™é‡Œçš„ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»ä¼  nilï¼Œå¦‚æœä¼  changes å°±ä¼šå‡ºç° BUG1 çš„æƒ…å†µ readyEventNum, err := Kevent(kfd, nil, events, nil) // æ— é™ç­‰å¾…ç›´åˆ°æœ‰äº‹ä»¶äº§ç”Ÿ //fmt.Printf(\u0026quot;readyEventNum: %v\\n\u0026quot;, readyEventNum) if err != nil \u0026amp;\u0026amp; err != EINTR { panic(err) } //log.Printf(\u0026quot;events: %v \\n\u0026quot;, events) //log.Printf(\u0026quot;changes: %v \\n\u0026quot;, changes) //log.Printf(\u0026quot;readyEventNum: %v\\n\u0026quot;, readyEventNum) for i := 0; i \u0026lt; readyEventNum; i++ { event := events[i] //log.Printf(\u0026quot;event fd: %v \\n\u0026quot;, event.Ident) efd := int(event.Ident) if efd == sfd { nfd, _, err := Accept(sfd) if err != nil { log.Println(err) continue } log.Printf(\u0026quot;accept event, fd: %v\\n\u0026quot;, nfd) if err := SetNonblock(nfd, true); err != nil { log.Println(err) continue //panic(err) } changes = append(changes, Kevent_t{ Ident: uint64(nfd), Filter: EVFILT_READ, Flags: EV_ADD | EV_ENABLE, Fflags: 0, Data: 0, Udata: nil, }) // BUG1 è§£å†³æ­¥éª¤3 ï¼šæ–°å¢ä¸‹é¢è¿™ä¸ªå‡½æ•°è°ƒç”¨ _, err = Kevent(kfd, changes, nil, nil) if err != nil { panic(err) } } else /*if event.Filter == EVFILT_READ*/ { log.Printf(\u0026quot;read event\\n\u0026quot;) b := make([]byte, 1024) _, err := Read(efd, b) if err != nil { log.Println(err) Close(efd) continue } _, err = Write(efd, b) if err != nil { log.Println(err) Close(efd) continue } } } } } åŸå› ï¼š\næ²¡ç ”ç©¶å‡ºæ¥\næš‚æ—¶è§è§£ï¼š\nè²Œä¼¼ kqueue è¿™ä¸ªå‡½æ•°æ˜¯ epoll çš„ epoll_ctl å’Œ epoll_wait çš„ç»“åˆä½“ï¼Œä¸»è¦æ˜¯å®ƒçš„ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆGo çš„ç³»ç»Ÿè°ƒç”¨éœ€è¦çš„å‚æ•°å’ŒåŸç”Ÿ API ç•¥æœ‰ä¸åŒï¼Œä½†å½±å“ä¸å¤§ï¼Œåªæ˜¯ä¸ç”¨æä¾›ä¸¤ä¸ªæ•°ç»„çš„é•¿åº¦è€Œå·²ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦ç›‘å¬çš„äº‹ä»¶é›†åˆï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥å­˜æ”¾å·²ç»å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦æ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå°±å°†ç¬¬ä¸‰ä¸ªå‚æ•°ä¼  nullï¼›å¦‚æœæƒ³è·å–å·²ç»å°±ç»ªçš„äº‹ä»¶ï¼Œé‚£ä¹ˆå°±ç»™ç¬¬äºŒä¸ªå‚æ•°ä¼  nullï¼Œå…·ä½“çœ‹å¼€å¤´çš„ echo server ä»£ç çš„é‚£å‡ è¡Œè°ƒç”¨ Kqueue çš„æ³¨é‡Šã€‚çœ‹äº†ä¸€äº›æ­£ç¡®çš„ä¾‹å­ï¼ŒåŒ…æ‹¬å®˜æ–¹çš„ FreeBSD man æ–‡æ¡£ï¼ŒåŸºæœ¬éƒ½æ˜¯è¿™ä¹ˆå†™çš„ã€‚\nå¯¹æ¯” epoll\npackage main import ( \u0026quot;log\u0026quot; . \u0026quot;syscall\u0026quot; ) func init() { log.SetFlags(log.Lshortfile | log.Ltime) } func main() { sfd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { panic(err) } log.Printf(\u0026quot;listen fd: %v\\n\u0026quot;, sfd) if err := Bind(sfd, \u0026amp;SockaddrInet4{Port: 8080, Addr: [4]byte{127, 0, 0, 1}}); err != nil { panic(err) } if err := Listen(sfd, 1024); err != nil { panic(err) } epfd, err := EpollCreate(10) if err != nil { panic(err) } if err := EpollCtl(epfd, EPOLL_CTL_ADD, sfd, \u0026amp;EpollEvent{ Events: EPOLLIN, Fd: int32(sfd), Pad: 0, }); err != nil { panic(err) } for { events := make([]EpollEvent, 20) n, err := EpollWait(epfd, events, -1) if err != nil { log.Println(err) continue } for i := 0; i \u0026lt; n; i++ { event := events[i] if event.Fd == int32(sfd) { nfd, _, err := Accept(sfd) if err != nil { log.Println(err) continue } if err := EpollCtl(epfd, EPOLL_CTL_ADD, nfd, \u0026amp;EpollEvent{ Events: EPOLLIN, Fd: int32(nfd), Pad: 0, }); err != nil { log.Println(err) continue } } else { b := make([]byte, 1024) _, err := Read(int(event.Fd), b) if err != nil { log.Println(err) Close(int(event.Fd)) continue } _, err = Write(int(event.Fd), b) if err != nil { log.Println(err) Close(int(event.Fd)) continue } } } } } ","date":"2022å¹´05æœˆ28æ—¥","permalink":"/posts/kqueue/","summary":"ä¸€ä¸ª echo server ç¤ºä¾‹ï¼š\npackage main import ( \u0026quot;log\u0026quot; .","title":"kqueue"},{"contents":"ä¸ºä»€ä¹ˆéœ€è¦å· pod ç±»ä¼¼é€»è¾‘ä¸»æœºï¼Œåœ¨é€»è¾‘ä¸»æœºä¸­è¿è¡Œçš„è¿›ç¨‹å…±äº«è¯¸å¦‚ CPUã€RAMã€ç½‘ç»œæ¥å£ç­‰èµ„æºã€‚æœ‰æ—¶å€™äººä»¬ä¼šæœŸæœ›è¿›ç¨‹ä¹Ÿèƒ½å…±äº«ç£ç›˜ï¼Œä½†æ˜¯å› ä¸º pod ä¸­è¿è¡Œçš„æ˜¯ä¸€ä¸ªä¸ªå®¹å™¨ï¼Œè€Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸ºæ–‡ä»¶ç³»ç»Ÿæ¥è‡ªäºå®¹å™¨é•œåƒï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½å…±äº«ç£ç›˜ã€‚æœ‰æ—¶å€™å¯èƒ½å­˜åœ¨è¿™æ ·ä¸€ç§éœ€æ±‚ï¼špod ä¸­æŸä¸ªå®¹å™¨å­˜å‚¨çš„æ•°æ®éœ€è¦æŒä¹…åŒ–ï¼Œä½†æ˜¯å› ä¸ºå®¹å™¨å­˜åœ¨æŒ‚æ‰çš„å¯èƒ½ï¼Œå¦‚æœæŒ‚æ‰åä¼šæ–°åˆ›å»ºä¸€ä¸ª pod æ¥é¡¶æ›¿ï¼Œä½†æ˜¯å› ä¸º pod å› ä¸ºæ— æ³•å…±äº«ç£ç›˜ï¼Œå¯¼è‡´æ— æ³•ç»§æ‰¿å…ˆå‰ pod é‡Œå­˜å‚¨çš„æ•°æ®ï¼Œå…ˆå‰çš„é‚£éƒ¨åˆ†æ•°æ®å°±æ°¸ä¹…ä¸¢å¤±äº†ã€‚\nk8s é€šè¿‡å®šä¹‰ å· è¿™ä¸ªæ¦‚å¿µæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä»¬ä¸åƒ pod è¿™æ ·çš„é¡¶çº§èµ„æºï¼Œè€Œæ˜¯è¢«å®šä¹‰ä¸ºäº† pod çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶å’Œ pod å…±äº«ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå·åœ¨ pod å¯åŠ¨æ—¶åˆ›å»ºï¼Œåœ¨ pod åˆ é™¤æ—¶é”€æ¯ï¼ˆä¹¦ä¸Šæ˜¯è¿™ä¹ˆè¯´çš„ï¼Œä½†æ˜¯æ„Ÿè§‰ä¸å¤ªå‡†ç¡®ï¼Œä¸åŒç±»å‹çš„å·æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œåƒ emptyDir å°±æ˜¯å’Œ pod å…±äº«ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ hostPath åˆ™ä¸å…±äº«ï¼Œå°±ç®— pod åˆ é™¤äº†ï¼Œè¿™ä¸ªå·ä¹Ÿä¸ä¼šè¢«åˆ é™¤ï¼‰ã€‚\nå·ç±»å‹ emptyDir é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå·æœ€åˆæ˜¯ç©ºçš„ï¼Œå½“ Pod å› ä¸ºæŸäº›åŸå› è¢«ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ï¼ŒemptyDir å·ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚è¿è¡Œåœ¨ pod å†…çš„åº”ç”¨ç¨‹åºå¯ä»¥å†™å…¥å®ƒéœ€è¦çš„ä»»ä½•æ–‡ä»¶ã€‚\nå®è·µï¼š\nyaml å¦‚ä¸‹ï¼šï¼ˆ âš ï¸ è¯¥ yaml çš„é•œåƒåŸºäº arm64 æ¶æ„ï¼Œå¦‚æœä½ çš„æœºå™¨æ˜¯ x86ï¼Œéœ€è¦å°†ç¬¬ä¸€ä¸ª -image æ›´æ¢ä¸º luksa/fortuneï¼‰\napiVersion: v1 kind: Pod metadata: name: fortune spec: containers: - image: stdoutt/fortune-arm64 name: html-generator volumeMounts: - name: html # ä½¿ç”¨ name ä¸º html çš„å·ï¼ˆè¯¥å·åœ¨ yaml æœ€åå®šä¹‰ï¼‰ mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html emptyDir: {} è¿™ä¸ª pod çš„å¤§è‡´æ„æ€æ˜¯ï¼šåˆ›å»ºäº† 2 ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªè´Ÿè´£ç”Ÿæˆéšæœºå†…å®¹ï¼ˆä½¿ç”¨ fortune éšæœºç”Ÿæˆä¸€å¥è°šè¯­ï¼‰å¹¶å†™å…¥åˆ° /var/htdocs/index.html æ–‡ä»¶é‡Œï¼Œå¦ä¸€ä¸ªæ˜¯ nginx æœåŠ¡ï¼Œè´Ÿè´£å°† /usr/share/nginx/html/index.html é‡Œçš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥ï¼ˆå°†ç¬¬ä¸€ä¸ªå®¹å™¨å†™å…¥çš„è°šè¯­è¯»å–å‡ºæ¥ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå®¹å™¨éœ€è¦ç»“åˆä½¿ç”¨ï¼Œä¸€ä¸ªè´Ÿè´£å†™ï¼Œå¦ä¸€ä¸ªè´Ÿè´£è¯»ï¼Œæ‰€ä»¥éœ€è¦å…±ç”¨åŒä¸€ä¸ªå·æ¥å®ç°ã€‚\nä¸ºäº†å®ç°ä¸Šé¢çš„æµç¨‹ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªå·ï¼Œå°†è¿™ä¸ªå·åˆ†åˆ«æŒ‚è½½åˆ°ä¸¤ä¸ªå®¹å™¨çš„æŸä¸ªç›®å½•ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°å…±äº«ä¸€ä¸ªå·çš„ç›®çš„ï¼Œåœ¨ä¸Šé¢çš„ yaml ä¸­ï¼Œå°†å·æŒ‚è½½åˆ°äº† fortune å®¹å™¨çš„ /var/htdocs/ ç›®å½•ä¸‹ï¼Œç„¶åè¿™ä¸ªå®¹å™¨ä¼šåœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª index.html å¹¶å†™å…¥è°šè¯­ï¼ˆå› ä¸ºæŒ‚è½½çš„åŸå› ï¼Œæ‰€ä»¥ç›¸å½“åœ¨å·ä¸­åˆ›å»ºäº†ä¸€ä¸ª index.html æ–‡ä»¶ï¼‰ï¼›åŒæ ·è¿˜ä¼šå°†è¿™ä¸ªå·æŒ‚è½½åˆ° nginx å®¹å™¨ä¸‹çš„ /usr/share/nginx/html ç›®å½•ä¸‹ï¼Œnginx é»˜è®¤ä¼šè¯»å–è¿™ä¸ªç›®å½•ä¸‹çš„ index.html ä½œä¸ºæ˜¾ç¤ºå†…å®¹ï¼Œå‰é¢æåˆ°è¿‡ï¼Œfortune å®¹å™¨ä¼šåˆ›å»ºä¸€ä¸ª index.html æ–‡ä»¶åˆ°å·ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶åˆšå¥½å°±å¯ä»¥ä½œä¸º nginx çš„é»˜è®¤æ˜¾ç¤ºå†…å®¹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œyaml é‡Œè¿˜å¯¹ nginx å®¹å™¨è®¾ç½®äº† readOnly: true å±æ€§ï¼Œè¡¨ç¤ºè¯¥å®¹å™¨åªèƒ½ä»å·ä¸­è¯»å–ï¼Œä¸èƒ½å†™å…¥ã€‚\nä»¥ä¸Šæ¶‰åŠåˆ° linux æŒ‚è½½ï¼ˆmountï¼‰çš„çŸ¥è¯†ï¼Œè¿™ä¸ªæ¦‚å¿µæ„Ÿè§‰æœ‰ç‚¹ç»•ï¼Œï¼ˆæˆ‘æ€»æ˜¯æŠŠæŒ‚è½½ã€è¢«æŒ‚è½½ææ··ï¼‰ï¼Œæˆ‘ä¹Ÿæ˜¯åˆå­¦æŒæ¡çš„ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥ä¸Šé¢çš„å†…å®¹è¯´çš„æ¯”è¾ƒç»•ï¼Œä¹Ÿå¯èƒ½ä¸æ­£ç¡®ï¼Œç”¨æˆ‘ä¸ªäººçš„ç†è§£ï¼Œç®€å•çš„ç”¨å‡ å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼Œå°†å·æŒ‚è½½åˆ°äº†ä¸€ä¸ªå®¹å™¨çš„ /var/htdocs ä¸‹å’Œå¦ä¸€ä¸ªå®¹å™¨çš„ /usr/share/nginx/html å®¹å™¨ä¸‹ï¼Œç„¶åè¿™ä¸¤ä¸ªè·¯å¾„å°±ç›¸å½“äºå…±äº«äº†ï¼Œç¬¬ä¸€ä¸ªå®¹å™¨åœ¨ /var/htdocs ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¦ä¸€ä¸ªå®¹å™¨å¯ä»¥åŒæ ·åœ¨ /usr/share/nginx/html ç›®å½•ä¸‹è¯»å–åˆ°ã€‚\nå› ä¸ºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯éš”ç¦»çš„ï¼Œæ­£å¸¸æ¥è¯´ä¸¤ä¸ªå®¹å™¨æ˜¯ä¸èƒ½å…±äº«ç›®å½•çš„ï¼Œå°±ç›¸å½“äºä¸¤å°ç”µè„‘ï¼Œå¦‚æœä¸é€šè¿‡ä¸€äº›ç‰¹æ®Šæ‰‹æ®µè‚¯å®šæ˜¯ä¸èƒ½å…±äº«ç›®å½•çš„ï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸Šé¢çš„ å· æ¥å®ç°ã€‚\næ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨ kubectl apply -f è¿›è¡Œåˆ›å»ºäº†ï¼Œä¸ºäº†æµ‹è¯•æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨ç«¯å£è½¬å‘ï¼š\n$ kubectl port-forward fortune 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 ç„¶åä½¿ç”¨ curl å°±å¯ä»¥äº†ï¼š\n$ curl http://localhost:8080 Q:\tHow many psychiatrists does it take to change a light bulb? A:\tOnly one, but it takes a long time, and the light bulb has to really want to change. â“è¿™ä¸ª emptyDir å®é™…è·¯å¾„åœ¨å“ªé‡Œï¼Ÿ\nemptyDir ä¸ä»…å¯ä»¥ä½¿ç”¨å¸¸è§„çš„ç¡¬ç›˜ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…å­˜ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼ˆlinux ä¸­çš„ tmpfs ä¹Ÿæ˜¯ç±»ä¼¼çš„ä¸œè¥¿ï¼‰ï¼Œåªéœ€è¦åœ¨ yaml ä¸­æŒ‡å®š mediun å³å¯ï¼š\nvolumes: - name: html emptyDir: medium: Memory # å­˜å‚¨åœ¨å†…å­˜ä¸­ hostPath è¿™é‡Œå¤ç”¨ emptyDir éƒ¨åˆ†çš„ yamlï¼Œåªæ˜¯å°† volume çš„ç±»å‹æ›´æ¢ä¸ºäº† hostPathï¼š\napiVersion: v1 kind: Pod metadata: name: fortune spec: containers: - image: stdoutt/fortune-arm64 name: html-generator volumeMounts: - name: html mountPath: /var/htdocs - image: nginx:alpine name: web-server volumeMounts: - name: html mountPath: /usr/share/nginx/html readOnly: true ports: - containerPort: 80 protocol: TCP volumes: - name: html hostPath: path: /data type: Directory æ‰§è¡Œä¸Šé¢çš„ yamlï¼Œåˆ›å»º podï¼Œç„¶åçœ‹çœ‹ hostPath å·é‡Œçš„å†…å®¹ï¼š\n$ cat /data/index.html Stay away from hurricanes for a while. $ cat /data/index.html A vivid and creative mind characterizes you. ä¹Ÿå¯ä»¥åƒ emptyDir ä¸­æ¼”ç¤ºçš„é‚£æ ·ï¼Œå¼€å¯ç«¯å£è½¬å‘ï¼Œä½¿ç”¨ curl çœ‹çœ‹æ•ˆæœï¼Œè¿™é‡Œå°±ä¸è®°å½•äº†ã€‚\næµ‹è¯•ä¸€ä¸‹ hostPath ç±»å‹çš„å·æ˜¯å¦å’Œ pod å…±äº«ç”Ÿå‘½å‘¨æœŸï¼š\n$ kubectl delete po fortune pod \u0026quot;fortune\u0026quot; deleted $ cat /data/index.html Today's weirdness is tomorrow's reason why. -- Hunter S. Thompson pod è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯ /data ä¸‹çš„å†…å®¹ä¾ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥ hostPath å·ä¸ä¸ pod å…±äº«ç”Ÿå‘½å‘¨æœŸï¼Œå±äºæŒä¹…å·ã€‚\næŒä¹…å· æŒä¹…å·ï¼ˆpvï¼‰å’ŒæŒä¹…å·å£°æ˜ï¼ˆpvcï¼‰ ä¸€èˆ¬æ¥è¯´ï¼Œå¼€å‘è€…ä¸éœ€è¦çŸ¥é“æŒä¹…å·å­˜å‚¨çš„ç±»å‹å’Œåœ°å€ï¼Œå¦‚æœå¼€å‘è€…å®šä¹‰ pod æ—¶éœ€è¦æ‰‹åŠ¨æŒ‡å®šå­˜å‚¨åœ°å€ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´é«˜è€¦åˆï¼Œè§£å†³æ–¹æ³•å°±æ˜¯è®¡ç®—æœºçš„é€šç”¨è§£å†³æ–¹æ³•ï¼šå¥—ä¸€å±‚ä¸­é—´å±‚ï¼Œpvc å°±æ˜¯è¿™ä¸ªä¸­é—´å±‚ï¼Œå¼€å‘è€…åªéœ€è¦å°†è‡ªå·±çš„éœ€æ±‚ï¼ˆå®¹é‡éœ€æ±‚ã€è®¿é—®æ¨¡å¼ï¼‰å®šä¹‰ä¸º pvc æäº¤ç»™ k8sï¼Œk8s å°†æ‰¾åˆ°å¯åŒ¹é…çš„æŒä¹…å·å¹¶å°†å…¶ç»‘å®šåˆ° pvcã€‚\nPVC ä¸ PV æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œä¸èƒ½ä¸€ä¸ª PVC æŒ‚è½½å¤šä¸ª PVï¼Œä¹Ÿä¸èƒ½ä¸€ä¸ª PV æŒ‚è½½å¤šä¸ª PVCã€‚ä¸ºåº”ç”¨é…ç½®å­˜å‚¨æ—¶ï¼Œéœ€è¦å£°æ˜ä¸€ä¸ªå­˜å‚¨éœ€æ±‚å£°æ˜ï¼ˆPVCï¼‰ï¼Œè€ŒKubernetesä¼šé€šè¿‡æœ€ä½³åŒ¹é…çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªæ»¡è¶³PVCéœ€æ±‚çš„PVï¼Œå¹¶ä¸ä¹‹ç»‘å®šã€‚æ‰€ä»¥ä»èŒè´£ä¸ŠPVCæ˜¯åº”ç”¨æ‰€éœ€è¦çš„å­˜å‚¨å¯¹è±¡ï¼Œå±äºåº”ç”¨ä½œç”¨åŸŸã€‚PVæ˜¯å­˜å‚¨å¹³é¢çš„å­˜å‚¨å¯¹è±¡ï¼Œå±äºæ•´ä¸ªå­˜å‚¨åŸŸã€‚\nPVCåªæœ‰ç»‘å®šäº†PVä¹‹åæ‰èƒ½è¢«Podä½¿ç”¨ï¼Œè€ŒPVCç»‘å®šPVçš„è¿‡ç¨‹å³æ˜¯æ¶ˆè´¹PVçš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æœ‰ä¸€å®šè§„åˆ™çš„ï¼Œä»¥ä¸‹è§„åˆ™éƒ½æ»¡è¶³çš„PVæ‰èƒ½è¢«PVCç»‘å®šï¼š\nVolumeModeï¼šè¢«æ¶ˆè´¹PVçš„VolumeModeéœ€è¦å’ŒPVCä¸€è‡´ã€‚ AccessModeï¼šè¢«æ¶ˆè´¹PVçš„AccessModeéœ€è¦å’ŒPVCä¸€è‡´ã€‚ StorageClassNameï¼šå¦‚æœPVCå®šä¹‰äº†æ­¤å‚æ•°ï¼ŒPVå¿…é¡»æœ‰ç›¸å…³çš„å‚æ•°å®šä¹‰æ‰èƒ½è¿›è¡Œç»‘å®šã€‚ LabelSelectorï¼šé€šè¿‡æ ‡ç­¾ï¼ˆlabelsï¼‰åŒ¹é…çš„æ–¹å¼ä»PVåˆ—è¡¨ä¸­é€‰æ‹©åˆé€‚çš„PVç»‘å®šã€‚ Sizeï¼šè¢«æ¶ˆè´¹PVçš„capacityå¿…é¡»å¤§äºæˆ–è€…ç­‰äºPVCçš„å­˜å‚¨å®¹é‡éœ€æ±‚æ‰èƒ½è¢«ç»‘å®šã€‚ åœ¨ k3s ä¸Šå®è·µ pv å’Œ pvc pvc.yaml\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: local-path-pvc namespace: default spec: accessModes: - ReadWriteOnce storageClassName: local-path resources: requests: storage: 50Mi åˆ›å»ºå¹¶æŸ¥çœ‹ï¼š\n$ kubectl apply -f pvc.yaml persistentvolumeclaim/local-path-pvc created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Pending local-path 102s $ kubectl get pv No resources found å‘ç° pvc çš„çŠ¶æ€æ˜¯ pendingï¼ŒæŸ¥çœ‹ describeï¼š\nEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal WaitForFirstConsumer 11s (x9 over 2m3s) persistentvolume-controller waiting for first consumer to be created before binding æ„æ€æ˜¯ pvc åˆ›å»ºå¥½äº†ï¼Œç­‰å¾…æŸä¸ªæ¶ˆè´¹è€…æ¥ç»‘å®šå®ƒï¼Œæ‰€ä»¥å¤„äº pending çŠ¶æ€ï¼Œæ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª pod ä½œä¸ºæ¶ˆè´¹è€…ï¼Œæ¥ç»‘å®šè¿™ä¸ª pvcï¼š\npvc_consumer_pod.yaml\napiVersion: v1 kind: Pod metadata: name: volume-test namespace: default spec: containers: - name: volume-test image: nginx:stable-alpine imagePullPolicy: IfNotPresent volumeMounts: - name: volv mountPath: /data ports: - containerPort: 80 volumes: - name: volv persistentVolumeClaim: claimName: local-path-pvc è¿è¡Œï¼š\n$ kubectl apply -f pvc_consumer_pod.yaml pod/volume-test created æ­¤æ—¶å†æŸ¥çœ‹ pvc çŠ¶æ€ï¼š\n$ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4 50Mi RWO local-path 5m41s $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4 50Mi RWO Delete Bound default/local-path-pvc local-path 41m å‘ç° pvc å·²ç»å¤„äº Bound çŠ¶æ€äº†ï¼Œæ­¤å¤– pv ä¹Ÿå·²ç»åˆ›å»ºå¥½äº†\næ¥ä¸‹æ¥å°±å¯ä»¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœäº†ï¼Œé¦–å…ˆéœ€è¦å…ˆè¿›å…¥å®¹å™¨ï¼š\n$ k3s kubectl get po NAME READY STATUS RESTARTS AGE redis 1/1 Running 0 9h volume-test 1/1 Running 0 5m49s $ kubectl exec -it volume-test -- /bin/sh / # ls bin docker-entrypoint.sh media root sys data etc mnt run tmp dev home opt sbin usr docker-entrypoint.d lib proc srv var å› ä¸º pvc_consumer_pod.yaml ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰çš„æŒ‚è½½ç›®å½•çš„ /dataï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ cd åˆ°å®¹å™¨çš„ /data ç›®å½•ï¼Œç„¶åå‘è¿™ä¸ªç›®å½•ä¸­å†™å…¥ä¸€äº›å†…å®¹ï¼Œå†çœ‹çœ‹å…¶ pvc ç»‘å®šçš„ pv æ˜¯å¦ä¼šåŒæ­¥æ‹¥æœ‰è¯¥å†…å®¹\n# æ­¤æ—¶æ¥ç€ä¸Šé¢çš„ execï¼Œä¹Ÿå°±æ˜¯åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œè¿™äº›å‘½ä»¤ / # cd data /data # echo \u0026quot;hello, local PV\u0026quot; \u0026gt; pvc-test /data # cat pvc-test hello, local PV åœ¨ local PV æŸ¥çœ‹æ˜¯å¦åŒæ ·æœ‰æ­¤æ–‡ä»¶ï¼Œåœ¨ k3s ä¸­ï¼Œpv å­˜å‚¨åœ¨ /var/lib/rancher/k3s/storage ç›®å½•ä¸‹ï¼Œk3s çš„ pv ç›¸å…³å†…å®¹å¯ä»¥ å‚è€ƒè¿™ç¯‡\n# é€€å‡ºå®¹å™¨å†…éƒ¨ï¼Œå›åˆ°ä¸»æœº $ ls /var/lib/rancher/k3s/storage/ pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4_default_local-path-pvc $ cd /var/lib/rancher/k3s/storage/pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4_default_local-path-pvc $ ls pvc-test # åœ¨å®¹å™¨å†…éƒ¨å†™å…¥çš„å†…å®¹ï¼ŒåŒæ­¥åˆ°äº†è¿™é‡Œ $ cat pvc-test hello, local PV ç»“æœè¯´æ˜æµ‹è¯•æˆåŠŸ\nå¦‚æœä¸¤ä¸ª pod ç»‘å®šåˆ°åŒä¸€ä¸ª pvc ä¸Šä¼šæ€æ ·ï¼Ÿ ç»§ç»­æ²¿ç”¨ä¹‹å‰çš„ pvc_consumer_pod.yamlï¼Œåšä¸€äº›ä¿®æ”¹ï¼š\n$ cp pvc_consumer_pod.yaml pvc_consumer_pod1.yaml ä¿®æ”¹åï¼š\napiVersion: v1 kind: Pod metadata: name: volume-test1 # æ­¤å¤„ä¿®æ”¹ namespace: default spec: containers: - name: volume-test1 # æ­¤å¤„ä¿®æ”¹ image: nginx:stable-alpine imagePullPolicy: IfNotPresent volumeMounts: - name: volv mountPath: /data ports: - containerPort: 80 volumes: - name: volv persistentVolumeClaim: claimName: local-path-pvc åˆ›å»ºï¼š\n$ kubectl apply -f pvc_consumer_pod1.yaml pod/volume-test1 created $ kubectl get po NAME READY STATUS RESTARTS AGE redis 1/1 Running 0 10h volume-test 1/1 Running 0 25m volume-test1 1/1 Running 0 32s å‘ç°åˆ›å»ºæˆåŠŸäº†\nè¿˜æ˜¯æŒ‰ç…§ä¹‹å‰çš„æµç¨‹ï¼Œå…ˆ exec è¿›å®¹å™¨çœ‹çœ‹ï¼š\n$ kubectl exec -it volume-test1 -- /bin/sh / # ls bin docker-entrypoint.sh media root sys data etc mnt run tmp dev home opt sbin usr docker-entrypoint.d lib proc srv var / # cd data/ /data # ls pvc-test /data # cat pvc-test hello, local PV å‘ç° /data ä¸‹å·²ç»æœ‰å†…å®¹äº†ï¼Œè€Œä¸”å°±æ˜¯ä¹‹å‰ volume-test è¿™ä¸ª pod å†™å…¥çš„å†…å®¹ï¼Œå°è¯•å‘è¿™ä¸ªæ–‡ä»¶é‡Œæ–°å†™å…¥ä¸€éƒ¨åˆ†å†…å®¹ï¼š\n/data # echo \u0026quot;hello again\u0026quot; \u0026gt;\u0026gt; pvc-test /data # cat pvc-test hello, local PV hello again æŸ¥çœ‹ local PVï¼š\n$ cat /var/lib/rancher/k3s/storage/pvc-0e7db0b6-fa32-4c2e-ac0c-53a354ead8a4_default_local-path-pvc/pvc-test hello, local PV hello again æŸ¥çœ‹ç¬¬ä¸€ä¸ªå®¹å™¨ volume-test :\n$ kubectl exec -it volume-test -- /bin/sh / # cat /data/pvc-test hello, local PV hello again å‘ç°äºŒè€…çš„å†…å®¹éƒ½åŒæ­¥äº†\nå¦‚æ­¤çœ‹æ¥ï¼Œå¤šä¸ª pod å¯ä»¥ç»‘å®šåŒä¸€ä¸ª pvc æ¥è¾¾åˆ°å…±äº«æ–‡ä»¶çš„æ•ˆæœï¼Œpv å’Œ pvc æ˜¯ä¸€å¯¹ä¸€ç»‘å®šçš„ï¼Œä½†æ˜¯ pod å’Œ pvc æ˜¯å¯ä»¥å¤šå¯¹ä¸€ç»‘å®šçš„ã€‚\nåˆ é™¤ pvc ","date":"2022å¹´05æœˆ20æ—¥","permalink":"/posts/k8s-juan/","summary":"ä¸ºä»€ä¹ˆéœ€è¦å· pod ç±»ä¼¼é€»è¾‘ä¸»æœºï¼Œåœ¨é€»è¾‘ä¸»æœºä¸­è¿è¡Œçš„è¿›ç¨‹å…±äº«è¯¸å¦‚ CPUã€RAMã€ç½‘ç»œæ¥å£ç­‰èµ„æºã€‚æœ‰æ—¶å€™äººä»¬ä¼šæœŸæœ›è¿›ç¨‹ä¹Ÿèƒ½å…±äº«ç£ç›˜ï¼Œä½†æ˜¯å› ä¸º pod ä¸­è¿è¡Œçš„æ˜¯ä¸€ä¸ªä¸ªå®¹å™¨ï¼Œè€Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸ºæ–‡ä»¶ç³»ç»Ÿæ¥è‡ªäºå®¹å™¨é•œåƒï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½å…±äº«ç£ç›˜ã€‚æœ‰æ—¶å€™å¯èƒ½å­˜åœ¨è¿™æ ·ä¸€ç§éœ€æ±‚ï¼špod ä¸­æŸä¸ªå®¹å™¨å­˜å‚¨çš„æ•°æ®éœ€è¦æŒä¹…åŒ–ï¼Œä½†æ˜¯å› ä¸ºå®¹å™¨å­˜åœ¨æŒ‚æ‰çš„å¯èƒ½ï¼Œå¦‚æœæŒ‚æ‰åä¼šæ–°åˆ›å»ºä¸€ä¸ª pod æ¥é¡¶æ›¿ï¼Œä½†æ˜¯å› ä¸º pod å› ä¸ºæ— æ³•å…±äº«ç£ç›˜ï¼Œå¯¼è‡´æ— æ³•ç»§æ‰¿å…ˆå‰ pod é‡Œå­˜å‚¨çš„æ•°æ®ï¼Œå…ˆå‰çš„é‚£éƒ¨åˆ†æ•°æ®å°±æ°¸ä¹…ä¸¢å¤±äº†ã€‚","title":"k8s å·"},{"contents":" æ¥æºï¼šhttps://chinese.freecodecamp.org/news/how-make-a-windows-10-usb-using-your-mac-build-a-bootable-iso-from-your-macs-terminal/\nå‡†å¤‡ windows iso æ–‡ä»¶ ä¸€ä¸ªå¤§å°è‡³å°‘ 8G çš„ U ç›˜ mac ä¸Šå®‰è£…å¥½ homebrew æ­¥éª¤ 1 æŸ¥çœ‹ U ç›˜çš„åç§°ï¼š\n$ diskutil list è¯¥å‘½ä»¤ä¼šåˆ—å‡ºç”µè„‘ä¸Šæ‰€æœ‰çš„ç£ç›˜è®¾å¤‡ï¼Œå¯ä»¥é€šè¿‡å¤§å°æ¥ç¡®è®¤å“ªä¸ªæ˜¯ä½ æ’å…¥çš„ U ç›˜ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯ï¼š\n/dev/disk8 (external, physical): #: TYPE NAME SIZE IDENTIFIER 0: FDisk_partition_scheme *31.0 GB disk8 1: Windows_NTFS WINDOWS10 31.0 GB disk8s1 é‚£ä¹ˆ disk8 å°±æ˜¯æˆ‘çš„ U ç›˜çš„åç§°äº†ã€‚\næ­¥éª¤ 2 æ ¼å¼åŒ– U ç›˜ï¼š\n$ diskutil eraseDisk FAT32 \u0026quot;WINDOWS10\u0026quot; MBR disk8 è¿™é‡Œçš„ disk8 è¦æ›¿æ¢æˆä½ çš„ u ç›˜åç§°ï¼Œ\u0026ldquo;WINDOWS10\u0026rdquo; æ˜¯æ ¼å¼åŒ–åå¯¹ç¡¬ç›˜çš„é‡å‘½åï¼Œå¯ä»¥æŒ‡å®šä¸ºä»»æ„å€¼ã€‚\nStarted erase on disk8 Unmounting disk Creating the partition map Waiting for partitions to activate Formatting disk8s1 as MS-DOS (FAT32) with name WINDOWS10 512 bytes per physical sector /dev/rdisk8s1: 60507232 sectors in 1890851 FAT32 clusters (16384 bytes/cluster) bps=512 spc=32 res=32 nft=2 mid=0xf8 spt=32 hds=255 hid=2048 drv=0x80 bsec=60536832 bspf=14773 rdcl=2 infs=1 bkbs=6 Mounting disk Finished erase on disk8 æç¤ºä»¥ä¸Šä¿¡æ¯è¯´æ˜æ ¼å¼åŒ–æˆåŠŸã€‚\næ­¥éª¤ 3 æŒ‚è½½ windows iso æ–‡ä»¶ï¼š\n$ hdiutil mount /Volumes/c/Win10_2004_Chinese\\(Simplified\\)_x64.iso hdiutil: mount failed - èµ„æºæš‚æ—¶ä¸å¯ç”¨ mout åé¢æ˜¯ä½ çš„ iso æ‰€åœ¨è·¯å¾„\nä¹Ÿå¯ä»¥åŒå‡» iso æ–‡ä»¶æ¥è¿›è¡ŒæŒ‚è½½ï¼Œå› ä¸ºæˆ‘ä¹‹å‰å·²ç»åŒå‡»æŒ‚è½½è¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œæç¤ºâ€œèµ„æºæš‚æ—¶ä¸å¯ç”¨â€\næŒ‚è½½å®Œæˆåï¼Œfinder çš„ä½ç½®ä¼šæ˜¾ç¤ºä¸€ä¸ªåä¸º CCCOMA_X64FRE_ZH-CN_DV9 çš„æ–‡ä»¶ï¼ˆä¹Ÿå¯èƒ½æ˜¯ CCCOMA_X64FRE_EN-US_DV9 ï¼Œå–å†³äº iso æ–‡ä»¶ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ /Volumes ç›®å½•ä¸‹æ‰¾åˆ°ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯ /Volumes/CCCOMA_X64FRE_ZH-CN_DV9ï¼ˆå¯ä»¥é€šè¿‡ ls /Volumes æŸ¥çœ‹ï¼‰ï¼Œè¿™ä¸ªè·¯å¾„åé¢ä¼šç”¨åˆ°\næ­¥éª¤ 4 å¤åˆ¶æ–‡ä»¶åˆ° u ç›˜ï¼ŒWindows 10 ISO ä¸­çš„ä¸€ä¸ªæ–‡ä»¶ install.wim ç°åœ¨å¤ªå¤§è€Œæ— æ³•å¤åˆ¶åˆ° FAT-32 æ ¼å¼çš„ USB é©±åŠ¨å™¨ï¼Œéœ€è¦å•ç‹¬å¤åˆ¶å®ƒã€‚\né¦–å…ˆè¿è¡Œæ­¤å‘½ä»¤ä»¥å¤åˆ¶é™¤è¯¥æ–‡ä»¶ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹ï¼š\n$ rsync -vha --exclude=sources/install.wim /Volumes/CCCOMA_X64FRE_ZH-CN_DV9/* /Volumes/WINDOWS10 ï¼ˆè¿™é‡Œå°† /Volumes/CCCOMA_X64FRE_ZH-CN_DV9/ æ›¿æ¢ä¸ºä½ çš„ç›®å½•ï¼Œå‚è€ƒæ­¥éª¤ 3ï¼Œ/Volumes/WINDOWS10 æ›¿æ¢ä¸ºä½ çš„ u ç›˜åï¼Œå‚è€ƒæ­¥éª¤ 2ï¼‰\nç„¶åç»§ç»­åˆ›å»ºä½ è¦å°†æ–‡ä»¶å†™å…¥çš„ç›®å½•ï¼š\n$ mkdir /Volumes/WINDOWS10/sources å¦‚æœæç¤º File exists è¯´æ˜è¯¥æ–‡ä»¶å¤¹å·²å­˜åœ¨ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚\nä½¿ç”¨ Homebrew ä½¿ç”¨æ­¤ç»ˆç«¯å‘½ä»¤å®‰è£…åä¸º wimlib çš„å·¥å…·ï¼Œè¯¥å·¥å…·ç”¨äºåˆ†å‰² install.wim ä¸º 2 ä¸ªå°äº 4G çš„æ–‡ä»¶ï¼Œ\n$ brew install wimlib ç„¶åè¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼š\n$ wimlib-imagex split /Volumes/CCCOMA_X64FRE_EN-US_DV9/sources/install.wim /Volumes/WIN10/sources/install.swm 3800 åŒæ ·çš„ï¼Œéœ€è¦å°† /Volumes/CCCOMA_X64FRE_EN-US_DV9/ è¿™éƒ¨åˆ†æ›¿æ¢ä¸ºä½ çš„è·¯å¾„ï¼Œä»¥åŠ /Volumes/WIN10/ è¿™éƒ¨åˆ†ã€‚ä¹‹åéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œç›´åˆ°æç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š\nSplitting WIM: 4193 MiB of 4193 MiB (100%) written, part 2 of 2 Finished splitting \u0026quot;/Volumes/CCCOMA_X64FRE_ZH-CN_DV9/sources/install.wim\u0026quot; # åˆ¶ä½œå®Œæˆ æ­¥éª¤ 5 è‡³æ­¤å¯åŠ¨ç›˜å·²ç»åˆ¶ä½œå®Œæˆï¼Œå¼¹å‡º u ç›˜ï¼Œæ’å…¥åˆ°è¦å®‰è£… windows çš„ç”µè„‘ï¼Œå¹¶ä½¿ç”¨ u ç›˜å¯åŠ¨ä¾¿å¯ä»¥çœ‹åˆ° windows çš„å®‰è£…ç•Œé¢äº†ã€‚\næ€»ç»“ åœ¨ mac ä¸Šåˆ¶ä½œ windows å¯åŠ¨ç›˜è¿˜æ˜¯æœ‰ç‚¹å°éº»çƒ¦çš„ï¼Œä¸åƒ windows ä¸Šç›´æ¥ä½¿ç”¨è½¯ç¢Ÿé€šé‚£ä¹ˆç®€å•æ–¹ä¾¿ï¼Œç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘æ•™ç¨‹æ˜¯è¿‡æ—¶é”™è¯¯çš„ï¼Œæ¯”å¦‚ä½¿ç”¨ balenaEtcher ï¼Œè¿™ä¸ªè½¯ä»¶è‡ªå·±éƒ½ä¼šå¼¹å‡ºè­¦å‘Šï¼Œæ— æ³•åˆ»å½• windowsï¼Œè¿˜æœ‰ä½¿ç”¨å‘½ä»¤è¡Œçš„ï¼Œè¦å°† u ç›˜æ ¼å¼åŒ–ä¸º MS-DOS æ ¼å¼ï¼Œå› ä¸º MS-DOS æ ¼å¼æ— æ³•ä¸€æ¬¡å†™å…¥ 4G ä»¥ä¸Šçš„æ–‡ä»¶ï¼Œä¼šæç¤º File too large é”™è¯¯ï¼Œå¦‚æœæ ¼å¼åŒ–ä¸º ExFATï¼Œè™½ç„¶å¯ä»¥æˆåŠŸå†™å…¥ï¼Œä½†æ˜¯ bios æ— æ³•è¯†åˆ«å‡º U ç›˜ã€‚å…¶å®æœ¬æ–‡ä½¿ç”¨çš„æ–¹æ³•ä¹Ÿæ˜¯å‘½ä»¤è¡Œï¼Œåªæ˜¯å¯¹ 4G æ–‡ä»¶è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œæ€»çš„æ¥çœ‹è¿™ä¸ªæ–¹æ³•ç®€å•æœ‰æ•ˆï¼Œæ„Ÿè°¢è¿™ä½å¤§ä½¬çš„æ•™ç¨‹ã€‚\n","date":"2022å¹´05æœˆ17æ—¥","permalink":"/posts/mac-shang-zhi-zuo-windows/","summary":"æ¥æºï¼šhttps://chinese.freecodecamp.org/news/how-make-a-windows-10-usb-using-your-mac-build-a-bootable-iso-from-your-macs-terminal/\nå‡†å¤‡ windows iso æ–‡ä»¶ ä¸€ä¸ªå¤§å°è‡³å°‘ 8G çš„ U ç›˜ mac ä¸Šå®‰è£…å¥½ homebrew æ­¥éª¤ 1 æŸ¥çœ‹ U ç›˜çš„åç§°ï¼š","title":"åœ¨ mac ä¸Šåˆ¶ä½œ windows10 å¯åŠ¨ç›˜ï¼Œäº²æµ‹å¯ç”¨"},{"contents":" å‚è€ƒï¼š\nhttps://www.zsythink.net/archives/category/%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3/iptables/page/2\nè§„åˆ™ç›¸å…³å‘½ä»¤ æŸ¥çœ‹è§„åˆ™ # æŸ¥çœ‹ filter è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œ-t åé¢è·Ÿè¡¨å $ iptables -t filter -L # æŸ¥çœ‹ raw è¡¨çš„æ‰€æœ‰è§„åˆ™ $ iptables -t raw -L # æŸ¥çœ‹ filter è¡¨ï¼ˆ-t ç¼ºçœæ—¶ï¼Œé»˜è®¤ä¸º filter è¡¨ï¼‰çš„ INPUT é“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™ $ iptables -L INPUT # åŠ  -v å¯ä»¥è¾“å‡ºæ›´è¯¦ç»†çš„ä¿¡æ¯ $ iptables -vL INPUT # åŠ  -n ä¼šç›´æ¥è¾“å‡º IP åœ°å€ï¼Œä¸åŠ çš„è¯ä¼šç»§ç»­è½¬æ¢ï¼Œæ¯”å¦‚ 0.0.0.0 ä¼šè½¬æ¢ä¸º anywhere $ iptables -nL INPUT # ä¸ºè¾“å‡ºçš„è§„åˆ™åˆ—è¡¨æ·»åŠ åºå· $ iptables --line -L INPUT æ“ä½œè§„åˆ™ æ¸…ç©ºè§„åˆ™ # æ¸…ç©º filter è¡¨ INPUT é“¾ä¸­çš„è§„åˆ™ $ iptables -F INPUT æ·»åŠ è§„åˆ™ $ iptables -t filter -I INPUT -s 192.168.64.1 -j DROP ä¸Šé¢çš„å‘½ä»¤è¡¨ç¤ºï¼šåœ¨ filter è¡¨çš„ INPUT é“¾ä¸­æ·»åŠ ä¸€æ¡è§„åˆ™ï¼šä¸¢å¼ƒï¼ˆDROPï¼‰æºåœ°å€ä¸º 192.168.64.1 çš„æŠ¥æ–‡\næ¯ä¸ªå‚æ•°çš„æ„æ€ï¼š\n-tï¼šæŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œæ­¤å¤„æŒ‡å®šäº†æ“ä½œ filter è¡¨ï¼Œä¸ä½¿ç”¨ -t é€‰é¡¹æŒ‡å®šè¡¨æ—¶ï¼Œé»˜è®¤ä¸ºæ“ä½œ filter è¡¨\n-Iï¼šæŒ‡æ˜å°† â€è§„åˆ™â€ æ’å…¥è‡³å“ªä¸ªé“¾ä¸­ï¼Œå³æ·»åŠ è§„åˆ™\n-sï¼šæŒ‡æ˜â€œåŒ¹é…æ¡ä»¶â€ä¸­çš„â€æºåœ°å€â€ï¼Œå¦‚æœæŠ¥æ–‡çš„æºåœ°å€å±äº-så¯¹åº”çš„åœ°å€ï¼Œé‚£ä¹ˆæŠ¥æ–‡åˆ™æ»¡è¶³åŒ¹é…æ¡ä»¶\n-jï¼šæŒ‡æ˜å½“â€åŒ¹é…æ¡ä»¶â€è¢«æ»¡è¶³æ—¶ï¼Œæ‰€å¯¹åº”çš„åŠ¨ä½œ\næµ‹è¯•ï¼š\nä¸Šé¢æ·»åŠ çš„ 192.168.64.1æ˜¯æˆ‘çš„å®¿ä¸»æœº ipï¼Œç°åœ¨ç”¨å®¿ä¸»æœºæ¥è®¿é—®ä¸€ä¸‹è¿™å°è®¾ç½®äº†è§„åˆ™çš„è™šæ‹Ÿæœºï¼š\n$ ping 192.168.64.5 # ping è™šæ‹Ÿæœº PING 192.168.64.5 (192.168.64.5): 56 data bytes Request timeout for icmp_seq 0 Request timeout for icmp_seq 1 Request timeout for icmp_seq 2 å‘ç°å·²ç»æ— æ³•è®¿é—®äº†ã€‚ï¼ˆä¹‹åå‘ç° ssh ç»™æ–­äº†ï¼Œè™šæ‹Ÿæœºä¹Ÿè¿›ä¸å»äº†ï¼Œç”¨çš„æ˜¯ multipassğŸ˜…ï¼‰\næ·»åŠ è§„åˆ™çš„åŒæ—¶å¯ä»¥æŒ‡å®šå…¶æ’å…¥çš„ä½ç½®ï¼Œä¸åŒçš„ä½ç½®ä¼šå½±å“è§„åˆ™çš„æ‰§è¡Œã€‚å…·ä½“çš„ä¾‹å­å¯ä»¥å‚è€ƒ https://www.zsythink.net/archives/1517ï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼šå·²ç»è®¾ç½®äº†ä¸€æ¡ drop è§„åˆ™ï¼Œå¦‚æœè¿½åŠ ä¸€æ¡ç›¸åŒ ipï¼Œä½†æ˜¯ accept çš„è§„åˆ™ï¼Œå‘ç°ä¾ç„¶æ— æ³• ping é€šï¼Œå› ä¸º drop åœ¨å‰ accept åœ¨åï¼›ä½†æ˜¯å¦‚æœå°† accept æ’å…¥åˆ°å¤´éƒ¨ï¼Œé‚£ä¹ˆ INPUT é“¾ä¼šå…ˆæ‰§è¡Œ accept è§„åˆ™ï¼Œæ•°æ®åŒ…å°±ä¼šè¢«æ”¾è¡Œï¼Œå› ä¸ºæŠ¥æ–‡å·²ç»è¢«æ”¾è¡Œäº†ï¼Œæ‰€ä»¥ï¼Œå³ä½¿ç¬¬äºŒæ¡ drop è§„åˆ™èƒ½å¤ŸåŒ¹é…åˆ°åˆšæ‰â€æ”¾è¡Œâ€çš„æŠ¥æ–‡ï¼Œä¹Ÿæ²¡æœ‰æœºä¼šå†å¯¹åˆšæ‰çš„æŠ¥æ–‡è¿›è¡Œä¸¢å¼ƒæ“ä½œäº†ã€‚\n# -A è¿½åŠ ä¸€æ¡è§„åˆ™ï¼ˆappendï¼‰ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ åˆ°æœ«å°¾ $ iptables -A INPUT -s 192.168.64.1 -j ACCEPT # -I æ·»åŠ åˆ°å¤´éƒ¨ $ iptables -I INPUT -s 192.168.64.1 -j ACCEPT # æ’å…¥åˆ°è§„åˆ™çš„ä¸‹æ ‡ 2 å¤„ $ iptables -I INPUT 2 -s 192.168.64.1 -j ACCEPT åˆ é™¤è§„åˆ™ æ ¹æ®è§„åˆ™ç¼–å·åˆ é™¤ï¼ˆæŒ‡å®š \u0026ndash;line ï¼‰\n$ iptables -t filter -D INPUT 3 ä¸Šé¢çš„å‘½ä»¤ä¼šåˆ é™¤ filter è¡¨çš„ INPUT é“¾çš„ç¬¬ 3 æ¡è§„åˆ™\næ ¹æ®åŒ¹é…æ¡ä»¶åˆ é™¤\n$ iptables -D INPUT -s 192.168.64.1 -j ACCEPT ä¸Šè¿°å‘½ä»¤è¡¨ç¤ºåˆ é™¤ INPUT é“¾ä¸­æºåœ°å€ä¸º 192.168.64.1ï¼ŒåŠ¨ä½œä¸º ACCEPT çš„è§„åˆ™\næ¸…ç©ºé“¾ä¸Šçš„è§„åˆ™\n# æ¸…ç©º filter è¡¨ INPUT é“¾ä¸­çš„è§„åˆ™ $ iptables -F INPUT æ¸…ç©ºè¡¨çš„æ‰€æœ‰è§„åˆ™\n# ä¸æŒ‡å®šé“¾å $ iptables -F è‡ªå®šä¹‰é“¾ è‡ªå®šä¹‰é“¾ç”¨äºå¯¹è§„åˆ™çš„ç®¡ç†ï¼Œè¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œiptables çš„ è¡¨ å·²ç»æ˜¯å¯¹è§„åˆ™çš„ä¸€ç§åˆ†ç±»ç®¡ç†äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è‡ªå®šä¹‰é“¾å‘¢ï¼Ÿæˆ‘æš‚æ—¶çš„ç†è§£æ˜¯ï¼Œè™½ç„¶è¡¨å·²ç»è¿›è¡Œäº†åˆ†ç±»ï¼Œä½†æ˜¯ç²’åº¦è¿˜æ˜¯æ¯”è¾ƒç²—ï¼Œæ¯”å¦‚ filter è¡¨åªæ˜¯è´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œä½†æ˜¯è¿‡æ»¤åŠŸèƒ½å¯èƒ½è¿˜éœ€è¦è¿›è¡Œè¿›ä¸€æ­¥åˆ†ç±»ï¼Œæ¯”å¦‚æœ‰é’ˆå¯¹ HTTP çš„è¿‡æ»¤è§„åˆ™ï¼Œæœ‰é’ˆå¯¹ SSH çš„è¿‡æ»¤è§„åˆ™ï¼Œ\nåˆ›å»º å®éªŒçš„ä¸¤å°æœºå™¨ IP ä¸ºï¼š192.168.1.110 å’Œ 192.168.1.103ï¼Œåœ¨ 110 ä¸Šè®¾ç½®ä¸€æ¡è‡ªå®šä¹‰é“¾ï¼Œè§„åˆ™æ˜¯é˜»æ­¢ 103 è¿™å°æœºå™¨æ¥è®¿é—® 8080 ç«¯å£ï¼Œ8080 è¿è¡Œäº†ä¸€ä¸ª web ç¨‹åºï¼Œè®¿é—®ä¼šè¿”å› â€œHelloâ€\né¦–å…ˆåˆ›å»ºä¸€æ¡åä¸º IN_WEB çš„è‡ªå®šä¹‰é“¾\n$ iptables -t filter -N IN_WEB ä¸ºè¯¥é“¾è®¾ç½®è§„åˆ™ï¼Œå¯¹ æºåœ°å€ ä¸º 192.168.1.103 çš„è¿æ¥è¿›è¡Œ REJECT ï¼ˆæ‹’ç»ï¼‰å¤„ç†\n$ iptables -t filter -I IN_WEB -s 192.168.1.103 -j REJECT æŸ¥çœ‹ filter ä¸­çš„è§„åˆ™ï¼Œä½¿ç”¨ IN_WEB è¿›è¡Œè¿‡æ»¤\n$ iptables -t filter --line -nvL IN_WEB Chain IN_WEB (0 references) num pkts bytes target prot opt in out source destination 1 0 0 REJECT all -- * * 192.168.1.103 0.0.0.0/0 reject-with icmp-port-unreachable è‡ªå®šä¹‰é“¾ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦å°†å…¶æ·»åŠ åˆ°ä¸€æ¡ é»˜è®¤é“¾ ä¸­ï¼Œ å°†è¯¥é“¾æ·»åŠ åˆ° INPUT é“¾ä¸­ï¼Œè¿™ä»£è¡¨è¯¥æ¡é“¾ç”¨äºæ¥æ”¶åˆ°æ•°æ®æ—¶\n$ iptables -I INPUT -p tcp --dport 8080 -j IN_WEB æŸ¥çœ‹\n$ iptables -t filter --line -nvL IN_WEB Chain IN_WEB (1 references) pkts bytes target prot opt in out source destination 0 0 REJECT all -- * * 192.168.1.103 0.0.0.0/0 reject-with icmp-port-unreachable æ­¤æ—¶ä½¿ç”¨ 103 çš„æœºå™¨è®¿é—® 110 çš„ 8080 ç«¯å£ï¼š\n$ curl 192.168.1.110:8080 curl: (7) Failed to connect to 192.168.1.110 port 8080 after 37 ms: Connection refused æŠ¥é”™ â€œConnection refusedâ€ï¼ˆè¿æ¥è¢«æ‹’ç»ï¼‰ï¼Œè¿™ä¸ªé”™è¯¯è§å¾—ä¹Ÿæ¯”è¾ƒå¤šäº†ï¼Œå½“è®¿é—®çš„ç«¯å£æ²¡æœ‰è¢«ç¨‹åºç›‘å¬æ—¶ï¼Œä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚æ­¤æ—¶è¯´æ˜æ‹¦æˆªè§„åˆ™å·²ç»æˆåŠŸã€‚\n110 çš„ 9090 ç«¯å£ä¸Šä¹Ÿè¿è¡Œäº†ä¸€ä¸ª web ç¨‹åºï¼Œè®¿é—®ä¸€ä¸‹çœ‹çœ‹æ˜¯ä¸æ˜¯åªæ‹¦æˆªäº† 8080 ç«¯å£ï¼š\n$ curl 192.168.1.110:9090 Hello% 9090 å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œè¯´æ˜æ‹¦æˆªè§„åˆ™æˆåŠŸã€‚\nåˆ é™¤ åˆ é™¤è‡ªå®šä¹‰é“¾éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶\n1ã€è‡ªå®šä¹‰é“¾æ²¡æœ‰è¢«å¼•ç”¨\n2ã€è‡ªå®šä¹‰é“¾ä¸­æ²¡æœ‰ä»»ä½•è§„åˆ™\nè‡ªå®šä¹‰é“¾è¢«æ”¾ç½®åœ¨ INPUT ä¸Šï¼Œé¦–å…ˆæŸ¥çœ‹ INPUT çš„æ‰€æœ‰è§„åˆ™ï¼Œå¹¶åˆ é™¤å±äºè‡ªå®šä¹‰é“¾çš„è§„åˆ™\n$ iptables -nvL INPUT # æŸ¥çœ‹ INPUT é“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™ Chain INPUT (policy ACCEPT 4397 packets, 972K bytes) pkts bytes target prot opt in out source destination 0 0 IN_WEB tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 7753 1508K KUBE-ROUTER-INPUT all -- * * 0.0.0.0/0 0.0.0.0/0 /* kube-router netpol - 4IA2OSFRMVNDXBVV */ 0 0 IN_WEB tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 1 64 IN_WEB tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:5555 $ iptables -D INPUT 7 # åˆ é™¤è§„åˆ™ï¼Œæ•°å­—æ˜¯ä¸Šé¢åˆ—è¡¨çš„åºå·ï¼Œæ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µæ¥æŒ‡å®š $ iptables --line-number -vL INPUT # ä½¿ç”¨ --line-numbers å¯ä»¥æ˜¾ç¤ºè§„åˆ™çš„ç¼–å·ï¼Œè¿™æ ·åˆ é™¤èµ·æ¥æ›´æ–¹ä¾¿ Chain INPUT (policy ACCEPT 2702 packets, 895K bytes) num pkts bytes target prot opt in out source destination 1 5865 1470K KUBE-ROUTER-INPUT all -- any any anywhere anywhere /* kube-router netpol - 4IA2OSFRMVNDXBVV */ 2 2702 895K KUBE-FIREWALL all -- any any anywhere anywhere 3 2702 895K KUBE-NODEPORTS all -- any any anywhere anywhere /* kubernetes health check service ports */ 4 0 0 KUBE-EXTERNAL-SERVICES all -- any any anywhere anywhere ctstate NEW /* kubernetes externally-visible service portals */ $ iptables -F IN_WEB # æ¸…ç©º filter è¡¨ä¸Šçš„ IN_WEB é“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™ï¼ˆä¸æŒ‡å®š -t æ—¶é»˜è®¤ä¸º filter è¡¨ï¼‰ $ iptables -X IN_WEB # åˆ é™¤é“¾ $ iptables -t filter --line -nvL IN_WEB # å†æ¬¡æŸ¥çœ‹è¯¥é“¾ï¼Œå‘ç°å·²ç»æ— æ³•è¾“å‡ºä¿¡æ¯äº†ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸ iptables v1.8.7 (nf_tables): chain `IN_WEB' in table `filter' is incompatible, use 'nft' tool. è´Ÿè½½å‡è¡¡ https://vflong.github.io/sre/network/2020/02/23/turning-iptables-into-a-tcp-load-balancer.html\nå®è·µ DNT è½¬å‘ æµç¨‹ï¼šæœ‰ä¸¤å°æœºå™¨ 192.168.64.4 ï¼ˆç®€ç§° 4ï¼‰å’Œ 192.168.64.1ï¼ˆç®€ç§° 1ï¼‰ï¼Œ4 ä¸Šçš„ 8080 å’Œ 9090 ç«¯å£è¿è¡Œäº†ä¸¤ä¸ª tcp ç¨‹åºï¼Œè¿æ¥åˆ° 8080 æ—¶ä¼šè¿”å›æ¶ˆæ¯ï¼š â€8080â€œï¼Œè¿æ¥åˆ° 9090 æ—¶ä¼šè¿”å›æ¶ˆæ¯ â€9090â€œï¼Œè¿™é‡Œé€šè¿‡ iptables è®¾ç½® nat è½¬å‘ï¼Œå°†è®¿é—® 8080 çš„è¿æ¥è½¬å‘åˆ° 9090ï¼Œä¹Ÿå°±æ˜¯ DNATï¼ˆD ä»£è¡¨ dstï¼Œç›®æ ‡ï¼‰ï¼Œä¿®æ”¹æŠ¥æ–‡çš„ç›®æ ‡åœ°å€ã€‚\næ·»åŠ è§„åˆ™ï¼š\n$ iptables -t nat -A PREROUTING -p tcp -d 192.168.64.4 --dport 8080 -j DNAT --to 192.168.64.4:9090 åœ¨ nat è¡¨çš„ PREROUTING é“¾ä¸­æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œå°†ç›®æ ‡åœ°å€ä¸º 192.168.64.4ï¼Œåè®®ä¸º tcp çš„è¯·æ±‚è½¬å‘ï¼ˆDNATï¼‰åˆ° 192.168.64.4 ï¼ˆæœ¬æœºï¼‰çš„ 9090 ç«¯å£\næŸ¥çœ‹è§„åˆ™ï¼š\n$ iptables -t nat -nL PREROUTING DNAT tcp -- 0.0.0.0/0 192.168.64.4 tcp dpt:8080 to:192.168.64.4:9090 åœ¨ 1 ä¸Šæ‰§è¡Œ ncï¼š\n$ nc 192.168.64.4 8080 9090 è®¿é—®çš„æ˜¯ 8080 ç«¯å£ï¼Œè¿”å›çš„æ¶ˆæ¯æ˜¯ 9090ï¼Œè¯´æ˜è½¬å‘æˆåŠŸã€‚\nè¿™ä¸¤ä¸ªç¨‹åºè¿˜ä¼šè®°å½•è®¿é—®çš„ IP åœ°å€ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š\n$ cat 8080 $ cat 9090 2022/05/19 15:41:44 192.168.64.1:63310 8080 çš„æ—¥å¿—ä¸ºç©ºï¼Œè¯´æ˜è¯¥è¯·æ±‚è¢« iptables æ‹¦æˆª åè½¬å‘ç»™äº† 9090\né™„ä»£ç ï¼š\npackage main import ( \u0026quot;net\u0026quot; \u0026quot;log\u0026quot; ) func main() { l, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;:8080\u0026quot;) assert(err) for { conn, err := l.Accept() assert(err) log.Println(conn.RemoteAddr()) conn.Write([]byte(\u0026quot;8080\u0026quot;)) } } func assert(err error) { if err != nil { panic(err) } } package main import ( \u0026quot;net\u0026quot; \u0026quot;log\u0026quot; ) func main() { l, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;:9090\u0026quot;) assert(err) for { conn, err := l.Accept() assert(err) log.Println(conn.RemoteAddr()) conn.Write([]byte(\u0026quot;9090\u0026quot;)) } } func assert(err error) { if err != nil { panic(err) } } ä½¿ç”¨ nohup éƒ¨ç½²ï¼š\n$ go build tcp_8080.go $ go build tcp_9090.go $ nohup ./tcp_8080 \u0026gt; 8080 \u0026amp; $ nohup ./tcp_9090 \u0026gt; 9090 \u0026amp; ","date":"2022å¹´05æœˆ16æ—¥","permalink":"/posts/iptables/","summary":"å‚è€ƒï¼š\nhttps://www.zsythink.net/archives/category/%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3/iptables/page/2\nè§„åˆ™ç›¸å…³å‘½ä»¤ æŸ¥çœ‹è§„åˆ™ # æŸ¥çœ‹ filter è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œ-t åé¢è·Ÿè¡¨å $ iptables -t filter -L # æŸ¥çœ‹ raw è¡¨çš„æ‰€æœ‰è§„åˆ™ $ iptables -t raw -L # æŸ¥çœ‹ filter è¡¨ï¼ˆ-t ç¼ºçœæ—¶ï¼Œé»˜è®¤ä¸º filter è¡¨ï¼‰çš„ INPUT é“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™ $ iptables -L INPUT # åŠ  -v å¯ä»¥è¾“å‡ºæ›´è¯¦ç»†çš„ä¿¡æ¯ $ iptables -vL INPUT # åŠ  -n ä¼šç›´æ¥è¾“å‡º IP åœ°å€ï¼Œä¸åŠ çš„è¯ä¼šç»§ç»­è½¬æ¢ï¼Œæ¯”å¦‚ 0.","title":"linux iptables"},{"contents":"deplopyment ç”¨äº pod çš„æ›´æ–°ç›¸å…³æ“ä½œã€‚\nå¦‚ä½•æ›´æ–° pod æ›´æ–°æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼šå½“å‰ pod è¿è¡Œçš„æ˜¯æŸä¸ª v1 ç‰ˆæœ¬çš„é•œåƒï¼Œä¸€ä¸ªæœˆåè¯¥é•œåƒå‘å¸ƒäº† v2 ç‰ˆæœ¬ï¼Œæ­¤æ—¶æƒ³å°†æ‰€æœ‰çš„ pod æ›´æ–°åˆ° v2 ç‰ˆæœ¬ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\næ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\nå…ˆåˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ podï¼Œå†åˆ›å»ºæ–°ç‰ˆæœ¬çš„ pod å®è·µå¦‚ä¸‹ï¼š\napiVersion: v1 kind: ReplicationController metadata: name: kubia-v1 spec: replicas: 3 template: metadata: name: kubia labels: app: kubia spec: containers: - image: luksa/kubia:v1 name: nodejs --- apiVersion: v1 kind: Service metadata: name: kubia spec: selector: app: kubia ports: - port: 80 targetPort: 8080 åˆ›å»ºä¸€ä¸ªåŸºäº luksa/kubia:v1 çš„é•œåƒçš„ podï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ª service\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-v1-td826 1/1 Running 0 4m16s kubia-v1-k8hz4 1/1 Running 0 4m16s kubia-v1-7kpmg 1/1 Running 0 4m16s $ kubectl get rc NAME DESIRED CURRENT READY AGE kubia-v1 3 3 3 5m $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 37h kubia ClusterIP 10.43.191.168 \u0026lt;none\u0026gt; 80/TCP 5m3s $ curl kubia This is v1 running in pod kubia-v1-7kpmg\tæµ‹è¯•è®¿é—®ï¼Œè¾“å‡ºè¡¨ç¤ºå½“å‰è¿è¡Œçš„æ˜¯ v1 ç‰ˆæœ¬\nç°åœ¨æ¥è¿›è¡Œå‡çº§æ“ä½œï¼Œå°† luksa/kubia:v1 å‡çº§ä¸º luksa/kubia:v2ã€‚\nä¿®æ”¹ yamlï¼š\nspec: containers: - image: luksa/kubia:v2 æ‰§è¡Œ yamlï¼š\n$ kubectl apply -f kubia-rc-and-service-v1.yaml replicationcontroller/kubia-v1 configured service/kubia unchanged $ curl 10.43.191.168 This is v1 running in pod kubia-v1-7kpmg å‘ç°è¾“å‡ºçš„è¿˜æ˜¯ v1ï¼Œå¯èƒ½æ˜¯å› ä¸º rc å·²ç»æœ‰ 3 ä¸ª pod äº†ï¼Œä¿®æ”¹ image ä¸ä¼šä»¤å…¶åˆ é™¤æ—§çš„å¹¶åˆ›å»ºæ–°çš„ï¼Œé‚£å°±åªå¥½æ‰‹åŠ¨åˆ é™¤æ—§ pod äº†ï¼š\n$ kubectl delete po -l app=kubia pod \u0026quot;kubia-v1-td826\u0026quot; deleted pod \u0026quot;kubia-v1-k8hz4\u0026quot; deleted pod \u0026quot;kubia-v1-7kpmg\u0026quot; deleted æ­¤æ—¶åˆ é™¤äº†æ‰€æœ‰ app=kubia çš„ podï¼ˆåœ¨æˆ‘çš„æœºå™¨ä¸Šæµ‹è¯•æ—¶ï¼Œè¿™ä¸ªåˆ é™¤æ“ä½œé˜»å¡äº†å°†è¿‘ 10sï¼‰ï¼Œrc æ£€æµ‹åˆ°å…¶ç®¡ç†çš„ pod æ•°é‡ä¸è¶³æ‰€éœ€çš„æ•°é‡ 3ï¼Œé‚£ä¹ˆå°±ä¼šæ–°åˆ›å»º 3 ä¸ª podï¼Œå› ä¸ºä¹‹å‰æ”¹æ‰äº†åˆ›å»º template ä¸­çš„é•œåƒä¸º v2ï¼Œæ‰€ä»¥ç°åœ¨ rc åˆ›å»ºå‡ºæ¥çš„éƒ½æ˜¯æ–°ç‰ˆæœ¬çš„ pod äº†ï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-v1-b5lkr 1/1 Running 0 37s kubia-v1-tq7nh 1/1 Running 0 37s kubia-v1-w6r6t 1/1 Running 0 37s $ curl 10.43.191.168 This is v2 running in pod kubia-v1-w6r6t ç»è¿‡ä¸Šé¢çš„ä¸€ç³»åˆ—æ“ä½œï¼Œç»ˆäºå®Œæˆäº† pod çš„å‡çº§ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼šåˆ é™¤ pod ååˆ° rc åˆ›å»ºå®Œæˆè¿™æ®µæ—¶é—´ï¼Œæ˜¯æ²¡æœ‰ pod èƒ½å¤Ÿæä¾›æœåŠ¡çš„ï¼Œè¿™å°±ä¼šå¯¼è‡´ç¨‹åºåœ¨ä¸€æ®µæ—¶é—´å†…ä¸å¯ç”¨ï¼Œè¿™å¯¹äºä¸€äº›åº”ç”¨æ˜¯æ— æ³•æ¥æ”¶çš„ã€‚\nå…ˆåˆ›å»ºæ–°ç‰ˆæœ¬çš„ podï¼Œå†åˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ pod å…ˆå°†é•œåƒé€€å›è‡³ v1 ç‰ˆæœ¬ï¼Œé‡‡ç”¨å’Œä¸Šé¢ç›¸åŒçš„æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸è´´å…·ä½“æ“ä½œäº†ã€‚\nå¤åˆ¶ä¸€ä»½ä¹‹å‰çš„ yamlï¼Œåœ¨è¯¥åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼š\n$ cp kubia-rc-and-service-v1.yaml kubia-rc-and-service-v2.yaml ä¿®æ”¹ä¸ºï¼š\napiVersion: v1 kind: ReplicationController metadata: name: kubia-v2 # ä¿®æ”¹ spec: replicas: 3 template: metadata: name: kubia labels: app: kubia-v2 # ä¿®æ”¹ spec: containers: - image: luksa/kubia:v2 # ä¿®æ”¹ name: nodejs --- apiVersion: v1 kind: Service metadata: name: kubia spec: selector: app: kubia-v2 # ä¿®æ”¹ ports: - port: 80 targetPort: 8080 ä¿®æ”¹ä¹‹å¤„å·²ç»æ ‡å‡ºï¼Œæ³¨æ„è¿™é‡Œè¿˜æ›´æ–°äº† service çš„é€‰æ‹©å™¨ï¼Œè®©å…¶ä¸º app=kubia-v2 çš„ pod æä¾›å¯¹å¤–æœåŠ¡ã€‚\n$ kubectl apply -f kubia-rc-and-service-v2.yaml replicationcontroller/kubia-v2 created service/kubia configured $ kubectl get rs No resources found in default namespace. $ kubectl get rc NAME DESIRED CURRENT READY AGE kubia-v1 3 3 3 68m kubia-v2 3 3 3 18s $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-v1-7pxtm 1/1 Running 0 11m kubia-v1-zt5pg 1/1 Running 0 11m kubia-v1-gnssp 1/1 Running 0 11m kubia-v2-46w9g 1/1 Running 0 20s kubia-v2-66wqr 1/1 Running 0 20s kubia-v2-bvjqc 1/1 Running 0 20s æ­¤æ—¶è®¿é—® serviceï¼š\n$ curl 10.43.191.168 This is v2 running in pod kubia-v2-dj8cf å‘ç°å·²ç»åˆ‡æ¢åˆ°äº† v2\nåç»­å†åˆ é™¤ v1 çš„ podï¼š\n$ kubectl get rc NAME DESIRED CURRENT READY AGE kubia-v1 3 3 3 76m kubia-v2 3 3 3 98s $ kubectl delete rc kubia-v1 replicationcontroller \u0026quot;kubia-v1\u0026quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-v2-dj8cf 1/1 Running 0 2m9s kubia-v2-4q5tv 1/1 Running 0 2m9s kubia-v2-rbbfd 1/1 Running 0 2m9s kubia-v1-gnssp 1/1 Terminating 0 19m kubia-v1-7pxtm 1/1 Terminating 0 19m kubia-v1-zt5pg 1/1 Terminating 0 19m ç­‰å¾…ä¸€ä¼šï¼Œè¿™äº› Terminating çŠ¶æ€çš„ pod å°±ä¼šæ¶ˆå¤±äº†ã€‚\nä½¿ç”¨è¿™ç§æ–¹å¼å¯ä»¥åšåˆ°ä¸åœæœºæ›´æ–°ï¼Œä½†æ˜¯éœ€è¦æ›´å¤šçš„ç¡¬ä»¶èµ„æºï¼Œå› ä¸ºåœ¨çŸ­æ—¶é—´å†…ä¼šåŒæ—¶è¿è¡Œ 2 å€çš„ podã€‚\näº¤æ›¿æ‰§è¡Œï¼Œåˆ ä¸€ä¸ªæ—§çš„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ è¿™ç§æ–¹å¼æ¯”è¾ƒç¹çï¼Œå°±ä¸æ¼”ç¤ºäº†ï¼Œå¤§è‡´çš„æ€è·¯æ˜¯ï¼šå’Œ å…ˆåˆ›å»ºæ–°ç‰ˆæœ¬çš„ podï¼Œå†åˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ pod ä¸­çš„åšæ³•ä¸€æ ·ï¼Œå†åˆ›å»ºä¸€ä¸ªç”¨äºç®¡ç† v2 çš„ rcï¼ˆè¿™é‡Œç§°ä¸º rc-v2ï¼Œä¹‹å‰çš„ç§°ä¸º rc-v1ï¼‰ï¼Œä½†æ˜¯ replicas ç½®ä¸º 0ï¼Œæ­¤æ—¶æœ‰ä¸¤ä¸ª rcï¼šrc-v1ï¼Œreplicas ä¸º 3ï¼Œrc-v2ï¼Œreplicas ä¸º 0ï¼Œç„¶åå¼€å§‹äº¤æ›¿æ‰§è¡Œï¼Œrc-v1 ç¼©å®¹ä¸º 2ï¼Œrc-v2 æ‰©å®¹åˆ° 1ï¼Œv1 ç¼©å®¹åˆ° 1ï¼Œv2 æ‰©å®¹åˆ° 2ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ¥å®Œæˆå‡çº§ã€‚\nè¿™ç§æ–¹å¼é¿å…äº†å‰é¢ä¸¤ç§åŒæ—¶åˆ›å»ºã€åŒæ—¶åˆ é™¤çš„ç¼ºç‚¹ï¼Œ ä½†æ˜¯å…¶ä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼šè¾ƒä¸ºç¹çï¼Œä¸”å®¹æ˜“å‡ºé”™ï¼Œä¸€å¥—æµç¨‹ä¸‹æ¥è¦æ•²éå¸¸å¤šçš„å‘½ä»¤ã€‚\nå¥½åœ¨å¼ºå¤§çš„ k8s æä¾›äº†æŒ‡ä»¤æ¥å®Œæˆ pod çš„æ›´æ–°æ“ä½œï¼š\n$ kubectl rolling-update kubia-v1 kubia-v2 --image=luksa/kubia:v2 âš ï¸ è¯¥å‘½ä»¤å·²ç»è¢«åˆ é™¤ ï¼šerror: unknown command \u0026ldquo;rolling-update\u0026rdquo; for \u0026ldquo;kubectl\u0026rdquo;\nhttps://stackoverflow.com/questions/65303683/why-kubectl-removed-command-rolling-update\nhttps://github.com/kubernetes/kubectl/commit/d3af7e08624bfa7c2f52714b47cfe96a52d15fc0\nå¤§è‡´åŸå› æ˜¯ï¼šè¯¥å‘½ä»¤æ˜¯åœ¨å®¢æˆ·ç«¯æ‰§è¡Œçš„ï¼Œè€Œä¸æ˜¯åœ¨ k8s å†…éƒ¨æ‰§è¡Œï¼Œç›¸æ¯”ä¹‹ä¸‹å®¢æˆ·ç«¯æ›´å®¹æ˜“é‡åˆ°ä¸€äº›ç½‘ç»œä¸­æ–­ã€ç»ˆç«¯å¼‚å¸¸é€€å‡ºç­‰é”™è¯¯ï¼Œè¿™ä¼šå¯¼è‡´ pod å’Œ rc å¤„äºä¸­é—´çŠ¶æ€\nä½¿ç”¨ deployment è¿›è¡Œæ›´æ–° ä½¿ç”¨å¦‚ä¸‹ yamlï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: kubia spec: replicas: 3 selector: matchLabels: app: kubia template: metadata: name: kubia labels: app: kubia spec: containers: - image: luksa/kubia:v1 name: nodejs åˆ›å»ºï¼š\n$ kubectl apply -f deployment.yaml --record Flag --record has been deprecated, --record will be removed in the future deployment.apps/kubia created ä¹¦ä¸Šç€é‡å¼ºè°ƒäº†ï¼šç¡®ä¿åœ¨åˆ›å»ºæ—¶ä½¿ç”¨äº† --record é€‰é¡¹ã€‚ è¿™ä¸ªé€‰é¡¹ä¼šè®°å½•å†å²ç‰ˆæœ¬å·ï¼Œ åœ¨ä¹‹åçš„æ“ä½œä¸­éå¸¸æœ‰ç”¨ã€‚ç„¶è€Œè¿™é‡Œç›´æ¥æç¤ºè¯¥é€‰é¡¹å·²è¢«åºŸå¼ƒï¼Œéš¾é“å·²ç»é»˜è®¤è®°å½•ç‰ˆæœ¬å·äº†å—ï¼Ÿ\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-5f6cdb7bf7-4pn9b 1/1 Running 0 7m26s kubia-5f6cdb7bf7-kt8gp 1/1 Running 0 7m26s kubia-5f6cdb7bf7-f6w5g 1/1 Running 0 7m26s $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 2d kubia ClusterIP 10.43.191.168 \u0026lt;none\u0026gt; 80/TCP 11h $ curl 10.43.191.168 This is v1 running in pod kubia-5f6cdb7bf7-f6w5g å¼€å§‹æ‰§è¡Œæ»šåŠ¨å‡çº§ï¼š\n$ kubectl patch deployment kubia -p '{\u0026quot;spec\u0026quot;: {\u0026quot;minReadySeconds\u0026quot;: 10}}' deployment.apps/kubia patched $ kubectl set image deployment kubia nodejs=luksa/kubia:v2 # æ›´æ–°é•œåƒ è¿™é‡Œé€šè¿‡ patch ä¸º è¿™ä¸ª deployment æ·»åŠ äº†ä¸€æ¡ minReadySeconds: 10 çš„å±æ€§ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯ï¼šæŒ‡å®šæ–°åˆ›å»ºçš„ pod è‡³å°‘è¦æˆåŠŸè¿è¡Œå¤šä¹…ä¹‹åï¼Œæ‰èƒ½å°†å…¶è§†ä¸ºå¯ç”¨ï¼Œåœ¨åé¢ä¼šè¯¦ç»†è¯´æ˜è¿™ä¸ªå±æ€§ã€‚\nä½¿ç”¨ set image å‘½ä»¤æ¥è¿›è¡Œæ›´æ–°ï¼Œå…¶ä¸­ nodejs æ˜¯ template.sepc.containers.name æŒ‡å®šçš„ã€‚ä¹‹åæ›´æ–°å°±å¼€å§‹äº†ï¼Œå¯ä»¥å¼€ä¸€ä¸ªæ–°çš„ shell è§‚å¯Ÿå‡çº§è¿‡ç¨‹ï¼š\n$ while true;do curl 10.43.191.168; sleep 0.5s;done This is v1 running in pod kubia-5f6cdb7bf7-f6w5g This is v2 running in pod kubia-88894bbd4-pbr5n This is v2 running in pod kubia-88894bbd4-h8mck This is v1 running in pod kubia-5f6cdb7bf7-f6w5g This is v1 running in pod kubia-5f6cdb7bf7-f6w5g This is v2 running in pod kubia-88894bbd4-w74nb This is v2 running in pod kubia-88894bbd4-pbr5n This is v1 running in pod kubia-5f6cdb7bf7-f6w5g This is v2 running in pod kubia-88894bbd4-h8mck This is v2 running in pod kubia-88894bbd4-h8mck This is v2 running in pod kubia-88894bbd4-w74nb This is v2 running in pod kubia-88894bbd4-h8mck This is v2 running in pod kubia-88894bbd4-h8mck This is v2 running in pod kubia-88894bbd4-w74nb This is v2 running in pod kubia-88894bbd4-pbr5n å¯ä»¥çœ‹åˆ°ï¼Œåˆšå¼€å§‹è¯·æ±‚ä¼šæ‰“åˆ° v1 æˆ–è€… v2ï¼Œåˆ°åé¢å°±å…¨éƒ¨æ˜¯ v2 äº†ï¼Œè¯´æ˜å‡çº§å·²ç»å®Œæˆï¼ŒåŒæ—¶ä¹Ÿè¯´æ˜è¯¥å‘½ä»¤ä½¿ç”¨çš„æ˜¯ æ»šåŠ¨æ›´æ–° çš„æ–¹å¼ï¼Œå…¶å®å…·ä½“ä½¿ç”¨å“ªç§æ–¹å¼æ˜¯å¯ä»¥é…ç½®çš„ï¼Œå­—æ®µæ˜¯ .spec.strategy.typeï¼Œé»˜è®¤ä¸º RollingUpdateï¼Œä¹Ÿå°±æ˜¯æ»šåŠ¨æ›´æ–°ï¼Œè¿˜æœ‰ä¸€ç§ Recreateï¼Œé‡‡ç”¨çš„æ˜¯å…ˆåˆ é™¤æ‰€æœ‰æ—§çš„ï¼Œå†åˆ›å»ºæ–° pod çš„æ–¹å¼ã€‚\nä½¿ç”¨ deployment è¿›è¡Œå›æ»š ä¸ºä»€ä¹ˆéœ€è¦å›æ»š å¯èƒ½å‘å¸ƒçš„æ–°ç‰ˆæœ¬å­˜åœ¨ä¸€äº› bugï¼Œä½†æ˜¯åœ¨æ›´æ–°ä¹‹å‰æ²¡æœ‰å‘ç°ï¼Œç­‰å‘ç°ä»¥åæ•´ä¸ªç³»ç»Ÿå·²ç»æ›´æ–°æˆæ–°ç‰ˆæœ¬äº†ï¼Œæ­¤æ—¶å°±éœ€è¦è¿›è¡Œå›æ»šæ“ä½œäº†ã€‚\nå®è·µ æ¥ç€ä¸Šé¢çš„æ“ä½œï¼Œæ­¤æ—¶æŸ¥çœ‹ rsï¼Œä¼šå‘ç°ä¹‹å‰çš„è€ rs æ²¡æœ‰è¢«åˆ é™¤ï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE kubia-88894bbd4 3 3 3 29m kubia-5f6cdb7bf7 0 0 0 87m $ kubectl describe kubia-5f6 ... Pod Template: Labels: app=kubia pod-template-hash=5f6cdb7bf7 Containers: nodejs: Image: luksa/kubia:v1 ... $ kubectl describe rs kubia-888 ... Pod Template: Labels: app=kubia pod-template-hash=88894bbd4 Containers: nodejs: Image: luksa/kubia:v2 ... ä¸ºä»€ä¹ˆè¦ä¿ç•™æ—§çš„ rs å‘¢ï¼Ÿè¿™é‡Œå…ˆå–ä¸ªå…³å­ ä¸ºçš„æ˜¯èƒ½å¤Ÿå®Œæˆå›æ»šæ“ä½œ\nå¼€å§‹å‡çº§ï¼Œè¿™é‡Œä¼šæ›´æ–°åˆ° v3 ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰é”™è¯¯çš„ç‰ˆæœ¬ï¼Œè®¿é—®ä» 5 æ¬¡å¼€å§‹å°±ä¼šè¿”å›ä¸€ä¸ª 500 é”™è¯¯ï¼š\n$ kubectl set image deployment kubia nodejs=luksa/kubia:v3 # æ›´æ–°åˆ° v3 deployment.apps/kubia image updated $ kubectl rollout status deployment kubia # æŸ¥çœ‹æ›´æ–°çŠ¶æ€ Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 old replicas are pending termination... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 old replicas are pending termination... Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 old replicas are pending termination... deployment \u0026quot;kubia\u0026quot; successfully rolled out åœ¨å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹è®¿é—® service çš„ç»“æœï¼š\n$ while true;do curl 10.43.191.168; sleep 0.5s;done This is v3 running in pod kubia-56ff78687-kc77b Some internal error has occurred! This is pod kubia-56ff78687-2b7tz This is v3 running in pod kubia-56ff78687-kc77b Some internal error has occurred! This is pod kubia-56ff78687-2b7tz This is v2 running in pod kubia-88894bbd4-h8mck Some internal error has occurred! This is pod kubia-56ff78687-2b7tz This is v3 running in pod kubia-56ff78687-mbqdw This is v3 running in pod kubia-56ff78687-mbqdw Some internal error has occurred! This is pod kubia-56ff78687-mbqdw This is v3 running in pod kubia-56ff78687-kc77b This is v2 running in pod kubia-88894bbd4-h8mck å¯ä»¥çœ‹åˆ°æœ‰ä¸€äº›æŠ¥é”™äº†ï¼šSome internal error has occurred! This is pod kubia-56ff78687-mbqdw\nå¯¹å¤–æä¾›ä¸€ä¸ªæœ‰ bug çš„ pod æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œæ­¤æ—¶å°±éœ€è¦æ‰§è¡Œå›æ»šæ“ä½œäº†ï¼š\n$ kubectl rollout undo deployment kubia deployment.apps/kubia rolled back åœ¨å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹è®¿é—® service çš„ç»“æœï¼š\n$ while true;do curl 10.43.191.168; sleep 0.5s;done This is v2 running in pod kubia-88894bbd4-rvzvb This is v2 running in pod kubia-88894bbd4-rvzvb This is v2 running in pod kubia-88894bbd4-pxxwt This is v2 running in pod kubia-88894bbd4-pxxwt This is v2 running in pod kubia-88894bbd4-4wknk This is v2 running in pod kubia-88894bbd4-4wknk å‘ç°å·²ç»å›æ»šåˆ° v2 ç‰ˆæœ¬äº†ã€‚\næŸ¥çœ‹æ›´æ–°è®°å½•ï¼š\n$ kubectl rollout history deployment kubia deployment.apps/kubia REVISION CHANGE-CAUSE 1 kubectl apply --filename=deployment.yaml --record=true 3 kubectl apply --filename=deployment.yaml --record=true 4 kubectl apply --filename=deployment.yaml --record=true è¿™é‡Œæ˜¾ç¤ºçš„å’Œä¹¦ä¸­çš„æœ‰æ‰€ä¸åŒï¼Œä¹¦ä¸­æ˜¾ç¤ºçš„æ˜¯ï¼š\n$ kubectl rollout history deployment kubia deployments \u0026quot;kubia\u0026quot;: REVISION CHANGE-CAUSE 2 kubectl set image deployment kubia nodejs=luksa/kubia:v2 3 kubectl set image deployment kubia nodejs=luksa/kubia:v3 æ„Ÿè§‰ä¹¦ä¸Šè¿™ç§æ˜¾ç¤ºçš„å‹å¥½ä¸€äº›ï¼Œè€Œä¸”æˆ‘æ‰§è¡Œçš„æ˜æ˜æ˜¯ kubectl set image deployment kubia nodejs=xxx ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯ kubectl apply \u0026ndash;filename=deployment.yaml \u0026ndash;record=true ï¼Ÿ\nå‰é¢æåˆ°è¿‡ï¼Œ\u0026ndash;record å·²ç»è¢«åºŸå¼ƒï¼Œéš¾é“æ–°ç‰ˆæœ¬å¯¹ CHANGE-CAUSE è¿›è¡Œäº†ä¸€äº›å˜æ›´å—ï¼Ÿæš‚æ—¶è¿˜ä¸çŸ¥é“å•¥æƒ…å†µ\nå¯ä»¥é€šè¿‡æŒ‡å®šç‰ˆæœ¬æ¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜äº†ï¼š\n$ kubectl rollout history deployment/kubia --revision=1 deployment.apps/kubia with revision #1 Pod Template: Labels:\tapp=kubia pod-template-hash=5f6cdb7bf7 Annotations:\tkubernetes.io/change-cause: kubectl apply --filename=deployment.yaml --record=true Containers: nodejs: Image:\tluksa/kubia:v1 Port:\t\u0026lt;none\u0026gt; Host Port:\t\u0026lt;none\u0026gt; Environment:\t\u0026lt;none\u0026gt; Mounts:\t\u0026lt;none\u0026gt; Volumes:\t\u0026lt;none\u0026gt; æ­¤æ—¶å°±å¯ä»¥çœ‹åˆ°è¯¥ç‰ˆæœ¬å¯¹åº”çš„é•œåƒäº†ã€‚\nè‡³æ­¤å·²ç»ç»å†äº† v1 - v3 ä¸€å…± 3 ä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œæœ‰æ›´æ–°æ“ä½œä¹Ÿæœ‰å›æ»šæ“ä½œï¼Œæ­¤æ—¶æŸ¥çœ‹ rsï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE kubia-5f6cdb7bf7 0 0 0 17h kubia-88894bbd4 3 3 3 16h kubia-56ff78687 0 0 0 15h ä¼šå‘ç°æ¯ä¸ªç‰ˆæœ¬çš„ rs ä¾ç„¶å­˜åœ¨ï¼Œä¸ºçš„å°±æ˜¯èƒ½æ‰§è¡Œå›æ»šæ“ä½œï¼Œé¡ºå¸¦ä¸€æï¼Œå›æ»šä¸ä»…ä»…æ˜¯ä¸Šä¸ªç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥æ˜¯ä»»æ„ä¸€ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨ kubectl rollout undo deployment kubia --to-revision=l å³å¯ã€‚åœ¨ä½¿ç”¨äº† deployment åï¼Œç³»ç»Ÿä¸­çš„ rs å°±ä¸ç”¨æˆ‘ä»¬å»ç®¡ç†äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸éœ€è¦è‡ªå·±å»æ‰‹åŠ¨ä¿®æ”¹ã€åˆ é™¤ rs äº†ã€‚\næ§åˆ¶æ»šåŠ¨å‡çº§é€Ÿç‡ æœ‰ä¸¤ä¸ªå±æ€§å¯ä»¥ç”¨æ¥æ§åˆ¶å‡çº§é€Ÿç‡ï¼š\nmaxSurgeï¼šå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå…è®¸è¶…å‡º replicas çš„ pod æ•°é‡ï¼Œå€¼å¯ä»¥æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”æˆ–è€…ä¸€ä¸ªæ•°å­— maxUnavailableï¼šå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå…è®¸çš„ä¸å¯ç”¨ pod æ•°é‡ï¼Œå€¼å¯ä»¥æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”æˆ–è€…ä¸€ä¸ªæ•°å­— è¿™ä¸¤ä¸ªå€¼å®šä¹‰åœ¨ .spec.strategy.rollingUpdate ä¸­ï¼Œä¸‹é¢å¯¹è¿™ä¸¤ä¸ªå±æ€§è¿›è¡Œå±•å¼€è¯´æ˜ã€‚\nå‰é¢æåˆ°è¿‡æ»šåŠ¨å‡çº§çš„æµç¨‹ï¼Œå¤§è‡´æ˜¯ä½¿ç”¨ä¸¤ä¸ª rsï¼Œä¸€ä¸ªç®¡ç†æ—§ç‰ˆæœ¬ podï¼Œä¸€ä¸ªç®¡ç†æ–°ç‰ˆæœ¬ podï¼Œç®¡ç†æ—§ç‰ˆæœ¬çš„ rs ä¸æ–­ç¼©å®¹ï¼Œç®¡ç†æ–°ç‰ˆæœ¬çš„ rs ä¸æ–­æ‰©å®¹ï¼Œæœ€ç»ˆå®Œæˆæ›´æ–°ã€‚é€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªå±æ€§å°±å¯ä»¥å¯¹æ•´ä¸ªæµç¨‹çš„é€Ÿç‡è¿›è¡Œæ§åˆ¶ï¼Œä¸¾ä¸ªä¾‹å­ï¼šç°åœ¨ä¸€å…±æœ‰ 3 ä¸ª pod éœ€è¦å‡çº§ï¼Œæ­¤æ—¶å°† maxUnavailable è®¾ç½®ä¸º 2ï¼Œä»£è¡¨æœ€å¤šå…è®¸æœ‰ 2 ä¸ª pod ä¸å¯ç”¨ï¼Œé‚£ä¹ˆæ­¤æ—¶ç¼©å®¹ rs å°±å¯ä»¥ç¼©åˆ° 1ã€‚å¼•ç”¨å®˜æ–¹çš„è¯´æ˜ï¼š\næœ€å¤§ä¸å¯ç”¨\n.spec.strategy.rollingUpdate.maxUnavailable æ˜¯ä¸€ä¸ªå¯é€‰å­—æ®µï¼Œç”¨æ¥æŒ‡å®š æ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çš„ Pod çš„ä¸ªæ•°ä¸Šé™ã€‚è¯¥å€¼å¯ä»¥æ˜¯ç»å¯¹æ•°å­—ï¼ˆä¾‹å¦‚ï¼Œ5ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰€éœ€ Pods çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼Œ10%ï¼‰ã€‚ç™¾åˆ†æ¯”å€¼ä¼šè½¬æ¢æˆç»å¯¹æ•°å¹¶å»é™¤å°æ•°éƒ¨åˆ†ã€‚ å¦‚æœ .spec.strategy.rollingUpdate.maxSurge ä¸º 0ï¼Œåˆ™æ­¤å€¼ä¸èƒ½ä¸º 0ã€‚ é»˜è®¤å€¼ä¸º 25%ã€‚\nä¾‹å¦‚ï¼Œå½“æ­¤å€¼è®¾ç½®ä¸º 30% æ—¶ï¼Œæ»šåŠ¨æ›´æ–°å¼€å§‹æ—¶ä¼šç«‹å³å°†æ—§ ReplicaSet ç¼©å®¹åˆ°æœŸæœ› Pod ä¸ªæ•°çš„70%ã€‚ æ–° Pod å‡†å¤‡å°±ç»ªåï¼Œå¯ä»¥ç»§ç»­ç¼©å®¹æ—§æœ‰çš„ ReplicaSetï¼Œç„¶åå¯¹æ–°çš„ ReplicaSet æ‰©å®¹ï¼Œ ç¡®ä¿åœ¨æ›´æ–°æœŸé—´å¯ç”¨çš„ Pods æ€»æ•°åœ¨ä»»ä½•æ—¶å€™éƒ½è‡³å°‘ä¸ºæ‰€éœ€çš„ Pod ä¸ªæ•°çš„ 70%ã€‚\næœ€å¤§å³°å€¼\n.spec.strategy.rollingUpdate.maxSurge æ˜¯ä¸€ä¸ªå¯é€‰å­—æ®µï¼Œç”¨æ¥æŒ‡å®šå¯ä»¥åˆ›å»ºçš„è¶…å‡ºæœŸæœ› Pod ä¸ªæ•°çš„ Pod æ•°é‡ã€‚æ­¤å€¼å¯ä»¥æ˜¯ç»å¯¹æ•°ï¼ˆä¾‹å¦‚ï¼Œ5ï¼‰æˆ–æ‰€éœ€ Pods çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼Œ10%ï¼‰ã€‚ å¦‚æœ MaxUnavailable ä¸º 0ï¼Œåˆ™æ­¤å€¼ä¸èƒ½ä¸º 0ã€‚ç™¾åˆ†æ¯”å€¼ä¼šé€šè¿‡å‘ä¸Šå–æ•´è½¬æ¢ä¸ºç»å¯¹æ•°ã€‚ æ­¤å­—æ®µçš„é»˜è®¤å€¼ä¸º 25%ã€‚\nä¾‹å¦‚ï¼Œå½“æ­¤å€¼ä¸º 30% æ—¶ï¼Œå¯åŠ¨æ»šåŠ¨æ›´æ–°åï¼Œä¼šç«‹å³å¯¹æ–°çš„ ReplicaSet æ‰©å®¹ï¼ŒåŒæ—¶ä¿è¯æ–°æ—§ Pod çš„æ€»æ•°ä¸è¶…è¿‡æ‰€éœ€ Pod æ€»æ•°çš„ 130%ã€‚ä¸€æ—¦æ—§ Pods è¢«æ€æ­»ï¼Œæ–°çš„ ReplicaSet å¯ä»¥è¿›ä¸€æ­¥æ‰©å®¹ï¼Œ åŒæ—¶ç¡®ä¿æ›´æ–°æœŸé—´çš„ä»»ä½•æ—¶å€™è¿è¡Œä¸­çš„ Pods æ€»æ•°æœ€å¤šä¸ºæ‰€éœ€ Pods æ€»æ•°çš„ 130%ã€‚\nå¯¹äºä¹¦ä¸Šçš„è¡¨ 9.2 æˆ‘æœ‰ç‚¹ç–‘é—®ï¼Œå¯¹è¿™ä¸¤ä¸ªå±æ€§çš„æè¿°éƒ½æ˜¯ï¼šå½“æŠŠç™¾åˆ†æ•°è½¬æ¢æˆç»å¯¹å€¼æ—¶ï¼Œä¼šå°†æ•°å­—å››èˆäº”å…¥ï¼Œä½†æ˜¯åé¢åˆä¸¾äº†ä¸ªä¾‹å­ï¼š\nç”±äºåœ¨ä¹‹å‰åœºæ™¯ä¸­ï¼Œè®¾ç½®çš„æœŸæœ›å‰¯æœ¬æ•°ä¸º 3ï¼Œä¸Šè¿°çš„ä¸¤ä¸ªå±æ€§éƒ½è®¾ç½®ä¸º 25%, maxSurge å…è®¸æœ€å¤š podæ•°é‡è¾¾åˆ° 4ï¼Œ åŒæ—¶ maxUnavailable ä¸å…è®¸å‡ºç°ä»»ä½•ä¸å¯ç”¨çš„pod (ä¹Ÿå°±æ˜¯è¯´ä¸‰ä¸ªpod\u0026amp;ã€é¡»ä¸€ç›´å¤„äºå¯è¿è¡ŒçŠ¶æ€)\nå‰¯æœ¬æ•°ä¸º 3ï¼ŒmaxUnavailable è®¾ç½®ä¸º 25%ï¼Œ3*25% = 0.75ï¼Œå››èˆäº”å…¥ç­‰äº 1ï¼Œé‚£ä¹ˆåº”è¯¥å…è®¸æœ‰ 1 ä¸ª pod ä¸å¯ç”¨ï¼Œä¸ºä»€ä¹ˆä¹¦ä¸Šè¯´çš„æ˜¯ä¸å…è®¸ä»»ä½• pod ä¸å¯ç”¨ï¼Ÿ\nåœ¨çœ‹å®˜æ–¹çš„æ–‡æ¡£ï¼šmaxUnavailable è¯´çš„æ˜¯ï¼šç™¾åˆ†æ¯”å€¼ä¼šè½¬æ¢æˆç»å¯¹æ•°å¹¶å»é™¤å°æ•°éƒ¨åˆ†\nmaxSurge è¯´çš„æ˜¯ï¼šç™¾åˆ†æ¯”å€¼ä¼šé€šè¿‡å‘ä¸Šå–æ•´è½¬æ¢ä¸ºç»å¯¹æ•°\nè¿™æ˜¾ç„¶å’Œä¹¦ä¸Šè¯´çš„å››èˆäº”å…¥æœ‰å‡ºå…¥ï¼Œé‚£ä¹ˆåˆ°åº•å®é™…æƒ…å†µå¦‚ä½•å‘¢ï¼Ÿåªæœ‰æºç èƒ½æ­æ™“ç­”æ¡ˆäº†ã€‚\nå¯¹åº”çš„å‡½æ•°åœ¨ kubernetes/pkg/controller/deployment/util/deployment_util.go ä¸‹ï¼š\n// desired ä»£è¡¨å‰¯æœ¬æ•°é‡ func ResolveFenceposts(maxSurge, maxUnavailable *intstrutil.IntOrString, desired int32) (int32, int32, error) { // maxSurge æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ 0 // roundUp è®¾ç½®ä¸º trueï¼Œä»£è¡¨å‘ä¸Šå–æ•´ surge, err := intstrutil.GetScaledValueFromIntOrPercent(intstrutil.ValueOrDefault(maxSurge, intstrutil.FromInt(0)), int(desired), true) if err != nil { return 0, 0, err } // maxUnavailable æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ 0 // roundUp è®¾ç½®ä¸º falseï¼Œä»£è¡¨å‘ä¸‹å–æ•´ unavailable, err := intstrutil.GetScaledValueFromIntOrPercent(intstrutil.ValueOrDefault(maxUnavailable, intstrutil.FromInt(0)), int(desired), false) if err != nil { return 0, 0, err } // æ‰€ä»¥ surge å’Œ unavailable é‡‡ç”¨çš„ç­–ç•¥æ˜¯ä¸åŒçš„ // æ¯”å¦‚ replicas ä¸º 3ï¼ŒmaxSurge å’Œ maxUnavailable éƒ½è®¾ç½®ä¸º 25%ï¼Œ // 3 * 25 / 100 = 0.75ï¼Œsurge é‡‡ç”¨å‘ä¸Šå–æ•´ï¼Œæ‰€ä»¥ä¸º 1ï¼Œè€Œ unavailable // é‡‡ç”¨å‘ä¸‹å–æ•´, æ‰€ä»¥ä¸º 0 if surge == 0 \u0026amp;\u0026amp; unavailable == 0 { // Validation should never allow the user to explicitly use zero values for both maxSurge // maxUnavailable. Due to rounding down maxUnavailable though, it may resolve to zero. // If both fenceposts resolve to zero, then we should set maxUnavailable to 1 on the // theory that surge might not work due to quota. unavailable = 1 } return int32(surge), int32(unavailable), nil } è°ƒç”¨çš„ GetScaledValueFromIntOrPercent å‡½æ•°ï¼š\n// intOrPercent ä»£è¡¨ä¸€ä¸ªæ•´æ•°æˆ–è€…ç™¾åˆ†æ¯”å­—ç¬¦ä¸²ï¼Œtotal ä»£è¡¨æ€»æ•°é‡ï¼ŒroundUp ä»£è¡¨å‘ä¸Šå–æ•´è¿˜æ˜¯å‘ä¸‹å–æ•´ï¼Œ // å¦‚æœ intOrPercent æ˜¯ intï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œå¦‚æœæ˜¯ç™¾åˆ†æ¯”ï¼Œåˆ™è¿”å› total*ç™¾åˆ†æ¯”åçš„å€¼ï¼ˆè¿˜éœ€è¦è¿›è¡Œå–æ•´å¤„ç†ï¼‰ func GetScaledValueFromIntOrPercent(intOrPercent *IntOrString, total int, roundUp bool) (int, error) { if intOrPercent == nil { return 0, errors.New(\u0026quot;nil value for IntOrString\u0026quot;) } // è·å– intOrPercent çš„å€¼ï¼Œè¯¥å€¼å¯èƒ½æ˜¯ä¸€ä¸ªæ•°å­—æˆ–è€…ç™¾åˆ†æ¯” value, isPercent, err := getIntOrPercentValueSafely(intOrPercent) if err != nil { return 0, fmt.Errorf(\u0026quot;invalid value for IntOrString: %v\u0026quot;, err) } // å¦‚æœè¯¥å€¼æ˜¯ç™¾åˆ†æ¯” if isPercent { // å¦‚æœè®¾ç½®äº† roundUpï¼ˆä¸çŸ¥é“å’‹ç¿»è¯‘ï¼‰ï¼Œåˆ™å‘ä¸Šå–æ•´ï¼Œæ¯”å¦‚ 1.2 =\u0026gt; 2ï¼ˆä¸æ˜¯å››èˆäº”å…¥ï¼‰ if roundUp { value = int(math.Ceil(float64(value) * (float64(total)) / 100)) } else { // å¦åˆ™å‘ä¸‹å–æ•´ï¼Œæ¯”å¦‚ 1.5 =\u0026gt; 1 value = int(math.Floor(float64(value) * (float64(total)) / 100)) } } return value, nil } æµ‹è¯•ä¸€ä¸‹ï¼š\nfunc TestResolveFenceposts1(t *testing.T) { maxSurge := intstr.FromString(\u0026quot;25%\u0026quot;) maxUnavailable := intstr.FromString(\u0026quot;25%\u0026quot;) var replicas int32 = 3 s, u, err := ResolveFenceposts(\u0026amp;maxSurge, \u0026amp;maxUnavailable, replicas) if err != nil { t.Error(err) } t.Log(s, u) } // Output: // 1 0 // ä»£è¡¨ä¸¤ä¸ªå€¼éƒ½è®¾ç½®ä¸º 25% çš„æƒ…å†µä¸‹ï¼Œå…è®¸å¤šå‡º 1 ä¸ª podï¼Œå…è®¸æœ‰ 0 ä¸ª pod ä¸å¯ç”¨ æ‰€ä»¥ä¹¦ä¸Šè¯´çš„å››èˆäº”å…¥å¹¶ä¸å‡†ç¡®ï¼Œå®˜æ–¹æ–‡æ¡£æ‰æ˜¯æ­£ç¡®çš„ï¼Œä¸è¿‡æœ€é è°±çš„è¿˜æ˜¯çœ‹æºç  ï¼ˆç‹—å¤´ï¼‰ã€‚\nå®è·µ è¯¥ yaml ç”¨æ¥åˆ›å»ºä¸€ä¸ª replicas ä¸º 3 çš„ deploymentï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 è¿è¡Œï¼š\n$ kubectl apply -f nginx-deployment.yaml --record deployment.apps/nginx-deployment created $ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-7848d4b86f 3 3 3 6m57s # æ›´æ–° deployment çš„é•œåƒç‰ˆæœ¬ï¼Œ1.91 æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„ç‰ˆæœ¬ $ kubectl set image deployment/nginx-deployment nginx=nginx:1.91 # æŸ¥çœ‹è¯¥ deployment ç®¡ç†çš„ rsï¼Œå‘ç°å¤šå‡ºæ¥äº†ä¸€ä¸ª rsï¼Œå…¶æœŸæœ›çš„ pod æ•°é‡ä¸º 1ï¼Œ # ä½†æ˜¯å› ä¸º 1.91 ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ READY ä¸º 0ï¼Œè¿™ä¸ªå¤šå‡ºæ¥çš„ rs å°±æ˜¯ç”¨æ¥åšæ»šåŠ¨æ›´æ–°çš„ $ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-7848d4b86f 3 3 3 6h54m nginx-deployment-b475d749b 1 1 0 7m8s # æŸ¥çœ‹æ›´æ–°åçš„ deployment $ kubectl get deploy NAME READY UP-TO-DATE AVAILABLE AGE nginx-deployment 3/3 1 3 6h59m # æŸ¥çœ‹ deployment çš„è¯¦ç»†ä¿¡æ¯ï¼Œå‘ç°æ»šåŠ¨ç­–ç•¥ä¸º 25% max unavailable, 25% max surgeï¼Œä¹Ÿå°±æ˜¯å…è®¸å¤šå‡º 1 ä¸ª podï¼Œå…è®¸ # æœ‰ 0 ä¸ª pod ä¸å¯ç”¨ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ podï¼Œæ‰€ä»¥é‚£ä¸ªæ–°åˆ›å»ºå‡ºæ¥çš„ rs çš„ replicas ä¸º 1 $ kubectl describe deploy nginx-deployment Name: nginx-deployment Namespace: default CreationTimestamp: Tue, 11 Oct 2022 17:21:35 +0800 Labels: app=nginx Annotations: deployment.kubernetes.io/revision: 4 kubernetes.io/change-cause: kubectl apply --filename=nginx-deployment.yaml --record=true Selector: app=nginx Replicas: 3 desired | 1 updated | 4 total | 3 available | 1 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max surge Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.91 Port: 80/TCP Host Port: 0/TCP Environment: \u0026lt;none\u0026gt; Mounts: \u0026lt;none\u0026gt; Volumes: \u0026lt;none\u0026gt; Conditions: Type Status Reason ---- ------ ------ Available True MinimumReplicasAvailable Progressing True ReplicaSetUpdated OldReplicaSets: nginx-deployment-7848d4b86f (3/3 replicas created) NewReplicaSet: nginx-deployment-b475d749b (1/1 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 9m9s deployment-controller Scaled down replica set nginx-deployment-b475d749b to 0 Normal ScalingReplicaSet 6m9s (x2 over 13m) deployment-controller Scaled up replica set nginx-deployment-b475d749b to 1 å‡çº§è¿‡ç¨‹ä¸­æ£€æµ‹æ–°ç‰ˆæœ¬æ˜¯å¦å¯ç”¨ åœ¨å›æ»šä¸€èŠ‚ä¸­è¯´è¿‡ï¼Œæ›´æ–°çš„æ–°ç‰ˆæœ¬å¯èƒ½æ˜¯ä¸€ä¸ªæ— æ³•å·¥ä½œçš„ç‰ˆæœ¬ï¼Œæ­¤æ—¶éœ€è¦å›æ»šæ“ä½œï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è¾¹æ›´æ–°è¾¹æ£€æµ‹ï¼Œå‘ç°ä¸å¯ç”¨å°±åœæ­¢æ›´æ–°å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„ minReadySeconds å±æ€§ + å°±ç»ªæ¢é’ˆå°±å¯ä»¥å®ç°ã€‚\nminReadySeconds å±æ€§æŒ‡å®šæ–°åˆ›å»ºçš„ pod è‡³å°‘è¦æˆåŠŸè¿è¡Œå¤šä¹…ä¹‹åï¼Œæ‰èƒ½å°†å…¶è§†ä¸ºå¯ç”¨ã€‚åœ¨ pod å¯ç”¨ä¹‹å‰ï¼Œæ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ä¸ä¼šç»§ç»­ã€‚å½“æ‰€æœ‰å®¹å™¨çš„å°±ç»ªæ¢é’ˆè¿”å›æˆåŠŸæ—¶ï¼Œpod å°±è¢«æ ‡è®°ä¸ºå°±ç»ªçŠ¶æ€ã€‚\nå¦‚æœä¸€ä¸ªæ–°çš„ pod è¿è¡Œå‡ºé”™ï¼Œå°±ç»ªæ¢é’ˆè¿”å›å¤±è´¥ï¼Œæˆ–è€…åœ¨ minReadySeconds æ—¶é—´å†…å®ƒçš„å°±ç»ªæ¢é’ˆå‡ºç°äº†å¤±è´¥ï¼Œ é‚£ä¹ˆæ–°ç‰ˆæœ¬çš„æ»šåŠ¨å‡çº§å°†è¢«é˜»æ­¢ã€‚\nä¹‹å‰çš„ç¬”è®°æœ‰å†™è¿‡å­˜æ´»æ¢é’ˆï¼Œè¿™é‡Œçš„æ˜¯å°±ç»ªæ¢é’ˆï¼ŒäºŒè€…æœ‰æ‰€åŒºåˆ«ï¼Œä½†åŒºåˆ«ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œè¿™é‡Œç®€å•æ‘˜è¦ä¸€ä¸‹å®˜æ–¹çš„æ–‡æ¡£ï¼š\nlivenessProbeï¼ˆå­˜æ´»æ¢é’ˆï¼‰\næŒ‡ç¤ºå®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚å¦‚æœå­˜æ´»æ€æ¢æµ‹å¤±è´¥ï¼Œåˆ™ kubelet ä¼šæ€æ­»å®¹å™¨ï¼Œ å¹¶ä¸”å®¹å™¨å°†æ ¹æ®å…¶é‡å¯ç­–ç•¥å†³å®šæœªæ¥ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œ åˆ™é»˜è®¤çŠ¶æ€ä¸º Successã€‚\nreadinessProbeï¼ˆå°±ç»ªæ¢é’ˆï¼‰\næŒ‡ç¤ºå®¹å™¨æ˜¯å¦å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚å¦‚æœå°±ç»ªæ€æ¢æµ‹å¤±è´¥ï¼Œ ç«¯ç‚¹æ§åˆ¶å™¨å°†ä»ä¸ Pod åŒ¹é…çš„æ‰€æœ‰æœåŠ¡çš„ç«¯ç‚¹åˆ—è¡¨ä¸­åˆ é™¤è¯¥ Pod çš„ IP åœ°å€ã€‚ åˆå§‹å»¶è¿Ÿä¹‹å‰çš„å°±ç»ªæ€çš„çŠ¶æ€å€¼é»˜è®¤ä¸º Failureã€‚ å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ€æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º Successã€‚\nstartupProbeï¼ˆå¯åŠ¨æ¢é’ˆï¼‰\næŒ‡ç¤ºå®¹å™¨ä¸­çš„åº”ç”¨æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœæä¾›äº†å¯åŠ¨æ¢é’ˆï¼Œåˆ™æ‰€æœ‰å…¶ä»–æ¢é’ˆéƒ½ä¼šè¢« ç¦ç”¨ï¼Œç›´åˆ°æ­¤æ¢é’ˆæˆåŠŸä¸ºæ­¢ã€‚å¦‚æœå¯åŠ¨æ¢æµ‹å¤±è´¥ï¼Œkubelet å°†æ€æ­»å®¹å™¨ï¼Œè€Œå®¹å™¨ä¾å…¶ é‡å¯ç­–ç•¥è¿›è¡Œé‡å¯ã€‚ å¦‚æœå®¹å™¨æ²¡æœ‰æä¾›å¯åŠ¨æ¢æµ‹ï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º Successã€‚\nå®è·µ yaml å¦‚ä¸‹ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: kubia spec: replicas: 3 minReadySeconds: 10 # pod å°±ç»ªåç»§ç»­ç­‰å¾… 10 ç§’ strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 0 # ç¡®ä¿å‡çº§è¿‡ç¨‹ä¸­ pod è¢«æŒ¨ä¸ªæ›¿æ¢ type: RollingUpdate template: metadata: name: kubia labels: app: kubia spec: containers: - image: luksa/kubia:v3 name: nodejs readinessProbe: # å°±ç»ªæ¢é’ˆ periodSeconds: 1 # æ¢é’ˆæ¯éš” 1 ç§’æ‰§è¡Œä¸€æ¬¡ httpGet: path: / port: 8080 selector: matchLabels: app: kubia è¿™æ˜¯ä¸€ä¸ªâ€œåæ‰â€çš„é•œåƒï¼šå°±ç»ªæ¢é’ˆæ£€æµ‹ä¸ä¼šæˆåŠŸï¼Œä¸‹é¢æ¥æ‰§è¡Œ yamlï¼š\n$ kubectl apply -f kubia-deployment-v3-with-readinesscheck.yaml deployment.apps/kubia configured apply å‘½ä»¤å¯ä»¥ç”¨ YAML æ–‡ä»¶ä¸­å£°æ˜çš„å­—æ®µæ¥æ›´æ–° Deploymentã€‚ä¸ä»…æ›´æ–°é•œåƒï¼Œè€Œä¸”è¿˜æ·»åŠ äº†å°±ç»ªæ¢é’ˆï¼Œä»¥åŠåœ¨ YAML ä¸­æ·»åŠ æˆ–ä¿®æ”¹çš„å…¶ä»–å£°æ˜ã€‚ å¦‚æœæ–°çš„ YAML ä¹ŸåŒ…å« replicas å­—æ®µï¼Œå½“å®ƒä¸ç°æœ‰ Deployment ä¸­çš„æ•°é‡ä¸ä¸€ è‡´æ—¶ï¼Œé‚£ä¹ˆ apply æ“ä½œä¹Ÿä¼šå¯¹ Dpeloymnet è¿›è¡Œæ‰©å®¹ã€‚\næ­¤æ—¶æŸ¥çœ‹å‡çº§è¿‡ç¨‹ï¼š\n$ kubectl rollout status deployment kubia Waiting for deployment \u0026quot;kubia\u0026quot; rollout to finish: 1 out of 3 new replicas have been updated... # å¾ˆä¹…ä»¥å... error: deployment \u0026quot;kubia\u0026quot; exceeded its progress deadline æ•´ä¸ªæµç¨‹å¡åœ¨äº†æ›´æ–°ç¬¬ä¸€ä¸ª podï¼Œè¯´æ˜æ›´æ–°å¤±è´¥äº†ï¼Œä½¿ç”¨ curl è¯·æ±‚ service çœ‹çœ‹ï¼š\n$ while true;do curl 10.43.191.168; sleep 0.5s;done This is v2 running in pod kubia-88894bbd4-4wknk This is v2 running in pod kubia-88894bbd4-pxxwt This is v2 running in pod kubia-88894bbd4-rvzvb This is v2 running in pod kubia-88894bbd4-4wknk This is v2 running in pod kubia-88894bbd4-pxxwt This is v2 running in pod kubia-88894bbd4-pxxwt This is v2 running in pod kubia-88894bbd4-pxxwt å‘ç°è¯·æ±‚å…¨éƒ¨æ‰“åœ¨äº† v2 pod ä¸Šï¼Œæ²¡æœ‰ v3 ç‰ˆæœ¬ï¼Œè¿™æ˜¯ç¬¦åˆéœ€æ±‚çš„ï¼Œè¯·æ±‚ä¸åº”è¯¥è½åˆ°ä¸€ä¸ªæœ‰é—®é¢˜çš„ pod ä¸Š\næŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-88894bbd4-rvzvb 1/1 Running 0 23h kubia-88894bbd4-4wknk 1/1 Running 0 23h kubia-88894bbd4-pxxwt 1/1 Running 0 23h kubia-74c44776ff-rm4xw 0/1 Running 0 98s å‘ç°æœ‰ä¸€ä¸ª pod æ²¡æœ‰å¤„äº READY çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº† maxSurge ä¸º 1ï¼Œæ‰€ä»¥ä¸€å…±æœ‰ replicas + 1 ä¸ª podï¼Œå¤šå‡ºæ¥å°±æ˜¯è¿™ä¸ªæ²¡æœ‰ READY çš„ v3 podï¼Œå› ä¸ºå®ƒçš„æ¢é’ˆæ£€æµ‹å¤±è´¥äº†ã€‚é€šè¿‡ kubectl describe po kubia-74c44776ff-rm4xw ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€è¡Œçš„äº‹ä»¶æ˜¾ç¤ºï¼š\nWarning Unhealthy 2m25s (x22 over 2m45s) kubelet Readiness probe failed: HTTP probe failed with statuscode: 500 ","date":"2022å¹´05æœˆ13æ—¥","permalink":"/posts/k8s-deployment/","summary":"deplopyment ç”¨äº pod çš„æ›´æ–°ç›¸å…³æ“ä½œã€‚\nå¦‚ä½•æ›´æ–° pod æ›´æ–°æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼šå½“å‰ pod è¿è¡Œçš„æ˜¯æŸä¸ª v1 ç‰ˆæœ¬çš„é•œåƒï¼Œä¸€ä¸ªæœˆåè¯¥é•œåƒå‘å¸ƒäº† v2 ç‰ˆæœ¬ï¼Œæ­¤æ—¶æƒ³å°†æ‰€æœ‰çš„ pod æ›´æ–°åˆ° v2 ç‰ˆæœ¬ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ","title":"k8s Deployment"},{"contents":"package main import ( \u0026quot;fmt\u0026quot; \u0026quot;reflect\u0026quot; ) type I interface { Do() } type S struct{} func (s *S) Do() {} func EnforcePtr(obj interface{}) { v := reflect.TypeOf(obj) fmt.Println(v) if v == nil { fmt.Println(v.Kind()) } } func main() { var i I EnforcePtr(i) var ii I = new(S) EnforcePtr(ii) } è¿™æ®µä»£ç è¿è¡Œåä¼šé˜»å¡ï¼Œé˜»å¡åœ¨ fmt.Println(v.Kind()) è¿™ä¸€è¡Œï¼Œä¸å¤ªæ¸…æ¥šåŸå› ï¼Œæš‚æ—¶ä½œä¸ºè®°å½•\npsï¼šé˜»å¡å shell çª—å£æ— æ³•é€šè¿‡ ctrl+c å¼ºåˆ¶ç»“æŸï¼Œéœ€è¦é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼š\nps -ef | grep \u0026lt;go file name\u0026gt; | grep -v grep | grep run | awk {'print $2'} | xargs kill åªéœ€è¦å°† EnforcePtr æ”¹ä¸ºå¦‚ä¸‹å½¢å¼å³å¯æ­£å¸¸å·¥ä½œ\nfunc EnforcePtr(obj interface{}) { v := reflect.TypeOf(obj) fmt.Println(v) if v == nil { typ := reflect.TypeOf(\u0026amp;v).Elem() fmt.Println(typ.Kind()) } } ","date":"2022å¹´05æœˆ13æ—¥","permalink":"/posts/block-code/","summary":"package main import ( \u0026quot;fmt\u0026quot; \u0026quot;reflect\u0026quot; ) type I interface { Do() } type S struct{} func (s *S) Do() {} func EnforcePtr(obj interface{}) { v := reflect.","title":"ä¸€æ®µè«åé˜»å¡çš„ reflect ä»£ç "},{"contents":"ssh åˆ°å®¶é‡Œçš„å¦å¤–ä¸€å°ç”µè„‘ï¼Œå‘ç°è¾“å…¥å»¶è¿Ÿæ¯”è¾ƒä¸¥é‡ï¼Œä½“éªŒä¸æ˜¯å¾ˆå¥½ï¼Œping å‘ç°å»¶è¿Ÿæ™®éåœ¨ 100 -200 ä¹‹é—´ï¼Œæœ‰å‡ æ¬¡ç”šè‡³è¶…è¿‡äº† 400ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼š\n$ sudo vim /etc/ssh/sshd_config è¾“å…¥ /UseDNS æŸ¥æ‰¾è¿™ä¸€è¡Œï¼Œæ‰¾åˆ°åå‘ç°è¿™è¡Œ UseDNS no æ˜¯è¢«æ³¨é‡Šçš„ï¼Œå»æ‰æ³¨é‡Šï¼Œç„¶å service sshd restart å³å¯ï¼Œä¿®æ”¹ä¹‹åå¡é¡¿é—®é¢˜ç¼“è§£äº†ä¸å°‘ï¼ŒåŸºæœ¬å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚\næ›´æ–°ï¼šå…¶å®æœ‰æ—¶å€™è¿˜æ˜¯å¡çš„ä¸€ bï¼Œçœ‹æ¥è¯¥æ–¹æ³•ç”¨å¤„ä¸æ˜¯ç‰¹åˆ«å¤§\n","date":"2022å¹´05æœˆ11æ—¥","permalink":"/posts/ssh-shu-ru-qia-dun/","summary":"ssh åˆ°å®¶é‡Œçš„å¦å¤–ä¸€å°ç”µè„‘ï¼Œå‘ç°è¾“å…¥å»¶è¿Ÿæ¯”è¾ƒä¸¥é‡ï¼Œä½“éªŒä¸æ˜¯å¾ˆå¥½ï¼Œping å‘ç°å»¶è¿Ÿæ™®éåœ¨ 100 -200 ä¹‹é—´ï¼Œæœ‰å‡ æ¬¡ç”šè‡³è¶…è¿‡äº† 400ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼š","title":"ssh è¾“å…¥å¡é¡¿"},{"contents":"ç¯å¢ƒï¼š\nMacBook m1\nUbuntu 20.04.4 LTSï¼ˆä½¿ç”¨ cat /etc/issue æŸ¥çœ‹ï¼‰ï¼ŒåŸºäº multipass åˆ›å»º\nåœ¨é˜…è¯»**ã€Šæ·±å…¥å‰–æKubernetesã€‹-å¼ ç£Šâ€”â€”ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸‰ï¼‰ï¼šæ·±å…¥ç†è§£å®¹å™¨é•œåƒ**ï¼Œæ–‡ä¸­æä¾›äº†ä¸€ä¸ª namespace çš„ç¤ºä¾‹ä»£ç ï¼š\n#define _GNU_SOURCE #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/wait.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;sched.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #define STACK_SIZE (1024 * 1024) static char container_stack[STACK_SIZE]; char* const container_args[] = { \u0026quot;/bin/bash\u0026quot;, NULL }; int container_main(void* arg) { printf(\u0026quot;Container - inside the container!\\n\u0026quot;); execv(container_args[0], container_args); printf(\u0026quot;Something's wrong!\\n\u0026quot;); return 1; } int main() { printf(\u0026quot;Parent - start a container!\\n\u0026quot;); int container_pid = clone(container_main, container_stack+STACK_SIZE, CLONE_NEWNS | SIGCHLD , NULL); waitpid(container_pid, NULL, 0); printf(\u0026quot;Parent - container stopped!\\n\u0026quot;); return 0; } ä½†æ˜¯åœ¨æˆ‘çš„æœºå™¨ä¸Šæ— æ³•è¿è¡Œï¼Œè¾“å‡ºä¸ºï¼š\nParent - start a container! Parent - container stopped! å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥ clone çš„å›è°ƒå‡½æ•°æ²¡æœ‰è¢«æ‰§è¡Œï¼Œ å› ä¸º Container - inside the container! æ²¡æœ‰è¢«è¾“å‡ºã€‚\nåœ¨main å‡½æ•°çš„ waitpidè°ƒç”¨åé¢æ·»åŠ ä¸€ä¸‹é”™è¯¯ä¿¡æ¯ï¼š\nif (WIFEXITED(status) != 1) { // å­è¿›ç¨‹éæ­£å¸¸é€€å‡º printf(\u0026quot;error!\u0026quot;); printf(\u0026quot;%d\\n\u0026quot;, WTERMSIG(status)); // è¾“å‡ºä¿¡å·ç±»å‹ } WTERMSIG ä¼šè¾“å‡ºä¿¡å·ç±»å‹ï¼Œè¾“å‡ºä¸º 7ï¼ŒæŸ¥äº†ä¸€ä¸‹ï¼Œæ„æ€æ˜¯ SIGBUSï¼Œè¿™æ˜¯ä¸ªä»€ä¹ˆç©æ„å‘¢ï¼ŸæŸ¥äº†ä¸€ä¸‹èµ„æ–™ï¼Œå¤§æ¦‚æ˜¯å†…å­˜é”™è¯¯ã€å¯¹é½é”™è¯¯ä»€ä¹ˆçš„ï¼Œå®Œå…¨çœ‹ä¸æ‡‚ï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•è§£å†³ã€‚ã€‚ã€‚\næ³¨ï¼šä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ä¹Ÿå¯ä»¥ï¼š\n$ gdb ns_err GNU gdb (Ubuntu 9.2-0ubuntu1~20.04.1) 9.2 (gdb) set follow-fork-mode child (gdb) r Starting program: /home/ubuntu/codetest/ns_err Parent - start a container! [Attaching after process 192301 fork to child process 192304] [New inferior 2 (process 192304)] [Detaching after fork from parent process 192301] containerPid: 192304 [Inferior 1 (process 192301) detached] Thread 2.1 \u0026quot;ns_err\u0026quot; received signal SIGBUS, Bus error. [Switching to process 192304] 0x0000000000400738 in container_main () ä¹Ÿå¯ä»¥çœ‹åˆ° \u0026quot;ns_err\u0026quot; received signal SIGBUS, Bus error. è¿™å¥è¯\næœ€åè¿˜æ˜¯ä»å®˜æ–¹æ–‡æ¡£æŸ¥åˆ°äº†ç­”æ¡ˆï¼Œä¸å¾—ä¸è¯´è¿˜æ˜¯å®˜æ–¹æ–‡æ¡£æœ€ä¸ºé è°±\nhttps://man7.org/linux/man-pages/man2/clone.2.html\næœ€ä¸‹é¢æœ‰ä¸€ä¸ª exampleï¼ŒæŠŠè¿™æ®µä»£ç  copy åˆ°æœ¬åœ°ï¼Œå‘ç°å±…ç„¶å¯ä»¥æˆåŠŸè¿è¡Œï¼š\n#define _GNU_SOURCE #include \u0026lt;sys/wait.h\u0026gt; #include \u0026lt;sys/utsname.h\u0026gt; #include \u0026lt;sched.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdint.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/mman.h\u0026gt; #define errExit(msg) do { perror(msg); exit(EXIT_FAILURE); \\ } while (0) static int /* Start function for cloned child */ childFunc(void *arg) { struct utsname uts; /* Change hostname in UTS namespace of child. */ if (sethostname(arg, strlen(arg)) == -1) errExit(\u0026quot;sethostname\u0026quot;); /* Retrieve and display hostname. */ if (uname(\u0026amp;uts) == -1) errExit(\u0026quot;uname\u0026quot;); printf(\u0026quot;uts.nodename in child: %s\\n\u0026quot;, uts.nodename); /* Keep the namespace open for a while, by sleeping. This allows some experimentation--for example, another process might join the namespace. */ sleep(200); return 0; /* Child terminates now */ } #define STACK_SIZE (1024 * 1024) /* Stack size for cloned child */ int main(int argc, char *argv[]) { char *stack; /* Start of stack buffer */ char *stackTop; /* End of stack buffer */ pid_t pid; struct utsname uts; if (argc \u0026lt; 2) { fprintf(stderr, \u0026quot;Usage: %s \u0026lt;child-hostname\u0026gt;\\n\u0026quot;, argv[0]); exit(EXIT_SUCCESS); } /* Allocate memory to be used for the stack of the child. */ stack = mmap(NULL, STACK_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, -1, 0); if (stack == MAP_FAILED) errExit(\u0026quot;mmap\u0026quot;); stackTop = stack + STACK_SIZE; /* Assume stack grows downward */ /* Create child that has its own UTS namespace; child commences execution in childFunc(). */ pid = clone(childFunc, stackTop, CLONE_NEWUTS | SIGCHLD, argv[1]); if (pid == -1) errExit(\u0026quot;clone\u0026quot;); printf(\u0026quot;clone() returned %jd\\n\u0026quot;, (intmax_t) pid); /* Parent falls through to here */ sleep(1); /* Give child time to change its hostname */ /* Display hostname in parent's UTS namespace. This will be different from hostname in child's UTS namespace. */ if (uname(\u0026amp;uts) == -1) errExit(\u0026quot;uname\u0026quot;); printf(\u0026quot;uts.nodename in parent: %s\\n\u0026quot;, uts.nodename); if (waitpid(pid, NULL, 0) == -1) /* Wait for child */ errExit(\u0026quot;waitpid\u0026quot;); printf(\u0026quot;child has terminated\\n\u0026quot;); exit(EXIT_SUCCESS); } ä¸åŒä¹‹å¤„åœ¨äºè¿™å‡ å¥è¯ï¼š\nstack = mmap(NULL, STACK_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, -1, 0); if (stack == MAP_FAILED) errExit(\u0026quot;mmap\u0026quot;); stackTop = stack + STACK_SIZE; /* Assume stack grows downward */ /* Create child that has its own UTS namespace; child commences execution in childFunc(). */ pid = clone(childFunc, stackTop, CLONE_NEWUTS | SIGCHLD, argv[1]); å®ƒæ˜¯é€šè¿‡ mmap ç”³è¯·çš„å†…å­˜\nç°åœ¨ä½¿ç”¨ç›¸åŒçš„æ–¹å¼ï¼Œä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„ä»£ç ï¼š\n#define _GNU_SOURCE #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/wait.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;sched.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/mman.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #define STACK_SIZE (1024 * 1024) #define errExit(msg) do { perror(msg); exit(EXIT_FAILURE); \\ } while (0) static char container_stack[STACK_SIZE]; char* const container_args[] = { \u0026quot;/bin/bash\u0026quot;, NULL }; int container_main(void* arg) { printf(\u0026quot;Container - inside the container!\\n\u0026quot;); // //mount(\u0026quot;\u0026quot;, \u0026quot;/\u0026quot;, NULL, MS_PRIVATE, \u0026quot;\u0026quot;); //mount(\u0026quot;none\u0026quot;, \u0026quot;/tmp\u0026quot;, \u0026quot;tmpfs\u0026quot;, 0, \u0026quot;\u0026quot;); execv(container_args[0], container_args); printf(\u0026quot;Something's wrong!\\n\u0026quot;); return 1; } int main() { char *stack; /* Start of stack buffer */ char *stackTop; /* End of stack buffer */ printf(\u0026quot;Parent - start a container!\\n\u0026quot;); stack = mmap(NULL, STACK_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, -1, 0); if (stack == MAP_FAILED) errExit(\u0026quot;mmap\u0026quot;); stackTop = stack + STACK_SIZE; int container_pid = clone(container_main, stackTop, CLONE_NEWNS|SIGCHLD , NULL); printf(\u0026quot;containerPid: %d\\n\u0026quot;, container_pid); int status; waitpid(container_pid, \u0026amp;status, 0); if (WIFEXITED(status) != 1) { printf(\u0026quot;error!\u0026quot;); printf(\u0026quot;%d\\n\u0026quot;, WTERMSIG(status)); } printf(\u0026quot;Parent - container stopped!\\n\u0026quot;); return 0; } æ¥ä¸‹æ¥å°±æ˜¯è§è¯å¥‡è¿¹çš„æ—¶åˆ»äº†ï¼\n$ ./a.out Parent - start a container! containerPid: 192918 Container - inside the container! $ exit Parent - container stopped! æ²¡æœ‰æŠ¥é”™äº†ï¼ŒæˆåŠŸè¿›å…¥å®¹å™¨ï¼Œé—®é¢˜ç»ˆäºè§£å†³äº†ã€‚\nè‡³äºä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ mmapï¼Œä½œä¸ºä¸€ä¸ªèœé¸¡ç›®å‰è¿˜æ²¡æœ‰å¤´ç»ªï¼Œåç»­å†è¿›è¡Œç ”ç©¶\n","date":"2022å¹´05æœˆ11æ—¥","permalink":"/posts/linux-clone-de-keng/","summary":"ç¯å¢ƒï¼š\nMacBook m1\nUbuntu 20.04.4 LTSï¼ˆä½¿ç”¨ cat /etc/issue æŸ¥çœ‹ï¼‰ï¼ŒåŸºäº multipass åˆ›å»º","title":"linux clone() çš„å‘"},{"contents":"å®è·µ å®šä¹‰ä¸€ä¸ªæœªçŸ¥åç¼€åçš„æ–‡ä»¶ï¼ˆè¿™ä¸ªåç¼€åèµ·çš„å¾—éšæ„ä¸€ç‚¹ï¼Œåƒ xyz è¿™ç§æ˜¯ä¸è¡Œçš„ï¼Œä¼šè¢« chrome è¯†åˆ«ä¸º chemical/x-xyz ç±»å‹ï¼‰ï¼Œä½†æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹æ˜¯ HTMLï¼š\ndemo.lubenwei\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026quot;utf-8\u0026quot;\u0026gt; \u0026lt;title\u0026gt;\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;HelloWorld\u0026lt;/h2\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç„¶åå†™ä¸€ä¸ª http file serverï¼Œå°†æ–‡ä»¶å†…å®¹ä½œä¸º response è¿”å›ï¼š\nmime_sniffing.go\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; ) func main() { http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { http.ServeFile(w, r, \u0026quot;./demo.lubenwei\u0026quot;) }) log.Println(\u0026quot;listen in 8080\u0026quot;) if err := http.ListenAndServe(\u0026quot;:8080\u0026quot;, nil); err != nil { panic(err) } } æ³¨æ„è¿™é‡Œæ²¡æœ‰æŒ‡å®š Content-Type\næ¥ä¸‹æ¥è¿è¡Œè¿™ä¸ª http serverï¼š\n$ go run mime_sniffing.go ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:8080ï¼Œä¼šå‘ç°æ˜¾ç¤ºçš„å†…å®¹æ˜¯ h2 æ ‡é¢˜çš„ HelloWorld\nè¿™é‡Œå°±æ¯”è¾ƒç–‘æƒ‘äº†ï¼Œæˆ‘æ—¢æ²¡æœ‰æŒ‡å®š Content-Type å“åº”å¤´ï¼Œä¹Ÿæ²¡æœ‰å°†æ–‡ä»¶åç¼€åå®šä¹‰ä¸º htmlï¼Œé‚£æµè§ˆå™¨æ˜¯å¦‚ä½•çŸ¥é“å…¶å†…å®¹æ˜¯ htmlï¼ŒåŒæ—¶è§£æå‡ºæ¥çš„å‘¢ï¼ŸæŸ¥äº†ä¸€ä¸‹ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ MIME å—…æ¢ï¼Œå¤§è‡´æ„æ€å°±æ˜¯å¦‚æœæ²¡æœ‰å®šä¹‰ Content-Typeï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šè¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ¨æ–­è¿™æ˜¯ä¸ªä»€ä¹ˆç±»å‹çš„æ–‡ä»¶ï¼Œè¿›è€Œé‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚è¿™é‡Œå°±ä¼šè¯»å–æˆ‘è¿™ä¸ªåç¼€åä¸º lubenwei çš„æ–‡ä»¶ï¼Œå‘ç°é‡Œé¢æœ‰ html æ ‡ç­¾ï¼Œç„¶åå°†å…¶ä½œä¸º html è§£æ\nå¯ä»¥é€šè¿‡è®¾ç½®å“åº”å¤´ X-Content-Type-Options: nosniff æ¥ç¦æ­¢å®¢æˆ·ç«¯å—…æ¢æ–‡ä»¶å†…å®¹ï¼Œä¿®æ”¹åä»£ç ï¼š\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; ) func main() { http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { w.Header().Set(\u0026quot;X-Content-Type-Options\u0026quot;, \u0026quot;nosniff\u0026quot;) http.ServeFile(w, r, \u0026quot;./demo.lubenwei\u0026quot;) }) log.Println(\u0026quot;listen in 8080\u0026quot;) if err := http.ListenAndServe(\u0026quot;:8080\u0026quot;, nil); err != nil { panic(err) } } ä½†æ˜¯æˆ‘è¿™è¾¹è®¿é—® http://localhost:8080 ä¾ç„¶ä¼šæ˜¾ç¤º h2 æ ¼å¼çš„ HelloWorldï¼ˆä½¿ç”¨ chromeã€edgeã€safari åˆ†åˆ«æµ‹è¯•ï¼Œç»“æœç›¸åŒï¼‰\nè²Œä¼¼æ˜¯å› ä¸º X-Content-Type-Options: nosniff éœ€è¦å’Œ Content-Type æ­é…ä½¿ç”¨æ‰è¡Œï¼Œè¿™é‡Œæˆ‘ç»™æŒ‡å®šä¸€ä¸ªé”™è¯¯çš„ Content-Typeï¼š\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; ) func main() { http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { w.Header().Set(\u0026quot;Content-Type\u0026quot;, \u0026quot;json\u0026quot;) w.Header().Set(\u0026quot;X-Content-Type-Options\u0026quot;, \u0026quot;nosniff\u0026quot;) http.ServeFile(w, r, \u0026quot;./demo.lubenwei\u0026quot;) }) log.Println(\u0026quot;listen in 8080\u0026quot;) if err := http.ListenAndServe(\u0026quot;:8080\u0026quot;, nil); err != nil { panic(err) } } ç”¨æµè§ˆå™¨ï¼ˆsafariï¼‰è®¿é—®ï¼Œä¼šå‘ç°æ­¤æ—¶ä¸ä¼šæ˜¾ç¤º HelloWorld äº†ï¼Œè€Œæ˜¯ä¼šä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œä¸åŒçš„æµè§ˆå™¨ä¼šæœ‰ä¸åŒçš„ç­–ç•¥ï¼Œchrome å’Œ edge çš„è¯æ˜¯ä¼šç›´æ¥æ˜¾ç¤ºå‡ºæ–‡ä»¶çš„å†…å®¹ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æµè§ˆå™¨å¯èƒ½ä¼šèµ°ç¼“å­˜ï¼Œå¯¼è‡´è¿˜æ˜¯æ˜¾ç¤º h2 æ ¼å¼çš„ HelloWorldï¼Œå¯ä»¥å¼€ä¸€ä¸ªéšèº«çª—å£è®¿é—®ï¼š\n","date":"2022å¹´05æœˆ08æ—¥","permalink":"/posts/http_mime_sniff/","summary":"å®è·µ å®šä¹‰ä¸€ä¸ªæœªçŸ¥åç¼€åçš„æ–‡ä»¶ï¼ˆè¿™ä¸ªåç¼€åèµ·çš„å¾—éšæ„ä¸€ç‚¹ï¼Œåƒ xyz è¿™ç§æ˜¯ä¸è¡Œçš„ï¼Œä¼šè¢« chrome è¯†åˆ«ä¸º chemical/x-xyz ç±»å‹ï¼‰ï¼Œä½†æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹æ˜¯ HTMLï¼š","title":"HTTP MIME å—…æ¢ [å¾…å®Œå–„]"},{"contents":"ä»€ä¹ˆæ˜¯ service pod å¾€å¾€éœ€è¦ä¸é›†ç¾¤å†…çš„å…¶ä»– pod è¿›è¡Œé€šä¿¡ï¼ŒåŒæ—¶å¯èƒ½ä¹Ÿéœ€è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œè®©é›†ç¾¤å¤–éƒ¨çš„ pod ä¹Ÿå¯ä»¥è®¿é—®ï¼Œå¦‚æœéœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨å°† pod çš„åœ°å€æä¾›ç»™è®¿é—®è€…ï¼Œæ˜¾ç„¶å¤ªéº»çƒ¦äº†ï¼Œä¸é€‚åˆä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œè€Œä¸”åœ¨ k8s ä¸­ pod çš„åœ°å€æ˜¯ä¸ç¡®å®šçš„ï¼Œå®ƒæ˜¯ç”± k8s è‡ªåŠ¨åˆ†é…çš„ï¼›æ­¤å¤–ï¼Œpod çš„åœ°å€ä¹Ÿæ˜¯éšæ—¶å¯èƒ½å˜åŠ¨çš„ï¼Œè¿™æ˜¯å› ä¸º Pod å¯èƒ½ä¼šåœ¨èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨æˆ–è€…è¢«é‡æ–°åˆ›å»ºã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ª Pod ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå®ƒçš„ IP åœ°å€ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚æ­¤å¤–ï¼Œå½“ä¸€ä¸ª Pod è¢«åˆ é™¤åï¼Œå…¶ IP åœ°å€ä¹Ÿä¼šéšä¹‹æ¶ˆå¤±ã€‚æ‰€ä»¥ k8s éœ€è¦æä¾›ä¸€ç§ç¨³å®šçš„èµ„æºç±»å‹æ¥è§£å†³ pod é—´é€šä¿¡çš„é—®é¢˜ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ Pod IP åœ°å€æ¥è®¿é—® Podã€‚è¿™ä¸ªèµ„æºå°±æ˜¯å°±æ˜¯ serviceã€‚\nservice ä¸º ä¸€ç»„åŠŸèƒ½ç›¸åŒï¼ˆé€»è¾‘æ„ä¹‰ä¸Šçš„ï¼Œä¾‹å¦‚ä½¿ç”¨ç›¸åŒçš„æ ‡ç­¾ï¼‰çš„ pod æä¾›å•ä¸€ä¸å˜çš„æ¥å…¥ç‚¹ï¼Œservice çš„ IP å’Œç«¯å£ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥è®¿é—®è€…å¯ä»¥ç»Ÿä¸€è¿æ¥åˆ° serviceï¼Œservice å†å°†è¯·æ±‚è½¬å‘ç»™å…¶ä»£ç†çš„æŸä¸€ä¸ª podï¼ˆä¼šè´Ÿè½½å‡è¡¡çš„è®¿é—®ï¼‰ï¼Œè¿™æ ·ï¼Œæ— è®º Pod IP æ˜¯å¦å˜åŒ–ï¼Œéƒ½èƒ½ä¿è¯å¯¹ Service çš„è®¿é—®ä¸ä¼šå—åˆ°å½±å“ï¼Œå°±å¯ä»¥è§£å†³ä¸Šé¢çš„ pod åœ°å€å˜åŠ¨é—®é¢˜ã€‚\nåˆ›å»º service ä¸‹é¢çš„ yaml å¯ä»¥åˆ›å»ºä¸€ä¸ª serviceï¼š\napiVersion: v1 kind: Service metadata: name: kubia spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ targetPort: 80 # è½¬å‘åˆ° pod çš„ 80 ç«¯å£ selector: app: kubia # å…·æœ‰ app=kubia æ ‡ç­¾çš„ pod éƒ½å±äºè¯¥ service âš ï¸ targetPort å¿…é¡»æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„ã€è¢«ç›‘å¬çš„ portï¼Œå¦åˆ™ä¹‹åè®¿é—®è¯¥ service ä¼šæŠ¥é”™ Connection refused\nåˆ›å»ºå®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œè·å– service çš„ IP åœ°å€ï¼š\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 23h kubia ClusterIP 10.43.87.107 \u0026lt;none\u0026gt; 80/TCP 23h æµ‹è¯• çŸ¥é“ service çš„ IP åœ°å€åå°±å¯ä»¥è¿›è¡Œæµ‹è¯•äº†ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼\nåœ¨ node æ‰§è¡Œ curl serviceIP\n$ curl 10.43.87.107 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; # çœç•¥ ... å› ä¸ºæˆ‘è½¬å‘çš„å®¹å™¨æ˜¯ nginxï¼Œæ‰€ä»¥ä¼šè¾“å‡º nginx çš„ index.htmlï¼Œè¿™é‡Œ curl çš„åœ°å€æ²¡æœ‰å†™ç«¯å£å·ï¼Œæ˜¯å› ä¸ºä¸å†™ç«¯å£å·ä¼šé»˜è®¤èµ° 80 ç«¯å£ï¼Œç„¶åè¿™ä¸ª svc çš„ port åˆšå¥½ä¹Ÿæ˜¯ 80ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ã€‚\nè¿›å…¥ä¸€ä¸ªå®¹å™¨å†…éƒ¨æ‰§è¡Œ curl\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-2qkls 1/1 Running 0 24h kubia-qgtjw 1/1 Running 0 24h kubia-mbghg 1/1 Running 0 24h nginx 1/1 Running 0 20h $ kubectl exec -it kubia-2qkls -- curl 10.43.87.107 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; # çœç•¥ ... å¦‚æœç”¨è¿‡ dockerï¼Œé‚£ä¹ˆ exec å‘½ä»¤åº”è¯¥å·²ç»éå¸¸ç†Ÿæ‚‰äº†\næœåŠ¡å‘ç° è™½ç„¶ service æä¾›äº†ä¸€ä¸ªç»Ÿä¸€è®¿é—®çš„ pod çš„é€”å¾„ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šè®¿é—®è€…åˆå¦‚ä½•çŸ¥é“ service çš„ IP åœ°å€ï¼Ÿéš¾é“è¿˜æ˜¯éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹ service çš„ IP ç„¶åå‘Šè¯‰è®¿é—®è€…å—ï¼Ÿé‚£è¿™ä¸æ˜¯æäº†ä¸ªå¯‚å¯å—ï¼Œä¸è¿‡ä¸ç”¨ç€æ€¥ï¼Œä½ æƒ³åˆ°çš„ k8s éƒ½æƒ³åˆ°äº†ï¼Œå¹¶ä¸”ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼š service æœåŠ¡å‘ç°ã€‚\nk8s æä¾›çš„æœåŠ¡å‘ç°æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š\nä½¿ç”¨ç¯å¢ƒå˜é‡ k8s å¯ä»¥ä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­åŒ…æ‹¬å…¶ä»– Podã€Service å’Œ Kubernetes API Server çš„åœ°å€ä¿¡æ¯ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡æœåŠ¡å‘ç°ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è®¿é—®å®¹å™¨çš„ç¯å¢ƒå˜é‡æ¥å‘ç°å’Œè®¿é—®å…¶ä»– Pod å’Œ Serviceã€‚\nâš ï¸ è¿™ç§æ–¹å¼éœ€è¦ service å…ˆäº pod åˆ›å»ºï¼Œè¿™æ ·åœ¨ pod åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œk8s ä¼šå°†å…¶ æ‰€å±çš„ service åœ°å€å†™å…¥åˆ°å…¶ç¯å¢ƒå˜é‡ä¸­ï¼Œpod é€šè¿‡ç¯å¢ƒå˜é‡å°±å¯ä»¥çŸ¥é“ service çš„åœ° å€äº†ã€‚\nservice çš„ç¯å¢ƒå˜é‡åæ ¼å¼æ˜¯ \u0026lt;SERVICE_NAME\u0026gt;_SERVICE_HOST å’Œ \u0026lt;SERVICE_NAME\u0026gt;_SERVICE_PORTï¼Œå…¶ä¸­ \u0026lt;SERVICE_NAME\u0026gt; æ˜¯ Service çš„åç§°ï¼ŒSERVICE_HOST å’Œ SERVICE_PORT æ˜¯å›ºå®šçš„åç¼€ã€‚Service name ä¼šè½¬æ¢ä¸ºå…¨å¤§å†™ï¼Œå¹¶ä¸”å…¶ä¸­çš„ - ä¼šè½¬æ¢ä¸ºä¸‹åˆ’çº¿ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸€ä¸ªåä¸º my-service çš„ Serviceï¼Œå®ƒçš„ Cluster IP ä¸º 10.0.0.1ï¼Œç«¯å£ä¸º 8080ï¼Œåˆ™ k8s ä¼šåœ¨ Pod ä¸­ä¸ºå…¶åˆ›å»ºä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼š\nMY_SERVICE_SERVICE_HOSTï¼šå€¼ä¸º 10.0.0.1ã€‚ MY_SERVICE_SERVICE_PORTï¼šå€¼ä¸º 8080ã€‚ å®è·µ service.yaml å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: kubia spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ targetPort: 80 # è½¬å‘åˆ° pod çš„ 80 ç«¯å£ selector: app: nginx # å…·æœ‰ app=nginx æ ‡ç­¾çš„ pod éƒ½å±äºè¯¥ service deploy.yamlï¼Œç”¨äºåˆ›å»º nginx podï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 è®¿é—®è€…çš„ pod yamlï¼Œä½¿ç”¨çš„é•œåƒæ˜¯ä¸€ä¸ª go ç¨‹åºï¼Œéœ€è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ service host çš„ç¯å¢ƒå˜é‡åå’Œ port çš„ç¯å¢ƒå˜é‡åï¼Œå‰é¢æåˆ°è¿‡è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡çš„å‘½åè§„åˆ™ï¼Œå› ä¸ºæˆ‘åˆ›å»ºçš„ service name æ˜¯ kubiaï¼Œæ‰€ä»¥ä¸¤ä¸ªç¯å¢ƒå˜é‡ååˆ†åˆ«æ˜¯ï¼šKUBIA_SERVICE_HOST å’Œ KUBIA_SERVICE_PORTã€‚ç„¶åè¿™ä¸ªç¨‹åºä¼šæ‹¿åˆ°è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡çš„ valueï¼Œå†é€šè¿‡è¿™ä¸¤ä¸ª value æ‹¼æ¥æˆ URLï¼Œæœ€åé€šè¿‡ http æ¥è®¿é—® nginxï¼ŒæœŸæœ›ç»“æœä¼šè¾“å‡º nginx çš„ index.htmlï¼Œä¹Ÿå°±æ˜¯æ¬¢è¿é¡µé¢ã€‚\napiVersion: v1 kind: Pod metadata: name: http-get spec: containers: - name: http-get image: stdoutt/service-env-test args: [\u0026quot;-hostEnv\u0026quot;, \u0026quot;KUBIA_SERVICE_HOST\u0026quot;, \u0026quot;-portEnv\u0026quot;, \u0026quot;KUBIA_SERVICE_PORT\u0026quot;] æ³¨æ„è¿™é‡Œéœ€è¦å…ˆåˆ›å»º serviceï¼Œå†åˆ›å»º deployï¼Œæœ€åå†åˆ›å»º http-get podã€‚\nåˆ›å»ºå®¢æˆ·ç«¯ podï¼š\n$ kubectl apply -f http-get.yaml pod/http-get created æŸ¥çœ‹ pod æ—¥å¿—ï¼š\n$ kubectl logs http-get # ç¨‹åºä¼šæ‰“å°å‡ºä¸¤ä¸ªç¯å¢ƒå˜é‡ KUBIA_SERVICE_HOST:10.43.65.224 KUBIA_SERVICE_PORT:80 url: http://10.43.65.224:80 # nginx index.html æˆåŠŸè¾“å‡ºäº† \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; é€šè¿‡æ—¥å¿—å†…å®¹ï¼Œè¯´æ˜ pod æˆåŠŸé€šè¿‡ç¯å¢ƒå˜é‡è·å–åˆ°äº† service çš„åœ°å€ï¼Œå¹¶é€šè¿‡ service è®¿é—®åˆ°äº† podã€‚\né™„ï¼š\nhttp-get å¯¹åº”é•œåƒ stdoutt/service-env-test çš„æºç å’Œ Dockerfileï¼š\ngo æºç ï¼š\npackage main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;os\u0026quot; ) var hostServiceEnvName = flag.String(\u0026quot;hostEnv\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;k8s service host env name\u0026quot;) var portServiceEnvName = flag.String(\u0026quot;portEnv\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;k8s service port env name\u0026quot;) func main() { flag.Parse() host := os.Getenv(*hostServiceEnvName) port := os.Getenv(*portServiceEnvName) url_ := fmt.Sprintf(\u0026quot;http://%v:%v\u0026quot;, host, port) fmt.Printf(\u0026quot;%v:%v\\n\u0026quot;, *hostServiceEnvName, host) fmt.Printf(\u0026quot;%v:%v\\n\u0026quot;, *portServiceEnvName, port) fmt.Printf(\u0026quot;url: %v\\n\u0026quot;, url_) resp, err := http.Get(url_) if err != nil { panic(err) } defer resp.Body.Close() b, err := io.ReadAll(resp.Body) if err != nil { panic(err) } fmt.Println(string(b)) } Dockerfile\nFROM golang:alpine AS builder # ç§»åŠ¨åˆ°å·¥ä½œç›®å½•ï¼š/build WORKDIR /build # å°†ä»£ç å¤åˆ¶åˆ°å®¹å™¨ä¸­ COPY . . # å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ app RUN go build -o app . ################### # æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªå°é•œåƒ ################### FROM scratch # ä»builderé•œåƒä¸­æŠŠ/dist/app æ‹·è´åˆ°å½“å‰ç›®å½• COPY --from=builder /build/app / # éœ€è¦è¿è¡Œçš„å‘½ä»¤ ENTRYPOINT [\u0026quot;/app\u0026quot;] å¦‚æœä½ æƒ³æ„å»ºå¤šæ¶æ„é•œåƒï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š\ndocker buildx create --name mybuilder --use docker buildx build -t \u0026lt;repo/imagename\u0026gt; --platform=linux/arm64,linux/amd64 . --push ä½¿ç”¨ DNS é™¤äº†ç¯å¢ƒå˜é‡å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ï¼šé€šè¿‡ DNS å‘ç°æœåŠ¡ï¼Œä¹‹åä¾¿å¯ä»¥é€šè¿‡ FQDN è¿›è¡Œè®¿é—®ï¼Œæ ¼å¼ç±»ä¼¼äºï¼šbackend-database.default.svc.cluster.localï¼Œå…¶ä¸­ backend-database æ˜¯ service çš„åå­—ï¼Œdefault æ˜¯ service æ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œsvc.cluster.local æ˜¯åœ¨æ‰€æœ‰é›†ç¾¤æœ¬åœ°æœåŠ¡åç§°ä¸­ä½¿ç”¨çš„å¯é…ç½®é›†ç¾¤åŸŸåç¼€ï¼ˆè¿™é‡Œä¸æ‡‚ï¼‰ã€‚\nâš ï¸ å®¢æˆ·ç«¯ä»ç„¶éœ€è¦çŸ¥é“æœåŠ¡çš„ç«¯å£å·ã€‚å¦‚æœæœåŠ¡ä½¿ç”¨æ ‡å‡†ç«¯å£å·(ä¾‹å¦‚ï¼ŒHTTP çš„ 80 ç«¯å£æˆ– Postgres çš„ 5432 ç«¯å£)ï¼Œè¿™æ ·æ˜¯æ²¡é—®é¢˜çš„ã€‚ å¦‚æœå¹¶ä¸æ˜¯æ ‡å‡†ç«¯å£ï¼Œ å®¢æˆ·ç«¯å¯ä»¥ä»ç¯å¢ƒå˜é‡ä¸­è·å–ç«¯å£å· ã€‚\nï¼ˆæ‘˜æŠ„è‡ªä¹¦ä¸Šï¼‰\nè¿™é‡Œæ²¡çœ‹æ‡‚ï¼Œéƒ½ç›´æ¥é€šè¿‡åŸŸåè®¿é—®äº†ï¼Œä¸ºä»€ä¹ˆå®¢æˆ·ç«¯è¿˜éœ€è¦çŸ¥é“ç«¯å£å·ï¼Ÿ\nåˆå­¦æ—¶çš„ä¸€ä¸ªæ¯”è¾ƒ 2 çš„é—®é¢˜ï¼Œè¯´æ˜åŸºç¡€ä¸ç‰¢ï¼ŒåŸŸååªè´Ÿè´£è§£æå‡º IP ï¼Œè€Œåªæœ‰ IP æ²¡æœ‰ç«¯å£å·æ˜¾ç„¶æ˜¯ä¸èƒ½è®¿é—®æœåŠ¡çš„ã€‚\nå¦‚æœè®¿é—® pod å’Œè¢«è®¿é—® pod åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ç”¨ service.name è¿›è¡Œè®¿é—®ï¼Œåé¢çš„å¯ä»¥å…¨éƒ¨çœç•¥ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œç›´æ¥ä½¿ç”¨ service çš„åå­— kubia è¿›è¡Œè®¿é—®ï¼š\n# æŸ¥çœ‹ serviceï¼Œè·å– service çš„åå­— $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 33h kubia ClusterIP 10.43.65.224 \u0026lt;none\u0026gt; 80/TCP 8h # æŸ¥çœ‹æ‰€æœ‰çš„ pod $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-msv7g 1/1 Running 0 8h kubia-8d2gm 1/1 Running 0 8h kubia-r4fcs 1/1 Running 0 8h # é€‰æ‹© 1 ä¸ªå®¹å™¨ï¼Œåœ¨å†…éƒ¨æ‰§è¡Œ curl åŸŸå $ kubectl exec kubia-msv79 -- curl kubia % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; # curl å®Œæ•´åŸŸå $ kubectl exec -it kubia-msv79 -- curl kubia.default.svc.cluster.local \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; å®è·µ éœ€è¦å…ˆå‡†å¤‡ service å’Œ deployï¼Œå¯ä»¥ç›´æ¥æ²¿ç”¨ ä½¿ç”¨ç¯å¢ƒå˜é‡ è¿™ä¸€èŠ‚å®è·µé‡Œçš„ yamlï¼Œå¦å¤–å‡†å¤‡ä¸€ä¸ª yaml ç”¨æ¥é€šè¿‡ dns å’Œ port è®¿é—® k8s serviceï¼š\nhttpget_dns.yaml\napiVersion: v1 kind: Pod metadata: name: http-get spec: containers: - name: http-get image: stdoutt/service-dns-test args: [\u0026quot;-dns\u0026quot;, \u0026quot;kubia.default.svc.cluster.local\u0026quot;, \u0026quot;-p\u0026quot;, \u0026quot;80\u0026quot;] è¿™ä¸ªé•œåƒéœ€è¦æä¾›ä¸¤ä¸ªå‚æ•° -dns å’Œ -pï¼Œé¡¾åæ€ä¹‰ï¼Œåˆ†åˆ«å¯¹åº” dns å’Œ portï¼Œç„¶åç¨‹åºä¼šæ ¹æ® dns è§£æå‡ºå¯¹åº”çš„ IPï¼Œå¹¶å°† IP å’Œ port æ‹¼æ¥æˆä¸€ä¸ª HTTP URLï¼Œå¹¶é€šè¿‡ HTTP è®¿é—®ã€‚\nè¿è¡Œå¹¶æŸ¥çœ‹æ•ˆæœï¼š\n$ kubectl apply -f httpget_dns.yaml pod/http-get created $ kubectl get po NAME READY STATUS RESTARTS AGE http-get 0/1 ContainerCreating 0 11s nginx-deployment-ff6774dc6-4nz9z 1/1 Running 2 (51m ago) 23h nginx-deployment-ff6774dc6-cwn7p 1/1 Running 2 (51m ago) 23h nginx-deployment-ff6774dc6-pjxhk 1/1 Running 2 (51m ago) 23h http-get 0/1 Completed 0 21s # é€šè¿‡ log æŸ¥çœ‹æ•ˆæœ $ kubectl logs http-get # è¿™é‡Œä¼šè¾“å‡ºé€šè¿‡ dns è§£æåˆ°çš„ ip http://10.110.49.109:80 # è¾“å‡ºäº† nginx çš„æ¬¢è¿é¡µé¢ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; é™„ï¼š\nhttp-get å¯¹åº”é•œåƒ stdoutt/service-dns-test çš„æºç å’Œ Dockerfileï¼š\ngo æºç ï¼š\npackage main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; \u0026quot;net\u0026quot; \u0026quot;net/http\u0026quot; ) func main() { var ( dns string port string ) flag.StringVar(\u0026amp;dns, \u0026quot;dns\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;dns\u0026quot;) flag.StringVar(\u0026amp;port, \u0026quot;p\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;port\u0026quot;) flag.Parse() if dns == \u0026quot;\u0026quot; || port == \u0026quot;\u0026quot; { panic(\u0026quot;dns must not null\u0026quot;) } addrs, err := net.LookupIP(dns) if err != nil { panic(err) } var httpGet = func(url string) { resp, err := http.Get(url) if err != nil { panic(err) } defer resp.Body.Close() b, err := io.ReadAll(resp.Body) if err != nil { panic(err) } fmt.Println(string(b)) } for _, addr := range addrs { url := fmt.Sprintf(\u0026quot;http://%v:%v\u0026quot;, addr, port) fmt.Println(url) httpGet(url) } } Dockerfile\nFROM golang:alpine AS builder # ç§»åŠ¨åˆ°å·¥ä½œç›®å½•ï¼š/build WORKDIR /build # å°†ä»£ç å¤åˆ¶åˆ°å®¹å™¨ä¸­ COPY . . # å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ app RUN go build -o app . # æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªå°é•œåƒ FROM scratch # ä» builder é•œåƒä¸­æŠŠ /dist/app æ‹·è´åˆ°å½“å‰ç›®å½• COPY --from=builder /build/app / # éœ€è¦è¿è¡Œçš„å‘½ä»¤ ENTRYPOINT [\u0026quot;/app\u0026quot;] build\n$ docker buildx create --name mybuilder --use $ docker buildx build -t \u0026lt;repo/imagename\u0026gt; --platform=linux/arm64,linux/amd64 . --push é›†ç¾¤å†…è®¿é—® ClusterIP é€šè¿‡é›†ç¾¤å†…éƒ¨ IP åœ°å€æš´éœ²æœåŠ¡ï¼Œä½†è¯¥åœ°å€ ä»…åœ¨é›†ç¾¤å†…éƒ¨ å¯è§ã€å¯è¾¾ï¼Œå®ƒæ— æ³•è¢«é›†ç¾¤å¤–éƒ¨çš„å®¢æˆ·ç«¯è®¿é—®ï¼Œæ˜¯ service çš„é»˜è®¤è®¿é—®ç±»å‹ã€‚å¦‚æœä¸æ˜ç¡®æŒ‡å®š clusterIPï¼Œåˆ™ç”± K8S åŠ¨æ€æŒ‡å®šä¸€ä¸ªï¼Œä¹Ÿæ”¯æŒç”¨æˆ·æ‰‹åŠ¨æ˜ç¡®æŒ‡å®šã€‚\nä¸‹é¢è¿™ä¸ª yaml åˆ›å»ºäº†ä¸€ä¸ªæ²¡æœ‰æ˜ç¡®æŒ‡å®š clusterIP çš„ serviceï¼Œä»¥åŠä¸€ä¸ªåˆ›å»º nginx çš„ rsï¼š\n--- apiVersion: v1 kind: Service metadata: name: nginx-service spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ selector: app: nginx --- apiVersion: apps/v1 kind: ReplicaSet metadata: name: nginx-rs spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 --- è¿è¡ŒåæŸ¥çœ‹ï¼š\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 31h nginx-service ClusterIP 10.43.27.242 \u0026lt;none\u0026gt; 80/TCP 7h9m $ kubectl describe svc nginx-service Name: nginx-service Namespace: default Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; Selector: app=nginx Type: ClusterIP IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.27.242 IPs: 10.43.27.242 Port: \u0026lt;unset\u0026gt; 80/TCP TargetPort: 80/TCP Endpoints: 10.42.0.30:80,10.42.0.32:80,10.42.0.36:80 Session Affinity: None Events: \u0026lt;none\u0026gt; $ curl 10.43.27.242 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; å‘ç°è¿™ä¸ª service æ˜¯ ClusterIP ç±»å‹çš„ï¼Œä¸” k8s è‡ªåŠ¨æŒ‡å®šäº†ä¸€ä¸ªåœ°å€ï¼Œå¹¶ä¸”å¯ä»¥æˆåŠŸè®¿é—®ã€‚\nä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ª clusterIPï¼Œåœ¨ä¸Šé¢çš„ yaml çš„ service éƒ¨åˆ†ä¸­ä¿®æ”¹ä¸€ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: nginx-service1 # èµ·ä¸ªæ–°åå­— spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ clusterIP: 10.43.27.66 # æ‰‹åŠ¨æŒ‡å®š ip selector: app: nginx è¿è¡Œï¼š\n$ kubectl apply -f svc_clusterip.yaml service/nginx-service1 created $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 32h nginx-service ClusterIP 10.43.27.242 \u0026lt;none\u0026gt; 80/TCP 7h16m nginx-service1 ClusterIP 10.43.27.66 \u0026lt;none\u0026gt; 80/TCP 10s $ curl 10.43.27.66 # å¯ä»¥æˆåŠŸè®¿é—® \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; ä½†æ˜¯ä¸æ¨èæ‰‹åŠ¨æŒ‡å®š clusterIPï¼Œå¯èƒ½ä¼šé€ æˆ IP å†²çªã€‚\nä½¿ç”¨ kube-proxy è®©å¤–éƒ¨è®¿é—® ClusterIP Service æ­£å¸¸æ¥è¯´ ClusterIP ç±»å‹çš„ Service æ˜¯æ— æ³•ä»å¤–éƒ¨è®¿é—®çš„ï¼Œä½†æ˜¯æœ‰ç§ç‰¹æ®Šçš„æ–¹æ³•å¯ä»¥â€”â€”ä½¿ç”¨ kube-proxyï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾ä¸­çš„ proxy éƒ¨åˆ†ã€‚\nå…·ä½“çš„æµç¨‹ï¼š\né¦–å…ˆåœ¨é›†ç¾¤å†…èŠ‚ç‚¹æ‰§è¡Œï¼š\n$ kubectl proxy --address='0.0.0.0' --accept-hosts='^*$' --port=8081 æ³¨æ„è¦åŠ ä¸Š --address å’Œ --accept-hostsï¼Œå¦åˆ™è®¿é—®ä¼šè¿”å› Forbiddenã€‚\nç„¶ååœ¨å¤–éƒ¨æœºå™¨æ‰§è¡Œä»¥ä¸‹æ ¼å¼è¯­å¥è¿›è¡Œè®¿é—®ï¼š\n$ curl http://[nodeIP]:[port]/api/v1/namespaces/[namespace-name]/services/[service-name]/proxy æ¯”å¦‚ï¼š\n$ curl -X GET -L http://192.168.31.50:8081/api/v1/namespaces/default/services/nginx/proxy PS: \u0026ldquo;curl -L\u0026rdquo; ä¸­çš„ \u0026ldquo;-L\u0026rdquo; æ˜¯ curl å‘½ä»¤ä¸­çš„é€‰é¡¹ï¼Œå®ƒçš„å«ä¹‰æ˜¯ \u0026ldquo;Follow any redirections\u0026rdquo;. ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›äº†ä¸€ä¸ªé‡å®šå‘å“åº”ï¼Œé‚£ä¹ˆ curl å‘½ä»¤å°±ä¼šè‡ªåŠ¨è·Ÿéšé‡å®šå‘å¹¶è¯·æ±‚é‡å®šå‘çš„åœ°å€ã€‚\nåœ¨æˆ‘çš„æœºå™¨ä¸Šæµ‹è¯•ï¼Œ-X GET å¯ä»¥ä¸æŒ‡å®šï¼Œä½†æ˜¯ -L ä¸€å®šè¦æŒ‡å®šï¼Œå¦åˆ™è¿”å›ç»“æœä¸ºç©º\næ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼ NodePortï¼Œä¹Ÿæ˜¯ä½¿ç”¨èŠ‚ç‚¹ IP + proxy å¼€å¯çš„ç«¯å£è¿›è¡Œè®¿é—®ï¼Œä¸è¿‡å‰ææ˜¯ä½ çš„å¤–éƒ¨æœºå™¨å¯ä»¥é€šè¿‡ IP è®¿é—®åˆ°è¿™ä¸ªèŠ‚ç‚¹\nå¯¹å¤–è®¿é—® å‚è€ƒï¼š\nKubernetes NodePort vs LoadBalancer vs Ingressï¼Ÿ æˆ‘ä»¬åº”è¯¥ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ\nKubernetes NodePort vs LoadBalancer vs Ingressï¼Ÿ æˆ‘ä»¬åº”è¯¥ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿï¼ˆåŸæ–‡ï¼‰\nå‰é¢æåˆ°çš„è¿™äº›éƒ½ä»…é™äºé›†ç¾¤çš„å†…éƒ¨è®¿é—®ï¼Œé›†ç¾¤å¤–æ˜¯æ— æ³•è®¿é—®çš„ï¼Œæ¯”å¦‚ä¸Šé¢çš„ service IP æ˜¯ 10.43.65.224ï¼Œè¿™åªåœ¨é›†ç¾¤å†…å¯ä»¥ curl ï¼Œé›†ç¾¤å¤–æ˜¯ä¸è¡Œçš„ï¼Œè€Œä¸”è¿™ä¸ª IP å³ä¾¿æ˜¯åœ¨é›†ç¾¤å†…ä¹Ÿæ˜¯æ— æ³• ping é€šçš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿ IP åœ°å€ã€‚\næœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼å¯ä»¥å°† service æš´éœ²ç»™é›†ç¾¤å¤–éƒ¨ï¼š\nNodePort NodePort ä¼šåœ¨ æ¯ä¸ª node ä¸Šå¼€å¯ä¸€ä¸ªç«¯å£ ç”¨æ¥è®¿é—® serviceï¼Œè¿™ä¸ªç«¯å£å®šä¹‰åœ¨ spec.ports[0].nodePortï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ èŠ‚ç‚¹IP:nodePort è¿›è¡Œè®¿é—®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ serviceIP:port è®¿é—®ï¼ˆè¿™ç§æ–¹å¼å…¶å®å°±æ˜¯å‰é¢ä»‹ç»çš„å¸¸è§„ service è®¿é—®æ–¹å¼ï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰ï¼ŒnodePort ä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œä¼šéšæœºä» 30000-32767 ä¸­é€‰æ‹©ä¸€ä¸ªã€‚\nå®è·µï¼š\néœ€è¦å‡†å¤‡ä»¥ä¸‹ yamlï¼š\nç”¨æ¥åˆ›å»º nginx deployment çš„ yamlï¼š apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 2 selector: matchLabels: # manage pods with the label app: nginx app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 åˆ›å»º NodePort ç±»å‹çš„ serviceï¼Œç”¨æ¥è®¿é—® nginx podï¼š apiVersion: v1 kind: Service metadata: name: kubia-node-port spec: type: NodePort ports: - port: 80 # è¯¥ service çš„ç«¯å£ targetPort: 80 # è½¬å‘åˆ° pod çš„ 80 ç«¯å£ nodePort: 30123 # 30000-32767 ä¹‹é—´ selector: app: nginx ä¹‹åä½¿ç”¨ apply -f æ‰§è¡Œä¸Šé¢çš„ä¸¤ä¸ª yamlï¼ˆè¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼‰\næŸ¥çœ‹ serviceï¼š\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 13d kubia-node-port NodePort 10.43.21.78 \u0026lt;none\u0026gt; 80:30123/TCP 6m12s æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„ IP åŠ  30123 ç«¯å£è¿›è¡Œè®¿é—®äº†ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯ï¼š\n$ ifconfig | grep 192 inet 192.168.64.4 netmask 255.255.255.0 broadcast 192.168.64.255 $ curl 192.168.64.4:30123 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; LoadBalance LoadBalanceï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼šå¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„ IPï¼Œè¿™ä¸ª IP å°±æ˜¯è´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒä¼šå°†ç”¨æˆ·è¯·æ±‚è´Ÿè½½å‡è¡¡çš„åˆ†å‘ç»™ podï¼Œæˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œå®ƒåœ¨ NodePort çš„åŸºç¡€ä¸Šåˆæ·»åŠ äº†ä¸€å±‚ç±»ä¼¼ä»£ç†å±‚çš„ä¸œè¥¿ï¼Œè®©å®¢æˆ·ç«¯è®¿é—®æ›´åŠ æ–¹ä¾¿ã€‚\nä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æ­¤æ—¶æœ‰ 2 ä¸ªå·¥ä½œèŠ‚ç‚¹ 1.1.1.1 å’Œ 2.2.2.2ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ 3 ä¸ª nginx podï¼ŒnodePort ä¸º 30000ï¼Œé‚£ä¹ˆåœ¨ NodePort ä¸‹ï¼Œå®¢æˆ·ç«¯è®¿é—®éœ€è¦æŒ‡å®šæŸä¸ª node çš„å…·ä½“ IPï¼Œæ¯”å¦‚ 1.1.1.1:30000 æˆ–è€… 2.2.2.2:30000ï¼›å¦‚æœä½¿ç”¨ loadBalance çš„è¯ï¼Œåˆ™ä¼šæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¬ç½‘ IPï¼ˆæ¯”å¦‚ 180.1.1.1ï¼‰ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨æˆ·åªè¦è®¿é—®è¿™ä¸ª IP å°±å¯ä»¥ï¼ˆå½“ç„¶è¿˜è¦æ·»åŠ ç«¯å£å·ï¼‰ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šè´Ÿè½½å‡è¡¡çš„æŠŠè¯·æ±‚åˆ†å‘åˆ° 1.1.1.1:30000 æˆ–è€… 2.2.2.2:30000ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„ loadBalance yamlï¼š\napiVersion: vl kind: Service metadata: name: kubia-loadbalancer spec: type: LoadBalancer ports: - port: 80 # loadBalance çš„ç«¯å£ targetPort: 8080 # è½¬å‘åˆ° pod çš„ 8080 ç«¯å£ nodePort: 30000 selector: app: kubia LoadBalance é€šå¸¸ç”±äº‘æœåŠ¡å•†æä¾›ï¼Œæ‰€ä»¥å®è·µèµ·æ¥å¯èƒ½éº»çƒ¦ä¸€äº›ï¼Œéœ€è¦åœ¨è…¾è®¯äº‘è¿™ç§å¹³å°ä¸Šå®è·µï¼Œå¥½åƒä¹Ÿæœ‰ä¸€äº›ç»„ä»¶å¯ä»¥æä¾›æœ¬åœ°çš„ä½¿ç”¨ï¼Œè¿™éƒ¨åˆ†æˆ‘è¿˜æ²¡æœ‰å»äº†è§£ã€‚\nIngress ä¸ªäººåæ§½ï¼ˆè¯·å¿½è§†ï¼‰ï¼š\nè¿™ä¸ªç©æ„æ˜¯æˆ‘ç›®å‰ä¸ºæ­¢ç”¨çš„æœ€è›‹ç–¼çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸æ˜¯ä¸å¥½ç”¨ï¼Œè€Œæ˜¯è¿ç”¨éƒ½ç”¨ä¸ä¸Šï¼Œæˆ‘åœ¨ minikube ä¸Šä½¿ç”¨çš„ ingress-nginx å› ä¸ºæ‹‰å–çš„é•œåƒåœ°å€è¢«å¢™ï¼Œå¯¼è‡´æ ¹æœ¬æ— æ³•å¼€å¯ ingress æœåŠ¡ï¼Œåˆå› ä¸ºæˆ‘çš„ minikube æ˜¯è·‘åœ¨ multipass è™šæ‹Ÿæœºä¸Šçš„ï¼Œä¸çŸ¥é“å¦‚ä½•å…±äº«å®¿ä¸»æœºçš„ vpnï¼Œå¯¼è‡´è¿™ä¸ªé—®é¢˜ä¸€ç›´æ— æ³•è§£å†³ï¼Œä¸å¾—ä¸åæ§½ä¸€ä¸‹ï¼Œm1 çš„ç”Ÿæ€è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œå°±è™šæ‹Ÿæœºè¿™å—ï¼Œæˆ‘æ‰¾äº†åŠå¤©ï¼ŒåŸºæœ¬èƒ½ç”¨çš„åªæœ‰è¿™ä¸ªç®€é™‹çš„ multipass ï¼ˆæ”¶è´¹çš„ parallels æ²¡æœ‰å°è¯•ï¼‰ï¼Œvmware ç›´æ¥æ— æ³•è¿è¡Œï¼ˆæç¤ºä»€ä¹ˆè¯¥è½¯ä»¶åŸºäº Intel ä½†å´å°è¯•ä½¿ç”¨ rosetta2 è¿è¡Œï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ª virtualBox ï¼Œè¿™ä¸ªæˆ‘ç›´æ¥æ‡’å¾—ä¸‹äº†ï¼Œæ®è¯´éƒ½ä¸æ”¯æŒ m1ï¼Œè€Œä¸”è¿™ç§ç½‘ç»œé—®é¢˜æå¾—æˆ‘çœŸçš„å¾ˆå¤´å¤§ï¼Œä¸å¾—ä¸åæ§½ä¸€ä¸‹å¤©æœçš„ç½‘ç»œï¼ŒèŠ±è´¹å¤§æŠŠæ—¶é—´å»è§£å†³ç½‘ç»œé—®é¢˜ï¼Œè¿˜æœ‰çœ‹è§æŸä¸ªæµç¨‹ä¸€ç›´å¡åœ¨ pull ä¸Šï¼Œè®©äººæœ‰ä¸€ç§æƒ³ç ¸æ‰ç”µè„‘çš„å†²åŠ¨ï¼Œæœ€è›‹ç–¼çš„æ˜¯è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰ä»€ä¹ˆé è°±çš„è§£å†³æ–¹å¼ï¼Œåœ¨ minikube å’Œ ingress-nginx çš„ github ä¸Šæ‰¾åˆ°äº†å…³äºå›½å†…æ‹‰å–çš„ issueï¼Œä½†æ˜¯åŸºæœ¬ä¹Ÿæ²¡ä»€ä¹ˆæœ‰ç”¨çš„ç­”æ¡ˆï¼Œè¿˜æœ‰ä¸€äº›ç½‘ä¸Šçš„æ•™ç¨‹ï¼Œç»™çš„ä¿®æ”¹ç‰ˆ yaml ç›´æ¥è·‘éƒ½è·‘ä¸èµ·æ¥ã€‚\nåœ¨ mac ä¸Šè·‘ minikube å¯ä»¥æˆåŠŸå¼€å¯ ingress æ’ä»¶ï¼Œä½†æ˜¯åˆä¼šæŠ¥ Because you are using a Docker driver on darwin, the terminal needs to be open to run it é”™è¯¯ï¼Œç½‘ä¸Šæ‰¾äº†åŠå¤©ä¹Ÿæ²¡çœ‹è§ä¸€ä¸ªèƒ½ç”¨çš„è§£å†³æ–¹æ³•\næŠ˜è…¾äº†ä¸€å¤©éƒ½æ²¡æŠŠ ingress ç»™è·‘èµ·æ¥ï¼Œæ„Ÿè§‰æ˜¯åœ¨çº¯çº¯çš„æµªè´¹æ—¶é—´\nLoadBalance çš„æ–¹å¼å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼šåªèƒ½ä¸ºä¸€ç§ç±»å‹çš„ service æä¾›æœåŠ¡ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä»‹ç»çš„ loadbalance åªæ˜¯ç”¨æ¥è®¿é—® nginx çš„ï¼Œå¦‚æœç°åœ¨é›†ç¾¤æ·»åŠ äº†ä¸€äº› redis podï¼Œé‚£ä¹ˆåˆè¦æ–°åˆ›å»ºä¸€ä¸ª LoadBalance æ¥æä¾›å¯¹å¤–æœåŠ¡ï¼ˆæ¯”å¦‚ spec.ports[0].port=6379, target=6379, nodePort=30001ï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡ LoadBalanceIP:30000 è¿™ä¸ªåœ°å€æ¥å®Œæˆå¯¹ nginx pod çš„è®¿é—®ï¼Œé€šè¿‡ LoadBalanceIP:30001 æ¥å®Œæˆå¯¹ redis pod çš„è®¿é—®ï¼Œå› ä¸º LoadBalanceIP æ˜¯å…¬ç½‘ IPï¼Œæ‰€ä»¥è¿™ä¹ˆææ— ç–‘æœ‰ç‚¹æµªè´¹ã€‚\nä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œingress è¿™ä¸ªç©æ„å°±åº”è¿è€Œç”Ÿäº†ï¼Œè¿™ä¸ªä¸œè¥¿å…¶å®è¯´ç™½äº†å°±æ˜¯ service çš„ serviceï¼ˆæ— é™å¥—å¨ƒï¼Ÿï¼‰ï¼Œç±»ä¼¼äº web è·¯ç”±çš„åŠŸèƒ½ï¼Œé€šè¿‡è®¿é—®ä¸åŒçš„åŸŸåæ¥å®Œæˆå¯¹ä¸åŒ service çš„è®¿é—®ï¼Œå°±æ¯”å¦‚è¿™å¼ å›¾ï¼š è€Œä¸” ingress å·¥ä½œåœ¨åº”ç”¨å±‚ï¼Œæ‰€ä»¥å¯ä»¥æä¾›ä¸€äº› service ä¸èƒ½å®ç°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚åŸºäº cookie çš„ä¼šè¯äº²å’Œæ€§ (session affinity) ç­‰\nåŸºäº minikube nginx ingress çš„å®è·µ è¯¥å®è·µåŸºäº minikube\nall.yaml\nåŒ…å«äº†ä¸‰ä¸ª pod å’Œä¸‰ä¸ªå¯¹åº”çš„ service\n--- apiVersion: v1 kind: Pod metadata: name: hello-app labels: app: hello-app spec: containers: - name: hello-app image: stdoutt/hello-app-arm64 # æ³¨æ„è¿™é‡Œä½¿ç”¨çš„é•œåƒä»…é€‚ç”¨äº arm64 æœºå™¨ ports: - containerPort: 8080 --- apiVersion: v1 kind: Service metadata: name: hello-app-service spec: type: NodePort ports: - port: 81 # è¯¥ service çš„ç«¯å£ targetPort: 8080 # è½¬å‘åˆ° pod çš„ 8080 ç«¯å£ nodePort: 30111 selector: app: hello-app --- apiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx-service spec: type: NodePort ports: - port: 80 # è¯¥ service çš„ç«¯å£ targetPort: 80 # è½¬å‘åˆ° pod çš„ 80 ç«¯å£ nodePort: 30222 selector: app: nginx --- apiVersion: v1 kind: Pod metadata: name: redis labels: app: redis spec: containers: - name: redis image: redis ports: - containerPort: 6379 --- apiVersion: v1 kind: Service metadata: name: redis-service spec: type: NodePort ports: - port: 82 # è¯¥ service çš„ç«¯å£ targetPort: 6379 # è½¬å‘åˆ° pod çš„ 8080 ç«¯å£ nodePort: 30333 selector: app: redis ingress.yaml\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: example-ingress spec: rules: - host: ingress.example.com http: paths: - path: /redis pathType: Prefix backend: service: name: redis-service port: number: 82 - path: /hello-app pathType: Prefix backend: service: name: hello-app-service port: number: 81 - path: /nginx pathType: Prefix backend: service: name: nginx-service port: number: 80 è¿è¡Œä¸Šé¢çš„ 2 ä¸ª yaml\næŸ¥çœ‹ ingress çš„ ipï¼š\n$ kubectl get ingress NAME CLASS HOSTS ADDRESS PORTS AGE example-ingress nginx ingress.example.com 192.168.49.2 80 9h å°† ingress ip å†™å…¥åˆ° /etc/hostsï¼š\n$ vim /etc/hosts # å†™å…¥è¿™ä¸€æ¡ï¼š192.168.49.2 ingress.example.com é—®é¢˜ï¼š\nè®¿é—® /hello-app å¯ä»¥æ­£å¸¸æ˜¾ç¤ºç»“æœï¼š\n$curl ingress.example.com/hello-app Hello, world! Version: 1.0.0 Hostname: hello-app ä½†æ˜¯ /nginx å’Œ /redis éƒ½æ˜¾ç¤º 404ï¼š\n$ curl ingress.example.com/nginx \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;404 Not Found\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;404 Not Found\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.23.1\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ä½†æ˜¯ç›´æ¥è®¿é—® service åˆæ˜¯é€šçš„ï¼š\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hello-app-service NodePort 10.103.218.83 \u0026lt;none\u0026gt; 81:30111/TCP 9h kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 14h nginx-service NodePort 10.99.214.102 \u0026lt;none\u0026gt; 80:30222/TCP 9h redis-service NodePort 10.104.106.67 \u0026lt;none\u0026gt; 82:30333/TCP 9h $ minikube ip 192.168.49.2 $ curl 192.168.49.2:30222 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026quot;http://nginx.org/\u0026quot;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026quot;http://nginx.com/\u0026quot;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ps: minikube å¦‚æœæƒ³è®¿é—® serviceï¼Œéœ€è¦å°† service å®šä¹‰ä¸º nodePort ç±»å‹ï¼Œç„¶åé€šè¿‡ minikube ip å‘½ä»¤æ¥è·å– minikube çš„ ipï¼Œç„¶åç”¨ \u0026lt;minikube_IP:nodePort\u0026gt; çš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚ä¼¼ä¹ä¸èƒ½ç›´æ¥åœ¨é›†ç¾¤å†…é€šè¿‡ curl ClusterIP çš„æ–¹å¼æ¥è®¿é—® serviceã€‚\nè§£å†³æ–¹æ³•ï¼š\nåœ¨ ingress.yaml ä¸­æ·»åŠ  nginx.ingress.kubernetes.io/rewrite-target: / æ³¨è§£\nä¿®æ”¹åçš„ metadataï¼š\nmetadata: name: example-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: / ç°åœ¨è¯•è¯•è®¿é—® /nginxï¼š\n$ curl ingress.example.com/nginx \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026quot;http://nginx.org/\u0026quot;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026quot;http://nginx.com/\u0026quot;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å¯ä»¥çœ‹åˆ°æˆåŠŸä½¿ç”¨ ingress è®¿é—®äº† nginx ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„ 404ã€‚\nä½†æ˜¯è®¿é—® /redis ä¼šæŠ¥ 502 é”™è¯¯ï¼ˆå¯èƒ½å¯¹äº ingress è€Œè¨€ï¼Œredis ä¸æ˜¯ä¸€ä¸ªå¥½çš„ä¾‹å­ï¼‰ï¼š\n$ curl ingress.example.com/redis \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;502 Bad Gateway\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;502 Bad Gateway\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; è¿™é‡Œæš‚æ—¶ä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œæ„Ÿè§‰è¿™é‡Œç”¨ redis æ¥åšå®è·µæœ¬èº«ä¹Ÿä¸å¤ªåˆç†ï¼Œæ¯•ç«Ÿ curl redis æœ¬æ¥å°±ä¸ä¼šæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯ç”¨ redis-cli é€šè¿‡è®¿é—® service çš„æ–¹å¼å¯ä»¥æ­£å¸¸å·¥ä½œï¼š\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hello-app-service NodePort 10.103.218.83 \u0026lt;none\u0026gt; 81:30111/TCP 12h kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 17h nginx-service NodePort 10.99.214.102 \u0026lt;none\u0026gt; 80:30222/TCP 12h redis-service NodePort 10.104.106.67 \u0026lt;none\u0026gt; 82:30333/TCP 12h $ k8s minikube ip 192.168.49.2 $ redis-cli -h 192.168.49.2 -p 30333 192.168.49.2:30333\u0026gt; keys * 1) \u0026quot;1\u0026quot; 192.168.49.2:30333\u0026gt; ä½†æ˜¯ç”¨ ingress çš„åœ°å€è®¿é—®æ˜¯ä¸è¡Œçš„ï¼š\n$ redis-cli -h ingress.example.com/redis -p 82 Could not connect to Redis at ingress.example.com/redis:82: Name or service not known not connected\u0026gt; $ redis-cli -h ingress.example.com/redis -p 30333 Could not connect to Redis at ingress.example.com/redis:30333: Name or service not known not connected\u0026gt; è¿™ä¸ªé—®é¢˜æš‚æ—¶å°†å…¶æç½®ï¼Œæ¯•ç«Ÿè¿™é‡Œä¸»è¦è¿˜æ˜¯ä»¥å­¦ä¹  ingress ä¸ºä¸»ã€‚\nç‰¹æ®Šçš„ headless service service æä¾›äº†ç¨³å®šçš„å¯¹å¤–è®¿é—®æœåŠ¡ï¼ŒåŒæ—¶è¿˜æä¾›äº†è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œæ¯æ¬¡è®¿é—® serviceï¼Œéƒ½ä¼šå°†å…¶è½¬å‘åˆ°è¯¥ service selector å¯¹åº”çš„ pod ä¸­çš„æŸä¸€ä¸ªï¼Œå…·ä½“è½¬å‘ç»™å“ªä¸ªæ˜¯ç”± service å†³å®šçš„ï¼Œè®¿é—®è€…æ²¡æœ‰è‡ªä¸»é€‰æ‹©æƒï¼Œä½†æ˜¯å¦‚æœè®¿é—®è€…æƒ³è‡ªä¸»é€‰æ‹©è®¿é—®å“ªä¸ª podï¼Œæˆ–è€…æƒ³è®¿é—®è¯¥ service ä¸‹çš„æ‰€æœ‰ podï¼Œæ­¤æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼Œå°±éœ€è¦ Headless Service é—ªäº®ç™»åœºäº†ã€‚\né¡¾åæ€ä¹‰ï¼Œheadless service ä¸€ç§ç‰¹æ®Šçš„ serviceï¼Œå®ƒæ˜¯æ²¡æœ‰ IP çš„ï¼Œæƒ³è¦è®¿é—®å®ƒï¼Œåªèƒ½é€šè¿‡ DNS çš„æ–¹å¼è®¿é—®ï¼ŒDNS çš„å›ºå®šæ ¼å¼æ˜¯ \u0026lt;service_name\u0026gt;..svc.cluster.localã€‚è€Œè®¿é—® headless service ä¹Ÿä¸åŒäºæ™®é€š service ï¼Œå®ƒä¸ä¼šéšæœºè®¿é—®å…¶ä»£ç†çš„æŸä¸ª podï¼Œè€Œæ˜¯ç›´æ¥å°†å…¶ä»£ç†çš„æ‰€æœ‰ pod çš„ address æä¾›ç»™ä½ ã€‚\né™¤æ­¤ä»¥å¤–ï¼Œå®ƒè¿˜ä¼šä¸º å…¶ä»£ç†çš„æ¯ä¸ª pod çš„ IP åœ°å€ç»‘å®šä¸€ä¸ªå¦‚ä¸‹æ ¼å¼çš„ DNS è®°å½•ï¼š\n\u0026lt;pod_name\u0026gt;.\u0026lt;service_name\u0026gt;..svc.cluster.local\né€šè¿‡ä¸Šé¢è¿™ç§æ ¼å¼çš„ DNS è®°å½•ï¼Œå°±å¯ä»¥è·å– headless service ä¸‹çš„æŸä¸ª pod çš„ IP åœ°å€äº†ã€‚\næ›´æ–°ï¼š\næ„Ÿè§‰ headless service ä¼šä¸ºå…¶ä»£ç†çš„ pod ç”Ÿæˆ DNS ä¸å¤ªå‡†ç¡®ï¼Ÿå› ä¸ºæˆ‘å®è·µäº†ä¸€ä¸‹ï¼Œç”¨ headless service + ç”± rs åˆ›å»ºå‡ºæ¥çš„ podï¼Œç„¶å exec åˆ°éšä¾¿ä¸€ä¸ª pod æ‰§è¡Œ nslookup \u0026lt;pod_name\u0026gt;.\u0026lt;service_name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local æ˜¯æ— æ³•è§£æåˆ°åœ°å€çš„ï¼ŒæŠ¥é”™ server can't find nginx-rs-wzc4r.nginx-service-headless.default.svc.cluster.local: NXDOMAINï¼Œè€Œç”¨ headless service + ç”± StatefulSet åˆ›å»ºå‡ºæ¥çš„ pod åˆ™å¯ä»¥æˆåŠŸè§£æåˆ°åœ°å€ã€‚\nç–‘é—®ï¼šç”¨æˆ·è‡ªè¡Œé€‰æ‹© pod çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿç”¨æˆ·éœ€è¦è®¿é—® service ä¸‹æ‰€æœ‰ pod çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ ç”¨æˆ·è‡ªè¡Œé€‰æ‹© pod çš„åœºæ™¯å¯èƒ½åŒ…æ‹¬ï¼š\nç‰¹å®šçš„æœåŠ¡éœ€è¦è®¿é—®ç‰¹å®šçš„ podï¼Œä¾‹å¦‚éœ€è¦ä½¿ç”¨æŸä¸ª pod ä¸Šç‰¹å®šçš„é…ç½®æˆ–è€…æ•°æ®ã€‚ æµ‹è¯•æˆ–è€…è°ƒè¯•éœ€è¦é’ˆå¯¹ç‰¹å®šçš„ pod è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚åˆ†æç‰¹å®š pod çš„æ—¥å¿—æˆ–è€…æ€§èƒ½æ•°æ®ã€‚ éœ€è¦è®¿é—® service ä¸‹æ‰€æœ‰ pod çš„åœºæ™¯å¯èƒ½åŒ…æ‹¬ï¼š\næ‰§è¡Œæ‰¹é‡æ“ä½œï¼Œä¾‹å¦‚å‘ service ä¸‹æ‰€æœ‰ pod å‘é€æŸä¸ªæŒ‡ä»¤æˆ–è€…è·å–æ‰€æœ‰ pod çš„çŠ¶æ€ä¿¡æ¯ã€‚ åœ¨æœåŠ¡å‘ç°åœºæ™¯ä¸‹ï¼Œéœ€è¦è·å– service ä¸‹æ‰€æœ‰å¯ç”¨çš„ pod åˆ—è¡¨ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ k8s ä¸­ï¼Œç”¨æˆ·ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥è®¿é—® podï¼Œè€Œæ˜¯é€šè¿‡ service æä¾›çš„ç¨³å®šçš„å¯¹å¤–è®¿é—®æœåŠ¡æ¥è®¿é—®åº”ç”¨ç¨‹åºã€‚åªæœ‰åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦ç›´æ¥è®¿é—® podã€‚\nç–‘é—®ï¼šä½¿ç”¨ headless service åï¼Œæ˜¯å¦ä»£è¡¨è´Ÿè½½å‡è¡¡å·²ç»å¤±æ•ˆï¼Œéœ€è¦ç”¨æˆ·è‡ªè¡Œå®ç°ï¼Ÿ å®è·µ 1 è¿™ä¸ªå®è·µå°†ä¼šæµ‹è¯• headless service çš„ç‰¹æ€§ï¼Œå¹¶ä¸”ä¼šå’Œæ™®é€šçš„ service è¿›è¡Œå¯¹æ¯”ï¼ŒåŠ æ·±ç†è§£ã€‚\nä¸‹é¢è¿™ä¸ª yaml ä¼šåˆ›å»ºä¸€ä¸ª nginx rsï¼Œä»¥åŠä¸¤ä¸ªå¯¹åº”çš„ serviceï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸çš„ serviceï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ headless ç±»å‹çš„ serviceï¼š\nï¼ˆpsï¼šå¥½åƒå¦‚æœ pod æŒ‡å®šäº† containerPortï¼Œé‚£ä¹ˆ service è¿™è¾¹å¯ä»¥ä¸æŒ‡å®š targetPortï¼‰\n--- apiVersion: v1 kind: Service metadata: name: nginx-service-headless spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ #targetPort: 8080 # è½¬å‘åˆ° pod çš„ 8080 ç«¯å£ clusterIP: None selector: app: nginx --- apiVersion: v1 kind: Service metadata: name: nginx-service spec: ports: - port: 80 # è¯¥ service çš„ç«¯å£ #targetPort: 8080 # è½¬å‘åˆ° pod çš„ 8080 ç«¯å£ selector: app: nginx --- apiVersion: apps/v1 kind: ReplicaSet metadata: name: nginx-rs spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 --- è¿è¡Œï¼š\n$ kubectl apply -f headless_service_test.yaml service/nginx-service-headless unchanged service/nginx-service created replicaset.apps/nginx-rs unchanged $ kubectl get po NAME READY STATUS RESTARTS AGE nginx-rs-f2b4j 1/1 Running 1 (33m ago) 47m nginx-rs-dhxz7 1/1 Running 1 (33m ago) 47m nginx-rs-sn8wk 1/1 Running 1 (33m ago) 47m dnsutils 1/1 Running 1 (33m ago) 36m $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 24h nginx-service-headless ClusterIP None \u0026lt;none\u0026gt; 80/TCP 48s nginx-service ClusterIP 10.43.27.242 \u0026lt;none\u0026gt; 80/TCP 29s æµ‹è¯•ä¸€ä¸‹æ™®é€šçš„ service èƒ½å¦è®¿é—®ï¼š\n$ curl 10.43.27.242 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; å¯ä»¥çœ‹åˆ°ï¼Œæ™®é€šçš„ service æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ï¼Œä½†æ˜¯ headless service æ˜¯ä¸å¯ä»¥è®¿é—®çš„ï¼Œå› ä¸º headless service æ˜ç¡®æŒ‡å®šäº† clusterIP ä¸º Noneï¼Œæ‰€ä»¥ä¸ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ªé›†ç¾¤å†… IPï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡ curl çš„æ–¹å¼è®¿é—®ã€‚\nä½¿ç”¨ nslookup æŸ¥çœ‹äºŒè€…çš„ dns è§£æï¼Œçœ‹çœ‹ä»–ä»¬ä¸¤çš„åŒºåˆ«ï¼Œservice çš„ dns æ ¼å¼æ˜¯ \u0026lt;service_name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.localï¼Œæ³¨æ„è¿™é‡Œéœ€è¦åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œã€‚\nTips: nginx å®¹å™¨é»˜è®¤åº”è¯¥æ˜¯æ²¡æœ‰å®‰è£… nsloopup çš„ï¼Œä½ éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n$ apt update $ apt install dnsutils $ kubectl exec -it nginx-rs-dhxz7 -- nslookup nginx-service.default.svc.cluster.local Server:\t10.43.0.10 Address:\t10.43.0.10:53 Name:\tnginx-service.default.svc.cluster.local Address: 10.43.27.242 $ kubectl exec -it nginx-rs-dhxz7 -- nslookup nginx-service-headless.default.svc.cluster.local Server:\t10.43.0.10 Address:\t10.43.0.10:53 Name:\tnginx-service-headless.default.svc.cluster.local Address: 10.42.0.36 Name:\tnginx-service-headless.default.svc.cluster.local Address: 10.42.0.32 Name:\tnginx-service-headless.default.svc.cluster.local Address: 10.42.0.30 å‘ç°åŒºåˆ«äº†å—ï¼Ÿæ™®é€šçš„ service åªè¿”å›äº†ä¸€æ¡åœ°å€ï¼Œè¿™æ¡åœ°å€æ­£æ˜¯ service è‡ªèº«çš„ ipï¼Œè€Œ headless service è¿”å›äº† 3 æ¡åœ°å€ï¼Œè¿™ 3 æ¡åœ°å€æ­£æ˜¯ service ä»£ç†çš„å‡ ä¸ª pod çš„åœ°å€ï¼š\n$ kubectl get po -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-rs-f2b4j 1/1 Running 1 (40m ago) 54m 10.42.0.36 ubuntu \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nginx-rs-dhxz7 1/1 Running 1 (40m ago) 54m 10.42.0.30 ubuntu \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nginx-rs-sn8wk 1/1 Running 1 (40m ago) 54m 10.42.0.32 ubuntu \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; dnsutils 1/1 Running 1 (40m ago) 43m 10.42.0.31 ubuntu \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥éªŒè¯ä¸€ä¸‹ headless ä¸ºå…¶ä»£ç†çš„ pod ç”Ÿæˆçš„ DNS è®°å½•ï¼š\nå¾…å®Œæˆï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè§£æä¸å‡º IPï¼ŒæŠ¥é”™ï¼š`server can\u0026rsquo;t find nginx-rs-wzc4r.nginx-service-headless.default.svc.cluster.local: NXDOMAIN\nå®è·µ 2 è¿™ä¸ªå®è·µä¼šç”¨é€šè¿‡ä»£ç çš„æ–¹å¼ï¼Œä» headless service ä¸­è·å– pod åœ°å€ï¼Œç„¶åè®¿é—®è¿™äº› podã€‚\né¦–å…ˆéœ€è¦å‡†å¤‡ä¸‹é¢çš„å‡ ä¸ª yamlã€‚\nDeployment.yaml\nè¿™ä¸ª deploy å°†ä¼šåˆ›å»º 3 ä¸ª podï¼Œæ¯ä¸ª pod éƒ½æ˜¯ä¸€ä¸ª http server ï¼Œé€šè¿‡ -h æ¥æŒ‡å®šåœ°å€ï¼Œ-p æ¥æŒ‡å®šç›‘å¬ç«¯å£ï¼Œè®¿é—®è¯¥ server ä¼šè¿”å›åŒ…æ‹¬ä¸»æœºåç­‰åŸºæœ¬ä¿¡æ¯ã€‚æ³¨æ„è¿™é‡Œçš„ -h éœ€è¦æŒ‡å®šä¸º 0.0.0.0 è€Œä¸æ˜¯ localhostï¼ŒæŒ‡å®šä¸º localhost çš„è¯å…¶ä»– pod å°†æ— æ³•è®¿é—®ã€‚ï¼ˆä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼‰\napiVersion: apps/v1 kind: Deployment metadata: name: hello-app labels: app: hello-app spec: replicas: 3 selector: matchLabels: app: hello-app template: metadata: labels: app: hello-app spec: containers: - name: hello-app image: stdoutt/hello-app args: [\u0026quot;-h\u0026quot;, \u0026quot;0.0.0.0\u0026quot;, \u0026quot;-p\u0026quot;, \u0026quot;8080\u0026quot;] Service.yaml\nè¿™æ˜¯ä¸€ä¸ª headless serviceã€‚\napiVersion: v1 kind: Service metadata: name: hello-app spec: clusterIP: None ports: - port: 80 # è¯¥ service çš„ç«¯å£ targetPort: 8080 # è½¬å‘åˆ° pod çš„ 80 ç«¯å£ selector: app: hello-app # å…·æœ‰ app=hello-app æ ‡ç­¾çš„ pod éƒ½å±äºè¯¥ service httpget.yaml\nè¿™ä¸ª pod é€šè¿‡ -s æ¥æŒ‡å®š headless service çš„ FQDNï¼Œæœ€ç»ˆè¿™ä¸ªé•œåƒå†…éƒ¨çš„ç¨‹åºä¼šè°ƒç”¨ net.LookupSRV è§£æå‡ºæ¯ä¸ª pod å¯¹åº”çš„ SRV è®°å½•ï¼Œç„¶åé€šè¿‡ SRV è®°å½•è¿›è¡Œè®¿é—®ã€‚\napiVersion: v1 kind: Pod metadata: name: http-get spec: containers: - name: http-get image: stdoutt/service-headless-test args: [\u0026quot;-s\u0026quot;, \u0026quot;hello-app.default.svc.cluster.local\u0026quot;, \u0026quot;-p\u0026quot;, \u0026quot;8080\u0026quot;] ç„¶åä¾æ¬¡åˆ›å»º Deploymentï¼Œheadless serviceï¼š\n$ kubectl get deploy NAME READY UP-TO-DATE AVAILABLE AGE hello-app 3/3 3 3 130m $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hello-app ClusterIP None \u0026lt;none\u0026gt; 80/TCP 119m kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 80d $ kubectl get po NAME READY STATUS RESTARTS AGE hello-app-7b5f4475c8-bv8lz 1/1 Running 0 131m hello-app-7b5f4475c8-pcrv8 1/1 Running 0 131m hello-app-7b5f4475c8-wm528 1/1 Running 0 131m æœ€ååˆ›å»º httpgetï¼Œç„¶åç­‰å¾…ä¸€ä¼šï¼Œç­‰ pod èµ·æ¥åï¼Œé€šè¿‡ logs æŸ¥çœ‹è¾“å‡ºï¼š\n$ kubectl apply -f httpget_headless.yaml pod/http-get created # æŸ¥çœ‹ log $ kubectl logs http-get url: http://10-1-0-117.hello-app.default.svc.cluster.local.:8080 Hello, world! Version: 1.0.0 Hostname: hello-app-7b5f4475c8-pcrv8 url: http://10-1-0-118.hello-app.default.svc.cluster.local.:8080 Hello, world! Version: 1.0.0 Hostname: hello-app-7b5f4475c8-bv8lz url: http://10-1-0-116.hello-app.default.svc.cluster.local.:8080 Hello, world! Version: 1.0.0 Hostname: hello-app-7b5f4475c8-wm528 ä» log å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸè®¿é—®åˆ°äº†æ¯ä¸€ä¸ª podï¼Œæ—¥å¿—é‡Œçš„ 3 ä¸ª Hostname å’Œ pod name ç›¸ç¬¦ã€‚\né™„ï¼š\nhttp-get é•œåƒçš„ go æºç ï¼š\né€šè¿‡ net.LookupSRV è§£æå‡º SRV è®°å½•ï¼Œä» SRV é‡Œå¯ä»¥æ‹¿åˆ° taget å’Œ portï¼Œå°†è¿™ä¸ªä¸¤ä¸ªå‚æ•°æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„ HTTP URL è¿›è¡Œè®¿é—®ã€‚\npackage main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; \u0026quot;net\u0026quot; \u0026quot;net/http\u0026quot; ) var ( HeadlessServiceName string ) func main() { flag.StringVar(\u0026amp;HeadlessServiceName, \u0026quot;s\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;headless service name\u0026quot;) flag.Parse() _, addrs, err := net.LookupSRV(\u0026quot;\u0026quot;, \u0026quot;\u0026quot;, HeadlessServiceName) if err != nil { panic(err) } var fn = func(url string) { resp, err := http.Get(url) if err != nil { panic(err) } defer resp.Body.Close() b, err := io.ReadAll(resp.Body) if err != nil { panic(err) } fmt.Println(string(b)) } for _, addr := range addrs { url := fmt.Sprintf(\u0026quot;http://%v:%v\u0026quot;, addr.Target, addr.Port) fmt.Printf(\u0026quot;url: %v\\n\u0026quot;, url) fn(url) } } å¾…è¡¥å……/ç–‘é—®ï¼š\nSRV è®°å½•æ˜¯ä»€ä¹ˆï¼Ÿ\nä¸ºä»€ä¹ˆ net.LookupSRV è¿”å›çš„ SRV.Target æ˜¯ 10-1-0-117.hello-app.default.svc.cluster.local. è¿™æ ·çš„ï¼Œè€Œä¸æ˜¯åƒ nslookup é‚£æ ·ç›´æ¥è¿”å› IPï¼Ÿ\n","date":"2022å¹´05æœˆ08æ—¥","permalink":"/posts/k8s-service/","summary":"ä»€ä¹ˆæ˜¯ service pod å¾€å¾€éœ€è¦ä¸é›†ç¾¤å†…çš„å…¶ä»– pod è¿›è¡Œé€šä¿¡ï¼ŒåŒæ—¶å¯èƒ½ä¹Ÿéœ€è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œè®©é›†ç¾¤å¤–éƒ¨çš„ pod ä¹Ÿå¯ä»¥è®¿é—®ï¼Œå¦‚æœéœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨å°† pod çš„åœ°å€æä¾›ç»™è®¿é—®è€…ï¼Œæ˜¾ç„¶å¤ªéº»çƒ¦äº†ï¼Œä¸é€‚åˆä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œè€Œä¸”åœ¨ k8s ä¸­ pod çš„åœ°å€æ˜¯ä¸ç¡®å®šçš„ï¼Œå®ƒæ˜¯ç”± k8s è‡ªåŠ¨åˆ†é…çš„ï¼›æ­¤å¤–ï¼Œpod çš„åœ°å€ä¹Ÿæ˜¯éšæ—¶å¯èƒ½å˜åŠ¨çš„ï¼Œè¿™æ˜¯å› ä¸º Pod å¯èƒ½ä¼šåœ¨èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨æˆ–è€…è¢«é‡æ–°åˆ›å»ºã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ª Pod ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå®ƒçš„ IP åœ°å€ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚æ­¤å¤–ï¼Œå½“ä¸€ä¸ª Pod è¢«åˆ é™¤åï¼Œå…¶ IP åœ°å€ä¹Ÿä¼šéšä¹‹æ¶ˆå¤±ã€‚æ‰€ä»¥ k8s éœ€è¦æä¾›ä¸€ç§ç¨³å®šçš„èµ„æºç±»å‹æ¥è§£å†³ pod é—´é€šä¿¡çš„é—®é¢˜ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ Pod IP åœ°å€æ¥è®¿é—® Podã€‚è¿™ä¸ªèµ„æºå°±æ˜¯å°±æ˜¯ serviceã€‚","title":"k8s service"},{"contents":"multipass æ˜¯ä¸€æ¬¾æ¯”è¾ƒè½»é‡çº§çš„è™šæ‹Ÿæœºæ–¹æ¡ˆï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œæ“ä½œæ–¹å¼ä¸å®¹å™¨ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰ç›´æ¥æä¾›ä¿®æ”¹é…ç½®çš„ç®€å•æ–¹æ³•ï¼Œæ¯”å¦‚é»˜è®¤åˆ›å»ºçš„è™šæ‹Ÿæœºç¡¬ç›˜å¤§å°åªä¼šåˆ†é… 5Gï¼Œå¦‚æœè¦è·‘ k8s ä¹‹ç±»çš„æ˜¾ç„¶æ˜¯ä¸å¤Ÿç”¨çš„ï¼ˆk3s éƒ½ä¸å¤Ÿï¼‰ï¼Œè€Œä¸”é»˜è®¤åˆ›å»ºçš„ CPU åªæœ‰ 1 æ ¸ï¼Œè¿ minikube éƒ½è·‘ä¸èµ·æ¥ï¼ˆæœ€ä½éœ€è¦ 2 æ ¸ï¼‰ï¼Œæ‰€ä»¥å°±éœ€è¦ä¿®æ”¹é…ç½®ã€‚\nåœ¨ github ä¸Šæ‰¾åˆ°çš„è§£å†³æ–¹æ¡ˆï¼ˆé€‚ç”¨äº m1 macï¼‰ï¼š\n# åœæ­¢ multipass $ sudo launchctl unload /Library/LaunchDaemons/com.canonical.multipassd.plist # ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆCPU å¯¹åº” num_coresï¼‰ $ sudo vim /var/root/Library/Application\\ Support/multipassd/qemu/multipassd-vm-instances.json # å¯åŠ¨ multipass $ sudo launchctl load /Library/LaunchDaemons/com.canonical.multipassd.plist å‚è€ƒï¼š\nhttps://github.com/canonical/multipass/issues/1158\næ›´æ–°ï¼š\nCPU èƒ½æ›´æ”¹æˆåŠŸï¼Œä½†æ˜¯ä¿®æ”¹å†…å­˜æ— æ³•ç”Ÿæ•ˆï¼Œè¿™ç©æ„è¿˜æ˜¯ä¸å¤ªå¥½ç”¨\n","date":"2022å¹´05æœˆ08æ—¥","permalink":"/posts/multipass-xiu-gai-pei-zhi/","summary":"multipass æ˜¯ä¸€æ¬¾æ¯”è¾ƒè½»é‡çº§çš„è™šæ‹Ÿæœºæ–¹æ¡ˆï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œæ“ä½œæ–¹å¼ä¸å®¹å™¨ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰ç›´æ¥æä¾›ä¿®æ”¹é…ç½®çš„ç®€å•æ–¹æ³•ï¼Œæ¯”å¦‚é»˜è®¤åˆ›å»ºçš„è™šæ‹Ÿæœºç¡¬ç›˜å¤§å°åªä¼šåˆ†é… 5Gï¼Œå¦‚æœè¦è·‘ k8s ä¹‹ç±»çš„æ˜¾ç„¶æ˜¯ä¸å¤Ÿç”¨çš„ï¼ˆk3s éƒ½ä¸å¤Ÿï¼‰ï¼Œè€Œä¸”é»˜è®¤åˆ›å»ºçš„ CPU åªæœ‰ 1 æ ¸ï¼Œè¿ minikube éƒ½è·‘ä¸èµ·æ¥ï¼ˆæœ€ä½éœ€è¦ 2 æ ¸ï¼‰ï¼Œæ‰€ä»¥å°±éœ€è¦ä¿®æ”¹é…ç½®ã€‚","title":"multipass ä¿®æ”¹é…ç½®ï¼ˆå†…å­˜ã€ç¡¬ç›˜ã€CPU ç­‰ï¼‰é€‚ç”¨äº m1 mac"},{"contents":"é—®é¢˜é‡ç° æœ‰å¦‚ä¸‹ yamlï¼š\napiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 8080 hostPort: 9527 æ­¤æ—¶ curl nodeIP:9527 ä¼šå‘ç°æŠ¥ Connection refused é”™è¯¯ï¼Œä½¿ç”¨ kubectl exec -it nginx -- curl localhost:8080 ä¹Ÿæ˜¯å¦‚æ­¤\nä¿®æ”¹ apiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 hostPort: 9527 å°† containerPort æ”¹ä¸º 80ï¼Œè¿™æ˜¯ nginx çš„é»˜è®¤ç›‘å¬ç«¯å£ã€‚\næ­¤æ—¶ä»æµè§ˆå™¨è®¿é—® NodeIP:9527 å‘ç°å¯ä»¥æ˜¾ç¤º nginx çš„ä¸»é¡µï¼Œä½¿ç”¨ kubectl exec -it nginx -- curl localhost:80 ä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œcurl localhost:9527 ä¹ŸåŒæ ·å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯ kubectl exec -it nginx -- curl localhost:9527 ä¼šæŠ¥ Connection refused é”™è¯¯ã€‚\nğŸ¤” ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥å¾—å‡ºï¼šhostPort æ˜¯ä¸»æœºå¯¹å¤–æš´éœ²çš„ IP åœ°å€ï¼Œå…¶æŒ‡å‘å®¹å™¨å†…éƒ¨çš„ containerPortï¼Œåœ¨ ä¿®æ”¹ çš„ä¾‹å­ä¸­ï¼Œæ„ä¹‰ä¸ºï¼šå¯¹å¤–æš´éœ² 9527 ç«¯å£ï¼Œè¯¥ç«¯å£æŒ‡å‘ nginx å®¹å™¨å†…éƒ¨çš„ 80 ç«¯å£ï¼Œæ‰€ä»¥è®¿é—®ä¸»æœºçš„ 9527 ç›¸å½“äºè®¿é—® nginx å®¹å™¨çš„ 80 ç«¯å£ï¼Œä» kubectl exec -it nginx -- curl localhost:9527 æŠ¥ Connection refused å¯ä»¥å¾—å‡ºï¼Œå®¹å™¨å†…éƒ¨æ˜¯æ²¡æœ‰ç›‘å¬ 9527 è¿™ä¸ªç«¯å£çš„ã€‚\nåœ¨ stackoverflow ä¸Šæ‰¾åˆ°äº†ä¸¤ä¸ªåŒæ ·çš„é—®é¢˜ï¼š\nhttps://stackoverflow.com/questions/69282237/nginx-pod-not-taking-specified-port\nå›ç­”ï¼š\nNGINX Docker image uses port 80 to listen for HTTP connections by default. containerPort is the port which you expose your application to external traffic.\nNGINX Docker é•œåƒé»˜è®¤ä½¿ç”¨ 80 ç«¯å£æ¥ç›‘å¬ HTTP è¿æ¥ã€‚å®¹å™¨ç«¯å£æ˜¯æ‚¨å°†åº”ç”¨ç¨‹åºå…¬å¼€ç»™å¤–éƒ¨æµé‡çš„ç«¯å£ã€‚\nhttps://stackoverflow.com/questions/66526811/unable-to-curl-pod-ip-using-containerport\nå›ç­”ï¼š\nBy default, nginx server listen to the port 80. You can see it in their docker image ref.\nWith kubectl run nginx --image=nginx --port=8888 what you have done here is you have expose another port along with 80. But the server is still listening on the 80 port.\nSo, try with target port 80. For this reason when you tried with other than port 80 it\u0026rsquo;s not working. Try with set --target-port=8888 to --target-port=80.\nOr, If you want to change the server port you need to use configmap along with pod to pass custom config to the server.\né»˜è®¤æƒ…å†µä¸‹ï¼Œnginx æœåŠ¡å™¨ç›‘å¬ 80 ç«¯å£ã€‚ä½ å¯ä»¥åœ¨ä»–ä»¬çš„ docker é•œåƒä¸­çœ‹åˆ°å®ƒ [ref](https://hub.docker.com/layers/nginx/library/nginx/1.18.0 - alpine/images /sha256 - d7038eae37cfa36cd8e286f6d6daf0df7a445a2da327517b3cde4ba1833adc0c?context=explore)ã€‚ ä½¿ç”¨ kubectl run nginx - image=nginx - port=8888 ä½ åœ¨è¿™é‡Œæ‰€åšçš„æ˜¯ä½ å·²ç»æš´éœ²äº†å¦ä¸€ä¸ªç«¯å£ä»¥åŠ 80ã€‚ä½†æ˜¯æœåŠ¡å™¨ä»åœ¨ç›‘å¬ 80 ç«¯å£ã€‚ å› æ­¤ï¼Œè¯·å°è¯•ä½¿ç”¨ç›®æ ‡ç«¯å£â€œ80â€ã€‚å› æ­¤ï¼Œå½“æ‚¨å°è¯•ä½¿ç”¨ç«¯å£â€œ80â€ä»¥å¤–çš„å…¶ä»–ç«¯å£æ—¶ï¼Œå®ƒä¸èµ·ä½œç”¨ã€‚å°è¯•å°†-target-port=8888è®¾ç½®ä¸º-target-port=80ã€‚ æˆ–è€…ï¼Œå¦‚æœè¦æ›´æ”¹æœåŠ¡å™¨ç«¯å£ï¼Œåˆ™éœ€è¦ä½¿ç”¨ configmap å’Œ pod å°†è‡ªå®šä¹‰é…ç½®ä¼ é€’ç»™æœåŠ¡å™¨ã€‚\né‚£ä¹ˆ containerPort è¿™ä¸ªå‚æ•°åˆ°åº•æ˜¯ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ\næŸ¥é˜…èµ„æ–™ï¼Œæœ‰è¿™å‡ ç§è¯´æ³•ï¼š\ncontainerPort æ˜¯ pod ä¸­çš„å®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£\ncontainerPort æ˜¯å®¹å™¨å†…éƒ¨çš„ port\nports : containerPort List of ports to expose from the container. Exposing a port here gives the system additional information about the network connections a container uses,but is primarily informational. Not specifying a port here DOES NOT prevent that port from being exposed. Any port which is listening on the default \u0026ldquo;0.0.0.0\u0026rdquo; address inside a container will be accessible from the network. Cannot be updated.\ncontainerPort æ˜¯è¦ä»å®¹å™¨å…¬å¼€çš„ç«¯å£åˆ—è¡¨ã€‚åœ¨æ­¤å¤„å…¬å¼€ç«¯å£å¯ä¸ºç³»ç»Ÿæä¾›æœ‰å…³å®¹å™¨ä½¿ç”¨çš„ç½‘ç»œè¿æ¥çš„é™„åŠ ä¿¡æ¯ï¼Œä½†ä¸»è¦æ˜¯ä¿¡æ¯æ€§çš„ã€‚æ­¤å¤„ä¸æŒ‡å®šç«¯å£ä¸ä¼šé˜»æ­¢è¯¥ç«¯å£è¢«æš´éœ²ã€‚ä»»ä½•ä¾¦å¬å®¹å™¨å†…é»˜è®¤â€œ0.0.0.0â€åœ°å€çš„ç«¯å£éƒ½å¯ä»¥ä»ç½‘ç»œè®¿é—®ã€‚æ— æ³•æ›´æ–°ã€‚ï¼ˆæœºç¿»ï¼Œæ¥è‡ª https://faun.pub/should-i-configure-the-ports-in-kubernetes-deployment-c6b3817e495ï¼‰\nä»ä¸Šé¢è¿™äº›è¯´æ³•å¤§è‡´äº†è§£äº†ï¼Œnginx å®¹å™¨ä¼šé»˜è®¤ç›‘å¬ 80 ç«¯å£ï¼Œè€Œæˆ‘æŒ‡å®šçš„ containerPort å®é™…ä¸Šä¸ä¼šæ”¹å˜ nginx ç›‘å¬çš„ç«¯å£ï¼Œæ‰€ä»¥å¦‚æœå°†å…¶æŒ‡å®šä¸ºé 80 ç«¯å£ï¼Œæ¯”å¦‚ 8080ï¼Œé‚£ä¹ˆ hostPort ä¼šè®¿é—®å®¹å™¨å†…çš„ 8080 ç«¯å£ï¼Œä½† 8080 æ²¡æœ‰è¢«ä»»ä½•ç¨‹åºç›‘å¬ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿ Connection refused é”™è¯¯ã€‚å°±å’Œä¸Šé¢æ‰€è¯´çš„ï¼ŒcontainerPort ä¸»è¦æ˜¯ä¿¡æ¯æ€§çš„ï¼Œå®ƒåªæ˜¯æ³¨æ˜äº†å®¹å™¨å¯¹å¤–æš´éœ²çš„ç«¯å£ï¼Œä¸ä¼šå®é™…å¯¹å®¹å™¨é€ æˆå½±å“ã€‚\n","date":"2022å¹´05æœˆ08æ—¥","permalink":"/posts/k8s-nginx-pod-de-containerport-wen-ti/","summary":"é—®é¢˜é‡ç° æœ‰å¦‚ä¸‹ yamlï¼š\napiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 8080 hostPort: 9527 æ­¤æ—¶ curl nodeIP:9527 ä¼šå‘ç°æŠ¥ Connection refused é”™è¯¯ï¼Œä½¿ç”¨ kubectl exec -it nginx -- curl localhost:8080 ä¹Ÿæ˜¯å¦‚æ­¤","title":"k8s nginx pod çš„ containerPort é—®é¢˜"},{"contents":"é¡¾åæ€ä¹‰ï¼Œdaemon ä»£è¡¨å®ˆæŠ¤ç¨‹åºï¼Œæ‰€ä»¥ DaemonSet ï¼ˆç®€ç§° dsï¼‰ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä¸“é—¨çš„ podï¼Œè¿™ä¸ª pod æ˜¯ç‰¹æ®Šçš„ï¼Œæ¯”å¦‚èµ„æºç›‘æ§å™¨æˆ–è€…æ—¥å¿—æ”¶é›†å™¨ï¼Œæˆ–è€… k8s è‡ªå·±çš„ kube-proxyã€‚ä¸ rc æˆ–è€… rs ä¸åŒï¼Œè¿™ä¸¤ä¸ªä¼šéšæœºåœ°åˆ†å¸ƒåœ¨æ•´ä¸ªé›†ç¾¤ä¸­ï¼Œæ¯”å¦‚å‰¯æœ¬æ•°é‡ä¸º 5ï¼Œä¸€å…±æœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šåœ¨èŠ‚ç‚¹ 1 åˆ›å»ºä¸¤ä¸ªå‰¯æœ¬ï¼ŒèŠ‚ç‚¹ 2 åˆ›å»º 1 ä¸ªå‰¯æœ¬ï¼ŒèŠ‚ç‚¹ 4 åˆ›å»º 2 ä¸ªå‰¯æœ¬ï¼Œä½† DaemonSet ä¼šä¿è¯è¿™ 4 ä¸ªèŠ‚ç‚¹å„è‡ªéƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚\napiVersion: apps/v1 kind: DaemonSet metadata: name: ssd-monitor spec: selector: matchLabels: # DaemonSet ä¼šå¯¹æ ‡ç­¾ä¸º app=ssd-monitor çš„ pod è¿›è¡Œç®¡ç† app: ssd-monitor template: metadata: labels: # è¿™ä¸ªæ ‡ç­¾ä¸èƒ½çœç•¥ï¼Œä¸”å¿…é¡»ä¸ä¸Šé¢çš„ matchLabels ç›¸åŒï¼Œå¦åˆ™ create ä¼šæŠ¥é”™ app: ssd-monitor spec: containers: - name: main image: nginx:alpine psï¼šå› ä¸ºä¹¦ä¸Šæä¾›çš„é•œåƒéƒ½æ˜¯ x86 çš„ï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸Šæ— æ³•è¿è¡Œï¼Œæ‰€ä»¥æŠŠé•œåƒæ›¿æ¢ä¸ºäº† nginxï¼Œåæ­£åªæ˜¯å­¦ä¹ ï¼Œä¹Ÿæ— æ‰€è°“äº†\nä¹¦ä¸Šçš„ template.spec ä¸‹å…¶å®è¿˜æœ‰ä¸€ä¸ª nodeSelectorï¼Œå€¼ä¸º disk=ssdï¼Œä»£è¡¨è¯¥ ds åªä¼šåœ¨æ ‡ç­¾ä¸º disk=ssd çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºã€ç®¡ç† podï¼Œè¿™é‡Œå·æ‡’äº†æ²¡å†™ï¼Œä¸ç„¶è¿˜è¦ç»™èŠ‚ç‚¹æ·»åŠ æ ‡ç­¾ã€‚\nå¦‚æœå°†ä¸€ä¸ªå·²ç»è¿è¡Œ ds åˆ›å»ºçš„ pod çš„èŠ‚ç‚¹çš„æ ‡ç­¾æ”¹æ‰ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå°†èŠ‚ç‚¹çš„æ ‡ç­¾ disk=ssd æ”¹ä¸º dsik=hddï¼Œé‚£ä¹ˆå…ˆå‰å·²ç»åˆ›å»ºå¥½çš„ ds pod ä¼šè¢«ç»ˆæ­¢ã€‚\n","date":"2022å¹´05æœˆ07æ—¥","permalink":"/posts/k8s-daemonset/","summary":"é¡¾åæ€ä¹‰ï¼Œdaemon ä»£è¡¨å®ˆæŠ¤ç¨‹åºï¼Œæ‰€ä»¥ DaemonSet ï¼ˆç®€ç§° dsï¼‰ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä¸“é—¨çš„ podï¼Œè¿™ä¸ª pod æ˜¯ç‰¹æ®Šçš„ï¼Œæ¯”å¦‚èµ„æºç›‘æ§å™¨æˆ–è€…æ—¥å¿—æ”¶é›†å™¨ï¼Œæˆ–è€… k8s è‡ªå·±çš„ kube-proxyã€‚ä¸ rc æˆ–è€… rs ä¸åŒï¼Œè¿™ä¸¤ä¸ªä¼šéšæœºåœ°åˆ†å¸ƒåœ¨æ•´ä¸ªé›†ç¾¤ä¸­ï¼Œæ¯”å¦‚å‰¯æœ¬æ•°é‡ä¸º 5ï¼Œä¸€å…±æœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šåœ¨èŠ‚ç‚¹ 1 åˆ›å»ºä¸¤ä¸ªå‰¯æœ¬ï¼ŒèŠ‚ç‚¹ 2 åˆ›å»º 1 ä¸ªå‰¯æœ¬ï¼ŒèŠ‚ç‚¹ 4 åˆ›å»º 2 ä¸ªå‰¯æœ¬ï¼Œä½† DaemonSet ä¼šä¿è¯è¿™ 4 ä¸ªèŠ‚ç‚¹å„è‡ªéƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚","title":"k8s DaemonSet"},{"contents":" æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹\nä»‹ç» ReplicaSetï¼ˆç®€ç§° rsï¼‰ æ˜¯ ReplicationController ï¼ˆç®€ç§° rcï¼‰çš„å‡çº§ç‰ˆï¼Œå®ƒçš„æ ‡ç­¾é€‰æ‹©å™¨åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚\næ ‡ç­¾é€‰æ‹©å™¨ ä½¿ç”¨ selector.matchExpressions è¿›è¡Œæ ‡ç­¾é€‰æ‹©ï¼Œæ¯”å¦‚ï¼š\nselector: matchExpressions: - key: app\t# æ­¤é€‰æ‹©å™¨è¦æ±‚è¯¥ pod åŒ…å«åä¸º â€œappâ€ çš„æ ‡ç­¾ operator: In values: - kubia\t# æ ‡ç­¾çš„å€¼å¿…é¡»æ˜¯ \u0026quot;kubia\u0026quot; å…¶ä¸­ï¼Œkey å’Œ operator æ˜¯å¿…é¡»çš„ï¼Œvalues å¯èƒ½ä¸ºç©ºï¼Œä¹Ÿå¯èƒ½ä¸ºå¤šä¸ªå€¼ï¼Œè¿ç®—ç¬¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š\nIn : Label çš„å€¼å¿…é¡»ä¸å…¶ä¸­ä¸€ä¸ªæŒ‡å®šçš„ values åŒ¹é…ã€‚ Notln : Label çš„å€¼ä¸ä»»ä½•æŒ‡å®šçš„ values ä¸åŒ¹é…ã€‚ Exists : pod å¿…é¡»åŒ…å«ä¸€ä¸ªæŒ‡å®šåç§°çš„æ ‡ç­¾(å€¼ä¸é‡è¦)ã€‚ä½¿ç”¨æ­¤è¿ç®—ç¬¦æ—¶ï¼Œä¸åº”è¯¥æŒ‡å®š values å­—æ®µã€‚ DoesNotExist : pod ä¸å¾—åŒ…å«æœ‰æŒ‡å®šåç§°çš„æ ‡ç­¾ã€‚values å±æ€§ä¸å¾—æŒ‡å®š ã€‚ä¸åº”æŒ‡å®š valueså­—æ®µã€‚ DoesNotExist : podä¸å¾—åŒ…å«æœ‰æŒ‡å®šåç§°çš„æ ‡ç­¾ã€‚valueså±æ€§ä¸å¾—æŒ‡å®š ã€‚ å¦‚æœä½ æŒ‡å®šäº†å¤šä¸ªè¡¨è¾¾å¼ï¼Œåˆ™æ‰€æœ‰è¿™äº›è¡¨è¾¾å¼éƒ½å¿…é¡»ä¸º true æ‰èƒ½ä½¿é€‰æ‹©å™¨ä¸ pod åŒ¹é…ã€‚å¦‚æœåŒæ—¶æŒ‡å®šmatchLabels å’Œ matchExpressionsï¼Œåˆ™æ‰€æœ‰æ ‡ç­¾éƒ½å¿…é¡»åŒ¹é…ï¼Œå¹¶ä¸”æ‰€æœ‰è¡¨è¾¾å¼å¿…é¡»è®¡ç®—ä¸º true ä»¥ä½¿è¯¥ pod ä¸é€‰æ‹©å™¨åŒ¹é…ã€‚\nä¾‹å­ï¼š\nselector: matchLabels: component: redis matchExpressions: - {key: tier, operator: In, values: [cache]} - {key: environment, operator: NotIn, values: [dev]} æµ‹è¯• rs æ˜¯å¦ä¼šæŠ¢å  rc çš„ pod ç°åœ¨æœ‰ 3 ä¸ª rc åˆ›å»ºçš„ podï¼Œæ ‡ç­¾éƒ½ä¸º app=kubiaï¼Œå®¹å™¨ä¸º nginxã€æ•°é‡ä¸º 3 ï¼Œå¦‚æœæ­¤æ—¶ä½¿ç”¨ rs åˆ›å»ºæ¡ä»¶ç›¸åŒçš„ pod ä¼šæ€æ ·ï¼Ÿä¼šç›´æ¥å°† rc çš„ 3 ä¸ªå®¹å™¨æŠ¢è¿‡æ¥å—ï¼Ÿ\nrs çš„ yaml å¦‚ä¸‹ï¼š\nkubia-replicaset.yaml\napiVersion: apps/v1 kind: ReplicaSet metadata: name: kubia spec: replicas: 3 selector: matchLabels: app: kubia template: metadata: labels: app: kubia spec: containers: - name: kubia image: nginx:alpine ports: - containerPort: 8080 åˆ›å»º rsï¼š\n$ kubectl apply -f kubia-replicaset.yaml æŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-qb26r 1/1 Running 0 13h kubia-d9xc6 1/1 Running 0 13h kubia-dg2j8 1/1 Running 0 17m kubia-vdrf6 1/1 Running 0 10m kubia-cq4wt 1/1 Running 0 10m kubia-qx467 1/1 Running 0 10m å‘ç° k8s åˆæ–°åˆ›å»ºäº† 3 ä¸ª podï¼Œé€šè¿‡ kubectl describe å¯ä»¥çœ‹åˆ°æ¯ä¸ª pod çš„ç®¡ç†è€…ï¼Œkubia-qb26r æ˜¾ç¤ºçš„æ˜¯ï¼šControlled By: ReplicationController/kubiaï¼Œkubia-qx467 æ˜¾ç¤ºçš„æ˜¯ï¼šControlled By: ReplicaSet/kubiaï¼Œè¯´æ˜ rs ä¸ä¼šæŠ¢å  rc çš„ podã€‚\nè„±ç¦» rc ç®¡ç†çš„ pod ä¼šè¢« rs æ¥ç®¡å— è¿˜æ˜¯å’Œä¸Šé¢çš„æ¡ä»¶ä¸€æ ·ï¼Œæœ‰ 3 ä¸ª rc åˆ›å»ºçš„ podï¼Œå¹¶ä¸”æ ‡ç­¾éƒ½ä¸º app=kubiaï¼Œå…ˆåˆ é™¤ä¹‹å‰åˆ›å»ºçš„ rsï¼Œè¿™ä¼šä¸€å¹¶åˆ é™¤å…¶åˆ›å»ºçš„ 3 ä¸ª podï¼š\n$ kubectl delete rs kubia replicaset.apps \u0026quot;kubia\u0026quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-qb26r 1/1 Running 0 13h kubia-d9xc6 1/1 Running 0 13h kubia-dg2j8 1/1 Running 0 20m åˆ é™¤ä¹‹å‰çš„ rcï¼Œæ³¨æ„æ·»åŠ  \u0026ndash;cascade= false æ¥é¿å…åˆ é™¤ podï¼ˆæœ‰ä¸ªè­¦å‘Šï¼Œæ„æ€ \u0026ndash;cascade=false è¢«åºŸå¼ƒäº†ï¼Œåº”è¯¥æ›¿æ¢ä¸º cascade=orphanï¼ŒæŸ¥äº†ä¸‹ orphan æ˜¯å­¤å„¿çš„æ„æ€ï¼ŒæŒºè´´åˆ‡çš„ï¼‰\n$ kubectl delete rc kubia --cascade=false warning: --cascade=false is deprecated (boolean value) and can be replaced with --cascade=orphan. replicationcontroller \u0026quot;kubia\u0026quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE kubia-d9xc6 1/1 Running 0 13h kubia-dg2j8 1/1 Running 0 28m kubia-qb26r 1/1 Running 0 13h å†åˆ›å»ºä¹‹å‰çš„ rs\n$ kubectl apply -f kubia-replicaset.yaml replicaset.apps/kubia created $ kubectl get po NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 20h kubia-dg2j8 1/1 Running 0 30m kubia-d9xc6 1/1 Running 0 13h kubia-qb26r 1/1 Running 0 13h $ kubectl describe pod kubia-dg2j8 Name: kubia-dg2j8 Labels: app=kubia # çœç•¥ Controlled By: ReplicaSet/kubia # çœç•¥ å¯ä»¥çœ‹åˆ° rs ä¼šç›´æ¥æ¥ç®¡è¿™ 3 ä¸ªè„±ç¦» rc ç®¡ç†çš„ podã€‚\n","date":"2022å¹´05æœˆ07æ—¥","permalink":"/posts/k8s-replicaset/","summary":"æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹","title":"k8s ReplicaSet"},{"contents":" æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹\nReplicationController é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆselectorï¼‰ä¸ pod ç›¸å…³è”ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸€ä¸ª pod çš„æ ‡ç­¾å°†å…¶ç§»å‡º ReplicationController çš„ç®¡ç†ï¼Œæˆ–è€…ç§»å…¥åˆ°å¦ä¸€ä¸ª ReplicationControllerã€‚\næŸ¥çœ‹æ‰€æœ‰çš„ ReplicationController:\n$ kubectl get rc NAME DESIRED CURRENT READY AGE kubia 2 2 2 39m å®éªŒ æŒ‰ç…§ä¹¦ä¸Šçš„ yamlï¼š\napiVersion: v1 kind: ReplicationController metadata: name: kubia spec: replicas: 3 selector: app: kubia template: metadata: labels: app: kubia\t# è¿™é‡Œéœ€è¦ä¸ selectro ä¸­çš„æ ‡ç­¾ä¿æŒä¸€è‡´ spec: containers: - name: kubia image: luksa/kubia ports: - containerPort: 8080 å‘ç°æ— æ³•è¿è¡Œ podï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE kubia-25mrj 0/1 CrashLoopBackOff 22 (3m22s ago) 92m kubia-x4dd8 0/1 CrashLoopBackOff 22 (3m11s ago) 92m kubia-8gdfz 0/1 CrashLoopBackOff 22 (2m45s ago) 92m æ‰“å°ä¸€ä¸‹æ—¥å¿—çœ‹çœ‹ï¼š\n$ kubectl logs kubia-25mrj standard_init_linux.go:228: exec user process caused: exec format error æŸ¥äº†ä¸€ä¸‹ï¼Œè²Œä¼¼æ˜¯å› ä¸º luksa/kubia è¿™ä¸ªé•œåƒæ˜¯ x86 çš„ï¼Œè€Œæˆ‘çš„ç”µè„‘æ˜¯ arm çš„ï¼Œæ‰€ä»¥å¯¼è‡´å®¹å™¨æ— æ³•è¿è¡Œ\nå¯ä»¥å°†å…¶æ¢æˆ nginx:alpine\nkubectl get po NAME READY STATUS RESTARTS AGE kubia-fcf4d 1/1 Running 0 16s kubia-d9xc6 1/1 Running 0 16s kubia-qb26r 1/1 Running 0 16s å°è¯•åˆ é™¤ä¸€ä¸ª podï¼š\n$ kubectl delete pod kubia-fcf4d pod \u0026quot;kubia-fcf4d\u0026quot; deleted å†æ¬¡æŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 7h12m kubia-d9xc6 1/1 Running 0 3m6s kubia-qb26r 1/1 Running 0 3m6s kubia-6lp8k 1/1 Running 0 23s å‘ç° ReplicationController åˆæ–°åˆ›å»ºäº†ä¸€ä¸ª podï¼Œåœ¨æœ€ä¸‹æ–¹çš„ kubia-6lp8k\nä¿®æ”¹æ ‡ç­¾å®éªŒ å…ˆçœ‹ä¸€ä¸‹å½“å‰çš„ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-d9xc6 1/1 Running 0 20m kubia-qb26r 1/1 Running 0 20m kubia-6lp8k 1/1 Running 0 17m ä¿®æ”¹ä¸€ä¸ª pod çš„ labelï¼š\n$ kubectl label po kubia-d9xc6 app=kubia1 --overwrite pod/kubia-d9xc6 labeled å†æ¬¡æŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-qb26r 1/1 Running 0 21m kubia-6lp8k 1/1 Running 0 18m kubia-d9xc6 1/1 Running 0 21m kubia-mnfft 1/1 Running 0 4s å‘ç°æ­¤æ—¶åˆæ–°åˆ›å»ºäº†ä¸€ä¸ª pod\nä½¿ç”¨ kubectl describe æŸ¥çœ‹ kubia-d9xc6ï¼Œå‘ç° Controlled By: ReplicationController/kubia è¿™å¥è¯æ¶ˆå¤±äº†ï¼Œè¯´æ˜è¯¥ pod å½“å‰å·²ç»ä¸ç”±ä»»ä½• ReplicationController ç®¡ç†äº†ã€‚\né—®é¢˜æ¥äº†ï¼Œå¦‚æœæŠŠ kubia-d9xc6 çš„æ ‡ç­¾å†æ”¹å›å»ä¼šæ€ä¹ˆæ ·ï¼Ÿ\n$ kubectl label po kubia-d9xc6 app=kubia --overwrite pod/kubia-d9xc6 unlabeled è¿™ä¸ª unlabeled æ²¡å¤ªææ‡‚ï¼Œä½†æ˜¯ describe æŸ¥çœ‹å‘ç°è¿˜æ˜¯æ›´æ”¹æˆåŠŸäº†ã€‚\næ­¤æ—¶å†æŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-qb26r 1/1 Running 0 26m kubia-6lp8k 1/1 Running 0 24m kubia-d9xc6 1/1 Running 0 26m å‘ç°å…ˆå‰æ–°åˆ›å»ºçš„ pod åˆè¢«åˆ é™¤äº†ã€‚\nçœ‹æ¥ ReplicationController ä¼šå§‹ç»ˆä¿è¯ pod ç¬¦åˆæŒ‡å®šæ•°é‡ï¼Œå¤šåˆ å°‘è¡¥ã€‚\næ°´å¹³ç¼©æ”¾ å¯ä»¥æ”¹å˜ spec.replicas æ¥å˜æ›´ pod çš„æ•°é‡ï¼š\n$ kubectl edit rc kubia æ­¤æ—¶ä¼šæ‰“å¼€ä¸€ä¸ª vimï¼Œå°† spec.replicas ä¿®æ”¹ä¸º 2ï¼Œesc + :wq é€€å‡ºï¼Œé€€å‡ºå k8s ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œè¾“å‡ºï¼šreplicationcontroller/kubia editedï¼Œæ­¤æ—¶å†æŸ¥çœ‹ podï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE kubia-qb26r 1/1 Running 0 37m kubia-d9xc6 1/1 Running 0 37m å¯ä»¥çœ‹åˆ° pod çš„æ•°é‡å·²ç»ç¼©å‡åˆ° 2 ä¸ªäº†\nåŒæ ·ä¹Ÿå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n$ kubectl scale rc kubia --replicas=2 åˆ é™¤ rc ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œåˆ é™¤ï¼š\n$ kubectl delete rc [rcName] åˆ é™¤ rc ä¼šä¸€å¹¶åˆ é™¤å…¶æ‰€ç®¡ç†çš„ podï¼Œä¸è¿‡ä¸æƒ³è¿™ä¹ˆåšï¼Œåˆ™éœ€è¦æ·»åŠ  --cascade=false é€‰é¡¹ã€‚\n","date":"2022å¹´05æœˆ06æ—¥","permalink":"/posts/k8s-replicationcontroller/","summary":"æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹","title":"k8s ReplicationController"},{"contents":" æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹4.1 ä¿æŒ pod å¥åº·\nåŸºæœ¬æ¦‚å¿µ k8s ä¼š æ£€æµ‹ pod ä¸­çš„å®¹å™¨ æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå¦‚æœå®¹å™¨çš„ä¸»çº¿ç¨‹å¥”æºƒï¼Œé‚£ä¹ˆ k8s ä¼šè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œæ— éœ€å¯¹åº”ç”¨ç¨‹åºä»»ä½•é¢å¤–æ“ä½œä¾¿è·å¾—äº†è‡ªåŠ¨ä¿®å¤çš„èƒ½åŠ›ï¼Œä½†æœ‰æ—¶å®¹å™¨æ²¡æœ‰å¥”æºƒä¹Ÿä¸ä¸€å®šå°±ä»£è¡¨æ­£å¸¸ï¼Œæ¯”å¦‚é‡åˆ°äº†æ­»é”é—®é¢˜ï¼Œæ­¤æ—¶è™½ç„¶å®¹å™¨ä¸ä¼šå¥”æºƒï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºå·²ç»å®Œå…¨å¡æ­»æ— æ³•ç»§ç»­å·¥ä½œäº†ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œk8s æä¾›äº†ä¸€ä¸ª å­˜æ´»æ¢é’ˆ åŠŸèƒ½ã€‚\nå­˜æ´»æ¢é’ˆ ä¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå¦‚æœæ¢æµ‹å¤±è´¥ï¼Œ k8s å°†å®šæœŸæ‰§è¡Œæ¢é’ˆå¹¶é‡æ–°å¯åŠ¨å®¹å™¨ã€‚\nå­˜æ´»æ¢é’ˆ æœ‰ä»¥ä¸‹å‡ ç§æœºåˆ¶ï¼š\nHTTPï¼Œå¯¹å®¹å™¨è¿›è¡Œ HTTP è®¿é—®ï¼ˆç«¯å£å’Œè·¯ç”±éœ€è¦è‡ªå·±æŒ‡å®šï¼‰ï¼Œæ ¹æ®è¿”å›ç æ¥åˆ¤æ–­æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆ2xxï¼Œ3xxä»£è¡¨æ­£å¸¸ï¼Œå…¶ä»–ä»£è¡¨é”™è¯¯ï¼‰ï¼Œå¦‚æœé•¿æ—¶é—´æœªå“åº”ä¹ŸåŒæ ·ä»£è¡¨æ— æ³•æ­£å¸¸å·¥ä½œã€‚\nTCP socketï¼Œå¯¹å®¹å™¨çš„æŒ‡å®šç«¯å£å»ºç«‹ TCP è¿æ¥ï¼Œå¦‚æœå»ºç«‹æˆåŠŸåˆ™ä»£è¡¨å­˜æ´»ï¼Œå¦åˆ™å®¹å™¨é‡æ–°å¯åŠ¨ã€‚\nExecï¼Œåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå¹¶æ£€æŸ¥å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ã€‚å¦‚æœçŠ¶æ€ç æ˜¯ 0, åˆ™æ¢æµ‹æˆåŠŸã€‚æ‰€æœ‰å…¶ä»–çŠ¶æ€ç éƒ½è¢«è®¤ä¸ºå¤±è´¥ã€‚\nå®è·µ ä½¿ç”¨ http æ–¹å¼ å®è·µä¼šåˆ›å»ºä¸€ä¸ªåŸºäº HTTP çš„å­˜æ´»æ¢é’ˆã€‚\nyaml æ–‡ä»¶å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod metadata: name: kubia-liveness spec: containers: - image: luksa/kubia-unhealthy # è¿™ä¸ªé•œåƒåŒ…å«äº†ä¸çŸ¥é“æ€ä¹ˆåæ‰çš„åº”ç”¨ name: kubia livenessProbe: httpGet: # ä¸€ä¸ª HTTP GET å­˜æ´»æ¢é’ˆ path: / # HTTP è¯·æ±‚çš„è·¯å¾„ port: 8080 # æ¢é’ˆè¿æ¥çš„ç½‘ç»œç«¯å£ åˆ›å»ºåï¼ŒæŸ¥çœ‹ pod çŠ¶æ€ï¼š\n$kubectl get pods NAME READY STATUS RESTARTS AGE kubia-liveness 0/1 CrashLoopBackOff 16 (21s ago) 60m RESTARTS ä»£è¡¨é‡å¯æ¬¡æ•°ï¼Œä¸Šé¢é‡å¯äº† 16 æ¬¡ï¼Œè¯´æ˜ k8s ä¸€ç›´åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤ï¼Œåªæ˜¯è¿™ä¸ªé•œåƒä¼šåœ¨é‡å¯åä¸ä¹…åæ‰ï¼Œå¯¼è‡´ä¸€ç›´åœ¨é‡å¯ï¼ˆä¸ºäº†æ¼”ç¤ºåˆ»æ„è€Œä¸ºä¹‹ï¼Œè¿™ä¸ªé•œåƒä¼šæ­£ç¡®å¤„ç†å‰ 5 ä¸ª HTTP è¯·æ±‚ï¼Œä¹‹åæ¯ä¸ªè¯·æ±‚éƒ½ä¼šè¿”å› 500ï¼Œå¯¼è‡´æ¢é’ˆæ£€æµ‹å¤±è´¥è€Œé‡å¯ï¼‰\næ³¨æ„ï¼šå½“å®¹å™¨è¢«å¼ºè¡Œç»ˆæ­¢æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®¹å™¨â€”â€”è€Œä¸æ˜¯é‡å¯åŸæ¥çš„å®¹å™¨ã€‚\nç–‘é—®ï¼š å®˜æ–¹æ–‡æ¡£é‡Œè¯´ï¼Œhttp å­˜æ´»æŒ‡é’ˆçš„åˆ¤æ–­ä¾æ®æ˜¯ï¼šè¿”å›å¤§äºæˆ–ç­‰äº 200 å¹¶ä¸”å°äº 400 çš„ä»»ä½•ä»£ç éƒ½æ ‡ç¤ºæˆåŠŸï¼Œå…¶å®ƒè¿”å›ä»£ç éƒ½æ ‡ç¤ºå¤±è´¥ã€‚é‚£å¦‚æœæ•´ä¸ªå®¹å™¨éƒ½æŒ‚æ‰äº†ï¼Œä¸ä¼šè¿”å›ä»»ä½•çŠ¶æ€ç ï¼Œæ­¤æ—¶ä¼šå¦‚ä½•å¤„ç†å‘¢ï¼Ÿæ˜¯è¶…æ—¶æœªæ”¶åˆ°å›å¤åå°±è‡ªåŠ¨åˆ¤å®šä¸ºæœªå­˜æ´»å—ï¼Ÿè¿™ä¸ªéœ€è¦è‡ªå·±å®è·µä¸€ä¸‹ï¼ˆpsï¼šå®˜æ–¹æ–‡æ¡£åŒ…æ‹¬ä¸€äº›ä¹¦ç±é‡Œé¢æä¾›äº†ç°æˆçš„é•œåƒï¼Œä½†æ˜¯è¿™äº›é•œåƒåŸºæœ¬éƒ½æ˜¯ amd64 çš„ï¼Œåœ¨æˆ‘çš„ m1 ä¸Šæ— æ³•æˆåŠŸè¿è¡Œï¼Œæ‰€ä»¥æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦è‡ªå·±å†™ä»£ç ï¼Œç„¶å docker buildï¼Œå† push åˆ° hubï¼Œï¼‰\nå¦‚æœ pod ä¸­æœ‰å¤šä¸ªå®¹å™¨ï¼Œå¦‚ä½•æ£€æµ‹ å¯ä»¥ä½¿ç”¨å­˜æ´»æ¢é’ˆï¼Œä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ä¸åŒçš„æ¢æµ‹æ–¹æ¡ˆï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨ tcp æ¢é’ˆï¼Œè®© pod ä¸­çš„æ¯ä¸ªå®¹å™¨æš´éœ²ä¸€ä¸ªç«¯å£ï¼Œç„¶åå­˜æ´»æ¢é’ˆåˆ†åˆ«å°è¯•ä¸è¿™äº›ç«¯å£å»ºç«‹è¿æ¥ï¼Œå¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªç«¯å£å»ºç«‹è¿æ¥å¤±è´¥ï¼Œåˆ™è¯´æ˜å®¹å™¨å‡ºç°äº†é—®é¢˜ï¼Œç„¶å k8s å°±ä¼šåˆ é™¤è¿™ä¸ªæœ‰é—®é¢˜çš„ podï¼Œå¹¶æ–°å»ºä¸€ä¸ªç›¸åŒçš„ pod æ›¿ä»£ã€‚\nå¾…å®è·µ\næŸ¥çœ‹ pod æ¢é’ˆ $ kubectl describe pod kubia-liveness Liveness: http-get http://:8080/ delay=0s timeout=1s period=10s #success=1 #failure=3 delay=0s è¡¨ç¤ºåœ¨å®¹å™¨å¯åŠ¨åç«‹å³å¼€å§‹æ¢æµ‹ï¼Œtimeout=1s è¡¨ç¤ºå®¹å™¨å¿…é¡»åœ¨ 1s å†…å¯¹æ¢é’ˆåšå‡ºå“åº”ï¼Œperiod=10s ä»£è¡¨æ¯ 10s è¿›è¡Œä¸€æ¬¡æ¢æµ‹ï¼Œfailure=3 è¡¨ç¤ºç´¯è®¡å¤±è´¥ 3 æ¬¡åˆ™è§†ä¸ºå®¹å™¨æ— æ³•æ­£å¸¸å·¥ä½œã€‚success=1 ä¹¦ä¸­æ²¡æœ‰è¯´æ˜ï¼Œä¸è¿‡åº”è¯¥å¯ä»¥çŒœåˆ°æ˜¯ä»£è¡¨æ¢é’ˆæˆåŠŸä¸€æ¬¡ä¾¿è§†ä¸ºå®¹å™¨å¯ä»¥æ­£å¸¸å·¥ä½œã€‚\nå¯¹äºä¸€äº›æ¯”è¾ƒé‡çš„åº”ç”¨ï¼Œå¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿çš„æ—¶é—´ï¼Œæ­¤æ—¶å°† delay è®¾ç½®ä¸º 0 å°±ä¸å¤ªåˆé€‚äº†ï¼Œå¯èƒ½ç¨‹åºéƒ½è¿˜æ²¡è·‘èµ·æ¥ï¼Œæ¢é’ˆå´å·²ç»æ¢æµ‹è¿‡å¥½å‡ æ¬¡äº†ï¼Œå¯¼è‡´é”™è¯¯çš„é‡å¯å½“å‰å®¹å™¨ã€‚é€šè¿‡ livenessProbe ä¸‹çš„ initialDelaySeconds è¿›è¡Œè®¾ç½®ã€‚\n","date":"2022å¹´05æœˆ06æ—¥","permalink":"/posts/k8s-cun-huo-tan-zhen/","summary":"æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹4.","title":"k8s å­˜æ´»æ¢é’ˆ"},{"contents":" æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹ç¬¬ä¸‰ç« ï¼špodï¼šè¿è¡Œäº Kubernetes ä¸­çš„å®¹å™¨\nä»€ä¹ˆæ˜¯ pod pod æ˜¯ k8s çš„æœ€åŸºæœ¬æ„å»ºæ¨¡å—ï¼Œä»–æ˜¯å¤šä¸ªå®¹å™¨çš„é›†åˆï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åªæœ‰1ä¸ªå®¹å™¨ï¼‰ï¼Œä¸€ä¸ª pod é‡Œçš„æ‰€æœ‰å®¹å™¨éƒ½ä¼šè¿è¡Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¸å­˜åœ¨ä¸€ä¸ª pod ä¸­çš„å®¹å™¨ A åœ¨èŠ‚ç‚¹ 1 è¿è¡Œï¼Œå®¹å™¨ B åœ¨èŠ‚ç‚¹ 2 è¿è¡Œè¿™ç§æƒ…å†µã€‚\nä¸ºä½•ä¸å°†æ‰€æœ‰è¿›ç¨‹æ”¾åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Ÿ\nå®¹å™¨è¢«è®¾è®¡ä¸ºæ¯ä¸ªå®¹å™¨åªè¿è¡Œä¸€ä¸ªè¿›ç¨‹(é™¤éè¿›ç¨‹æœ¬èº«äº§ç”Ÿå­è¿›ç¨‹)ã€‚ å¦‚æœåœ¨å•ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªä¸ç›¸å…³çš„è¿›ç¨‹ï¼Œé‚£ä¹ˆä¿æŒæ‰€æœ‰è¿›ç¨‹è¿è¡Œã€ ç®¡ç†å®ƒä»¬çš„æ—¥å¿—ç­‰å°†ä¼šæ˜¯æˆ‘ä»¬çš„è´£ä»»ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦åŒ…å«ä¸€ç§åœ¨è¿›ç¨‹å´©æºƒæ—¶èƒ½å¤Ÿè‡ªåŠ¨é‡å¯çš„æœºåˆ¶ã€‚åŒæ—¶è¿™äº›è¿›ç¨‹éƒ½å°†è®°å½•åˆ°ç›¸åŒçš„æ ‡å‡†è¾“å‡ºä¸­ï¼Œ è€Œæ­¤æ—¶æˆ‘ä»¬å°†å¾ˆéš¾ç¡®å®šæ¯ä¸ªè¿›ç¨‹åˆ†åˆ«è®°å½•äº†ä»€ä¹ˆã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œ æˆ‘ä»¬éœ€è¦è®©æ¯ä¸ªè¿›ç¨‹è¿è¡Œåœ¨è‡ªå·±çš„å®¹å™¨ä¸­ï¼Œ è€Œè¿™å°±æ˜¯ Docker å’Œ Kubernetes æœŸæœ›ä½¿ç”¨çš„æ–¹å¼ã€‚\néš”ç¦»æ€§ï¼špod ä¸­çš„å®¹å™¨äº’ç›¸ä¹‹é—´å¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œå®ƒä»¬å…±äº«ç›¸åŒçš„ä¸»æœºåå’Œç½‘ç»œæ¥å£ï¼Œä¹Ÿèƒ½ä½¿ç”¨ ipc è¿›è¡Œé€šä¿¡ã€‚è¿›ç¨‹å’Œæ–‡ä»¶ç³»ç»Ÿä¹Ÿå¯ä»¥å…±äº«ï¼Œä½†è¿™ä¸¤ä¸ªéœ€è¦åšä¸€äº›é¢å¤–çš„æ“ä½œã€‚å› ä¸ºå…±äº«ç½‘ç»œæ¥å£ï¼Œæ‰€ä»¥ä¹Ÿå…±äº«ç›¸åŒçš„ IP åœ°å€å’Œç«¯å£ï¼Œè¿™ä»£è¡¨ä¸€ä¸ª pod ä¸­ä¸åŒå®¹å™¨çš„è¿›ç¨‹ä¸èƒ½ç»‘å®šåˆ°åŒä¸€ä¸ªç«¯å£å·ï¼Œæ­¤å¤–å®¹å™¨å¯ä»¥é€šè¿‡ localhost ä¸åŒä¸€ pod ä¸­çš„å…¶ä»–å®¹å™¨è¿›è¡Œé€šä¿¡ã€‚\npod é—´é€šä¿¡ï¼šk8s é›†ç¾¤ä¸­çš„æ‰€æœ‰ pod éƒ½åœ¨åŒä¸€ä¸ªå…±äº«ç½‘ç»œåœ°å€ç©ºé—´ä¸­ï¼Œæ‰€ä»¥ pod é—´å¯ä»¥é€šè¿‡ IP è¿›è¡Œç›¸äº’è®¿é—®\næ€»ç»“ï¼špod ç±»ä¼¼äºä¸€å°ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œåªæ˜¯å…¶æ¯ä¸ªè¿›ç¨‹éƒ½å°è£…åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼ŒåŒæ—¶æ¯”è¾ƒè½»é‡ï¼Œå¼€é”€å°\né€šè¿‡ pod åˆç†ç®¡ç†å®¹å™¨ æ¯ä¸ª pod åªåŒ…å«ç´§å¯†ç›¸å…³çš„ç»„ä»¶æˆ–è¿›ç¨‹ pod æœ‰ä¸€æ¡æ€»çš„åŸåˆ™ï¼šåº”è¯¥å°†åº”ç”¨ç¨‹åºç»„ç»‡åˆ°å¤šä¸ª pod ä¸­ï¼Œ è€Œ æ¯ä¸ª pod åªåŒ…å«ç´§å¯†ç›¸å…³çš„ç»„ä»¶æˆ–è¿›ç¨‹ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰ç¨‹åºéƒ½æ”¾åˆ°ä¸€ä¸ª podã€‚\nåŸå› æœ‰å‡ ä¸‹å‡ ç‚¹ï¼š\næœ€å¤§ç¨‹åº¦åˆ©ç”¨èŠ‚ç‚¹ï¼Œæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªå‰ç«¯åº”ç”¨å’Œä¸€ä¸ªåç«¯åº”ç”¨ï¼Œä»¥åŠä¸€ä¸ªåŒèŠ‚ç‚¹çš„ k8s é›†ç¾¤ï¼Œæ­¤æ—¶åº”è¯¥å°†å‰ç«¯ pod æ”¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåç«¯ pod æ”¾åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯å°†å‰åç«¯æ”¾åˆ°ä¸€ä¸ª pod ä¸­ã€‚ æ–¹ä¾¿æ‰©ç¼©å®¹ï¼Œpod æ˜¯ k8s çš„æ‰©ç¼©å®¹åŸºæœ¬å•ä½ï¼Œå®ƒåªèƒ½æ‰©ç¼©æ•´ä¸ª podï¼Œä¸èƒ½æ‰©ç¼©æŸä¸ªå®¹å™¨ï¼Œå¦‚æœä¸€ä¸ª pod ä¸­åŒæ—¶å­˜æ”¾äº†å‰åç«¯ç¨‹åºï¼Œé‚£ä¹ˆå¦‚æœå‘ç”Ÿæ‰©å®¹ï¼Œä¼šå¯¼è‡´å‰åç«¯åŒæ—¶æ‰©å®¹ï¼Œä½†å¯èƒ½æˆ‘åªæƒ³è®©åç«¯è¿›è¡Œæ‰©å®¹ï¼ˆè¿™æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œæ¯•ç«Ÿå‰åç«¯çš„éœ€æ±‚ä¸åŒï¼‰ã€‚ ä½•æ—¶åœ¨ pod ä¸­ä½¿ç”¨å¤šä¸ªå®¹å™¨ ä¸¾ä¸ªä¾‹å­ï¼šæœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªè´Ÿè´£å¯¹å¤–æä¾›æ–‡ä»¶è®¿é—®æœåŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£ä»å¤–éƒ¨ä¸‹è½½èµ„æºåˆ°æ–‡ä»¶ï¼ˆsidecarå®¹å™¨ï¼‰ï¼Œè¿™ä¸¤ä¸ªå®¹å™¨é—´æ˜¯ç´§å¯†å…³è”çš„ï¼Œæ­¤æ—¶ä¾¿å¯ä»¥æ”¾åˆ°ä¸€ä¸ª pod ä¸­ã€‚\nå¦‚æœä¸€ä¸ª pod ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨ï¼Œè€Œå…¶ä¸­æœ‰ä¸€ä¸ªå®¹å™¨æŒ‚æ‰äº†ï¼Œæ­¤æ—¶ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ å¯ä»¥ä½¿ç”¨å­˜æ´»æ¢é’ˆï¼Œä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ä¸åŒçš„æ¢æµ‹æ–¹æ¡ˆï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨ tcp æ¢é’ˆï¼Œè®© pod ä¸­çš„æ¯ä¸ªå®¹å™¨æš´éœ²ä¸€ä¸ªç«¯å£ï¼Œç„¶åå­˜æ´»æ¢é’ˆåˆ†åˆ«å°è¯•ä¸è¿™äº›ç«¯å£å»ºç«‹è¿æ¥ï¼Œå¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªç«¯å£å»ºç«‹è¿æ¥å¤±è´¥ï¼Œåˆ™è¯´æ˜å®¹å™¨å‡ºç°äº†é—®é¢˜ï¼Œç„¶å k8s å°±ä¼šåˆ é™¤è¿™ä¸ªæœ‰é—®é¢˜çš„ podï¼Œå¹¶æ–°å»ºä¸€ä¸ªç›¸åŒçš„ pod æ›¿ä»£ã€‚\nç›¸å…³å‘½ä»¤ æŸ¥çœ‹ä¸€ä¸ª pod çš„ yaml å®šä¹‰\n$ kubectl get po [pod name] -o [yaml|json] -o å¯ä»¥è¾“å…¥ yaml æˆ–è€… json\næŸ¥çœ‹ pod yaml çš„å­—æ®µå«ä¹‰\n$ kubectl explain pods åˆ›å»º pod\n$ kubectl [create|apply] -f [srcFile] é€šè¿‡ srcFile æ¥åˆ›å»º podï¼Œè¯¥æ–‡ä»¶å¯ä»¥æ˜¯ yaml æˆ–è€… json\n**æŸ¥çœ‹å½“å‰çš„ pod **\n$ kubectl get pods è·å– pod æ—¥å¿—\n$ kubectl logs [podName] è·å–æŒ‡å®šå®¹å™¨çš„æ—¥å¿—\n$ kubectl logs [podName] -c [containerName] æ›´æ–° pod\nä¿®æ”¹ yaml åé‡æ–°æ‰§è¡Œ\n$ kubectl apply -f [srcFile] è¿™åªé€‚ç”¨äºæ›´æ”¹ Pod ä¸­å®¹å™¨ï¼ˆåŒ…æ‹¬å·¥ä½œå®¹å™¨ä¸åˆå§‹åŒ–å®¹å™¨ï¼‰çš„é•œåƒï¼Œä»¥åŠ activeDeadlineSeconds ï¼ˆå¯¹ Job ç±»å‹çš„ Pod å®šä¹‰å¤±è´¥é‡è¯•çš„æœ€å¤§æ—¶é—´ï¼‰ï¼Œ tolerations ï¼ˆPod å¯¹æ±¡ç‚¹çš„å®¹å¿ï¼‰\nå¦‚æœæ˜¯å…¶ä»–æƒ…å†µï¼Œåˆ™éœ€è¦åˆ é™¤åé‡æ–°åˆ›å»ºå®¹å™¨\nKubernetes å¯¹ Pod çš„æ›´æ–°åšäº†é™åˆ¶ï¼Œé™¤äº†æ›´æ”¹ Pod ä¸­å®¹å™¨ï¼ˆåŒ…æ‹¬å·¥ä½œå®¹å™¨ä¸åˆå§‹åŒ–å®¹å™¨ï¼‰çš„é•œåƒï¼Œä»¥åŠ activeDeadlineSeconds ï¼ˆå¯¹ Job ç±»å‹çš„ Pod å®šä¹‰å¤±è´¥é‡è¯•çš„æœ€å¤§æ—¶é—´ï¼‰ï¼Œ tolerations ï¼ˆPod å¯¹æ±¡ç‚¹çš„å®¹å¿ï¼‰ï¼Œä¿®æ”¹å…¶å®ƒéƒ¨åˆ†å°†ä¸ä¼šäº§ç”Ÿä½œç”¨ï¼Œå¦‚æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨å‰é¢ Pod å®šä¹‰æ–‡æ¡£ pod-test.yaml ä¸­å°†å®¿ä¸»æœºç«¯å£ 8081 æ”¹ä¸º 8082ï¼Œé‡æ–°æ‰§è¡Œ kubectl applyï¼Œ å°†æç¤ºå¦‚ä¸‹é”™è¯¯ï¼š\nThe Pod \u0026quot;nginx\u0026quot; is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`, `spec.initContainers[*].image`, `spec.activeDeadlineSeconds`, `spec.tolerations` (only additions to existing tolerations) or `spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative) åˆ é™¤ pod\n$ kubectl delete [podName] pod æä¾›å¯¹å¤–è®¿é—® å¯¹å¤–è®¿é—® pod çš„æœ€æ™®éæ–¹å¼æ˜¯ä½¿ç”¨ serviceï¼Œä½† service æ˜¯ä¸€ä¸ªç›¸å½“é‡è¦çš„å†…å®¹ï¼Œæ‰€ä»¥ä¼šå¦èµ·ä¸€ç¯‡ç¬”è®°ï¼Œåœ¨æœ¬ç¯‡ç¬”è®°ä¸­åªä¼šè®°å½•é™¤ service å¤–çš„æ–¹å¼ï¼Œè¿™äº›æ–¹å¼å¹¶ä¸å¸¸ç”¨ï¼Œä»…ä½œä¸ºè®°å½•ã€‚\nhostNetwork åœ¨ yaml ä¸­æ·»åŠ  hostNetwork: true å­—æ®µï¼š\napiVersion: v1 kind: Pod metadata: name: nginx spec: hostNetwork: true containers: - name: nginx image: nginx æ‰§è¡Œ yamlï¼š\n$ kubectl apply -f hostnetwork.yaml æŸ¥çœ‹ podï¼š\n$ kubectl get po -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx 1/1 Running 0 18m 192.168.49.2 minikube \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; æ­¤æ—¶é€šè¿‡ pod IP å°±å¯ä»¥è¿›è¡Œè®¿é—®äº†ï¼š\n$ curl 192.168.49.2 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; HostPort å‚è€ƒ pod å®æˆ˜ éƒ¨åˆ†\nport-forward ä½¿ç”¨ kubectl è‡ªå¸¦çš„ç«¯å£è½¬å‘å‘½ä»¤ï¼š\n$ kubectl port-forward [podName] [å¯¹å¤–æš´éœ²çš„ç«¯å£]:[podå†…éƒ¨ç«¯å£] æ¯”å¦‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šå®è·µï¼ˆè®¿é—®è¿™ä¸ª pod ä¼šè¾“å‡ºä¸€å¥è°šè¯­ï¼Œå‚è€ƒä¹¦ä¸Šçš„ p168ï¼‰ï¼š\n$ kubectl port-forward fortune 8080:80 Forwarding from 127.0.0.1:8080 -\u0026gt; 80 Forwarding from [::1]:8080 -\u0026gt; 80 æ­¤æ—¶ä¸Šé¢çš„ shell ä¼šé˜»å¡ï¼Œæ–°å¼€ä¸€ä¸ª shellï¼Œæ‰§è¡Œ curlï¼š\n$ curl http://localhost:8080 Q:\tHow many psychiatrists does it take to change a light bulb? A:\tOnly one, but it takes a long time, and the light bulb has to really want to change. ğŸ¤”ï¸ ç–‘é—®ï¼š\n1ï¼‰curl å¿…é¡»è¦æ·»åŠ  http åè®®æ‰è¡Œï¼Œå¦‚æœåªæ˜¯ curl localhost 8080 ä¼šæŠ¥é”™ï¼šcurl: (7) Failed to connect to localhost port 80: Connection refusedï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ\nğŸ˜… æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æ˜¯ curl localhost:8080ï¼Œcurl http://localhost:8080 å’Œ curl localhost:8080 å®é™…æ˜¯ä¸€æ ·çš„\n2ï¼‰æ­¤å¤–ï¼Œæˆ‘åœ¨å®¿ä¸»æœºç”¨ curl è™šæ‹ŸæœºIP:8080 ä¹Ÿæ— æ³•æˆåŠŸè®¿é—®ï¼Œåªæœ‰åœ¨è™šæ‹Ÿæœºå†…éƒ¨æ‰è¡Œ\npod å®æˆ˜ é€šè¿‡å®æˆ˜åˆ›å»ºä¸€ä¸ª nginx pod\nnginx yaml å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 hostPort: 8080 åˆ›å»º pod\n$ kubectl apply -f nginx_pod.yaml ç­‰å¾…ä¸€ä¼šï¼Œç›´åˆ°åˆ›å»ºå®Œæˆ\n$ kubectl get pods NAME READY STATUS RESTARTS AGE nginx 0/1 ContainerCreating 0 2s NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 2m17s åœ¨ yaml ä¸­è®¾ç½®äº† hostPort ä¸º 8080ï¼Œä»£è¡¨å¯¹å¤–æš´éœ² 8080 ç«¯å£ï¼Œæ˜ å°„åˆ°å®¹å™¨å†…éƒ¨çš„ 80 ç«¯å£ï¼Œæ­¤æ—¶ä¾¿å¯ä»¥é€šè¿‡ IP:8080 è¿›è¡Œè®¿é—®äº†ï¼Œå¦‚æœä¸è®¾ç½® hostPortï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ kubectl exec -it nginx sh è¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œæ‰§è¡Œ curl localhostï¼Œå¯ä»¥çœ‹åˆ° nginx æ¬¢è¿é¡µçš„ HTML ä»£ç ã€‚\næ ‡ç­¾ æ ‡ç­¾ç”¨æ¥ä¸º pod è¿›è¡Œåˆ†ç±»ã€‚\næœ‰å‡ ç§æ–¹å¼å¯ä»¥ä¸º pod åˆ›å»ºæ ‡ç­¾ï¼š\nåœ¨ yaml ä¸­çš„ metadata labels ä¸­æŒ‡å®šï¼Œæ ‡ç­¾æ˜¯ key:value çš„æ–¹å¼ï¼Œkey éœ€è¦å…¨å±€å”¯ä¸€ï¼Œæ¯”å¦‚åœ¨ä¸Šé¢ nginx yaml ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ª app: nginx æ ‡ç­¾ã€‚ ä½¿ç”¨ kubectl label po nginx key=value æ·»åŠ æ ‡ç­¾ pod çš„ key å¿…é¡»å”¯ä¸€ï¼Œå¦åˆ™æŠ¥é”™ï¼š\n$ kubectl label po nginx key=value1 error: 'key' already has a value (value), and --overwrite is false æŸ¥çœ‹ pod çš„æ‰€æœ‰æ ‡ç­¾ï¼š\n$ kubectl get po --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx 1/1 Running 0 118m app=nginx,key=value æŸ¥çœ‹ pod çš„æŸä¸ªæ ‡ç­¾ï¼š\n$ kubectl get po -L app,key NAME READY STATUS RESTARTS AGE APP KEY nginx 1/1 Running 0 120m nginx value ä¿®æ”¹ pod çš„æ ‡ç­¾ï¼š\n$ kubectl label po nginx key=value1 --overwrite pod/nginx labeled $ kubectl get po --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx 1/1 Running 0 122m app=nginx,key=value1 æŒ‡å®š --overwrite è¿›è¡Œä¿®æ”¹\nå°† pod è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹ å¯ä»¥ä¸ºæŸä¸ª node è®¾ç½®ä¸€ä¸ªæ ‡ç­¾ï¼Œç„¶ååœ¨ pod yaml ä¸­æŒ‡å®š spec.nodeSelector ï¼Œä¿è¯ pod è¢«è°ƒåº¦åˆ°ç¬¦åˆå…¶éœ€æ±‚çš„èŠ‚ç‚¹ã€‚\né€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¸º node è®¾ç½®æ ‡ç­¾ï¼š\n$ kubectl label node [nodeName] [key=value] pod yaml æŒ‡å®šè¢«è°ƒåº¦èŠ‚ç‚¹ï¼š\napiVersion: vl kind: Pod metadata: name: kubia-gpu spec: nodeSelector: gpu: \u0026quot;true\u0026quot; containers: - image: luksa/kubia name: kubia ä»¥ä¸Šä¼šä¿è¯è¯¥ pod è¢«è°ƒåº¦åˆ° gpu=true çš„èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡ nodeSelector æŒ‡å®šã€‚\npod å¦‚ä½•è°ƒåº¦ ä¹‹å‰å®éªŒä½¿ç”¨çš„éƒ½æ˜¯å•èŠ‚ç‚¹æ–¹å¼ï¼Œæ‰€ä»¥æ²¡åœ¨æ„ pod æ˜¯å¦‚ä½•è°ƒåº¦çš„ï¼Œåæ¥ç”¨ kind æ­å»ºäº†ä¸€ä¸ª 3 èŠ‚ç‚¹çš„ k8s é›†ç¾¤åæ‰æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥åšäº†ä¸€ä¸ªå®éªŒï¼š\nå½“å‰é›†ç¾¤çš„ nodeï¼š\n$ kubectl get node -o wide | awk '{printf \u0026quot;%-30s%-15s\\n\u0026quot;, $1, $6}' NAME INTERNAL-IP kind-control-plane 172.18.0.2 kind-worker 172.18.0.4 kind-worker2 172.18.0.3 åˆ›å»º 3 ä¸ª nginx podï¼ˆä½¿ç”¨ deploymentï¼‰\napiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: name: nginx labels: app: nginx spec: containers: - image: nginx name: nginx æŸ¥çœ‹ poï¼š\n$ kubectl get po -o wide | awk '{printf \u0026quot;%-30s%-15s\\n\u0026quot;, $1,$9}' NAME NODE nginx-66b9cc684d-8l7hg kind-worker2 nginx-66b9cc684d-flj48 kind-worker nginx-66b9cc684d-hxzc9 kind-worker å‘ç°è¿™ä¸‰ä¸ª pod éƒ½è¢«è°ƒåº¦åˆ° worker èŠ‚ç‚¹ï¼Œæ²¡æœ‰è¢«è°ƒåº¦åˆ° kind-control-plane èŠ‚ç‚¹ï¼Œç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œå¾—çŸ¥ pod çš„è°ƒåº¦æ˜¯ç”± kube-scheduler æ¥æ‰§è¡Œçš„ï¼Œæœ‰ä¸€ç³»åˆ—è§„åˆ™æ¥å®Œæˆè¿™ä»¶äº‹ï¼Œæ¯”å¦‚å®˜æ–¹æ–‡æ¡£é‡Œæ‰€æè¿°çš„ï¼š\nkube-scheduler ç»™ä¸€ä¸ª pod åšè°ƒåº¦é€‰æ‹©åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š\nè¿‡æ»¤ æ‰“åˆ† è¿‡æ»¤é˜¶æ®µä¼šå°†æ‰€æœ‰æ»¡è¶³ Pod è°ƒåº¦éœ€æ±‚çš„ Node é€‰å‡ºæ¥ã€‚ ä¾‹å¦‚ï¼ŒPodFitsResources è¿‡æ»¤å‡½æ•°ä¼šæ£€æŸ¥å€™é€‰ Node çš„å¯ç”¨èµ„æºèƒ½å¦æ»¡è¶³ Pod çš„èµ„æºè¯·æ±‚ã€‚ åœ¨è¿‡æ»¤ä¹‹åï¼Œå¾—å‡ºä¸€ä¸ª Node åˆ—è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ï¼›é€šå¸¸æƒ…å†µä¸‹ï¼Œ è¿™ä¸ª Node åˆ—è¡¨åŒ…å«ä¸æ­¢ä¸€ä¸ª Nodeã€‚å¦‚æœè¿™ä¸ªåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œä»£è¡¨è¿™ä¸ª Pod ä¸å¯è°ƒåº¦ã€‚\nåœ¨æ‰“åˆ†é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¼šä¸º Pod ä»æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ä¸­é€‰å–ä¸€ä¸ªæœ€åˆé€‚çš„ Nodeã€‚ æ ¹æ®å½“å‰å¯ç”¨çš„æ‰“åˆ†è§„åˆ™ï¼Œè°ƒåº¦å™¨ä¼šç»™æ¯ä¸€ä¸ªå¯è°ƒåº¦èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ã€‚\næœ€åï¼Œkube-scheduler ä¼šå°† Pod è°ƒåº¦åˆ°å¾—åˆ†æœ€é«˜çš„ Node ä¸Šã€‚ å¦‚æœå­˜åœ¨å¤šä¸ªå¾—åˆ†æœ€é«˜çš„ Nodeï¼Œkube-scheduler ä¼šä»ä¸­éšæœºé€‰å–ä¸€ä¸ªã€‚\né‰´äºç›®å‰å®åŠ›æœ‰é™ï¼Œæ— æ³•æ‘¸æ¸…å…·ä½“çš„æµç¨‹ï¼Œå¾…æˆ‘æ—¥åç ”ç©¶å†è¯¦ç»†å±•å¼€ï¼ˆï¼‰\n","date":"2022å¹´05æœˆ04æ—¥","permalink":"/posts/k8s-pod-bi-ji/","summary":"æœ¬ç¯‡ç¬”è®°æ‘˜è‡ª ã€ŠKubernetes in Aciton ã€‹ç¬¬ä¸‰ç« ï¼špodï¼šè¿è¡Œäº Kubernetes ä¸­çš„å®¹å™¨","title":"k8s pod"},{"contents":"è¿™æ˜¯ä¸€ä¸ªå›°æ‰°æˆ‘å·²ä¹…çš„é—®é¢˜ï¼Œå½“é€‰ä¸­ä¸€æ®µä»£ç å¹¶ç»§ç»­å‘ä¸‹æ»‘åŠ¨æ—¶ï¼Œæ»‘åŠ¨é€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œå¯¼è‡´æ— æ³•å‡†ç¡®é€‰ä¸­æˆ‘æƒ³è¦çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚æˆ‘çš„å±å¹•èƒ½æ˜¾ç¤º200è¡Œä»£ç ï¼Œæˆ‘æƒ³é€‰ä¸­1-250è¡Œçš„ä»£ç ï¼Œè¿™å°±éœ€è¦æˆ‘å‘ä¸‹æ»‘åŠ¨æ¥é€‰ä¸­å‰©ä½™çš„50è¡Œï¼Œä½†æ˜¯å› ä¸ºé€Ÿåº¦å¤ªå¿«ï¼Œå¯¼è‡´æˆ‘è½»è½»ä¸€æ»‘å°±ä¼šç¬é—´è·‘åˆ°ç¬¬800è¡Œä»£ç çš„ä½ç½®ï¼Œäºæ˜¯æˆ‘åˆè¦å‘ä¸Šæ»‘åŠ¨ï¼Œç»“æœåˆç¬é—´åˆ°äº†ç¬¬150è¡Œï¼Œéå¸¸ä»¤äººè›‹ç–¼ã€‚\nåœ¨ç½‘ä¸Šç”¨ä¸­æ–‡æœç´¢ä¸åˆ°ç›¸å…³çš„é—®é¢˜ï¼Œæ²¡åŠæ³•åªèƒ½ç”¨æˆ‘è¹©è„šçš„è‹±æ–‡æœç´¢ vscode scroll too fast selectingï¼Œæ²¡æƒ³åˆ°è¿˜æ‰¾å‡ºæ¥ä¸å°‘ï¼Œçœ‹æ¥æœ‰æ—¶å€™è¿˜æ˜¯å¾—ç”¨è‹±æ–‡æœç´¢æ‰èƒ½è§£å†³é—®é¢˜ã€‚https://github.com/microsoft/vscode/issues/40890 è¿™é‡Œæè¿°äº†åŒæ ·çš„é—®é¢˜ï¼Œä½†æ˜¯é‡Œé¢çš„è§£å†³æ–¹æ¡ˆéƒ½å¯¹æˆ‘æ— æ•ˆï¼Œåƒ \u0026quot;editor.smoothScrolling\u0026quot;: trueï¼Œeditor.mouseWheelScrollSensitivity:0.1 è¿™äº›éƒ½ä¸è¡Œï¼Œä¼¼ä¹ vscode æœ¬èº«ä¹Ÿæ²¡æœ‰æä¾›ä¸€ä¸ªä¸“é—¨é’ˆå¯¹é€‰ä¸­åæ»‘åŠ¨é€Ÿåº¦çš„é€‰é¡¹ã€‚\næœ€ååœ¨ https://stackoverflow.com/questions/44374762/visual-studio-code-scroll-speed-too-fast-for-selecting-with-mouse è¿™é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªå°†å°†å°±çš„è§£å†³æ–¹æ¡ˆ:\nWhile not a solution to the scroll speed issue, there is a rather trivial workaround. Select part of the region you want selected, scroll down to the point the region to select ends and Shift-Click. Voila, whole region selected.\næ„æ€å°±æ˜¯å…ˆé€‰ä¸­ä¸€å°éƒ¨åˆ†æ–‡å­—ï¼Œç„¶åæ¾å¼€é¼ æ ‡/è§¦æ§æ¿ï¼Œç„¶åå‘ä¸‹æ»‘åŠ¨åˆ°è¦é€‰æ‹©å†…å®¹çš„æœ«å°¾ï¼Œå† shift + å·¦é”®ç‚¹å‡»æ­¤å¤„ï¼Œå³å¯å®ŒæˆåŒºåŸŸé€‰æ‹©ã€‚\n","date":"2022å¹´04æœˆ10æ—¥","permalink":"/posts/vscode-xuan-zhong-wen-ben-shi-hua-dong-su-du-guo-kuai/","summary":"è¿™æ˜¯ä¸€ä¸ªå›°æ‰°æˆ‘å·²ä¹…çš„é—®é¢˜ï¼Œå½“é€‰ä¸­ä¸€æ®µä»£ç å¹¶ç»§ç»­å‘ä¸‹æ»‘åŠ¨æ—¶ï¼Œæ»‘åŠ¨é€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œå¯¼è‡´æ— æ³•å‡†ç¡®é€‰ä¸­æˆ‘æƒ³è¦çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚æˆ‘çš„å±å¹•èƒ½æ˜¾ç¤º200è¡Œä»£ç ï¼Œæˆ‘æƒ³é€‰ä¸­1-250è¡Œçš„ä»£ç ï¼Œè¿™å°±éœ€è¦æˆ‘å‘ä¸‹æ»‘åŠ¨æ¥é€‰ä¸­å‰©ä½™çš„50è¡Œï¼Œä½†æ˜¯å› ä¸ºé€Ÿåº¦å¤ªå¿«ï¼Œå¯¼è‡´æˆ‘è½»è½»ä¸€æ»‘å°±ä¼šç¬é—´è·‘åˆ°ç¬¬800è¡Œä»£ç çš„ä½ç½®ï¼Œäºæ˜¯æˆ‘åˆè¦å‘ä¸Šæ»‘åŠ¨ï¼Œç»“æœåˆç¬é—´åˆ°äº†ç¬¬150è¡Œï¼Œéå¸¸ä»¤äººè›‹ç–¼ã€‚\nåœ¨ç½‘ä¸Šç”¨ä¸­æ–‡æœç´¢ä¸åˆ°ç›¸å…³çš„é—®é¢˜ï¼Œæ²¡åŠæ³•åªèƒ½ç”¨æˆ‘è¹©è„šçš„è‹±æ–‡æœç´¢ vscode scroll too fast selectingï¼Œæ²¡æƒ³åˆ°è¿˜æ‰¾å‡ºæ¥ä¸å°‘ï¼Œçœ‹æ¥æœ‰æ—¶å€™è¿˜æ˜¯å¾—ç”¨è‹±æ–‡æœç´¢æ‰èƒ½è§£å†³é—®é¢˜ã€‚https://github.","title":"vscode é€‰ä¸­æ–‡æœ¬æ—¶æ»‘åŠ¨é€Ÿåº¦è¿‡å¿«"},{"contents":"å®‰è£…ï¼š curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --write-kubeconfig-mode 666 \u0026ndash;write-kubeconfig-modeè®¾ç½®è¯»å†™æƒé™ï¼Œå¦åˆ™æ¯æ¬¡ kubectl éƒ½è¦ sudoï¼ŒåŒæ—¶ä½¿ç”¨å›½å†…é•œåƒè¿›è¡Œä¸‹è½½\nè®¾ç½®é•œåƒ å‚è€ƒ https://blog.csdn.net/xs20691718/article/details/106515605\n# 1 cp /var/lib/rancher/k3s/agent/etc/containerd/config.toml /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl # æ‹·è´ä¸€ä»½é…ç½®æ–‡ä»¶ # 2 sudo vim /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl # åœ¨ config.toml.tmpl æ–‡ä»¶ä¸­æ·»åŠ  [plugins.cri.registry.mirrors] [plugins.cri.registry.mirrors.\u0026quot;docker.io\u0026quot;] endpoint = [\u0026quot;https://docker.mirrors.ustc.edu.cn\u0026quot;] # 3 é‡å¯æœåŠ¡ systemctl restart k3s # 4 æŸ¥çœ‹ä¿®æ”¹æ˜¯å¦æˆåŠŸ sudo crictl info | grep mirror åˆ›å»º pod ä¸€ç›´å¤„äº pending çŠ¶æ€ ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯æ±¡ç‚¹é—®é¢˜ï¼Œå› ä¸º pod æè¿°ä¸­æœ‰ warning è­¦å‘Šï¼š0/1 nodes are available: 1 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn\u0026rsquo;t tolerate.ï¼Œä½¿ç”¨ kubectl describe node [nodename] æŸ¥çœ‹ï¼Œå‘ç°èŠ‚ç‚¹çš„æ±¡ç‚¹ä¸º :NoScheduleï¼Œè€Œ pod çš„ Tolerations æ˜¯ :NoExecuteï¼Œå…ˆå°è¯•ç§»é™¤èŠ‚ç‚¹çš„æ±¡ç‚¹ï¼Œä½¿ç”¨ kubectl taint nodes node1 key1:NoSchedule- è¿›è¡Œç§»é™¤ï¼Œä½†æ˜¯ç§»é™¤åæ‰§è¡Œ kubectl get no -o yaml | grep taint -A 5 å‘ç°ä¾ç„¶æ˜¾ç¤ºæœ‰æ±¡ç‚¹ï¼ˆæ­£å¸¸åº”è¯¥è¾“å‡ºä¸ºç©ºï¼‰ï¼Œéš¾é“æ˜¯ç§»é™¤æ±¡ç‚¹å¤±æ•ˆäº†å—ï¼Ÿç½‘ä¸Šä¹ŸæŸ¥ä¸åˆ°ä»»ä½•ç›¸å…³èµ„æ–™ï¼Œäºæ˜¯åˆå°è¯•æ›´æ”¹ pod çš„å®¹å¿åº¦ï¼Œä¿®æ”¹ yaml æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\ntolerations: - key: \u0026quot;node.kubernetes.io/disk-pressure\u0026quot; operator: \u0026quot;Exists\u0026quot; effect: \u0026quot;NoSchedule\u0026quot; ä¹‹åå†é‡æ–°æ‰§è¡Œ kubectl apply -f é‡æ–°åˆ›å»º podï¼Œå‘ç°è¿˜æ˜¯æ— æ•ˆã€‚æœ€åé‡å¯äº†ä¸€ä¸‹ k3s ï¼Œç„¶åè«åå…¶å¦™çš„å‘ç° pod åˆ›å»ºæˆåŠŸäº†ï¼Œæ­¤æ—¶å†æŸ¥çœ‹ node æè¿°ä¿¡æ¯ï¼Œå‘ç° taint ä¸º none äº†ã€‚\nä¸€å¼€å§‹çš„ pod æè¿°ä¿¡æ¯ä¸­è¿˜æœ‰ä¸€æ¡é”™è¯¯ä¿¡æ¯ï¼š kubernetes The node was low on resource: ephemeral-storage.â€ Evicted ï¼Œç½‘ä¸Šæ‰¾äº†åŠå¤©èµ„æ–™ï¼Œä¹Ÿæ²¡æœ‰çœ‹åˆ°å¾ˆå¥½çš„è§£å†³æ–¹æ³•ï¼ˆå…¶å®æ˜¯æˆ‘çœ‹ä¸æ‡‚ğŸ˜…ï¼‰\nâ€‹\t====================== æ›´æ–° ======================\nç ´æ¡ˆäº†ï¼Œæ³¨æ„ node çš„æ±¡ç‚¹ key æ˜¯ node.kubernetes.io/disk-pressureï¼ŒæŸ¥äº†ä¸€ä¸‹è¿™è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„ç£ç›˜å®¹é‡ä¸è¶³ï¼Œè¯¥æ±¡ç‚¹ä¼šé˜»æ­¢ pod è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä¸”æ— æ³•å»é™¤ï¼Œè¿™å°±æ˜¯ pod ä¸€ç›´ pending çš„åŸå› ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯ multipass åˆ›å»ºçš„è™šæ‹Ÿæœºï¼Œé»˜è®¤åªåˆ†é…çš„ 5G çš„ç£ç›˜ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±æ»¡äº†ï¼Œå¯¼è‡´ k3s å‡ºç°è¿™ä¸€æ±¡ç‚¹ï¼Œåªè¦é‡æ–°åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºå¹¶åˆ†é…å¤§ä¸€äº›çš„ç£ç›˜ç©ºé—´å³å¯ï¼ˆä¹Ÿå¯ä»¥è°ƒæ•´ç°æœ‰è™šæ‹Ÿæœºçš„ç£ç›˜ç©ºé—´ï¼Œä½†æ˜¯æœ‰äº›éº»çƒ¦ï¼Œå°è¯•æ— æœåæ”¾å¼ƒäº†ï¼‰\nè€å®è¯´ç¬¬ä¸€æ¬¡ç”¨è¿™ä¸ª k3sï¼Œæ„Ÿè§‰æ¯” minikube è¦éš¾ç”¨å¾ˆå¤šï¼Œå‘ç”Ÿäº†ä¸å°‘è«åå…¶å¦™çš„é—®é¢˜ï¼Œä¸è¿‡å†…å­˜å ç”¨ç¡®å®è¦ä½å¾—å¤šï¼Œæš‚ä¸”å…ˆæ‘¸ç´¢ä¸€ä¸‹å§ï¼Œåˆšå¥½è¿˜å­¦åˆ°äº†æ±¡ç‚¹è¿™ä¸ªæ–°çŸ¥è¯†ã€‚\n","date":"2022å¹´04æœˆ08æ—¥","permalink":"/posts/k3s/","summary":"å®‰è£…ï¼š curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --write-kubeconfig-mode 666 \u0026ndash;write-kubeconfig-modeè®¾ç½®è¯»å†™æƒé™ï¼Œå¦åˆ™æ¯æ¬¡ kubectl éƒ½è¦ sudoï¼ŒåŒæ—¶ä½¿ç”¨å›½å†…é•œåƒè¿›è¡Œä¸‹è½½","title":"k3s è¸©å‘è®°å½•"},{"contents":"èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼• ç´¢å¼•ç±»å‹åˆ†ä¸ºä¸»é”®ç´¢å¼•å’Œéä¸»é”®ç´¢å¼•ã€‚\nä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„æ˜¯æ•´è¡Œæ•°æ®ã€‚åœ¨InnoDBé‡Œï¼Œä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºèšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰ã€‚\néä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å†…å®¹æ˜¯ä¸»é”®çš„å€¼ã€‚åœ¨InnoDBé‡Œï¼Œéä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆsecondary indexï¼‰ã€‚\næ¯”å¦‚åœ¨ä¸Šå›¾ä¸­ï¼ŒID å°±æ˜¯èšç°‡ç´¢å¼•ï¼ŒK æ˜¯éèšç°‡ç´¢å¼•\næ ¹æ®ä¸Šé¢çš„ç´¢å¼•ç»“æ„è¯´æ˜ï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼šåŸºäºä¸»é”®ç´¢å¼•å’Œæ™®é€šç´¢å¼•çš„æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\nå¦‚æœè¯­å¥æ˜¯ select * from T where ID=500ï¼Œå³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢IDè¿™æ£µB+æ ‘ï¼› å¦‚æœè¯­å¥æ˜¯ select * from T where k=5ï¼Œå³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢kç´¢å¼•æ ‘ï¼Œå¾—åˆ°IDçš„å€¼ä¸º500ï¼Œå†åˆ°IDç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›è¡¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸºäºéä¸»é”®ç´¢å¼•çš„æŸ¥è¯¢éœ€è¦å¤šæ‰«æä¸€æ£µç´¢å¼•æ ‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ä¸­åº”è¯¥å°½é‡ä½¿ç”¨ä¸»é”®æŸ¥è¯¢ã€‚\nå›è¡¨æŸ¥è¯¢ åœ¨ä¸Šå›¾ä¸­ï¼Œå¦‚æœæ‰§è¡Œ select * from T where k between 3 and 5ï¼Œéœ€è¦æ‰§è¡Œå‡ æ¬¡æ ‘çš„æœç´¢æ“ä½œï¼Œä¼šæ‰«æå¤šå°‘è¡Œï¼Ÿ\nåœ¨ k ç´¢å¼•æ ‘ä¸Šæ‰¾åˆ° k=3 çš„è®°å½•ï¼Œå–å¾— ID = 300ï¼›\nå†åˆ° ID ç´¢å¼•æ ‘æŸ¥åˆ° ID=300 å¯¹åº”çš„ R3ï¼›ï¼ˆå› ä¸ºæŸ¥è¯¢çš„æ˜¯ *ï¼Œæ‰€ä»¥éœ€è¦å»ä¸»é”®ç´¢å¼•å¤„æ‹¿åˆ°æ•´è¡Œçš„å€¼ï¼‰\nåœ¨ k ç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼ k=5ï¼Œå–å¾— ID=500ï¼›\nå†å›åˆ° ID ç´¢å¼•æ ‘æŸ¥åˆ° ID=500 å¯¹åº”çš„ R4ï¼›\nåœ¨ k ç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼ k=6ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå¾ªç¯ç»“æŸã€‚\nåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå›åˆ°ä¸»é”®ç´¢å¼•æ ‘æœç´¢çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¸ºå›è¡¨ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæŸ¥è¯¢è¿‡ç¨‹è¯»äº†kç´¢å¼•æ ‘çš„3æ¡è®°å½•ï¼ˆæ­¥éª¤1ã€3å’Œ5ï¼‰ï¼Œå›è¡¨äº†ä¸¤æ¬¡ï¼ˆæ­¥éª¤2å’Œ4ï¼‰ã€‚\nè¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•ï¼ˆcovering indexï¼‰æŒ‡ä¸€ä¸ªæŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œåªç”¨ä»ç´¢å¼•ä¸­å°±èƒ½å¤Ÿå–å¾—ï¼Œä¸å¿…ä»æ•°æ®è¡¨ä¸­è¯»å–ã€‚ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºå®ç°äº†ç´¢å¼•è¦†ç›–ã€‚ å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«äº†ï¼ˆæˆ–è¦†ç›–äº†ï¼‰æ»¡è¶³æŸ¥è¯¢è¯­å¥ä¸­å­—æ®µä¸æ¡ä»¶çš„æ•°æ®å°±å«åšè¦†ç›–ç´¢å¼•ã€‚\næ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœæ‰§è¡Œçš„è¯­å¥æ˜¯ select ID from T where k between 3 and 5ï¼Œè¿™æ—¶åªéœ€è¦æŸ¥ ID çš„å€¼ï¼Œè€Œ ID çš„å€¼å·²ç»åœ¨ k ç´¢å¼•æ ‘ä¸Šäº†ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æä¾›æŸ¥è¯¢ç»“æœï¼Œä¸éœ€è¦å›è¡¨ã€‚\n","date":"2022å¹´03æœˆ26æ—¥","permalink":"/posts/mysql-suo-yin/","summary":"èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼• ç´¢å¼•ç±»å‹åˆ†ä¸ºä¸»é”®ç´¢å¼•å’Œéä¸»é”®ç´¢å¼•ã€‚\nä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„æ˜¯æ•´è¡Œæ•°æ®ã€‚åœ¨InnoDBé‡Œï¼Œä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºèšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰ã€‚\néä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å†…å®¹æ˜¯ä¸»é”®çš„å€¼ã€‚åœ¨InnoDBé‡Œï¼Œéä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆsecondary indexï¼‰ã€‚","title":"MySQL ç´¢å¼•"},{"contents":"è¿™æ˜¯æˆ‘åœ¨çœ‹ Mysql Buffer Pool æ—¶çš„ä¸€ä¸ªç–‘é—®ï¼Œå…ˆè¯´è¯´ Buffer Poolï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒMysql ä¸ºè¯»å†™æ“ä½œæ·»åŠ äº†ä¸€å±‚ç¼“å­˜ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­æ“ä½œï¼Œé€Ÿåº¦ç›¸æ¯”æ“ä½œç¡¬ç›˜è¦å¿«å¾ˆå¤šï¼Œåªè¦ä¹‹åå†å°†å†…å­˜ä¸­çš„æ•°æ®å®šæœŸå†™å…¥åˆ°ç£ç›˜ä¸­å³å¯ä¿è¯æ•°æ®ä¸€è‡´ã€‚ä½†æ˜¯è¿™æ ·å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœåœ¨å†…å­˜å†™å…¥åˆ°ç£ç›˜ä¹‹å‰ï¼ŒMysql è¿›ç¨‹æŒ‚æ‰äº†ï¼Œè¿™æ ·å²‚ä¸æ˜¯å°±ä¸¢å¤±æ•°æ®äº†ï¼Ÿ\né€šè¿‡ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œäº†è§£äº† Mysql å¯¹äºè¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ³•ï¼šredo logï¼Œå¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œçš„æ“ä½œï¼Œä¼šåŒæ­¥æŠŠå¯¹åº”çš„æ—¥å¿—å†™å…¥åˆ° redo log ä¸­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸Šé¢çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ redo log è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘åˆäº§ç”Ÿäº†å‡ ä¸ªç–‘é—®ï¼š\nè¿™æ ·ä¸æ˜¯è¿˜ä¼šå‘ç”Ÿä¸Šé¢çš„é—®é¢˜å—ï¼Ÿå¦‚æœå†…å­˜ä¸­æ“ä½œäº†ï¼Œç„¶åæ•°æ®åº“è¿›ç¨‹æŒ‚æ‰äº†ï¼Œæ²¡æ¥å¾—åŠå†™å…¥åˆ° redo logï¼Œé‚£ä¸æ˜¯ä¸€æ ·ä¹Ÿå‘ç”Ÿä¸¢å¤±äº†å—ï¼Ÿ å¼•å…¥ buffer pool å°±æ˜¯ä¸ºäº†é˜²æ­¢ç›´æ¥æ“ä½œç¡¬ç›˜ï¼Œç°åœ¨åˆè¦åŒæ­¥å†™å…¥åˆ° redo log ä¸­ï¼Œç­‰äºè¿˜æ˜¯è¦æ“ä½œç¡¬ç›˜ï¼Œé‚£è¿˜æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ æŸ¥æ‰¾çš„ä¸€äº›è¯´æ³•ï¼ˆä¸ç¡®å®šæ­£ä¸æ­£ç¡®ï¼‰ï¼š\né€šè¿‡ WAL(Write Ahead Logï¼Œé¢„å†™æ—¥å¿—) æœºåˆ¶æ¥ä¿è¯ä¸ä¼šå‘ç”Ÿä¸Šé¢çš„æƒ…å†µï¼Œå³ï¼šå†™å…¥æ—¥å¿—ä¸€å®šå‘ç”Ÿåœ¨æ›´æ–°å†…å­˜ä¹‹å‰ï¼ˆå…³äº WAL æš‚æ—¶ä¹Ÿæ²¡æœ‰å®Œå…¨ç†è§£ï¼Œæ‰€ä»¥è¿™é‡Œæ ‡è®°ä¸ºå­˜ç–‘ï¼‰ å†™å…¥ redo log çš„æ–¹å¼ä½¿ç”¨äº†è¿½åŠ æ“ä½œï¼Œ æ‰€ä»¥ç£ç›˜æ“ä½œæ˜¯ é¡ºåºå†™ï¼Œè€Œå†™å…¥æ•°æ®éœ€è¦å…ˆæ‰¾åˆ°å†™å…¥ä½ç½®ï¼Œç„¶åæ‰å†™åˆ°ç£ç›˜ï¼Œæ‰€ä»¥ç£ç›˜æ“ä½œæ˜¯ éšæœºå†™ï¼ˆå…·ä½“å¯ä»¥å‚è§ç¡¬ç›˜çš„é¡ºåºè¯»å†™å’Œéšæœºè¯»å†™ï¼‰ï¼Œç£ç›˜çš„ã€Œé¡ºåºå†™ ã€æ¯”ã€Œéšæœºå†™ã€ é«˜æ•ˆçš„å¤šï¼Œå› æ­¤ redo log å†™å…¥ç£ç›˜çš„å¼€é”€æ›´å°ã€‚ ","date":"2022å¹´03æœˆ16æ—¥","permalink":"/posts/mysql-buffer-pool-de-yi-xie-yi-wen-ji-lu/","summary":"è¿™æ˜¯æˆ‘åœ¨çœ‹ Mysql Buffer Pool æ—¶çš„ä¸€ä¸ªç–‘é—®ï¼Œå…ˆè¯´è¯´ Buffer Poolï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒMysql ä¸ºè¯»å†™æ“ä½œæ·»åŠ äº†ä¸€å±‚ç¼“å­˜ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­æ“ä½œï¼Œé€Ÿåº¦ç›¸æ¯”æ“ä½œç¡¬ç›˜è¦å¿«å¾ˆå¤šï¼Œåªè¦ä¹‹åå†å°†å†…å­˜ä¸­çš„æ•°æ®å®šæœŸå†™å…¥åˆ°ç£ç›˜ä¸­å³å¯ä¿è¯æ•°æ®ä¸€è‡´ã€‚ä½†æ˜¯è¿™æ ·å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœåœ¨å†…å­˜å†™å…¥åˆ°ç£ç›˜ä¹‹å‰ï¼ŒMysql è¿›ç¨‹æŒ‚æ‰äº†ï¼Œè¿™æ ·å²‚ä¸æ˜¯å°±ä¸¢å¤±æ•°æ®äº†ï¼Ÿ","title":"Mysql Buffer Pool çš„ä¸€äº›ç–‘é—®è®°å½•"},{"contents":"å¼•å­ ä½¿ç”¨è¿‡ Go çš„å°ä¼™ä¼´åº”è¯¥éƒ½é‡åˆ°è¿‡è¿™æ ·ä¸€ä¸ªå‘ï¼šå½“ä½¿ç”¨ slice ä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œå¦‚æœè°ƒç”¨æ–¹å‡½æ•°å†…éƒ¨å‘ç”Ÿäº† append æ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„æ”¹å˜ä¸ä¼šåœ¨å®å‚å¤„ä½“ç°å‡ºæ¥ï¼Œæ¯”å¦‚ï¼š\npackage main import \u0026quot;fmt\u0026quot; func main() { slice := make([]int, 0, 0) slice = fn(slice) fmt.Println(\u0026quot;[main] slice: \u0026quot;, slice) } func fn(slice []int) (s []int) { s = append(slice, 1) fmt.Println(\u0026quot;[func] slice: \u0026quot;, s) } è¾“å‡ºï¼š\n[func] slice: [1] [main] slice: [] çœ‹è¿‡ä¸€äº›åšå®¢ï¼Œé‡Œé¢é˜è¿°çš„åŸå› æ˜¯ï¼šslice çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåä¸º SliceHeader çš„ç»“æ„ä½“ï¼š\ntype SliceHeader struct { Data uintptr Len int Cap int } å…¶ä¸­çš„ Data æŒ‡å‘åº•å±‚æ•°ç»„ï¼Œå°† slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ï¼Œå®é™…ä¸Šä¼ é€’çš„å°±æ˜¯è¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼Œè€Œ append å¯èƒ½ä¼šå¯¼è‡´æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯é‡æ–°åˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼Œå°†ä¹‹å‰çš„æ•°æ®æ‹·è´è¿‡å»ï¼Œå¹¶ä¸”é‡æ–°å°† Data æŒ‡å‘è¿™ä¸ªæ–°æ•°ç»„ï¼Œå› ä¸ºä¼ å…¥çš„å‚æ•°ä¸æ˜¯æŒ‡é’ˆç±»å‹è€Œæ˜¯å€¼ç±»å‹ï¼Œæ‰€ä»¥ Data çš„æ”¹å˜ä¸èƒ½ä½“ç°åœ¨å®å‚ä¸­ã€‚\nå¬èµ·æ¥æœ‰äº›é“ç†ï¼Œé‚£ä¹ˆå°±åŠ¨æ‰‹å®è·µä¸€ä¸‹ï¼Œçœ‹çœ‹å®é™…æƒ…å†µå¦‚ä½•ï¼š\npackage main import ( \u0026quot;reflect\u0026quot; \u0026quot;unsafe\u0026quot; \u0026quot;fmt\u0026quot; ) // é€šè¿‡åå°„æ¥è·å– slice å¯¹åº”çš„åº•å±‚ SliceHeader ç»“æ„ä½“ func getSliceHeader(slice []int) { struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;slice)) fmt.Printf(\u0026quot;%+v\\n\u0026quot;, struc) dataPtr := unsafe.Pointer(struc.Data) fmt.Println(dataPtr) } func sliceAppend(slice []int) { slice = append(slice, 1, 2, 3, 4) fmt.Println(\u0026quot;[func] sliceHeader info: \u0026quot;) getSliceHeader(slice) fmt.Println(\u0026quot;========================\u0026quot;) struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;slice)) dataPtr := unsafe.Pointer(struc.Data) data := *(*[4]int)(dataPtr) fmt.Println(\u0026quot;[func] after append, sliceHeader.data: \u0026quot;, data) } func main() { n := make([]int, 0, 0) fmt.Println(\u0026quot;[main] sliceHeader info: \u0026quot;) getSliceHeader(n) fmt.Println(\u0026quot;========================\u0026quot;) sliceAppend(n) fmt.Println(\u0026quot;[main] after call, slice data: \u0026quot;, n) struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;n)) dataPtr := unsafe.Pointer(struc.Data) data := *(*[4]int)(dataPtr) fmt.Println(\u0026quot;[main] sliceHeader.data\u0026quot;, data) } ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥æœ‰äº›é•¿ï¼Œå®é™…åªæ˜¯é€šè¿‡åå°„å»æ‹¿åˆ° slice å¯¹åº”çš„ SliceHeaderï¼Œå¹¶é€šè¿‡ unsafe æ¥è·å– data å¯¹åº”çš„åº•å±‚æ•°ç»„ï¼Œæ— éœ€è¿‡å¤šå…³æ³¨ã€‚\nè¾“å‡ºç»“æœï¼š\n[main] sliceHeader info: \u0026amp;{Data:4336299344 Len:0 Cap:0} 0x10276ad50 ======================== [func] sliceHeader info: \u0026amp;{Data:1374390272064 Len:4 Cap:4} 0x140000b4040 ======================== [func] after append, sliceHeader.data: [1 2 3 4] [main] after call, slice data: [] [main] sliceHeader.data [0 0 0 0] main é‡Œçš„ slice æ˜¯ä¸€ä¸ª len å’Œ cap éƒ½ä¸º 0 çš„ sliceï¼Œè€Œå‡½æ•°å†…éƒ¨éœ€è¦ append 4 ä¸ªå…ƒç´ ï¼Œè¿™åŠ¿å¿…ä¼šå‘ç”Ÿæ‰©å®¹ï¼Œä»ä¸Šé¢çš„è¾“å‡ºä¿¡æ¯ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œdata æŒ‡å‘çš„åœ°å€ç¡®å®å‘ç”Ÿäº†æ”¹å˜ï¼Œmain ä¸­ data æŒ‡å‘ 0x10276ad50ï¼Œè€Œ func ä¸­ data æŒ‡å‘äº† 0x140000b4040ã€‚\næ–°çš„ç–‘é—® åœ¨äº†è§£åŸå› åï¼Œæˆ‘åˆçªå‘å¥‡æƒ³ï¼Œæ—¢ç„¶æ˜¯å› ä¸ºæ‰©å®¹æ‰å¯¼è‡´çš„ä¸¢å¤±ï¼Œé‚£æˆ‘ä¸è®©ä»–æ‰©å®¹ä¸å°±å¥½äº†å—ï¼Ÿåœ¨ make æ—¶ç›´æ¥æŒ‡å®š cap ä¸º 20ï¼Œè€Œå‡½æ•°å†…åª append 4 ä¸ªå…ƒç´ ï¼Œè¿™æ ·å°±ä¸ä¼šæ‰©å®¹äº†ï¼Œæ­¤æ—¶ç»“æœä¼šå¦‚ä½•ï¼Ÿ\npackage main import ( \u0026quot;reflect\u0026quot; \u0026quot;unsafe\u0026quot; \u0026quot;fmt\u0026quot; ) func getSliceHeader(slice []int) { struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;slice)) fmt.Printf(\u0026quot;%+v\\n\u0026quot;, struc) dataPtr := unsafe.Pointer(struc.Data) fmt.Println(dataPtr) } func sliceAppend(slice []int) { slice = append(slice, 1, 2, 3, 4) fmt.Println(\u0026quot;[func] sliceHeader info: \u0026quot;) getSliceHeader(slice) fmt.Println(\u0026quot;========================\u0026quot;) struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;slice)) dataPtr := unsafe.Pointer(struc.Data) data := *(*[4]int)(dataPtr) fmt.Println(\u0026quot;[func] after append, sliceHeader.data: \u0026quot;, data) } func main() { n := make([]int, 0, 20) fmt.Println(\u0026quot;[main] sliceHeader info: \u0026quot;) getSliceHeader(n) fmt.Println(\u0026quot;========================\u0026quot;) sliceAppend(n) fmt.Println(\u0026quot;[main] after call, slice data: \u0026quot;, n) struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;n)) dataPtr := unsafe.Pointer(struc.Data) data := *(*[4]int)(dataPtr) fmt.Println(\u0026quot;[main] sliceHeader.data\u0026quot;, data) } è¾“å‡ºï¼š\n[main] sliceHeader info: \u0026amp;{Data:1374390001664 Len:0 Cap:20} 0x14000072000 ======================== [func] sliceHeader info: \u0026amp;{Data:1374390001664 Len:4 Cap:20} # æ³¨æ„è¿™é‡Œçš„ Len 0x14000072000 ======================== [func] after append, sliceHeader.data: [1 2 3 4] [main] after call, slice data: [] [main] sliceHeader.data [1 2 3 4] å¯ä»¥çœ‹åˆ°ï¼ŒSliceHeader.Data çš„æŒ‡å‘ç¡®å®æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œéƒ½æ˜¯ 0x14000072000ï¼Œå¹¶ä¸”é€šè¿‡æœ€åä¸€å¥è¾“å‡º [main] sliceHeader.data [1 2 3 4] å¯ä»¥å¾—çŸ¥ï¼Œåº•å±‚çš„æ•°ç»„ç¡®å®å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†æ˜¯æœ€ç»ˆ main çš„ slice è¾“å‡ºè¿˜æ˜¯ä¸ºç©ºï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\nä¸€ä¸ªçŒœæµ‹ï¼š\næˆ‘ä»¬åœ¨ main å‡½æ•°è°ƒç”¨ sliceAppend ä¹‹ååœ¨åŠ å…¥ä¸€æ®µè¯ï¼š\nsliceAppend(n) fmt.Println(\u0026quot;[main] after call, slice data: \u0026quot;, n) struc := (*reflect.SliceHeader)(unsafe.Pointer(\u0026amp;n)) dataPtr := unsafe.Pointer(struc.Data) data := *(*[4]int)(dataPtr) fmt.Println(\u0026quot;after call, sliceHeader info: \u0026quot;) // æ–°å¢ getSliceHeader(n)\t// æ–°å¢ è¾“å‡ºï¼š\nafter call, sliceHeader info: \u0026amp;{Data:1374390730752 Len:0 Cap:20} data address: 0x14000124000 å‘ç°åœ¨ append ä¹‹åï¼ŒLen ä¾ç„¶ä¸º 0ï¼Œéš¾é“è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼Ÿfmt.Println å¯èƒ½æ˜¯æ£€æµ‹åˆ° slice çš„ Len ä¸º 0ï¼Œæ‰€ä»¥å³ä¾¿åº•å±‚æ•°ç»„å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†è¿˜æ˜¯æ‰“å°å‡ºäº†ç©ºåˆ‡ç‰‡ï¼Ÿï¼ˆå…·ä½“è¿˜æ˜¯å¾—çœ‹ Println çš„æºç æ‰èƒ½çœŸæ­£çŸ¥é“åŸå› ï¼‰\nå› ä¸ºä¼ çš„ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥ Len çš„å˜åŒ–ä¸èƒ½åæ˜ åˆ°å®å‚ï¼Œåœ¨ä¹‹å‰çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œå½¢å‚çš„ Len å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼š\n[func] sliceHeader info: \u0026amp;{Data:1374390001664 Len:4 Cap:20} ç»¼ä¸Šæ‰€è¿°ï¼Œä»¥åå¦‚æœè¦æŠŠ slice ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä¸”è°ƒç”¨æ–¹è¦æ‰§è¡Œ append æ“ä½œï¼Œç›´æ¥ç»Ÿä¸€ä¼ é€’æŒ‡é’ˆå°±å¥½äº†ã€‚\n","date":"2022å¹´03æœˆ10æ—¥","permalink":"/posts/go-slice-append-de-keng-cun-yi/","summary":"å¼•å­ ä½¿ç”¨è¿‡ Go çš„å°ä¼™ä¼´åº”è¯¥éƒ½é‡åˆ°è¿‡è¿™æ ·ä¸€ä¸ªå‘ï¼šå½“ä½¿ç”¨ slice ä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œå¦‚æœè°ƒç”¨æ–¹å‡½æ•°å†…éƒ¨å‘ç”Ÿäº† append æ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„æ”¹å˜ä¸ä¼šåœ¨å®å‚å¤„ä½“ç°å‡ºæ¥ï¼Œæ¯”å¦‚ï¼š","title":"Go slice append çš„å‘ [å­˜ç–‘]"},{"contents":"é¡µçš„æ¦‚å¿µ çº¿ç¨‹æ€ä¹ˆè°ƒåº¦çš„ è¿›ç¨‹é—´é€šä¿¡æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œå“ªç§æ–¹å¼æœ€å¿«ï¼Ÿ 1.æ— åç®¡é“( pipe )ï¼šç®¡é“æ˜¯ä¸€ç§åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚è¿›ç¨‹çš„äº²ç¼˜å…³ç³»é€šå¸¸æ˜¯æŒ‡çˆ¶å­è¿›ç¨‹å…³ç³»ã€‚\n2.é«˜çº§ç®¡é“(popen)ï¼šå°†å¦ä¸€ä¸ªç¨‹åºå½“åšä¸€ä¸ªæ–°çš„è¿›ç¨‹åœ¨å½“å‰ç¨‹åºè¿›ç¨‹ä¸­å¯åŠ¨ï¼Œåˆ™å®ƒç®—æ˜¯å½“å‰ç¨‹åºçš„å­è¿›ç¨‹ï¼Œè¿™ç§æ–¹å¼æˆ‘ä»¬æˆä¸ºé«˜çº§ç®¡é“æ–¹å¼ã€‚\n3.æœ‰åç®¡é“ (named pipe) ï¼š æœ‰åç®¡é“ä¹Ÿæ˜¯åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œä½†æ˜¯å®ƒå…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚\n4.æ¶ˆæ¯é˜Ÿåˆ—( message queue ) ï¼š æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ã€ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚\n5.ä¿¡å·é‡( semophore ) ï¼š ä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚å®ƒå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚\n6.ä¿¡å· ( sinal ) ï¼š ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚\n7.å…±äº«å†…å­˜( shared memory ) ï¼šå…±äº«å†…å­˜å°±æ˜¯æ˜ å°„ä¸€æ®µèƒ½è¢«å…¶ä»–è¿›ç¨‹æ‰€è®¿é—®çš„å†…å­˜ï¼Œè¿™æ®µå…±äº«å†…å­˜ç”±ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œä½†å¤šä¸ªè¿›ç¨‹éƒ½å¯ä»¥è®¿é—®ã€‚å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ IPC æ–¹å¼ï¼Œå®ƒæ˜¯é’ˆå¯¹å…¶ä»–è¿›ç¨‹é—´é€šä¿¡æ–¹å¼è¿è¡Œæ•ˆç‡ä½è€Œä¸“é—¨è®¾è®¡çš„ã€‚å®ƒå¾€å¾€ä¸å…¶ä»–é€šä¿¡æœºåˆ¶ï¼Œå¦‚ä¿¡å·ä¸¤ï¼Œé…åˆä½¿ç”¨ï¼Œæ¥å®ç°è¿›ç¨‹é—´çš„åŒæ­¥å’Œé€šä¿¡ã€‚\n8.å¥—æ¥å­—( socket ) ï¼š å¥—è§£å­—ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œä¸å…¶ä»–é€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ç”¨äºä¸åŒæœºå™¨é—´çš„è¿›ç¨‹é€šä¿¡ã€‚\n","date":"2022å¹´02æœˆ15æ—¥","permalink":"/posts/cao-zuo-xi-tong-mian-shi-ti/","summary":"é¡µçš„æ¦‚å¿µ çº¿ç¨‹æ€ä¹ˆè°ƒåº¦çš„ è¿›ç¨‹é—´é€šä¿¡æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œå“ªç§æ–¹å¼æœ€å¿«ï¼Ÿ 1.æ— åç®¡é“( pipe )ï¼šç®¡é“æ˜¯ä¸€ç§åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚è¿›ç¨‹çš„äº²ç¼˜å…³ç³»é€šå¸¸æ˜¯æŒ‡çˆ¶å­è¿›ç¨‹å…³ç³»ã€‚","title":"æ“ä½œç³»ç»Ÿé¢è¯•é¢˜"},{"contents":" ç”³æ˜ï¼šä»¥ä¸‹å†…å®¹æ¥è‡ªç½‘ä¸Šçš„åšå®¢ã€è¯¾ç¨‹ï¼Œé€šè¿‡è‡ªå·±çš„ç†è§£è¿›è¡Œä¸€ä¸‹è½¬è¿°ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯å’Œçº°æ¼\nä»‹ç» MySQL çš„ å¯é‡å¤è¯» å’Œ è¯»å·²æäº¤ æ˜¯åŸºäº MVCC å®ç°çš„ï¼Œå®ƒçš„æœ€å¤§ä¼˜ç‚¹æ˜¯è¯»ä¸åŠ é”ï¼Œå› æ­¤è¯»å†™ä¸å†²çªï¼Œå¹¶å‘æ€§èƒ½å¥½ï¼Œå…¶å®ç°ä¸»è¦åŸºäºä»¥ä¸‹æŠ€æœ¯åŠæ•°æ®ç»“æ„ï¼š\né¦–å…ˆï¼ŒInnoDB é‡Œé¢æ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œå«ä½œ transaction idã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„ã€‚\nåŒä¸€è¡Œè®°å½•å¯èƒ½è¢«ä¸åŒçš„äº‹åŠ¡è¿›è¡Œæ“ä½œï¼Œè¿™æ ·åŒä¸€è¡Œè®°å½•å°±å¯èƒ½ä¼šæœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªè®°å½•éƒ½ä¼šæœ‰ä»¥ä¸‹å†…å®¹ï¼š\n1ï¼‰éšè—åˆ—ï¼šInnoDB ä¸­æ¯è¡Œæ•°æ®éƒ½æœ‰éšè—åˆ—ï¼Œéšè—åˆ—ä¸­åŒ…å«äº†æœ¬è¡Œæ•°æ®çš„äº‹åŠ¡ idï¼ˆå°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼Œrow trx_idï¼‰ã€æŒ‡å‘ undo log çš„æŒ‡é’ˆç­‰ã€‚\n2ï¼‰åŸºäº undo log çš„ç‰ˆæœ¬é“¾ï¼šå‰é¢è¯´åˆ°æ¯è¡Œæ•°æ®çš„éšè—åˆ—ä¸­åŒ…å«äº†æŒ‡å‘ undo log çš„æŒ‡é’ˆï¼Œè€Œæ¯æ¡ undo log ä¹Ÿä¼šæŒ‡å‘æ›´æ—©ç‰ˆæœ¬çš„ undo logï¼Œä»è€Œå½¢æˆä¸€æ¡ç‰ˆæœ¬é“¾ã€‚\næ¯”å¦‚åœ¨ä¸Šå›¾ä¸­ï¼Œid ä¸º 15 çš„äº‹åŠ¡å°† k æ›´æ–°ä¸º 10ï¼Œæ­¤æ—¶è¯¥ç‰ˆæœ¬çš„ row_trx_id ä¸ºå½“å‰äº‹åŠ¡ 15ï¼Œundo log æŒ‡é’ˆæŒ‡å‘ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä»¥æ­¤ç±»æ¨ï¼Œid ä¸º 17 çš„äº‹åŠ¡å°† k æ›´æ–°ä¸º 11ï¼Œå¹¶é‡å¤ä¸Šé¢çš„æ“ä½œã€‚è¿™æ ·ï¼ŒåŒä¸€ä¸ªè®°å½•å°±æœ‰äº†å¤šä¸ªç‰ˆæœ¬ï¼Œå¹¶ä¸”é€šè¿‡æŒ‡é’ˆå½¢æˆäº†ä¸€æ¡ç‰ˆæœ¬é“¾ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ª Read View çš„æ¦‚å¿µï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€ä¸ªæ•°æ®å¿«ç…§ï¼Œå°±åƒç›¸æœºæ‹ç…§é‚£æ ·ï¼Œå®šæ ¼æŸä¸€æ—¶åˆ»çš„é£æ™¯ã€‚åœ¨ è¯»å·²æäº¤ å’Œ å¯é‡å¤è¯» è¿™ä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸­å°±ç”¨åˆ°äº† Read View è¿™ä¸ªä¸œè¥¿ï¼Œè¯»æäº¤ éš”ç¦»çº§åˆ«æ˜¯åœ¨ æ¯æ¬¡è¯»æ“ä½œæ‰§è¡Œå‰ éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œè€Œ å¯é‡å¤è¯» éš”ç¦»çº§åˆ«æ˜¯ å¯åŠ¨äº‹åŠ¡æ—¶ ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewã€‚\nRead View æœ‰å››ä¸ªé‡è¦çš„å­—æ®µï¼š\nm_ids ï¼šæŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€çš„äº‹åŠ¡ id åˆ—è¡¨ï¼Œæ³¨æ„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œâ€œæ´»è·ƒäº‹åŠ¡â€æŒ‡çš„å°±æ˜¯ï¼Œå¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤çš„äº‹åŠ¡ã€‚ min_trx_id ï¼šæŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€ä¸­äº‹åŠ¡ id æœ€å°çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ m_ids çš„æœ€å°å€¼ï¼Œå¯ä»¥ç§°ä¸º ä½æ°´ä½ã€‚ max_trx_id ï¼šè¿™ä¸ªå¹¶ä¸æ˜¯ m_ids çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯åˆ›å»º Read View æ—¶å½“å‰æ•°æ®åº“ä¸­åº”è¯¥ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼ï¼Œä¹Ÿå°±æ˜¯å…¨å±€äº‹åŠ¡ä¸­æœ€å¤§çš„äº‹åŠ¡ id å€¼ + 1ï¼Œå¯ä»¥ç§°ä¸º é«˜æ°´ä½ï¼› creator_trx_id ï¼šæŒ‡çš„æ˜¯åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡çš„äº‹åŠ¡ idã€‚ å½“åˆ›å»ºå‡ºä¸€ä¸ª Read View æ—¶ï¼Œå®ƒä¼šæ ¹æ® select æ¡ä»¶ï¼Œæ‰¾åˆ°æŸä¸€è¡Œï¼ˆæˆ–è€…å¤šè¡Œï¼‰è®°å½•ï¼Œé¦–å…ˆæ‰¾åˆ°çš„æ˜¯è¿™è¡Œçš„æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœè¿™é‡Œç†è§£ä¸äº†ï¼Œè¯·çœ‹åé¢çš„ç¤ºä¾‹ï¼‰ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬çš„ row trx_idï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š\nå¦‚æœè½åœ¨ ç»¿è‰²éƒ¨åˆ†ï¼ˆå°äºä½æ°´ä½ï¼‰ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²æäº¤çš„äº‹åŠ¡æˆ–è€…æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ•°æ®æ˜¯ å¯è§ çš„ï¼›\nå¦‚æœè½åœ¨ çº¢è‰²éƒ¨åˆ†ï¼ˆå¤§äºç­‰äºé«˜æ°´ä½ï¼‰ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±å°†æ¥å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ˜¯è‚¯å®š ä¸å¯è§ çš„ï¼›\nå¦‚æœè½åœ¨é»„è‰²éƒ¨åˆ†ï¼Œé‚£å°±åŒ…æ‹¬ä¸¤ç§æƒ…å†µ a. è‹¥ row trx_id åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±è¿˜ æ²¡æäº¤ çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œä¸å¯è§ï¼› b. è‹¥ row trx_id ä¸åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ **å·²ç»æäº¤ **äº†çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œå¯è§ã€‚\nå¦‚æœè¯¥ç‰ˆæœ¬ä¸å¯è§ï¼Œé‚£ä¹ˆä¼šé€šè¿‡ undolog æŒ‡é’ˆï¼Œç»§ç»­æŸ¥çœ‹ä¸Šä¸ªç‰ˆæœ¬ï¼Œé‡å¤ä¸Šé¢çš„æµç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯è§çš„ç‰ˆæœ¬ã€‚\nmvcc ç¤ºä¾‹ ä¸¾ä¸ªä¾‹å­ï¼š å‡è®¾è¿™ä¸‰ä¸ªäº‹åŠ¡å¼€å§‹å‰ï¼Œç³»ç»Ÿé‡Œé¢è¿˜æœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡ï¼Œ ID æ˜¯ 99ï¼Œäº‹åŠ¡ Aã€Bã€C çš„äº‹åŠ¡ ID åˆ†åˆ«æ˜¯100ã€101ã€102ï¼ˆäº‹åŠ¡ ID æŒ‰ç…§äº‹åŠ¡å¼€å§‹æ—¶é—´é€’å¢ï¼ŒA æœ€å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥äº‹åŠ¡ ID åœ¨ä¸‰è€…ä¸­æœ€å°ï¼‰ï¼Œä¸”å½“å‰ç³»ç»Ÿé‡Œåªæœ‰è¿™å››ä¸ªäº‹åŠ¡ï¼Œä¸‰ä¸ªäº‹åŠ¡å¼€å§‹å‰ï¼Œk (1,1ï¼‰è¿™ä¸€è¡Œæ•°æ®çš„ row trx_id æ˜¯ 90ã€‚\nè¿™æ ·ï¼Œäº‹åŠ¡ A çš„è§†å›¾æ•°ç»„å°±æ˜¯[99,100], äº‹åŠ¡ B çš„è§†å›¾æ•°ç»„æ˜¯[99,100,101], äº‹åŠ¡ C çš„è§†å›¾æ•°ç»„æ˜¯[99,100,101,102]ã€‚\näº‹åŠ¡ C æœ€å…ˆå°† k æ›´æ–°ä¸º (1, 2)ï¼Œæ­¤æ—¶ä¾¿äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬çš„ row_trx_id ä¸ºäº‹åŠ¡ C çš„ idï¼Œä¹Ÿå°±æ˜¯ 102ï¼Œä¹‹å C ä¾¿æäº¤äº†ï¼ˆäº‹åŠ¡ C æ²¡æœ‰æ˜¾å¼åœ°ä½¿ç”¨ begin/commitï¼Œè¡¨ç¤ºè¿™ä¸ª update è¯­å¥æœ¬èº«å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¯­å¥å®Œæˆçš„æ—¶å€™ä¼šè‡ªåŠ¨æäº¤ï¼‰ã€‚\nä¹‹åï¼ŒB è¿›è¡Œäº†æ›´æ–°ï¼Œæ­¤æ—¶åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œrow_trx_id ä¸º 101ï¼Œä½†æ­¤æ—¶ B è¿˜æ²¡æœ‰ commitï¼Œ\nä¹‹åï¼ŒA å°è¯•è·å– k çš„å€¼ï¼Œå®ƒå°†ä»å½“å‰ç‰ˆæœ¬å¼€å§‹è¯»ï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸€è¡Œçš„æœ€æ–°å€¼ï¼Œå³ b æ›´æ–°åçš„ç‰ˆæœ¬ï¼‰ï¼Œæ­¤æ—¶ A çš„è§†å›¾æ•°ç»„ä¸º [99, 100]ï¼Œä½æ°´ä½æ˜¯æ•°ç»„ä¸­çš„æœ€å°å€¼ 99ï¼Œé«˜æ°´ä½æ˜¯ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡åˆ†é…çš„ IDï¼Œä¹Ÿå°±æ˜¯ 101ï¼ŒæŸ¥æ‰¾æµç¨‹å¦‚ä¸‹ï¼š\næ‰¾åˆ° (1,3) çš„æ—¶å€™ï¼Œåˆ¤æ–­å‡º row trx_id=101ï¼Œç­‰äºé«˜æ°´ä½å¤§ï¼ˆç–‘é—®ï¼šå¦‚æœé«˜æ°´ä½æ˜¯æ•°ç»„æœ€å¤§+1ï¼Œä¹Ÿå°±æ˜¯ 101ï¼Œé‚£æ­¤æ—¶ row trx_id æ˜¯ç­‰äºé«˜æ°´ä½è€Œä¸æ˜¯å¤§äºå•Šï¼Ÿï¼‰ï¼Œå¤„äºçº¢è‰²åŒºåŸŸï¼Œä¸å¯è§ï¼› æ¥ç€ï¼Œæ‰¾åˆ°ä¸Šä¸€ä¸ªå†å²ç‰ˆæœ¬ï¼Œä¸€çœ‹ row trx_id=102ï¼Œæ¯”é«˜æ°´ä½å¤§ï¼Œå¤„äºçº¢è‰²åŒºåŸŸï¼Œä¸å¯è§ï¼› å†å¾€å‰æ‰¾ï¼Œç»ˆäºæ‰¾åˆ°äº†ï¼ˆ1,1)ï¼Œå®ƒçš„row trx_id=90ï¼Œæ¯”ä½æ°´ä½å°ï¼Œå¤„äºç»¿è‰²åŒºåŸŸï¼Œå¯è§ã€‚ è¿™æ ·æ‰§è¡Œä¸‹æ¥ï¼Œè™½ç„¶æœŸé—´è¿™ä¸€è¡Œæ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œä½†æ˜¯äº‹åŠ¡ A ä¸è®ºåœ¨ä»€ä¹ˆæ—¶å€™æŸ¥è¯¢ï¼Œçœ‹åˆ°è¿™è¡Œæ•°æ®çš„ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€è‡´æ€§è¯»ã€‚\nå†æ¬¡ç†è§£è§†å›¾æ•°ç»„çš„ä½œç”¨ å‡è®¾æœ‰äº‹åŠ¡ Aï¼Œid ä¸º 90ï¼Œäº‹åŠ¡ Bï¼Œid ä¸º 91ï¼Œåœ¨ Aï¼ŒB ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡ï¼Œid ä¸º 80ï¼Œk è¿™ä¸€è¡Œçš„å½“å‰ç‰ˆæœ¬äº‹åŠ¡ id ä¸º 30\näº‹åŠ¡ A [80, 90] äº‹åŠ¡ B [80, 90, 91] begin set k = k+1 begin get k å‰é¢è¯´åˆ°ï¼Œè§†å›¾æ•°ç»„ä¿å­˜çš„æ˜¯è¯¥äº‹åŠ¡ä¸€å¯åŠ¨æ—¶ï¼Œå½“å‰æ´»è·ƒçš„äº‹åŠ¡ï¼Œäº‹åŠ¡ A çš„ set æ“ä½œä¼šäº§ç”Ÿä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬çš„ row_trx_id ä¸º 90ï¼Œå½“ B è¦æŸ¥è¯¢ k æ—¶ï¼Œå…ˆæŸ¥è¯¢å½“å‰ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ A set åçš„ç‰ˆæœ¬ï¼Œå‘ç° row_trx_id ä¸º 90ï¼Œæ­¤æ—¶äº‹åŠ¡ B çš„ä½æ°´ä½æ˜¯ 80ï¼ˆè§†å›¾æ•°ç»„é‡Œçš„æœ€å°å€¼ï¼‰ï¼Œé«˜æ°´ä½æ˜¯ 92ï¼ˆ91+1ï¼Œæ­¤å¤„å­˜ç–‘ï¼‰ï¼Œè€Œ row_trx_id åœ¨ä½æ°´ä½å’Œé«˜æ°´ä½ä¹‹é—´ï¼Œé‚£ä¹ˆå°±è¿›ä¸€æ­¥æŸ¥çœ‹ B çš„è§†å›¾æ•°ç»„ä¸­æ˜¯å¦æœ‰ 90ï¼Œå¦‚æœæœ‰åˆ™è¯´æ˜è¯¥äº‹åŠ¡è¿˜æœª commitï¼Œä¸èƒ½è¢«æŸ¥çœ‹ï¼Œæ­¤æ—¶ B çš„æ•°ç»„é‡Œæœ‰ 90ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬ä¸èƒ½æŸ¥çœ‹ï¼Œç»§ç»­é€šè¿‡ undo logæŒ‡é’ˆæ‰¾åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ row_trx_id ä¸º 30 çš„ç‰ˆæœ¬ï¼Œæ­¤æ—¶ 30 ä½äºä½æ°´ä½ï¼Œå¯ä»¥æŸ¥çœ‹ã€‚è¿™æ ·ä¸€å¥—æµç¨‹ä¸‹æ¥ï¼Œå°±é¿å…äº† è¯»æœªæäº¤ çš„å‘ç”Ÿã€‚\nå¯é‡å¤è¯» å’Œ è¯»å·²æäº¤ åœ¨ MVCC ä¸‹å®ç°çš„åŒºåˆ« å¯é‡å¤è¯» å’Œ è¯»å·²æäº¤ éƒ½æ˜¯ä½¿ç”¨ MVCC å®ç°çš„ï¼Œé‚£ä¹ˆä»–ä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ RCï¼ˆè¯»å·²æäº¤ï¼‰ä¸ RRï¼ˆå¯é‡å¤è¯»ï¼‰ ä¸€æ ·ï¼Œéƒ½ä½¿ç”¨äº†MVCCï¼Œå…¶ä¸»è¦åŒºåˆ«åœ¨äºï¼š\nRR æ˜¯åœ¨äº‹åŠ¡å¼€å§‹åç¬¬ä¸€æ¬¡æ‰§è¡Œ select å‰åˆ›å»º ReadViewï¼Œç›´åˆ°äº‹åŠ¡æäº¤éƒ½ä¸ä¼šå†åˆ›å»ºã€‚æ ¹æ®å‰é¢çš„ä»‹ç»ï¼ŒRR å¯ä»¥é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚ï¼ˆè¿™é‡Œæœ‰ç‚¹ç–‘æƒ‘ï¼ŒRR åˆ°åº•èƒ½ä¸èƒ½è§£å†³å¹»è¯»é—®é¢˜ï¼Ÿçœ‹ä¸å°‘åšå®¢æœ‰è¯´èƒ½çš„ï¼Œä¹Ÿæœ‰è¯´ä¸èƒ½çš„ï¼Œè²Œä¼¼æ˜¯åœ¨ sql æ ‡å‡†ä¸‹çš„ RR æ˜¯ä¸èƒ½è§£å†³å¹»è¯»çš„ï¼Œä½†æ˜¯ Innodb çš„ RR ä½¿ç”¨äº† next-keyï¼Œå¯ä»¥é˜²æ­¢å¹»è¯»ï¼‰\nRC æ¯æ¬¡æ‰§è¡Œ select å‰éƒ½ä¼šé‡æ–°å»ºç«‹ä¸€ä¸ªæ–°çš„ ReadViewï¼Œå› æ­¤å¦‚æœäº‹åŠ¡ A ç¬¬ä¸€æ¬¡ select ä¹‹åï¼Œäº‹åŠ¡ B å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹å¹¶æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡ A ç¬¬äºŒæ¬¡ select æ—¶ä¼šé‡æ–°å»ºç«‹æ–°çš„ ReadViewï¼Œå› æ­¤æ­¤æ—¶äº‹åŠ¡ B çš„ä¿®æ”¹å¯¹äº‹åŠ¡ A æ˜¯å¯è§çš„ã€‚å› æ­¤ RC éš”ç¦»çº§åˆ«å¯ä»¥é¿å…è„è¯»ï¼Œä½†æ˜¯æ— æ³•é¿å…ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚\næ›´æ–°é€»è¾‘ å¯¹äºæ›´æ–°è¯­å¥ï¼Œä½¿ç”¨çš„æ˜¯ å½“å‰è¯»ï¼Œè€Œä¸æ˜¯ä¸Šé¢çš„ å¿«ç…§è¯»ï¼Œselect è¯­å¥å¦‚æœåŠ é”ï¼Œä¹Ÿæ˜¯å½“å‰è¯»ï¼Œé¡¾åæ€ä¹‰ï¼Œå½“å‰è¯»å°±æ˜¯è·å–è¯¥å€¼çš„æœ€æ–°å€¼ï¼Œæ¯”å¦‚åœ¨ä¸‹å›¾ä¸­ï¼Œäº‹åŠ¡ B è¯»å‡ºæ¥çš„ k ä¸º 3ï¼ˆk çš„åˆå€¼ä¸º 1ï¼‰ï¼Œå°±æ˜¯å› ä¸ºå½“å‰è¯»çš„ç¼˜æ•…ï¼š è¿™ä¹ˆåšçš„åŸå› æ˜¯ï¼Œå¦‚æœä¸ä½¿ç”¨å½“å‰è¯»ï¼Œé‚£ä¼šå°±ä¼šå‘ç”Ÿæ›´æ–°è¦†ç›–çš„æƒ…å†µã€‚\nå¯¹äºè¿™ç§æƒ…å†µï¼Œäº‹åŠ¡ C æ²¡æœ‰é©¬ä¸Šæäº¤ï¼Œé‚£ä¹ˆå®ƒä¼šæŒæœ‰é”ï¼Œç›´åˆ°æäº¤åæ‰ä¼šé‡Šæ”¾é”ï¼Œåœ¨å®ƒæäº¤ä¹‹å‰ï¼ŒB å°è¯•æ›´æ–°ï¼Œä½†æ˜¯å› ä¸ºæ‹¿ä¸åˆ°é”ï¼Œæ‰€ä»¥ B å°±ä¼šé˜»å¡ï¼Œç›´åˆ° C commit\nå‚è€ƒï¼š\næå®¢æ—¶é—´â€”â€”MySQL å®æˆ˜45è®² https://www.cnblogs.com/kismetv/p/10331633.html ","date":"2022å¹´02æœˆ14æ—¥","permalink":"/posts/mvcc-yu-shi-wu-ge-chi/","summary":"ç”³æ˜ï¼šä»¥ä¸‹å†…å®¹æ¥è‡ªç½‘ä¸Šçš„åšå®¢ã€è¯¾ç¨‹ï¼Œé€šè¿‡è‡ªå·±çš„ç†è§£è¿›è¡Œä¸€ä¸‹è½¬è¿°ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯å’Œçº°æ¼\nä»‹ç» MySQL çš„ å¯é‡å¤è¯» å’Œ è¯»å·²æäº¤ æ˜¯åŸºäº MVCC å®ç°çš„ï¼Œå®ƒçš„æœ€å¤§ä¼˜ç‚¹æ˜¯è¯»ä¸åŠ é”ï¼Œå› æ­¤è¯»å†™ä¸å†²çªï¼Œå¹¶å‘æ€§èƒ½å¥½ï¼Œå…¶å®ç°ä¸»è¦åŸºäºä»¥ä¸‹æŠ€æœ¯åŠæ•°æ®ç»“æ„ï¼š","title":"MVCC ä¸äº‹åŠ¡éš”ç¦»"},{"contents":"SO_REUSEADDR è¯¥é€‰é¡¹å¯ä»¥ç»‘å®šå¤„äº TIME_WAIT çŠ¶æ€çš„åœ°å€ï¼Œå®è·µï¼š server ç«¯ï¼š\nfunc TestServer(t *testing.T) { fd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { t.Fatal(err) } if err := SetsockoptInt(fd, SOL_SOCKET, SO_REUSEADDR, 1); err != nil { t.Fatal(err) } if err := Bind(fd, \u0026amp;SockaddrInet4{Port: 9999, Addr: [4]byte{127, 0, 0, 1}}); err != nil { t.Fatal(err) } if err := Listen(fd, 1024); err != nil { t.Fatal(err) } for { connfd, _, err := Accept(fd) if err != nil { t.Log(err) continue } buf := make([]byte, 1024) _, err = Read(connfd, buf) if err != nil { t.Log(err) break } if _, err := Write(connfd, buf); err != nil { t.Log(err) break } Close(connfd) } } client ç«¯ï¼š\nfunc TestClient(t *testing.T) { fd, err := Socket(AF_INET, SOCK_STREAM, 0) if err != nil { t.Fatal(err) } if err := Connect(fd, \u0026amp;SockaddrInet4{Port: 9999, Addr: [4]byte{127, 0, 0, 1}}); err != nil { t.Fatal(err) } if _, err := Write(fd, []byte(\u0026quot;123\u0026quot;)); err != nil { Close(fd) t.Fatal(err) } buf := make([]byte, 1024) if _, err := Read(fd, buf); err != nil { Close(fd) t.Fatal(err) } t.Log(string(buf)) time.Sleep(time.Second * 5) // client ç«¯ä¸ä¼šå…ˆé€€å‡º Close(fd) } å…ˆè¿è¡Œ server å†è¿è¡Œ clientï¼Œä¹‹åè¿…é€Ÿå…³é—­ serverï¼Œæ­¤æ—¶å› ä¸º server æ˜¯ä¸»åŠ¨å…³é—­æ–¹ï¼Œæ‰€ä»¥çŠ¶æ€ä¸º TIME_WAITï¼Œæ­¤æ—¶å†æ¬¡è¿è¡Œ serverï¼Œå‘ç°å¯ä»¥è¿è¡ŒæˆåŠŸï¼Œå¦‚æœå»æ‰ SetsockoptInt(fd, SOL_SOCKET, SO_REUSEADDR, 1) ï¼Œé‚£ä¹ˆå†æ¬¡è¿è¡Œä¼šæŠ¥é”™ï¼šaddress already in use\n","date":"2022å¹´02æœˆ10æ—¥","permalink":"/posts/so_reuseaddr-he-so_reuseport-shi-jian/","summary":"SO_REUSEADDR è¯¥é€‰é¡¹å¯ä»¥ç»‘å®šå¤„äº TIME_WAIT çŠ¶æ€çš„åœ°å€ï¼Œå®è·µï¼š server ç«¯ï¼š","title":"SO_REUSEADDR å’Œ SO_REUSEPORT å®è·µ"},{"contents":"é—®é¢˜è®°å½• æœ€è¿‘å†™äº†ä¸€ä¸ªæ™®é€šçš„ tcp demoï¼Œå‘ç° server çš„çŠ¶æ€å¤„äº CLOSE_WAITï¼Œè€Œ client çš„çŠ¶æ€å¤„äº FIN_WAIT_2ï¼Œä¸ºäº†æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼Œç‰¹æ­¤å†™äº†è¿™ç¯‡æ–‡ç« ä½œä¸ºè®°å½•ï¼Œè¿™ä¹Ÿ\næ²¡æœ‰ close çš„æœåŠ¡ç«¯ï¼š\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; ) func handler(conn net.Conn) error { for { b := make([]byte, 1024) _, err := conn.Read(b) if err != nil { return err } _, err = conn.Write(b) if err != nil { return err } } } func main() { addr := \u0026quot;:8080\u0026quot; l, err := net.Listen(\u0026quot;tcp\u0026quot;, addr) log.Printf(\u0026quot;listen in %v \\n\u0026quot;, addr) if err != nil { panic(err) } for { conn, err := l.Accept() if err != nil { log.Println(err) break } go func() { if err := handler(conn); err != nil { log.Println(\u0026quot;handler error: \u0026quot;, err) } }() } } æ²¡æœ‰ close çš„å®¢æˆ·ç«¯ï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; ) func main() { c, err := net.Dial(\u0026quot;tcp\u0026quot;, \u0026quot;:8080\u0026quot;) if err != nil { panic(err) } for { var input string fmt.Scan(\u0026amp;input) n, err := c.Write([]byte(input)) if err != nil { log.Println(\u0026quot;write error: \u0026quot;, err) continue } log.Println(\u0026quot;write byte size: \u0026quot;, n) output := make([]byte, 4096) n, err = c.Read(output) if err != nil { log.Println(\u0026quot;read error: \u0026quot;, err) continue } fmt.Printf(\u0026quot;read byte size %v, content: %v \\n\u0026quot;, n, string(output)) } } å®éªŒæ­¥éª¤ï¼š æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¿è¡Œ server å’Œ clientï¼Œå…ˆè¿è¡Œ serverï¼Œå†è¿è¡Œ clientï¼Œclient è¿æ¥åç«‹é©¬ ctrl + c é€€å‡ºï¼Œè¾“å…¥ netstat -an | awk '/^tcp/' | grep 8080 æŸ¥çœ‹è¿æ¥çŠ¶æ€ï¼š\ntcp4 0 0 127.0.0.1.8080 127.0.0.1.57785 CLOSE_WAIT tcp4 0 0 127.0.0.1.57785 127.0.0.1.8080 FIN_WAIT_2 tcp46 0 0 *.8080 *.* LISTEN å‘ç°æ­¤æ—¶ server çš„çŠ¶æ€æ˜¯ CLOSE_WAITï¼Œè€Œ client çš„çŠ¶æ€æ˜¯ FIN_WAIT_2ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä»£ç å‘ç°ï¼Œserver ç«¯æ²¡æœ‰å¯¹è¿æ¥è¿›è¡Œå…³é—­å¤„ç†ï¼Œé‚£ä¹ˆæ ¹æ®å››æ¬¡æŒ¥æ‰‹çš„çŠ¶æ€å˜åŒ–å¯çŸ¥ï¼š\nç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼Œä¸»åŠ¨å…³é—­æ–¹ï¼ˆclientï¼‰å‘é€ FINï¼Œå¹¶è¿›å…¥ FIN_WAIT_1 çŠ¶æ€ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼Œè¢«åŠ¨å…³é—­æ–¹ï¼ˆserverï¼‰æ”¶åˆ° FIN åï¼Œå›å¤ä¸€ä¸ª ACKï¼ŒåŒæ—¶è¿›å…¥ CLOSE_WAIT çŠ¶æ€ï¼Œä¸»åŠ¨ï¼ˆclientï¼‰å…³é—­æ–¹æ”¶åˆ° ACK åï¼Œè¿›å…¥ FIN_WAIT_2 ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼Œè¢«åŠ¨å…³é—­æ–¹ï¼ˆserverï¼‰å‘é€ä¸€ä¸ª FINï¼Œå¹¶è¿›å…¥ LAST_ACKï¼Œé—®é¢˜æ¥äº†ï¼Œè¯¥ FIN æ˜¯è°ƒç”¨ close å‡½æ•°åæ‰ä¼šå‘é€çš„ï¼Œè€Œä¸Šé¢çš„ä»£ç æ²¡æœ‰è°ƒç”¨ closeï¼Œæ‰€ä»¥ä¸ä¼šå‘é€ FIN ä¸€åˆ‡éƒ½æ˜äº†äº†ï¼Œæ­¤æ—¶å› ä¸º server è¿™è¾¹æ²¡æœ‰æ²¡æœ‰è°ƒç”¨ close å¯¼è‡´æ— æ³•å‘å‡ºç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼Œæ‰€ä»¥æ•´ä¸ªæŒ¥æ‰‹æµç¨‹è¢«å¡ä½ï¼Œserver çš„çŠ¶æ€åœç•™åœ¨ CLOSE_WAITï¼Œè€Œ client çš„çŠ¶æ€åœç•™åœ¨ FIN_WAIT_2\nä¸€å°æ®µæ—¶é—´åï¼ˆå¤§çº¦å‡ åˆ†é’Ÿï¼‰ï¼ŒCLOSE_WAIT å’Œ FIN_WAIT_2 çŠ¶æ€éƒ½ä¼šè‡ªåŠ¨æ¶ˆå¤±\nè§£å†³ ä¿®æ”¹ server çš„ä»£ç ï¼Œæ·»åŠ  closeï¼š\n// çœç•¥ go func() { if err := handler(conn); err != nil { log.Println(\u0026quot;handler error: \u0026quot;, err) // æ–°æ·»åŠ çš„å…³é—­è¿æ¥å‡½æ•° conn.Close() } }() // çœç•¥ é‡å¤ä¹‹å‰çš„æ­¥éª¤ï¼Œå†æ¬¡è¾“å…¥ netstat -an | awk '/^tcp/' | grep 8080 æŸ¥çœ‹è¿æ¥çŠ¶æ€ï¼š\ntcp46 0 0 *.8080 *.* LISTEN tcp4 0 0 127.0.0.1.57896 127.0.0.1.8080 TIME_WAIT å¯ä»¥çœ‹åˆ°æ­¤æ—¶ç›´æ¥è¿›å…¥åˆ°äº† TIME_WAIT çŠ¶æ€äº†ã€‚\næ€»ç»“ï¼š é€šè¿‡æ­¤æ¬¡å®éªŒï¼Œæ˜ç™½äº† CLOSE_WAIT å‡ºç°çš„åŸå› ï¼Œå¹³æ—¶å†™ä»£ç æ¯”è¾ƒç–å¿½ï¼Œå¯¹è¿™äº›å…³é—­è¿æ¥çš„å°ç»†èŠ‚ä¸å¤Ÿé‡è§†ï¼Œå¦‚æœåœ¨ä¸Šçº¿ç¯å¢ƒï¼Œé«˜å¹¶å‘ä¸‹å¯èƒ½ä¼šå¯¼è‡´å‡ºç°å¤§é‡çš„ CLOSE_WAITï¼Œå°±å› ä¸ºè¿™ä¹ˆä¸€ä¸ªå°å°çš„ç»†èŠ‚å¯èƒ½å¯¼è‡´ä¸¥é‡çš„åæœï¼ŒåŒæ—¶ä¹Ÿæ·±åˆ»è®¤è¯†åˆ°äº†åŸºç¡€çš„é‡è¦æ€§ã€‚\né™„ CLOSE_WAIT çš„å±å®³ å¤„äº CLOSE_WAIT çŠ¶æ€çš„ TCP è¿æ¥ä¼šä¸€ç›´å ç”¨ç«¯å£å·ã€socket fd ç­‰èµ„æºï¼Œé€ æˆèµ„æºæµªè´¹ï¼Œå¦‚æœä¸»æœºå­˜åœ¨å¤§é‡çš„ CLOSE_WAIT çŠ¶æ€çš„è¿æ¥ï¼Œç”šè‡³å¯èƒ½ä¼šå¯¼è‡´æ— æ³•å»ºç«‹æ–°è¿æ¥ï¼Œä»è€Œæ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚\nTCP å››æ¬¡æŒ¥æ‰‹ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼Œä¸»åŠ¨å…³é—­æ–¹ï¼ˆclientï¼‰å‘é€ FINï¼Œå¹¶è¿›å…¥ FIN_WAIT_1 çŠ¶æ€ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼Œè¢«åŠ¨å…³é—­æ–¹ï¼ˆserverï¼‰æ”¶åˆ° FIN åï¼Œå›å¤ä¸€ä¸ª ACKï¼ŒåŒæ—¶è¿›å…¥ CLOSE_WAIT çŠ¶æ€ï¼Œä¸»åŠ¨ï¼ˆclientï¼‰å…³é—­æ–¹æ”¶åˆ° ACK åï¼Œè¿›å…¥ FIN_WAIT_2 ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼Œè¢«åŠ¨å…³é—­æ–¹ï¼ˆserverï¼‰å‘é€ä¸€ä¸ª FINï¼Œå¹¶è¿›å…¥ LAST_ACKï¼Œä¸»åŠ¨å…³é—­æ–¹ï¼ˆclientï¼‰æ”¶åˆ° FIN åï¼Œè¿›å…¥ TIME_WAIT çŠ¶æ€ ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼Œä¸»åŠ¨å…³é—­æ–¹ï¼ˆclientï¼‰å‘é€ ACKï¼Œè¢«åŠ¨å…³é—­æ–¹ï¼ˆserverï¼‰æ”¶åˆ° ACK åï¼Œè¿›å…¥ CLOSED çŠ¶æ€ ","date":"2022å¹´02æœˆ02æ—¥","permalink":"/posts/close_wait-he-fin_wait_2/","summary":"é—®é¢˜è®°å½• æœ€è¿‘å†™äº†ä¸€ä¸ªæ™®é€šçš„ tcp demoï¼Œå‘ç° server çš„çŠ¶æ€å¤„äº CLOSE_WAITï¼Œè€Œ client çš„çŠ¶æ€å¤„äº FIN_WAIT_2ï¼Œä¸ºäº†æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼Œç‰¹æ­¤å†™äº†è¿™ç¯‡æ–‡ç« ä½œä¸ºè®°å½•ï¼Œè¿™ä¹Ÿ","title":"TCP CLOSE_WAIT å’Œ FIN_WAIT_2"},{"contents":"TCP ç›¸å…³ 1. è¯´è¯´ TIME_WAIT åŠå…¶ä½œç”¨ å½“ä¸€ç«¯ ä¸»åŠ¨ æ–­å¼€è¿æ¥å¹¶å‘é€æœ€åä¸€æ¬¡æŒ¥æ‰‹åï¼Œè¯¥ç«¯çŠ¶æ€å˜ä¸º TIME_WAIT ï¼Œæ­¤æ—¶ä¼šç­‰å¾… 2 MSL ï¼ˆMSL æ˜¯ Maximum Segment Lifetimeï¼Œè¯‘ä¸ºâ€œæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´â€ï¼Œå¯ä¸º 30sï¼Œ1min æˆ– 2minã€‚ï¼‰ ä½œç”¨ï¼š\né¿å…æ–°æ—§è¿æ¥æ··æ·† å¦‚æœä¸€ä¸ª tcp è¿æ¥è¢«å…³é—­äº†ï¼Œç´§æ¥ç€é©¬ä¸Šåˆæœ‰ä¸€ä¸ªç›¸åŒå››å…ƒç»„çš„ tcp è¿æ¥å»ºç«‹äº†ï¼Œä¸”æ­¤æ—¶åˆšå¥½æ—§è¿æ¥ä¸­æœ‰ä¸€ä¸ªå»¶è¿Ÿçš„æŠ¥æ–‡åˆ°è¾¾äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—§æŠ¥æ–‡å°±ä¼šé”™è¯¯çš„è¢«æ–°è¿æ¥æ¥æ”¶ï¼ˆseq å¯¹æ–°è¿æ¥æ°å¥½æœ‰æ•ˆï¼‰ï¼Œè¿›è€Œå¯èƒ½ä¼šäº§ç”Ÿä¸€äº›è¯¡å¼‚æˆ–è€…é”™è¯¯çš„ç°è±¡ã€‚TIME_WAIT å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ç¡®ä¿è¿™äº›å»¶è¿Ÿçš„æ—§æŠ¥æ–‡åœ¨ç½‘ç»œä¸­æ¶ˆå¤±ã€‚\nç¡®ä¿åŒæ–¹çš„è¿æ¥éƒ½å¯ä»¥æ­£å¸¸å…³é—­ å‡è®¾ A ä¸»åŠ¨å…³é—­ï¼Œé‚£ä¹ˆæ ¹æ®å››æ¬¡æŒ¥æ‰‹å¯çŸ¥ï¼Œæœ€åä¸€æ¬¡æŒ¥æ‰‹ï¼ŒA éœ€è¦å‘é€ä¸€ä¸ª ACK ç»™ Bï¼Œå¦‚æœå‘é€ä¹‹åæ²¡æœ‰ TIME_WAITï¼Œè€Œæ˜¯ç›´æ¥ CLOSEDï¼Œé‚£ä¹ˆå¦‚æœè¯¥ ACK ä¸¢å¤±ï¼ŒB ä¼šå› ä¸ºè¶…æ—¶è€Œé‡å‘ FINï¼Œä½†æ˜¯å› ä¸º A å·²ç»å…³é—­äº†ï¼Œæ‰€ä»¥ä¼šå›å¤ä¸€ä¸ª RSTï¼ŒB å°±ä¼šè®¤ä¸ºå‘ç”Ÿäº†é”™è¯¯ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰ã€‚å¦‚æœ A åœ¨å‘é€æœ€åä¸€ä¸ª ACK åè¿›å…¥ TIME_WAIT ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆ B çš„é‡ä¼  FIN å°±å¯ä»¥è¢«æ­£å¸¸æ¥æ”¶äº†ã€‚\nä¹Ÿæœ‰ä¸€äº›åšå®¢è¯´ï¼Œå®¢æˆ·ç«¯å››æ¬¡æŒ¥æ‰‹çš„æœ€åä¸€ä¸ª ACK æŠ¥æ–‡å¦‚æœåœ¨ç½‘ç»œä¸­è¢«ä¸¢å¤±äº†ï¼Œæ­¤æ—¶å¦‚æœå®¢æˆ·ç«¯ TIME_WAIT è¿‡çŸ­æˆ–æ²¡æœ‰ï¼Œåˆ™å°±ç›´æ¥è¿›å…¥äº† CLOSED çŠ¶æ€äº†ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯åˆ™ä¼šä¸€ç›´å¤„åœ¨ LASE_ACK çŠ¶æ€ã€‚ å½“å®¢æˆ·ç«¯å‘èµ·å»ºç«‹è¿æ¥çš„ SYN è¯·æ±‚æŠ¥æ–‡åï¼ŒæœåŠ¡ç«¯ä¼šå‘é€ RST æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œè¿æ¥å»ºç«‹çš„è¿‡ç¨‹å°±ä¼šè¢«ç»ˆæ­¢ã€‚\n2. TCP å¦‚ä½•ä¿è¯å¯é æ€§ TCP (Transmission Control Protocol) é€šè¿‡ä»¥ä¸‹æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§ï¼š\nåº”ç­”æœºåˆ¶ï¼šTCP é‡‡ç”¨åº”ç­”æœºåˆ¶ç¡®è®¤æ•°æ®æ˜¯å¦è¢«æˆåŠŸæ¥æ”¶ã€‚æ¥æ”¶æ–¹ä¼šå‘å‘é€æ–¹å‘é€ä¸€ä¸ª ACK (Acknowledgment) ç¡®è®¤æŠ¥æ–‡ï¼Œå‘Šè¯‰å‘é€æ–¹å·²ç»æˆåŠŸæ¥æ”¶åˆ°æ•°æ®ã€‚å¦‚æœå‘é€æ–¹åœ¨ä¸€ä¸ªç‰¹å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° ACKï¼Œå°±ä¼šé‡æ–°å‘é€æ•°æ®ã€‚ è¶…æ—¶é‡ä¼ ï¼šå¦‚æœå‘é€æ–¹æ²¡æœ‰æ”¶åˆ° ACKï¼Œå®ƒå°±ä¼šé‡æ–°å‘é€æ•°æ®ã€‚å¦‚æœå‘é€æ–¹è¿ç»­å¤šæ¬¡æ²¡æœ‰æ”¶åˆ° ACKï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªè¿æ¥å·²ç»å¤±æ•ˆï¼Œå¹¶å…³é—­è¿™ä¸ªè¿æ¥ã€‚ æ»‘åŠ¨çª—å£ï¼šTCP ä½¿ç”¨æ»‘åŠ¨çª—å£æœºåˆ¶æ¥æ§åˆ¶å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¹‹é—´çš„æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚å‘é€æ–¹ä¼šå°†å¤šä¸ªæ•°æ®åŒ…æ‰“åŒ…æˆä¸€ä¸ªçª—å£ï¼Œæ¥æ”¶æ–¹ä¼šå‘Šè¯‰å‘é€æ–¹å®ƒå¯ä»¥æ¥æ”¶çš„æœ€å¤§çª—å£å¤§å°ã€‚è¿™æ ·å‘é€æ–¹å°±å¯ä»¥æ§åˆ¶å®ƒå‘é€çš„æ•°æ®åŒ…æ•°é‡ï¼Œç¡®ä¿ä¸ä¼šé€ æˆç½‘ç»œæ‹¥å¡ã€‚ é‡ä¼ æœºåˆ¶ï¼šå¦‚æœå‘é€æ–¹å‘é€çš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­ä¸¢å¤±æˆ–æŸåï¼Œæ¥æ”¶æ–¹ä¼šå‘é€ä¸€ä¸ª SACK (Selective Acknowledgment) æŠ¥æ–‡å‘Šè¯‰å‘é€æ–¹å“ªäº›æ•°æ®åŒ…æ²¡æœ‰æ¥æ”¶åˆ°ã€‚å‘é€æ–¹ä¼šæ ¹æ® SACK æŠ¥æ–‡é‡ä¼ è¿™äº›æ•°æ®åŒ…ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼ŒTCP é€šè¿‡è¿™äº›æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§ï¼Œç¡®ä¿æ•°æ®èƒ½å¤Ÿåœ¨ç½‘ç»œä¸­æˆåŠŸä¼ è¾“å¹¶è¢«æ­£ç¡®æ¥æ”¶ã€‚\n3. ä¸‰æ¬¡æ¡æ‰‹å¯¹åº”åˆ° socket å‡½æ•° 4. å››æ¬¡æŒ¥æ‰‹å¯¹åº”åˆ° socket å‡½æ•° ä¸»åŠ¨å…³é—­æ–¹è°ƒç”¨ close å‘é€ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ è¢«åŠ¨å…³é—­æ–¹è°ƒç”¨ close å‘é€ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ 5. ä¸ºä»€ä¹ˆæ–­å¼€è¿æ¥éœ€è¦å››æ¬¡æŒ¥æ‰‹ 6. ä¸‰æ¬¡æ¡æ‰‹ä¸ºä»€ä¹ˆéœ€è¦ 3 æ¬¡ï¼Ÿ2 æ¬¡æˆ–è€… 4 æ¬¡ä¸è¡Œå— 2 æ¬¡ï¼šæ— æ³•é˜»æ­¢å†å²è¿æ¥ï¼Œé€ æˆèµ„æºæµªè´¹ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š\nåœ¨ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼ŒæœåŠ¡ç«¯ä¸€æ”¶åˆ° SYN å°±å»ºç«‹è¿æ¥ï¼Œä½†æ˜¯å´æ— æ³•è¾¨è®¤è¯¥ SYN æ˜¯å¦æ˜¯æ—§è¿æ¥ï¼Œåªæœ‰åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ RST åæ‰èƒ½çŸ¥é“ï¼Œè¿™å¯¼è‡´ç™½ç™½åˆ›å»ºäº†ä¸€æ¡è¿æ¥ã€‚\nè€Œä½¿ç”¨ 3 æ¬¡æ¡æ‰‹å°±å¯ä»¥é¿å…ä¸Šé¢çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸‰æ¬¡æ¡æ‰‹çš„æƒ…å†µä¸‹ï¼Œ å¯ä»¥åœ¨æœåŠ¡ç«¯å»ºç«‹è¿æ¥ä¹‹å‰ï¼Œé˜»æ­¢æ‰å†å²è¿æ¥ï¼Œä»è€Œä¿è¯å»ºç«‹çš„è¿æ¥ä¸æ˜¯å†å²è¿æ¥ã€‚\n4 æ¬¡ï¼šæ—¢ç„¶ 3 æ¬¡å·²ç»å¯ä»¥ä¿è¯è¿æ¥æ­£å¸¸å»ºç«‹äº†ï¼Œå°±æ²¡å¿…è¦å†å¤šåŠ ä¸€æ¬¡äº†\n7. TCP çš„æ‹¥å¡æ§åˆ¶ HTTP ç›¸å…³ 1. HTTP 1.0ï¼Œ1.1ï¼Œ2.0ï¼Œ3.0 HTTP 1.0 é‡‡ç”¨çŸ­è¿æ¥ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ä¸æœåŠ¡å™¨å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåä¾¿æ–­å¼€è¿æ¥ã€‚æ— çŠ¶æ€ï¼šå³æ¯æ¬¡è¯·æ±‚å®Œæˆåå°±ä¼šæ–­å¼€è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥æ–­å¼€åéƒ½æ— æ³•è·å–ä¸Šæ¬¡è¿æ¥çš„çŠ¶æ€å’Œä¿¡æ¯ã€‚ å­˜åœ¨çš„é—®é¢˜ï¼š\næ— æ³•å¤ç”¨è¿æ¥ï¼Œæ¯æ¬¡å‘é€è¯·æ±‚ï¼Œéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡TCPè¿æ¥ï¼Œè€ŒTCPçš„è¿æ¥é‡Šæ”¾è¿‡ç¨‹åˆæ˜¯æ¯”è¾ƒè´¹äº‹çš„ã€‚è¿™ç§æ— è¿æ¥çš„ç‰¹æ€§ä¼šä½¿å¾—ç½‘ç»œçš„åˆ©ç”¨ç‡å˜ä½ã€‚\né˜Ÿå¤´é˜»å¡(head of line blocking)ï¼Œç”±äºHTTP1.0è§„å®šä¸‹ä¸€ä¸ªè¯·æ±‚å¿…é¡»åœ¨å‰ä¸€ä¸ªè¯·æ±‚å“åº”åˆ°è¾¾ä¹‹å‰æ‰èƒ½å‘é€ï¼Œå‡è®¾å‰ä¸€ä¸ªè¯·æ±‚å“åº”ä¸€ç›´ä¸åˆ°è¾¾ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªè¯·æ±‚å°±ä¸å‘é€ï¼Œåé¢çš„è¯·æ±‚å°±é˜»å¡äº†ã€‚\nä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡éƒ½ä¼šä¼ é€å…¨éƒ¨çš„é¡µé¢å’Œæ•°æ®ã€‚\nHTTP 1.1 é•¿è¿æ¥ï¼šHTTP 1.1 é»˜è®¤æ”¯æŒ keep-alive çš„é•¿è¿æ¥æ¨¡å¼ï¼Œè§£å†³äº† 1.0 ä¸­æ— æ³•å¤ç”¨ TCP è¿æ¥çš„é—®é¢˜ï¼Œå½“æœ¬æ¬¡è¯·æ±‚ç»“æŸåä¸ä¼šæ–­å¼€è¿æ¥å¹¶ä¿æŒæœ¬æ¬¡è¿æ¥çš„çŠ¶æ€ä¸ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯éƒ½æœ‰æƒå–æ¶ˆè¯¥æ¨¡å¼ã€‚\nç®¡é“åŒ–ï¼šå¤šä¸ªè¯·æ±‚ä¸ç”¨æ’é˜Ÿå‘é€ï¼Œä½†æ˜¯æœåŠ¡ç«¯å¿…é¡»æŒ‰ç…§å‘é€çš„é¡ºåºè¿›è¡Œç›¸åº”ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å®Œå…¨è§£å†³ HTTP 1.0 çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚ä¸¾ä¾‹ï¼šå‡è®¾æ–‡ä»¶Aä¸­æœ‰ä¸‰ä¸ªé™æ€æ–‡ä»¶D,Eå’ŒFï¼Œè™½ç„¶ç®¡é“åŒ–æŠ€æœ¯ä½¿Eä¸éœ€è¦ç­‰å¾…Dè¯·æ±‚å®Œæˆå¹¶æ¥æ”¶åˆ°å“åº”åå†å¼€å§‹è¯·æ±‚ï¼ŒFä¹ŸåŒç†ï¼Œä½†æ˜¯æœ€åæœåŠ¡ç«¯è¿˜æ˜¯éœ€è¦æŒ‰ç…§å‘é€è¯·æ±‚æ—¶çš„é¡ºåºæ¥ä¾æ¬¡ç»™å‡ºå“åº”ï¼Œè¿™æ—¶å€™ä¾æ—§ä¼šå‘ç”Ÿé˜»å¡ã€‚ åŸå› æ˜¯ HTTP1.1 çš„è¯·æ±‚å’Œå“åº”å¹¶æ²¡æœ‰åºå·æ ‡è¯†ï¼Œæ‰€ä»¥æ— æ³•å°†ä¹±åºçš„å“åº”ä¸è¯·æ±‚å¯¹åº”èµ·æ¥ã€‚\nåŸºäºé•¿è¿æ¥çš„æ¨¡å¼å°±å¯ä»¥å®ç°æ–­ç‚¹ç»­ä¼ çš„åŠŸèƒ½äº†ï¼Œè¿™æ ·å¯¹å¤§æ–‡ä»¶çš„ä¼ è¾“å’Œä¸‹è½½ä¼šæ›´åŠ å‹å¥½ï¼ŒåŒæ—¶HTTP1.1åœ¨è¯·æ±‚å¤´ä¸­å¼•å…¥äº†rangeå¤´åŸŸï¼Œå®ƒå…è®¸åªè¯·æ±‚èµ„æºçš„æŸéƒ¨åˆ†ï¼Œæ­¤æ—¶çš„è¿”å›ç æ˜¯206\nHTTP 2 ï¼ˆå‚è€ƒ https://blog.csdn.net/qq_34827674/article/details/115188949ï¼‰\nå¤´éƒ¨å‹ç¼©ï¼šåœ¨ HTTP 1/1.1 ä¸­ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š Content-Encoding æ¥è®¾ç½® body çš„å‹ç¼©æ–¹å¼ï¼Œæ¯”å¦‚ gzipï¼Œä½†æ˜¯ header éƒ¨åˆ†ä¸èƒ½è¿›è¡Œå‹ç¼©ï¼Œä¸” header éƒ¨åˆ†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š1. ä½¿ç”¨ ASCII ç ï¼Œæ•ˆç‡ä½ 2. å¯èƒ½å¾ˆå¤šè¯·æ±‚çš„ header çš„å­—æ®µå€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ¯”è¾ƒå†—ä½™ 3. å­˜åœ¨ä¸€äº›å›ºå®šå­—æ®µï¼Œæ¯”å¦‚ Cookie è§£å†³æ–¹å¼ï¼š é™æ€ç¼–ç è¡¨ é™æ€ç¼–ç è¡¨ä¸ºä¸€äº›å¸¸è§çš„ Header è¿›è¡Œäº†æ˜ å°„ï¼Œç”¨ä¸€ä¸ª index æ¥æ ‡è¯†ï¼Œæ¯”å¦‚åœ¨ä¸Šå›¾ä¸­ï¼Œ:method GET ä½¿ç”¨ 2 æ¥ä»£æ›¿ï¼Œè¿™æ ·ä¼ è¾“å°±ä¼šèŠ‚çœå¾ˆå¤šå­—èŠ‚ï¼ŒæœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°æŠ¥æ–‡åï¼Œé€šè¿‡é™æ€ç¼–ç è¡¨å°±å¯ä»¥è·å–åˆ°ç›¸åº”çš„ä¿¡æ¯ã€‚ ä½†æ˜¯ä¹Ÿä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œä¸€äº› index æ˜¯æ²¡æœ‰ header value çš„ï¼Œè¿™æ˜¯å› ä¸ºè¿™äº› Value å¹¶ä¸æ˜¯å›ºå®šçš„è€Œæ˜¯å˜åŒ–çš„ï¼Œè¿™äº› Value éƒ½ä¼šç»è¿‡ Huffman ç¼–ç åï¼Œæ‰ä¼šå‘é€å‡ºå»ã€‚å…·ä½“çš„ç¼–ç æ–¹å¼å‚è€ƒä¸Šé¢ç»™å‡ºæ¥çš„åŸæ–‡é“¾æ¥ã€‚\nåŠ¨æ€ç¼–ç è¡¨ é™æ€è¡¨åªåŒ…å«äº† 61 ç§é«˜é¢‘å‡ºç°åœ¨å¤´éƒ¨çš„å­—ç¬¦ä¸²ï¼Œä¸åœ¨é™æ€è¡¨èŒƒå›´å†…çš„å¤´éƒ¨å­—ç¬¦ä¸²å°±è¦è‡ªè¡Œæ„å»ºåŠ¨æ€è¡¨ï¼Œå®ƒçš„ Index ä» 62 èµ·æ­¥ï¼Œä¼šåœ¨ç¼–ç è§£ç çš„æ—¶å€™éšæ—¶æ›´æ–°ã€‚\næ¯”å¦‚å‘é€çš„æŠ¥æ–‡åŒ…å«è¿™æ ·ä¸€ä¸ªå¤´éƒ¨ï¼šXXX: YYYï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¼šåœ¨å„è‡ªçš„åŠ¨æ€ç¼–ç è¡¨ä¸­æ·»åŠ è¿™ä¸€ headerï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ª index æ ‡è¯†ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¹‹åè¦å†æ¬¡å‘é€è¯¥å¤´éƒ¨ï¼Œé‚£ä¹ˆåªéœ€è¦å‘é€å¯¹åº”å¾— index å³å¯ã€‚\nä½¿å¾—åŠ¨æ€è¡¨ç”Ÿæ•ˆæœ‰ä¸€ä¸ªå‰æï¼šå¿…é¡»åŒä¸€ä¸ªè¿æ¥ä¸Šï¼Œé‡å¤ä¼ è¾“å®Œå…¨ç›¸åŒçš„ HTTP å¤´éƒ¨ã€‚ å¦‚æœæ¶ˆæ¯å­—æ®µåœ¨ 1 ä¸ªè¿æ¥ä¸Šåªå‘é€äº† 1 æ¬¡ï¼Œæˆ–è€…é‡å¤ä¼ è¾“æ—¶ï¼Œå­—æ®µæ€»æ˜¯ç•¥æœ‰å˜åŒ–ï¼ŒåŠ¨æ€è¡¨å°±æ— æ³•è¢«å……åˆ†åˆ©ç”¨äº†ã€‚\nå› æ­¤ï¼Œéšç€åœ¨åŒä¸€ HTTP/2 è¿æ¥ä¸Šå‘é€çš„æŠ¥æ–‡è¶Šæ¥è¶Šå¤šï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ–¹çš„ã€Œå­—å…¸ã€ç§¯ç´¯çš„è¶Šæ¥è¶Šå¤šï¼Œç†è®ºä¸Šæœ€ç»ˆæ¯ä¸ªå¤´éƒ¨å­—æ®µéƒ½ä¼šå˜æˆ 1 ä¸ªå­—èŠ‚çš„ Indexï¼Œè¿™æ ·ä¾¿é¿å…äº†å¤§é‡çš„å†—ä½™æ•°æ®çš„ä¼ è¾“ï¼Œå¤§å¤§èŠ‚çº¦äº†å¸¦å®½ã€‚\nåŠ¨æ€è¡¨çš„å¼Šç«¯æ˜¯ï¼šéšç€è¡¨å­—æ®µçš„å¢é•¿ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒWeb æœåŠ¡å™¨éƒ½ä¼šæä¾›ç±»ä¼¼ http2_max_requests çš„é…ç½®ï¼Œç”¨äºé™åˆ¶ä¸€ä¸ªè¿æ¥ä¸Šèƒ½å¤Ÿä¼ è¾“çš„è¯·æ±‚æ•°é‡ï¼Œé¿å…åŠ¨æ€è¡¨æ— é™å¢å¤§ï¼Œè¯·æ±‚æ•°é‡åˆ°è¾¾ä¸Šé™åï¼Œå°±ä¼šå…³é—­ HTTP/2 è¿æ¥æ¥é‡Šæ”¾å†…å­˜ã€‚\näºŒè¿›åˆ¶å¸§\nå¤šè·¯å¤ç”¨ ä¸ºäº†è§£å†³ HTTP 1/1.1 ä¸­çš„å¯¹å¤´é˜»å¡é—®é¢˜ï¼ŒHTTP 2 ä½¿ç”¨äº†**æµï¼ˆstreamï¼‰**çš„æ¦‚å¿µï¼Œæ¯ä¸€æ¬¡è¯·æ±‚å¯¹åº”ä¸€ä¸ªæµï¼Œæœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œç”¨æ¥åŒºåˆ†ä¸åŒçš„è¯·æ±‚ï¼Œå¤šä¸ª stream å¤ç”¨ä¸€æ¡ TCP è¿æ¥ï¼Œè¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚åœ¨æ¯ä¸ª stream ä¸­è¿˜æœ‰å¤šä¸ª messageï¼Œmessage å¯¹åº” HTTP1 ä¸­çš„è¯·æ±‚æˆ–å“åº”ï¼Œæœ‰ header å’Œ body ç»„æˆã€‚message ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª frameï¼ˆå¸§ï¼‰ï¼Œframe æ˜¯ HTTP2 çš„æœ€å°å•ä½ï¼Œä»¥äºŒè¿›åˆ¶å‹ç¼©æ ¼å¼å­˜æ”¾ HTTP1 ä¸­çš„å†…å®¹ã€‚ä¸€ä¸ªè¯·æ±‚çš„æ•°æ®ä¼šè¢«åˆ†æˆå¤šä¸ªå¸§ï¼Œæ–¹ä¾¿è¿›è¡Œæ•°æ®åˆ†å‰²ä¼ è¾“ï¼Œæ¯ä¸ªå¸§éƒ½å”¯ä¸€å±äºæŸä¸€ä¸ªæµIDï¼Œå°†å¸§æŒ‰ç…§æµIDè¿›è¡Œåˆ†ç»„ï¼Œå³å¯åˆ†ç¦»å‡ºä¸åŒçš„è¯·æ±‚ã€‚è¿™æ ·åŒä¸€ä¸ªTCPè¿æ¥ä¸­å°±å¯ä»¥åŒæ—¶å¹¶å‘å¤šä¸ªè¯·æ±‚ï¼Œä¸åŒè¯·æ±‚çš„å¸§æ•°æ®å¯ç©¿æ’åœ¨ä¸€èµ·ï¼Œæ ¹æ®æµIDåˆ†ç»„å³å¯ã€‚\nHTTP2 ä¾ç„¶å­˜åœ¨çš„é—®é¢˜ï¼šTCP çš„é˜Ÿå¤´é˜»å¡ å¦‚æœHTTP/2è¿æ¥åŒæ–¹çš„ç½‘ç»œä¸­æœ‰ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œæˆ–è€…ä»»ä½•ä¸€æ–¹çš„ç½‘ç»œå‡ºç°ä¸­æ–­ï¼Œæ•´ä¸ªTCPè¿æ¥å°±ä¼šæš‚åœï¼Œä¸¢å¤±çš„æ•°æ®åŒ…éœ€è¦è¢«é‡æ–°ä¼ è¾“ã€‚ å› ä¸ºTCPæ˜¯ä¸€ä¸ªæŒ‰åºä¼ è¾“çš„é“¾æ¡ï¼Œå› æ­¤å¦‚æœå…¶ä¸­ä¸€ä¸ªç‚¹ä¸¢å¤±äº†ï¼Œé“¾è·¯ä¸Šä¹‹åçš„å†…å®¹å°±éƒ½éœ€è¦ç­‰å¾…ã€‚ è¿™ç§å•ä¸ªæ•°æ®åŒ…é€ æˆçš„é˜»å¡ï¼Œå°±æ˜¯TCPä¸Šçš„é˜Ÿå¤´é˜»å¡ï¼ˆhead of line blockingï¼‰ã€‚\nHTTP 3 TODO\nHTTP çŠ¶æ€ç ï¼Œ1xx-5xx 1xxï¼šè¡¨ç¤ºå·²æ¥æ”¶è¯·æ±‚ï¼Œéœ€è¦ç»§ç»­å‘é€è¯·æ±‚ 2xxï¼šè¡¨ç¤ºæˆåŠŸå¤„ç†äº†è¯·æ±‚ 3xxï¼šè¡¨ç¤ºéœ€è¦è¿›è¡Œé‡å®šå‘ 4xxï¼šè¡¨ç¤ºè¯·æ±‚ä¸èƒ½è¢«ç†è§£ã€å¤„ç† 5xxï¼šè¡¨ç¤ºæœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿäº†å†…éƒ¨é”™è¯¯ï¼Œè¿™äº›é”™è¯¯å¯èƒ½æ˜¯æœåŠ¡å™¨æœ¬èº«çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯·æ±‚å‡ºé”™\nè¾“å…¥ url åˆ°æµè§ˆå™¨çš„è¿‡ç¨‹ é¦–å…ˆéœ€è¦ç¡®ä¿æœ¬æœºæ‹¥æœ‰ä¸€ä¸ª IP åœ°å€ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦é€šè¿‡ DHCP è·å–ä¸€ä¸ª IPï¼Œè·å–æµç¨‹å¦‚ä¸‹ï¼š\n1.1 æœ¬æœºç”Ÿæˆä¸€ä¸ª DHCP è¯·æ±‚æŠ¥æ–‡ï¼Œæ”¾å…¥åˆ°ä¸€ä¸ªç›®çš„ç«¯å£ä¸º 67ï¼Œæºç«¯å£ä¸º 68 çš„ UDP æŠ¥æ–‡ä¸­\n1.2 å†å°†è¿™ä¸ª UDP æŠ¥æ–‡æ”¾åˆ°ä¸€ä¸ªç›®çš„åœ°å€ä¸º 255.255.255.255 ï¼ˆå¹¿æ’­åœ°å€ï¼‰å’Œæºåœ°å€ä¸º 0.0.0.0 ï¼ˆæ—  IP åœ°å€ï¼‰çš„ IP æŠ¥æ–‡ä¸­\n1.3 å†å°†è¿™ä¸ª IP æŠ¥æ–‡æ”¾åˆ°ä¸€ä¸ªä»¥å¤ªç½‘å¸§ä¸­ï¼Œè¯¥ä»¥å¤ªç½‘å¸§çš„ç›®çš„ MAC åœ°å€ä¸º FF:FF:FF:FF:FF:FFï¼ˆè¡¨ç¤ºå¹¿æ’­ç»™å±€åŸŸç½‘å†…çš„æ‰€æœ‰ä¸»æœºï¼‰ï¼Œ æº MAC åœ°å€ä¸º 00:16:D3:23:68:8A\n1.4\n","date":"2022å¹´01æœˆ28æ—¥","permalink":"/posts/ji-suan-ji-wang-luo-mian-shi-ti/","summary":"TCP ç›¸å…³ 1. è¯´è¯´ TIME_WAIT åŠå…¶ä½œç”¨ å½“ä¸€ç«¯ ä¸»åŠ¨ æ–­å¼€è¿æ¥å¹¶å‘é€æœ€åä¸€æ¬¡æŒ¥æ‰‹åï¼Œè¯¥ç«¯çŠ¶æ€å˜ä¸º TIME_WAIT ï¼Œæ­¤æ—¶ä¼šç­‰å¾… 2 MSL ï¼ˆMSL æ˜¯ Maximum Segment Lifetimeï¼Œè¯‘ä¸ºâ€œæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´â€ï¼Œå¯ä¸º 30sï¼Œ1min æˆ– 2minã€‚ï¼‰ ä½œç”¨ï¼š","title":"è®¡ç®—æœºç½‘ç»œé¢è¯•é¢˜"},{"contents":"Goroutine é˜»å¡çš„è¯ï¼Œæ˜¯ä¸æ˜¯å¯¹åº”çš„ M ä¹Ÿä¼šé˜»å¡ å¦‚æœ G è¢«é˜»å¡åœ¨æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œé‚£ä¹ˆä¸ä»…ä»… G ä¼šé˜»å¡ï¼Œæ‰§è¡Œ G çš„ M ä¹Ÿä¼šè§£ç»‘ Pï¼Œä¸ G ä¸€èµ·è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚å¦‚æœæ­¤æ—¶æœ‰ç©ºé—²çš„ M,åˆ™ P å’Œä¸å…¶ç»‘å®šå¹¶ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ G;å¦‚æœæ²¡æœ‰ç©ºé—²çš„ M,ä½†è¿˜æ˜¯æœ‰å…¶ä»– G éœ€è¦å»æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ªæ–° Mã€‚å½“ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œé˜»å¡åœ¨è¯¥ç³»ç»Ÿè°ƒç”¨ä¸Šçš„ G ä¼šå°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ P,å¦‚æœæ²¡æœ‰å¯ç”¨çš„ P,é‚£ä¹ˆè¿™ä¸ª G ä¼šè¢«æ ‡è®°ä¸º runnable å¹¶æŠŠå®ƒæ”¾å…¥å…¨å±€çš„ runqueue ä¸­ç­‰å¾…è°ƒåº¦ï¼Œä¹‹å‰çš„é‚£ä¸ªæŒ‚èµ·çš„ M å°†å†æ¬¡è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚\nGMP å½“ä¸€ä¸ª G é˜»å¡æ—¶ï¼ŒGã€Mã€P ä¼šå‘ç”Ÿä»€ä¹ˆ ç”¨æˆ·æ€é˜»å¡\nå½“ goroutine å› ä¸º channel æ“ä½œæˆ–è€… network I/O è€Œé˜»å¡æ—¶ï¼ˆå®é™…ä¸Š golang å·²ç»ç”¨ netpoller å®ç°äº†goroutineç½‘ç»œ I/O é˜»å¡ä¸ä¼šå¯¼è‡´ M è¢«é˜»å¡ï¼Œä»…é˜»å¡ G ï¼‰ï¼Œå¯¹åº”çš„ G ä¼šè¢«æ”¾ç½®åˆ°æŸä¸ª wait é˜Ÿåˆ—(å¦‚ channel çš„ waitq )ï¼Œè¯¥ G çš„çŠ¶æ€ç”± _Gruning å˜ä¸º _Gwaittingï¼Œè€Œ M ä¼šè·³è¿‡è¯¥ G å°è¯•è·å–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ª Gï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰ runnable çš„G ä¾› M è¿è¡Œï¼Œé‚£ä¹ˆ M å°†è§£ç»‘ Pï¼Œå¹¶è¿›å…¥ sleep çŠ¶æ€ï¼›å½“é˜»å¡çš„ G è¢«å¦ä¸€ç«¯çš„ G2 å”¤é†’æ—¶ï¼ˆæ¯”å¦‚ channel çš„å¯è¯»/å†™é€šçŸ¥ï¼‰ï¼ŒG è¢«æ ‡è®°ä¸º runnableï¼Œå°è¯•åŠ å…¥ G2 æ‰€åœ¨ P çš„ runnextï¼Œç„¶åå†æ˜¯ P çš„ Local é˜Ÿåˆ—å’Œ Global é˜Ÿåˆ—ã€‚\nç³»ç»Ÿè°ƒç”¨é˜»å¡\nå½“ G è¢«é˜»å¡åœ¨æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šæ—¶ï¼Œæ­¤æ—¶ G ä¼šé˜»å¡åœ¨ _Gsyscall çŠ¶æ€ï¼ŒM ä¹Ÿå¤„äº block on syscall çŠ¶æ€ï¼Œæ­¤æ—¶çš„ Må¯è¢«æŠ¢å è°ƒåº¦ï¼šæ‰§è¡Œè¯¥ G çš„ M ä¼šä¸ P è§£ç»‘ï¼Œè€Œ P åˆ™å°è¯•ä¸å…¶å®ƒ idle çš„ M ç»‘å®šï¼Œç»§ç»­æ‰§è¡Œå…¶å®ƒ Gã€‚å¦‚æœæ²¡æœ‰å…¶å®ƒidle çš„ Mï¼Œä½† P çš„ Local é˜Ÿåˆ—ä¸­ä»ç„¶æœ‰ G éœ€è¦æ‰§è¡Œï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ Mï¼›å½“ç³»ç»Ÿè°ƒç”¨å®Œæˆåï¼ŒG ä¼šé‡æ–°å°è¯•è·å–ä¸€ä¸ª idle çš„ P è¿›å…¥å®ƒçš„ Local é˜Ÿåˆ—æ¢å¤æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰ idle çš„ Pï¼ŒG ä¼šè¢«æ ‡è®°ä¸º runnable åŠ å…¥åˆ° Global é˜Ÿåˆ—ã€‚\nP å’Œ M æ•°é‡å¯ä»¥æ— é™æ‰©å¢çš„å—ï¼Ÿ ä¸æ˜¯æ— çº¿æ‰©å¢çš„ã€‚\nP çš„æ•°é‡ï¼šç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• GOMAXPROCS() å†³å®šã€‚\nMçš„æ•°é‡ï¼šgoroutine ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000ã€‚ä½†æ˜¯å†…æ ¸å¾ˆéš¾åˆ›å»ºå‡ºå¦‚æ­¤å¤šçš„çº¿ç¨‹ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ M çš„æœ€å¤§æ•°é‡å–å†³äºå†…æ ¸ã€‚ä¹Ÿå¯ä»¥è°ƒç”¨ runtime/debug ä¸­çš„ SetMaxThreads å‡½æ•°ï¼Œæ‰‹åŠ¨è®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚\nP çš„è°ƒåº¦é€»è¾‘ å…ˆä»æœ¬åœ° runq è·å–å¾…æ‰§è¡Œçš„ Gï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†ä»å…¨å±€ runq è·å–å¾…æ‰§è¡Œçš„ Gï¼Œè¿˜æ²¡æœ‰çš„è¯ï¼Œå°±ä»åˆ«çš„ P ä¸­æ‹¿ï¼ˆå·ï¼‰èµ°ä¸€åŠçš„ G\nå¦‚æœä¸€ä¸ª G è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´é˜Ÿåˆ—ä¸­åç»­ G éƒ½æ— æ³•è¿è¡Œå‘¢ï¼Ÿ å†…å®¹æ¥è‡ªï¼šhttps://www.bilibili.com/video/BV1zT4y1F7XF?spm_id_from=333.999.0.0ï¼Œé‡Œé¢æœ‰éå¸¸è¯¦ç»†çš„ä»‹ç»\nè¿™æ¶‰åŠåˆ° GMP çš„æŠ¢å ï¼Œåœ¨ main goroutine å¯åŠ¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª sysmon goroutineï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åç¨‹ï¼Œå…¶ä¸ä¾èµ– Pï¼Œä¹Ÿä¸ç”± GMP è°ƒåº¦ï¼Œä»–ä¼šæœ¬ç€å…¬å¹³è°ƒåº¦çš„åŸåˆ™ï¼Œå¯¹è¿è¡Œæ—¶é—´è¿‡é•¿çš„ Pï¼Œå®è¡ŒæŠ¢å æ“ä½œï¼Œå°±æ˜¯å‘Šè¯‰é‚£äº›è¿è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„ P è¯¥è®©å‡ºäº†ï¼Œé‚£ä¹ˆæ€ä¹ˆçŸ¥é“è¿è¡Œæ—¶é—´è¿‡é•¿äº†å‘¢ï¼ŸP é‡Œé¢æœ‰ä¸€ä¸ª schedtick å­—æ®µï¼Œæ¯å½“è°ƒåº¦æ‰§è¡Œä¸€ä¸ªæ–°çš„ Gï¼Œå¹¶ä¸”ä¸ç»§æ‰¿ä¸Šä¸ª G çš„æ—¶é—´ç‰‡æ—¶ï¼ˆè¿™é‡Œä¸æ‡‚ï¼‰ï¼Œå°±ä¼šæŠŠå®ƒè‡ªå¢ 1ï¼Œè¿˜æœ‰ä¸€ä¸ª sysmontick.schedwhen è®°å½•çš„æ˜¯ä¸Šæ¬¡è°ƒåº¦çš„æ—¶é—´ï¼Œç›‘æµ‹åç¨‹å¦‚æœæ£€æµ‹åˆ° sysmontick.schedtick ä¸ç­‰äº p.schedtickï¼Œè¯´æ˜è¿™ä¸ª P åˆå‘ç”Ÿäº†æ–°çš„è°ƒåº¦ï¼Œå°±ä¼šåŒæ­¥ schedwhen å’Œ schedtickï¼Œä½†å¦‚æœç›¸ç­‰ï¼Œåˆ™è¯´æ˜å­ schedwhen è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œè¿™ä¸ª P å¹¶æœªå‘ç”Ÿäº†æ–°çš„è°ƒåº¦ï¼Œæˆ–è€…æ²¿ç”¨äº†ä¹‹å‰ G çš„æ—¶é—´ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å½“å‰æ—¶é—´ä¸ schedwhen çš„å·®å€¼ï¼Œ(sysmontick.schedwhen + forcePreemptNS \u0026lt; now)ï¼Œæ¥åˆ¤æ–­å½“å‰ P ä¸Šçš„ G æ˜¯å¦è¿è¡Œæ—¶é—´è¿‡é•¿äº†ï¼Œå¦‚æœè¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆå°±è¦é€šçŸ¥è¯¥ P è®©å‡ºäº†ã€‚\nå¦‚ä½•é€šçŸ¥ P å‘¢ï¼Ÿä½¿ç”¨çš„æ˜¯ æ ˆå¢é•¿ çš„æ–¹å¼ã€‚é™¤äº†å¯¹åç¨‹æ ˆæ²¡ä»€ä¹ˆæ¶ˆè€—çš„å‡½æ•°è°ƒç”¨ï¼ŒGo è¯­è¨€ç¼–è¯‘å™¨éƒ½ä¼šåœ¨å‡½æ•°å¤´éƒ¨æ’å…¥æ ˆå¢é•¿æ£€æµ‹ç›¸å…³ä»£ç ï¼Œä¼šæ ¹æ®æ ˆå¸§å¤§å°æ¥æ’å…¥ä¸åŒçš„ä»£ç ï¼ŒSP è¡¨ç¤ºå½“å‰çš„æ ˆä½¿ç”¨åˆ°äº†å“ªä¸ªä½ç½®ï¼Œstackguard0 è¡¨ç¤ºåç¨‹æ ˆçš„ç©ºé—´ä¸‹ç•Œï¼Œå½“æ ˆçš„æ¶ˆè€—è¾¾åˆ°æˆ–è¶…è¿‡ stackguard0 æ—¶ï¼Œå°±éœ€è¦è¿›è¡Œæ ˆå¢é•¿ï¼Œä¼šæ ¹æ®è¶…å‡ºå¤§å°çš„å¤šå°‘æ¥ä½¿ç”¨ä¸åŒçš„å¢é•¿ä»£ç ï¼ˆè¿™ä¸ªå…·ä½“çœ‹è§†é¢‘é‡Œçš„è¯´æ˜ï¼Œä¸€å…± 3 ç§ç­–ç•¥ï¼‰ï¼Œå¦‚æœè°ƒåº¦å™¨å¸Œæœ›å½“å‰ P è®©å‡ºï¼Œé‚£ä¹ˆå°±ä¼šå°† stackguard0 è®¾ç½®ä¸º stackPreemptï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼ŒçœŸæ­£çš„æ ˆæŒ‡é’ˆä¸å¯èƒ½æŒ‡å‘è¿™ä¸ªä½ç½®ï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨çš„ç”¨ä½œç‰¹æ®Šæ ‡è¯†ï¼Œæ­¤å¤–å› ä¸ºè¯¥å€¼è¶³å¤Ÿå¤§ï¼Œé‚£ä¹ˆ 3 ç§ç­–ç•¥éƒ½ä¼šæ»¡è¶³æ¡ä»¶ï¼Œä»è€Œ goto åˆ° morestack å¤„ï¼Œmorestack ä¼šè°ƒç”¨ runtime.newstack å‡½æ•°ï¼Œè´Ÿè´£æ ˆå¢é•¿å·¥ä½œï¼Œä½†æ˜¯åœ¨å¢é•¿å‰ï¼Œä¼šå…ˆåˆ¤æ–­ stackguard0 æ˜¯å¦ç­‰äº stackPreemptï¼Œå¦‚æœç­‰äºå°±ä¸è¿›è¡Œæ ˆå¢é•¿äº†ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€æ¬¡åç¨‹è°ƒåº¦ï¼Œä»è€Œè¾¾åˆ°æŠ¢å çš„ç›®çš„ã€‚\nä¸è¿‡è¿™ç§æŠ¢å æ–¹å¼çš„ç¼ºé™·å°±æ˜¯è¿‡äºä¾èµ–æ ˆå¢é•¿ä»£ç ï¼Œå¦‚æœæ¥ä¸ª for{}ï¼Œå› ä¸ºä¸æ¶‰åŠåˆ°å‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥ä¸æ ˆå¢é•¿æ— å…³ï¼Œä¹Ÿå°±æ— æ³•é€šè¿‡ä¸Šé¢çš„æ–¹å¼æ¥å®ç°æŠ¢å ï¼Œè¿™ä¸€é—®é¢˜åœ¨ go1.14 ä¸­å¾—åˆ°äº†è§£å†³ï¼Œå› ä¸ºå®ƒå®ç°äº†å¼‚æ­¥æŠ¢å ï¼Œæ˜¯é€šè¿‡ä¿¡å·ï¼ˆsignalï¼‰å®ç°çš„ï¼Œå½“è¦æŠ¢å æ—¶ï¼Œä¼šå‘åç¨‹å…³è”çš„ M å‘é€ä¸€ä¸ª sigPreempt ä¿¡å·ï¼ˆå¥½åƒåº•å±‚æ˜¯ SIGURGï¼‰ï¼Œç›®æ ‡çº¿ç¨‹ï¼ˆMï¼‰æ”¶åˆ°ä¿¡å·åä¼šè¢«ä¸­æ–­ï¼Œè½¬å»æ‰§è¡Œ sigHandlerï¼Œè¯¥å‡½æ•°æ£€æµ‹åˆ°ä¿¡å·ä¸º sigPreempt åï¼Œä¼šè°ƒç”¨ runtime.doSigPreempt å‡½æ•°ï¼Œå®ƒä¼šå‘å½“å‰è¢«æ‰“æ–­çš„åç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œæ³¨å…¥ä¸€ä¸ªå¼‚æ­¥æŠ¢å å‡½æ•°è°ƒç”¨ï¼Œä¹‹åè¿”å›ï¼Œè¢«æ‰“æ–­çš„åç¨‹æ¢å¤ï¼Œç«‹åˆ»æ‰§è¡Œè¢«æ³¨å…¥çš„å¼‚æ­¥æŠ¢å å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ runtime ä¸­çš„è°ƒåº¦é€»è¾‘ï¼Œä»è€Œå®ç°è®©å‡ºã€‚\nG é™·å…¥ç³»ç»Ÿè°ƒç”¨ä¼šå‘ç”Ÿä»€ä¹ˆ ä¸€ä¸ªåç¨‹è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå°±è¦åˆ‡æ¢åˆ° g0 æ ˆï¼ˆä¸ºä»€ä¹ˆè¦åˆ‡æ¢åˆ° g0 æ ˆï¼‰ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼ŒG å’Œ M ä¼šä¸€ç›´ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸èƒ½è¢«åˆ†å¼€ï¼Œä¹Ÿå°±ç”¨ä¸åˆ° P äº†ï¼Œæ‰€ä»¥åœ¨é™·å…¥ç³»ç»Ÿè°ƒç”¨å‰ï¼Œå½“å‰ M ä¼šè®©å‡º Pï¼Œè§£é™¤ m.P ä¸å½“å‰ P çš„å¼ºå…³è”ï¼Œå¹¶ä¸”è®°å½•åˆ° m.oldp ä¸­ã€‚ä½†æ˜¯è¿™ä¸ª P å¦‚æœæ”¾ç€ä¸ç®¡å°±æœ‰ç‚¹æµªè´¹äº†ï¼Œè¿˜æ˜¯éœ€è¦å°†å…¶å…³è”åˆ°å…¶ä»– Mï¼Œç»§ç»­æ‰§è¡Œå·¥ä½œï¼Œå½“ä¹‹å‰çš„ M ç»“æŸç³»ç»Ÿè°ƒç”¨åï¼Œä¼šå…ˆæ£€æŸ¥ä¹‹å‰çš„ Pï¼ˆm.oldpï¼‰æ˜¯å¦è¢«å ç”¨ï¼Œæ²¡æœ‰çš„è¯å°±ç»§ç»­ä½¿ç”¨ï¼Œå¦åˆ™å°±é‡æ–°ç”³è¯·ä¸€ä¸ªï¼Œæ²¡ç”³è¯·åˆ°çš„è¯ï¼ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”³è¯·ä¸åˆ°ï¼Ÿï¼‰ï¼Œå°±æŠŠå½“å‰ G æ”¾åˆ°å…¨å±€ runq ä¸­ï¼Œç„¶å M å°±è¿›å…¥ç¡çœ ã€‚\nå¦‚æœå½“å‰ M æ²¡æœ‰ç»‘å®š Pï¼Œé‚£ä¹ˆå¦‚ä½•è·å– G GMP çš„å‡ ä¸ªé˜Ÿåˆ— è²Œä¼¼ GMP é‡Œçš„å…¨å±€é˜Ÿåˆ—æœ‰ä¸¤ç§ï¼Œä¸€ç§å°±æ˜¯å•çº¯ä¿å­˜ç”¨ä½œè®°å½•çš„ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯è°ƒåº¦å™¨çš„å…¨å±€é˜Ÿåˆ—ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯ç©ºé—²çŠ¶æ€çš„\nè°ƒåº¦å™¨çš„å¯è¿è¡Œ G é˜Ÿåˆ—\nå­˜æ”¾ç­‰å¾…æ‰§è¡Œçš„ gï¼Œæ–°åˆ›å»ºçš„ g ä¼šå…ˆå°è¯•ä¿å­˜åˆ°å½“å‰ g ï¼ˆè¿™ä¸ª g å°±æ˜¯æ–°åˆ›å»º g çš„çˆ¶ goroutineï¼‰å¯¹åº”çš„ p çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—å·²æ»¡ï¼ˆ256ä¸ªï¼‰ï¼Œå°±ä¼šæŠŠ g æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚\nè¯¥é˜Ÿåˆ—æœ‰å®¹é‡é™åˆ¶å—ï¼Ÿ\nè¯¥é˜Ÿåˆ—é‡Œçš„ g ä»€ä¹ˆæ—¶å€™è¢«æ¶ˆè´¹ï¼Ÿ\nå¦‚æœæŸä¸ª p çš„æœ¬åœ° g é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šä»å…¨å±€é˜Ÿåˆ—é‡Œè·å–\nå…¨å±€ M é˜Ÿåˆ—\nä½œç”¨ï¼š è·å–æ‰€æœ‰ M çš„ä¿¡æ¯ é˜²æ­¢ M è¢«å½“ä½œåƒåœ¾å›æ”¶æ‰ è°ƒåº¦å™¨çš„ç©ºé—² M é˜Ÿåˆ—\nè¿è¡Œæ—¶ç³»ç»Ÿåœ¨åœæ­¢ M æ—¶ï¼Œä¼šæŠŠå®ƒæ”¾å…¥è°ƒåº¦å™¨çš„ç©ºé—² M é˜Ÿåˆ—\nä»€ä¹ˆæ—¶å€™è¢«æ¶ˆè´¹ å½“ G é™·å…¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¸å…¶å…³è”çš„ M ä¹Ÿä¼šè¢«é˜»å¡ï¼Œè€Œä¸ä¹‹å…³è”çš„ P ä¼šè¢«åˆ†ç¦»ï¼Œä½¿å¾—è¿™ä¸ª P ä¸­å‰©ä½™çš„ G å¯ä»¥è¢«æ‰§è¡Œï¼Œæ­¤æ—¶ P å°±ä¼šå»å…¨å±€ M é˜Ÿåˆ—é‡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæœ‰çš„è¯\nå…¨å±€ P é˜Ÿåˆ—\nä¿å­˜äº†å½“å‰ runtime åˆ›å»ºçš„æ‰€æœ‰ Pï¼Œruntime ä¼šæŠŠè¿™äº› p ä¸­çš„å¯è¿è¡Œ g å…¨éƒ¨å–å‡ºï¼Œå¹¶æ”¾å…¥è°ƒåº¦å™¨çš„å¯è¿è¡Œ g é˜Ÿåˆ—ä¸­ï¼Œè¢«è½¬ç§»çš„è¿™äº› gï¼Œä¼šåœ¨ä»¥åç»ç”±è°ƒåº¦å†æ¬¡æ”¾å…¥æŸä¸ª p çš„å¯è¿è¡Œ g é˜Ÿåˆ—\nè°ƒåº¦å™¨çš„ç©ºé—² P é˜Ÿåˆ—\nå½“ä¸€ä¸ª p ä¸ä¸ä»»ä½• m å…³è”æ—¶ï¼Œruntime å°±ä¼šæŠŠå®ƒæ”¾å…¥è¯¥åˆ—è¡¨ï¼Œå½“ runtime éœ€è¦ä¸€ä¸ªç©ºé—²çš„ p æ¥å…³è”æŸä¸ª m æ—¶ï¼Œå°±ä¼šä»è¯¥é˜Ÿåˆ—è·å–ã€‚æ­¤å¤–ï¼Œp è¿›å…¥ç©ºé—²é˜Ÿåˆ—çš„ä¸€ä¸ªé‡è¦æ¡ä»¶æ˜¯ï¼Œæœ¬åœ°é˜Ÿåˆ—é‡Œæ²¡æœ‰å¯è¿è¡Œçš„ g\nP çš„ G é˜Ÿåˆ—\nä¿å­˜çš„æ˜¯å¯è¿è¡Œçš„ gï¼Œæ–°åˆ›å»ºçš„ g ä¼šå…ˆå°è¯•æ”¾åˆ°è¿™é‡Œï¼Œæœ€å¤§å®¹é‡ä¸º 256ã€‚\nP çš„è‡ªç”± G é˜Ÿåˆ—ï¼Œè°ƒåº¦å™¨çš„è‡ªç”± G åˆ—è¡¨\nè‡ªç”± g è¡¨ç¤ºçš„æ˜¯å·²ç»è¿è¡Œå®Œæˆçš„ gï¼Œä¸»è¦æ˜¯ä¸ºäº†æé«˜å¤ç”¨ç‡ï¼Œé¿å…é¢‘ç¹åˆ›å»º gï¼Œå› ä¸º g æœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚\nè¿è¡Œå®Œæˆçš„ g ä¼šå…ˆæ”¾åˆ°å¯¹åº”çš„ p çš„è‡ªç”± g é˜Ÿåˆ—é‡Œï¼Œå¦‚æœå¤ªå¤šäº†ï¼Œå°±ä¼šè½¬ç§»ä¸€éƒ¨åˆ†åˆ°è°ƒåº¦å™¨çš„è‡ªç”± g åˆ—è¡¨\nå½“åˆ›å»ºä¸€ä¸ª goroutine æ—¶ï¼Œä¼šå…ˆå°è¯•ä» p çš„è‡ªç”± g é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªç°æˆçš„ gï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…å¤ªå°‘ï¼Œä¼šä»è°ƒåº¦å™¨çš„è‡ªç”± g é˜Ÿåˆ—ä¸­æ‹¿ä¸€éƒ¨åˆ†ï¼Œå¦‚æœè°ƒåº¦å™¨ä¸­ä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šæ–°åˆ›å»ºä¸€ä¸ª g\ng0ï¼Œm0 æ˜¯ä»€ä¹ˆ ç¨‹åºé¢˜ ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;sync\u0026quot; \u0026quot;runtime\u0026quot; ) func main() { runtime.GOMAXPROCS(1) var wg sync.WaitGroup wg.Add(3) // goroutine1 go func(n int) { fmt.Println(n) wg.Done() }(1) // goroutine2 go func(n int) { fmt.Println(n) wg.Done() }(2) // goroutine3 go func(n int) { fmt.Println(n) wg.Done() }(3) wg.Wait() } ç»“æœï¼š3 1 2\nP æœ‰ä¸€ä¸ª runnext å­—æ®µï¼Œä¿å­˜çš„æ˜¯ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ gï¼Œå½“åˆ›å»ºä¸€ä¸ªæ–°çš„ g æ—¶ï¼Œä¼šè°ƒç”¨ runqput å°†å…¶æ·»åŠ åˆ° P çš„ runq ä¸­ï¼Œå¦‚æœå½“å‰ P çš„ runq ä¸­å·²ç»æœ‰ g äº†ï¼Œåˆ™ä¼šå°†å…¶æŒ¤èµ°ï¼Œè¢«æŒ¤èµ°çš„é‚£ä¸ªè¿›å…¥ P çš„æœ¬åœ° runqã€‚runnext çš„ä¼˜å…ˆåº¦æ¯” runq é«˜ï¼Œä¼šå…ˆæ‰§è¡Œ runnext çš„ gï¼Œå†æŒ‰é¡ºåºæ‰§è¡Œ runq ä¸­çš„ gã€‚\nåœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œå› ä¸ºè®¾ç½®äº† runtime.GOMAXPROCS(1)ï¼Œæ‰€ä»¥æ•´ä¸ª runtime ä¸­åªæœ‰ 1 ä¸ª Pï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ 3 ä¸ªgoroutine éƒ½å…±ç”¨è¿™ä¸€ä¸ª Pï¼Œé¦–å…ˆï¼Œgoroutine1ï¼ˆç®€ç§° g1ï¼‰ å…ˆæ”¾åˆ° runnextï¼Œä¹‹å g2 è¿›æ¥æŠŠ g1 æŒ¤èµ°ï¼Œg1 æ”¾åˆ° runqï¼Œå†ä¹‹åï¼Œg3 æŠŠ g2 æŒ¤èµ°ï¼Œg2 æ”¾åˆ° runqï¼Œæ­¤æ—¶ runnext ä¿å­˜çš„æ˜¯ g3ï¼Œrunq ä¸­æ˜¯ g1ï¼Œg2ï¼Œæ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ 3ï¼Œ1ï¼Œ2\ngoroutine çš„è°ƒåº¦æ—¶æœºæœ‰å“ªäº› ","date":"2022å¹´01æœˆ26æ—¥","permalink":"/posts/gmp-mian-shi-ti/","summary":"Goroutine é˜»å¡çš„è¯ï¼Œæ˜¯ä¸æ˜¯å¯¹åº”çš„ M ä¹Ÿä¼šé˜»å¡ å¦‚æœ G è¢«é˜»å¡åœ¨æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œé‚£ä¹ˆä¸ä»…ä»… G ä¼šé˜»å¡ï¼Œæ‰§è¡Œ G çš„ M ä¹Ÿä¼šè§£ç»‘ Pï¼Œä¸ G ä¸€èµ·è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚å¦‚æœæ­¤æ—¶æœ‰ç©ºé—²çš„ M,åˆ™ P å’Œä¸å…¶ç»‘å®šå¹¶ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ G;å¦‚æœæ²¡æœ‰ç©ºé—²çš„ M,ä½†è¿˜æ˜¯æœ‰å…¶ä»– G éœ€è¦å»æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ªæ–° Mã€‚å½“ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œé˜»å¡åœ¨è¯¥ç³»ç»Ÿè°ƒç”¨ä¸Šçš„ G ä¼šå°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ P,å¦‚æœæ²¡æœ‰å¯ç”¨çš„ P,é‚£ä¹ˆè¿™ä¸ª G ä¼šè¢«æ ‡è®°ä¸º runnable å¹¶æŠŠå®ƒæ”¾å…¥å…¨å±€çš„ runqueue ä¸­ç­‰å¾…è°ƒåº¦ï¼Œä¹‹å‰çš„é‚£ä¸ªæŒ‚èµ·çš„ M å°†å†æ¬¡è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚","title":"GMP é¢è¯•é¢˜"},{"contents":" è½¬è½½è‡ªï¼šhttps://blog.csdn.net/u010476994/article/details/104001848 ï¼ˆCentos 7 éƒ¨åˆ†ï¼‰ https://blog.csdn.net/u014630144/article/details/108129079 ï¼ˆUbuntu 20 éƒ¨åˆ†ï¼‰\næœ¬å¸–å­èƒ½å¤Ÿå®ç°çš„æ•ˆæœï¼š 1ã€è™šæ‹Ÿæœºèƒ½è®¿é—®å¤–ç½‘ã€è™šæ‹Ÿæœºèƒ½è®¿é—®Macæœ¬æœºï¼› 2ã€Macæœ¬æœºå¯ä»¥è¿æ¥è™šæ‹Ÿæœºã€‚\nMac å‰ææ­¥éª¤ 1ã€é…ç½® VMware Fusion è™šæ‹Ÿç½‘ç»œé…ç½® VMware Fusion å®‰è£…å®Œæˆåï¼Œä¼šåœ¨Mac OSä¸­æ–°å»ºä¸¤ä¸ªç½‘å¡ï¼š vmnet1ä»¥åŠvmnet8ï¼ˆåœ¨ /Library/Preferences/VMware Fusion ä¸‹å¯ä»¥çœ‹åˆ°ï¼‰ï¼Œå…¶ä¸­ vmnet1 æ˜¯Host-onlyæ¨¡å¼ï¼Œ vmnet8æ˜¯NATæ¨¡å¼ã€‚æ­¤å¤„ä»…å¯¹ç½‘å¡vmnet8 è¿›è¡Œä¿®æ”¹ï¼ˆ ä¿®æ”¹è¿‡ç¨‹ä¸­éœ€å…³é—­VMWare Fusionï¼‰ã€‚\n1.1 ä¿®æ”¹ /Library/Preferences/VMware\\ Fusion/networking ã€‚ sudo vi /Library/Preferences/VMware\\ Fusion/networking å°† DHCP è®¾ç½®ä¸º noï¼Œ å³ä½¿ç”¨é™æ€IPã€‚ å°† SUBNET ä¿®æ”¹ä¸ºè‡ªå·±æƒ³ç”¨çš„ç½‘æ®µï¼Œæ­¤å¤„æˆ‘å¡«çš„æ˜¯ 192.168.111.0 ç½‘æ®µã€‚\nä¿å­˜é€€å‡ºã€‚ æ³¨æ„ï¼šåªä¿®æ”¹ vmnet8 çš„é…ç½®ï¼Œ ä¸è¦ä¿®æ”¹ vmnet1 çš„é…ç½®ã€‚\n1.2 ä¿®æ”¹ /Library/Preferences/VMware\\ Fusion/vmnet8/nat.conf ã€‚ è®¾ç½®ç½‘å…³ä¸º 192.168.111.2 ï¼Œ ç½‘å…³çš„IPè¦å’Œä¸Šä¸€æ­¥ä¸­çš„IP ä¿æŒç½‘å…³ä¸€è‡´ã€‚ è‡³æ­¤ï¼ŒVMware Fusionçš„é…ç½®å®Œæ¯•ã€‚\n1.3 å°†è™šæ‹Ÿæœºç½‘ç»œåˆ‡æ¢åˆ°NATæ¨¡å¼ã€‚ CentOS 7 æ­¥éª¤å¦‚ä¸‹ï¼š\n1ã€æ‰“å¼€è™šæ‹Ÿæœºï¼Œé…ç½®è™šæ‹Ÿæœºç½‘ç»œé…ç½®ä¿¡æ¯ sudo vim /etc/sysconfig/network-scripts/ifcfg-ens33 å¯æŒ‰å¦‚ä¸‹æ ¼å¼é…ç½®ç½‘ç»œä¿¡æ¯ï¼ˆéƒ¨åˆ†ä¿¡æ¯éœ€æŒ‰ç…§è‡ªå·±çš„æƒ…å†µé…ç½®ï¼‰\nTYPE=Ethernet PROXY_METHOD=none BROWSER_ONLY=no BOOTPROTO=static DEFROUTE=yes IPV4_FAILURE_FATAL=no IPV6INIT=yes IPV6_AUTOCONF=yes IPV6_DEFROUTE=yes IPV6_FAILURE_FATAL=no IPV6_ADDR_GEN_MODE=stable-privacy NAME=ens33 UUID=405afcb9-08fe-4507-8775-232604d2e819 DEVICE=ens33 ONBOOT=yes IPADDR=192.168.110.14 # è‡ªå®šä¹‰çš„è™šæ‹ŸæœºIPï¼Œ éœ€ä¸VMware Fusioné…ç½®çš„IPåœ¨åŒä¸€ä¸ªç½‘æ®µä¸Š GATEWAY=192.168.110.2 # ç½‘å…³ã€‚1.2ä¸­é…ç½®çš„ç½‘å…³åœ°å€ NETMASK=255.255.255.0 # æ©ç ã€‚1.2ä¸­é…ç½®çš„æ©ç  DNS1=192.168.1.1 # Macæœ¬æœºçš„DNSåœ°å€ã€‚ ç³»ç»Ÿåå¥½è®¾ç½®-\u0026gt; ç½‘ç»œ -\u0026gt; åœ¨å·¦ä¾§é€‰æ‹©å½“å‰ä½¿ç”¨çš„ç½‘ç»œï¼Œç‚¹å‡»å³ä¸‹è§’çš„â€œé«˜çº§â€æŒ‰é’® -\u0026gt; åˆ‡æ¢Tabé¡µï¼Œå¯æ‰¾åˆ°DNSåœ°å€ã€‚ DNS2=192.168.1.1 # åŒä¸Š ä¿å­˜é€€å‡ºï¼Œé‡å¯ç½‘ç»œæœåŠ¡\nsystemctl restart network è‡³æ­¤ã€‚æ‰€æœ‰ç½‘ç»œé…ç½®å®Œæˆã€‚\næ³¨æ„ï¼šä¿®æ”¹å®Œ DNS åéœ€è¦é‡å¯ VMware æ‰èƒ½ç”Ÿæ•ˆ ï¼ˆè²Œä¼¼åªéœ€è¦é‡å¯ä¸€æ¬¡ï¼Œåç»­å†æ›´æ”¹ DNS ä¸éœ€è¦é‡å¯äº†ï¼‰\nUbuntu 20 1. ç¼–è¾‘ç½‘ç»œé…ç½®æ–‡ä»¶ï¼š sudo vi /etc/netplan/00-installer-config.yaml ç¼–è¾‘æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n# This is the network config written by 'subiquity' network: ethernets: ens33: dhcp4: no addresses: [192.168.110.10/24] # ç¡®ä¿è¯¥å€¼åœ¨å‰ææ­¥éª¤ 1.1 ä¸­è®¾ç½®çš„ ip æ®µå†…ï¼Œä¸”å­ç½‘æ©ç ç›¸åŒ gateway4: 192.168.110.2 # ä¸å‰ææ­¥éª¤ 1.2 ä¸­ç½‘ç®¡ ip ç›¸åŒ nameservers: addresses: [114.114.114.114] version: 2 ä½¿é…ç½®çš„ipåœ°å€ç”Ÿæ•ˆï¼š\nsudo netplan apply é‡å¯ VMware Fusion ç”Ÿæ•ˆã€‚\n","date":"2022å¹´01æœˆ17æ—¥","permalink":"/posts/mac-huan-jing-xia-vmware-fusion-xia-de-xu-ni-ji-centos-7de-nat-wang-luo-pei-zhi/","summary":"è½¬è½½è‡ªï¼šhttps://blog.csdn.net/u010476994/article/details/104001848 ï¼ˆCentos 7 éƒ¨åˆ†ï¼‰ https://blog.","title":"Macç¯å¢ƒä¸‹ï¼Œ VMware Fusionä¸‹çš„è™šæ‹Ÿæœºï¼ˆ CentOS 7/Ubuntu20ï¼‰çš„ NATç½‘ç»œé…ç½®"},{"contents":"æµ‹è¯•æ•°æ®å¦‚ä¸‹ï¼š\nCREATE TABLE `t` ( `id` int(11) NOT NULL, `c` int(11) DEFAULT NULL, `d` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `c` (`c`) ) ENGINE=InnoDB; +----+------+------+ | id | c | d | +----+------+------+ | 0 | 0 | 0 | | 5 | 5 | 5 | | 10 | 10 | 10 | | 15 | 15 | 15 | | 20 | 20 | 20 | | 25 | 25 | 25 | +----+------+------+ æµ‹è¯•æƒ…æ™¯ 1 ä¸å­˜åœ¨çš„ä¸»é”®ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where id = 9 for update; 4 insert into t values(11,5,5); 5 insert into t values(6,5,5); 6 insert into t values(10,5,5); 7 insert into t values(4,5,5); 8 select * from t where id = 9 for update; ç»“æœï¼š\nB1ï¼šæˆåŠŸæ‰§è¡Œï¼Œè¾“å‡º Empty set\nB4ï¼šæˆåŠŸæ‰§è¡Œ\nB5ï¼šè¢«é˜»å¡\nB6ï¼šDuplicate entry \u0026lsquo;10\u0026rsquo; for key \u0026rsquo;t.PRIMARY\u0026rsquo; ä¸»é”®ä¸èƒ½é‡å¤\nB7ï¼šæˆåŠŸæ‰§è¡Œ\nB8ï¼šæˆåŠŸæ‰§è¡Œï¼Œè¾“å‡º Empty set\nè¯´æ˜ï¼š\nå› ä¸º id = 9 è¿™ä¸€è¡Œä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šåŠ é—´éš™é”ï¼ŒåŒºé—´ä¸º (5, 10]ï¼Œå·¦å¼€å³é—­ã€‚æ‰€ä»¥æ‰€æœ‰å°è¯•åœ¨ [5, 10) åŒºé—´ insert æ•°æ®çš„ sql éƒ½è¢«é˜»å¡äº†ï¼Œä½†æ˜¯åŒºé—´å¤–ä¸ä¼šè¢«é˜»å¡ï¼Œæ¯”å¦‚ id=11 å’Œ id = 4 å°±æˆåŠŸæ‰§è¡Œäº†ã€‚\nå…³äº B8 ä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é˜»å¡ï¼Œå¯èƒ½æ˜¯å› ä¸ºå› ä¸º id=9 ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ A3 å¤„çš„ for update å¹¶æ²¡æœ‰ç”Ÿæ•ˆåŠ é”ã€‚\næµ‹è¯•æƒ…æ™¯ 2 session A session B 1 begin 2 begin 3 select * from t where id = 9 for update; 4 insert into t values(9,9,9); 5 select * from t where id = 9 for update; 6 select * from t where id = 7 for update; 7 8 A3ï¼šæˆåŠŸæ‰§è¡Œï¼Œè¾“å‡º Empty set\nA4ï¼šæˆåŠŸæ‰§è¡Œ\nB5ï¼šè¢«é˜»å¡\nB6ï¼šæˆåŠŸæ‰§è¡Œï¼Œè¾“å‡º Empty set\nä¸ºä»€ä¹ˆ B5 ä¼šè¢«é˜»å¡å‘¢ï¼Ÿä¼¼ä¹é™¤äº† id=9 ä»¥å¤–ï¼Œå…¶ä»–çš„æŸ¥è¯¢éƒ½ä¸ä¼šè¢«é˜»å¡\nç ´æ¡ˆäº†ï¼Œinsert ä¼šåŠ æ’å®ƒé”\næµ‹è¯•æƒ…æ™¯ 3 å·²ç»å­˜åœ¨çš„ä¸»é”®ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where id = 10 for update; 4 insert into t values(11,5,5); 5 insert into t values(9,5,5); 6 select * from t where id = 10 for update; 7 select * from t where id = 9 for update; 8 select * from t where id = 11 for update; 9 select * from t where id = 8 for update; A3ï¼šæˆåŠŸæ‰§è¡Œ\nB4ï¼šæˆåŠŸæ‰§è¡Œ\nB5ï¼šæˆåŠŸæ‰§è¡Œ\nB6ï¼šè¢«é˜»å¡\nA7ï¼šè¢«é˜»å¡\nA8ï¼šè¢«é˜»å¡\nA9ï¼šæˆåŠŸæ‰§è¡Œ\nå› ä¸º id=10 å­˜åœ¨ä¸” id ä¸ºä¸»é”®ï¼Œæ‰€ä»¥åªåŠ äº†æ’ä»–é”ï¼Œæ²¡æœ‰åŠ é—´éš™é”ï¼Œæ‰€ä»¥ B4ï¼ŒB5 çš„æ’å…¥éƒ½æˆåŠŸäº†ï¼ŒB6 è¢«é˜»å¡äº†ï¼Œå› ä¸º id=10 è¿™ä¸€è¡Œå·²ç»ä¸Šé”äº†ã€‚\nç”±äºä¸»é”®æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œè€Œä¸”æ˜¯åªä½¿ç”¨ä¸€ä¸ªç´¢å¼•æŸ¥è¯¢ï¼Œå¹¶ä¸”åªé”å®šä¸€æ¡è®°å½•ï¼Œæ‰€ä»¥ä»¥ä¸Šçš„ä¾‹å­ï¼Œåªä¼šå¯¹ id = 10 çš„æ•°æ®åŠ ä¸Šè®°å½•é”ï¼Œè€Œä¸ä¼šäº§ç”Ÿé—´éš™é”ã€‚\næ¯”è¾ƒæ€ªå¼‚çš„æ˜¯ A7ã€A8 è¿™ä¸¤ä¸ªåœ°æ–¹ï¼Œå±…ç„¶è¢«é˜»å¡äº†ï¼Œè§‚å¯Ÿå‘ç°ï¼Œè¿™ä¸¤ä¸ª sql æŸ¥è¯¢çš„ id æ˜¯ 9 å’Œ 10ï¼Œåˆšå¥½æ˜¯ B ä¸­æ’å…¥çš„ä¸¤ä¸ª idï¼Œè€Œ A9 å¤„çš„ id=8 æ²¡æœ‰è¢«é˜»å¡ï¼Œéš¾é“åœ¨ insert ä¹‹åä¼šç»™æ–°æ’å…¥çš„è¡ŒåŠ é”å—ï¼Ÿ\nç ´æ¡ˆäº†ï¼Œinsert ä¼šåŠ æ’å®ƒé”\næµ‹è¯•æƒ…æ™¯ 4 å·²ç»å­˜åœ¨çš„éç´¢å¼•åˆ—ï¼ˆå¯èƒ½æŸ¥å‡ºå¤šæ¡æ•°æ®ï¼‰ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where d=5 for update; 4 insert into t values(26,26,5); 5 insert into t values(26,26,4); 6 insert into t values(100,100,100); A3ï¼šæˆåŠŸæ‰§è¡Œ\nB4ï¼šè¢«é˜»å¡\nB5ï¼šè¢«é˜»å¡\nB6ï¼šè¢«é˜»å¡\nå› ä¸º A3 æŸ¥è¯¢æ¡ä»¶æ˜¯ d=5ï¼Œè€Œ d æ—¢ä¸æ˜¯ä¸»é”®ä¹Ÿæ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šåŠ é—´éš™é”ï¼Œé˜²æ­¢å¹»è¯»å‡ºç°ï¼Œé—´éš™é”çš„èŒƒå›´æ˜¯ (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +suprenum]ï¼Œæ‰€æœ‰çš„ insert å…¨éƒ¨è¢«é˜»å¡äº†ï¼Œ\næµ‹è¯•æƒ…æ™¯ 5 ä¸å­˜åœ¨çš„éç´¢å¼•åˆ—ï¼ˆå¯èƒ½æŸ¥å‡ºå¤šæ¡æ•°æ®ï¼‰ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where d=100 for update; 4 insert into t values(26,26,5); 5 insert into t values(26,26,4); 6 insert into t values(100,100,100); ç»“è®ºï¼šsession B çš„ insert å…¨éƒ¨è¢«é˜»å¡ï¼Œç”±æ­¤å¯è§ï¼Œå³ä¾¿ d=100 è¿™ä¸€è¡Œä¸å­˜åœ¨ï¼Œä¾ç„¶ä¼šåŠ é—´éš™é”\næµ‹è¯•åœºæ™¯ 6 ä¸å­˜åœ¨çš„æ™®é€šç´¢å¼•åˆ—ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where c=9 for update; 4 insert into t values(11,11,11); 5 insert into t values(100,8,100); 6 insert into t values(100,10,100); 7 insert into t values(101,5,100); 8 insert into t values(102,4,100); B4ï¼šæˆåŠŸæ‰§è¡Œ\nB5ï¼šè¢«é˜»å¡\nB6ï¼šæˆåŠŸæ‰§è¡Œ\nB7ï¼šè¢«é˜»å¡\nB8ï¼šæˆåŠŸæ‰§è¡Œ\nå¯¹äºåˆ— c è€Œè¨€ï¼Œæœ‰è¿™äº›é—´éš™ï¼š (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +suprenum]\nå› ä¸ºæŸ¥è¯¢çš„æ˜¯ c=9 ï¼Œæ‰€ä»¥é—´éš™é”èŒƒå›´æ˜¯ (5,10]ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å¤ªæ˜ç™½è¿™ä¸ªèŒƒå›´çš„æ„æ€ï¼ŒæŒ‰ç…§æ•°å­¦æ¥è¯´ï¼Œåº”è¯¥æ˜¯ä¸åŒ…å« 5ï¼Œä½†æ˜¯åŒ…å« 10 çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯ c=5 ä¸åŠ é”ï¼Œc=10 åŠ é”ï¼Œä½†æ˜¯ä»ä¸Šé¢çš„æµ‹è¯•æ¥çœ‹ï¼Œinsert c=5 è¢«é˜»å¡ï¼Œè€Œ insert c=10 æ²¡æœ‰è¢«é˜»å¡ï¼Œå®Œå…¨ç›¸åï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ\næµ‹è¯•æƒ…æ™¯ 6 session A session B 1 begin 2 begin 3 insert into t values(9,9,9); 4 select * from t where id=9 for update; A3ï¼šæ‰§è¡ŒæˆåŠŸ\nB4ï¼šé˜»å¡\nå¯ä»¥å‚è€ƒ https://zhuanlan.zhihu.com/p/48269420\n","date":"2021å¹´10æœˆ19æ—¥","permalink":"/posts/mysql-jian-xi-suo-shi-jian/","summary":"æµ‹è¯•æ•°æ®å¦‚ä¸‹ï¼š\nCREATE TABLE `t` ( `id` int(11) NOT NULL, `c` int(11) DEFAULT NULL, `d` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `c` (`c`) ) ENGINE=InnoDB; +----+------+------+ | id | c | d | +----+------+------+ | 0 | 0 | 0 | | 5 | 5 | 5 | | 10 | 10 | 10 | | 15 | 15 | 15 | | 20 | 20 | 20 | | 25 | 25 | 25 | +----+------+------+ æµ‹è¯•æƒ…æ™¯ 1 ä¸å­˜åœ¨çš„ä¸»é”®ï¼Œselect æ˜¯å¦ä¼šåŠ é—´éš™é” session A session B 1 begin 2 begin 3 select * from t where id = 9 for update; 4 insert into t values(11,5,5); 5 insert into t values(6,5,5); 6 insert into t values(10,5,5); 7 insert into t values(4,5,5); 8 select * from t where id = 9 for update; ç»“æœï¼š","title":"Mysql é—´éš™é”å®è·µ"},{"contents":"å…¨æ–‡åŸºäºæ­¤è¡¨ï¼š\nCREATE TABLE `t` ( `id` int(11) NOT NULL, `c` int(11) DEFAULT NULL, `d` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `c` (`c`) ) ENGINE=InnoDB; insert into t values(0,0,0),(5,5,5), (10,10,10),(15,15,15),(20,20,20),(25,25,25); 1. ä»€ä¹ˆæ˜¯å¹»è¯» å¦‚ä¸‹æ˜¯æ–‡ç« ä¸­çš„å›¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ result æ˜¯åŸºäº å¦‚æœåªåœ¨id=5è¿™ä¸€è¡ŒåŠ é”ï¼Œè€Œå…¶ä»–è¡Œçš„ä¸åŠ é” ï¼ˆä¹Ÿå°±æ˜¯è¡Œé”ï¼‰è¿™ä¸€åŸºç¡€ä¸Šçš„ï¼Œå½“æ—¶æ²¡æ³¨æ„è¿™å¥è¯ï¼Œå¯¼è‡´è‡ªå·±ç”¨ Mysql åšå®éªŒæ—¶å‡ºç°äº†ä¸ä¸€æ ·çš„ç»“æœï¼šsession A çš„ T1 æ‰§è¡Œå®Œæˆåï¼Œsession B çš„ T2 è¢«é˜»å¡ï¼Œç›´åˆ° A äº‹åŠ¡ç»“æŸï¼Œå› ä¸º B è¢«é˜»å¡äº†ï¼Œæ‰€ä»¥ A çš„ T3 æŸ¥è¯¢ç»“æœä¾ç„¶æ˜¯ (5,5,5) è€Œä¸æ˜¯å›¾ä¸­çš„ (0,0,5)(5,5,5) å¹»è¯» æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œã€‚æ¯”å¦‚åœ¨ä¸Šå›¾ä¸­ï¼ŒQ3 è¯»åˆ°äº† (1,1,5) ï¼Œä¾¿æ˜¯å¹»è¯»ã€‚\nå¹»è¯» åœ¨ å½“å‰è¯» ä¸‹æ‰ä¼šå‡ºç°ï¼Œå›¾ä¸­çš„ select éƒ½åŠ äº† for updateï¼Œä»£è¡¨å½“å‰è¯»ã€‚ï¼ˆå½“å‰è¯»ï¼šè¯»å–çš„æ˜¯è®°å½•æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”å½“å‰è¯»è¿”å›çš„è®°å½•éƒ½ä¼šåŠ ä¸Šé”ï¼Œä¿è¯å…¶ä»–äº‹åŠ¡ä¸ä¼šå†å¹¶å‘çš„ä¿®æ”¹è¿™æ¡è®°å½•ï¼‰ï¼Œåœ¨å¿«ç…§è¯»ä¸‹ä¸ä¼šå‡ºç°ï¼ˆå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼‰ï¼Œå› ä¸ºå¿«ç…§è¯»çœ‹ä¸åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®ã€‚\nå¹»è¯» ä»…ä¸“æŒ‡ æ–°æ’å…¥çš„è¡Œï¼Œæ‰€ä»¥ session B T2 çš„ update æ“ä½œï¼Œå¯¼è‡´çš„ A T3 ç»“æœä¸ç®—æ˜¯å¹»è¯»ã€‚æ¯”å¦‚åœ¨ä¸Šå›¾ä¸­ï¼ŒQ2 è¯»åˆ°äº† (0,0,5) ï¼Œä½†ä¸æ˜¯å¹»è¯»ã€‚\n2. å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ è¿™æ˜¯åŸæ–‡ä¸­çš„æ ‡é¢˜ï¼Œä½†æ˜¯æˆ‘ä¸æ˜¯å¾ˆç†è§£ä¹‹åä¸¾çš„ä¾‹å­å’Œå¹»è¯»æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå€’æ˜¯æ¢æˆ åªåŠ è¡Œé”æœ‰ä»€ä¹ˆé—®é¢˜ æ›´è´´åˆ‡ï¼ˆä¸ªäººæ‹™è§ï¼‰ã€‚\n2.1 è¯­ä¹‰è¢«ç ´å session A é‡Œ Q1 è¯­å¥ï¼Œè¡¨ç¤ºè¦é”ä½æ‰€æœ‰ d=5 çš„è¡Œï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡çš„è¯»å†™æ“ä½œã€‚ä½†æ˜¯åœ¨ session B T2 ä¸­æ‰¾ä¸ªäº†æ¼æ´ï¼Œå…ˆå°† id=0 è¿™ä¸€è¡Œçš„ d æ”¹æˆ 5ï¼Œå†å¯¹è¿™ä¸€è¡Œè¿›è¡Œæ›´æ”¹ï¼Œè¿™æ ·å°±ç ´åäº† A ä¸­é”ä½æ‰€æœ‰ d=5 è¿™ä¸€è¯­å¥è¿›è¡Œäº†ç ´åï¼Œsession C ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚\n2.2 æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ é”çš„è®¾è®¡æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è€Œè¿™ä¸ªä¸€è‡´æ€§ï¼Œä¸æ­¢æ˜¯æ•°æ®åº“å†…éƒ¨æ•°æ®çŠ¶æ€åœ¨æ­¤åˆ»çš„ä¸€è‡´æ€§ï¼Œè¿˜åŒ…å«äº†æ•°æ®å’Œæ—¥å¿—åœ¨é€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ã€‚\nçœ‹çœ‹ binlog é‡Œé¢çš„å†…å®¹ï¼š\nT2 æ—¶åˆ»ï¼Œsession B äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›\nT4 æ—¶åˆ»ï¼Œsession C äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›\nT6 æ—¶åˆ»ï¼Œsession A äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†update t set d=100 where d=5 è¿™æ¡è¯­å¥ã€‚\n// session B update t set d=5 where id=0; /*(0,0,5)*/ update t set c=5 where id=0; /*(0,5,5)*/ // session C insert into t values(1,1,5); /*(1,1,5)*/ update t set c=5 where id=1; /*(1,5,5)*/ // session A update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/ å› ä¸º binlog æ˜¯æŒ‰ç…§ commit çš„å…ˆåé¡ºåºè®°å½•çš„ï¼Œè€Œä¸æ˜¯æŒ‰ update çš„æ‰§è¡Œé¡ºåºè®°å½•çš„ï¼ˆä¸Šå›¾ä¸­ A æœ€å…ˆæ‰§è¡Œ updateï¼Œç„¶åæ˜¯ Bï¼Œæœ€åæ˜¯ Cï¼‰ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´é”™è¯¯çš„ç»“æœï¼Œå¦‚æœä»¥åç”¨ binlog æ¥å…‹éš†ä¸€ä¸ªåº“ï¼Œè¿™ä¸‰è¡Œçš„ç»“æœå˜æˆäº† (0,5,100)ã€(1,5,100) å’Œ (5,5,100)ï¼Œä¸å®é™…çš„ (0,5,5)ã€(1,5,5) å’Œ (5,5,100) ä¸ç¬¦ï¼Œå› ä¸º A è¢«è®°å½•åˆ°äº†æœ€åã€‚\nå¦‚ä½•è®© binlog æŒ‰ update çš„æ‰§è¡Œé¡ºåºè®°å½•å‘¢ï¼ŸæŒ‰ç…§æ–‡ä¸­çš„è¯´æ³•æ˜¯ï¼ŒæŠŠæ‰«æè¿‡ç¨‹ä¸­ç¢°åˆ°çš„è¡Œï¼Œä¹Ÿéƒ½åŠ ä¸Šå†™é”ï¼Œï¼ˆè¿™é‡Œæ²¡å¤ªæ˜ç™½ï¼Œæ„æ€æ˜¯æŠŠ session A ä¸­çš„ select è¯­å¥æ‰«æåˆ°çš„è¡Œå…¨éƒ¨åŠ é”å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œå› ä¸º d æ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šæ‰«æå…¨è¡¨ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•´å¼ è¡¨éƒ½åŠ é”å—ï¼Ÿæš‚æ—¶å…ˆè¿™ä¹ˆç†è§£å§ï¼‰A select for update æ—¶ç›´æ¥å°†æ‰€æœ‰è¡Œé”èµ·æ¥ï¼Œè¿™æ ·åç»­çš„ B C éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ° A commitï¼Œè¿™æ · binlog ä¸­ï¼Œæœ€å…ˆè®°å½•çš„å°±æ˜¯ Aï¼Œæ­¤æ—¶çš„ binlogï¼š\ninsert into t values(1,1,5); /*(1,1,5)*/ update t set c=5 where id=1; /*(1,5,5)*/ update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/ update t set d=5 where id=0; /*(0,0,5)*/ update t set c=5 where id=0; /*(0,5,5)*/ å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„è®°å½•ä¾ç„¶å­˜åœ¨é—®é¢˜ï¼Œæœ€å…ˆè®°å½•çš„ä¸æ˜¯é¢„æƒ³ä¸­çš„ Aï¼Œè€Œæ˜¯ Cï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ˜æ˜éƒ½å·²ç»æŠŠæ•´å¼ è¡¨éƒ½é”èµ·æ¥äº†ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†id=1è¿™ä¸€è¡Œçš„æ’å…¥å’Œæ›´æ–°å‘¢ï¼Ÿ\nåŸå› å¾ˆç®€å•ã€‚åœ¨T3æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™æ‰€æœ‰è¡ŒåŠ é”çš„æ—¶å€™ï¼Œid=1è¿™ä¸€è¡Œè¿˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå°±åŠ ä¸ä¸Šé”ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æŠŠæ‰€æœ‰çš„è®°å½•éƒ½åŠ ä¸Šé”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†æ–°æ’å…¥çš„è®°å½•ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆâ€œå¹»è¯»â€ä¼šè¢«å•ç‹¬æ‹¿å‡ºæ¥è§£å†³çš„åŸå› ã€‚\n3. å¦‚ä½•è§£å†³å¹»è¯» 3.1 é—´éš™é” äº§ç”Ÿå¹»è¯»çš„åŸå› æ˜¯ï¼Œè¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„é—´éš™ã€‚\nä½•ä¸ºé—´éš™ï¼Ÿæ¯”å¦‚ (0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25) è¿™å…­æ¡è®°å½•ä¸­ï¼Œä¾¿å­˜åœ¨ä»¥ä¸‹ 7 ä¸ªé—´éš™ï¼š è¿™æ ·ï¼Œå½“ä½ æ‰§è¡Œ select * from t where d=5 for update çš„æ—¶å€™ï¼Œå°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„6ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜åŒæ—¶åŠ äº†7ä¸ªé—´éš™é”ã€‚è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚\nè·Ÿ é—´éš™é” å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œã€‚é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»ã€‚\nå¯¹äºæŒ‡å®šæŸ¥è¯¢æŸä¸€æ¡è®°å½•çš„åŠ é”è¯­å¥ï¼Œå¦‚æœè¯¥è®°å½•ä¸å­˜åœ¨ï¼Œä¼šäº§ç”Ÿè®°å½•é”å’Œé—´éš™é”ï¼Œå¦‚æœè®°å½•å­˜åœ¨ï¼Œåˆ™åªä¼šäº§ç”Ÿè®°å½•é”ã€‚ï¼ˆæ³¨æ„è¿™é‡Œçš„æŸ¥è¯¢ä¸€æ¡è®°å½•ï¼Œå¦‚æœæ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œæˆ–è€…æŸ¥è¯¢å‡ºå¤šæ¡ç»“æœï¼Œé‚£ä¹ˆä¸ç®¡å­˜ä¸å­˜åœ¨ï¼Œéƒ½ä¼šåŠ é—´éš™é”ï¼‰\nå¯¹äºæŸ¥æ‰¾æŸä¸€èŒƒå›´å†…çš„æŸ¥è¯¢è¯­å¥ï¼Œä¼šäº§ç”Ÿé—´éš™é”ï¼Œå¦‚ï¼šWHERE id BETWEEN 5 AND 7 FOR UPDATEã€‚\né—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„ã€‚\né—´éš™é”å’Œè¡Œé”åˆç§° next-key lockï¼Œæ¯ä¸ª next-key lock æ˜¯å‰å¼€åé—­åŒºé—´ã€‚\n3.2 é—´éš™é”å¯¼è‡´çš„æ­»é”æ¡ˆä¾‹ session A æ‰§è¡Œselect \u0026hellip; for updateè¯­å¥ï¼Œç”±äºid=9è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é”(5,10);\nsession B æ‰§è¡Œselect \u0026hellip; for updateè¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é”(5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›\nsession B è¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Açš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›\nsession Aè¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Bçš„é—´éš™é”æŒ¡ä½äº†ã€‚\nè‡³æ­¤ï¼Œä¸¤ä¸ª session è¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚å½“ç„¶ï¼ŒInnoDB çš„æ­»é”æ£€æµ‹é©¬ä¸Šå°±å‘ç°äº†è¿™å¯¹æ­»é”å…³ç³»ï¼Œè®© session A çš„ insert è¯­å¥æŠ¥é”™è¿”å›äº†ã€‚\n","date":"2021å¹´10æœˆ19æ—¥","permalink":"/posts/mysql-shi-zhan-bi-ji-20-jiang-huan-du-shi-shi-me/","summary":"å…¨æ–‡åŸºäºæ­¤è¡¨ï¼š\nCREATE TABLE `t` ( `id` int(11) NOT NULL, `c` int(11) DEFAULT NULL, `d` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `c` (`c`) ) ENGINE=InnoDB; insert into t values(0,0,0),(5,5,5), (10,10,10),(15,15,15),(20,20,20),(25,25,25); 1.","title":"MySQLå®æˆ˜ç¬”è®° 20è®²å¹»è¯»æ˜¯ä»€ä¹ˆ"},{"contents":"https://www.cnblogs.com/Joezzz/p/9803344.html\n","date":"2021å¹´10æœˆ04æ—¥","permalink":"/posts/zhuan-zai-jin-cheng-de-xu-ni-di-zhi-kong-jian-fen-bu/","summary":"https://www.cnblogs.com/Joezzz/p/9803344.html","title":"[è½¬è½½] è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒ"},{"contents":"https://blog.csdn.net/qq_41855420/article/details/103746234\n","date":"2021å¹´10æœˆ04æ—¥","permalink":"/posts/mac-tong-guo-dosbox-da-jian-hui-bian-huan-jing-fu-bian-yi-lian-jie-zhi-xing-diao-shi-xiang-xi-guo-cheng/","summary":"https://blog.csdn.net/qq_41855420/article/details/103746234","title":"[è½¬è½½] Mac é€šè¿‡DOSBoxæ­å»ºæ±‡ç¼–ç¯å¢ƒï¼ˆé™„ç¼–è¯‘ã€é“¾æ¥ã€æ‰§è¡Œã€è°ƒè¯•è¯¦ç»†è¿‡ç¨‹ï¼‰"},{"contents":" ç»™å®šä¸€ä¸ªæ— é‡å¤å…ƒç´ çš„æ­£æ•´æ•°æ•°ç»„Â candidatesÂ å’Œä¸€ä¸ªæ­£æ•´æ•°Â targetÂ ï¼Œæ‰¾å‡ºÂ candidatesÂ ä¸­æ‰€æœ‰å¯ä»¥ä½¿æ•°å­—å’Œä¸ºç›®æ ‡æ•°Â targetÂ çš„å”¯ä¸€ç»„åˆã€‚\ncandidatesÂ ä¸­çš„æ•°å­—å¯ä»¥æ— é™åˆ¶é‡å¤è¢«é€‰å–ã€‚å¦‚æœè‡³å°‘ä¸€ä¸ªæ‰€é€‰æ•°å­—æ•°é‡ä¸åŒï¼Œåˆ™ä¸¤ç§ç»„åˆæ˜¯å”¯ä¸€çš„ã€‚Â å¯¹äºç»™å®šçš„è¾“å…¥ï¼Œä¿è¯å’Œä¸ºÂ target çš„å”¯ä¸€ç»„åˆæ•°å°‘äº 150 ä¸ªã€‚\nç¤ºä¾‹Â 1ï¼š è¾“å…¥: candidates = [2,3,6,7], target = 7 è¾“å‡º: [[7],[2,2,3]]\nç¤ºä¾‹Â 2ï¼š è¾“å…¥: candidates = [2,3,5], target = 8 è¾“å‡º: [[2,2,2,2],[2,3,3],[3,5]]\nç¤ºä¾‹ 3ï¼š è¾“å…¥: candidates = [2], target = 1 è¾“å‡º: []\nç¤ºä¾‹ 4ï¼š è¾“å…¥: candidates = [1], target = 1 è¾“å‡º: [[1]]\nç¤ºä¾‹ 5ï¼š è¾“å…¥: candidates = [1], target = 2 è¾“å‡º: [[1,1]]\næç¤ºï¼š 1 \u0026lt;= candidates.length \u0026lt;= 30 1 \u0026lt;= candidates[i] \u0026lt;= 200 candidate ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚ 1 \u0026lt;= target \u0026lt;= 500\næ–¹æ³• 1 å›æº¯ é€’å½’æ ‘å¦‚ä¸‹ï¼šï¼ˆä»¥ candidates = [2,3,6,7], target = 7 ä¸ºä¾‹ï¼‰ ä»£ç ï¼š\nfunc combinationSum(candidates []int, target int) [][]int { var res [][]int var tmp []int backtrack(candidates, target, 0, 0, tmp, \u0026amp;res) return res } func backtrack(c []int, t, sum, start int, tmp []int, res *[][]int) { if sum == t { tmpp := make([]int, len(tmp)) copy(tmpp, tmp) *res = append(*res, tmpp) return } if sum \u0026gt; t { return } for i := start; i \u0026lt; len(c); i++ { tmp = append(tmp, c[i]) sum += c[i] fmt.Println(tmp) backtrack(c, t, sum, i, tmp, res) tmp = tmp[:len(tmp)-1] sum -= c[i] } } ","date":"2021å¹´09æœˆ25æ—¥","permalink":"/posts/39-zu-he-zong-he/","summary":"ç»™å®šä¸€ä¸ªæ— é‡å¤å…ƒç´ çš„æ­£æ•´æ•°æ•°ç»„Â candidatesÂ å’Œä¸€ä¸ªæ­£æ•´æ•°Â targetÂ ï¼Œæ‰¾å‡ºÂ candidatesÂ ä¸­æ‰€æœ‰å¯ä»¥ä½¿æ•°å­—å’Œä¸ºç›®æ ‡æ•°Â targetÂ çš„å”¯ä¸€ç»„åˆã€‚","title":"39. ç»„åˆæ€»å’Œ"},{"contents":"å‘½ä»¤ï¼š ps -ef | grep name | grep -v grep | awk '{print $2}' | xargs kill è§£é‡Šï¼š ps -efï¼šæŸ¥çœ‹å…¨æ ¼å¼çš„å…¨éƒ¨è¿›ç¨‹\ngrep nameï¼šå°† ps -ef çš„è¾“å‡ºä½œä¸ºè¾“å…¥ï¼Œè¿‡æ»¤å‡ºå…¶ä¸­åŒ…å« â€nameâ€œ çš„ç»“æœ\ngrep -v grepï¼š-v ä»£è¡¨åå‘é€‰æ‹©ï¼Œè¿™æ¡æ˜¯æ¯”è¾ƒè¿·æƒ‘çš„ï¼Œä¸ºä»€ä¹ˆè¦åŠ è¿™æ¡è¯­å¥å‘¢ï¼Ÿå› ä¸ºä¹‹å‰çš„ grep name è¿™å¥è¯æœ¬èº«ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”è¯¥è¿›ç¨‹ä¸­ä¹Ÿä¼šåŒ…å« \u0026ldquo;name\u0026rdquo; è¿™ä¸ªå­—æ®µï¼Œæ‰€ä»¥ grep name è¾“å‡ºçš„åˆ—è¡¨ä¸­ä¹Ÿä¼šåŒ…å«å…¶è‡ªèº«çš„è¿›ç¨‹ï¼Œä½†æ˜¯è¯¥è¿›ç¨‹åœ¨ grep æ‰§è¡Œä¹‹åå°±ä¼šé€€å‡ºï¼Œå¦‚æœæ­¤æ—¶å†å°†å…¶ killï¼Œä¼šäº§ç”Ÿ kill: 32169: No such process é”™è¯¯ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿ç”¨ -v grepï¼Œåå‘é€‰æ‹©ï¼Œé€‰æ‹©å‡ºä¸åŒ…å« grep çš„æ¡ç›®\nawkï¼šps è¾“å‡ºçš„å‘½ä»¤åŒ…å«äº† rootã€pid ç­‰å¤šä¸ªå­—æ®µï¼Œä½†æ˜¯ kill åªéœ€è¦ pid å­—æ®µï¼Œé€šè¿‡è¯¥å‘½ä»¤ï¼Œå¯ä»¥ç­›é€‰å‡ºéœ€è¦çš„ pidï¼Œ$2 è¡¨ç¤ºæ¯è¡Œç¬¬äºŒä¸ªå˜é‡ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯è¿›ç¨‹å·\nxargsï¼šè¡¨ç¤ºç”¨å‰é¢å‘½ä»¤çš„è¾“å‡ºç»“æœï¼ˆä¹Ÿå°±æ˜¯ä¸€ç³»åˆ—çš„è¿›ç¨‹å·ï¼‰ä½œä¸º kill å‘½ä»¤çš„å‚æ•°\nå®è·µ ä½¿ç”¨ go è¿›è¡Œå®è·µ é¦–å…ˆåˆ›å»ºå‡ºä»»æ„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨ go ç¼–å†™ä¸€ä¸ªç®€å•ç¨‹åºï¼Œå¹¶ç¼–è¯‘å‡ºæ¥ï¼Œæ–‡ä»¶åä¸º sleep.goï¼š\npackage main import \u0026quot;time\u0026quot; func main() { time.Sleep(time.Hour) } ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ï¼š\ngo build sleep.go ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶åä¸º sleep\nå†åˆ›å»ºä¸€ä¸ª go ç¨‹åºï¼Œç”¨æ¥åˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼š\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;os/exec\u0026quot; \u0026quot;sync\u0026quot; ) func main() { var wg sync.WaitGroup wg.Add(100) for i := 0; i \u0026lt; 100; i++ { go func() { defer wg.Done() cmd := exec.Command(\u0026quot;./sleep\u0026quot;) _, err := cmd.CombinedOutput() if err != nil { log.Fatalln(err) } }() } wg.Wait() } æ­¤æ—¶æ‰§è¡Œ ps -ef | grep sleepï¼Œç»ˆç«¯è¾“å‡ºï¼š\n501 32764 1880 0 10:16ä¸‹åˆ ttys000 0:00.01 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox sleep 501 32660 32659 0 10:16ä¸‹åˆ ttys009 0:00.01 ./sleep 501 32661 32659 0 10:16ä¸‹åˆ ttys009 0:00.01 ./sleep 501 32662 32659 0 10:16ä¸‹åˆ ttys009 0:00.01 ./sleep 501 32663 32659 0 10:16ä¸‹åˆ ttys009 0:00.01 ./sleep .... çœç•¥ æ³¨æ„ï¼Œè¿™é‡Œçš„ç¬¬ä¸€æ¡å°±æ˜¯ grep è‡ªèº«çš„è¿›ç¨‹\næˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼Œä¸åŠ  grep -v grep ä¼šæ€ä¹ˆæ ·ï¼š\nps -ef | grep sleep | awk '{print $2}' | xargs kill ç»“æœï¼š\nkill: 32772: No such process è¿è¡Œå‡ºé”™äº†ï¼ˆè¿™é‡Œæ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ 32764ï¼Ÿï¼‰\næ­¤æ—¶å†æ‰§è¡Œ ps -ef | grep sleep\n501 32784 1880 0 10:17ä¸‹åˆ ttys000 0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox sleep å‘ç°è¿˜æœ‰ä¸€æ¡æ²¡è¢« kill æ‰\nè€Œå¦‚æœä½¿ç”¨ ps -ef | grep name | grep -v grep | awk '{print $2}' | xargs killï¼Œåˆ™ä¸ä¼šäº§ç”Ÿé”™è¯¯ï¼Œå¹¶ä¸”æ‰€æœ‰å¸¦æœ‰ â€sleepâ€œ çš„è¿›ç¨‹éƒ½è¢« kill æ‰äº†\n","date":"2021å¹´09æœˆ21æ—¥","permalink":"/posts/linux-pi-liang-kill-jin-cheng/","summary":"å‘½ä»¤ï¼š ps -ef | grep name | grep -v grep | awk '{print $2}' | xargs kill è§£é‡Šï¼š ps -efï¼šæŸ¥çœ‹å…¨æ ¼å¼çš„å…¨éƒ¨è¿›ç¨‹","title":"Linux æ‰¹é‡ kill è¿›ç¨‹"},{"contents":"B æ ‘å’Œ B+ æ ‘çš„åŒºåˆ« æ¥æºï¼šhttps://draveness.me/whys-the-design-mysql-b-plus-tree/\nB æ ‘ä¸ B+ æ ‘çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ï¼ŒB æ ‘å¯ä»¥åœ¨éå¶ç»“ç‚¹ä¸­å­˜å‚¨æ•°æ®ï¼Œä½†æ˜¯ B+ æ ‘çš„æ‰€æœ‰æ•°æ®å…¶å®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå½“ä¸€ä¸ªè¡¨åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ B æ ‘æ—¶ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦è®¿é—®æ‰€æœ‰ã€å¤§äº 4ï¼Œå¹¶ä¸”å°äº 9 çš„æ•°æ®ã€ï¼š å¦‚æœä¸è€ƒè™‘ä»»ä½•ä¼˜åŒ–ï¼Œåœ¨ä¸Šé¢çš„ç®€å• B æ ‘ä¸­æˆ‘ä»¬éœ€è¦è¿›è¡Œ 4 æ¬¡ç£ç›˜çš„éšæœº I/O æ‰èƒ½æ‰¾åˆ°æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ•°æ®è¡Œï¼š\nåŠ è½½æ ¹èŠ‚ç‚¹æ‰€åœ¨çš„é¡µï¼Œå‘ç°æ ¹èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ 6ï¼Œå¤§äº 4ï¼› é€šè¿‡æ ¹èŠ‚ç‚¹çš„æŒ‡é’ˆåŠ è½½å·¦å­èŠ‚ç‚¹æ‰€åœ¨çš„é¡µï¼Œéå†é¡µé¢ä¸­çš„æ•°æ®ï¼Œæ‰¾åˆ° 5ï¼› é‡æ–°åŠ è½½æ ¹èŠ‚ç‚¹æ‰€åœ¨çš„é¡µï¼Œå‘ç°æ ¹èŠ‚ç‚¹ä¸åŒ…å«ç¬¬äºŒä¸ªå…ƒç´ ï¼› é€šè¿‡æ ¹èŠ‚ç‚¹çš„æŒ‡é’ˆåŠ è½½å³å­èŠ‚ç‚¹æ‰€åœ¨çš„é¡µï¼Œéå†é¡µé¢ä¸­çš„æ•°æ®ï¼Œæ‰¾åˆ° 7 å’Œ 8ï¼› å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å„ç§æ–¹å¼æ¥å¯¹ä¸Šè¿°çš„è¿‡ç¨‹è¿›è¡Œä¼˜åŒ–ï¼Œä¸è¿‡ B æ ‘èƒ½åšçš„ä¼˜åŒ– B+ æ ‘åŸºæœ¬éƒ½å¯ä»¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘ä¼˜åŒ– B æ ‘è€Œå¸¦æ¥çš„æ”¶ç›Šï¼Œç›´æ¥æ¥çœ‹çœ‹ä»€ä¹ˆæ ·çš„ä¼˜åŒ– B+ æ ‘å¯ä»¥åšï¼Œè€Œ B æ ‘ä¸è¡Œã€‚\nç”±äºæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¯èƒ½åŒ…å«ç›®æ ‡æ•°æ®ï¼Œæˆ‘ä»¬æ€»æ˜¯è¦ä»æ ¹èŠ‚ç‚¹å‘ä¸‹éå†å­æ ‘æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„æ•°æ®è¡Œï¼Œè¿™ä¸ªç‰¹ç‚¹å¸¦æ¥äº†å¤§é‡çš„éšæœº I/Oï¼Œä¹Ÿæ˜¯ B æ ‘æœ€å¤§çš„æ€§èƒ½é—®é¢˜ã€‚\nB+ æ ‘ä¸­å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜äº†ï¼Œå› ä¸ºæ‰€æœ‰çš„æ•°æ®è¡Œéƒ½å­˜å‚¨åœ¨å¶èŠ‚ç‚¹ä¸­ï¼Œè€Œè¿™äº›å¶èŠ‚ç‚¹å¯ä»¥é€šè¿‡ã€æŒ‡é’ˆã€ä¾æ¬¡æŒ‰é¡ºåºè¿æ¥ï¼Œå½“æˆ‘ä»¬åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ B+ æ ‘éå†æ•°æ®æ—¶å¯ä»¥ç›´æ¥åœ¨å¤šä¸ªå­èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œè·³è½¬ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœå¤§é‡çš„ç£ç›˜ I/O æ—¶é—´ï¼Œä¹Ÿä¸éœ€è¦åœ¨ä¸åŒå±‚çº§çš„èŠ‚ç‚¹ä¹‹é—´å¯¹æ•°æ®è¿›è¡Œæ‹¼æ¥å’Œæ’åºï¼›é€šè¿‡ä¸€ä¸ª B+ æ ‘æœ€å·¦ä¾§çš„å¶å­èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åƒé“¾è¡¨ä¸€æ ·éå†æ•´ä¸ªæ ‘ä¸­çš„å…¨éƒ¨æ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¼•å…¥åŒå‘é“¾è¡¨ä¿è¯å€’åºéå†æ—¶çš„æ€§èƒ½ã€‚\næˆ‘çš„ç†è§£ï¼šå› ä¸º B+ æ ‘æŠŠæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨äº†å¶èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¶èŠ‚ç‚¹å…¨éƒ¨è¿æ¥èµ·æ¥å½¢æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥åœ¨èŒƒå›´æŸ¥æ‰¾æ—¶ç‰¹åˆ«é«˜æ•ˆï¼Œåªéœ€è¦é€šè¿‡æŒ‡é’ˆå‰åç§»åŠ¨å³å¯ï¼Œè¿™ä¹Ÿæ˜¯å…¶ç›¸å¯¹äº B æ ‘è€Œè¨€æœ€å¤§çš„ä¼˜åŠ¿ï¼Œä¸å†éœ€è¦åƒ B æ ‘é‚£æ ·è¿›è¡Œå›æº¯æ“ä½œäº†ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¦æŸ¥æ‰¾ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®ï¼Œéœ€è¦åœ¨å¶èŠ‚ç‚¹å’Œæ ¹èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨ï¼‰ã€‚\n** è¡¥å……ä¸€ç‚¹ï¼š** B+ æ ‘æ›´é€‚åˆå¤–éƒ¨å­˜å‚¨ã€‚ç”±äºå†…èŠ‚ç‚¹æ—  data åŸŸï¼Œæ¯ä¸ªèŠ‚ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®\nè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œç”±äº B- æ ‘èŠ‚ç‚¹å†…éƒ¨æ¯ä¸ª key éƒ½å¸¦ç€ data åŸŸï¼Œè€Œ B+ æ ‘èŠ‚ç‚¹åªå­˜å‚¨ key çš„å‰¯æœ¬ï¼ŒçœŸå®çš„ key å’Œ data åŸŸéƒ½åœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨ã€‚å‰é¢è¯´è¿‡ç£ç›˜æ˜¯åˆ† block çš„ï¼Œä¸€æ¬¡ç£ç›˜ IO ä¼šè¯»å–è‹¥å¹²ä¸ª blockï¼Œå…·ä½“å’Œæ“ä½œç³»ç»Ÿæœ‰å…³ï¼Œé‚£ä¹ˆç”±äºç£ç›˜ IO æ•°æ®å¤§å°æ˜¯å›ºå®šçš„ï¼Œåœ¨ä¸€æ¬¡ IO ä¸­ï¼Œå•ä¸ªå…ƒç´ è¶Šå°ï¼Œé‡å°±è¶Šå¤§ã€‚è¿™å°±æ„å‘³ç€ B+ æ ‘å•æ¬¡ç£ç›˜ IO çš„ä¿¡æ¯é‡å¤§äº B- æ ‘ï¼Œä»è¿™ç‚¹æ¥çœ‹ B+ æ ‘ç›¸å¯¹ B- æ ‘ç£ç›˜ IO æ¬¡æ•°å°‘ã€‚\næ€»ç»“ æ¥æºï¼šhttps://leetcode-cn.com/circle/discuss/F7bKlM/\n1. B+ æ ‘å’Œ B æ ‘çš„åŒºåˆ«ï¼Ÿ B æ ‘éå¶å­ç»“ç‚¹å’Œå¶å­ç»“ç‚¹éƒ½å­˜å‚¨æ•°æ®,å› æ­¤æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦æœ€å¥½ä¸º O(1)ï¼Œæœ€åä¸º O(log n)ã€‚ B+ æ ‘åªåœ¨å¶å­ç»“ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­ç»“ç‚¹å­˜å‚¨å…³é”®å­—ï¼Œä¸”ä¸åŒéå¶å­ç»“ç‚¹çš„å…³é”®å­—å¯èƒ½é‡å¤ï¼Œå› æ­¤æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦å›ºå®šä¸º O(log n)ã€‚\nB+ æ ‘å¶å­ç»“ç‚¹ä¹‹é—´ç”¨é“¾è¡¨ç›¸äº’è¿æ¥ï¼Œå› è€Œåªéœ€æ‰«æå¶å­ç»“ç‚¹çš„é“¾è¡¨å°±å¯ä»¥å®Œæˆä¸€æ¬¡éå†æ“ä½œï¼ŒBæ ‘åªèƒ½é€šè¿‡ä¸­åºéå†ã€‚\n2. ä¸ºä»€ä¹ˆ B+ æ ‘æ¯” B æ ‘æ›´é€‚åˆåº”ç”¨äºæ•°æ®åº“ç´¢å¼•ï¼Ÿ B+ æ ‘æ›´åŠ é€‚åº”ç£ç›˜çš„ç‰¹æ€§ï¼Œç›¸æ¯” B æ ‘å‡å°‘äº† I/O è¯»å†™çš„æ¬¡æ•°ã€‚ç”±äºç´¢å¼•æ–‡ä»¶å¾ˆå¤§å› æ­¤ç´¢å¼•æ–‡ä»¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ŒB+ æ ‘çš„éå¶å­ç»“ç‚¹åªå­˜å…³é”®å­—ä¸å­˜æ•°æ®ï¼Œå› è€Œå•ä¸ªé¡µå¯ä»¥å­˜å‚¨æ›´å¤šçš„å…³é”®å­—ï¼Œå³ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜çš„éœ€è¦æŸ¥æ‰¾çš„å…³é”®å­—ä¹Ÿå°±è¶Šå¤šï¼Œç£ç›˜çš„éšæœº I/O è¯»å–æ¬¡æ•°ç›¸å¯¹å°±å‡å°‘äº†ã€‚\nB+ æ ‘çš„æŸ¥è¯¢æ•ˆç‡ç›¸æ¯” Bæ ‘ æ›´åŠ ç¨³å®šï¼Œç”±äºæ•°æ®åªå­˜åœ¨åœ¨å¶å­ç»“ç‚¹ä¸Šï¼Œæ‰€ä»¥æŸ¥æ‰¾æ•ˆç‡å›ºå®šä¸º O(log n)ã€‚\nB+ æ ‘å¶å­ç»“ç‚¹ä¹‹é—´ç”¨é“¾è¡¨æœ‰åºè¿æ¥ï¼Œæ‰€ä»¥æ‰«æå…¨éƒ¨æ•°æ®åªéœ€æ‰«æä¸€éå¶å­ç»“ç‚¹ï¼Œåˆ©äºæ‰«åº“å’ŒèŒƒå›´æŸ¥è¯¢ï¼›B æ ‘ç”±äºéå¶å­ç»“ç‚¹ä¹Ÿå­˜æ•°æ®ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ä¸­åºéå†æŒ‰åºæ¥æ‰«ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºèŒƒå›´æŸ¥è¯¢å’Œæœ‰åºéå†è€Œè¨€ï¼ŒB+ æ ‘çš„æ•ˆç‡æ›´é«˜ã€‚\nå¼•ç”³ ä¸ºä»€ä¹ˆä¸ä½¿ç”¨äºŒå‰æœç´¢æ ‘ï¼Ÿ æ ‘å¯ä»¥æœ‰äºŒå‰ï¼Œä¹Ÿå¯ä»¥æœ‰å¤šå‰ã€‚å¤šå‰æ ‘å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹æœ‰å¤šä¸ªå„¿å­ï¼Œå„¿å­ä¹‹é—´çš„å¤§å°ä¿è¯ä»å·¦åˆ°å³é€’å¢ã€‚äºŒå‰æ ‘æ˜¯æœç´¢æ•ˆç‡æœ€é«˜çš„ï¼Œä½†æ˜¯å®é™…ä¸Šå¤§å¤šæ•°çš„æ•°æ®åº“å­˜å‚¨å´å¹¶ä¸ä½¿ç”¨äºŒå‰æ ‘ã€‚å…¶åŸå› æ˜¯ï¼Œç´¢å¼•ä¸æ­¢å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿˜è¦å†™åˆ°ç£ç›˜ä¸Šã€‚\nä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€æ£µ100ä¸‡èŠ‚ç‚¹çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œæ ‘é«˜20ï¼ˆ2^20 = 1048576ï¼‰ã€‚ä¸€æ¬¡æŸ¥è¯¢å¯èƒ½éœ€è¦è®¿é—®20ä¸ªæ•°æ®å—ã€‚åœ¨æœºæ¢°ç¡¬ç›˜æ—¶ä»£ï¼Œä»ç£ç›˜éšæœºè¯»ä¸€ä¸ªæ•°æ®å—éœ€è¦10 mså·¦å³çš„å¯»å€æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ª100ä¸‡è¡Œçš„è¡¨ï¼Œå¦‚æœä½¿ç”¨äºŒå‰æ ‘æ¥å­˜å‚¨ï¼Œå•ç‹¬è®¿é—®ä¸€ä¸ªè¡Œå¯èƒ½éœ€è¦20ä¸ª10 msçš„æ—¶é—´ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯çœŸå¤Ÿæ…¢çš„ã€‚\nä¸ºäº†è®©ä¸€ä¸ªæŸ¥è¯¢å°½é‡å°‘åœ°è¯»ç£ç›˜ï¼Œå°±å¿…é¡»è®©æŸ¥è¯¢è¿‡ç¨‹è®¿é—®å°½é‡å°‘çš„æ•°æ®å—ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸åº”è¯¥ä½¿ç”¨äºŒå‰æ ‘ï¼Œè€Œæ˜¯è¦ä½¿ç”¨â€œNå‰â€æ ‘ã€‚è¿™é‡Œï¼Œâ€œNå‰â€æ ‘ä¸­çš„â€œNâ€å–å†³äºæ•°æ®å—çš„å¤§å°ã€‚\n","date":"2021å¹´09æœˆ11æ—¥","permalink":"/posts/mysql-wei-shi-me-shi-yong-b-shu/","summary":"B æ ‘å’Œ B+ æ ‘çš„åŒºåˆ« æ¥æºï¼šhttps://draveness.me/whys-the-design-mysql-b-plus-tree/","title":"MySQL ä¸ºä»€ä¹ˆä½¿ç”¨ B+ æ ‘"},{"contents":"æ¥æºäºå®˜æ–¹æ–‡æ¡£ï¼ˆhttps://grpc.io/docs/languages/cpp/quickstart/ï¼‰ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€äº›å‘ï¼Œç‰¹æ­¤è®°å½•ï¼Œç³»ç»Ÿä¸º macOS 11.0.1 (20B29)ï¼š\n1. è®¾ç½®ç›®å½•ï¼ˆå¾ˆé‡è¦ï¼Œå¿…é¡»æ‰§è¡Œè¯¥æ­¥éª¤ï¼‰ é€‰æ‹©ä¸€ä¸ªç›®å½•æ¥ä¿å­˜æœ¬åœ°å®‰è£…çš„è½¯ä»¶åŒ…ã€‚æ­¤é¡µé¢å‡å®šç¯å¢ƒå˜é‡MY_INSTALL_DIRåŒ…å«æ­¤ç›®å½•è·¯å¾„ã€‚ä¾‹å¦‚ï¼š\nexport MY_INSTALL_DIR=$HOME/.local mkdir -p $MY_INSTALL_DIR export PATH=\u0026quot;$MY_INSTALL_DIR/bin:$PATH\u0026quot; è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç…§ç€æ–‡æ¡£åšå°±å¥½ã€‚\n2. å®‰è£… cmake brew install cmake 3. å®‰è£…æ„å»º gRPC æ‰€éœ€çš„åŸºæœ¬å·¥å…· brew install autoconf automake libtool pkg-config 4. ä» GitHub ä¸Š clone gRPC æºç  git clone --recurse-submodules -b v1.38.0 https://github.com/grpc/grpc 5. æ„å»ºå’Œå®‰è£… gRPCã€Protocol Buffers å’Œ Abseil ä»¥ä¸‹æ¥è‡ªå®˜æ–¹ï¼Œä½†æ˜¯éœ€è¦ä¿®æ”¹ä¸€äº›å†…å®¹ï¼š\n$ cd grpc $ mkdir -p cmake/build $ pushd cmake/build $ cmake -DgRPC_INSTALL=ON \\ -DgRPC_BUILD_TESTS=OFF \\ -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \\ ../.. $ make -j $ make install $ popd $ mkdir -p third_party/abseil-cpp/cmake/build $ pushd third_party/abseil-cpp/cmake/build $ cmake -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \\ -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE \\ ../.. $ make -j $ make install $ popd è¿™ä¸€æ­¥é‡åˆ°çš„é—®é¢˜æ¯”è¾ƒå¤šã€‚ é—®é¢˜ 1ï¼š æ‰§è¡Œç¬¬ä¸€ä¸ª make install åäº§ç”Ÿå¦‚ä¸‹é”™è¯¯ï¼š\n-- Install configuration: \u0026quot;\u0026quot; CMake Error at cmake_install.cmake:41 (file): file cannot create directory: /lib. Maybe need administrative privileges. åœ¨ç½‘ä¸ŠæŸ¥äº†ä¸‹ï¼Œæ˜¯å› ä¸º macOS ä» big sur å¼€å§‹å°±ä¸å…è®¸å¯¹æ ¹ç›®å½•è¿›è¡Œè¯»å†™æ“ä½œäº†ï¼Œä¸€å¼€å§‹è¿˜ä»¥ä¸ºè¦è§£å†³æ ¹ç›®å½•çš„è¯»å†™é—®é¢˜ï¼Œåæ¥åœ¨ GitHub ä¸Šæ‰¾åˆ°äº†å¯¹åº”çš„ issuesï¼ˆhttps://github.com/grpc/grpc/issues/24660ï¼‰ï¼Œè§£å†³æ–¹æ³•æ˜¯æ‰§è¡Œä¸Šè¿°æ–‡ç« ä¸€å¼€å§‹çš„ç¬¬ä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ç›®å½•ã€‚ï¼ˆè¿˜å¥½æ²¡æŠ˜è…¾ç³»ç»Ÿï¼‰\né—®é¢˜ 2: make -j ç”µè„‘ç›´æ¥å¡æ­» è¿˜æ²¡æ‰¾åˆ°åŸå› ï¼Œä¸è¿‡æ‰¾åˆ°äº†è§£å†³æ–¹æ³•ï¼šmake -j 4 ï¼Œå³åœ¨ j çš„åé¢æŒ‡å®šä¸€ä¸ªæ•°å­—å³å¯ï¼Œè¿™ä¸ªæ•°å­—è²Œä¼¼ä»£è¡¨çš„æ„æ€æ˜¯å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å‘çš„è¿›è¡Œç¼–è¯‘ã€‚ï¼ˆéš¾é“ä¸åŠ æ•°å­—çš„è¯é»˜è®¤å¼€å¯æœ€å¤§çº¿ç¨‹ï¼Ÿï¼‰\né—®é¢˜ 3ï¼š æ‰§è¡Œç¬¬äºŒä¸ª make install åäº§ç”Ÿå¦‚ä¸‹é”™è¯¯ï¼š\n3 warnings and 9 errors generated. make[2]: *** [absl/base/CMakeFiles/log_severity.dir/log_severity.cc.o] Error 1 make[1]: *** [absl/base/CMakeFiles/log_severity.dir/all] Error 2 15 warnings and 20 errors generated. 15 warnings and 20 errors generated. make[2]: *** [absl/time/CMakeFiles/civil_time.dir/internal/cctz/src/civil_time_detail.cc.o] Error 1 make[2]: *** [absl/time/CMakeFiles/time_zone.dir/internal/cctz/src/time_zone_format.cc.o] Error 1 make[1]: *** [absl/time/CMakeFiles/civil_time.dir/all] Error 2 15 warnings and 20 errors generated. 15 warnings and 20 errors generated. 15 warnings and 20 errors generated. make[2]: *** [absl/time/CMakeFiles/time_zone.dir/internal/cctz/src/time_zone_if.cc.o] Error 1 make[2]: *** [absl/time/CMakeFiles/time_zone.dir/internal/cctz/src/time_zone_lookup.cc.o] Error 1 make[2]: *** [absl/time/CMakeFiles/time_zone.dir/internal/cctz/src/time_zone_info.cc.o] Error 1 15 warnings and 20 errors generated. make[2]: *** [absl/time/CMakeFiles/time_zone.dir/internal/cctz/src/time_zone_impl.cc.o] Error 1 make[1]: *** [absl/time/CMakeFiles/time_zone.dir/all] Error 2 make: *** [all] Error 2 æ€»è€Œè¨€ä¹‹å°±æ˜¯ç¼–è¯‘å¤±è´¥ï¼Œè§£å†³æ–¹æ³•æ˜¯ï¼š å°†ç¬¬äºŒä¸ª cmake æ›¿æ¢ä¸ºå¦‚ä¸‹è¯­å¥ï¼Œå°±æ˜¯å¤šåŠ äº†ä¸€è¡Œ -DCMAKE_CXX_STANDARD=11 ï¼ŒæŒ‡å®šä½¿ç”¨ c++ 11 è¿›è¡Œç¼–è¯‘ã€‚\ncmake -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \\ -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE \\ -DCMAKE_CXX_STANDARD=11 \\ ../.. è®°å¾—å¦‚æœä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ cmakeï¼Œåˆ™éœ€è¦å…ˆæ¸…é™¤ï¼ˆrm -rf third_party/abseil-cpp/cmake/buildï¼Œå†æ‰§è¡Œ mkdir -p third_party/abseil-cpp/cmake/buildï¼‰ï¼Œå†é‡æ–°æ‰§è¡Œä¸Šé¢çš„ cmake è¯­å¥ã€‚ä¹‹åå°±å¯ä»¥æ­£ç¡®çš„ make install äº†ã€‚\nä¹‹åå°±å¯ä»¥æ„‰å¿«çš„å¼€å§‹æ„å»ºç¤ºä¾‹äº†ï¼š\ncd examples/cpp/helloworld mkdir -p cmake/build pushd cmake/build cmake -DCMAKE_PREFIX_PATH=$MY_INSTALL_DIR ../.. make -j æ„å»ºå®Œæˆåï¼Œè¿è¡ŒæœåŠ¡ç«¯ï¼š\n# è¿è¡ŒæœåŠ¡å™¨ï¼š ./greeter_server æ–°åˆ›å»ºä¸€ä¸ªç»ˆç«¯ï¼š\n./greeter_client è¾“å‡ºï¼š\nGreeter received: Hello world ","date":"2021å¹´08æœˆ31æ—¥","permalink":"/posts/mac-xia-gou-jian-ji-yu-c-de-grpc/","summary":"æ¥æºäºå®˜æ–¹æ–‡æ¡£ï¼ˆhttps://grpc.io/docs/languages/cpp/quickstart/ï¼‰ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€äº›å‘ï¼Œç‰¹æ­¤è®°å½•ï¼Œç³»ç»Ÿä¸º macOS 11.0.1 (20B29)ï¼š\n1. è®¾ç½®ç›®å½•ï¼ˆå¾ˆé‡è¦ï¼Œå¿…é¡»æ‰§è¡Œè¯¥æ­¥éª¤ï¼‰ é€‰æ‹©ä¸€ä¸ªç›®å½•æ¥ä¿å­˜æœ¬åœ°å®‰è£…çš„è½¯ä»¶åŒ…ã€‚æ­¤é¡µé¢å‡å®šç¯å¢ƒå˜é‡MY_INSTALL_DIRåŒ…å«æ­¤ç›®å½•è·¯å¾„ã€‚ä¾‹å¦‚ï¼š","title":"Mac ä¸‹æ„å»ºåŸºäº C++ çš„ gRPC"},{"contents":"è¡¨é” è¯­æ³•ï¼š\nåŠ é”ï¼š\nåŠ è¯»é” LOCK TABLES [tablename] READ;\nåŠ å†™é” LOCK TABLES [tablename] WRITE;\né‡Šæ”¾é”ï¼š UNLOCK TABLES;\nåŠ é”åä¼šé˜»å¡å…¶ä»–çº¿ç¨‹çš„éƒ¨åˆ†æ“ä½œï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¹åŠ é”çº¿ç¨‹è¿›è¡Œä¸€äº›é™åˆ¶ï¼Œç›´åˆ°åŠ é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚\nè¯»é”å’Œå†™é”çš„åŒºåˆ«ï¼š å½“åŠ  è¯»é” åï¼Œå…¶ä»–çº¿ç¨‹çš„ SELECT è¯­å¥ä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯ INSERTã€UPDATEã€DELETE è¿™äº›å†™è¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚æ­¤å¤–ï¼ŒåŠ é”çº¿ç¨‹åªèƒ½æ‰§è¡Œè¯»è¯­å¥ï¼Œä¸èƒ½æ‰§è¡Œå†™è¯­å¥ï¼Œ å¦åˆ™ä¼šäº§ç”Ÿé”™è¯¯ Table 'sort_demo' was locked with a READ lock and can't be updatedã€‚\nå½“åŠ  å†™é” åï¼Œå…¶ä»–çº¿ç¨‹çš„è¯»å†™è¯­å¥éƒ½ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯åŠ é”çº¿ç¨‹çš„è¯»å†™è¯­å¥éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚\nå¯ä»¥ç”¨ unlock tables ä¸»åŠ¨é‡Šæ”¾é”ï¼Œä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æ–­å¼€çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾ã€‚\nåœ¨è¿˜æ²¡æœ‰å‡ºç°æ›´ç»†ç²’åº¦çš„é”çš„æ—¶å€™ï¼Œè¡¨é”æ˜¯æœ€å¸¸ç”¨çš„å¤„ç†å¹¶å‘çš„æ–¹å¼ã€‚è€Œå¯¹äº InnoDB è¿™ç§æ”¯æŒè¡Œé”çš„å¼•æ“ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨ lock tables å‘½ä»¤æ¥æ§åˆ¶å¹¶å‘ï¼Œæ¯•ç«Ÿé”ä½æ•´ä¸ªè¡¨çš„å½±å“é¢è¿˜æ˜¯å¤ªå¤§ã€‚\nMDL é”ï¼ˆå…ƒæ•°æ®é”ï¼‰ MDL ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚MDL çš„ä½œç”¨æ˜¯ï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢æ­£åœ¨éå†ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè€Œæ‰§è¡ŒæœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšå˜æ›´ï¼Œåˆ äº†ä¸€åˆ—ï¼Œé‚£ä¹ˆæŸ¥è¯¢çº¿ç¨‹æ‹¿åˆ°çš„ç»“æœè·Ÿè¡¨ç»“æ„å¯¹ä¸ä¸Šï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚\nå› æ­¤ï¼Œåœ¨ MySQL 5.5 ç‰ˆæœ¬ä¸­å¼•å…¥äº† MDLï¼Œå½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ  MDL è¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ  MDL å†™é”ã€‚\nè¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œå› æ­¤ä½ å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€å¼ è¡¨å¢åˆ æ”¹æŸ¥ã€‚\nè¯»å†™é”ä¹‹é—´ã€å†™é”ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œç”¨æ¥ä¿è¯å˜æ›´è¡¨ç»“æ„æ“ä½œçš„å®‰å…¨æ€§ã€‚å› æ­¤ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹è¦åŒæ—¶ç»™ä¸€ä¸ªè¡¨åŠ å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªè¦ç­‰å¦ä¸€ä¸ªæ‰§è¡Œå®Œæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚\nè™½ç„¶ MDL é”æ˜¯ç³»ç»Ÿé»˜è®¤ä¼šåŠ çš„ï¼Œä½†å´æ˜¯ä½ ä¸èƒ½å¿½ç•¥çš„ä¸€ä¸ªæœºåˆ¶ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ç»å¸¸çœ‹åˆ°æœ‰äººæ‰åˆ°è¿™ä¸ªå‘é‡Œï¼šç»™ä¸€ä¸ªå°è¡¨åŠ ä¸ªå­—æ®µï¼Œå¯¼è‡´æ•´ä¸ªåº“æŒ‚äº†ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ° session A å…ˆå¯åŠ¨ï¼Œè¿™æ—¶å€™ä¼šå¯¹è¡¨ t åŠ ä¸€ä¸ª MDL è¯»é”ã€‚ç”±äº session B éœ€è¦çš„ä¹Ÿæ˜¯MDL è¯»é”ï¼Œå› æ­¤å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚\nä¹‹å session C ä¼šè¢«blockedï¼Œæ˜¯å› ä¸º session A çš„ MDL è¯»é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œè€Œ session C éœ€è¦MDL å†™é”ï¼Œå› æ­¤åªèƒ½è¢«é˜»å¡ã€‚\nå¦‚æœåªæœ‰ session C è‡ªå·±è¢«é˜»å¡è¿˜æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä½†æ˜¯ä¹‹åæ‰€æœ‰è¦åœ¨è¡¨tä¸Šæ–°ç”³è¯·MDLè¯»é”çš„è¯·æ±‚ä¹Ÿä¼šè¢« session C é˜»å¡ã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œæ‰€æœ‰å¯¹è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½éœ€è¦å…ˆç”³è¯· MDL è¯»é”ï¼Œå°±éƒ½è¢«é”ä½ï¼Œç­‰äºè¿™ä¸ªè¡¨ç°åœ¨å®Œå…¨ä¸å¯è¯»å†™äº†ã€‚\nå¦‚æœæŸä¸ªè¡¨ä¸Šçš„æŸ¥è¯¢è¯­å¥é¢‘ç¹ï¼Œè€Œä¸”å®¢æˆ·ç«¯æœ‰é‡è¯•æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¶…æ—¶åä¼šå†èµ·ä¸€ä¸ªæ–° session å†è¯·æ±‚çš„è¯ï¼Œè¿™ä¸ªåº“çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚\nä½ ç°åœ¨åº”è¯¥çŸ¥é“äº†ï¼Œäº‹åŠ¡ä¸­çš„ MDL é”ï¼Œåœ¨è¯­å¥æ‰§è¡Œå¼€å§‹æ—¶ç”³è¯·ï¼Œä½†æ˜¯è¯­å¥ç»“æŸåå¹¶ä¸ä¼šé©¬ä¸Šé‡Šæ”¾ï¼Œè€Œä¼šç­‰åˆ°æ•´ä¸ªäº‹åŠ¡æäº¤åå†é‡Šæ”¾ã€‚\nåˆ’é‡ç‚¹ï¼šä¸€æ—¦å‡ºç°å†™é”ç­‰å¾…ï¼Œä¸ä½†å½“å‰æ“ä½œä¼šè¢«é˜»å¡ï¼ŒåŒæ—¶è¿˜ä¼šé˜»å¡åç»­è¯¥è¡¨çš„æ‰€æœ‰æ“ä½œã€‚äº‹åŠ¡ä¸€æ—¦ç”³è¯· åˆ° MDL é”åï¼Œç›´åˆ°äº‹åŠ¡æ‰§è¡Œå®Œæ‰ä¼šå°†é”é‡Šæ”¾ã€‚\nåŸºäºä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•å®‰å…¨åœ°ç»™å°è¡¨åŠ å­—æ®µï¼Ÿ\né¦–å…ˆæˆ‘ä»¬è¦è§£å†³é•¿äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸æäº¤ï¼Œå°±ä¼šä¸€ç›´å ç€ MDL é”ã€‚åœ¨ MySQL çš„ information_schema åº“çš„ innodb_trx è¡¨ä¸­ï¼Œä½ å¯ä»¥æŸ¥åˆ°å½“å‰æ‰§è¡Œä¸­çš„äº‹åŠ¡ã€‚å¦‚æœä½ è¦åš DDL å˜æ›´çš„è¡¨åˆšå¥½æœ‰é•¿äº‹åŠ¡åœ¨æ‰§è¡Œï¼Œè¦è€ƒè™‘å…ˆæš‚åœ DDLï¼Œæˆ–è€… kill æ‰è¿™ä¸ªé•¿äº‹åŠ¡ã€‚\nä½†è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ã€‚å¦‚æœä½ è¦å˜æ›´çš„è¡¨æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¡¨ï¼Œè™½ç„¶æ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯ä¸Šé¢çš„è¯·æ±‚å¾ˆé¢‘ç¹ï¼Œè€Œä½ ä¸å¾—ä¸åŠ ä¸ªå­—æ®µï¼Œä½ è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\nè¿™æ—¶å€™ kill å¯èƒ½æœªå¿…ç®¡ç”¨ï¼Œå› ä¸ºæ–°çš„è¯·æ±‚é©¬ä¸Šå°±æ¥äº†ã€‚æ¯”è¾ƒç†æƒ³çš„æœºåˆ¶æ˜¯ï¼Œåœ¨ alter table è¯­å¥é‡Œé¢è®¾å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸ªæŒ‡å®šçš„ç­‰å¾…æ—¶é—´é‡Œé¢èƒ½å¤Ÿæ‹¿åˆ° MDLå†™é” æœ€å¥½ï¼Œæ‹¿ä¸åˆ°ä¹Ÿä¸è¦é˜»å¡åé¢çš„ä¸šåŠ¡è¯­å¥ï¼Œå…ˆæ”¾å¼ƒã€‚ä¹‹åå¼€å‘äººå‘˜æˆ–è€… DBA å†é€šè¿‡é‡è¯•å‘½ä»¤é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚\nMariaDB å·²ç»åˆå¹¶äº† AliSQL çš„è¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå¼€æºåˆ†æ”¯ç›®å‰éƒ½æ”¯æŒ DDL NOWAIT/WAIT n è¿™ä¸ªè¯­æ³•ã€‚\nALTER TABLE tbl_name NOWAIT add column ... ALTER TABLE tbl_name WAIT N add column ... 2. å…¨å±€é” é¡¾åæ€ä¹‰ï¼Œå…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ã€‚MySQL æä¾›äº†ä¸€ä¸ªåŠ å…¨å±€è¯»é”çš„æ–¹æ³•ï¼Œå‘½ä»¤æ˜¯ Flush tables with read lock (FTWRL)ã€‚å½“ä½ éœ€è¦è®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä¹‹åå…¶ä»–çº¿ç¨‹çš„ä»¥ä¸‹è¯­å¥ä¼šè¢«é˜»å¡ï¼šæ•°æ®æ›´æ–°è¯­å¥ï¼ˆæ•°æ®çš„å¢åˆ æ”¹ï¼‰ã€æ•°æ®å®šä¹‰è¯­å¥ï¼ˆåŒ…æ‹¬å»ºè¡¨ã€ä¿®æ”¹è¡¨ç»“æ„ç­‰ï¼‰ å’Œæ›´æ–°ç±»äº‹åŠ¡çš„æäº¤è¯­å¥ã€‚\nå…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œåšå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•´åº“æ¯ä¸ªè¡¨éƒ½ select å‡ºæ¥å­˜æˆæ–‡æœ¬ã€‚\næ‚²è§‚é” ä¹è§‚é” ç”¨æ•°æ®ç‰ˆæœ¬ï¼ˆVersionï¼‰è®°å½•æœºåˆ¶å®ç°ï¼Œè¿™æ˜¯ä¹è§‚é”æœ€å¸¸ç”¨çš„ä¸€ç§å®ç°æ–¹å¼ã€‚ä½•è°“æ•°æ®ç‰ˆæœ¬ï¼Ÿå³ä¸ºæ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬æ ‡è¯†ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ä¸ºæ•°æ®åº“è¡¨å¢åŠ ä¸€ä¸ªæ•°å­—ç±»å‹çš„ â€œversionâ€ å­—æ®µæ¥å®ç°ã€‚å½“è¯»å–æ•°æ®æ—¶ï¼Œå°†version å­—æ®µçš„å€¼ä¸€åŒè¯»å‡ºï¼Œæ•°æ®æ¯æ›´æ–°ä¸€æ¬¡ï¼Œå¯¹æ­¤versionå€¼åŠ  1ã€‚å½“æˆ‘ä»¬æäº¤æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬ä¿¡æ¯ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„versionå€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ•°æ®åº“è¡¨å½“å‰ç‰ˆæœ¬å·ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„versionå€¼ç›¸ç­‰ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚\nä¸¾ä¾‹\n1ã€æ•°æ®åº“è¡¨è®¾è®¡\nä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯id, value, version\nselect id,value,version from TABLE where id=#{id} 2ã€æ¯æ¬¡æ›´æ–°è¡¨ä¸­çš„valueå­—æ®µæ—¶ï¼Œä¸ºäº†é˜²æ­¢å‘ç”Ÿå†²çªï¼Œéœ€è¦è¿™æ ·æ“ä½œ\nupdate TABLE set value=2,version=version+1 where id=#{id} and version=#{version}; ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æœ‰ä¸‹é¢ä¸¤ä¸ªäº‹åŠ¡ï¼š\nA B select id,value,version from TABLE where id=1ï¼Œç»“æœï¼šversion = 1 select id,value,version from TABLE where id=1ï¼Œç»“æœï¼šversion=1 æ‹¿ä¸Šé¢æŸ¥è¯¢å‡ºæ¥çš„ version è¿›è¡Œæ›´æ–°ï¼Œupdate set version=version+1 where version=1ï¼Œç»“æœï¼šversion = 2 update set version=version+1 where version=1ï¼Œæ­¤æ—¶versionå·²ç»è¢« A æ›´æ–°æˆäº† 2ï¼Œæ‰€ä»¥è¿™æ¡ sql è¯­å¥ä¸ä¼šæ‰§è¡ŒæˆåŠŸï¼Œä»è€Œé¿å…æ—§æ•°æ®è¦†ç›–æ–°æ•°æ® æ­»é” è¿™æ—¶å€™ï¼Œäº‹åŠ¡Aåœ¨ç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾id=2çš„è¡Œé”ï¼Œè€Œäº‹åŠ¡Båœ¨ç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾id=1çš„è¡Œé”ã€‚ äº‹åŠ¡Aå’Œäº‹åŠ¡Båœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„èµ„æºé‡Šæ”¾ï¼Œå°±æ˜¯è¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚\nfor update åŠ è¡Œé”è¿˜æ˜¯è¡¨é”ï¼Ÿ å®éªŒï¼š æœ‰å¦‚ä¸‹è¡¨ï¼š\ncreate for_update_is_lock_row_or_lock_table( id int primary key auto_increment, d int, c int, key(c)c ); insert into for_update_is_lock_row_or_lock_table(d, c) values(1, 1) insert into for_update_is_lock_row_or_lock_table(d, c) values(2, 2) insert into for_update_is_lock_row_or_lock_table(d, c) values(3, 3) å®éªŒ 1 ä½¿ç”¨ç´¢å¼•åˆ—ä½œä¸ºæ¡ä»¶æŸ¥è¯¢ äº‹åŠ¡1ï¼š\nupdate for_update_is_lock_row_or_lock_table set d=11 where c= 1; äº‹åŠ¡2ï¼š æ›´æ–°åŒä¸€åˆ—æ•°æ®\nupdate for_update_is_lock_row_or_lock_table set d=1 where c= 1; ä¸Šé¢çš„è¯­å¥è¢«è¢«é˜»å¡\nupdate for_update_is_lock_row_or_lock_table set d=22 where c= 2; ä½†æ˜¯è¿™æ¡è¯­å¥ä¸ä¼šè¢«é˜»å¡ï¼Œè¯´æ˜æ­¤æ—¶åŠ çš„æ˜¯è¡Œé”\nå®éªŒ2 ä½¿ç”¨éç´¢å¼•åˆ—ä½œä¸ºæ¡ä»¶æŸ¥è¯¢ äº‹åŠ¡1ï¼š\nupdate for_update_is_lock_row_or_lock_table set c=11 where d= 1; äº‹åŠ¡2:\nupdate for_update_is_lock_row_or_lock_table set c=22 where d=2; è¢«é˜»å¡ï¼Œæ­¤æ—¶ä¸æ˜¯åŒä¸€è¡Œä½†å´è¢«é˜»å¡ï¼Œè¯´æ˜æ­¤æ—¶åŠ çš„æ˜¯è¡¨é”\nç»“è®º å¦‚æœæŸ¥è¯¢æ¡ä»¶ç”¨äº†ç´¢å¼•/ä¸»é”®ï¼Œé‚£ä¹ˆselect \u0026hellip;.. for updateå°±ä¼šè¿›è¡Œè¡Œé”ã€‚\nå¦‚æœæ˜¯æ™®é€šå­—æ®µ(æ²¡æœ‰ç´¢å¼•/ä¸»é”®)ï¼Œé‚£ä¹ˆselect \u0026hellip;.. for updateå°±ä¼šè¿›è¡Œé”è¡¨ã€‚\n","date":"2021å¹´08æœˆ29æ—¥","permalink":"/posts/mysql-suo/","summary":"è¡¨é” è¯­æ³•ï¼š\nåŠ é”ï¼š\nåŠ è¯»é” LOCK TABLES [tablename] READ;","title":"MySQL é”"},{"contents":"1. æœªæäº¤è¯»ï¼ˆè„è¯»ï¼‰ äº‹åŠ¡çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚äº‹åŠ¡å¯ä»¥è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œç§°ä¹‹ä¸º è„è¯»ã€‚å®ƒå­˜åœ¨ 4 ä¸ªå¸¸è§é—®é¢˜ï¼ˆè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€ä¸¢å¤±æ›´æ–°ï¼‰ã€‚ 2. æäº¤è¯»ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡è¦ç­‰å¦ä¸€ä¸ªäº‹åŠ¡æäº¤åæ‰èƒ½è¯»å–æ•°æ®ã€‚ å®ƒè§£å†³äº†è„è¯»é—®é¢˜ï¼Œå­˜åœ¨ 3 ä¸ªå¸¸è§é—®é¢˜ï¼ˆä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€ä¸¢å¤±æ›´æ–°ï¼‰ã€‚ æ–°çš„é—®é¢˜ï¼šæ›´æ–°ä¸¢å¤±ï¼ˆæäº¤è¦†ç›–ï¼‰ æ–°çš„é—®é¢˜ï¼šä¸å¯é‡å¤è¯» æ–°çš„é—®é¢˜ï¼šå›æ»šä¸¢å¤±ï¼ˆå›æ»šè¦†ç›–ï¼‰ å’Œ æ›´æ–°ä¸¢å¤± ä¸€æ ·ï¼Œæ’¤æ¶ˆä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œåœ¨è¯¥äº‹åŠ¡å†…çš„å†™æ“ä½œè¦å›æ»šï¼ŒæŠŠå…¶å®ƒå·²æäº¤çš„äº‹åŠ¡å†™å…¥çš„æ•°æ®è¦†ç›–äº†ã€‚\n3. å¯é‡å¤è¯» ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚ å°±æ˜¯åœ¨å¼€å§‹è¯»å–æ•°æ®ï¼ˆäº‹åŠ¡å¼€å¯ï¼‰æ—¶ï¼Œä¸å†å…è®¸ä¿®æ”¹æ“ä½œ ã€‚å®ƒè§£å†³äº†è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œè¿˜å­˜åœ¨2ä¸ªå¸¸è§é—®é¢˜ï¼ˆå¹»è¯»ã€ä¸¢å¤±æ›´æ–°ï¼‰ã€‚\nå®ç°åŸç†ï¼š æ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚\né€‚ç”¨åœºæ™¯ï¼š å‡è®¾ä½ åœ¨ç®¡ç†ä¸€ä¸ªä¸ªäººé“¶è¡Œè´¦æˆ·è¡¨ã€‚ä¸€ä¸ªè¡¨å­˜äº†æ¯ä¸ªæœˆæœˆåº•çš„ä½™é¢ï¼Œä¸€ä¸ªè¡¨å­˜äº†è´¦å•æ˜ç»†ã€‚è¿™æ—¶å€™ä½ è¦åšæ•°æ®æ ¡å¯¹ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸Šä¸ªæœˆçš„ä½™é¢å’Œå½“å‰ä½™é¢çš„å·®é¢ï¼Œæ˜¯å¦ä¸æœ¬æœˆçš„è´¦å•æ˜ç»†ä¸€è‡´ã€‚ä½ ä¸€å®šå¸Œæœ›åœ¨æ ¡å¯¹è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç”¨æˆ·å‘ç”Ÿäº†ä¸€ç¬”æ–°çš„äº¤æ˜“ï¼Œä¹Ÿä¸å½±å“ä½ çš„æ ¡å¯¹ç»“æœã€‚\nè¿™æ—¶å€™ä½¿ç”¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«å°±å¾ˆæ–¹ä¾¿ã€‚äº‹åŠ¡å¯åŠ¨æ—¶çš„è§†å›¾å¯ä»¥è®¤ä¸ºæ˜¯é™æ€çš„ï¼Œä¸å—å…¶ä»–äº‹åŠ¡æ›´æ–°çš„å½±å“ã€‚\nTipsï¼š å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„åŒºåˆ« æ‘˜è‡ªç½‘ä¸Šï¼š (1) ä¸å¯é‡å¤è¯» ä¸»è¦æ˜¯è¯´å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•, å‘ç°è¯¥è®°å½•ä¸­æŸäº›åˆ—å€¼è¢«ä¿®æ”¹è¿‡ å¹»è¯» ä¸»è¦æ˜¯è¯´å¤šæ¬¡è¯»å–ä¸€ä¸ªèŒƒå›´å†…çš„è®°å½•(åŒ…æ‹¬ç›´æ¥æŸ¥è¯¢æ‰€æœ‰è®°å½•ç»“æœæˆ–è€…åšèšåˆç»Ÿè®¡), å‘ç°ç»“æœ ä¸ä¸€è‡´(æ ‡å‡†æ¡£æ¡ˆä¸€èˆ¬æŒ‡è®°å½•å¢å¤š, è®°å½•çš„å‡å°‘åº”è¯¥ä¹Ÿç®—æ˜¯å¹»è¯»)ã€‚ (2) å¹»è¯»é—®é¢˜å¯¹åº”çš„æ˜¯æ’å…¥ INSERT æ“ä½œ â€œå¹»è¯»â€æ˜¯æŒ‡è¯»çš„è¿‡ç¨‹ä¸­ï¼ŒæŸäº›å…ƒç»„è¢«å¢åŠ æˆ–åˆ é™¤ï¼Œè¿™æ ·è¿›è¡Œä¸€äº›é›†åˆæ“ä½œï¼Œæ¯”å¦‚ç®—æ€»æ•°ï¼Œå¹³å‡å€¼ç­‰ç­‰ï¼Œå°± ä¼šæ¯æ¬¡ç®—å‡ºä¸ä¸€æ ·çš„æ•°ã€‚æ‰€ä»¥â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€éƒ½æ˜¯è¯»çš„è¿‡ç¨‹ä¸­æ•°æ®å‰åä¸ä¸€è‡´ï¼Œåªæ˜¯å‰è€…ä¾§é‡äºä¿® æ”¹ï¼Œåè€…ä¾§é‡äºå¢åˆ ã€‚ä¸ªäººè®¤ä¸ºï¼Œä¸¥æ ¼æ¥è®²â€œå¹»è¯»â€å¯ä»¥è¢«ç§°ä¸ºâ€œä¸å¯é‡å¤è¯»â€çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œæ²¡é”™çš„ã€‚ä½† æ˜¯ä»æ•°æ®åº“ç®¡ç†çš„è§’åº¦æ¥çœ‹äºŒè€…æ˜¯æœ‰åŒºåˆ«çš„ã€‚è§£å†³â€œä¸å¯é‡å¤è¯»â€åªè¦åŠ è¡Œçº§é”å°±å¯ä»¥äº†ã€‚è€Œè§£å†³â€œå¹»è¯»â€åˆ™ éœ€è¦åŠ è¡¨çº§é”ï¼Œæˆ–è€…é‡‡ç”¨å…¶ä»–æ›´å¤æ‚çš„æŠ€æœ¯ï¼Œæ€»ä¹‹ä»£ä»·è¦å¤§è®¸å¤šã€‚è¿™æ˜¯ææ•°æ®åº“çš„é‚£å¸®å®¶ä¼™éè¦æŠŠè¿™ä¸¤è€… åŒºåˆ†å¼€çš„åŠ¨æœºå§ã€‚\n4. å¯ä¸²è¡ŒåŒ– ä¸²è¡ŒåŒ–ï¼Œé¡¾åæ€ä¹‰æ˜¯å¯¹äºåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚\nä¸²è¡ŒåŒ–æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œä¼šå¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®ƒå°†éš”ç¦»é—®é¢˜å…¨éƒ¨è§£å†³ï¼Œä½†æ˜¯è¿™ç§äº‹åŠ¡éš”ç¦»çº§åˆ«æ•ˆç‡ä½ä¸‹ï¼Œæ¯”è¾ƒè€—æ•°æ®åº“æ€§èƒ½ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨ã€‚ ","date":"2021å¹´08æœˆ27æ—¥","permalink":"/posts/mysql-de-shi-wu-ge-chi-ji-bie/","summary":"1. æœªæäº¤è¯»ï¼ˆè„è¯»ï¼‰ äº‹åŠ¡çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚äº‹åŠ¡å¯ä»¥è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œç§°ä¹‹ä¸º è„è¯»ã€‚å®ƒå­˜åœ¨ 4 ä¸ªå¸¸è§é—®é¢˜ï¼ˆè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€ä¸¢å¤±æ›´æ–°ï¼‰ã€‚ 2.","title":"MySQL çš„äº‹åŠ¡éš”ç¦»çº§åˆ«"},{"contents":"æœ‰ä¸€å¯¹å…”å­ï¼Œä»å‡ºç”Ÿåçš„ç¬¬äº”ä¸ªæœˆèµ·æ¯æœˆç”Ÿå‡ºä¸€å¯¹å°å…”å­ï¼ˆå³æ»¡4æœˆå°±å¼€å§‹ç”Ÿå°å…”ï¼‰ï¼Œå°å…”å­ä¹Ÿä¼šå‡ºç”Ÿä»ç¬¬äº”ä¸ªæœˆèµ·æ¯æœˆç”Ÿä¸€å¯¹å°å…å­ã€‚å‡å¦‚å…”å­ä¸ä¼šæ­»ï¼Œç¬¬nä¸ªæœˆæ—¶ï¼Œå…”ç¾¤æœ‰å¤šå°‘å¯¹å…”å­ã€‚\nè¾“å…¥æè¿°: ç¬¬næœˆï¼ˆnä¸ºè‡ªç„¶æ•°ï¼Œn\u0026lt;101ï¼‰\nè¾“å‡ºæè¿°: ç¬¬ n ä¸ªæœˆæ—¶ï¼Œå…”å­çš„å¯¹æ•°ï¼ˆå…ç¾¤çš„å…”å­æœ‰å¤šå°‘å¯¹å…”å­ï¼‰ã€‚ ç¤ºä¾‹ 1 è¾“å…¥ 5 è¾“å‡º 2 è¯´æ˜ ç¬¬äº”ä¸ªæœˆæ—¶ï¼Œæœ‰ä¸¤å¯¹å…”å­\næ–¹æ³•1 åŠ¨æ€è§„åˆ’ ACM æ¨¡å¼\npackage main import ( \u0026quot;fmt\u0026quot; ) func rabbit(n int) int { dp := make([]int, n) dp[0] = 1 dp[1] = 1 dp[2] = 1 dp[3] = 1 for i := 4; i \u0026lt; n; i++ { dp[i] = dp[i-1] + dp[i-4] } return dp[n-1] } func main() { var input int fmt.Scan(\u0026amp;input) v := rabbit(input) fmt.Println(v) } ","date":"2021å¹´08æœˆ21æ—¥","permalink":"/posts/niu-ke-bi-shi-ti-tu-zi-fan-yan/","summary":"æœ‰ä¸€å¯¹å…”å­ï¼Œä»å‡ºç”Ÿåçš„ç¬¬äº”ä¸ªæœˆèµ·æ¯æœˆç”Ÿå‡ºä¸€å¯¹å°å…”å­ï¼ˆå³æ»¡4æœˆå°±å¼€å§‹ç”Ÿå°å…”ï¼‰ï¼Œå°å…”å­ä¹Ÿä¼šå‡ºç”Ÿä»ç¬¬äº”ä¸ªæœˆèµ·æ¯æœˆç”Ÿä¸€å¯¹å°å…å­ã€‚å‡å¦‚å…”å­ä¸ä¼šæ­»ï¼Œç¬¬nä¸ªæœˆæ—¶ï¼Œå…”ç¾¤æœ‰å¤šå°‘å¯¹å…”å­ã€‚\nè¾“å…¥æè¿°: ç¬¬næœˆï¼ˆnä¸ºè‡ªç„¶æ•°ï¼Œn\u0026lt;101ï¼‰\nè¾“å‡ºæè¿°: ç¬¬ n ä¸ªæœˆæ—¶ï¼Œå…”å­çš„å¯¹æ•°ï¼ˆå…ç¾¤çš„å…”å­æœ‰å¤šå°‘å¯¹å…”å­ï¼‰ã€‚ ç¤ºä¾‹ 1 è¾“å…¥ 5 è¾“å‡º 2 è¯´æ˜ ç¬¬äº”ä¸ªæœˆæ—¶ï¼Œæœ‰ä¸¤å¯¹å…”å­","title":"[ç‰›å®¢][ç¬”è¯•é¢˜] å…”å­ç¹è¡"},{"contents":"types zskiplistNode typedef struct zskiplistNode { sds ele; // æˆå‘˜ double score; // åˆ†å€¼ struct zskiplistNode *backward; // åé€€æŒ‡é’ˆ // å±‚ struct zskiplistLevel { struct zskiplistNode *forward; // å‰è¿›æŒ‡é’ˆ unsigned long span; // è·¨åº¦ } level[]; } zskiplistNode; zskiplist typedef struct zskiplist { struct zskiplistNode *header, *tail; unsigned long length; int level; // å½“å‰è·³è·ƒè¡¨å†…ï¼Œå±‚æ•°æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•° } zskiplist; zset typedef struct zset { dict *dict; zskiplist *zsl; } zset; functions zslCreate /* Create a new skiplist. */ zskiplist *zslCreate(void) { int j; zskiplist *zsl; zsl = zmalloc(sizeof(*zsl)); zsl-\u0026gt;level = 1; // åˆå§‹æœ€é«˜å±‚æ•°ä¸º 1 zsl-\u0026gt;length = 0; // ä¸åŒ…å«ä»»ä½•èŠ‚ç‚¹ // header æŒ‡å‘ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹çš„æœ‰ 32 å±‚ï¼ˆå³ level[] çš„é•¿åº¦ä¸º 32ï¼‰ zsl-\u0026gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL); // ä¸ºå¤´ç»“ç‚¹æ¯å±‚çš„å±æ€§è¿›è¡Œåˆå§‹åŒ– for (j = 0; j \u0026lt; ZSKIPLIST_MAXLEVEL; j++) { zsl-\u0026gt;header-\u0026gt;level[j].forward = NULL; zsl-\u0026gt;header-\u0026gt;level[j].span = 0; } zsl-\u0026gt;header-\u0026gt;backward = NULL; zsl-\u0026gt;tail = NULL; return zsl; } zslInsert å‘ skiplist ä¸­æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ã€‚\n/* Insert a new node in the skiplist. Assumes the element does not already * exist (up to the caller to enforce that). The skiplist takes ownership * of the passed SDS string 'ele'. */ // score: åˆ†æ•° // ele: æˆå‘˜ï¼Œæ˜¯ä¸€ä¸ª sds å­—ç¬¦ä¸²ç±»å‹ zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) { // update ç”¨æ¥ä¿å­˜æ¯å±‚çš„æŸä¸ªèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹æ˜¯å¾…æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š // // head // level[2] ---- 1---------- 6 ----- 10 // level[1] ---- 1 ----- 4 - 6 ----- 10 æ’å…¥ä¸€ä¸ª 7 // level[0] ---- 1 - 2 - 4 - 6 - 8 - 10 // // è¿™é‡Œå…ˆä¸è¯´æ˜æ’å…¥çš„è¯¦ç»†è¿‡ç¨‹ï¼Œåªé€šè¿‡ä¸Šé¢çš„è·³è¡¨å°±å¯ä»¥çŸ¥é“ï¼Œ7 ä¼šè¢«æ’å…¥åˆ° 6 çš„åé¢ï¼Œ // å¹¶ä¸”å‡è®¾ 7 çš„é«˜åº¦ä¸º 3ï¼Œæ­¤æ—¶çš„ update æ•°ç»„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š // // update[2] = 6ï¼Œä»£è¡¨ç¬¬ä¸‰å±‚çš„ 6 æ˜¯å¾…æ’å…¥èŠ‚ç‚¹ 7 çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚ // update[1] = 6, update[0] = 6ï¼ŒåŒç†ã€‚ä¹‹åä¼šéå† update æ•°ç»„ï¼Œå¹¶å°†æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´  // çš„ forward æŒ‡å‘æ–°èŠ‚ç‚¹ã€‚ // // æœ€ç»ˆç»“æœä¸ºï¼š // head // level[2] ---- 1 --------- 6 - 7 ----- 10 // level[1] ---- 1 ----- 4 - 6 - 7 ----- 10 æ’å…¥ä¸€ä¸ª 7 // level[0] ---- 1 - 2 - 4 - 6 - 7 - 8 - 10 zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x; // unsigned int rank[ZSKIPLIST_MAXLEVEL]; int i, level; serverAssert(!isnan(score)); x = zsl-\u0026gt;header; // ä» zsl çš„æœ€é«˜å±‚å¼€å§‹æŸ¥æ‰¾ï¼Œå¹¶ä¸æ–­ä¸‹é™ï¼Œç›´åˆ°æœ€ååˆ°è¾¾ç¬¬ 1 å±‚ // Tips: ä»€ä¹ˆæ˜¯æœ€é«˜å±‚ï¼Ÿ // æ¯”å¦‚ zsl å½“å‰æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼ˆä¸ç®—å¤´ç»“ç‚¹ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„å±‚æ•° // åˆ†åˆ«ä¸º 4ï¼Œ2ï¼Œ5ï¼Œé‚£ä¹ˆ zsl-\u0026gt;level å°±æ˜¯èŠ‚ç‚¹ä¸­å±‚æ•°æœ€é«˜çš„ 5 for (i = zsl-\u0026gt;level-1; i \u0026gt;= 0; i--) { /* store rank that is crossed to reach the insert position */ rank[i] = i == (zsl-\u0026gt;level-1) ? 0 : rank[i+1]; // å¾ªç¯éœ€è¦æ»¡è¶³çš„æ¡ä»¶å¦‚ä¸‹ï¼š // 1. level[i] å‰è¿›æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªé null èŠ‚ç‚¹ï¼Œä¸”å‰è¿›æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹çš„åˆ†å€¼ // å°äºå½“å‰æ’å…¥å€¼çš„åˆ†å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘å‰ç§»åŠ¨ï¼Œç»§ç»­æŸ¥æ‰¾ï¼Œä¾‹å¦‚æœ‰å¦‚ä¸‹è·³è¡¨ï¼š // // head // level[2] ---- 1---------- 4 ----- 6 // level[1] ---- 1 ----- 3 - 4 ----- 6 æ’å…¥ä¸€ä¸ª 8 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 6 // // æ­¤æ—¶è·³è¡¨çš„ level ä¸º 3ï¼ˆæ­¤æ—¶å¤–å±‚çš„ for å¾ªç¯ä¸­çš„ i = 3-1 = 2ï¼‰ï¼Œ // ä» head çš„ level[3-1] å¼€å§‹æ‰¾èµ·ï¼Œlevel[2] çš„å‰è¿›æŒ‡é’ˆæŒ‡å‘äº† 1ï¼Œä¸ä¸ºç©ºï¼Œ // ä¸”è¦æ’å…¥çš„èŠ‚ç‚¹åˆ†å€¼ä¸º 8ï¼Œå¤§äº 1ï¼Œæ‰€ä»¥å¯ä»¥å°† x ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹çš„ forward èŠ‚ç‚¹ï¼Œ // å³ç§»åŠ¨åˆ° 4ã€‚ // // 4 è¿˜æ˜¯å°äº 8ï¼Œç»§ç»­å‘å‰ç§»åŠ¨ï¼Œç§»åŠ¨åˆ° 6ï¼Œæ­¤æ—¶ 6 çš„å‰è¿›æŒ‡é’ˆä¸º nullï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ // while å¾ªç¯äº†ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œupdate[2] = x = å½“å‰èŠ‚ç‚¹ 6ã€‚è‡³æ­¤ï¼Œæ­¤è½® for å¾ªç¯ // ç»“æŸã€‚ // // ç»§ç»­è¿›è¡Œç¬¬äºŒè½® for å¾ªç¯ï¼Œæ­¤æ—¶ i = 1ï¼Œè¿™ä»£è¡¨ç€ç°åœ¨é™åˆ°äº†è·³è¡¨çš„ç¬¬äºŒå±‚ã€‚ç¬¬äºŒå±‚çš„ // 6 ä¾ç„¶æŒ‡å‘ nullï¼Œæ‰€ä»¥ä¸è¿›å…¥ whileï¼Œupdate[1] = å½“å‰èŠ‚ç‚¹ 6ã€‚ // // ç¬¬ä¸‰è½® for å¾ªç¯ï¼Œæ­¤æ—¶ i = 0ï¼Œè¿™ä»£è¡¨å·²ç»æ¥åˆ°äº†è·³è¡¨çš„ç¬¬ä¸€å±‚ï¼Œæ­¤æ—¶çš„ 6 ä¾ç„¶æŒ‡å‘ // nullï¼Œupdate[0] = 6ã€‚ // // // 2. level[i] å‰è¿›æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªé null èŠ‚ç‚¹ï¼Œä¸”å‰è¿›æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹çš„åˆ†å€¼ // ç­‰äºå½“å‰æ’å…¥å€¼çš„åˆ†å€¼ï¼Œä¹Ÿå°±æ˜¯é‡åˆ°äº†åˆ†å€¼ä¸€æ ·çš„æƒ…å†µäº†ï¼Œæ­¤æ—¶ä¼šç»§ç»­åˆ¤æ–­äºŒè€…çš„ // æˆå‘˜å€¼ï¼Œå› ä¸ºæˆå‘˜å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼šæ ¹æ®å­—å…¸é¡ºåºè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ forward // çš„æˆå‘˜å€¼å°äºè¦æ’å…¥çš„æˆå‘˜å€¼ï¼Œåˆ™ç»§ç»­å‘å‰ç§»åŠ¨ã€‚ // // ç®€å•çš„è¯´ï¼Œå¦‚æœåˆ†å€¼ç›¸åŒï¼Œä¼šç»§ç»­æ ¹æ®æˆå‘˜å€¼è¿›è¡Œåˆ¤æ–­ã€‚ // æ¯”å¦‚ï¼š // // èŠ‚ç‚¹ 1 èŠ‚ç‚¹ 2 ï¼ˆçœç•¥å¤´ç»“ç‚¹ï¼Œå¤´èŠ‚ç‚¹æŒ‡å‘èŠ‚ç‚¹ 1ï¼‰ // +--------+ +--------+ // + l3 + ----\u0026gt; + l3 + // + l2 + ----\u0026gt; + l2 + // + l1 + ----\u0026gt; + l1 + æ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œæˆå‘˜å€¼ä¸º bbbbbï¼Œ // + 30.0 + ----\u0026gt; + 50.0 + åˆ†å€¼ä¸º 30.0 // + aaaaa + ----\u0026gt; + ccccc + // +--------+ +--------+ // // å¼€å§‹ä¼šä»å¤´ç»“ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°èŠ‚ç‚¹ 1ï¼Œå‘ç°èŠ‚ç‚¹ 1 çš„ score ä¸º 30.0ï¼Œç»§ç»­åˆ¤æ–­æˆå‘˜å€¼ï¼Œ // å› ä¸º bbbbb \u0026gt; aaaaaï¼Œæ‰€ä»¥ç§»åŠ¨åˆ°èŠ‚ç‚¹ 1ï¼Œçœ‹åä¸€ä¸ªèŠ‚ç‚¹ èŠ‚ç‚¹ 2 çš„ score å€¼ï¼Œå› ä¸º // 50 \u0026gt; 30ï¼Œæ‰€ä»¥åœæ­¢ç§»åŠ¨ï¼Œæ–°èŠ‚ç‚¹å°†æ’å…¥åˆ°èŠ‚ç‚¹ 1 çš„åé¢ // // èŠ‚ç‚¹ 1 æ–°èŠ‚ç‚¹ // +--------+ +--------+ // + l3 + ----\u0026gt; + l3 + // + l2 + ----\u0026gt; + l2 + // + l1 + ----\u0026gt; + l1 + // + 30.0 + ----\u0026gt; + 30.0 + // + aaaaa + ----\u0026gt; + bbbbb + // +--------+ +--------+ while (x-\u0026gt;level[i].forward \u0026amp;\u0026amp; // level[i] çš„å‰è¿›æŒ‡é’ˆæŒ‡å‘é null èŠ‚ç‚¹ // å¦‚æœæ’å…¥èŠ‚ç‚¹çš„åˆ†å€¼å¤§äº level[i] æŒ‡å‘èŠ‚ç‚¹çš„åˆ†å€¼ (x-\u0026gt;level[i].forward-\u0026gt;score \u0026lt; score || // æ’å…¥èŠ‚ç‚¹åˆ†å€¼ç­‰äº level[i] æŒ‡å‘èŠ‚ç‚¹çš„åˆ†å€¼ (x-\u0026gt;level[i].forward-\u0026gt;score == score \u0026amp;\u0026amp; // level[i] æŒ‡å‘èŠ‚ç‚¹çš„ ele å°äºæ’å…¥èŠ‚ç‚¹çš„ ele // Tips: sdscmp(x, y), å½“ x \u0026lt; y æ—¶ï¼Œè¿”å›ä¸€ä¸ªè´Ÿæ•° sdscmp(x-\u0026gt;level[i].forward-\u0026gt;ele,ele) \u0026lt; 0))) { // rank[i] += x-\u0026gt;level[i].span; // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ x = x-\u0026gt;level[i].forward; } // è®°å½•å½“å‰å±‚çš„å¾…æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ update[i] = x; } /* we assume the element is not already inside, since we allow duplicated * scores, reinserting the same element should never happen since the * caller of zslInsert() should test in the hash table if the element is * already inside or not. */ level = zslRandomLevel(); // å¦‚æœéšæœºç”Ÿæˆçš„é«˜åº¦å¤§äºå½“å‰ zsl çš„æœ€å¤§é«˜åº¦ï¼Œé‚£ä¹ˆä¼šå¤šå‡ºæ¥ç‹¬ç«‹çš„å‡ å±‚ï¼Œéœ€è¦è¿æ¥èµ·æ¥ï¼Œ // ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæ–°æ’å…¥ä¸€ä¸ª 8ï¼Œä¸” 8 çš„éšæœºå±‚æ•°ä¸º 5ï¼Œé‚£ä¹ˆå°±ä¼šå¤šå‡ºæ¥ 2 å±‚ï¼Œè¿™ä¸¤ // å±‚æ˜¯ç‹¬ç«‹çš„ï¼Œéœ€è¦å°†å…¶ä¸ head è¿æ¥èµ·æ¥ã€‚ // // head 8 ï¼ˆç‹¬ç«‹ï¼‰ // 8 ï¼ˆç‹¬ç«‹ï¼‰ // level[2] ---- 1---------- 4 ----- 6 --- 8 // level[1] ---- 1 ----- 3 - 4 ----- 6 --- 8 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 6 --- 8 // // è¿æ¥åï¼š // // head // level[4] ------------------------------ 8 // level[3] ------------------------------ 8 // level[2] ---- 1---------- 4 ----- 6 --- 8 // level[1] ---- 1 ----- 3 - 4 ----- 6 --- 8 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 6 --- 8 if (level \u0026gt; zsl-\u0026gt;level) { // ä¸ºå¤šå‡ºçš„è¿™å‡ å±‚è¿›è¡Œè¿æ¥ for (i = zsl-\u0026gt;level; i \u0026lt; level; i++) { rank[i] = 0; // ç‹¬ç«‹çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦ç”¨å¤´ç»“ç‚¹ä½œä¸º update update[i] = zsl-\u0026gt;header; update[i]-\u0026gt;level[i].span = zsl-\u0026gt;length; } // æ›´æ–°æœ€å¤§é«˜åº¦ zsl-\u0026gt;level = level; } // åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ x = zslCreateNode(level,score,ele); // å°†æ–°èŠ‚ç‚¹çš„æ¯ä¸€å±‚ä¸è·³è¡¨ä¸­å¯¹åº”çš„é‚£ä¸€å±‚å…³è”èµ·æ¥ // æ¯”å¦‚ï¼šupdate[0] æŒ‡å‘ x[0]ï¼Œupdate[1] æŒ‡å‘ x[1] // æ–‡å­—ä¸å¥½ç†è§£ï¼Œçœ‹ä¸‹é¢çš„å›¾ç¤ºï¼š // // head // level[2] ---- 1---------- 4 ----- 8 // level[1] ---- 1 ----- 3 - 4 ----- 8 æ’å…¥ä¸€ä¸ª 7, å‡è®¾å±‚æ•°ä¸º 2 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 8 // // å› ä¸ºå±‚æ•°ä¸º 2ï¼Œæ‰€ä»¥ for 2 æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šå°† 7 çš„å±‚æ•°å…³è”èµ·æ¥ // // head // level[2] ---- 1---------- 4 --------- 8 // level[1] ---- 1 ----- 3 - 4 ----- 7 - 8 ç¬¬äºŒæ¬¡ï¼š4 æŒ‡å‘ 7ï¼Œ7 æŒ‡å‘ 8 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 7 - 8 ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œå°† 7 çš„ç¬¬ä¸€å±‚å…³è”èµ·æ¥ // 5 æŒ‡å‘ 7ï¼Œ7 æŒ‡å‘ 8 for (i = 0; i \u0026lt; level; i++) { // å°±å’Œé“¾è¡¨çš„æ·»åŠ æ“ä½œä¸€æ ·ï¼Œè¦å°† x æ·»åŠ åˆ° update çš„åé¢ï¼Œ // éœ€è¦å…ˆå°† x æŒ‡å‘ update çš„åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå†å°† update æŒ‡å‘ x // // update -\u0026gt; update.next, è¦å°† x æ·»åŠ åˆ° update åé¢ // 1. x -\u0026gt; update.next // 2. update -\u0026gt; x // ç»“æœï¼šupdate -\u0026gt; x -\u0026gt; update.next x-\u0026gt;level[i].forward = update[i]-\u0026gt;level[i].forward; update[i]-\u0026gt;level[i].forward = x; /* update span covered by update[i] as x is inserted here */ x-\u0026gt;level[i].span = update[i]-\u0026gt;level[i].span - (rank[0] - rank[i]); update[i]-\u0026gt;level[i].span = (rank[0] - rank[i]) + 1; } /* increment span for untouched levels */ for (i = level; i \u0026lt; zsl-\u0026gt;level; i++) { update[i]-\u0026gt;level[i].span++; } // æ›´æ–°æ–°æ·»åŠ èŠ‚ç‚¹çš„å›é€€æŒ‡é’ˆï¼Œå¦‚æœ update[0] æ˜¯ headerï¼Œé‚£ä¹ˆå°±å°†å›é€€æŒ‡é’ˆè®¾ç½®ä¸º nullï¼Œ // ä¸æ˜¯ headerï¼Œåˆ™è®¾ç½®ä¸º update[0] // è¿™é‡Œä¸ºä»€ä¹ˆåªæœ‰ update[0] å‘¢ï¼Ÿå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªåé€€æŒ‡é’ˆï¼Œ // æ‰€ä»¥è¿™é‡Œåªéœ€ä¸ºç¬¬ 1 å±‚è®¾ç½®åé€€èŠ‚ç‚¹ x-\u0026gt;backward = (update[0] == zsl-\u0026gt;header) ? NULL : update[0]; // å°†æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹çš„ backward æŒ‡å‘æ–°èŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è¯ï¼‰ // å°±å’ŒåŒé“¾è¡¨çš„æ·»åŠ æ“ä½œä¸€æ · if (x-\u0026gt;level[0].forward) x-\u0026gt;level[0].forward-\u0026gt;backward = x; else // å¦åˆ™è¯´æ˜æ–°èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶æ›´æ–° tail ä¸ºæ–°èŠ‚ç‚¹ zsl-\u0026gt;tail = x; zsl-\u0026gt;length++; // èŠ‚ç‚¹æ•°é‡ + 1 return x; } zslDeleteNode /* Internal function used by zslDelete, zslDeleteRangeByScore and * zslDeleteRangeByRank. */ void zslDeleteNode(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update) { int i; // åˆ é™¤æ¯å±‚ä¸­çš„ x for (i = 0; i \u0026lt; zsl-\u0026gt;level; i++) { // å¦‚æœ update çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ x if (update[i]-\u0026gt;level[i].forward == x) { update[i]-\u0026gt;level[i].span += x-\u0026gt;level[i].span - 1; // å’Œé“¾è¡¨çš„åˆ é™¤æ“ä½œä¸€æ ·ï¼Œå°†è¢«åˆ é™¤çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘è¦åˆ é™¤çš„åä¸€ä¸ªèŠ‚ç‚¹ update[i]-\u0026gt;level[i].forward = x-\u0026gt;level[i].forward; } else { update[i]-\u0026gt;level[i].span -= 1; } } // å¦‚æœè¢«åˆ é™¤èŠ‚ç‚¹æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åé€€æŒ‡é’ˆæŒ‡å‘è¢«åˆ é™¤èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ if (x-\u0026gt;level[0].forward) { x-\u0026gt;level[0].forward-\u0026gt;backward = x-\u0026gt;backward; } else { // å¦åˆ™è¯´æ˜è¢«åˆ é™¤èŠ‚ç‚¹æ˜¯è·³è¡¨ä¸­çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›´æ–° tail ä¸ºè¢«åˆ é™¤ // èŠ‚ç‚¹çš„å‰ä¸€ä¸ª zsl-\u0026gt;tail = x-\u0026gt;backward; } // æ›´æ–°è·³è¡¨çš„æœ€å¤§é«˜åº¦å­—æ®µ // ä»æœ€é«˜å±‚å¼€å§‹ï¼Œå¦‚æœå¤´ç»“ç‚¹åœ¨è¯¥å±‚æ²¡æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥å±‚ä¸ºç©ºï¼Œlevel--ï¼Œ // å¾ªç¯åˆ é™¤æ‰€æœ‰ç©ºå±‚ while(zsl-\u0026gt;level \u0026gt; 1 \u0026amp;\u0026amp; zsl-\u0026gt;header-\u0026gt;level[zsl-\u0026gt;level-1].forward == NULL) zsl-\u0026gt;level--; // æ›´æ–°è·³è¡¨çš„èŠ‚ç‚¹æ•°é‡ zsl-\u0026gt;length--; } zslDelete /* Delete an element with matching score/element from the skiplist. * The function returns 1 if the node was found and deleted, otherwise * 0 is returned. * * If 'node' is NULL the deleted node is freed by zslFreeNode(), otherwise * it is not freed (but just unlinked) and *node is set to the node pointer, * so that it is possible for the caller to reuse the node (including the * referenced SDS string at node-\u0026gt;ele). */ int zslDelete(zskiplist *zsl, double score, sds ele, zskiplistNode **node) { zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x; int i; // æ•´ä½“æµç¨‹ï¼š // // head // level[4] ------------------------------ 8 // level[3] ------------------------------ 8 // level[2] ---- 1---------- 4 ----- 6 --- 8 åˆ é™¤ 6 // level[1] ---- 1 ----- 3 - 4 ----- 6 --- 8 // level[0] ---- 1 - 2 - 3 - 4 - 5 - 6 --- 8 // // 1. å…ˆä»æœ€é«˜å¤„ level[4] å¼€å§‹ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º 8ï¼Œæ¯” 6 å¤§ï¼Œä¸æ»¡è¶³ while æ¡ä»¶ï¼Œ // x = head.level[4], update[4] = xï¼Œé™åˆ° level[3] // // 2. level[3] å’Œ [4] æƒ…å†µä¸€æ ·ï¼Œ // x = head.level[3], update[3] = x // // 3. level[2] ä¼šä»å¤´ç»“ç‚¹å‰è¿›åˆ°èŠ‚ç‚¹ 4ï¼Œ // x = 4, update[2] = xï¼ˆå…¶å®å½“ score ç›¸åŒæ—¶ï¼Œè¿˜ä¼šç»§ç»­æ¯”è¾ƒ eleï¼Œè¿™é‡Œçœç•¥ï¼‰ // // 4. level[1] =\u0026gt; x = 4, update[1] = x // 5. level[0] =\u0026gt; x = 5, update[0] = x // è‡³æ­¤ï¼Œupdate è®°å½•äº†è¢«åˆ é™¤åœ¨æ¯å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œx æ˜¯ç¬¬ä¸€å±‚çš„è¢«åˆ é™¤èŠ‚ç‚¹çš„å‰ä¸€ä¸ª // èŠ‚ç‚¹ // å’Œæ’å…¥æ“ä½œä¸€æ ·ï¼Œå…ˆæŸ¥æ‰¾è·³è¡¨ï¼Œæ‰¾åˆ°è¢«åˆ é™¤èŠ‚ç‚¹åœ¨æ¯å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ x = zsl-\u0026gt;header; for (i = zsl-\u0026gt;level-1; i \u0026gt;= 0; i--) { while (x-\u0026gt;level[i].forward \u0026amp;\u0026amp; (x-\u0026gt;level[i].forward-\u0026gt;score \u0026lt; score || (x-\u0026gt;level[i].forward-\u0026gt;score == score \u0026amp;\u0026amp; sdscmp(x-\u0026gt;level[i].forward-\u0026gt;ele,ele) \u0026lt; 0))) { x = x-\u0026gt;level[i].forward; } update[i] = x; } /* We may have multiple elements with the same score, what we need * is to find the element with both the right score and object. */ // æ­¤æ—¶çš„ x æ˜¯è¢«åˆ é™¤èŠ‚ç‚¹åœ¨ç¬¬ä¸€å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè·å– x çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ x = x-\u0026gt;level[0].forward; // å¦‚æœ x å­˜åœ¨ï¼Œä¸” score å’Œ ele éƒ½ç›¸åŒï¼Œè°ƒç”¨åˆ é™¤èŠ‚ç‚¹å‡½æ•°è¿›è¡Œåˆ é™¤ if (x \u0026amp;\u0026amp; score == x-\u0026gt;score \u0026amp;\u0026amp; sdscmp(x-\u0026gt;ele,ele) == 0) { zslDeleteNode(zsl, x, update); if (!node) zslFreeNode(x); else *node = x; return 1; } return 0; /* not found */ } ","date":"2021å¹´08æœˆ17æ—¥","permalink":"/posts/redis-zset-yuan-ma-yue-du/","summary":"types zskiplistNode typedef struct zskiplistNode { sds ele; // æˆå‘˜ double score; // åˆ†å€¼ struct zskiplistNode *backward; // åé€€æŒ‡é’ˆ // å±‚ struct zskiplistLevel { struct zskiplistNode *forward; // å‰è¿›æŒ‡é’ˆ unsigned long span; // è·¨åº¦ } level[]; } zskiplistNode; zskiplist typedef struct zskiplist { struct zskiplistNode *header, *tail; unsigned long length; int level; // å½“å‰è·³è·ƒè¡¨å†…ï¼Œå±‚æ•°æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•° } zskiplist; zset typedef struct zset { dict *dict; zskiplist *zsl; } zset; functions zslCreate /* Create a new skiplist.","title":"Redis zset æºç é˜…è¯»"},{"contents":" ç»™ä½ ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„Â numsÂ ï¼Œä½ éœ€è¦ä»ä¸­åˆ æ‰ä¸€ä¸ªå…ƒç´ ã€‚\nè¯·ä½ åœ¨åˆ æ‰å…ƒç´ çš„ç»“æœæ•°ç»„ä¸­ï¼Œè¿”å›æœ€é•¿çš„ä¸”åªåŒ…å« 1 çš„éç©ºå­æ•°ç»„çš„é•¿åº¦ã€‚\nå¦‚æœä¸å­˜åœ¨è¿™æ ·çš„å­æ•°ç»„ï¼Œè¯·è¿”å› 0 ã€‚\næç¤º 1ï¼š\nè¾“å…¥ï¼šnums = [1,1,0,1] è¾“å‡ºï¼š3 è§£é‡Šï¼šåˆ æ‰ä½ç½® 2 çš„æ•°åï¼Œ[1,1,1] åŒ…å« 3 ä¸ª 1 ã€‚ ç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šnums = [0,1,1,1,0,1,1,0,1] è¾“å‡ºï¼š5 è§£é‡Šï¼šåˆ æ‰ä½ç½® 4 çš„æ•°å­—åï¼Œ[0,1,1,1,1,1,0,1] çš„æœ€é•¿å…¨ 1 å­æ•°ç»„ä¸º [1,1,1,1,1] ã€‚ ç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šnums = [1,1,1] è¾“å‡ºï¼š2 è§£é‡Šï¼šä½ å¿…é¡»è¦åˆ é™¤ä¸€ä¸ªå…ƒç´ ã€‚ ç¤ºä¾‹ 4ï¼š\nè¾“å…¥ï¼šnums = [1,1,0,0,1,1,1,0,1] è¾“å‡ºï¼š4 ç¤ºä¾‹ 5ï¼š\nè¾“å…¥ï¼šnums = [0,0,0] è¾“å‡ºï¼š0\næç¤ºï¼š\n1 \u0026lt;= nums.length \u0026lt;= 10^5 nums[i]Â è¦ä¹ˆæ˜¯Â 0Â è¦ä¹ˆæ˜¯Â 1 ã€‚\næ–¹æ³• 1 æ»‘åŠ¨çª—å£ ä»£ç å¦‚ä¸‹ï¼š\nfunc longestSubarray(nums []int) int { var ( l, r int windowHasZero bool // å½“å‰çª—å£å†…æ˜¯å¦æœ‰ 0 zeroIndex int res int ) for r \u0026lt; len(nums) { if nums[r] == 0 \u0026amp;\u0026amp; !windowHasZero { windowHasZero = true zeroIndex = r } else if nums[r] == 0 \u0026amp;\u0026amp; windowHasZero { z := zeroIndex // æ›´æ–°å½“å‰ä½ç½®ä¸ºæ–°çš„ zeroIndex zeroIndex = r res = max(res, r-l-1) // l ç§»åŠ¨åˆ°ä¹‹å‰ 0 æ‰€åœ¨ä½ç½®ä¹‹å l = z + 1 } r++ } res = max(res, r-l-1) return res } func max(x, y int) int { if x \u0026gt; y { return x } return y } ","date":"2021å¹´08æœˆ12æ—¥","permalink":"/posts/leetcode-1493-shan-diao-yi-ge-yuan-su-yi-hou-quan-wei-1-de-zui-chang-zi-shu-zu/","summary":"ç»™ä½ ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„Â numsÂ ï¼Œä½ éœ€è¦ä»ä¸­åˆ æ‰ä¸€ä¸ªå…ƒç´ ã€‚\nè¯·ä½ åœ¨åˆ æ‰å…ƒç´ çš„ç»“æœæ•°ç»„ä¸­ï¼Œè¿”å›æœ€é•¿çš„ä¸”åªåŒ…å« 1 çš„éç©ºå­æ•°ç»„çš„é•¿åº¦ã€‚","title":"leetcode 1493. åˆ æ‰ä¸€ä¸ªå…ƒç´ ä»¥åå…¨ä¸º 1 çš„æœ€é•¿å­æ•°ç»„"},{"contents":"ä½¿ç”¨å›½å†…é•œåƒï¼Œç›®å‰å·²çŸ¥Githubå›½å†…é•œåƒç½‘ç«™æœ‰ github.com.cnpmjs.org å’Œ git.sdut.me/ ã€‚é€Ÿåº¦æ ¹æ®å„åœ°æƒ…å†µè€Œå®šï¼Œåœ¨cloneæŸä¸ªé¡¹ç›®çš„æ—¶å€™å°† github.com æ›¿æ¢ä¸º github.com.cnpmjs.org å³å¯ã€‚\næ¥æºï¼šhttps://blog.csdn.net/hzlarm/article/details/115415038\n","date":"2021å¹´08æœˆ11æ—¥","permalink":"/posts/git-clone-su-du-man/","summary":"ä½¿ç”¨å›½å†…é•œåƒï¼Œç›®å‰å·²çŸ¥Githubå›½å†…é•œåƒç½‘ç«™æœ‰ github.com.cnpmjs.org å’Œ git.sdut.me/ ã€‚é€Ÿåº¦æ ¹æ®å„åœ°æƒ…å†µè€Œå®šï¼Œåœ¨cloneæŸä¸ªé¡¹ç›®çš„æ—¶å€™å°† github.","title":"git clone é€Ÿåº¦æ…¢çš„è§£å†³æ–¹æ³•"},{"contents":"åœ¨ä¸€å¦‚æ—¢å¾€åœ°æ‰§è¡Œ git push åˆ° Github æ—¶ï¼Œå‡ºç°äº†ä¸€ä¸ªä»æœªé‡åˆ°è¿‡çš„é”™è¯¯ï¼š\nremote: fatal error in commit_refs To https://github.com/xxx ! [remote rejected] master -\u0026gt; master (failure) error: failed to push some refs to 'https://github.com/xxx' è§£å†³ git fsck git gc å‚è€ƒï¼š https://stackoverflow.com/questions/37341960/how-do-i-fix-remote-fatal-error-in-commit-refs-errors-trying-to-push-with-git#comment75666427_37342002\n","date":"2021å¹´08æœˆ11æ—¥","permalink":"/posts/git-push-error-remote-fatal-error-in-commit_refs/","summary":"åœ¨ä¸€å¦‚æ—¢å¾€åœ°æ‰§è¡Œ git push åˆ° Github æ—¶ï¼Œå‡ºç°äº†ä¸€ä¸ªä»æœªé‡åˆ°è¿‡çš„é”™è¯¯ï¼š","title":"git push error: remote: fatal error in commit_refs"},{"contents":"å¼•å­ å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ chanï¼Œç„¶ååˆ›å»ºä¸¤ä¸ª main goroutineï¼Œä¸€ä¸ªå¾€å…¨å±€ chan é‡Œå‘é€æ•°æ®ï¼Œä¸€ä¸ªä»å…¨å±€ chan é‡Œè¯»å–æ•°æ®ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\nè¿™ä¸ªå¥‡è‘©é—®é¢˜æ˜¯æˆ‘åœ¨å†™ä¸€ä¸ª server é¡¹ç›®æ—¶é‡åˆ°çš„ï¼Œå½“æ—¶çš„æƒ…æ™¯æ˜¯ï¼šæƒ³ä¸º server æ·»åŠ ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´å°±å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ï¼ŒæœåŠ¡ç«¯è¿™è¾¹ç»´æŒä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœæ”¶åˆ°å¿ƒè·³åŒ…åˆ™é‡ç½®ï¼Œå¦‚æœå®šæ—¶å™¨åˆ°æ—¶åˆ™è®¤ä¸ºå®¢æˆ·ç«¯å·²æ–­å¼€ï¼Œå…³é—­ socket è¿æ¥ã€‚è€ƒè™‘åˆ°å¿ƒè·³åŒ…äº§ç”Ÿçš„ç½‘ç»œä¼ è¾“å¼€é”€ï¼Œçªå‘å¥‡æƒ³ï¼Œå¯ä¸å¯ä»¥ç”¨ä¸€ä¸ªå…¨å±€ channel æ¥ä»£æ›¿ï¼Ÿ\näºæ˜¯ä¾¿å®šä¹‰äº†ä¸€ä¸ªå…¨å±€ channelï¼Œå®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´å°±å‘ channel ä¸­å†™å…¥æ•°æ®ï¼ŒæœåŠ¡ç«¯ä½¿ç”¨ select æ¥è¯»å– channelã€‚ä½†æ˜¯æµ‹è¯•æ—¶å´å‘ç°ï¼Œå®¢æˆ·ç«¯å¤„çš„å‘é€è¯­å¥ ch \u0026lt;- struct{}{} è¢«é˜»å¡äº†ï¼Œäºæ˜¯åˆå°†å…¨å±€ channel æ”¹ä¸ºå¸¦ç¼“å†²çš„ï¼Œç¼“å†²ä¸º 1ï¼Œæ­¤æ—¶å†æ¬¡è¿è¡Œï¼Œå®¢æˆ·ç«¯çš„å‘é€è¯­å¥æ²¡æœ‰è¢«é˜»å¡äº†ï¼Œä½†æ˜¯æœåŠ¡ç«¯é‚£è¾¹å´å‹æ ¹æ”¶ä¸åˆ°æ•°æ®ã€‚\næƒ…æ™¯å†ç° åˆ›å»ºä¸€ä¸ª global åŒ…ï¼Œåœ¨å…¶ä¸‹æ–°å»ºä¸€ä¸ª go æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\npackage global var Ch = make(chan int64, 1) åˆ›å»ºä¸€ä¸ª cli åŒ…åŠå…¶ä¹‹ä¸‹çš„ go æ–‡ä»¶ï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;gomodtest/sockchan/global\u0026quot; \u0026quot;time\u0026quot; ) func main() { select { case \u0026lt;-time.After(time.Second * 8) : fmt.Println(\u0026quot;timeout !\u0026quot;) case v := \u0026lt;-global.Ch: fmt.Println(v) } } æœ€ååˆ›å»ºä¸€ä¸ª sev åŒ…ï¼š\npackage main import ( \u0026quot;gomodtest/sockchan/global\u0026quot; \u0026quot;fmt\u0026quot; ) func main() { fmt.Println(\u0026quot;send data to global chan\u0026quot;) global.Ch \u0026lt;- 1 fmt.Println(\u0026quot;send ok\u0026quot;) } ç›®å½•ç»“æ„ï¼š\nâ”œâ”€â”€ cli â”‚ â””â”€â”€ cli.go â”œâ”€â”€ global â”‚ â””â”€â”€ var.go â””â”€â”€ sev â””â”€â”€ sev.go å…ˆè¿è¡Œ cli.goï¼Œå†å¼€ä¸€ä¸ª termin è¿è¡Œ sev.goï¼š\nsev.go è¾“å‡ºå¦‚ä¸‹ï¼š\nâœ sev go run sev.go send data to global chan send ok cli.go è¾“å‡ºå¦‚ä¸‹\nâœ cli go run cli.go timeout ! ç»“æœè¯´æ˜ï¼Œå¯ä»¥å‘ chan ä¸­å†™å…¥æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½ä» chan ä¸­è¯»å–æ•°æ®ã€‚\nåŸå›  ä¸¤ä¸ª main ä»£è¡¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹é—´é€šä¿¡å½“ç„¶ä¸èƒ½ä½¿ç”¨ channel äº†ï¼ˆå¦‚æ­¤å¼±æ™ºçš„é—®é¢˜ï¼‰\n","date":"2021å¹´08æœˆ08æ—¥","permalink":"/posts/liang-ge-main-goroutine-cao-zuo-yi-ge-channel-hui-zen-yang/","summary":"å¼•å­ å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ chanï¼Œç„¶ååˆ›å»ºä¸¤ä¸ª main goroutineï¼Œä¸€ä¸ªå¾€å…¨å±€ chan é‡Œå‘é€æ•°æ®ï¼Œä¸€ä¸ªä»å…¨å±€ chan é‡Œè¯»å–æ•°æ®ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ","title":"ä¸¤ä¸ª main goroutine æ“ä½œä¸€ä¸ª channel ä¼šæ€æ ·"},{"contents":"å¼•å­ ï¼ˆä»¥å mysql çš„è¾“å‡ºè¿˜æ˜¯æˆªå›¾å¥½ä¸€äº›ï¼Œå¤åˆ¶ç²˜è´´æ ¼å¼ä¼šå¾ˆéš¾çœ‹ï¼‰\næœ‰å¦‚ä¸‹è¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š\n+-------+-------------+------+-----+---------+----------------+ | Field | Type | Null | Key | Default | Extra | +-------+-------------+------+-----+---------+----------------+ | id | int | NO | PRI | NULL | auto_increment | | name | varchar(50) | YES | MUL | NULL | | | age | int | YES | | NULL | | +-------+-------------+------+-----+---------+----------------+ åˆ›å»ºä¸€ä¸ª (name, age) è”åˆç´¢å¼•ï¼Œå¹¶æ‰§è¡Œä¸‹é¢çš„ SQL è¯­å¥ï¼š\nexplain select * from stu_join_index where age = '12'; è¿è¡Œåå‘ç° type ä¸º indexï¼Œè¿™ä»£è¡¨è¿™æ¬¡æŸ¥è¯¢èµ°äº†ç´¢å¼•ã€‚\nï¼ˆ2022.3.20 æ›´æ–°ï¼šindex ä»£è¡¨çš„æ˜¯ä¼šå¯¹æ•´ä¸ªç´¢å¼•æ ‘è¿›è¡Œæ‰«æï¼Œå…¶å®ä¹Ÿç­‰åŒäºå…¨è¡¨æŸ¥è¯¢ï¼Œè‡³äº index ç›¸æ¯” all æ•ˆç‡ä¼šä¸ä¼šæ›´é«˜ï¼ŒæŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼Œéƒ½è¯´ index æ•ˆç‡è¦æ›´å¿«ä¸€äº›ï¼‰\n+----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ | 1 | SIMPLE | stu_join_index | NULL | index | name_age | name_age | 212 | NULL | 5 | 20.00 | Using where; Using index | +----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ è¿™å°±å¥‡æ€ªäº†ï¼ŒæŒ‰ç…§ Mysql æœ€å·¦å‰ç¼€åŸåˆ™ï¼Œå»ºç«‹çš„ç´¢å¼•æ˜¯ (name, age) ï¼Œåº”è¯¥åªæœ‰ï¼ˆnameï¼‰ï¼Œï¼ˆnameï¼Œageï¼‰ä¼šèµ°ç´¢å¼•å•Šï¼Ÿå†å°è¯•æŸ¥è¯¢ä¸€ä¸‹ï¼ˆage, nameï¼‰ï¼Œçœ‹ä¼šä¸ä¼šèµ°ç´¢å¼•ï¼š\nexplain select * from stu_join_index where age = '12' and name = 'aa'; +----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ | 1 | SIMPLE | stu_join_index | NULL | index | name_age | name_age | 212 | NULL | 5 | 20.00 | Using where; Using index | +----+-------------+----------------+------------+-------+---------------+----------+---------+------+------+----------+--------------------------+ å¯ä»¥çœ‹åˆ°è¿™é‡Œä¾ç„¶èµ°äº†ç´¢å¼•ã€‚\nè¡¥å……ï¼šExtra æ˜¾ç¤ºçš„æ˜¯ Using where; Using indexï¼Œå…¶ä¸­çš„ Using index ä»£è¡¨ï¼šä»è¡¨ä¸­ä»…ä½¿ç”¨ç´¢å¼•æ ‘ä¸­çš„ä¿¡æ¯å°±èƒ½è·å–æŸ¥è¯¢è¯­å¥çš„åˆ—çš„ä¿¡æ¯, è€Œä¸å¿…è¿›è¡Œå…¶ä»–é¢å¤–æŸ¥æ‰¾ï¼ˆseekï¼‰å»è¯»å–å®é™…çš„è¡Œè®°å½•ã€‚å½“æŸ¥è¯¢çš„åˆ—æ˜¯å•ä¸ªç´¢å¼•çš„éƒ¨åˆ†çš„åˆ—æ—¶, å¯ä»¥ä½¿ç”¨æ­¤ç­–ç•¥ã€‚ï¼ˆç®€å•çš„ç¿»è¯‘å°±æ˜¯ï¼šä½¿ç”¨ç´¢å¼•æ¥ç›´æ¥è·å–åˆ—çš„æ•°æ®ï¼Œè€Œä¸éœ€å›è¡¨ï¼Œå³è¦†ç›–ç´¢å¼•ï¼‰ã€‚\nåæ¥åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªåŒæ ·é—®é¢˜çš„æ–‡ç« ï¼ˆhttps://segmentfault.com/a/1190000022690969ï¼‰ï¼Œä»–çš„æƒ…å†µå’Œæˆ‘ä¸€æ ·ï¼Œåˆ›å»ºäº†ä¸€å¼ è¡¨ï¼Œè¡¨ä¸­æ€»å…±æœ‰å››ä¸ªå­—æ®µã€‚ id ä¸ºä¸»é”®ï¼Œè¿˜æœ‰ä¸€ä¸ªç”± nameï¼Œageï¼Œaddress ç»„æˆçš„è”åˆç´¢å¼•ï¼Œå½“ä»–æ‰§è¡Œä¸‹é¢çš„ SQL æ—¶ï¼š\nEXPLAIN select * from user where address='beijing'; åŒæ ·å‘ç° type å­—æ®µä¸º indexã€‚\næœ€ç»ˆåœ¨è¯„è®ºåŒºæ‰¾åˆ°äº†ç­”æ¡ˆï¼š\næ€»ç»“ä¸‹ï¼Œä¸æ˜¯æœ€å·¦åŸåˆ™å¤±æ•ˆäº†ã€‚æ˜¯å› ä¸ºä¸€å¼€å§‹è®¾è®¡çš„å­—æ®µåªæœ‰å››ä¸ªï¼š(id,name,age,address)ï¼Œæ­¤æ—¶çš„è” åˆç´¢å¼•æ˜¯ï¼ˆname, age, addressï¼‰ï¼Œid è‡ªå¸¦ä¸€ä¸ªä¸»é”®ç´¢å¼•ã€‚ç›¸å½“äºï¼Œå››ä¸ªå­—æ®µéƒ½æœ‰ç´¢å¼•ã€‚å› ä¸ºè¦†ç›–ç´¢å¼• çš„ç¼˜æ•…ï¼Œæ€ä¹ˆæŸ¥éƒ½ä¼šèµ°ç´¢å¼•ã€‚å½“å¢åŠ ä¸€ä¸ªå­—æ®µï¼ˆuseï¼‰åï¼Œè¯¥å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œå› æ­¤ select * çš„æ—¶å€™ä¸ä¼š è§¦å‘è¦†ç›–ç´¢å¼•ï¼Œå› æ­¤ä¸ä¼šèµ°ç´¢å¼•ã€‚ä½†æ˜¯å¦‚æœåªæŸ¥è¯¢ select name,age,address,id çš„è¯ä¾ç„¶ä¼šèµ°ç´¢å¼•\näºæ˜¯æˆ‘è¿›è¡Œäº†è¿›ä¸€æ­¥æµ‹è¯•ï¼Œä¸ºè¡¨æ·»åŠ ä¸€ä¸ªå­—æ®µå¹¶æ’å…¥ä¸€æ¡æ•°æ®ï¼š\nalter table stu_join_index add column score int; update stu_join_index set score = 90 where name = 'aa'; æ­¤æ—¶çš„è¡¨ä¿¡æ¯ï¼š\n+----+------+------+-------+ | id | name | age | score | +----+------+------+-------+ | 1 | aa | 12 | 90 | | 2 | bb | 22 | NULL | | 3 | cc | 66 | NULL | | 4 | dd | 88 | NULL | | 5 | ee | 23 | NULL | +----+------+------+-------+ æ­¤æ—¶æ‰§è¡Œ (score, age)ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ï¼š\nexplain select * from stu_join_index where score = 90 and age = 12; +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | 1 | SIMPLE | stu_join_index | NULL | ALL | NULL | NULL | NULL | NULL | 5 | 20.00 | Using where | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ æ­¤æ—¶ type å˜ä¸ºäº† ALLï¼Œä»£è¡¨è¦æ‰«æå…¨è¡¨ã€‚\nå› ä¸º (name, age) ç›¸å½“äºåˆ›å»ºäº† name å•åˆ—ç´¢å¼•å’Œ (name, age) è”åˆç´¢å¼•ã€‚å¯¹äºå¤šä¸ªå­—æ®µçš„è”åˆç´¢å¼•ï¼Œä¹ŸåŒç†ã€‚å¦‚ index(a, b, c) è”åˆç´¢å¼•ï¼Œåˆ™ç›¸å½“äºåˆ›å»ºäº† a å•åˆ—ç´¢å¼•ï¼Œ(a, b) è”åˆç´¢å¼•ï¼Œå’Œ (a, b, c )è”åˆç´¢å¼•ã€‚ (score, age) æ—¢æ²¡æœ‰è”åˆç´¢å¼•ï¼Œå„è‡ªä¹Ÿæ²¡æœ‰å•åˆ—ç´¢å¼•ï¼Œæ‰€ä»¥è‡ªç„¶è¦æ‰«æå…¨è¡¨ã€‚\nä¸€äº›ç–‘é—® 1. where æ¡ä»¶åªæœ‰ name å¦‚æœ where æ¡ä»¶åªæœ‰ score ï¼Œæˆ–è€…åªæœ‰ age ï¼Œç»“æœä¼šæ€æ ·å‘¢ï¼Ÿ\nexplain select * from stu_join_index where age = '12'; explain select * from stu_join_index where score = 90; è¿è¡Œç»“æœï¼š\n+----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | 1 | SIMPLE | stu_join_index | NULL | ALL | NULL | NULL | NULL | NULL | 5 | 20.00 | Using where | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ ç»“æœä¼šæ‰«æå…¨è¡¨ã€‚è¿™æ—¶å› ä¸º socre å’Œ age éƒ½æ²¡æœ‰å•åˆ—ç´¢å¼•ã€‚\nä½†æ˜¯å½“ where æ¡ä»¶åªæœ‰ name æ—¶ä¼šæ€æ ·å‘¢ï¼Ÿ\nexplain select * from stu_join_index where name = 'aa'; è¿è¡Œç»“æœï¼š\n+----+-------------+----------------+------------+------+---------------+----------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+----------+---------+-------+------+----------+-------+ | 1 | SIMPLE | stu_join_index | NULL | ref | name_age | name_age | 203 | const | 1 | 100.00 | NULL | +----+-------------+----------------+------------+------+---------------+----------+---------+-------+------+----------+-------+ æ­¤æ—¶ type ä¸º refï¼Œåœ¨ä¸Šé¢å·²ç»è¯´è¿‡ï¼Œ(name, age) è”åˆç´¢å¼•ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ª name å•åˆ—ç´¢å¼•ã€‚ä½†æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ ref è€Œä¸æ˜¯ index å‘¢ï¼Ÿ\nref ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æ‰«ææˆ–å”¯ä¸€ç´¢å¼•çš„å‰ç¼€æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è®°å½•è¡Œã€‚\nå‡ºç°è¯¥è¿æ¥ç±»å‹çš„æ¡ä»¶æ˜¯ï¼š æŸ¥æ‰¾æ¡ä»¶åˆ—ä½¿ç”¨äº†ç´¢å¼•è€Œä¸”ä¸ä¸ºä¸»é”®å’Œuniqueã€‚å…¶å®ï¼Œæ„æ€å°±æ˜¯è™½ç„¶ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†è¯¥ç´¢å¼•åˆ—çš„å€¼å¹¶ä¸å”¯ä¸€ï¼Œæœ‰é‡å¤ã€‚è¿™æ ·å³ä½¿ä½¿ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾åˆ°äº†ç¬¬ä¸€æ¡æ•°æ®ï¼Œä»ç„¶ä¸èƒ½åœæ­¢ï¼Œè¦è¿›è¡Œç›®æ ‡å€¼é™„è¿‘çš„å°èŒƒå›´æ‰«æã€‚ä½†å®ƒçš„å¥½å¤„æ˜¯å®ƒå¹¶ä¸éœ€è¦æ‰«å…¨è¡¨ï¼Œå› ä¸ºç´¢å¼•æ˜¯æœ‰åºçš„ï¼Œå³ä¾¿æœ‰é‡å¤å€¼ï¼Œä¹Ÿæ˜¯åœ¨ä¸€ä¸ªéå¸¸å°çš„èŒƒå›´å†…æ‰«æã€‚\næˆ‘çš„çŒœæµ‹ï¼š\nåœ¨æ²¡æœ‰æ·»åŠ  score å­—æ®µå‰ï¼Œè”åˆç´¢å¼• (name, age) æ˜¯è¦†ç›–ç´¢å¼•ï¼Œä½†æ˜¯æ·»åŠ äº† score åä¾¿ä¸å†æ˜¯è¦†ç›–ç´¢å¼•äº†\nè¦†ç›–ç´¢å¼•ä¾ç„¶æ˜¯ ref\n2. ä¸ºä»€ä¹ˆ name ä¸ºéå­—ç¬¦ä¸²æ—¶ä¸èµ°ç´¢å¼• åœ¨ 1 ä¸­æåˆ°ï¼Œ\nexplain select * from stu_join_index where name = 'aa'; çš„ type ä¸º refï¼Œé‚£ä¹ˆå¦‚æœæŠŠæŸ¥è¯¢æ¡ä»¶æ”¹ä¸ºéå­—ç¬¦ä¸²ä¼šæ€æ ·å‘¢ï¼Ÿï¼ˆname ä¸º varchar ç±»å‹ï¼‰\nexplain select * from stu_join_index where name = 1; ç»“æœï¼š\n+----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ | 1 | SIMPLE | stu_join_index | NULL | ALL | name_age | NULL | NULL | NULL | 5 | 20.00 | Using where | +----+-------------+----------------+------------+------+---------------+------+---------+------+------+----------+-------------+ ç»“æœå˜ä¸ºäº† ALLï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å­—ç¬¦ä¸²å°±ä¼šç´¢å¼•å¤±æ•ˆå‘¢ï¼Ÿ\nå›ç­”\nåœ¨åšå®¢ https://blog.csdn.net/qq_28194001/article/details/90488782 ä¸­å¾—å‡ºç»“è®ºï¼š\nå½“æˆ‘ä»¬ä½¿ç”¨çš„å­—æ®µæ˜¯æ•°å€¼ç±»å‹æ—¶ï¼ŒåŠ å¼•å·æˆ–è€…ä¸åŠ å¼•å·ï¼ˆsqlä¸­å•å¼•å·å’ŒåŒå¼•å·å®ç°ç›¸åŒæ•ˆæœï¼‰éƒ½ä¸å½±å“ ç´¢å¼•çš„ä½¿ç”¨ å½“æˆ‘ä»¬çš„å­—æ®µæ˜¯å­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œä¸åŠ å¼•å·çš„æŸ¥è¯¢æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼ŒåŠ å¼•å·çš„æŸ¥è¯¢æ‰å¯æ­£å¸¸ä½¿ç”¨ç´¢å¼• 3. å†æ¥çœ‹ä¸€ç§æƒ…å†µï¼š æ­¤æ—¶æ‰§è¡Œ (name, score, age)ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ï¼š\nexplain select * from stu_join_index where name = 'aa' and score = 90 and age = 12; +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------------+ | 1 | SIMPLE | stu_join_index | NULL | ref | name_age | name_age | 208 | const,const | 1 | 20.00 | Using where | +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------------+ è¿™é‡Œæ˜æ˜ä¸ç¬¦åˆæœ€å·¦å‰ç¼€åŸåˆ™ï¼Œä¸ºä»€ä¹ˆ type ä¼šæ˜¯ refï¼Ÿ\n4. å†æ¬¡æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼ˆåœ¨æ–‡ç« ä¸€å¼€å§‹è¿˜æ²¡æœ‰æ·»åŠ  score å­—æ®µæ—¶ï¼Œæ‰§è¡Œè¿‡è¯¥è¯­å¥ï¼‰ï¼š\nexplain select * from stu_join_index where age = '12' and name = 'aa'; +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------+ | 1 | SIMPLE | stu_join_index | NULL | ref | name_age | name_age | 208 | const,const | 1 | 100.00 | NULL | +----+-------------+----------------+------------+------+---------------+----------+---------+-------------+------+----------+-------+ ä¸ºä»€ä¹ˆåŠ äº† score å­—æ®µåï¼Œ type ä» index å˜ä¸ºäº† refï¼Ÿ\n","date":"2021å¹´08æœˆ07æ—¥","permalink":"/posts/mysql-zui-zuo-qian-zhui-yuan-ze-shi-xiao/","summary":"å¼•å­ ï¼ˆä»¥å mysql çš„è¾“å‡ºè¿˜æ˜¯æˆªå›¾å¥½ä¸€äº›ï¼Œå¤åˆ¶ç²˜è´´æ ¼å¼ä¼šå¾ˆéš¾çœ‹ï¼‰\næœ‰å¦‚ä¸‹è¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š","title":"Mysql æœ€å·¦å‰ç¼€åŸåˆ™å¤±æ•ˆ"},{"contents":"è¿™æ˜¯ä¸€é“é¢è¯•é«˜é¢‘é¢˜\næ— åç®¡é“ æ— åç®¡é“åªèƒ½ç”¨äºçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä»£ç å¦‚ä¸‹ï¼š\n// // Created by zz on 2021/3/5. // #include \u0026quot;../lib/apue.h\u0026quot; // æ— åç®¡é“ï¼šåªèƒ½åœ¨çˆ¶å­è¿›ç¨‹ä¹‹é—´é€šä¿¡ void pipe_t() { int fp[2]; // pipe()ï¼šåˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œç»ç”±å‚æ•° fd è¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œfp[0] ä¸ºè¯»æ‰“å¼€ï¼Œfp[1] ä¸ºå†™æ‰“å¼€ int err = pipe(fp); // æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1 err == 0 ? printf(\u0026quot;ok\u0026quot;) : printf(\u0026quot;create pipe error\u0026quot;); } // é€šè¿‡ç®¡é“ï¼Œä»çˆ¶è¿›ç¨‹ä¼ è¾“æ•°æ®åˆ°å­è¿›ç¨‹ void parent_to_child_pipe() { int n; int fd[2]; pid_t pid; char line[MAXLINE]; if (pipe(fd) \u0026lt; 0) { // ç”±çˆ¶è¿›ç¨‹åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹æ‰€åˆ›å»ºçš„ç®¡é“ err_sys(\u0026quot;pipe error\u0026quot;); } if ( (pid = fork()) \u0026lt; 0) { // fork åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ err_sys(\u0026quot;fork error\u0026quot;); } else if (pid \u0026gt; 0) { // çˆ¶è¿›ç¨‹ close(fd[0]); // å› ä¸ºæ˜¯ çˆ¶ -\u0026gt; å­ï¼Œæ‰€ä»¥å…³é—­çˆ¶è¿›ç¨‹çš„è¯»ç«¯ fd[0] printf(\u0026quot;çˆ¶è¿›ç¨‹å‘é€æ•°æ®...\\n\u0026quot;); write(fd[1], \u0026quot;hello world\\n\u0026quot;, 12); } else { // å­è¿›ç¨‹ // è¯¥å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹æ‰€åˆ›å»ºçš„ç®¡é“ close(fd[1]); // å› ä¸ºæ˜¯ çˆ¶ -\u0026gt; å­ï¼Œæ‰€ä»¥å…³é—­å­è¿›ç¨‹çš„å†™ç«¯ fd[1] printf(\u0026quot;å­è¿›ç¨‹è¯»å–æ•°æ®...\\n\u0026quot;); n = read(fd[0], line, sizeof(line)); write(STDOUT_FILENO, line, n); } exit(0); } int main() { parent_to_child_pipe(); } è¿è¡Œç»“æœï¼š\nâœ ./pipe çˆ¶è¿›ç¨‹å‘é€æ•°æ®... å­è¿›ç¨‹è¯»å–æ•°æ®... hello world å‘½åç®¡é“ å‘½åç®¡é“ï¼ˆFIFOï¼‰å¯ä»¥ç”¨äºä»»æ„ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚è¦æƒ³ä½¿ç”¨ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª FIFO æ–‡ä»¶ï¼Œä¹‹åå¯ä»¥é€šè¿‡å¯¹å…¶çš„è¯»å†™æ¥å®Œæˆé€šä¿¡æ“ä½œã€‚\nä¸ºäº†ä½“ç°å‡º ä»»æ„ä¸¤ä¸ªè¿›ç¨‹ è¿™ä¸€ç‰¹ç‚¹ï¼Œä¼šåˆ›å»ºä¸¤ä¸ª c æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ fifo_write.cï¼Œå®ƒè´Ÿè´£åˆ›å»ºä¸€ä¸ª FIFO æ–‡ä»¶å¹¶å‘å…¶ä¸­å†™å…¥ â€œHello, World!â€ï¼Œä»£ç å¦‚ä¸‹ï¼š\n#include \u0026quot;../lib/apue.h\u0026quot; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #define FIFO_NAME \u0026quot;/tmp/my_fifo\u0026quot; int main() { int res = 0; // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç®¡é“ if (access(FIFO_NAME, F_OK) == -1) { res = mkfifo(FIFO_NAME, 0777); if (res == -1) { printf(\u0026quot;mkfifo error: %s \\n\u0026quot;, strerror(errno)); return 0; } } // ä»¥åªå†™æ–¹å¼æ‰“å¼€ç®¡é“ int pipe_fd = open(FIFO_NAME, O_WRONLY); if (pipe_fd == -1) { printf(\u0026quot;open fifo error: %s \\n\u0026quot;, strerror(errno)); return 0; } char buf[1024]; memset(\u0026amp;buf, '\\0', 1024); strcpy(buf, \u0026quot;Hello, World!\u0026quot;); // å‘ fifo ä¸­å†™å…¥æ•°æ® int n = write(pipe_fd, buf, sizeof(buf)); if (n \u0026lt; 0) { printf(\u0026quot;write data to fifo error: %s \\n\u0026quot;, strerror(errno)); return 0; } printf(\u0026quot;process %d write %d bytes to fifo \\n\u0026quot;, getpid(), n); } å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ fifo_read.cï¼Œå®ƒè´Ÿè´£ä» FIFO ç®¡é“ä¸­è¯»å–æ•°æ®ï¼š\n// // Created by zz on 2021/8/6. // #include \u0026quot;../lib/apue.h\u0026quot; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #define FIFO_NAME \u0026quot;/tmp/my_fifo\u0026quot; int main() { // åªè¯»æ–¹å¼æ‰“å¼€ç®¡é“ int pipe_fd = open(FIFO_NAME, O_RDONLY); if (pipe_fd == -1) { printf(\u0026quot;open fifo error: %s \\n\u0026quot;, strerror(errno)); return 0; } char buf[1024]; memset(\u0026amp;buf, '\\0', 1024); // ä»ç®¡é“ä¸­è¯»å–æ•°æ® int n = read(pipe_fd, buf, 1024); if (n \u0026lt; 0) { printf(\u0026quot;read data from fifo error: %s \\n\u0026quot;, strerror(errno)); return 0; } printf(\u0026quot;process %d read from fifo: %s \\n\u0026quot;, getpid(), buf); } æ³¨æ„ä¸Šé¢çš„ä»£ç åˆ›å»ºçš„æ˜¯ é˜»å¡ å‘½åç®¡é“ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š\nå…ˆè¿è¡Œ fifo_write.cï¼š\n# ç¼–è¯‘ fifo_write.c âœ gcc -o fw fifo_write.c ../lib/apue.c # è¿è¡Œ ./fw # è¿è¡Œåï¼Œå‘ç°æ•´ä¸ªç¨‹åºé˜»å¡äº†ï¼Œæ²¡æœ‰ä»»ä½•ååº” å†åˆ›å»ºä¸€ä¸ª terminalï¼Œè¿è¡Œ fifo_read.c\n# ç¼–è¯‘ âœ gcc -o fr fifo_read.c ../lib/apue.c # è¿è¡Œ ./fr # è¾“å‡ºç»“æœ process 7601 read from fifo: Hello, World! æ­¤æ—¶å†çœ‹ fifo_write çš„ terminalï¼Œå‘ç°å·²ç»åœæ­¢é˜»å¡äº†ï¼š\nprocess 7517 write 1024 bytes to fifo æ˜¯ä¸æ˜¯å‘ç°å®åç®¡é“å’Œ Go ä¸­çš„æ— ç¼“å†² channel éå¸¸ç›¸ä¼¼å‘¢ï¼Ÿå½“å‘ channel å†™å…¥æ•°æ®æ—¶ï¼Œæ•´ä¸ª goroutine ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°æœ‰å¦å¤–ä¸€ä¸ª goroutine ä»è¯¥ channel ä¸­å–å‡ºæ•°æ®ï¼Œæ‰ä¼šåœæ­¢é˜»å¡ã€‚ä» channel ä¸­è¯»å–æ•°æ®ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰ channel ä¸­å­˜åœ¨æ•°æ®æ‰èƒ½è¯»å–ï¼Œå¦åˆ™å°±ä¼šè¿›å…¥é˜»å¡ã€‚\næ¶ˆæ¯é˜Ÿåˆ— ï¼ˆå†…å®¹æ¥è‡ª https://blog.csdn.net/ljianhui/article/details/10287879ï¼‰\næ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†ä¸€ç§ä»ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªæ•°æ®å—çš„æ–¹æ³•ã€‚ æ¯ä¸ªæ•°æ®å—éƒ½è¢«è®¤ä¸ºå«æœ‰ä¸€ä¸ªç±»å‹ï¼Œæ¥æ”¶è¿›ç¨‹å¯ä»¥ç‹¬ç«‹åœ°æ¥æ”¶å«æœ‰ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘é€æ¶ˆæ¯æ¥é¿å…å‘½åç®¡é“çš„åŒæ­¥å’Œé˜»å¡é—®é¢˜ã€‚ä½†æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“ä¸€æ ·ï¼Œæ¯ä¸ªæ•°æ®å—éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ã€‚\nLinux ç”¨å® MSGMAX å’Œ MSGMNB æ¥é™åˆ¶ä¸€æ¡æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦å’Œä¸€ä¸ªé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚\næ¶ˆæ¯é˜Ÿåˆ—çš„ API msgget å‡½æ•° è¯¥å‡½æ•°ç”¨æ¥åˆ›å»ºå’Œè®¿é—®ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒçš„åŸå‹ä¸ºï¼š int msgget(key_t key, int msgflg); ä¸å…¶ä»–çš„ IPC æœºåˆ¶ä¸€æ ·ï¼Œç¨‹åºå¿…é¡»æä¾›ä¸€ä¸ªé”®æ¥å‘½åæŸä¸ªç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚msgflg æ˜¯ä¸€ä¸ªæƒé™æ ‡å¿—ï¼Œè¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—çš„è®¿é—®æƒé™ï¼Œå®ƒä¸æ–‡ä»¶çš„è®¿é—®æƒé™ä¸€æ ·ã€‚msgflg å¯ä»¥ä¸ IPC_CREAT åšæˆ–æ“ä½œï¼Œè¡¨ç¤ºå½“ key æ‰€å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœ key æ‰€å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—å­˜åœ¨æ—¶ï¼ŒIPC_CREAT æ ‡å¿—ä¼šè¢«å¿½ç•¥ï¼Œè€Œåªè¿”å›ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚\nå®ƒè¿”å›ä¸€ä¸ªä»¥ key å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—çš„æ ‡è¯†ç¬¦ï¼ˆéé›¶æ•´æ•°ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å›-1.\nmsgsnd å‡½æ•° è¯¥å‡½æ•°ç”¨æ¥æŠŠæ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å®ƒçš„åŸå‹ä¸ºï¼š\nint msgsend(int msgid, const void *msg_ptr, size_t msg_sz, int msgflg); msgid æ˜¯ç”± msgget å‡½æ•°è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚\nmsg_ptr æ˜¯ä¸€ä¸ªæŒ‡å‘å‡†å¤‡å‘é€æ¶ˆæ¯çš„æŒ‡é’ˆï¼Œä½†æ˜¯æ¶ˆæ¯çš„æ•°æ®ç»“æ„å´æœ‰ä¸€å®šçš„è¦æ±‚ï¼ŒæŒ‡é’ˆ msg_ptr æ‰€æŒ‡å‘çš„æ¶ˆæ¯ç»“æ„ä¸€å®šè¦æ˜¯ä»¥ä¸€ä¸ªé•¿æ•´å‹æˆå‘˜å˜é‡å¼€å§‹çš„ç»“æ„ä½“ï¼Œæ¥æ”¶å‡½æ•°å°†ç”¨è¿™ä¸ªæˆå‘˜æ¥ç¡®å®šæ¶ˆæ¯çš„ç±»å‹ã€‚æ‰€ä»¥æ¶ˆæ¯ç»“æ„è¦å®šä¹‰æˆè¿™æ ·ï¼š\nstruct my_message { long int message_type; /* The data you wish to transfer*/ }; msg_sz æ˜¯ msg_ptr æŒ‡å‘çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ³¨æ„æ˜¯æ¶ˆæ¯çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»“æ„ä½“çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´msg_sz æ˜¯ä¸åŒ…æ‹¬é•¿æ•´å‹æ¶ˆæ¯ç±»å‹æˆå‘˜å˜é‡çš„é•¿åº¦ã€‚\nmsgflg ç”¨äºæ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚\nå¦‚æœè°ƒç”¨æˆåŠŸï¼Œæ¶ˆæ¯æ•°æ®çš„ä¸€åˆ†å‰¯æœ¬å°†è¢«æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å› -1.\nmsgrcv å‡½æ•° è¯¥å‡½æ•°ç”¨æ¥ä»ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå®ƒçš„åŸå‹ä¸º\nint msgrcv(int msgid, void *msg_ptr, size_t msg_st, long int msgtype, int msgflg); msgid, msg_ptr, msg_st çš„ä½œç”¨ä¹Ÿå‡½æ•° msgsnd å‡½æ•°çš„ä¸€æ ·ã€‚\nmsgtype å¯ä»¥å®ç°ä¸€ç§ç®€å•çš„æ¥æ”¶ä¼˜å…ˆçº§ã€‚å¦‚æœ msgtype ä¸º 0ï¼Œå°±è·å–é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœå®ƒçš„å€¼å¤§äºé›¶ï¼Œå°†è·å–å…·æœ‰ç›¸åŒæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœå®ƒå°äºé›¶ï¼Œå°±è·å–ç±»å‹ç­‰äºæˆ–å°äº msgtype çš„ç»å¯¹å€¼çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚ï¼ˆps: ï¼Ÿï¼Ÿï¼Ÿè¿™é‡Œæ²¡å¤ªçœ‹æ‡‚ï¼‰\nmsgflg ç”¨äºæ§åˆ¶å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ç›¸åº”ç±»å‹çš„æ¶ˆæ¯å¯ä»¥æ¥æ”¶æ—¶å°†å‘ç”Ÿçš„äº‹æƒ…ã€‚\nè°ƒç”¨æˆåŠŸæ—¶ï¼Œè¯¥å‡½æ•°è¿”å›æ”¾åˆ°æ¥æ”¶ç¼“å­˜åŒºä¸­çš„å­—èŠ‚æ•°ï¼Œæ¶ˆæ¯è¢«å¤åˆ¶åˆ°ç”± msg_ptr æŒ‡å‘çš„ç”¨æˆ·åˆ†é…çš„ç¼“å­˜åŒºä¸­ï¼Œç„¶ååˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¯¹åº”æ¶ˆæ¯ã€‚å¤±è´¥æ—¶è¿”å› -1.\nmsgctlå‡½æ•° è¯¥å‡½æ•°ç”¨æ¥æ§åˆ¶æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒä¸å…±äº«å†…å­˜çš„ shmctl å‡½æ•°ç›¸ä¼¼ï¼Œå®ƒçš„åŸå‹ä¸ºï¼š\nint msgctl(int msgid, int command, struct msgid_ds *buf); command æ˜¯å°†è¦é‡‡å–çš„åŠ¨ä½œï¼Œå®ƒå¯ä»¥å–3ä¸ªå€¼ï¼Œ IPC_STATï¼šæŠŠ msgid_ds ç»“æ„ä¸­çš„æ•°æ®è®¾ç½®ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼ï¼Œå³ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼è¦†ç›– msgid_ds çš„å€¼ã€‚ IPC_SETï¼šå¦‚æœè¿›ç¨‹æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå°±æŠŠæ¶ˆæ¯åˆ—é˜Ÿçš„å½“å‰å…³è”å€¼è®¾ç½®ä¸º msgid_ds ç»“æ„ä¸­ç»™å‡ºçš„å€¼ IPC_RMIDï¼šåˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—\nbuf æ˜¯æŒ‡å‘ msgid_ds ç»“æ„çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼å’Œè®¿é—®æƒé™çš„ç»“æ„ã€‚msgid_ds ç»“æ„è‡³å°‘åŒ…æ‹¬ä»¥ä¸‹æˆå‘˜ï¼š\nstruct msgid_ds { uid_t shm_perm.uid; uid_t shm_perm.gid; mode_t shm_perm.mode; }; æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å› -1.\nç¤ºä¾‹ ä¸‹é¢æ˜¯ mq_recv çš„ä»£ç ï¼Œè´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ã€‚\n// // Created by zz on 2021/8/6. // #include \u0026lt;sys/msg.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; struct msg_st { long int msg_type; char text[BUFSIZ]; }; int main() { int running = 1; int msgid = -1; struct msg_st data; long int msgtype = 0; //æ³¨æ„1 // å»ºç«‹æ¶ˆæ¯é˜Ÿåˆ— msgid = msgget((key_t) 1234, 0666 | IPC_CREAT); if (msgid == -1) { fprintf(stderr, \u0026quot;msgget failed with error: %d\\n\u0026quot;, errno); exit(EXIT_FAILURE); } // ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ° end æ¶ˆæ¯ä¸ºæ­¢ while (running) { if (msgrcv(msgid, (void *) \u0026amp;data, BUFSIZ, msgtype, 0) == -1) { fprintf(stderr, \u0026quot;msgrcv failed with errno: %d\\n\u0026quot;, errno); exit(EXIT_FAILURE); } printf(\u0026quot;You wrote: %s\\n\u0026quot;, data.text); // é‡åˆ°endç»“æŸ if (strncmp(data.text, \u0026quot;end\u0026quot;, 3) == 0) running = 0; } // åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ— if (msgctl(msgid, IPC_RMID, 0) == -1) { fprintf(stderr, \u0026quot;msgctl(IPC_RMID) failed\\n\u0026quot;); exit(EXIT_FAILURE); } exit(EXIT_SUCCESS); } ä¸‹é¢æ˜¯ mq_send çš„ä»£ç ï¼Œè´Ÿè´£å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n// // Created by zz on 2021/8/6. // #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;sys/msg.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #define MAX_TEXT 512 struct msg_st { long int msg_type; char text[MAX_TEXT]; }; int main() { int running = 1; struct msg_st data; char buffer[BUFSIZ]; int msgid = -1; // å»ºç«‹æ¶ˆæ¯é˜Ÿåˆ— msgid = msgget((key_t) 1234, 0666 | IPC_CREAT); if (msgid == -1) { fprintf(stderr, \u0026quot;msgget failed with error: %d\\n\u0026quot;, errno); exit(EXIT_FAILURE); } // å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­å†™æ¶ˆæ¯ï¼Œç›´åˆ°å†™å…¥ end while (running) { //è¾“å…¥æ•°æ® printf(\u0026quot;Enter some text: \u0026quot;); fgets(buffer, BUFSIZ, stdin); data.msg_type = 1; // æ³¨æ„2 strcpy(data.text, buffer); // å‘é˜Ÿåˆ—å‘é€æ•°æ® if (msgsnd(msgid, (void *) \u0026amp;data, MAX_TEXT, 0) == -1) { fprintf(stderr, \u0026quot;msgsnd failed\\n\u0026quot;); exit(EXIT_FAILURE); } // è¾“å…¥ end ç»“æŸè¾“å…¥ if (strncmp(buffer, \u0026quot;end\u0026quot;, 3) == 0) running = 0; sleep(1); } exit(EXIT_SUCCESS); } è¿è¡Œç»“æœï¼š\nä¸ºäº†éªŒè¯æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥é¿å…å‘½åç®¡é“çš„åŒæ­¥å’Œé˜»å¡é—®é¢˜ï¼Œè¿™é‡Œå…ˆè¿è¡Œ mq_sendï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘é€ 3 æ¡æ¶ˆæ¯ï¼š\nâœ ./mq_send Enter some text: 123 Enter some text: 456 Enter some text: 789 # å‘é€äº† 3 æ¡æ¶ˆæ¯ å†å¼€å¯ä¸€ä¸ª terminal è¿è¡Œ mq_recvï¼š\nâœ ./mq_recv You wrote: 123 You wrote: 456 You wrote: 789 # ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºäº†æ¶ˆæ¯ å¦‚æœå…ˆè¿è¡Œ mq_recvï¼Œåˆ™ç¨‹åºä¼šé˜»å¡ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ã€‚\næ¶ˆæ¯ç±»å‹ ï¼ˆps: è¿™éƒ¨åˆ†å…ˆä¸å®è·µäº†ï¼‰\nè¿™é‡Œä¸»è¦è¯´æ˜ä¸€ä¸‹æ¶ˆæ¯ç±»å‹æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œæ³¨æ„ msgreceive.c æ–‡ä»¶ main å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ msgtypeï¼ˆæ³¨é‡Šä¸ºæ³¨æ„1ï¼‰ï¼Œå®ƒä½œä¸º msgrcv å‡½æ•°çš„æ¥æ”¶ä¿¡æ¯ç±»å‹å‚æ•°çš„å€¼ï¼Œå…¶å€¼ä¸º 0ï¼Œè¡¨ç¤ºè·å–é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ¶ˆæ¯ã€‚å†æ¥çœ‹çœ‹ msgsend.c æ–‡ä»¶ä¸­ while å¾ªç¯ä¸­çš„è¯­å¥ data.msg_type = 1ï¼ˆæ³¨é‡Šä¸ºæ³¨æ„2ï¼‰ï¼Œå®ƒç”¨æ¥è®¾ç½®å‘é€çš„ä¿¡æ¯çš„ä¿¡æ¯ç±»å‹ï¼Œå³å…¶å‘é€çš„ä¿¡æ¯çš„ç±»å‹ä¸º 1 ã€‚æ‰€ä»¥ç¨‹åº msgreceive èƒ½å¤Ÿæ¥æ”¶åˆ°ç¨‹åº msgsend å‘é€çš„ä¿¡æ¯ã€‚\nå¦‚æœæŠŠæ³¨æ„1ï¼Œå³ msgreceive.c æ–‡ä»¶ main å‡½æ•°ä¸­çš„è¯­å¥ç”± long int msgtype = 0; æ”¹å˜ä¸º l ong int msgtype = 2; ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Œmsgreceive å°†ä¸èƒ½æ¥æ”¶åˆ°ç¨‹åº msgsend å‘é€çš„ä¿¡æ¯ã€‚å› ä¸ºåœ¨è°ƒç”¨ msgrcv å‡½æ•°æ—¶ï¼Œå¦‚æœ msgtypeï¼ˆç¬¬å››ä¸ªå‚æ•°ï¼‰å¤§äºé›¶ï¼Œåˆ™å°†åªè·å–å…·æœ‰ç›¸åŒæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¿®æ”¹åè·å–çš„æ¶ˆæ¯ç±»å‹ä¸º2ï¼Œè€Œ msgsend å‘é€çš„æ¶ˆæ¯ç±»å‹ä¸º 1 ï¼Œæ‰€ä»¥ä¸èƒ½è¢« msgreceive ç¨‹åºæ¥æ”¶ã€‚é‡æ–°ç¼–è¯‘ msgreceive.c æ–‡ä»¶å¹¶å†æ¬¡æ‰§è¡Œï¼Œå…¶ç»“æœå¦‚ä¸‹ï¼š\næ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“çš„æ¯”è¾ƒ æ¶ˆæ¯é˜Ÿåˆ—è·Ÿå‘½åç®¡é“æœ‰ä¸å°‘çš„ç›¸åŒä¹‹å¤„ï¼Œé€šè¿‡ä¸å‘½åç®¡é“ä¸€æ ·ï¼Œæ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡çš„è¿›ç¨‹å¯ä»¥æ˜¯ä¸ç›¸å…³çš„è¿›ç¨‹ï¼ŒåŒæ—¶å®ƒä»¬éƒ½æ˜¯é€šè¿‡å‘é€å’Œæ¥æ”¶çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®çš„ã€‚åœ¨å‘½åç®¡é“ä¸­ï¼Œå‘é€æ•°æ®ç”¨ write ï¼Œæ¥æ”¶æ•°æ®ç”¨readï¼Œåˆ™åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå‘é€æ•°æ®ç”¨ msgsndï¼Œæ¥æ”¶æ•°æ®ç”¨ msgrcvã€‚è€Œä¸”å®ƒä»¬å¯¹æ¯ä¸ªæ•°æ®éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ã€‚\nä¸å‘½åç®¡é“ç›¸æ¯”ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜åŠ¿åœ¨äºï¼Œ1ã€æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯ä»¥ç‹¬ç«‹äºå‘é€å’Œæ¥æ”¶è¿›ç¨‹è€Œå­˜åœ¨ï¼Œä»è€Œæ¶ˆé™¤äº†åœ¨åŒæ­¥å‘½åç®¡é“çš„æ‰“å¼€å’Œå…³é—­æ—¶å¯èƒ½äº§ç”Ÿçš„å›°éš¾ã€‚2ã€åŒæ—¶é€šè¿‡å‘é€æ¶ˆæ¯è¿˜å¯ä»¥é¿å…å‘½åç®¡é“çš„åŒæ­¥å’Œé˜»å¡é—®é¢˜ï¼Œä¸éœ€è¦ç”±è¿›ç¨‹è‡ªå·±æ¥æä¾›åŒæ­¥æ–¹æ³•ã€‚3ã€æ¥æ”¶ç¨‹åºå¯ä»¥é€šè¿‡æ¶ˆæ¯ç±»å‹æœ‰é€‰æ‹©åœ°æ¥æ”¶æ•°æ®ï¼Œè€Œä¸æ˜¯åƒå‘½åç®¡é“ä¸­é‚£æ ·ï¼Œåªèƒ½é»˜è®¤åœ°æ¥æ”¶ã€‚\næ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹ ä¸€æ˜¯é€šä¿¡ä¸åŠæ—¶ï¼ŒäºŒæ˜¯é™„ä»¶ä¹Ÿæœ‰å¤§å°é™åˆ¶ï¼Œè¿™åŒæ ·ä¹Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡ä¸è¶³çš„ç‚¹ã€‚\næ¶ˆæ¯é˜Ÿåˆ—ä¸é€‚åˆæ¯”è¾ƒå¤§æ•°æ®çš„ä¼ è¾“ï¼Œå› ä¸ºåœ¨å†…æ ¸ä¸­æ¯ä¸ªæ¶ˆæ¯ä½“éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ï¼ŒåŒæ—¶æ‰€æœ‰é˜Ÿåˆ—æ‰€åŒ…å«çš„å…¨éƒ¨æ¶ˆæ¯ä½“çš„æ€»é•¿åº¦ä¹Ÿæ˜¯æœ‰ä¸Šé™ã€‚åœ¨ Linux å†…æ ¸ä¸­ï¼Œä¼šæœ‰ä¸¤ä¸ªå®å®šä¹‰ MSGMAX å’Œ MSGMNBï¼Œå®ƒä»¬ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œåˆ†åˆ«å®šä¹‰äº†ä¸€æ¡æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦å’Œä¸€ä¸ªé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚\næ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„æ•°æ®æ‹·è´å¼€é”€ï¼Œå› ä¸ºè¿›ç¨‹å†™å…¥æ•°æ®åˆ°å†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ç”Ÿä»ç”¨æˆ·æ€æ‹·è´æ•°æ®åˆ°å†…æ ¸æ€çš„è¿‡ç¨‹ï¼ŒåŒç†å¦ä¸€è¿›ç¨‹è¯»å–å†…æ ¸ä¸­çš„æ¶ˆæ¯æ•°æ®æ—¶ï¼Œä¼šå‘ç”Ÿä»å†…æ ¸æ€æ‹·è´æ•°æ®åˆ°ç”¨æˆ·æ€çš„è¿‡ç¨‹ã€‚\nsocket å¦‚æœ socket ç±»å‹ä¸º TCP å’Œ UDP ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ä¸åŒä¸»æœºçš„è¿›ç¨‹é—´è¿›è¡Œé€šä¿¡ã€‚ å¦‚æœ socket ç±»å‹ä¸º UNIXï¼Œå¯ä»¥åœ¨åŒä¸€ä¸»æœºä¸‹çš„è¿›ç¨‹é—´é€šä¿¡ã€‚ TCP å’Œ UDP æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹ UNIXï¼Œä»£ç ç¤ºä¾‹é‡‡ç”¨ Goï¼š\nunxi_write\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; \u0026quot;os\u0026quot; ) func main() { filename := \u0026quot;/tmp/gounix.sock\u0026quot; l, err := net.Listen(\u0026quot;unix\u0026quot;, filename) if err != nil { log.Println(\u0026quot;listen error: \u0026quot;, err) os.Remove(filename)\t// å‡ºç°é”™è¯¯ä¸€èˆ¬æ˜¯å› ä¸ºæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤ return } log.Println(\u0026quot;åˆ›å»º UNIX Domain Socket æˆåŠŸ\u0026quot;) defer l.Close() for { conn, err := l.Accept() if err != nil { log.Println(\u0026quot;accept error: \u0026quot;, err) continue } // å‘ unix æ–‡ä»¶ä¸­å†™å…¥æ•°æ® conn.Write([]byte(\u0026quot;Hello, World!\u0026quot;)) } } unix_read\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; ) func main() { filename := \u0026quot;/tmp/gounix.sock\u0026quot; conn, err := net.Dial(\u0026quot;unix\u0026quot;, filename) if err != nil { log.Println(\u0026quot;dial error: \u0026quot;, err) return } b := make([]byte, 1024) _, err = conn.Read(b) if err != nil { log.Println(\u0026quot;read error: \u0026quot;, err) return } fmt.Printf(\u0026quot;b: %v\\n\u0026quot;, string(b)) } æ€ä¹ˆæ„Ÿè§‰ unix socket å’Œ å‘½åç®¡é“æ˜¯ä¸€æ ·çš„ã€‚ã€‚ã€‚\nä¿¡å· å‘é€è¿›ç¨‹è°ƒç”¨ kill å‘æ¥æ”¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œæ¥æ”¶è¿›ç¨‹ä½¿ç”¨ signal å¯¹è¯¥ä¿¡å·è¿›è¡Œæ³¨å†Œç›‘å¬ï¼Œå½“æ•è·åˆ°è¯¥ä¿¡å·æ—¶ï¼Œå¯ä»¥è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ æ¼”ç¤ºä»£ç å¦‚ä¸‹ï¼š\n#include \u0026lt;signal.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; // handler ç”¨æ¥å¤„ç†æ¥æ”¶åˆ°çš„ä¿¡å· void handler() { printf(\u0026quot;[parent] receive a SIGINT signal, finish the process!\\n\u0026quot;); exit(0); } int main() { int pid; pid = fork(); if (pid \u0026lt; 0) { printf(\u0026quot;fork error!\u0026quot;); return 0; } if (pid == 0) { // child printf(\u0026quot;[child] process id: %d, parent id: %d \\n\u0026quot;, getpid(), getppid()); sleep(5); // ç¡çœ  5 ç§’ // ä½¿ç”¨ kill å‡½æ•°å‘æŒ‡å®šçš„è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å· // è¿™é‡Œå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ª SIGINT ä¿¡å· kill(getppid(), SIGINT); printf(\u0026quot;[child] send a SIGINT signal\\n\u0026quot;); } else { // parent printf(\u0026quot;[parent] process id: %d \\n\u0026quot;, getpid()); printf(\u0026quot;[parent] wait signal... \\n\u0026quot;); // æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ•è·åˆ° SIGINT æ—¶ï¼Œè°ƒç”¨ handler å‡½æ•°è¿›è¡Œå¤„ç† (void) signal(SIGINT, handler); } sleep(10); // ç­‰å¾…çˆ¶å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯• } ","date":"2021å¹´08æœˆ06æ—¥","permalink":"/posts/jin-cheng-jian-tong-xin-de-fang-shi/","summary":"è¿™æ˜¯ä¸€é“é¢è¯•é«˜é¢‘é¢˜\næ— åç®¡é“ æ— åç®¡é“åªèƒ½ç”¨äºçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä»£ç å¦‚ä¸‹ï¼š\n// // Created by zz on 2021/3/5.","title":"è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼"},{"contents":" å·²çŸ¥ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ï¼Œé¢„å…ˆæŒ‰ç…§å‡åºæ’åˆ—ï¼Œç»ç”± 1 åˆ° n æ¬¡ æ—‹è½¬ åï¼Œå¾—åˆ°è¾“å…¥æ•°ç»„ã€‚ä¾‹å¦‚ï¼ŒåŸæ•°ç»„ nums = [0,1,2,4,5,6,7] åœ¨å˜åŒ–åå¯èƒ½å¾—åˆ°ï¼š è‹¥æ—‹è½¬ 4 æ¬¡ï¼Œåˆ™å¯ä»¥å¾—åˆ° [4,5,6,7,0,1,2] è‹¥æ—‹è½¬ 7 æ¬¡ï¼Œåˆ™å¯ä»¥å¾—åˆ° [0,1,2,4,5,6,7] æ³¨æ„ï¼Œæ•°ç»„ [a[0], a[1], a[2], \u0026hellip;, a[n-1]] æ—‹è½¬ä¸€æ¬¡ çš„ç»“æœä¸ºæ•°ç»„ [a[n-1], a[0], a[1], a[2], \u0026hellip;, a[n-2]] ã€‚\nç»™ä½ ä¸€ä¸ªå…ƒç´ å€¼ äº’ä¸ç›¸åŒ çš„æ•°ç»„ nums ï¼Œå®ƒåŸæ¥æ˜¯ä¸€ä¸ªå‡åºæ’åˆ—çš„æ•°ç»„ï¼Œå¹¶æŒ‰ä¸Šè¿°æƒ…å½¢è¿›è¡Œäº†å¤šæ¬¡æ—‹è½¬ã€‚è¯·ä½ æ‰¾å‡ºå¹¶è¿”å›æ•°ç»„ä¸­çš„ æœ€å°å…ƒç´  ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šnums = [3,4,5,1,2] è¾“å‡ºï¼š1 è§£é‡Šï¼šåŸæ•°ç»„ä¸º [1,2,3,4,5] ï¼Œæ—‹è½¬ 3 æ¬¡å¾—åˆ°è¾“å…¥æ•°ç»„ã€‚ ç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šnums = [4,5,6,7,0,1,2] è¾“å‡ºï¼š0 è§£é‡Šï¼šåŸæ•°ç»„ä¸º [0,1,2,4,5,6,7] ï¼Œæ—‹è½¬ 4 æ¬¡å¾—åˆ°è¾“å…¥æ•°ç»„ã€‚ ç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šnums = [11,13,15,17] è¾“å‡ºï¼š11 è§£é‡Šï¼šåŸæ•°ç»„ä¸º [11,13,15,17] ï¼Œæ—‹è½¬ 4 æ¬¡å¾—åˆ°è¾“å…¥æ•°ç»„ã€‚\næç¤ºï¼š\nn == nums.length 1 \u0026lt;= n \u0026lt;= 5000 -5000 \u0026lt;= nums[i] \u0026lt;= 5000 nums ä¸­çš„æ‰€æœ‰æ•´æ•° äº’ä¸ç›¸åŒ nums åŸæ¥æ˜¯ä¸€ä¸ªå‡åºæ’åºçš„æ•°ç»„ï¼Œå¹¶è¿›è¡Œäº† 1 è‡³ n æ¬¡æ—‹è½¬\næ–¹æ³• 1 äºŒåˆ†æ³• å’ŒåŸºæœ¬äºŒåˆ†ä¸€æ ·ï¼Œåˆå§‹å˜é‡ l ç½®äºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œr ç½®äºæœ€åä¸€ä¸ªå…ƒç´ ï¼Œm å– (l + r) \u0026raquo; 1ï¼Œé€šè¿‡åˆ¤æ–­ nums[m] å’Œ nums[l]ã€nums[r] çš„å¤§å°å…³ç³»ï¼Œæ¥åˆ¤æ–­å“ªéƒ¨åˆ†æ˜¯æœ‰åºçš„ã€‚\næ¯”å¦‚ [3, 4, 5, 1, 2]ï¼Œm = 5ï¼Œl = 3ï¼Œr = 2ï¼Œm \u0026gt; lï¼Œæ‰€ä»¥ [l, m] è¿™éƒ¨åˆ†æœ‰åºã€‚ åˆæ¯”å¦‚ [7, 0, 1, 2, 3, 4, 5]ï¼Œm = 2ï¼Œl = 7ï¼Œr = 5ï¼Œm \u0026lt; rï¼Œæ‰€ä»¥ [m, r] è¿™éƒ¨åˆ†æœ‰åºã€‚ è¿˜æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼š[0, 1, 2, 4, 5, 6, 7] æ—‹è½¬ 7 æ¬¡åï¼Œä¾ç„¶æ˜¯åŸæ•°ç»„ [0, 1, 2, 4, 5, 6, 7]ï¼Œè¿™ç§æƒ…å†µåœ¨åé¢ä¼šè¯´ã€‚\né¦–å…ˆæˆ‘ä»¬å‡è®¾å½“å‰æ•°ç»„æ˜¯ä¸€ä¸ªå¸¸è§„çš„æ—‹è½¬æ•°ç»„ï¼Œæ¯”å¦‚ [3, 4, 5, 1, 2]ï¼Œè¿™ç§æ—‹è½¬æ•°ç»„æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šæ•´ä¸ªæ•°ç»„è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªæœ‰åºå­æ•°ç»„ï¼Œå¤§çš„å­æ•°ç»„åœ¨å‰é¢ï¼Œå°çš„åœ¨åé¢ã€‚é¢˜ç›®è¦æ‰¾çš„æ˜¯æœ€å°å€¼ï¼Œè¯¥å€¼åªå¯èƒ½æ˜¯è¾ƒå°å­æ•°ç»„çš„ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥æ¨æ–­å‡ºä»¥ä¸‹ç­–ç•¥ï¼š\nå¦‚æœ nums[m] \u0026lt; nums[r]ï¼Œåˆ™ä»£è¡¨ [m, r] è¿™éƒ¨åˆ†æœ‰åºï¼Œæ—¢ç„¶æœ‰åºï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†ä¸­æœ€å°çš„ä¾¿æ˜¯ mï¼Œä¸¾ä¸ªä¾‹å­ï¼š [7, 0, 1, 2, 3, 4, 5, 6]ï¼Œl = 7ï¼Œm = 2ï¼Œr = 6ï¼Œä»£è¡¨ [m, r] è¿™éƒ¨åˆ†æœ‰åºï¼Œå³ [2, 3, 4, 5, 6] è¿™éƒ¨åˆ†ï¼Œå…¶ä¸­æœ€å°çš„æ˜¯ m = 2ã€‚ ä½†æ˜¯ m ä»…ä»…æ˜¯è¿™éƒ¨åˆ†ä¸­çš„æœ€å°å€¼ï¼Œæœªå¿…æ˜¯æ•´ä¸ªæ•°ç»„ä¸­çš„æœ€å°å€¼ï¼Œå®ƒçš„å‰é¢ä»ç„¶å¯èƒ½å­˜åœ¨æ›´å°çš„å€¼ã€‚æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ•´ä¸ªæ•°ç»„ä¸­æœ€å°çš„æ˜¯ 0ã€‚ æ‰€ä»¥æ­¤æ—¶çš„ä¸‹ä¸€æ­¥åšæ³•æ˜¯ï¼šå°† r ç§»åŠ¨åˆ° mï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸èƒ½ç§»åŠ¨åˆ° m - 1 å‘¢ï¼Ÿå› ä¸º m ä¹Ÿå¯èƒ½æ˜¯æœ€å°çš„æ•°ï¼Œæ¯”å¦‚ [3, 4, 0, 1, 2] è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœ r ç§»åŠ¨åˆ° m - 1ï¼Œç§»åŠ¨åˆ°äº† 4ï¼Œè¿™æ ·å°±å·²ç»é”™è¿‡æ­£ç¡®ç­”æ¡ˆäº†ã€‚\nå¦‚æœ nums[m] \u0026gt; nums[l]ï¼Œåˆ™ä»£è¡¨ [l, m] è¿™éƒ¨åˆ†æœ‰åºï¼Œå®ƒä»¬åœ¨æ•°ç»„çš„å·¦è¾¹ï¼ˆå¸¸è§„æ—‹è½¬æ•°ç»„ï¼‰ï¼Œè¿™æ„å‘³ç€å®ƒä»¬æ˜¯æ•°ç»„ä¸­è¾ƒå¤§çš„é‚£éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š [3, 4, 5, 1, 2]ï¼Œl = 3ï¼Œr = 2ï¼Œm = 5ï¼Œ[l, r] è¿™éƒ¨åˆ†æœ‰åºï¼Œå³ [3, 4, 5] è¿™éƒ¨åˆ†ï¼Œå®ƒä»¬åœ¨æ•°ç»„ä¸­æ˜¯è¾ƒå¤§çš„éƒ¨åˆ†ï¼Œç”±äºæœ€å°å€¼åªå¯èƒ½æ˜¯è¾ƒå°å­æ•°ç»„çš„ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å¿…ç„¶æ²¡æœ‰æœ€å°å€¼ï¼Œå°† l ç§»åŠ¨åˆ° m + 1 å¤„ï¼ˆè¿™é‡Œå’Œ nums[m] \u0026lt; nums[r] çš„ç­–ç•¥ä¸åŒäº†ï¼‰ã€‚\nç‰¹æ®Šæƒ…å†µï¼š[0, 1, 2, 3, 4, 5, 6, 7]ï¼Œæ­¤æ—¶å¤„ç†ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦å…ˆåˆ¤æ–­ nums[m] \u0026lt; nums[r] å…³ç³»å³å¯ï¼Œè¿™æ · r å°±ä¼šä» 7 ç§»åŠ¨åˆ° 3ï¼Œå¿½ç•¥äº†å³è¾¹é‚£äº›è¾ƒå¤§å…ƒç´ ã€‚\nè§£å†³äº† l å’Œ r ç§»åŠ¨çš„ç­–ç•¥ï¼Œå‰©ä¸‹çš„å°±æ˜¯é—®é¢˜å°±æ˜¯ä½•æ—¶è¿”å›ä½•å€¼ï¼Œé€šè¿‡å‡ ä¸ªä¾‹å­åˆ†æå‡ºç»“è®ºï¼š [7, 0, 1, 2, 3, 4, 5]ï¼Œåœ¨ n æ¬¡å¾ªç¯åï¼Œlï¼Œrï¼Œm éƒ½å¤„äºå…ƒç´  0 å¤„ã€‚ [6, 7, 0, 1, 2, 3, 4, 5]ï¼Œåœ¨ n æ¬¡å¾ªç¯åï¼Œlï¼Œm å¤„äºå…ƒç´  0 å¤„ï¼Œr åœ¨å…ƒç´  1 å¤„ã€‚ [5, 6, 7, 0, 1, 2, 3, 4,]ï¼Œåœ¨ n æ¬¡å¾ªç¯åï¼Œlï¼Œrï¼Œm éƒ½å¤„äºå…ƒç´  0 å¤„ã€‚ [0, 1, 2, 3, 4, 5, 6, 7]ï¼Œåœ¨ n æ¬¡å¾ªç¯åï¼Œlï¼Œm å¤„äºå…ƒç´  0 å¤„ï¼Œr æ­¤æ—¶åœ¨ä¸‹æ ‡ [-1] å¤„ã€‚\nè§‚å¯Ÿå‘ç°ï¼Œæœ€ç»ˆéƒ½æ˜¯ l æŒ‡å‘æœ€å°å…ƒç´ ï¼Œä¸”æ­¤æ—¶ l å’Œ r çš„å…³ç³»æ˜¯ l \u0026gt;= r ï¼Œæ‰€ä»¥å¯ä»¥å¾—å‡ºç»“è®ºï¼šå¾ªç¯æ¨å‡ºæ¡ä»¶ä¸º l \u0026gt;= rï¼Œæœ€ç»ˆç»“æœè¿”å›ä¸º nums[l]ã€‚\nä»£ç å¦‚ä¸‹ï¼š\nfunc findMin(nums []int) int { l, r := 0, len(nums) - 1 for l \u0026lt; r { m := (l + r) \u0026gt;\u0026gt; 1 if nums[m] \u0026lt; nums[r] { r = m } else if nums[m] \u0026gt;= nums[l] { l = m + 1 } } return nums[l] } ","date":"2021å¹´08æœˆ06æ—¥","permalink":"/posts/leetcode-153-xun-zhao-xuan-zhuan-pai-xu-shu-zu-zhong-de-zui-xiao-zhi/","summary":"å·²çŸ¥ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ï¼Œé¢„å…ˆæŒ‰ç…§å‡åºæ’åˆ—ï¼Œç»ç”± 1 åˆ° n æ¬¡ æ—‹è½¬ åï¼Œå¾—åˆ°è¾“å…¥æ•°ç»„ã€‚ä¾‹å¦‚ï¼ŒåŸæ•°ç»„ nums = [0,1,2,4,5,6,7] åœ¨å˜åŒ–åå¯èƒ½å¾—åˆ°ï¼š è‹¥æ—‹è½¬ 4 æ¬¡ï¼Œåˆ™å¯ä»¥å¾—åˆ° [4,5,6,7,0,1,2] è‹¥æ—‹è½¬ 7 æ¬¡ï¼Œåˆ™å¯ä»¥å¾—åˆ° [0,1,2,4,5,6,7] æ³¨æ„ï¼Œæ•°ç»„ [a[0], a[1], a[2], \u0026hellip;, a[n-1]] æ—‹è½¬ä¸€æ¬¡ çš„ç»“æœä¸ºæ•°ç»„ [a[n-1], a[0], a[1], a[2], \u0026hellip;, a[n-2]] ã€‚","title":"leetcode 153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼"},{"contents":"é¦–å…ˆæ˜ç¡®å‡ ä¸ªæ¦‚å¿µ é€»è¾‘åœ°å€ï¼šæ˜¯ç¨‹åºç¼–è¯‘åï¼Œç”Ÿæˆçš„ç›®æ ‡æ¨¡å—è¿›è¡Œç¼–å€æ—¶éƒ½æ˜¯ä»0å·å•å…ƒå¼€å§‹ç¼–å€ï¼Œç§°ä¹‹ä¸ºç›®æ ‡æ¨¡å—çš„ç›¸å¯¹åœ°å€ï¼Œå³ä¸ºé€»è¾‘åœ°å€ã€‚\né¡µï¼šå°†è™šæ‹Ÿå†…å­˜åˆ’åˆ†çš„å—ï¼Œå¯¹åº”çš„å¤§å°å°±å«é¡µé¢å¤§å°ã€‚\né¡µæ¡†ï¼šå°†ç‰©ç†å†…å­˜åˆ’åˆ†çš„å—ã€‚\né¡µå’Œé¡µæ¡†äºŒè€…ä¸€ä¸€å¯¹åº”ï¼Œä¸€ä¸ªé¡µæ”¾å…¥ä¸€ä¸ªé¡µæ¡†ï¼Œï¼ˆç†è®ºä¸Šï¼‰é¡µçš„å¤§å°å’Œé¡µæ¡†çš„å¤§å°ç›¸ç­‰ã€‚\né¡µè¡¨ï¼šå°±æ˜¯ä¸€ä¸ªé¡µå’Œé¡µæ¡†ä¸€ä¸€å¯¹åº”çš„å…³ç³»è¡¨ã€‚ã€å­˜æ”¾åœ¨å†…å­˜ä¸­ã€‘ å…³ç³»è¡¨åªæ˜¯èµ·åˆ°ä¸€ä¸ªç´¢å¼•çš„ä½œç”¨ï¼Œè¯´ç™½äº†å°±æ˜¯èƒ½æ ¹æ®å…³ç³»è¡¨èƒ½æŸ¥åˆ°æŸä¸€ä¸ªé¡µé¢å’Œå“ªä¸€ä¸ªé¡µæ¡†æ‰€å¯¹åº”ã€‚\nä¸€çº§é¡µè¡¨ æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€é¡µä¸€èˆ¬ä¸º 4 KBï¼Œæ‰€ä»¥åœ¨ 4 GB ï¼ˆ32 ä½ç³»ç»Ÿï¼‰ä¸‹ä¸€å…±æœ‰ 4 GB / 4 KB = 4 GB * 1024 (4096 MB) * 1024(4194304KB) / 4KB = 1048576 ä¸ªé¡µï¼Œæ¯ä¸ªé¡µéœ€è¦ä¸€ä¸ª PTE æ¥ä¿å­˜æ˜ å°„ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦å’Œé¡µåŒç­‰æ•°é‡çš„ 1048576 ä¸ª PTEï¼Œæ¯ä¸ª PTE å  4 byteï¼Œä¸€å…±éœ€è¦ 4 MB çš„å†…å­˜ã€‚\næ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œå¦‚æœå½“å‰æœ‰ 100 ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆä»…ä»…æ˜¯é¡µè¡¨å°±å ç”¨äº† 400 MB çš„å†…å­˜ï¼Œè¿™è¿˜æ˜¯åœ¨ 32 ä½ä¸‹çš„æƒ…å†µï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ä¼šå ç”¨æ›´å¤šã€‚\næ­¤å¤–ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸€èˆ¬è€Œè¨€ä¸ä¼šå ç”¨è¿™ä¹ˆå¤šçš„å†…å­˜ï¼ˆ4 GBï¼Œæ•´æ•´å æ»¡ï¼‰ï¼Œæ‰€ä»¥å…¶é¡µè¡¨ä¸­ä¼šæœ‰ä¸€äº›é¡µè¡¨é¡¹å¹¶æœªæ˜ å°„ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯å´ä¾ç„¶å ç”¨äº†å†…å­˜ï¼Œè¿™æ˜¾ç„¶ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ã€‚\nå¤šçº§é¡µè¡¨ å›¾ç‰‡æ¥æºï¼šhttps://www.cnblogs.com/xiaolincoding/p/13213699.html\nåœ¨ä¸€çº§é¡µè¡¨ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ 32 ä½å’Œé¡µå¤§å° 4KB çš„ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹çš„é¡µè¡¨éœ€è¦è£…ä¸‹ 1048576 ï¼ˆ1024 * 1024ï¼‰ä¸ªé¡µè¡¨é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™å•ä¸ªé¡µè¡¨é¡¹æ‹†åˆ†ä¸ºäºŒçº§é¡µè¡¨ï¼Œç¬¬ä¸€çº§é¡µè¡¨æœ‰ 1024 ä¸ªé¡µè¡¨é¡¹ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹æŒ‡å‘ä¸€ä¸ªäºŒçº§é¡µè¡¨ï¼Œæ¯ä¸ªäºŒçº§é¡µè¡¨é¡¹åŒ…å«äº† 1024 ä¸ªé¡µè¡¨é¡¹ï¼Œç®—ä¸‹æ¥ä¹Ÿæ˜¯ 1024 * 1024 ä¸ªé¡µè¡¨é¡¹ã€‚\né‚£ä¹ˆäºŒçº§é¡µè¡¨æ˜¯å¦‚ä½•è§£å†³ä¸€çº§é¡µè¡¨å­˜åœ¨çš„å†…å­˜å ç”¨é—®é¢˜çš„å‘¢ï¼Ÿåœ¨äºŒçº§é¡µè¡¨ä¸­ï¼Œç¬¬ä¸€çº§é¡µè¡¨æœ‰ 1024 ä¸ªé¡µè¡¨é¡¹ï¼Œå…±å ç”¨ 4 KB å†…å­˜ï¼Œå¦‚æœå½“å‰é¡µè¡¨é¡¹æœ‰è¢«æ˜ å°„ï¼Œé‚£ä¹ˆå°±ç»§ç»­åˆ›å»ºå…¶å¯¹åº”çš„äºŒçº§é¡µè¡¨ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå½“å‰é¡µè¡¨é¡¹æ²¡æœ‰è¢«æ˜ å°„ï¼Œå°±ä¸åˆ›å»ºäºŒçº§é¡µè¡¨ï¼Œç›¸åº”çš„å†…å­˜å°±çœä¸‹äº†ã€‚åšä¸ªç®€å•çš„è®¡ç®—ï¼Œå‡è®¾åªæœ‰ 20% çš„ä¸€çº§é¡µè¡¨é¡¹è¢«ç”¨åˆ°äº†ï¼Œé‚£ä¹ˆé¡µè¡¨å ç”¨çš„å†…å­˜ç©ºé—´å°±åªæœ‰ 4KBï¼ˆä¸€çº§é¡µè¡¨ï¼‰ + 20% * 4MBï¼ˆäºŒçº§é¡µè¡¨ï¼‰= 0.804MBï¼Œè¿™å¯¹æ¯”å•çº§é¡µè¡¨çš„ 4MB æ˜¯ä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„èŠ‚çº¦ï¼Ÿ\nå†æ¥çœ‹çœ‹ æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ ä¸­çš„ ç¬¬ 9.6.3 èŠ‚ å¤šçº§é¡µè¡¨ ä¸­æ˜¯å¦‚ä½•æè¿°çš„ï¼š åœ¨ä¸Šå›¾ä¸­ï¼Œç‰‡ 2 åˆ° 7 æ˜¯æœªè¢«åˆ†é…çš„ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨ç‰‡ i ä¸­è‡³å°‘æœ‰ä¸€ä¸ªé¡µæ˜¯åˆ†é…äº†çš„ï¼Œé‚£ä¹ˆä¸€çº§ PTE i å°±æŒ‡å‘ ä¸€ä¸ªäºŒçº§é¡µè¡¨çš„åŸºå€ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œç‰‡0ã€ 1 å’Œ 8çš„ æ‰€æœ‰æˆ–è€…éƒ¨åˆ†å·²è¢«åˆ†é…ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä¸€çº§ PTE å°±æŒ‡å‘äºŒçº§é¡µè¡¨ã€‚\nè¿™ç§æ–¹æ³•ä»ä¸¤ä¸ªæ–¹é¢å‡å°‘äº†å†…å­˜è¦æ±‚ã€‚ç¬¬ä¸€ ï¼Œå¦‚æœä¸€çº§é¡µè¡¨ä¸­çš„ä¸€ä¸ª PTE æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›¸åº”çš„äºŒçº§é¡µè¡¨å°±æ ¹æœ¬ä¸ä¼šå­˜åœ¨ã€‚è¿™ä»£è¡¨ç€ä¸€ç§å·¨å¤§çš„æ½œåœ¨èŠ‚çº¦ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªå…¸å‹çš„ç¨‹åºï¼Œ4GB çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¤§éƒ¨åˆ†éƒ½ä¼šæ˜¯æœªåˆ†é…çš„ã€‚ç¬¬äºŒï¼Œåªæœ‰ä¸€çº§é¡µè¡¨æ‰éœ€è¦æ€»æ˜¯åœ¨ä¸»å­˜ä¸­ï¼›è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå¯ä»¥åœ¨éœ€è¦æ—¶åˆ›å»ºã€é¡µé¢è°ƒå…¥æˆ–è°ƒå‡ºäºŒçº§é¡µè¡¨ï¼Œè¿™å°±å‡å°‘äº†ä¸»å­˜çš„å‹åŠ›ï¼›åªæœ‰æœ€ç»å¸¸ä½¿ç”¨çš„äºŒçº§é¡µè¡¨æ‰éœ€è¦ç¼“å­˜åœ¨ä¸»å­˜ä¸­ ã€‚\n","date":"2021å¹´08æœˆ05æ—¥","permalink":"/posts/duo-ji-ye-biao/","summary":"é¦–å…ˆæ˜ç¡®å‡ ä¸ªæ¦‚å¿µ é€»è¾‘åœ°å€ï¼šæ˜¯ç¨‹åºç¼–è¯‘åï¼Œç”Ÿæˆçš„ç›®æ ‡æ¨¡å—è¿›è¡Œç¼–å€æ—¶éƒ½æ˜¯ä»0å·å•å…ƒå¼€å§‹ç¼–å€ï¼Œç§°ä¹‹ä¸ºç›®æ ‡æ¨¡å—çš„ç›¸å¯¹åœ°å€ï¼Œå³ä¸ºé€»è¾‘åœ°å€ã€‚\né¡µï¼šå°†è™šæ‹Ÿå†…å­˜åˆ’åˆ†çš„å—ï¼Œå¯¹åº”çš„å¤§å°å°±å«é¡µé¢å¤§å°ã€‚\né¡µæ¡†ï¼šå°†ç‰©ç†å†…å­˜åˆ’åˆ†çš„å—ã€‚\né¡µå’Œé¡µæ¡†äºŒè€…ä¸€ä¸€å¯¹åº”ï¼Œä¸€ä¸ªé¡µæ”¾å…¥ä¸€ä¸ªé¡µæ¡†ï¼Œï¼ˆç†è®ºä¸Šï¼‰é¡µçš„å¤§å°å’Œé¡µæ¡†çš„å¤§å°ç›¸ç­‰ã€‚","title":"å¤šçº§é¡µè¡¨ä¸ºä»€ä¹ˆèŠ‚çœå†…å­˜"},{"contents":" è¯·ä½ ä»…ä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—å®ç°ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆï¼Œå¹¶æ”¯æŒæ™®é€šæ ˆçš„å…¨éƒ¨å››ç§æ“ä½œï¼ˆpushã€topã€pop å’Œ emptyï¼‰ã€‚\nå®ç° MyStack ç±»ï¼š\nvoid push(int x) å°†å…ƒç´  x å‹å…¥æ ˆé¡¶ã€‚ int pop() ç§»é™¤å¹¶è¿”å›æ ˆé¡¶å…ƒç´ ã€‚ int top() è¿”å›æ ˆé¡¶å…ƒç´ ã€‚ boolean empty() å¦‚æœæ ˆæ˜¯ç©ºçš„ï¼Œè¿”å› true ï¼›å¦åˆ™ï¼Œè¿”å› false ã€‚\næ³¨æ„ï¼š\nä½ åªèƒ½ä½¿ç”¨é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œ â€”â€” ä¹Ÿå°±æ˜¯Â push to backã€peek/pop from frontã€size å’ŒÂ is emptyÂ è¿™äº›æ“ä½œã€‚ ä½ æ‰€ä½¿ç”¨çš„è¯­è¨€ä¹Ÿè®¸ä¸æ”¯æŒé˜Ÿåˆ—ã€‚Â ä½ å¯ä»¥ä½¿ç”¨ list ï¼ˆåˆ—è¡¨ï¼‰æˆ–è€… dequeï¼ˆåŒç«¯é˜Ÿåˆ—ï¼‰æ¥æ¨¡æ‹Ÿä¸€ä¸ªé˜Ÿåˆ—Â , åªè¦æ˜¯æ ‡å‡†çš„é˜Ÿåˆ—æ“ä½œå³å¯ã€‚\nç¤ºä¾‹ï¼š\nè¾“å…¥ï¼š [\u0026ldquo;MyStack\u0026rdquo;, \u0026ldquo;push\u0026rdquo;, \u0026ldquo;push\u0026rdquo;, \u0026ldquo;top\u0026rdquo;, \u0026ldquo;pop\u0026rdquo;, \u0026ldquo;empty\u0026rdquo;] [[], [1], [2], [], [], []] è¾“å‡ºï¼š [null, null, null, 2, 2, false]\nè§£é‡Šï¼š MyStack myStack = new MyStack(); myStack.push(1); myStack.push(2); myStack.top(); // è¿”å› 2 myStack.pop(); // è¿”å› 2 myStack.empty(); // è¿”å› False\næç¤ºï¼š\n1 \u0026lt;= x \u0026lt;= 9 æœ€å¤šè°ƒç”¨100 æ¬¡ pushã€popã€top å’Œ empty æ¯æ¬¡è°ƒç”¨ pop å’Œ top éƒ½ä¿è¯æ ˆä¸ä¸ºç©º\nè¿›é˜¶ï¼šä½ èƒ½å¦å®ç°æ¯ç§æ“ä½œçš„å‡æ‘Šæ—¶é—´å¤æ‚åº¦ä¸º O(1) çš„æ ˆï¼Ÿæ¢å¥è¯è¯´ï¼Œæ‰§è¡Œ n ä¸ªæ“ä½œçš„æ€»æ—¶é—´å¤æ‚åº¦ O(n) ï¼Œå°½ç®¡å…¶ä¸­æŸä¸ªæ“ä½œå¯èƒ½éœ€è¦æ¯”å…¶ä»–æ“ä½œæ›´é•¿çš„æ—¶é—´ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªä»¥ä¸Šçš„é˜Ÿåˆ—ã€‚\næ–¹æ³• 1 ä¸¤ä¸ªé˜Ÿåˆ— ä»£ç ï¼š\ntype MyStack struct { q1 *list.List q2 *list.List } /** Initialize your data structure here. */ func Constructor() MyStack { return MyStack{ q1: list.New(), q2: list.New(), } } /** Push element x onto stack. */ func (m *MyStack) Push(x int) { m.q2.PushBack(x) for m.q1.Len() \u0026gt; 0 { pop := m.q1.Remove(m.q1.Front()).(int) m.q2.PushBack(pop) } m.q1, m.q2 = m.q2, m.q1 } /** Removes the element on top of the stack and returns that element. */ func (m *MyStack) Pop() int { return m.q1.Remove(m.q1.Front()).(int) } /** Get the top element. */ func (m *MyStack) Top() int { return m.q1.Front().Value.(int) } /** Returns whether the stack is empty. */ func (m *MyStack) Empty() bool { return m.q1.Len() == 0 } /** * Your MyStack object will be instantiated and called as such: * obj := Constructor(); * obj.Push(x); * param_2 := obj.Pop(); * param_3 := obj.Top(); * param_4 := obj.Empty(); */ æ–¹æ³• 2 ä¸€ä¸ªé˜Ÿåˆ— å…¶å®ç”¨ä¸¤ä¸ªé˜Ÿåˆ—æœ‰äº›å¤šä½™ï¼Œåè€Œä½¿ç¨‹åºé€»è¾‘å˜å¤æ‚äº†ï¼Œåªè¦ä¸€ä¸ªé˜Ÿåˆ—å³å¯ã€‚\nä»£ç ï¼š\ntype MyStack struct { queue *list.List } /** Initialize your data structure here. */ func Constructor() MyStack { return MyStack{ queue: list.New(), } } /** Push element x onto stack. */ func (m *MyStack) Push(x int) { queueLen := m.queue.Len() m.queue.PushBack(x) for i := 0; i \u0026lt; queueLen; i++ { pop := m.queue.Remove(m.queue.Front()).(int) m.queue.PushBack(pop) } } /** Removes the element on top of the stack and returns that element. */ func (m *MyStack) Pop() int { pop := m.queue.Remove(m.queue.Front()).(int) return pop } /** Get the top element. */ func (m *MyStack) Top() int { return m.queue.Front().Value.(int) } /** Returns whether the stack is empty. */ func (m *MyStack) Empty() bool { return m.queue.Len() == 0 } /** * Your MyStack object will be instantiated and called as such: * obj := Constructor(); * obj.Push(x); * param_2 := obj.Pop(); * param_3 := obj.Top(); * param_4 := obj.Empty(); */ ","date":"2021å¹´08æœˆ04æ—¥","permalink":"/posts/leetcode-225-yong-dui-lie-shi-xian-zhan/","summary":"è¯·ä½ ä»…ä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—å®ç°ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆï¼Œå¹¶æ”¯æŒæ™®é€šæ ˆçš„å…¨éƒ¨å››ç§æ“ä½œï¼ˆpushã€topã€pop å’Œ emptyï¼‰ã€‚\nå®ç° MyStack ç±»ï¼š","title":"leetcode 225. ç”¨é˜Ÿåˆ—å®ç°æ ˆ"},{"contents":" è®¾è®¡ä¸€ä¸ªæ”¯æŒ push ï¼Œpop ï¼Œtop æ“ä½œï¼Œå¹¶èƒ½åœ¨å¸¸æ•°æ—¶é—´å†…æ£€ç´¢åˆ°æœ€å°å…ƒç´ çš„æ ˆã€‚\npush(x) â€”â€” å°†å…ƒç´  x æ¨å…¥æ ˆä¸­ã€‚ pop()Â â€”â€” åˆ é™¤æ ˆé¡¶çš„å…ƒç´ ã€‚ top()Â â€”â€” è·å–æ ˆé¡¶å…ƒç´ ã€‚ getMin() â€”â€” æ£€ç´¢æ ˆä¸­çš„æœ€å°å…ƒç´ ã€‚ ç¤ºä¾‹:\nè¾“å…¥ï¼š [\u0026ldquo;MinStack\u0026rdquo;,\u0026ldquo;push\u0026rdquo;,\u0026ldquo;push\u0026rdquo;,\u0026ldquo;push\u0026rdquo;,\u0026ldquo;getMin\u0026rdquo;,\u0026ldquo;pop\u0026rdquo;,\u0026ldquo;top\u0026rdquo;,\u0026ldquo;getMin\u0026rdquo;] [[],[-2],[0],[-3],[],[],[],[]]\nè¾“å‡ºï¼š [null,null,null,null,-3,null,0,-2]\nè§£é‡Šï¼š MinStack minStack = new MinStack(); minStack.push(-2); minStack.push(0); minStack.push(-3); minStack.getMin(); \u0026ndash;\u0026gt; è¿”å› -3. minStack.pop(); minStack.top(); \u0026ndash;\u0026gt; è¿”å› 0. minStack.getMin(); \u0026ndash;\u0026gt; è¿”å› -2.\næç¤ºï¼š\npopã€top å’Œ getMin æ“ä½œæ€»æ˜¯åœ¨ éç©ºæ ˆ ä¸Šè°ƒç”¨ã€‚\næ–¹æ³• ä¸¤ä¸ªæ ˆ ä»£ç å¦‚ä¸‹ï¼š\ntype MinStack struct { s1, s2 *list.List } /** initialize your data structure here. */ func Constructor() MinStack { return MinStack{ s1: list.New(), s2: list.New(), } } func (m *MinStack) Push(val int) { m.s1.PushBack(val) if m.s2.Len() == 0 { m.s2.PushBack(val) } else if m.s2.Len() \u0026gt; 0 \u0026amp;\u0026amp; val \u0026lt;= m.s2.Back().Value.(int) { m.s2.PushBack(val) } } func (m *MinStack) Pop() { if m.s1.Len() \u0026gt; 0 { if m.s1.Back().Value.(int) == m.s2.Back().Value.(int) { m.s2.Remove(m.s2.Back()) } m.s1.Remove(m.s1.Back()) } } func (m *MinStack) Top() int { return m.s1.Back().Value.(int) } func (m *MinStack) GetMin() int { if m.s2.Len() \u0026gt; 0 { return m.s2.Back().Value.(int) } return -1 } /** * Your MinStack object will be instantiated and called as such: * obj := Constructor(); * obj.Push(val); * obj.Pop(); * param_3 := obj.Top(); * param_4 := obj.GetMin(); */ ","date":"2021å¹´08æœˆ04æ—¥","permalink":"/posts/leetcode-155-zui-xiao-zhan/","summary":"è®¾è®¡ä¸€ä¸ªæ”¯æŒ push ï¼Œpop ï¼Œtop æ“ä½œï¼Œå¹¶èƒ½åœ¨å¸¸æ•°æ—¶é—´å†…æ£€ç´¢åˆ°æœ€å°å…ƒç´ çš„æ ˆã€‚","title":"leetcode 155. æœ€å°æ ˆ"},{"contents":" å°Qåœ¨å‘¨æœ«çš„æ—¶å€™å’Œä»–çš„å°ä¼™ä¼´æ¥åˆ°å¤§åŸå¸‚é€›è¡—ï¼Œä¸€æ¡æ­¥è¡Œè¡—ä¸Šæœ‰å¾ˆå¤šé«˜æ¥¼ï¼Œå…±æœ‰nåº§é«˜æ¥¼æ’æˆä¸€è¡Œã€‚ å°Qä»ç¬¬ä¸€æ ‹ä¸€ç›´èµ°åˆ°äº†æœ€åä¸€æ ‹ï¼Œå°Qä»æ¥éƒ½æ²¡æœ‰è§åˆ°è¿™ä¹ˆå¤šçš„æ¥¼ï¼Œæ‰€ä»¥ä»–æƒ³çŸ¥é“ä»–åœ¨æ¯æ ‹æ¥¼çš„ä½ç½®å¤„èƒ½çœ‹åˆ°å¤šå°‘æ ‹æ¥¼å‘¢ï¼Ÿï¼ˆå½“å‰é¢çš„æ¥¼çš„é«˜åº¦å¤§äºç­‰äºåé¢çš„æ¥¼æ—¶ï¼Œåé¢çš„æ¥¼å°†è¢«æŒ¡ä½ï¼‰\nè¾“å…¥ä¾‹å­1: [5,3,8,3,2,5]\nè¾“å‡ºä¾‹å­1: [3,3,5,4,4,4]\nä¾‹å­è¯´æ˜1: å½“å°Qå¤„äºä½ç½®3æ—¶ï¼Œä»–å¯ä»¥å‘å‰çœ‹åˆ°ä½ç½®2,1å¤„çš„æ¥¼ï¼Œå‘åçœ‹åˆ°ä½ç½®4,6å¤„çš„æ¥¼ï¼ŒåŠ ä¸Šç¬¬3æ ‹æ¥¼ï¼Œå…±å¯çœ‹åˆ°5æ ‹æ¥¼ã€‚å½“å°Qå¤„äºä½ç½®4æ—¶ï¼Œä»–å¯ä»¥å‘å‰çœ‹åˆ°ä½ç½®3å¤„çš„æ¥¼ï¼Œå‘åçœ‹åˆ°ä½ç½®5,6å¤„çš„æ¥¼ï¼ŒåŠ ä¸Šç¬¬4æ ‹æ¥¼ï¼Œå…±å¯çœ‹åˆ°4æ ‹æ¥¼ã€‚\nå¯¹ä¾‹å­çš„è¿›ä¸€æ­¥è¯´æ˜ï¼šä¸Šé¢æ‰€è¯´çš„ä½ç½®åºå·æ˜¯ä» 1 å¼€å§‹çš„ï¼Œæ‰€ä»¥ä½ç½® 3 çš„æ¥¼é«˜ä¸º 8ã€‚\nä» 8 çš„å·¦è¾¹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°é«˜åº¦ä¸º 5ï¼Œ3 çš„è¿™ä¸¤æ ‹æ¥¼ï¼ˆ5 åœ¨å·¦è¾¹ï¼Œ3 åœ¨å³è¾¹ï¼Œæ‰€ä»¥å…ˆçœ‹åˆ° 3 å†çœ‹åˆ° 5ï¼Œå¦‚æœæ˜¯ [3, 5, 8]ï¼Œé‚£ä¹ˆå°±åªèƒ½çœ‹åˆ° 5 è€Œçœ‹ä¸åˆ° 3 äº†ï¼Œå› ä¸ºè¢«æŒ¡ä½äº†ï¼‰ã€‚\nä» 8 çš„å³è¾¹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°é«˜åº¦ä¸º 3ï¼Œ5 çš„è¿™ä¸¤æ ‹æ¥¼ï¼Œæ³¨æ„ï¼Œåœ¨ 3ï¼Œ5 ä¹‹é—´çš„ 2 æ˜¯çœ‹ä¸åˆ°çš„ï¼Œå› ä¸ºè¢« 3 æŒ¡ä½äº†ã€‚\næœ€å°æ ˆ çœ‹è¯„è®ºé‡Œçš„ï¼Œä¸€å¼€å§‹æ²¡æƒ³åˆ°æœ€å°æ ˆçš„æ–¹æ³•\npackage main import ( \u0026quot;container/list\u0026quot; ) /** * ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åã€å‚æ•°åå·²ç»æŒ‡å®šï¼Œè¯·å‹¿ä¿®æ”¹ï¼Œç›´æ¥è¿”å›æ–¹æ³•è§„å®šçš„å€¼å³å¯ * * * @param heights intæ•´å‹ä¸€ç»´æ•°ç»„ * @return intæ•´å‹ä¸€ç»´æ•°ç»„ */ func findBuilding( heights []int ) []int { // write code here var ( res = make([]int, len(heights), len(heights)) stack = list.New() // min stack //rs := list.New() // stack l = len(heights) ) // æ¯ä¸ªä½ç½®éƒ½èƒ½çœ‹è§è‡ªå·±ï¼Œæ‰€ä»¥åˆå€¼éƒ½ä¸º 1 for i := 0; i \u0026lt; len(res); i++ { res[i] = 1 } // æ¯æ ‹æ¥¼å·¦è¾¹èƒ½çœ‹åˆ°çš„æ•°é‡ for i := 0; i \u0026lt; l-1; i++ { for stack.Len() \u0026gt; 0 \u0026amp;\u0026amp; stack.Back().Value.(int) \u0026lt;= heights[i] { stack.Remove(stack.Back()) } stack.PushBack(heights[i]) res[i+1] += stack.Len() } stack.Init() // clear stack // æ¯æ ‹æ¥¼å³è¾¹èƒ½çœ‹åˆ°çš„æ•°é‡ for i := l-1; i \u0026gt; 0; i-- { for stack.Len() \u0026gt; 0 \u0026amp;\u0026amp; stack.Back().Value.(int) \u0026lt;= heights[i] { stack.Remove(stack.Back()) } stack.PushBack(heights[i]) res[i-1] += stack.Len() } return res } æš´åŠ›æ³• è‡ªå·±å†™çš„ï¼Œè¿è¡Œè¶…æ—¶ï¼Œ5/10 ç»„ç”¨ä¾‹é€šè¿‡ï¼Œä»…åšä¿ç•™è®°å½•ï¼Œæ— å‚è€ƒä»·å€¼\npackage main /** * ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åã€å‚æ•°åå·²ç»æŒ‡å®šï¼Œè¯·å‹¿ä¿®æ”¹ï¼Œç›´æ¥è¿”å›æ–¹æ³•è§„å®šçš„å€¼å³å¯ * * * @param heights intæ•´å‹ä¸€ç»´æ•°ç»„ * @return intæ•´å‹ä¸€ç»´æ•°ç»„ */ func findBuilding( heights []int ) []int { // write code here var ( //isSelf bool res = make([]int, len(heights), len(heights)) ) for i := 0; i \u0026lt; len(heights); i++ { var curMaxHeight = -1 // // å½“å‰ä½ç½®ä¸€å…±å¯ä»¥çœ‹è§å‡ æ ‹æ¥¼ï¼Œå› ä¸ºå¯ä»¥çœ‹è§è‡ªå·±æ‰€åœ¨çš„æ¥¼ï¼Œæ‰€ä»¥åˆå€¼ä¸º 1 var total = 1 // å½“å‰ä½ç½®çš„å·¦è¾¹å¯ä»¥çœ‹è§å‡ æ ‹æ¥¼ for j := i - 1; j \u0026gt;= 0; j-- { if heights[j] \u0026lt; curMaxHeight { continue } curMaxHeight = max(heights[j], curMaxHeight) total++ } curMaxHeight = -1 // é‡ç½® // å½“å‰ä½ç½®çš„å³è¾¹ä¸€å…±å¯ä»¥çœ‹è§å‡ æ ‹æ¥¼ for j := i + 1; j \u0026lt; len(heights); j++ { if heights[j] \u0026lt; curMaxHeight { continue } curMaxHeight = max(heights[j], curMaxHeight) total++ } res[i] = total } return res } func max(x, y int) int { if x \u0026gt; y { return x } return y } ","date":"2021å¹´08æœˆ03æ—¥","permalink":"/posts/niu-ke-teng-xun-2020-bi-shi-ti-di-er-ti-guang-jie/","summary":"å°Qåœ¨å‘¨æœ«çš„æ—¶å€™å’Œä»–çš„å°ä¼™ä¼´æ¥åˆ°å¤§åŸå¸‚é€›è¡—ï¼Œä¸€æ¡æ­¥è¡Œè¡—ä¸Šæœ‰å¾ˆå¤šé«˜æ¥¼ï¼Œå…±æœ‰nåº§é«˜æ¥¼æ’æˆä¸€è¡Œã€‚ å°Qä»ç¬¬ä¸€æ ‹ä¸€ç›´èµ°åˆ°äº†æœ€åä¸€æ ‹ï¼Œå°Qä»æ¥éƒ½æ²¡æœ‰è§åˆ°è¿™ä¹ˆå¤šçš„æ¥¼ï¼Œæ‰€ä»¥ä»–æƒ³çŸ¥é“ä»–åœ¨æ¯æ ‹æ¥¼çš„ä½ç½®å¤„èƒ½çœ‹åˆ°å¤šå°‘æ ‹æ¥¼å‘¢ï¼Ÿï¼ˆå½“å‰é¢çš„æ¥¼çš„é«˜åº¦å¤§äºç­‰äºåé¢çš„æ¥¼æ—¶ï¼Œåé¢çš„æ¥¼å°†è¢«æŒ¡ä½ï¼‰\nè¾“å…¥ä¾‹å­1: [5,3,8,3,2,5]","title":"[ç‰›å®¢][è…¾è®¯2020ç¬”è¯•é¢˜] ç¬¬äºŒé¢˜. é€›è¡—"},{"contents":" è¯´æ˜ï¼šè¯¥é¢˜å‡ºè‡ªç‰›å®¢ â€”â€” è…¾è®¯2020æ ¡å›­æ‹›è˜-åå°\næ—¶é—´é™åˆ¶ï¼šC/C++ 1ç§’ï¼Œå…¶ä»–è¯­è¨€2ç§’\nç©ºé—´é™åˆ¶ï¼šC/C++ 256Mï¼Œå…¶ä»–è¯­è¨€512M\nå°Qæƒ³è¦ç»™ä»–çš„æœ‹å‹å‘é€ä¸€ä¸ªç¥ç§˜å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä»–å‘ç°å­—ç¬¦ä¸²çš„è¿‡äºé•¿äº†ï¼Œäºæ˜¯å°Qå‘æ˜äº†ä¸€ç§å‹ç¼©ç®—æ³•å¯¹å­— ç¬¦ä¸²ä¸­é‡å¤çš„éƒ¨åˆ†è¿›è¡Œäº†å‹ç¼©ï¼Œå¯¹äºå­—ç¬¦ä¸²ä¸­è¿ç»­çš„mä¸ªç›¸åŒå­—ç¬¦ä¸²Så°†ä¼šå‹ç¼©ä¸º[m|S](mä¸ºä¸€ä¸ªæ•´æ•°ä¸” 1\u0026lt;=m\u0026lt;=100)ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ABCABCABCå°†ä¼šè¢«å‹ç¼©ä¸º[3|ABC]ï¼Œç°åœ¨å°Qçš„åŒå­¦æ”¶åˆ°äº†å°Qå‘é€è¿‡æ¥çš„å­—ç¬¦ ä¸²ï¼Œä½ èƒ½å¸®åŠ©ä»–è¿›è¡Œè§£å‹ç¼©ä¹ˆï¼Ÿ\nè¾“å…¥ä¾‹å­1: \u0026ldquo;HG[3|B[2|CA]]F\u0026rdquo;\nè¾“å‡ºä¾‹å­1: \u0026ldquo;HGBCACABCACABCACAF\u0026rdquo;\nä¾‹å­è¯´æ˜1: HG[3|B[2|CA]]F âˆ’\u0026gt; HG[3|BCACA]F âˆ’\u0026gt; HGBCACABCACABCACAF\nä»£ç  è¿™é“é¢˜å’Œ leetcode 394. å­—ç¬¦ä¸²è§£ç  åŸºæœ¬ç›¸ä¼¼ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª â€œ|â€ ç¬¦å·ï¼Œåªè¦æ·»åŠ  â€œ|â€ å¯¹åº”çš„é€»è¾‘å³å¯ï¼Œè§‚å¯Ÿå‘ç° â€œ|â€ æ˜¯åœ¨æ•°å­—ä¹‹åå‡ºç°çš„ï¼Œæ‰€ä»¥éå†åˆ° â€œ|â€ æ—¶éœ€è¦å°†å½“å‰æ•°å­—å˜é‡æ·»åŠ åˆ°æ•°å­—æ ˆï¼ŒåŒæ—¶å°†å½“å‰æ•°å­—å˜é‡ç½® 0ã€‚ åŒæ—¶ä¹Ÿéœ€è¦æ›´æ”¹é‡åˆ° â€œ[â€ æ—¶çš„é€»è¾‘ï¼Œæ­¤æ—¶åªéœ€è¦æ·»åŠ å½“å‰å­—ç¬¦ä¸²å˜é‡åˆ°å­—ç¬¦ä¸²æ ˆï¼Œå¹¶æ¸…ç©ºå½“å‰å­—ç¬¦ä¸²å˜é‡ã€‚å¯ä»¥å‚è€ƒ lc394 çš„æ€è·¯ï¼š https://zengh1.github.io/post/leetcode-394-zi-fu-chuan-jie-ma/ã€‚\npackage main import ( \u0026quot;container/list\u0026quot; \u0026quot;unicode\u0026quot; \u0026quot;strings\u0026quot; ) /** * ä»£ç ä¸­çš„ç±»åã€æ–¹æ³•åã€å‚æ•°åå·²ç»æŒ‡å®šï¼Œè¯·å‹¿ä¿®æ”¹ï¼Œç›´æ¥è¿”å›æ–¹æ³•è§„å®šçš„å€¼å³å¯ * * * @param str stringå­—ç¬¦ä¸² * @return stringå­—ç¬¦ä¸² */ func compress( str string ) string { // write code here mulstack := list.New() // ä¿å­˜æ•°å­—çš„æ ˆ letstack := list.New() // ä¿å­˜å­—æ¯çš„æ ˆ var ( mul int res strings.Builder ) for _, c := range str { if unicode.IsLetter(c) { res.WriteRune(c) } else if unicode.IsNumber(c) { mul = mul*10 + int(c-'0') } else if c == '[' { letstack.PushBack(res.String()) res.Reset() } else if c == '|' { mulstack.PushBack(mul) mul = 0 } else if c == ']' { popmul := mulstack.Remove(mulstack.Back()).(int) var temp string for i := 0; i \u0026lt; popmul; i++ { temp += res.String() } popchar := letstack.Remove(letstack.Back()).(string) res.Reset() res.WriteString(popchar + temp) } } return res.String() } ","date":"2021å¹´08æœˆ03æ—¥","permalink":"/posts/teng-xun-2020-bi-shi-ti-ya-suo-suan-fa/","summary":"è¯´æ˜ï¼šè¯¥é¢˜å‡ºè‡ªç‰›å®¢ â€”â€” è…¾è®¯2020æ ¡å›­æ‹›è˜-åå°\næ—¶é—´é™åˆ¶ï¼šC/C++ 1ç§’ï¼Œå…¶ä»–è¯­è¨€2ç§’","title":"[ç‰›å®¢][è…¾è®¯2020ç¬”è¯•é¢˜] ç¬¬ä¸€é¢˜. å‹ç¼©ç®—æ³•"},{"contents":"RDB RDB å¯ä»¥å°†æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ä¸€ä¸ª RDB æ–‡ä»¶ä¸­ï¼ˆè¯¥æ–‡ä»¶çš„æ–‡ä»¶åå¯ä»¥åœ¨ redis.conf ä¸­çš„ dbfilename è¿›è¡Œé…ç½®ï¼Œé»˜è®¤ä¸º dump.rdbï¼‰ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº†æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”Ÿæˆ RDB æ–‡ä»¶çš„æ•°æ®åº“çŠ¶æ€ã€‚\nå¦‚ä½•ä½¿ç”¨ ä½¿ç”¨ SAVE æˆ–è€… BGSAVE æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼ŒäºŒè€…çš„åŒºåˆ«æ˜¯ SAVE ä¼šé˜»å¡è¿›ç¨‹ç›´åˆ° RDB æ–‡ä»¶åˆ›å»ºå®Œæ¯•ä¸ºæ­¢ï¼Œé˜»å¡æœŸé—´ä¸èƒ½å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œè€Œ BGSAVE ä¼š fork ä¸€ä¸ªå­è¿›ç¨‹å–åˆ›å»º RDBï¼Œä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚\nRDB çš„å‘ 1. ç”Ÿæˆçš„ dump.rdb æ‰€åœ¨ä½ç½® åœ¨ redis.conf ä¸­æŒ‡æ˜ï¼š\n# The working directory. # # The DB will be written inside this directory, with the filename specified # above using the 'dbfilename' configuration directive. # # The Append Only File will also be created inside this directory. # # Note that you must specify a directory here, not a file name. dir /usr/local/var/db/redis/ ä¸€äº›åšå®¢ä¸­è¯´çš„æ˜¯åœ¨ redis-cli ä¸­ä½¿ç”¨ config get dir æŸ¥çœ‹ï¼Œä½†æ˜¯\n2. å®¢æˆ·ç«¯æ‰§è¡Œ shutdown æˆ–è€… ç›´æ¥ ctrl+c é€€å‡ºæœåŠ¡ç«¯ï¼Œä¼šè‡ªåŠ¨ save å½“æ—¶æˆ‘æƒ³åšä¸€ä¸ªæµ‹è¯•ï¼šå…ˆ set å‡ æ¡æ•°æ®ï¼Œç„¶åæ‰§è¡Œ save å¯¹è¿™å‡ æ¡å°†æ•°æ®æŒä¹…åŒ–ï¼Œå†æ‰§è¡Œ flushdb æ¸…ç©ºæ•°æ®åº“ï¼Œå½“å†æ¬¡å¯åŠ¨ redis-server æ—¶ï¼Œä¼šè¯»å– dump.rdb ï¼Œå°† set çš„é‚£å‡ æ¡æ•°æ®æ¢å¤è¿‡æ¥ã€‚\ntips: flushdb æ¸…ç©ºæ•°æ®åº“åä¸ä¼šæ‰§è¡Œ saveï¼Œè€Œ flushall æ¸…ç©ºåä¼šæ‰§è¡Œ save\nç„¶è€Œå½“æˆ‘å®è·µæ—¶å´äº‹ä¸æ„¿è¿ï¼Œredis-server çš„å¯åŠ¨æ—¥å¿—ä¸Šæ˜¾ç¤ºäº†è¯»å– rdbï¼Œä½†ä½¿ç”¨ keys * å´æ˜¾ç¤º emptyï¼Œèµ·åˆä»¥ä¸ºæ˜¯è‡ªå·±å¯¹ rdb å·¥ä½œæœºåˆ¶ä¸å¤Ÿäº†è§£ï¼Œæ‰¾äº†åŠå¤©èµ„æ–™ï¼Œæœ€åæ‰å‘ç°æ˜¯å› ä¸ºé€€å‡ºä¼šè‡ªåŠ¨æ‰§è¡Œ saveï¼Œå½“é€€å‡ºæ—¶ï¼Œredis-server è¾“å‡ºå¦‚ä¸‹ï¼š\n56163:M 02 Aug 2021 16:20:34.361 # User requested shutdown... 56163:M 02 Aug 2021 16:20:34.361 * Saving the final RDB snapshot before exiting. 56163:M 02 Aug 2021 16:20:34.362 * DB saved on disk 56163:M 02 Aug 2021 16:20:34.362 # Redis is now ready to exit, bye bye... æ‰€ä»¥å‡ºç°ä¸Šé¢æƒ…å†µçš„åŸå› åœ¨äºï¼Œredis-server é€€å‡ºæ—¶è‡ªåŠ¨æ‰§è¡Œ saveï¼Œå°†å½“å‰æ‰§è¡Œè¿‡ flushdb å‘½ä»¤çš„æ•°æ®åº“åˆæŒä¹…åŒ–äº†ä¸€ä»½ï¼Œå¹¶è¦†ç›–æ‰äº†ä¹‹å‰çš„ RDB æ–‡ä»¶ã€‚\nè§£å†³æ–¹æ³•ï¼šè®© redis-server éæ­£å¸¸é€€å‡ºå³å¯ï¼Œæ¯”å¦‚ä½¿ç”¨ kill -9 ï¼ˆ kill æ˜¯æ— æ•ˆçš„ï¼‰ã€‚\nAOF ä¸ RDB æŒä¹…åŒ–é€šè¿‡ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ä¸åŒï¼ŒAOF æŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜ Redis æœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„ã€‚\nAOF é»˜è®¤å…³é—­ï¼Œè¦æƒ³å¼€å¯éœ€è¦ä¿®æ”¹ redis.conf ä¸­çš„ appendonly ä¸º yesã€‚å’Œ RDB ä¸€æ ·ï¼Œå½“ Redis é€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡ŒæŒä¹…åŒ–ï¼š\n56925:M 02 Aug 2021 17:21:03.892 # User requested shutdown... 56925:M 02 Aug 2021 17:21:03.892 * Calling fsync() on the AOF file. 56925:M 02 Aug 2021 17:21:03.892 * Saving the final RDB snapshot before exiting. 56925:M 02 Aug 2021 17:21:03.892 * DB saved on disk 56925:M 02 Aug 2021 17:21:03.892 * Removing the pid file. 56925:M 02 Aug 2021 17:21:03.893 # Redis is now ready to exit, bye bye... AOF ç”Ÿæˆçš„é»˜è®¤æ–‡ä»¶åä¸º appendonly.aofï¼Œå…¶ä¸­ä¿å­˜çš„æ˜¯åè®®åŒ–åçš„å†™å‘½ä»¤ï¼Œæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ cat æ‰“å°æŸ¥çœ‹ï¼Œè¯¥ db å­˜å‚¨äº†ä¸¤ä¸ªkeyï¼ša:b å’Œ b:bï¼Œå…¶å¯¹åº”çš„ AOF æ–‡ä»¶å¦‚ä¸‹ï¼š\n*2 $6 SELECT $1 0 *3 $3 set $1 a $1 a *3 $3 set $1 b $1 b å¦‚ä½•ä½¿ç”¨ é€šè¿‡ BGREWRITEAOF å‘½ä»¤è¿›è¡ŒæŒä¹…åŒ–ã€‚\nAOF æŒä¹…åŒ–çš„å®ç° AOF æŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸º å‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ï¼Œæ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ ä¸‰ä¸ªæ­¥éª¤ã€‚\nå‘½ä»¤è¿½åŠ ï¼šæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤åï¼Œä¼šä»¥åè®®æ ¼å¼è¿½åŠ åˆ° aof_buf ç¼“å†²åŒºçš„æœ«å°¾ã€‚ æ–‡ä»¶å†™å…¥ï¼šæ­¤æ—¶ä¸ä¼šæŠŠæ•°æ®ç›´æ¥å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œè€Œæ˜¯å…ˆå°† aof_buf ä¸­çš„æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºã€‚ æ–‡ä»¶åŒæ­¥ï¼šå°†å†…å­˜ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œè¦æ³¨æ„å†™å…¥å’ŒåŒæ­¥çš„åŒºåˆ«\nå†™å…¥å’ŒåŒæ­¥çš„åŒºåˆ« åœ¨ç°ä»£ OS ä¸­ï¼Œä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ“ä½œï¼Œå½“ç”¨æˆ·è°ƒç”¨åˆ° write å‡½æ•°å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œos å…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé‡Œï¼Œæ­£å¸¸æ˜¯ç­‰åˆ°ç¼“å†²åŒºæ»¡äº†æˆ–æ˜¯è§„å®šæ—¶é—´åˆ°äº†ï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºé‡Œçš„æ•°æ®å†™å…¥ç£ç›˜ï¼Œè¿™æ—¶æ‰æ˜¯æŒä¹…åŒ–å®Œæˆã€‚\nç±»ä¼¼ä½ ç”¨è®°äº‹æœ¬å†™ä¸œè¥¿ä¸€æ ·ï¼Œå†™å®Œä¹‹åä½ ä¼š Ctrl+vï¼ˆä¿å­˜ï¼‰ï¼Œä½†æ˜¯åœ¨æ²¡æ‰§è¡Œ Ctrl+v çš„æ—¶å€™ä½ ä¹Ÿèƒ½çœ‹åˆ°è‡ªå·±å†™çš„ï¼Œè¿™æ—¶å› ä¸ºä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œäº†ï¼Œç„¶åä½ ä¿å­˜äº†ï¼Œè¿™æ‰ä¿å­˜åˆ°ç£ç›˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠä½ å†™ä¸œè¥¿å½“åšæ˜¯å¯¹ aof æ–‡ä»¶çš„å†™å…¥ï¼Œä½ æ‰§è¡Œ Ctrl+v æ‰æ˜¯åŒæ­¥åˆ°ç£ç›˜æ“ä½œã€‚\nè¿™æ ·è™½ç„¶å¤§å¤§æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯å¾ˆä¸å®‰å…¨ï¼Œåœ¨ä½ å†™äº†å¥½å¤šå­—æ—¶ï¼Œå¡ï¼Œå¿½ç„¶ç”µè„‘åœæœºäº†ï¼Œå†™çš„ä¸œè¥¿å…¨æ²¡äº†ï¼Œå°±é—®ä½ æ°”ä¸æ°”ï¼Ÿ\næ‰€ä»¥ appendfsync çš„é€‰é¡¹å€¼ä¸­çš„ alwaysã€everysec éƒ½å¯ä»¥å¼ºåˆ¶è®© OS ç«‹å³å°†ç¼“å†²åŒºé‡Œçš„æ•°æ®å†™å…¥ç¡¬ç›˜ã€‚always æ˜¯å†™åˆ°ç¼“å†²åŒºäº†ç«‹é©¬å°±åŒæ­¥åˆ°ç£ç›˜ï¼Œeverysec æ˜¯å†™åˆ°ç¼“å†²åŒºçš„æ•°æ®æ¯ç§’å°±åŒæ­¥ä¸€æ¬¡ï¼Œä¸¢å¤±äº†ä¹Ÿå°±ä¸¢å¤±äº†ä¸Šä¸€ç§’å†…çš„æ•°æ®ï¼Œä¹Ÿä¸æ˜¯å¾ˆæ°”ã€‚\nå†™å…¥åŒæ­¥çš„ç­–ç•¥å–å†³äºé…ç½®æ–‡ä»¶ä¸­çš„ appendfsync é€‰é¡¹ï¼Œåœ¨ Redis è®¾è®¡ä¸å®ç° ä¸­æœ‰è¯¦ç»†è¯´æ˜ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚\nAOF é‡å†™ TODO\nä¸€ä¸ªé—®é¢˜ï¼šå­è¿›ç¨‹åœ¨é‡å†™è¿‡ç¨‹ä¸­ï¼Œçˆ¶è¿›ç¨‹ä¾ç„¶å¯ä»¥å†™å…¥æ–°çš„ kvï¼Œæ­¤æ—¶ä¼šæ€ä¹ˆå¤„ç†ï¼Ÿ é‡å†™è¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹ä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤ï¼Œé‚£é—®é¢˜æ¥äº†ï¼Œé‡å†™ AOF æ—¥å¿—è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²ç»å­˜åœ¨ key-valueï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ï¼Œæ­¤æ—¶è¿™ä¸ª key-value æ•°æ®åœ¨å­è¿›ç¨‹çš„å†…å­˜æ•°æ®å°±è·Ÿä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ä¸ä¸€è‡´äº†ï¼Œè¿™æ—¶è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ\nä¸ºäº†è§£å†³è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼ŒRedis è®¾ç½®äº†ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºåœ¨åˆ›å»º bgrewriteaof å­è¿›ç¨‹ä¹‹åå¼€å§‹ä½¿ç”¨ã€‚\nåœ¨é‡å†™ AOF æœŸé—´ï¼Œå½“ Redis æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œå®ƒä¼šåŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å†™å…¥åˆ° ã€ŒAOF ç¼“å†²åŒºã€å’Œ ã€ŒAOF é‡å†™ç¼“å†²åŒºã€ã€‚\nå½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œï¼ˆæ‰«ææ•°æ®åº“ä¸­æ‰€æœ‰æ•°æ®ï¼Œé€ä¸€æŠŠå†…å­˜æ•°æ®çš„é”®å€¼å¯¹è½¬æ¢æˆä¸€æ¡å‘½ä»¤ï¼Œå†å°†å‘½ä»¤è®°å½•åˆ°é‡å†™æ—¥å¿—ï¼‰åï¼Œä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¸€æ¡ä¿¡å·ï¼Œä¿¡å·æ˜¯è¿›ç¨‹é—´é€šè®¯çš„ä¸€ç§æ–¹å¼ï¼Œä¸”æ˜¯å¼‚æ­¥çš„ã€‚\nä¸»è¿›ç¨‹æ”¶åˆ°è¯¥ä¿¡å·åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦åšä»¥ä¸‹å·¥ä½œï¼š\nå°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–°çš„ AOF çš„æ–‡ä»¶ä¸­ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ï¼› æ–°çš„ AOF çš„æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œè¦†ç›–ç°æœ‰çš„ AOF æ–‡ä»¶ã€‚ ä¿¡å·å‡½æ•°æ‰§è¡Œå®Œåï¼Œä¸»è¿›ç¨‹å°±å¯ä»¥ç»§ç»­åƒå¾€å¸¸ä¸€æ ·å¤„ç†å‘½ä»¤äº†ã€‚\n","date":"2021å¹´08æœˆ02æ—¥","permalink":"/posts/redis-chi-jiu-hua-zhi-aof-yu-rdb/","summary":"RDB RDB å¯ä»¥å°†æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ä¸€ä¸ª RDB æ–‡ä»¶ä¸­ï¼ˆè¯¥æ–‡ä»¶çš„æ–‡ä»¶åå¯ä»¥åœ¨ redis.","title":"Redis æŒä¹…åŒ–ä¹‹ AOF ä¸ RDB"},{"contents":"ä½•ä¸ºåœç­‰åè®® é¦–å…ˆå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç®€å•çš„å¯é ä¼ è¾“åè®®ï¼Œä¸»æœº A å‘é€æ•°æ®åˆ†ç»„ç»™ ä¸»æœº Bï¼Œç”±äºç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ•°æ®æŸåï¼Œæ‰€ä»¥ä¸»æœº Bä¼šè¿›è¡Œæ ¡éªŒå’Œæ£€æµ‹ï¼Œå¦‚æœæ•°æ®å®Œæ•´åˆ™å‘é€ ACKï¼Œå¦åˆ™å‘é€ NAKï¼Œå¦‚æœæ”¶åˆ° ACKï¼Œåˆ™å¯ä»¥ç»§ç»­å‘é€ä¸‹ä¸€ä¸ªæ•°æ®åˆ†ç»„ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ”¶åˆ° NAK åˆ™é‡æ–°å‘é€å½“å‰æ•°æ®åˆ†ç»„ã€‚\nåœ¨æ”¶åˆ° ä¸»æœº B çš„å›å¤ä¹‹å‰ï¼Œä¸»æœº A ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œï¼Œè¿™ä¾¿æ˜¯åœç­‰åè®®ï¼Œç±»ä¼¼äºä¸²è¡Œæ“ä½œã€‚\nå­˜åœ¨çš„é—®é¢˜åŠè§£å†³æ–¹æ³• 1. é•¿æ—¶é—´å¾—ä¸åˆ°å›åº” è§£å†³æ–¹æ³•ï¼š 2. ACKã€NAK ä¸¢å¤± æ—¢ç„¶æ˜¯ç½‘ç»œä¼ è¾“ï¼Œé‚£ä¹ˆä¸ä»…æŠ¥æ–‡ä¼šä¸¢å¤±ï¼ŒACKã€NAK åŒæ ·ä¹Ÿæœ‰ä¸¢å¤±çš„å¯èƒ½ï¼Œå¦‚æœä¸¢å¤±ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿçœ‹å¦‚ä¸‹åœºæ™¯ï¼š åœ¨ä¸Šå›¾ä¸­ï¼Œå› ä¸º ACK çš„ä¸¢å¤±ï¼Œè§¦å‘è¶…æ—¶é‡ä¼ ï¼Œåˆå‘é€äº†ä¸€æ¬¡æ•°æ®ç»™å¯¹ç«¯ï¼Œä½†æ˜¯å¯¹ç«¯å·²ç»æ¥æ”¶åˆ°äº†è¿™ä¸ªæ•°æ®ï¼Œå±äºå†—ä½™æ•°æ®ï¼Œæ— éœ€å†æ¬¡æ¥æ”¶ã€‚é‚£ä¹ˆå¯ä»¥ä¸¢å¼ƒå—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œå› ä¸ºå¯¹ç«¯å¹¶ä¸çŸ¥é“å®ƒçš„ ACK æ˜¯å¦ä¸¢å¤±ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•åˆ†è¾¨è¿™æ¬¡æ¥æ”¶åˆ°çš„æ˜¯å†—ä½™é‡ä¼ è¿˜æ˜¯æ–°çš„æŠ¥æ–‡ï¼Œå†—ä½™é‡ä¼ å¯ä»¥ä¸¢å¼ƒï¼Œä½†æ˜¯æ–°æŠ¥æ–‡ä¸èƒ½ã€‚\nè§£å†³æ–¹æ³•ï¼šç»™æ¯ä¸ªåˆ†ç»„å¸¦ä¸Šåºå·ï¼Œç”±äºåœç­‰åè®®æ¯å‘é€ä¸€ä¸ªæ•°æ®åˆ†ç»„å°±åœæ­¢ç­‰å¾…ï¼Œåªè¦ä¿è¯æ¯å‘é€ä¸€ä¸ªæ–°çš„æ•°æ®åˆ†ç»„ï¼Œå…¶å‘é€åºå·ä¸ä¸Šæ¬¡å‘é€çš„æ•°æ®åˆ†ç»„çš„åºå·ä¸åŒå°±å¯ä»¥äº†ï¼Œæ‰€ä»¥ä¸€æ¬¡ç”¨ä¸€ä¸ªæ¯”ç‰¹ï¼ˆ0 æˆ– 1ï¼‰æ¥ç¼–å·å°±å¤Ÿäº†ï¼Œ01ä¸æ–­å¾ªç¯ï¼Œè¿™æ¬¡å‘é€ç¼–å·ä¸º 0ï¼Œä¸‹æ¬¡å‘é€åˆ™ç¼–å·ä¸º 1ï¼Œå†ä¸‹æ¬¡ä¸º 0ï¼Œå¦‚æ­¤å¾€å¤ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æ¥æ”¶åˆ°é‡ä¼ åˆ†ç»„ data0 æ—¶ï¼Œä¾¿å¯æ ¹æ®ç¼–å·åˆ¤æ–­å‡ºè¿™æ˜¯ä¸€ä¸ªå†—ä½™æ•°æ®ï¼Œä¾¿å¯ä»¥ä¸¢å¼ƒäº†ã€‚è¿™é‡Œæ³¨æ„æ•°æ®å¯ä»¥ä¸¢å¼ƒï¼Œä½†æ˜¯ä¾ç„¶è¦å›å¤ä¸€ä¸ª ACKï¼Œå‘Šè¯‰å¯¹æ–¹æˆ‘å·²ç»æ”¶åˆ°äº†ä½ çš„æ•°æ®ï¼Œä¸‹æ¬¡ä¸ç”¨å†å‘äº†ã€‚\n3. å¦ä¸€ç§æƒ…å†µ ä»…ä»…ç»™åˆ†ç»„å¸¦ä¸Šåºå·å°±å¯ä»¥äº†å—ï¼Ÿçœ‹å¦‚ä¸‹æƒ…å†µï¼š DATA0 çš„ ACK å»¶è¿Ÿäº†ï¼Œè¿™å¯¼è‡´ DATA0 é‡ä¼ ï¼Œå†å‘èµ·é‡ä¼ åä¸ä¹…ï¼Œå»¶è¿Ÿçš„ ACK åˆ°è¾¾äº†ï¼Œäºæ˜¯ç»§ç»­å‘é€ä¸‹ä¸€ä¸ªæ•°æ® DATA1ï¼Œä¹‹ååˆæ”¶åˆ°äº†é‡ä¼  DATA0 è¿”å›çš„ ACKï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ¥æ”¶ç«¯å¦‚ä½•è¾¨åˆ«è¿™æ¬¡çš„ ACK æ˜¯ DATA0 è¿”å›çš„è¿˜æ˜¯ DATA1 è¿”å›çš„ï¼Ÿ\nè§£å†³æ–¹æ³•ï¼šç»™ ACK ä¹ŸåŠ ä¸Šåºå· å‡ºå¤„ è®¡ç®—æœºç½‘ç»œå¾®è¯¾å ‚â€”â€”æ¹–ç§‘å¤§æ•™ä¹¦åŒ ï¼Œhttps://www.bilibili.com/video/BV1c4411d7jb?p=25ï¼Œå›¾ç‰‡åŠå†…å®¹çš†æ¥è‡ªäºæ­¤\n","date":"2021å¹´07æœˆ30æ—¥","permalink":"/posts/ke-kao-chuan-shu-de-shi-xian-ji-zhi-ting-zhi-deng-dai-xie-yi-swstop-and-wait/","summary":"ä½•ä¸ºåœç­‰åè®® é¦–å…ˆå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç®€å•çš„å¯é ä¼ è¾“åè®®ï¼Œä¸»æœº A å‘é€æ•°æ®åˆ†ç»„ç»™ ä¸»æœº Bï¼Œç”±äºç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ•°æ®æŸåï¼Œæ‰€ä»¥ä¸»æœº Bä¼šè¿›è¡Œæ ¡éªŒå’Œæ£€æµ‹ï¼Œå¦‚æœæ•°æ®å®Œæ•´åˆ™å‘é€ ACKï¼Œå¦åˆ™å‘é€ NAKï¼Œå¦‚æœæ”¶åˆ° ACKï¼Œåˆ™å¯ä»¥ç»§ç»­å‘é€ä¸‹ä¸€ä¸ªæ•°æ®åˆ†ç»„ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ”¶åˆ° NAK åˆ™é‡æ–°å‘é€å½“å‰æ•°æ®åˆ†ç»„ã€‚","title":"å¯é ä¼ è¾“çš„å®ç°æœºåˆ¶ â€”â€” åœæ­¢-ç­‰å¾…åè®®SWï¼ˆStop-and-Waitï¼‰"},{"contents":"çœ‹çœ‹ map è¿™ä¸ªé‡è¦æ•°æ®ç»“æ„åœ¨ go ä¸­æ˜¯å¦‚ä½•å®ç°çš„\nhmap map çš„ç»“æ„ä½“\n// A header for a Go map. type hmap struct { // count ä»£è¡¨å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œè°ƒç”¨len(map)æ—¶ï¼Œè¿”å›çš„å°±æ˜¯è¯¥å­—æ®µå€¼ã€‚ // // Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go. // Make sure this stays in sync with the compiler's definition. count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 // B æ¡¶çš„æ•°ç›®æ˜¯ 2 çš„ B æ¬¡å¹‚ï¼Œå› ä¸ºé€‰æ‹©æ¡¶ä½¿ç”¨çš„æ˜¯ä¸è¿ç®—çš„æ–¹æ³• B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) // ä½¿ç”¨çš„æº¢å‡ºæ¡¶çš„æ•°é‡ noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details // hash0 æ˜¯å“ˆå¸Œçš„ç§å­ï¼Œå®ƒèƒ½ä¸ºå“ˆå¸Œå‡½æ•°çš„ç»“æœå¼•å…¥éšæœºæ€§ï¼Œè¿™ä¸ªå€¼åœ¨åˆ›å»ºå“ˆå¸Œè¡¨æ—¶ç¡®å®šï¼Œ // å¹¶åœ¨è°ƒç”¨å“ˆå¸Œå‡½æ•°æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ hash0 uint32 // hash seed // buckets æ¡¶çš„ä½ç½®ï¼Œå®é™…ç±»å‹ä¸º []bmap buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. // oldbuckets ç”¨äºåœ¨æ‰©å®¹é˜¶æ®µä¿å­˜æ—§æ¡¶çš„ä½ç½® // å¦‚æœ oldbuckets == nilï¼Œåˆ™ä»£è¡¨ä»¥åŠè¿ç§»å®Œæˆ // åˆ¤æ–­å‡½æ•°ä¸º growing() oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing // è®°å½•æ¸è¿›å¼æ‰©å®¹é˜¶æ®µä¸‹ä¸€ä¸ªè¦è¿ç§»çš„æ—§æ¡¶ç¼–å· // ä½•ä¸ºæ¸è¿›å¼ï¼Ÿ // å¦‚æœè§¦å‘æ‰©å®¹ï¼Œæ­¤æ—¶ä¸ä¼šä¸€æ¬¡æ€§æŠŠ kv å…¨éƒ¨ä»æ—§æ¡¶è¿ç§»åˆ°æ–°æ¡¶ï¼Œè€Œæ˜¯å½“æ‰§è¡Œæ’å…¥ï¼ˆåŒ…æ‹¬ä¿®æ”¹ï¼‰ã€åˆ é™¤æ“ä½œæ—¶ï¼Œ // å¯¹ä¸€éƒ¨åˆ† kv è¿›è¡Œè¿ç§»ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¿ç§»çš„æ—¶é—´åˆ†æ‘Šåˆ°å¤šæ¬¡ map æ“ä½œä¸­ï¼Œé˜²æ­¢ç¬é—´æ€§èƒ½æŠ–åŠ¨ // ps: æ¯æ¬¡æœ€å¤šåªä¼šæ¬è¿ 2 ä¸ª bucketï¼Œè¿ç§»æ˜¯å¦å®Œæˆçš„åˆ¤æ–­ä¾æ®æ˜¯ oldbuckets å­—æ®µæ˜¯å¦ä¸ºç©º nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) // æŒ‡å‘ä¸€ä¸ª mapextraï¼Œmapextra é‡Œé¢è®°å½•çš„æ˜¯æº¢å‡ºæ¡¶çš„ç›¸å…³ä¿¡æ¯ extra *mapextra // optional fields } bmap bmap æ˜¯ä¸€ä¸ªæ¡¶ï¼Œç¼–è¯‘æœŸé—´ä¼šåŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼š\næ¥è‡ª Go è¯­è¨€è®¾è®¡ä¸å®ç°ï¼š runtime.bmap ä¸­çš„å…¶ä»–å­—æ®µåœ¨è¿è¡Œæ—¶ä¹Ÿéƒ½æ˜¯é€šè¿‡è®¡ç®—å†…å­˜åœ°å€çš„æ–¹å¼è®¿é—®çš„ï¼Œ æ‰€ä»¥å®ƒçš„å®šä¹‰ä¸­å°±ä¸åŒ…å«è¿™äº›å­—æ®µï¼Œä¸è¿‡æˆ‘ä»¬èƒ½æ ¹æ®ç¼–è¯‘æœŸé—´çš„ cmd/compile/internal/gc.bmap å‡½æ•°é‡å»ºå®ƒçš„ç»“æ„\nä½†æ˜¯åœ¨ go 1.16 ä¸­æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥åœ¨å…¶ä»–åšå®¢æ‰¾äº†è¿™ä¸ªç»“æ„ä½“ï¼Œå¦‚ä¸‹ï¼š\ntype bmap struct { topbits [8]uint8 keys [8]keytype values [8]valuetype pad uintptr overflow uintptr } æ¡¶ä¸­å­˜æ”¾ kv çš„æ–¹å¼å¦‚ä¸‹ï¼š\nè®¡ç®—å‡ºçš„hash å€¼çš„é«˜å…«ä½ä¸º tophashï¼Œç”¨äºåœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ¡¶ä¸­åŒºåˆ«å‡ºé”®ï¼Œä½ä½ç”¨äºé€‰æ‹©æ¡¶ï¼Œ ä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªè®¡ç®—å‡ºæ¥çš„ hashï¼š\né«˜ 8 ä½ 66883387 391851 01010 ä½ 5 ä½\nå½“ B ç­‰äº 5 æ—¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€‰æ‹©çš„å“ˆå¸Œå€¼ä½ä½ä¹Ÿæ˜¯ 5 ä½ï¼Œå³ 01010ï¼Œå®ƒçš„åè¿›åˆ¶å€¼ä¸º 10ï¼Œä»£è¡¨ 10 å·æ¡¶ã€‚ å†ç”¨å“ˆå¸Œå€¼çš„é«˜ 8 ä½ï¼Œæ‰¾åˆ°æ­¤ key åœ¨æ¡¶ä¸­çš„ä½ç½®ã€‚\næ¡¶é‡Œé¢ä¼šæœ€å¤šè£… 8 ä¸ª key/valueï¼Œè¿™äº› key ä¹‹æ‰€ä»¥ä¼šè½å…¥åŒä¸€ä¸ªæ¡¶ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ç»è¿‡å“ˆå¸Œè®¡ç®—åï¼Œå“ˆå¸Œç»“æœçš„ ä½Bä½æ˜¯ç›¸åŒçš„ï¼Œè€Œå¤šä¸ª key è£…å…¥ä¸€ä¸ªæ¡¶å°±æ˜¯ go ç”¨æ¥å¤„ç† hash å†²çª çš„æ–¹å¼ã€‚åœ¨æ¡¶å†…ï¼Œä¼šæ ¹æ® key çš„ hash å€¼çš„é«˜ 8 ä½ä½œä¸º tophashï¼Œtophash çš„ä½œç”¨æ˜¯åœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ¡¶ä¸­åŒºåˆ«å‡ºé”®ï¼Œå¯ä»¥åœ¨æŸ¥æ‰¾ key æ—¶è¿›è¡Œå¿«é€Ÿåˆ¤æ–­ï¼Œå¿«é€Ÿçš„åŸå› åœ¨äºï¼š\nåœ¨æŸä¸ª bmap é‡Œå¿«é€Ÿåˆ¤ç­‰ key æ—¶ä½¿ç”¨ï¼Œè‹¥ hash é«˜å…«ä½ä¸ç›¸ç­‰å°±ä¸ç”¨è¿›ä¸€æ­¥æ¯”è¾ƒ key æ˜¯å¦ç›¸ç­‰äº†ï¼Œåˆ¤æ–­ key æ˜¯å¦ç›¸ç­‰ä¼šæ ¹æ® key çš„ç±»å‹æ‰¾åˆ°å¯¹åº”çš„equal å‡½æ•°ï¼Œç„¶åè°ƒç”¨å‡½æ•°æ‹¿åˆ°åˆ¤ç­‰ç»“æœï¼›è€Œåˆ¤æ–­ tophash å°±æ²¡é‚£ä¹ˆå¤æ‚äº†ã€‚æ¥æºï¼šhttps://www.bilibili.com/video/BV1Sp4y1U7dJï¼Œã€Golangã€‘Mapé•¿å•¥æ ·å„¿ï¼Ÿé‡Œçš„è¯„è®º\nè®¡ç®— tophash çš„å‡½æ•°æ˜¯ï¼šfunc tophash(hash uintptr) uint8\nbmap çš„ç»“æ„å›¾ç¤ºï¼š åœ¨8ä¸ªé”®å€¼å¯¹æ•°æ®åé¢æœ‰ä¸€ä¸ªoverflowæŒ‡é’ˆï¼Œå› ä¸ºæ¡¶ä¸­æœ€å¤šåªèƒ½è£… 8 ä¸ªé”®å€¼å¯¹ï¼Œå¦‚æœæœ‰å¤šä½™çš„é”®å€¼å¯¹è½åˆ°äº†å½“å‰æ¡¶ï¼Œé‚£ä¹ˆå°±éœ€è¦å†æ„å»ºä¸€ä¸ªæ¡¶ï¼ˆç§°ä¸ºæº¢å‡ºæ¡¶ï¼‰ï¼Œé€šè¿‡ overflow æŒ‡é’ˆé“¾æ¥èµ·æ¥ã€‚\n// A bucket for a Go map. type bmap struct { // tophash generally contains the top byte of the hash value // for each key in this bucket. If tophash[0] \u0026lt; minTopHash, // tophash[0] is a bucket evacuation state instead. tophash [bucketCnt]uint8 // Followed by bucketCnt keys and then bucketCnt elems. // NOTE: packing all the keys together and then all the elems together makes the // code a bit more complicated than alternating key/elem/key/elem/... but it allows // us to eliminate padding which would be needed for, e.g., map[int64]int8. // Followed by an overflow pointer. } åˆ›å»º map // map åˆå§‹åŒ–çš„æµç¨‹ï¼š // 1. å…¥å‚æ ¡éªŒï¼Œåˆ¤æ–­ key çš„ç±»å‹æ˜¯å¦åˆæ³•ï¼Œå¿…é¡»ä¸ºå¯æ¯”è¾ƒç±»å‹ // 2. åº•å±‚è°ƒç”¨ makemap å‡½æ•°ï¼Œè®¡ç®—å¾—åˆ°åˆé€‚çš„ Bï¼Œmap å®¹é‡æœ€å¤šå¯å®¹çº³ 6.5 * 2^B ä¸ªå…ƒç´ ï¼Œ // 6.5 ä¸ºè£…è½½å› å­é˜ˆå€¼å¸¸é‡ã€‚ // è£…è½½å› å­çš„è®¡ç®—å…¬å¼æ˜¯ï¼šè£…è½½å› å­ = å¡«å…¥è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°/æ•£åˆ—è¡¨çš„é•¿åº¦ï¼Œè£…è½½å› å­è¶Šå¤§ï¼Œè¯´æ˜ç©ºé—²ä½ç½®è¶Šå°‘ï¼Œå†²çªè¶Šå¤šï¼Œæ•£åˆ—è¡¨çš„æ€§èƒ½ä¼šä¸‹é™ // makemap implements Go map creation for make(map[k]v, hint). // If the compiler has determined that the map or the first bucket // can be created on the stack, h and/or bucket may be non-nil. // If h != nil, the map can be created directly in h. // If h.buckets != nil, bucket pointed to can be used as the first bucket. func makemap(t *maptype, hint int, h *hmap) *hmap { //println(\u0026quot;[make map] start...\u0026quot;) // 1. è®¡ç®—å“ˆå¸Œå ç”¨çš„å†…å­˜æ˜¯å¦æº¢å‡ºæˆ–è€…è¶…å‡ºèƒ½åˆ†é…çš„æœ€å¤§å€¼ mem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size) if overflow || mem \u0026gt; maxAlloc { hint = 0 } //println(\u0026quot;[make map] cap: \u0026quot;, hint, \u0026quot;, use mem: \u0026quot;, mem) //log.Printf(\u0026quot;[make map] cap: %d, use mem: %d \\n\u0026quot;, hint, mem) // initialize Hmap if h == nil { h = new(hmap) } // 2. è°ƒç”¨ runtime.fastrand è·å–ä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­ h.hash0 = fastrand() // Find the size parameter B which will hold the requested # of elements. // For hint \u0026lt; 0 overLoadFactor returns false since hint \u0026lt; bucketCnt. B := uint8(0) // 3. æ ¹æ®ä¼ å…¥çš„ hint è®¡ç®—å‡ºéœ€è¦çš„æœ€å°éœ€è¦çš„æ¡¶çš„æ•°é‡ for overLoadFactor(hint, B) { B++ } //println(\u0026quot;B is \u0026quot;, B) //log.Printf(\u0026quot;B is %d, that mean the total bocket number is 2^B = %v \\n\u0026quot;, B, math2.Pow(2, float64(B))) h.B = B // åˆ†é…åˆå§‹å“ˆå¸Œè¡¨ // å¦‚æœ B ä¸º 0ï¼Œé‚£ä¹ˆ buckets å­—æ®µåç»­ä¼šåœ¨ mapassignï¼ˆmap çš„æ·»åŠ å‡½æ•°ï¼‰ æ–¹æ³•ä¸­ lazily åˆ†é… // // allocate initial hash table // if B == 0, the buckets field is allocated lazily later (in mapassign) // If hint is large zeroing this memory could take a while. if h.B != 0 { var nextOverflow *bmap // 4. ä½¿ç”¨ runtime.makeBucketArray åˆ›å»ºç”¨äºä¿å­˜æ¡¶çš„æ•°ç»„ // runtime.makeBucketArray ä¼šæ ¹æ®ä¼ å…¥çš„ B è®¡ç®—å‡ºçš„éœ€è¦åˆ›å»ºçš„æ¡¶æ•°é‡ // å¹¶åœ¨å†…å­˜ä¸­åˆ†é…ä¸€ç‰‡è¿ç»­çš„ç©ºé—´ç”¨äºå­˜å‚¨æ•°æ® h.buckets, nextOverflow = makeBucketArray(t, h.B, nil) if nextOverflow != nil { h.extra = new(mapextra) h.extra.nextOverflow = nextOverflow } } return h } åˆ›å»ºä¿å­˜æ¡¶çš„æ•°ç»„ // makeBucket ä¸º map åˆ›å»ºç”¨äºä¿å­˜ buckets çš„æ•°ç»„ã€‚ // å½“æ¡¶çš„æ•°é‡å°äº 24 æ—¶ï¼Œç”±äºæ•°æ®è¾ƒå°‘ã€ä½¿ç”¨æº¢å‡ºæ¡¶çš„å¯èƒ½æ€§è¾ƒä½ï¼Œä¼šçœç•¥åˆ›å»ºçš„è¿‡ç¨‹ä»¥å‡å°‘é¢å¤–å¼€é”€ï¼› // å½“æ¡¶çš„æ•°é‡å¤šäº 24 æ—¶ï¼Œä¼šé¢å¤–åˆ›å»º 2^B âˆ’ 4 ä¸ªæº¢å‡ºæ¡¶ï¼› // // makeBucketArray initializes a backing array for map buckets. // 1\u0026lt;\u0026lt;b is the minimum number of buckets to allocate. // dirtyalloc should either be nil or a bucket array previously // allocated by makeBucketArray with the same t and b parameters. // If dirtyalloc is nil a new backing array will be alloced and // otherwise dirtyalloc will be cleared and reused as backing array. func makeBucketArray(t *maptype, b uint8, dirtyalloc unsafe.Pointer) (buckets unsafe.Pointer, nextOverflow *bmap) { base := bucketShift(b) nbuckets := base // å¯¹äºå°çš„ b å€¼ï¼ˆå°äº4ï¼‰ï¼Œå³æ¡¶çš„æ•°é‡å°äº 16 æ—¶ï¼Œä½¿ç”¨æº¢å‡ºæ¡¶çš„å¯èƒ½æ€§å¾ˆå°ã€‚ // å¯¹äºæ­¤æƒ…å†µï¼Œå°±é¿å…è®¡ç®—å¼€é”€ã€‚ // For small b, overflow buckets are unlikely. // Avoid the overhead of the calculation. if b \u0026gt;= 4 { // å½“æ¡¶çš„æ•°é‡å¤§äºç­‰äº 16 ä¸ªæ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹å°±ä¼šé¢å¤–åˆ›å»º 2^(b-4) ä¸ªæº¢å‡ºæ¡¶ // Add on the estimated number of overflow buckets // required to insert the median number of elements // used with this value of b. nbuckets += bucketShift(b - 4) sz := t.bucket.size * nbuckets up := roundupsize(sz) if up != sz { nbuckets = up / t.bucket.size } } // è¿™é‡Œï¼Œdirtyalloc åˆ†ä¸¤ç§æƒ…å†µã€‚å¦‚æœå®ƒä¸º nilï¼Œåˆ™ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„ã€‚ // å¦‚æœå®ƒä¸ä¸º nilï¼Œåˆ™å®ƒæŒ‡å‘çš„æ˜¯æ›¾ç»åˆ†é…è¿‡çš„åº•å±‚æ•°ç»„ï¼Œè¯¥åº•å±‚æ•°ç»„æ˜¯ç”±ä¹‹å‰åŒ // æ ·çš„ t å’Œ b å‚æ•°é€šè¿‡ makeBucketArray åˆ†é…çš„ï¼Œå¦‚æœæ•°ç»„ä¸ä¸ºç©ºï¼Œéœ€è¦æŠŠ // è¯¥æ•°ç»„ä¹‹å‰çš„æ•°æ®æ¸…ç©ºå¹¶å¤ç”¨ã€‚ if dirtyalloc == nil { buckets = newarray(t.bucket, int(nbuckets)) } else { // dirtyalloc was previously generated by // the above newarray(t.bucket, int(nbuckets)) // but may not be empty. buckets = dirtyalloc size := t.bucket.size * nbuckets if t.bucket.ptrdata != 0 { memclrHasPointers(buckets, size) } else { memclrNoHeapPointers(buckets, size) } } // å³ b å¤§äºç­‰äº 4 çš„æƒ…å†µä¸‹ï¼Œä¼šé¢„åˆ†é…ä¸€äº›æº¢å‡ºæ¡¶ã€‚ // ä¸ºäº†æŠŠè·Ÿè¸ªè¿™äº›æº¢å‡ºæ¡¶çš„å¼€é”€é™è‡³æœ€ä½ï¼Œä½¿ç”¨äº†ä»¥ä¸‹çº¦å®šï¼š // å¦‚æœé¢„åˆ†é…çš„æº¢å‡ºæ¡¶çš„ overflow æŒ‡é’ˆä¸º nilï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æŒ‡é’ˆç¢°æ’ï¼ˆbumping the pointerï¼‰è·å¾—æ›´å¤šå¯ç”¨æ¡¶ã€‚ //ï¼ˆå…³äºæŒ‡é’ˆç¢°æ’ï¼šå‡è®¾å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„ï¼Œæ‰€æœ‰ç”¨è¿‡çš„å†…å­˜éƒ½æ”¾åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾åœ¨å¦ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸º // åˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œé‚£æ‰€åˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠé‚£ä¸ªæŒ‡é’ˆå‘ç©ºé—²ç©ºé—´é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ï¼Œè¿™ç§åˆ†é…æ–¹å¼ç§°ä¸ºâ€œæŒ‡é’ˆç¢°æ’â€ï¼‰ // å¯¹äºæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œéœ€è¦ä¸€ä¸ªå®‰å…¨çš„é nil æŒ‡é’ˆæŒ‡å‘å®ƒã€‚ if base != nbuckets { // We preallocated some overflow buckets. // To keep the overhead of tracking these overflow buckets to a minimum, // we use the convention that if a preallocated overflow bucket's overflow // pointer is nil, then there are more available by bumping the pointer. // We need a safe non-nil pointer for the last overflow bucket; just use buckets. nextOverflow = (*bmap)(add(buckets, base*uintptr(t.bucketsize))) last := (*bmap)(add(buckets, (nbuckets-1)*uintptr(t.bucketsize))) last.setoverflow(t, (*bmap)(buckets)) } return buckets, nextOverflow } æŸ¥æ‰¾ æŸ¥æ‰¾æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œmapaccess1 å¯¹åº” h[key] è¿™ç§å½¢å¼ï¼Œmapaccess2 å¯¹åº” v, ok := h[key] ï¼Œok è¡¨ç¤ºè¯¥ key æ˜¯å¦å­˜åœ¨ã€‚\nmapaccess1 // map æŸ¥æ‰¾ key // // mapaccess1 returns a pointer to h[key]. Never returns nil, instead // it will return a reference to the zero object for the elem type if // the key is not in the map. // NOTE: The returned pointer may keep the whole map live, so don't // hold onto it for very long. func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { if raceenabled \u0026amp;\u0026amp; h != nil { callerpc := getcallerpc() pc := funcPC(mapaccess1) racereadpc(unsafe.Pointer(h), callerpc, pc) raceReadObjectPC(t.key, key, callerpc, pc) } if msanenabled \u0026amp;\u0026amp; h != nil { msanread(key, t.key.size) } // å¦‚æœ map ä¸ºç©ºæˆ–è€…å…ƒç´ ä¸ªæ•°ä¸º 0ï¼Œè¿”å›é›¶å€¼ if h == nil || h.count == 0 { if t.hashMightPanic() { t.hasher(key, 0) // see issue 23734 } return unsafe.Pointer(\u0026amp;zeroVal[0]) } // å†™å’Œè¯»å†²çªï¼Œå³å¹¶å‘æ“ä½œ if h.flags\u0026amp;hashWriting != 0 { throw(\u0026quot;concurrent map read and map write\u0026quot;) } // è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¹¶ä¸”åŠ å…¥ hash0 å¼•å…¥éšæœºæ€§ // ä¸åŒç±»å‹çš„ keyï¼Œä¼šä½¿ç”¨ä¸åŒçš„ hash ç®—æ³• hash := t.hasher(key, uintptr(h.hash0)) m := bucketMask(h.B) // b å°±æ˜¯ bucket çš„åœ°å€ b := (*bmap)(add(h.buckets, (hash\u0026amp;m)*uintptr(t.bucketsize))) // å¦‚æœ oldbuckets ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¯æ˜ map å‘ç”Ÿäº†æ‰©å®¹ // å¦‚æœæœ‰æ‰©å®¹å‘ç”Ÿï¼Œè€çš„ buckets ä¸­çš„æ•°æ®å¯èƒ½è¿˜æœªæ¬è¿è‡³æ–°çš„ buckets é‡Œ // æ‰€ä»¥éœ€è¦å…ˆåœ¨è€çš„ buckets ä¸­æ‰¾ if c := h.oldbuckets; c != nil { if !h.sameSizeGrow() { // There used to be half as many buckets; mask down one more power of two. m \u0026gt;\u0026gt;= 1 } oldb := (*bmap)(add(c, (hash\u0026amp;m)*uintptr(t.bucketsize))) if !evacuated(oldb) { b = oldb } } // è®¡ç®—å‡ºå½“å‰ key çš„é«˜ 8 ä½çš„ hashï¼Œä¹Ÿå°±æ˜¯ tophash top := tophash(hash) bucketloop: // åŒé‡å¾ªç¯éå†ï¼šå¤–å±‚å¾ªç¯æ˜¯ä»æ¡¶åˆ°æº¢å‡ºæ¡¶éå†ï¼›å†…å±‚æ˜¯æ¡¶ä¸­çš„ cell éå† // è·³å‡ºå¾ªç¯çš„æ¡ä»¶æœ‰ä¸‰ç§ï¼š // ç¬¬ä¸€ç§æ˜¯å·²ç»æ‰¾åˆ° key å€¼ï¼› // ç¬¬äºŒç§æ˜¯å½“å‰æ¡¶å†æ— æº¢å‡ºæ¡¶ï¼› // ç¬¬ä¸‰ç§æ˜¯å½“å‰æ¡¶ä¸­æœ‰ cell ä½çš„ tophash å€¼æ˜¯ emptyRest // å®ƒä»£è¡¨æ­¤æ—¶çš„æ¡¶åé¢çš„ cell è¿˜æœªåˆ©ç”¨ï¼Œæ‰€ä»¥æ— éœ€å†ç»§ç»­éå†ã€‚ // å‰é¢å·²ç»é€šè¿‡ hash å€¼çš„ä½ä½ç¡®å®šæ˜¯å‡ å·æ¡¶äº†ï¼Œä½†æ˜¯æ¡¶å¯èƒ½è¿˜è¿æ¥ç€æº¢å‡ºæ¡¶ï¼Œæ‰€ä»¥ä½¿ç”¨ for å¾ªåº // æ¥éå†è¯¥æ¡¶ä»¥åŠå…¶è¿æ¥çš„æº¢å‡ºæ¡¶ for ; b != nil; b = b.overflow(t) { // æ¯ä¸ªæ¡¶å†…æœ€å¤šå­˜æ”¾ 8 ä¸ª key/valueï¼Œæ¯ä¸ª kv å¯¹åº”ä¸€ä¸ª tophashï¼Œæ‰€ä»¥ // éå†è¿™ 8 ä¸ª tophash æ¥æŸ¥æ‰¾ key for i := uintptr(0); i \u0026lt; bucketCnt; i++ { // tophash ä¸åŒ¹é… if b.tophash[i] != top { // å¦‚æœæ˜¯ emptyRestï¼Œä»£è¡¨æ­¤æ—¶çš„æ¡¶åé¢çš„ cell è¿˜æœªåˆ©ç”¨ï¼Œæ‰€ä»¥æ— éœ€å†ç»§ç»­éå† if b.tophash[i] == emptyRest { break bucketloop } // ç»§ç»­æŸ¥æ‰¾ continue } // åˆ°è¿™é‡Œè¯´æ˜æ‰¾åˆ°äº† keyï¼Œå¾—åˆ° key çš„åœ°å€ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } // tophash ç›¸åŒè¿˜éœ€è¦åˆ¤æ–­ key æ˜¯å¦ç›¸ç­‰ // å¦‚æœ key ä¹Ÿç›¸åŒåˆ™ä»£è¡¨æ‰¾åˆ°äº†ï¼Œè¿”å› // å¦‚æœ key ä¸ç›¸åŒï¼Œåˆ™è¿›å…¥ä¸‹è½®å¾ªç¯ if t.key.equal(key, k) { e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { e = *((*unsafe.Pointer)(e)) } return e } } } // æ‰€æœ‰çš„ bucket éƒ½æœªæ‰¾åˆ°ï¼Œåˆ™è¿”å›é›¶å€¼ return unsafe.Pointer(\u0026amp;zeroVal[0]) } mapaccess2 func mapaccess2(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, bool) { if raceenabled \u0026amp;\u0026amp; h != nil { callerpc := getcallerpc() pc := funcPC(mapaccess2) racereadpc(unsafe.Pointer(h), callerpc, pc) raceReadObjectPC(t.key, key, callerpc, pc) } if msanenabled \u0026amp;\u0026amp; h != nil { msanread(key, t.key.size) } if h == nil || h.count == 0 { if t.hashMightPanic() { t.hasher(key, 0) // see issue 23734 } return unsafe.Pointer(\u0026amp;zeroVal[0]), false } if h.flags\u0026amp;hashWriting != 0 { throw(\u0026quot;concurrent map read and map write\u0026quot;) } hash := t.hasher(key, uintptr(h.hash0)) m := bucketMask(h.B) b := (*bmap)(add(h.buckets, (hash\u0026amp;m)*uintptr(t.bucketsize))) if c := h.oldbuckets; c != nil { if !h.sameSizeGrow() { // There used to be half as many buckets; mask down one more power of two. m \u0026gt;\u0026gt;= 1 } oldb := (*bmap)(add(c, (hash\u0026amp;m)*uintptr(t.bucketsize))) if !evacuated(oldb) { b = oldb } } top := tophash(hash) bucketloop: for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u0026lt; bucketCnt; i++ { if b.tophash[i] != top { if b.tophash[i] == emptyRest { break bucketloop } continue } k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } if t.key.equal(key, k) { e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { e = *((*unsafe.Pointer)(e)) } return e, true } } } return unsafe.Pointer(\u0026amp;zeroVal[0]), false } æ·»åŠ  // map çš„æ·»åŠ å‡½æ•° // Like mapaccess, but allocates a slot for the key if it is not present in the map. func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { //println(\u0026quot;insert key into map...\u0026quot;) // å¦‚æœ h æ˜¯ç©ºæŒ‡é’ˆï¼Œèµ‹å€¼ä¼šå¼•èµ· panic // ä¾‹å¦‚ä»¥ä¸‹è¯­å¥ // var m map[string]int // m[\u0026quot;k\u0026quot;] = 1 if h == nil { panic(plainError(\u0026quot;assignment to entry in nil map\u0026quot;)) } if raceenabled { callerpc := getcallerpc() pc := funcPC(mapassign) racewritepc(unsafe.Pointer(h), callerpc, pc) raceReadObjectPC(t.key, key, callerpc, pc) } if msanenabled { msanread(key, t.key.size) } // æœ‰å…¶ä»– goroutine æ­£åœ¨å¾€ map ä¸­å†™ keyï¼Œä¼šæŠ›å‡ºä»¥ä¸‹é”™è¯¯ if h.flags\u0026amp;hashWriting != 0 { throw(\u0026quot;concurrent map writes\u0026quot;) } // é€šè¿‡ key å’Œå“ˆå¸Œç§å­ï¼Œç®—å‡ºå¯¹åº”å“ˆå¸Œå€¼ hash := t.hasher(key, uintptr(h.hash0)) //println(\u0026quot;this key hash is \u0026quot;, hash) // å°† flags çš„å€¼ä¸ hashWriting åšæŒ‰ä½æˆ–è¿ç®— // å› ä¸ºåœ¨å½“å‰ goroutine å¯èƒ½è¿˜æœªå®Œæˆ key çš„å†™å…¥ï¼Œå†æ¬¡è°ƒç”¨ t.hasher ä¼šå‘ç”Ÿ panicã€‚ // Set hashWriting after calling t.hasher, since t.hasher may panic, // in which case we have not actually done a write. h.flags ^= hashWriting if h.buckets == nil { h.buckets = newobject(t.bucket) // newarray(t.bucket, 1) } again: // bucketMask è¿”å›å€¼æ˜¯ 2 çš„ B æ¬¡æ–¹å‡ 1 // å› æ­¤ï¼Œé€šè¿‡ hash å€¼ä¸ bucketMask è¿”å›å€¼åšæŒ‰ä½ä¸æ“ä½œï¼Œ // è¿”å›çš„åœ¨ buckets æ•°ç»„ä¸­çš„ç¬¬å‡ å·æ¡¶ bucket := hash \u0026amp; bucketMask(h.B) //println(\u0026quot;this key will store in bucket \u0026quot;, bucket) // å¦‚æœ map æ­£åœ¨æ¬è¿ï¼ˆå³ h.oldbuckets != nilï¼‰ä¸­,åˆ™åŒæ—¶è¿›è¡Œæ¬è¿å·¥ä½œ // è¿™é‡Œæ¶‰åŠåˆ°äº†æ¸è¿›å¼æ‰©å®¹è¿™ä¸€æ¦‚å¿µï¼Œå³æ‰©å®¹ä¸æ˜¯ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰é”®ï¼Œè€Œæ˜¯åœ¨å…¶ä»– // æ“ä½œä¸­è¿›è¡Œå°éƒ¨åˆ†è¿ç§» if h.growing() { //println(\u0026quot;the map is growing!\u0026quot;) growWork(t, h, bucket) } // è®¡ç®—å‡ºä¸Šé¢æ±‚å‡ºçš„ç¬¬å‡ å· bucket çš„å†…å­˜ä½ç½® b := (*bmap)(add(h.buckets, bucket*uintptr(t.bucketsize))) // è®¡ç®—å‡º tophash top := tophash(hash) //println(\u0026quot;this key's tophash is: \u0026quot;, top) // æ˜¯å¦å½“å‰ key æ˜¯å¦å·²ç»æ·»åŠ æˆåŠŸäº†ï¼Œå¦‚æœä¸º nil åˆ™è¡¨ç¤ºæœªæˆåŠŸ var inserti *uint8 var insertk unsafe.Pointer // key çš„åœ°å€ var elem unsafe.Pointer // value çš„åœ°å€ bucketloop: for { // éå†æ¡¶ä¸­çš„ 8 ä¸ª cellï¼Œæ‰¾åˆ°ä¸€ä¸ªç©ºä½æ’å…¥ for i := uintptr(0); i \u0026lt; bucketCnt; i++ { //println(\u0026quot;cur bucket tophash is \u0026quot;, b.tophash[i]) // å¦‚æœå½“å‰ cell çš„ tophash ä¸ç­‰äºå½“å‰ key çš„ tophash if b.tophash[i] != top { //println(\u0026quot;b.tophash[i] != top\u0026quot;) // å¦‚æœ cell ä½ä¸ºç©ºï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨å¯¹åº”ä½ç½®è¿›è¡Œæ’å…¥ if isEmpty(b.tophash[i]) \u0026amp;\u0026amp; inserti == nil { inserti = \u0026amp;b.tophash[i] // æ›´æ–° insertiï¼Œè¡¨ç¤ºå·²ç»æ·»åŠ æˆåŠŸ insertk = add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) } // emptyRest è¡¨ç¤ºå½“å‰ cell åŠä¹‹åéƒ½ä¸ºç©ºï¼Œæ­¤æ—¶å·²ç»æ‰¾åˆ°ç©ºä½äº†ï¼Œ // æ‰€ä»¥æ²¡å¿…è¦å†éå†äº† if b.tophash[i] == emptyRest { break bucketloop } continue } // ç¬¬äºŒç§æƒ…å†µæ˜¯ cell ä½çš„ tophash å€¼å’Œå½“å‰çš„ tophash å€¼ç›¸ç­‰ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } // å³ä½¿å½“å‰ cell ä½çš„ tophash å€¼ç›¸ç­‰ï¼Œä¸ä¸€å®šå®ƒå¯¹åº”çš„ key ä¹Ÿæ˜¯ç›¸ç­‰çš„ï¼Œ // æ‰€ä»¥è¿˜è¦åšä¸€ä¸ª key å€¼åˆ¤æ–­ï¼Œkey å€¼ä¸åŒåˆ™ continue ç»§ç»­å¯»æ‰¾ç©ºä½ if !t.key.equal(key, k) { //println(\u0026quot;tophash equal but key not equal\u0026quot;) continue } // å¦‚æœå·²ç»æœ‰è¯¥ key äº†ï¼Œå°±æ›´æ–°å®ƒ // already have a mapping for key. Update it. if t.needkeyupdate() { //println(\u0026quot;tophash equal and key equal, update the value\u0026quot;) typedmemmove(t.key, k, key) } // è¿™é‡Œè·å–åˆ°äº†è¦æ’å…¥ key å¯¹åº”çš„ value çš„å†…å­˜åœ°å€ elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) // å¦‚æœé¡ºåˆ©åˆ°è¿™ï¼Œå°±ç›´æ¥è·³åˆ° done çš„ç»“æŸé€»è¾‘ä¸­å» goto done } //println(\u0026quot;range this bucket over, not find empty cell to insert key, continue range overflow buckets\u0026quot;) // å¦‚æœæ¡¶ä¸­çš„ 8 ä¸ª cell éå†å®Œï¼Œè¿˜æœªæ‰¾åˆ°å¯¹åº”çš„ç©º cell æˆ–è¦†ç›– cellï¼Œ // é‚£ä¹ˆå°±è¿›å…¥å®ƒçš„æº¢å‡ºæ¡¶ä¸­å»éå† ovf := b.overflow(t) // å¦‚æœè¿æº¢å‡ºæ¡¶ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ cellï¼Œè·³å‡ºå¾ªç¯ if ovf == nil { //println(\u0026quot;overflow buckets not find empty cell, need grow\u0026quot;) break } b = ovf } // åœ¨å·²æœ‰çš„æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­éƒ½æœªæ‰¾åˆ°åˆé€‚çš„ cell ä¾› key å†™å…¥ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¼šè§¦å‘ä»¥ä¸‹ä¸¤ç§æƒ…å†µ // æƒ…å†µä¸€ï¼š // åˆ¤æ–­å½“å‰ map çš„è£…è½½å› å­æ˜¯å¦è¾¾åˆ°è®¾å®šçš„ 6.5 é˜ˆå€¼ï¼Œæˆ–è€…å½“å‰ map çš„æº¢å‡ºæ¡¶æ•°é‡æ˜¯å¦è¿‡å¤šã€‚ // å¦‚æœå­˜åœ¨è¿™ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œã€‚ // hashGrow() å®é™…å¹¶æœªå®Œæˆæ‰©å®¹ï¼Œå¯¹å“ˆå¸Œè¡¨æ•°æ®çš„æ¬è¿ï¼ˆå¤åˆ¶ï¼‰æ“ä½œæ˜¯é€šè¿‡ growWork() æ¥å®Œæˆçš„ã€‚ // é‡æ–°è·³å…¥ again é€»è¾‘ï¼Œåœ¨è¿›è¡Œå®Œ growWork() æ“ä½œåï¼Œå†æ¬¡éå†æ–°çš„æ¡¶ã€‚ // Did not find mapping for key. Allocate new cell \u0026amp; add entry. // If we hit the max load factor or we have too many overflow buckets, // and we're not already in the middle of growing, start growing. if !h.growing() \u0026amp;\u0026amp; (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) { hashGrow(t, h) goto again // Growing the table invalidates everything, so try again } // æƒ…å†µäºŒï¼š // åœ¨ä¸æ»¡è¶³æƒ…å†µä¸€çš„æ¡ä»¶ä¸‹ï¼Œä¼šä¸ºå½“å‰æ¡¶å†æ–°å»ºæº¢å‡ºæ¡¶ï¼Œå¹¶å°† tophashï¼Œ // key æ’å…¥åˆ°æ–°å»ºæº¢å‡ºæ¡¶çš„å¯¹åº”å†…å­˜çš„ 0 å·ä½ç½® if inserti == nil { // The current bucket and all the overflow buckets connected to it are full, allocate a new one. newb := h.newoverflow(t, b) inserti = \u0026amp;newb.tophash[0] insertk = add(unsafe.Pointer(newb), dataOffset) elem = add(insertk, bucketCnt*uintptr(t.keysize)) } // åœ¨æ’å…¥ä½ç½®å­˜å…¥æ–°çš„ key å’Œ value // store new key/elem at insert position if t.indirectkey() { kmem := newobject(t.key) *(*unsafe.Pointer)(insertk) = kmem insertk = kmem } if t.indirectelem() { vmem := newobject(t.elem) *(*unsafe.Pointer)(elem) = vmem } typedmemmove(t.key, insertk, key) *inserti = top // map ä¸­çš„ key æ•°é‡ + 1 h.count++ done: if h.flags\u0026amp;hashWriting == 0 { throw(\u0026quot;concurrent map writes\u0026quot;) } h.flags \u0026amp;^= hashWriting if t.indirectelem() { elem = *((*unsafe.Pointer)(elem)) } return elem } åˆ é™¤ func mapdelete(t *maptype, h *hmap, key unsafe.Pointer) { if raceenabled \u0026amp;\u0026amp; h != nil { callerpc := getcallerpc() pc := funcPC(mapdelete) racewritepc(unsafe.Pointer(h), callerpc, pc) raceReadObjectPC(t.key, key, callerpc, pc) } if msanenabled \u0026amp;\u0026amp; h != nil { msanread(key, t.key.size) } if h == nil || h.count == 0 { if t.hashMightPanic() { t.hasher(key, 0) // see issue 23734 } return } if h.flags\u0026amp;hashWriting != 0 { throw(\u0026quot;concurrent map writes\u0026quot;) } hash := t.hasher(key, uintptr(h.hash0)) // Set hashWriting after calling t.hasher, since t.hasher may panic, // in which case we have not actually done a write (delete). h.flags ^= hashWriting bucket := hash \u0026amp; bucketMask(h.B) if h.growing() { growWork(t, h, bucket) } b := (*bmap)(add(h.buckets, bucket*uintptr(t.bucketsize))) bOrig := b top := tophash(hash) search: for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u0026lt; bucketCnt; i++ { if b.tophash[i] != top { if b.tophash[i] == emptyRest { break search } continue } k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) k2 := k if t.indirectkey() { k2 = *((*unsafe.Pointer)(k2)) } if !t.key.equal(key, k2) { continue } // Only clear key if there are pointers in it. if t.indirectkey() { *(*unsafe.Pointer)(k) = nil } else if t.key.ptrdata != 0 { memclrHasPointers(k, t.key.size) } e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { *(*unsafe.Pointer)(e) = nil } else if t.elem.ptrdata != 0 { memclrHasPointers(e, t.elem.size) } else { memclrNoHeapPointers(e, t.elem.size) } b.tophash[i] = emptyOne // If the bucket now ends in a bunch of emptyOne states, // change those to emptyRest states. // It would be nice to make this a separate function, but // for loops are not currently inlineable. if i == bucketCnt-1 { if b.overflow(t) != nil \u0026amp;\u0026amp; b.overflow(t).tophash[0] != emptyRest { goto notLast } } else { if b.tophash[i+1] != emptyRest { goto notLast } } for { b.tophash[i] = emptyRest if i == 0 { if b == bOrig { break // beginning of initial bucket, we're done. } // Find previous bucket, continue at its last entry. c := b for b = bOrig; b.overflow(t) != c; b = b.overflow(t) { } i = bucketCnt - 1 } else { i-- } if b.tophash[i] != emptyOne { break } } notLast: h.count-- // Reset the hash seed to make it more difficult for attackers to // repeatedly trigger hash collisions. See issue 25237. if h.count == 0 { h.hash0 = fastrand() } break search } } if h.flags\u0026amp;hashWriting == 0 { throw(\u0026quot;concurrent map writes\u0026quot;) } h.flags \u0026amp;^= hashWriting } æ‰©å®¹ æ‰©å®¹ç­–ç•¥åˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\nåˆ¤æ–­å·²ç»è¾¾åˆ°è£…è½½å› å­çš„ä¸´ç•Œç‚¹ï¼Œå³å…ƒç´ ä¸ªæ•° \u0026gt;= æ¡¶ï¼ˆbucketï¼‰æ€»æ•° * 6.5ï¼Œè¿™æ—¶å€™è¯´æ˜å¤§éƒ¨åˆ†çš„æ¡¶å¯èƒ½éƒ½å¿«æ»¡äº†ï¼ˆå³å¹³å‡æ¯ä¸ªæ¡¶å­˜å‚¨çš„é”®å€¼å¯¹è¾¾åˆ°6.5ä¸ªï¼‰ï¼Œå¦‚æœæ’å…¥æ–°å…ƒç´ ï¼Œæœ‰å¤§æ¦‚ç‡éœ€è¦æŒ‚åœ¨æº¢å‡ºæ¡¶ï¼ˆoverflow bucketï¼‰ä¸Šï¼Œåˆ¤æ–­ å‡½æ•°ä¸º overLoadFactor\nåˆ¤æ–­æº¢å‡ºæ¡¶æ˜¯å¦å¤ªå¤šï¼Œå½“æ¡¶æ€»æ•° \u0026lt; 2 ^ 15 æ—¶ï¼Œå¦‚æœæº¢å‡ºæ¡¶æ€»æ•° \u0026gt;= æ¡¶æ€»æ•°ï¼Œ åˆ™è®¤ä¸ºæº¢å‡ºæ¡¶è¿‡å¤šã€‚å½“æ¡¶æ€»æ•° \u0026gt;= 2 ^ 15 æ—¶ï¼Œç›´æ¥ä¸ 2 ^ 15 æ¯”è¾ƒï¼Œå½“æº¢å‡º æ¡¶æ€»æ•° \u0026gt;= 2 ^ 15 æ—¶ï¼Œå³è®¤ä¸ºæº¢å‡ºæ¡¶å¤ªå¤šäº†ï¼Œåˆ¤æ–­å‡½æ•°ï¼štooManyOverflowBuckets\nåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ä¸æ–­çš„å¢åˆ ï¼Œè¿™æ ·ä¼šé€ æˆ overflow çš„ bucket æ•°é‡å¢å¤šï¼Œä½†è´Ÿè½½å› å­ åˆä¸é«˜ï¼Œæœªè¾¾ä¸åˆ°ç¬¬ 1 ç‚¹çš„ä¸´ç•Œå€¼ï¼Œå°±ä¸èƒ½è§¦å‘æ‰©å®¹æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚è¿™æ ·ä¼šé€ æˆæ¡¶çš„ä½¿ç”¨ç‡ä¸é«˜ï¼Œ å€¼å­˜å‚¨å¾—æ¯”è¾ƒç¨€ç–ï¼ŒæŸ¥æ‰¾æ’å…¥æ•ˆç‡ä¼šå˜å¾—éå¸¸ä½ï¼Œå› æ­¤æœ‰äº†ç¬¬ 2 ç‚¹åˆ¤æ–­æŒ‡æ ‡ã€‚è¿™å°±åƒæ˜¯ä¸€åº§ç©ºåŸï¼Œæˆ¿ å­å¾ˆå¤šï¼Œä½†æ˜¯ä½æˆ·å¾ˆå°‘ï¼Œéƒ½åˆ†æ•£äº†ï¼Œæ‰¾èµ·äººæ¥å¾ˆå›°éš¾\nä¸¤ç§æƒ…å†µå®˜æ–¹é‡‡ç”¨äº†ä¸åŒçš„è§£å†³æ–¹æ¡ˆ\né’ˆå¯¹ 1ï¼Œå°† B + 1ï¼ˆæ¡¶æ•°é‡ä¸º 2 ^ Bï¼ŒB+1 åˆ™ä»£è¡¨ç¿»å€ï¼‰ï¼Œæ–°å»ºä¸€ä¸ª buckets æ•°ç»„ï¼Œ æ–°çš„ buckets å¤§å°æ˜¯åŸæ¥çš„ 2 å€ï¼Œç„¶åæ—§ buckets æ•°æ®æ¬è¿åˆ°æ–°çš„ bucketsã€‚è¯¥æ–¹æ³•æˆ‘ä»¬ç§°ä¹‹ä¸ºå¢é‡æ‰©å®¹ã€‚\né’ˆå¯¹ 2ï¼Œå¹¶ä¸æ‰©å¤§å®¹é‡ï¼Œbuckets æ•°é‡ç»´æŒä¸å˜ï¼Œé‡æ–°åšä¸€éç±»ä¼¼å¢é‡æ‰©å®¹çš„æ¬è¿åŠ¨ä½œï¼ŒæŠŠæ¾æ•£çš„é”®å€¼å¯¹ é‡æ–°æ’åˆ—ä¸€æ¬¡ï¼ŒæŠŠåœ¨ overflow bucket ä¸­çš„ key ç§»åŠ¨åˆ° bucket ä¸­æ¥ä»¥ä½¿ bucket çš„ä½¿ç”¨ç‡ æ›´é«˜ï¼Œè¿›è€Œä¿è¯æ›´å¿«çš„å­˜å–ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬ç§°ä¹‹ä¸ºç­‰é‡æ‰©å®¹ã€‚\nåˆ¤æ–­æ‰©å®¹æ¡ä»¶å‡½æ•° tooManyOverflowBuckets åˆ¤æ–­æº¢å‡ºæ¡¶æ˜¯å¦å¤ªå¤šï¼Œå½“æ¡¶æ€»æ•° \u0026lt; 2 ^ 15 æ—¶ï¼Œå¦‚æœæº¢å‡ºæ¡¶æ€»æ•° \u0026gt;= æ¡¶æ€»æ•°ï¼Œåˆ™è®¤ä¸ºæº¢å‡ºæ¡¶è¿‡å¤šã€‚å½“æ¡¶æ€»æ•° \u0026gt;= 2 ^ 15 æ—¶ï¼Œç›´æ¥ä¸ 2 ^ 15 æ¯”è¾ƒï¼Œå½“æº¢å‡ºæ¡¶æ€»æ•° \u0026gt;= 2 ^ 15 æ—¶ï¼Œå³è®¤ä¸ºæº¢å‡ºæ¡¶å¤ªå¤šäº†ã€‚\n// tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1\u0026lt;\u0026lt;B buckets. // Note that most of these overflow buckets must be in sparse use; // if use was dense, then we'd have already triggered regular map growth. func tooManyOverflowBuckets(noverflow uint16, B uint8) bool { // If the threshold is too low, we do extraneous work. // If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory. // \u0026quot;too many\u0026quot; means (approximately) as many overflow buckets as regular buckets. // See incrnoverflow for more details. if B \u0026gt; 15 { B = 15 } // The compiler doesn't see here that B \u0026lt; 16; mask B to generate shorter shift code. return noverflow \u0026gt;= uint16(1)\u0026lt;\u0026lt;(B\u0026amp;15) } overLoadFactor åˆ¤æ–­å·²ç»è¾¾åˆ°è£…è½½å› å­çš„ä¸´ç•Œç‚¹ï¼Œå³å…ƒç´ ä¸ªæ•° \u0026gt;= æ¡¶ï¼ˆbucketï¼‰æ€»æ•° * 6.5ï¼Œè¿™æ—¶å€™è¯´æ˜å¤§éƒ¨åˆ†çš„æ¡¶å¯èƒ½éƒ½å¿«æ»¡äº† ï¼ˆå³å¹³å‡æ¯ä¸ªæ¡¶å­˜å‚¨çš„é”®å€¼å¯¹è¾¾åˆ° 6.5 ä¸ªï¼‰ï¼Œå¦‚æœæ’å…¥æ–°å…ƒç´ ï¼Œæœ‰å¤§æ¦‚ç‡éœ€è¦æŒ‚åœ¨æº¢å‡ºæ¡¶ï¼ˆoverflow bucketï¼‰ä¸Šã€‚\n// overLoadFactor reports whether count items placed in 1\u0026lt;\u0026lt;B buckets is over loadFactor. func overLoadFactor(count int, B uint8) bool { return count \u0026gt; bucketCnt \u0026amp;\u0026amp; uintptr(count) \u0026gt; loadFactorNum*(bucketShift(B)/loadFactorDen) } æ‰©å®¹å‡½æ•° hashGrow // hashGrow() å‡½æ•°å®é™…ä¸Šå¹¶æ²¡æœ‰çœŸæ­£åœ°â€œæ¬è¿â€ï¼Œå®ƒåªæ˜¯åˆ†é…å¥½äº†æ–°çš„ bucketsï¼Œå¹¶å°†è€çš„ buckets // æŒ‚åˆ°äº† hmap.oldbuckets å­—æ®µä¸Šã€‚ func hashGrow(t *maptype, h *hmap) { // If we've hit the load factor, get bigger. // Otherwise, there are too many overflow buckets, // so keep the same number of buckets and \u0026quot;grow\u0026quot; laterally. bigger := uint8(1) // å¦‚æœæ²¡æœ‰è¾¾åˆ°è´Ÿè½½å› å­ä¸´ç•Œç‚¹ï¼Œåˆ™è®¾ç½®ä¸ºç­‰é‡æ‰©å®¹ if !overLoadFactor(h.count+1, h.B) { bigger = 0 // bigger è®¾ç½®ä¸º 0 h.flags |= sameSizeGrow } // è®°å½•è€ buckets çš„ä½ç½® oldbuckets := h.buckets // åˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„ç”¨æ¥å­˜æ”¾æ–°æ¡¶ newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, nil) flags := h.flags \u0026amp;^ (iterator | oldIterator) if h.flags\u0026amp;iterator != 0 { flags |= oldIterator } // commit the grow (atomic wrt gc) h.B += bigger h.flags = flags h.oldbuckets = oldbuckets h.buckets = newbuckets h.nevacuate = 0 h.noverflow = 0 if h.extra != nil \u0026amp;\u0026amp; h.extra.overflow != nil { // Promote current overflow buckets to the old generation. if h.extra.oldoverflow != nil { throw(\u0026quot;oldoverflow is not nil\u0026quot;) } h.extra.oldoverflow = h.extra.overflow h.extra.overflow = nil } if nextOverflow != nil { if h.extra == nil { h.extra = new(mapextra) } h.extra.nextOverflow = nextOverflow } // the actual copying of the hash table data is done incrementally // by growWork() and evacuate(). } growWork // çœŸæ­£æ¬è¿ buckets çš„åŠ¨ä½œåœ¨ growWork() å‡½æ•°ä¸­ï¼Œè€Œè°ƒç”¨ growWork() å‡½æ•°çš„åŠ¨ä½œæ˜¯åœ¨ // mapassign() å’Œ mapdelete() å‡½æ•°ä¸­ã€‚ä¹Ÿå°±æ˜¯æ’å…¥ï¼ˆåŒ…æ‹¬ä¿®æ”¹ï¼‰ã€åˆ é™¤ key çš„æ—¶å€™ï¼Œéƒ½ // ä¼šå°è¯•è¿›è¡Œæ¬è¿ buckets çš„å·¥ä½œã€‚å®ƒä»¬ä¼šå…ˆæ£€æŸ¥ oldbuckets æ˜¯å¦æ¬è¿å®Œæ¯•ï¼ˆæ£€æŸ¥ oldbuckets // æ˜¯å¦ä¸º nilï¼‰ï¼Œå†å†³å®šæ˜¯å¦è¿›è¡Œæ¬è¿å·¥ä½œã€‚ // growWork ä¼šæ¬è¿ 0~2 ä¸ªæ¡¶ func growWork(t *maptype, h *hmap, bucket uintptr) { // make sure we evacuate the oldbucket corresponding // to the bucket we're about to use evacuate(t, h, bucket\u0026amp;h.oldbucketmask()) // evacuate one more oldbucket to make progress on growing if h.growing() { // å†å¤šæ¬è¿ä¸€ä¸ªæ¡¶ evacuate(t, h, h.nevacuate) } } ç–‘é—® å¦‚æœä¸¤ä¸ª key è½å…¥åŒä¸€ä¸ªæ¡¶ï¼Œä¸”æ°å·§å®ƒä»¬çš„ tophash ä¹Ÿç›¸åŒï¼Œæ­¤æ—¶çš„æ·»åŠ å’ŒæŸ¥æ‰¾æµç¨‹ä¼šæ€æ ·ï¼Ÿ å¯¹äº æŸ¥æ‰¾ è€Œè¨€ï¼Œå¦‚æœ tophash ç›¸åŒè¿˜ä¼šè¿›ä¸€æ­¥åˆ¤æ–­ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœ key ç›¸åŒåˆ™è¿”å›ï¼Œä¸åŒåˆ™ç»§ç»­æŸ¥æ‰¾ã€‚\næ·»åŠ  ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå¦‚æœ tophash å’Œ key éƒ½ç›¸åŒï¼Œè¯´æ˜è¯¥ key å·²ç»å­˜åœ¨ï¼Œä¼šæ‰§è¡Œæ›´æ–°æ“ä½œï¼Œå¦åˆ™ç»§ç»­å¯»æ‰¾ç©ºä½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªæ¡¶ä¸­å¯èƒ½å‡ºç°ç›¸åŒç›¸åŒçš„ tophashã€‚\ngo map çš„è´Ÿè½½å› å­æ˜¯å¤šå°‘ï¼Ÿ è´Ÿè½½å› å­æ˜¯ 6.5ï¼Œåœ¨æºç ä¸­è¡¨ç°ä¸ºï¼š\n// Maximum average load of a bucket that triggers growth is 6.5. // Represent as loadFactorNum/loadFactorDen, to allow integer math. loadFactorNum = 13 loadFactorDen = 2 å‚è€ƒ Goæ˜¯å¦‚ä½•è®¾è®¡Mapçš„ â€” æœºå™¨é“ƒç èœåˆ€ï¼Œhttps://mp.weixin.qq.com/s/q3qyc5uf3IMVt4KQD12IKQ\nã€Golangã€‘Mapé•¿å•¥æ ·å„¿ï¼Ÿâ€” å¹¼éºŸå®éªŒå®¤ï¼Œhttps://www.bilibili.com/video/BV1Sp4y1U7dJ\n","date":"2021å¹´07æœˆ29æ—¥","permalink":"/posts/go-map-yuan-ma-yue-du/","summary":"çœ‹çœ‹ map è¿™ä¸ªé‡è¦æ•°æ®ç»“æ„åœ¨ go ä¸­æ˜¯å¦‚ä½•å®ç°çš„","title":"go mapæºç é˜…è¯»"},{"contents":" ç»™ä½ ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯Â kÂ ä¸ªèŠ‚ç‚¹ä¸€ç»„è¿›è¡Œç¿»è½¬ï¼Œè¯·ä½ è¿”å›ç¿»è½¬åçš„é“¾è¡¨ã€‚\nkÂ æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œå®ƒçš„å€¼å°äºæˆ–ç­‰äºé“¾è¡¨çš„é•¿åº¦ã€‚\nå¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸æ˜¯Â kÂ çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆè¯·å°†æœ€åå‰©ä½™çš„èŠ‚ç‚¹ä¿æŒåŸæœ‰é¡ºåºã€‚\nè¿›é˜¶ï¼š\nä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªåªä½¿ç”¨å¸¸æ•°é¢å¤–ç©ºé—´çš„ç®—æ³•æ¥è§£å†³æ­¤é—®é¢˜å—ï¼Ÿ ä½ ä¸èƒ½åªæ˜¯å•çº¯çš„æ”¹å˜èŠ‚ç‚¹å†…éƒ¨çš„å€¼ï¼Œè€Œæ˜¯éœ€è¦å®é™…è¿›è¡ŒèŠ‚ç‚¹äº¤æ¢ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šhead = [1,2,3,4,5], k = 2 è¾“å‡ºï¼š[2,1,4,3,5]\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šhead = [1,2,3,4,5], k = 3 è¾“å‡ºï¼š[3,2,1,4,5]\nç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šhead = [1,2,3,4,5], k = 1 è¾“å‡ºï¼š[1,2,3,4,5]\nç¤ºä¾‹ 4ï¼š\nè¾“å…¥ï¼šhead = [1], k = 1 è¾“å‡ºï¼š[1]\næç¤ºï¼š\nåˆ—è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡åœ¨èŒƒå›´ sz å†… 1 \u0026lt;= sz \u0026lt;= 5000 0 \u0026lt;= Node.val \u0026lt;= 1000 1 \u0026lt;= k \u0026lt;= sz\næ–¹æ³• è¿™é‡Œå€Ÿç”¨ leetcode é¢˜è§£çš„å›¾ç‰‡ï¼Œæ¯”è¾ƒç›´è§‚ï¼Œåªè¦ç…§ç€å›¾ä¸Šçš„æµç¨‹ï¼ŒåŸºæœ¬å°±å¯ä»¥ç¼–å†™å‡ºä»£ç äº†ã€‚ å›¾ç‰‡æ¥æºï¼šhttps://leetcode-cn.com/problems/reverse-nodes-in-k-group/solution/tu-jie-kge-yi-zu-fan-zhuan-lian-biao-by-user7208t/\nä»£ç  /** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */ func reverseKGroup(head *ListNode, k int) *ListNode { s := \u0026amp;ListNode{Next: head} var ( pre = s // start çš„å‰ç»§èŠ‚ç‚¹ next = pre // end çš„åç»§èŠ‚ç‚¹ start *ListNode // è¦ç¿»è½¬çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ end = pre // è¦ç¿»è½¬çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ ) for pre != nil { start = pre.Next // end ç§»åŠ¨åˆ°è¦ç¿»è½¬çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ for i := 0; i \u0026lt; k; i++ { end = end.Next if end == nil { return s.Next } } next = end.Next end.Next = nil // æ–­é“¾ rh, rt := reverse(start) // åè½¬ start - end // é‡æ–°è¿æ¥é“¾è¡¨ pre.Next = rh rt.Next = next pre = rt end = rt } return s.Next } func reverse(head *ListNode) (rhead, rtail *ListNode) { var ( cur = head prev, next *ListNode ) for cur != nil { next = cur.Next cur.Next = prev prev = cur cur = next } return prev, head } ","date":"2021å¹´07æœˆ29æ—¥","permalink":"/posts/leetcode-25-k-ge-yi-zu-fan-zhuan-lian-biao/","summary":"ç»™ä½ ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯Â kÂ ä¸ªèŠ‚ç‚¹ä¸€ç»„è¿›è¡Œç¿»è½¬ï¼Œè¯·ä½ è¿”å›ç¿»è½¬åçš„é“¾è¡¨ã€‚\nkÂ æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œå®ƒçš„å€¼å°äºæˆ–ç­‰äºé“¾è¡¨çš„é•¿åº¦ã€‚","title":"leetcode 25. K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨"},{"contents":" ç»™å®šäºŒå‰æ ‘å…¶ä¸­çš„ä¸€ä¸ªç»“ç‚¹ï¼Œè¯·æ‰¾å‡ºå…¶ä¸­åºéå†é¡ºåºçš„ä¸‹ä¸€ä¸ªç»“ç‚¹å¹¶ä¸”è¿”å›ã€‚\næ³¨æ„ï¼Œæ ‘ä¸­çš„ç»“ç‚¹ä¸ä»…åŒ…å«å·¦å³å­ç»“ç‚¹ï¼Œè€Œä¸”åŒ…å«æŒ‡å‘çˆ¶ç»“ç‚¹çš„æŒ‡é’ˆã€‚\nç¤ºä¾‹: è¾“å…¥:{8,6,10,5,7,9,11},8 è¿”å›:9 è§£æ:è¿™ä¸ªç»„è£…ä¼ å…¥çš„å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯æ•´é¢—æ ‘ï¼Œä¸­åºéå†{5,6,7,8,9,10,11}ï¼Œæ ¹èŠ‚ç‚¹8çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯9ï¼Œåº”è¯¥è¿”å›{9,10,11}ï¼Œåå°åªæ‰“å°å­æ ‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥åªä¼šæ‰“å°9ï¼Œå¦‚ä¸‹å›¾ï¼Œå…¶å®éƒ½æœ‰æŒ‡å‘å·¦å³å­©å­çš„æŒ‡é’ˆï¼Œè¿˜æœ‰æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä¸‹å›¾æ²¡æœ‰ç”»å‡ºæ¥ ç‰¹åˆ«è¯´æ˜ï¼šleetcode ä¸Šæ²¡æœ‰è¿™é“é¢˜ï¼Œæµ‹è¯„è¯·å‰å¾€ç‰›å®¢ï¼Œè¯„æµ‹åœ°å€ï¼šhttps://www.nowcoder.com/questionTerminal/9023a0c988684a53960365b889ceaf5e\nåˆ†æ æœ‰å¦‚ä¸‹æƒ…å†µï¼š\nè¯¥èŠ‚ç‚¹æœ‰å³å­æ ‘ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­çš„ 8ï¼Œå…¶å³å­æ ‘ä¸º 10ï¼Œ10 çš„æœ€å·¦èŠ‚ç‚¹ä¸º 9ï¼Œæ‰€ä»¥ 8 çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ 9ã€‚\nè¯¥èŠ‚ç‚¹æ— å³å­æ ‘ï¼Œé‚£ä¹ˆåˆæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\nè¯¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œæ¯”å¦‚ 9 å°±æ˜¯å…¶çˆ¶èŠ‚ç‚¹ 10 çš„å·¦å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯çˆ¶èŠ‚ç‚¹ã€‚\nè¯¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œæ¯”å¦‚ 7 å°±æ˜¯å…¶çˆ¶èŠ‚ç‚¹ 6 çš„å³å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ï¼šå·¦å­èŠ‚ç‚¹æ˜¯å…¶çˆ¶èŠ‚ç‚¹ çš„èŠ‚ç‚¹ï¼Œè¯´èµ·æ¥æ¯”è¾ƒç»•ï¼Œå°±æ˜¯å·¦å­èŠ‚ç‚¹ä¸º 6 çš„èŠ‚ç‚¹ï¼Œåœ¨å›¾ä¸­æ˜¯ 8ã€‚\nå†ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå¦‚æœç»™å®šçš„èŠ‚ç‚¹ä¸º 11 ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸º 10ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º 10ï¼Œæ­¤æ—¶åªèƒ½ç»§ç»­å‘ä¸Šæ‰¾ï¼Œçœ‹ 10 çš„çˆ¶èŠ‚ç‚¹ 8 çš„æƒ…å†µï¼ŒåŒæ ·çš„ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º 8ï¼Œç»§ç»­å‘ä¸Šï¼Œä½†æ­¤æ—¶ 8 å·²ç»æ²¡æœ‰çˆ¶èŠ‚ç‚¹äº†ï¼Œæ‰€ä»¥è¿”å› nil\nä»£ç  package main /* type TreeLinkNode struct { Val int Left *TreeLinkNode Right *TreeLinkNode Next *TreeLinkNode } */ func GetNext(pNode *TreeLinkNode) *TreeLinkNode { // å³å­æ ‘ä¸ä¸ºç©º if pNode.Right != nil { p := pNode.Right // å³å­æ ‘ä¸­æœ€å·¦è¾¹çš„èŠ‚ç‚¹ for p.Left != nil { p = p.Left } return p } else {\t// å³å­æ ‘ä¸ºç©º // å¦‚æœ pNode æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆæ³¨æ„çˆ¶èŠ‚ç‚¹çš„éç©ºåˆ¤æ–­ï¼‰ if pNode.Next != nil \u0026amp;\u0026amp; pNode.Next.Left == pNode { // åˆ™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹ return pNode.Next } else { // pNode æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ p := pNode.Next\t// pNode çš„çˆ¶èŠ‚ç‚¹ // ä¸æ–­å‘ä¸ŠæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸º p æˆ–è€… p == nil for p != nil \u0026amp;\u0026amp; p.Next != nil { // å¦‚æœ pï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰çš„çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸æ˜¯ p // åˆ™ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ if p.Next.Left != p { p = p.Next } else { return p.Next } } } } return nil } ","date":"2021å¹´07æœˆ28æ—¥","permalink":"/posts/bian-cheng-ti-er-cha-shu-de-xia-yi-ge-jie-dian/","summary":"ç»™å®šäºŒå‰æ ‘å…¶ä¸­çš„ä¸€ä¸ªç»“ç‚¹ï¼Œè¯·æ‰¾å‡ºå…¶ä¸­åºéå†é¡ºåºçš„ä¸‹ä¸€ä¸ªç»“ç‚¹å¹¶ä¸”è¿”å›ã€‚\næ³¨æ„ï¼Œæ ‘ä¸­çš„ç»“ç‚¹ä¸ä»…åŒ…å«å·¦å³å­ç»“ç‚¹ï¼Œè€Œä¸”åŒ…å«æŒ‡å‘çˆ¶ç»“ç‚¹çš„æŒ‡é’ˆã€‚\nç¤ºä¾‹: è¾“å…¥:{8,6,10,5,7,9,11},8 è¿”å›:9 è§£æ:è¿™ä¸ªç»„è£…ä¼ å…¥çš„å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯æ•´é¢—æ ‘ï¼Œä¸­åºéå†{5,6,7,8,9,10,11}ï¼Œæ ¹èŠ‚ç‚¹8çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯9ï¼Œåº”è¯¥è¿”å›{9,10,11}ï¼Œåå°åªæ‰“å°å­æ ‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥åªä¼šæ‰“å°9ï¼Œå¦‚ä¸‹å›¾ï¼Œå…¶å®éƒ½æœ‰æŒ‡å‘å·¦å³å­©å­çš„æŒ‡é’ˆï¼Œè¿˜æœ‰æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä¸‹å›¾æ²¡æœ‰ç”»å‡ºæ¥ ç‰¹åˆ«è¯´æ˜ï¼šleetcode ä¸Šæ²¡æœ‰è¿™é“é¢˜ï¼Œæµ‹è¯„è¯·å‰å¾€ç‰›å®¢ï¼Œè¯„æµ‹åœ°å€ï¼šhttps://www.","title":"[ç¼–ç¨‹é¢˜]äºŒå‰æ ‘çš„ä¸‹ä¸€ä¸ªç»“ç‚¹"},{"contents":"MySQL é¢ç»æ±‡æ€»ï¼Œæ”¶é›†äºç‰›å®¢ï¼Œä¸æ–­æ›´æ–°ä¸­\n1. char å’Œ varchar çš„åŒºåˆ« char æ˜¯å›ºå®šé•¿åº¦ï¼Œvarchar é•¿åº¦å¯å˜ï¼Œå­˜å‚¨æ—¶ï¼Œå‰è€…ä¸ç®¡å®é™…å­˜å‚¨æ•°æ®çš„é•¿åº¦ï¼Œç›´æ¥è§„å®š char è§„å®šçš„é•¿åº¦åˆ†é…å­˜å‚¨ç©ºé—´ï¼›è€Œåè€…ä¼šæ ¹æ®å®é™…å­˜å‚¨çš„æ•°æ®åˆ†é…æœ€ç»ˆçš„å­˜å‚¨ç©ºé—´ã€‚\nä»¥char(32)å’Œvarchar(32)ä¸¾ä¾‹ï¼šï¼ˆè¿™é‡Œçš„ 32 è¡¨ç¤ºå­—ç¬¦æ•°ï¼‰\nchar(32) varchar(32) å ç”¨ç©ºé—´ å›ºå®š32å­—ç¬¦ï¼ˆå¦‚æœæ•°æ®é•¿åº¦ä¸å¤Ÿ32å°†ç”¨ç©ºæ ¼è¡¥é½ï¼‰ è·Ÿéšå®é™…å­˜å‚¨å†…å®¹é•¿åº¦ï¼Œä½†ä¸è¶…è¿‡32 ç©ºæ ¼å¤„ç† æ£€ç´¢æ—¶ä¼šå»æ‰å°¾éƒ¨ç©ºæ ¼ï¼ˆæ•°æ®æœ¬èº«æœ‰ç©ºç™½ç¬¦ä¹Ÿä¼šè¢«å»æ‰ï¼‰ ä¸ä¼šå¯¹ç©ºæ ¼å¤„ç† æ˜¯å¦è®°å½•å­—æ®µé•¿åº¦ å¦ æ˜¯ã€‚é¢å¤–æ‹¿å‡ºç©ºé—´è®°å½•å­—æ®µæ•°æ®é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ é€‚ç”¨åœºæ™¯ å­˜å‚¨çš„æ•°æ®é•¿åº¦åŸºæœ¬ä¸€è‡´ï¼Œä¸éœ€è¦ç©ºæ ¼ï¼Œeg æ‰‹æœºå·ã€UUIDã€å¯†ç åŠ å¯†åçš„å¯†æ–‡ æ•°æ®é•¿åº¦ä¸ä¸€å®šï¼Œé•¿åº¦èŒƒå›´å˜åŒ–è¾ƒå¤§çš„åœºæ™¯ å°é—®é¢˜ï¼šchar(1) å’Œ varchar(1) çš„åŒºåˆ«ï¼Ÿä¸¤ä¸ªéƒ½åªèƒ½ä¿å­˜å•ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯ varchar è¦å¤šå ä¸€ä¸ªæˆ–ä¸¤ä¸ªå­˜å‚¨ä½ç½®ç”¨æ¥è®°å½•å­˜å‚¨é•¿åº¦ä¿¡æ¯\n2. å»ºç«‹ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œé—® select aï¼Œbï¼Œc å’Œ select aï¼Œcï¼Œb æœ‰ä»€ä¹ˆåŒºåˆ« MySQL çš„ æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™\n3. varchar ç±»å‹ï¼Œæ’å…¥çš„æ•°æ®è¶…è¿‡è®¾ç½®çš„é•¿åº¦ä¼šæ€æ · æ¥æºï¼š https://www.hegongshan.com/2020/04/22/mysql-varchar/\nç½‘ä¸ŠåŸºæœ¬éƒ½è¯´å­—ç¬¦ä¸²ä¼šè¢«è‡ªåŠ¨æˆªæ–­ï¼Œå¹¶æŠ¥å‡ºä¸€ä¸ª warningï¼Œä½†æ˜¯ï¼Œæˆ‘åœ¨æœ¬æœºä¸Šæµ‹è¯•æ—¶ï¼ˆMySQL 8.0.16ï¼‰ï¼Œå´æŠ¥äº†å¦‚ä¸‹é”™è¯¯ï¼š\nERROR 1406 (22001): Data too long for column 'name' at row 1 è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿåæ¥ï¼Œæˆ‘å‘ç°ï¼Œè¿™ä¸¤ç§æƒ…å†µæ˜¯ç”±äºSQLæ¨¡å¼ä¸åŒé€ æˆçš„ã€‚\nåœ¨MySQLä¸­ï¼Œæœ‰å¦‚ä¸‹ä¸‰ç§æœ€é‡è¦çš„SQLæ¨¡å¼ï¼ˆå®˜ç½‘ç§°ä¹‹ä¸ºThe Most Important SQL Modesï¼‰\nANSI\nå®½æ¾æ¨¡å¼\næ­¤æ¨¡å¼æ›´æ”¹è¯­æ³•å’Œè¡Œä¸ºï¼Œä½¿å…¶æ›´æ¥è¿‘æ ‡å‡†SQL\nSTRICT_TRANS_TABLES\nä¸¥æ ¼æ¨¡å¼\nåœ¨è¯¥æ¨¡å¼ä¸‹,å¦‚æœä¸€ä¸ªå€¼ä¸èƒ½æ’å…¥åˆ°ä¸€ä¸ªäº‹åŠ¡è¡¨ä¸­,åˆ™ä¸­æ–­å½“å‰çš„æ“ä½œ,å¯¹éäº‹åŠ¡è¡¨ä¸åšé™åˆ¶\nTRADITIONAL\nåœ¨å‘åˆ—ä¸­æ’å…¥é”™è¯¯å€¼æ—¶ï¼Œæ­¤æ¨¡å¼â€œç»™å‡ºé”™è¯¯è€Œä¸æ˜¯è­¦å‘Šâ€ã€‚\nTRADITIONAL æ˜¯ä¸€ä¸ªç»„åˆæ¨¡å¼ï¼Œå®ƒåŒ…å«äº† STRICT_TRANS_TABLES\nä½¿ç”¨ select @@sql_mode æŸ¥çœ‹å½“å‰çš„ sql_modeã€‚\nset @@sql_mode = 'traditional' æ›´æ”¹å½“å‰ sql_modeã€‚\næ€»ç»“\nå½“ varchar è¶…è¿‡é™åˆ¶é•¿åº¦æ—¶ï¼Œ\n1.å¦‚æœå½“å‰çš„ SQL æ¨¡å¼ä¸ºå®½æ¾æ¨¡å¼ï¼Œé‚£ä¹ˆå°†ä¼šæŒ‰ç…§ä»å‰å¾€åçš„é¡ºåºï¼Œå¯¹å­—ç¬¦ä¸²è¿›è¡Œæˆªæ–­ï¼Œå¹¶æç¤ºä¸€ä¸ªè­¦å‘Šï¼›\n2.å¦‚æœå½“å‰çš„ SQL æ¨¡å¼ä¸ºä¸¥æ ¼æ¨¡å¼ï¼Œé‚£ä¹ˆå°†ä¼šæŠ¥å‡ºä¸€ä¸ªé”™è¯¯ã€‚\nMYSQL äº‹åŠ¡çš„ ACID Aï¼šåŸå­æ€§ï¼Œä¿è¯äº‹åŠ¡è¦ä¸å…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¸å…¨éƒ¨å¤±è´¥ Cï¼šä¸€è‡´æ€§ï¼šä¿è¯äº‹åŠ¡ä»ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ Iï¼šéš”ç¦»æ€§ï¼šäº‹åŠ¡å’Œäº‹åŠ¡ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå¹¶ä¸”æœ‰ä¸åŒçš„éš”ç¦»çº§åˆ« Dï¼šæŒä¹…æ€§ï¼Œäº‹åŠ¡æœ€ç»ˆä¼šä¿å­˜åˆ°ç¡¬ç›˜ä¸Šï¼Œå¯¹æ•°æ®åº“çš„æ›´æ”¹æ˜¯æ°¸ä¹…æ€§çš„\nMySQL åŸå­æ€§æ€ä¹ˆä¿è¯ é€šè¿‡ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼Œ\nredolog å·¥ä½œåŸç† å®•æœºæ¢å¤ undolog åœ¨å®•æœºæ—¶æ€ä¹ˆä¿è¯åŸå­æ€§ å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„åŒºåˆ« ä¸å¯é‡å¤è¯»ä¸å¹»è¯»çš„åŒºåˆ«å¯ä»¥é€šä¿—çš„ç†è§£ä¸ºï¼šå‰è€…æ˜¯æ•°æ®å˜äº†ï¼Œåè€…æ˜¯æ•°æ®çš„è¡Œæ•°å˜äº†\nä¹è§‚é”æ‚²è§‚é” ç´¢å¼•è®¾è®¡åŸåˆ™ ä¸ºé¢‘ç¹æŸ¥è¯¢çš„å­—æ®µå»ºç«‹ç´¢å¼• ","date":"2021å¹´07æœˆ25æ—¥","permalink":"/posts/mysql-mian-jing/","summary":"MySQL é¢ç»æ±‡æ€»ï¼Œæ”¶é›†äºç‰›å®¢ï¼Œä¸æ–­æ›´æ–°ä¸­\n1. char å’Œ varchar çš„åŒºåˆ« char æ˜¯å›ºå®šé•¿åº¦ï¼Œvarchar é•¿åº¦å¯å˜ï¼Œå­˜å‚¨æ—¶ï¼Œå‰è€…ä¸ç®¡å®é™…å­˜å‚¨æ•°æ®çš„é•¿åº¦ï¼Œç›´æ¥è§„å®š char è§„å®šçš„é•¿åº¦åˆ†é…å­˜å‚¨ç©ºé—´ï¼›è€Œåè€…ä¼šæ ¹æ®å®é™…å­˜å‚¨çš„æ•°æ®åˆ†é…æœ€ç»ˆçš„å­˜å‚¨ç©ºé—´ã€‚","title":"MySQL é¢ç»æ±‡æ€»"},{"contents":"Linux epoll çš„æ¡ä»¶è§¦å‘( Level Trigger )å’Œè¾¹ç¼˜è§¦å‘( Edge Trigger )\nLT æ•ˆæœæ¼”ç¤º ä¸€ä¸ªç®€å•çš„å° demoï¼Œä»æ ‡å‡†è¾“å…¥ stdin è¯»å…¥æ•°æ®ï¼Œå¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º stdoutï¼Œè¿™é‡Œè®¾ç½®äº†æ¯æ¬¡è¯»å–çš„ BUF_SIZE ä¸º 2ã€‚\n#include \u0026lt;sys/epoll.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;string.h\u0026gt; #define BUF_SIZE 2 int main() { int epfd, nfds; char buf[BUF_SIZE]; struct epoll_event event, events[5]; epfd = epoll_create(1); event.data.fd = STDIN_FILENO; event.events = EPOLLIN /*| EPOLLET*/; epoll_ctl(epfd, EPOLL_CTL_ADD, STDIN_FILENO, \u0026amp;event); while (1) { nfds = epoll_wait(epfd, events, 5, -1); //printf(\u0026quot;%d events already\\n\u0026quot;, nfds); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].data.fd == STDIN_FILENO) { printf(\u0026quot;trigger once!\\n\u0026quot;); memset(buf, '\\0', BUF_SIZE); read(events[i].data.fd, buf, BUF_SIZE); printf(\u0026quot;read content: %s\\n\u0026quot;, buf); } } } } è¿è¡Œç¨‹åºï¼Œè¾“å…¥ä¸€ä¸ªé•¿åº¦ä¸º 6 çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºè®¾ç½®äº†æ¯æ¬¡è¯» 2 å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€æ¬¡å¹¶ä¸èƒ½è¯»å®Œï¼š è¿è¡Œç»“æœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ LT æ¨¡å¼ä¸‹ï¼Œåªè¦ç¼“å†²åŒºä¸­è¿˜æœ‰æ•°æ®ï¼Œè¯¥äº‹ä»¶å°±ä¾ç„¶ä¼šè§¦å‘ï¼ˆè¿™é‡Œæœ€åä¸€æ¬¡è§¦å‘ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œè¾“å‡ºçš„å†…å®¹ä¹Ÿæ˜¯ç©ºï¼Œå¯èƒ½è¯»å–çš„æ˜¯æ¢è¡Œç¬¦ï¼Ÿï¼‰\nET æ•ˆæœæ¼”ç¤º ET çš„ä»£ç å’Œ LT åŸºæœ¬ä¸€æ ·ï¼Œåªéœ€è¦åœ¨ events å¤„å°å°æ”¹åŠ¨ event.events = EPOLLIN | EPOLLET\n#include \u0026lt;sys/epoll.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;string.h\u0026gt; #define BUF_SIZE 2 int main() { int epfd, nfds; char buf[BUF_SIZE]; struct epoll_event event, events[5]; epfd = epoll_create(1); event.data.fd = STDIN_FILENO; event.events = EPOLLIN | EPOLLET; // set et epoll_ctl(epfd, EPOLL_CTL_ADD, STDIN_FILENO, \u0026amp;event); while (1) { nfds = epoll_wait(epfd, events, 5, -1); //printf(\u0026quot;%d events already\\n\u0026quot;, nfds); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].data.fd == STDIN_FILENO) { printf(\u0026quot;trigger once!\\n\u0026quot;); memset(buf, '\\0', BUF_SIZE); read(events[i].data.fd, buf, BUF_SIZE); printf(\u0026quot;read content: %s\\n\u0026quot;, buf); } } } } åŒæ ·çš„è¾“å…¥ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š åœ¨ ET æ¨¡å¼ä¸‹ï¼Œæ•´ä¸ªäº‹ä»¶åªä¼šè§¦å‘ä¸€æ¬¡ï¼Œå³ä¾¿ç¼“å†²åŒºä¸­è¿˜æœ‰æ®‹ä½™æ•°æ®æœªè¢«å¤„ç†ï¼Œè¦æƒ³å†æ¬¡è§¦å‘ï¼Œåªæœ‰åœ¨ç»ˆç«¯ä¸­å†æ¬¡è¾“å…¥ï¼š è¿™é‡Œè¾“å…¥äº† adaasdad ï¼Œä½¿å¾—äº‹ä»¶å¾—ä»¥å†æ¬¡è§¦å‘ã€‚\nè¿™ä¸ª demo è¯´æ˜äº†ï¼Œå¦‚æœä½¿ç”¨ ET æ¨¡å¼ï¼Œå°±ä¸€å®šè¦åœ¨ä¸€æ¬¡äº‹ä»¶ä¸­ï¼Œä¸€æ¬¡æ€§æŠŠ socket ä¸Šçš„æ•°æ®æ”¶å–å¹²å‡€æ‰è¡Œï¼Œå¦åˆ™å¯èƒ½é€ æˆæ•°æ®çš„é—æ¼ã€‚\nET çš„é—®é¢˜ ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œéœ€è¦åœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­è°ƒç”¨ readï¼Œç›´åˆ°è¯»å®Œä¸ºæ­¢ã€‚ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š\n#include \u0026lt;sys/epoll.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;string.h\u0026gt; #define BUF_SIZE 2 int main() { int epfd, nfds; char buf[BUF_SIZE]; struct epoll_event event, events[5]; epfd = epoll_create(1); event.data.fd = STDIN_FILENO; event.events = EPOLLIN | EPOLLET; // set et epoll_ctl(epfd, EPOLL_CTL_ADD, STDIN_FILENO, \u0026amp;event); while (1) { nfds = epoll_wait(epfd, events, 5, -1); //printf(\u0026quot;%d events already\\n\u0026quot;, nfds); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].data.fd == STDIN_FILENO) { printf(\u0026quot;trigger once!\\n\u0026quot;); memset(buf, '\\0', BUF_SIZE); // ä¸æ–­è¯»å–ç›´åˆ°å…¨éƒ¨è¯»å®Œ while (1) { int n = read(events[i].data.fd, buf, BUF_SIZE); if (n \u0026lt;= 0) { printf(\u0026quot;read EOF\\n\u0026quot;); break; } printf(\u0026quot;read content: %s\\n\u0026quot;, buf); } } } } } ET éœ€è¦å’Œ NONBLOCK æ­é…ä½¿ç”¨ ä¸Šé¢çš„ demo åªæ˜¯ä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼Œå®é™…ä¸­ epoll æ›´å¤šçš„åº”ç”¨åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œè¿™å°†æ¶‰åŠåˆ°å¤šä¸ªè¿æ¥çš„å¹¶å‘é—®é¢˜ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸‹ä¸€ä¸ªä½¿ç”¨ epoll ET å®ç°çš„ echo æœåŠ¡ï¼š\n#include \u0026quot;../pkg/net/net.h\u0026quot; #include \u0026lt;iostream\u0026gt; #include \u0026lt;sys/epoll.h\u0026gt; #define BUF_SIZE 4 // å°†è°ƒç”¨ read å‡½æ•°æ—¶ä½¿ç”¨çš„ç¼“å†²å¤§å°ç¼©å‡ä¸º 4 ä¸ªå­—èŠ‚ #define EPOLL_SIZE 50 // g++ -o echo_et echo_et.cc ../pkg/net/net.cpp int main() { Server s(\u0026quot;tcp\u0026quot;, \u0026quot;0.0.0.0\u0026quot;, \u0026quot;8080\u0026quot;); s.Listen(100); char buf[BUF_SIZE]; int epfd = epoll_create(EPOLL_SIZE); struct epoll_event *events; struct epoll_event event; events = (epoll_event*) malloc(sizeof(struct epoll_event) * EPOLL_SIZE); event.data.fd = s.Sockfd(); event.events = EPOLLIN | EPOLLET; // ET epoll_ctl(epfd, EPOLL_CTL_ADD, s.Sockfd(), \u0026amp;event); for (; ;) { int okcnt = epoll_wait(epfd, events, EPOLL_SIZE, -1); if (okcnt == -1) { cout \u0026lt;\u0026lt; \u0026quot;epoll wait error\u0026quot; \u0026lt;\u0026lt; endl; break; } // æ’å…¥éªŒè¯ epoll_wait å‡½æ•°è°ƒç”¨æ¬¡æ•°çš„è¯­å¥ cout \u0026lt;\u0026lt; \u0026quot;trigger once!\u0026quot; \u0026lt;\u0026lt; endl; for (int i = 0; i \u0026lt; okcnt; i++) { if (events[i].data.fd == s.Sockfd()) { auto conn = s.Accept(); event.events = EPOLLIN | EPOLLET; event.data.fd = conn-\u0026gt;Connfd(); epoll_ctl(epfd, EPOLL_CTL_ADD, conn-\u0026gt;Connfd(), \u0026amp;event); cout \u0026lt;\u0026lt; \u0026quot;connected client: \u0026quot; \u0026lt;\u0026lt; conn-\u0026gt;Connfd() \u0026lt;\u0026lt; endl; } else { while (true) { int n = read(events[i].data.fd, buf, BUF_SIZE); if (n == 0) { epoll_ctl(epfd, EPOLL_CTL_DEL, events[i].data.fd, nullptr); close(events[i].data.fd); printf(\u0026quot;closed client: %d\\n\u0026quot;, events[i].data.fd); break; } else { write(events[i].data.fd, buf, n); } } } } } } ä¸Šé¢çš„ç¨‹åºæ˜¯ä¸å…·å¤‡å¹¶å‘èƒ½åŠ›çš„ï¼ŒåŸå› åœ¨äºè¿™æ®µä»£ç ï¼š\nwhile (true) { int n = read(events[i].data.fd, buf, BUF_SIZE); if (n == 0) { epoll_ctl(epfd, EPOLL_CTL_DEL, events[i].data.fd, nullptr); close(events[i].data.fd); printf(\u0026quot;closed client: %d\\n\u0026quot;, events[i].data.fd); break; } else { write(events[i].data.fd, buf, n); } } å› ä¸º ET çš„ç‰¹æ€§ï¼Œéœ€è¦ä¸€æ¬¡æ€§å°†æ•°æ®å…¨éƒ¨è¯»å®Œï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­è°ƒç”¨ read æ¥è¯»å–æ•°æ®ã€‚\nä½†æ˜¯ socket å»ºç«‹çš„è¿æ¥é»˜è®¤æ˜¯é˜»å¡æ¨¡å¼çš„ï¼Œè¿™å°†å¯¼è‡´ read å‡½æ•°åœ¨æœ€åä¸€æ¬¡è¢«é˜»å¡ï¼Œæ¯”å¦‚è¦è¯»å–æ•°æ® 1234ï¼Œæ¯æ¬¡è¯» 2 ä¸ªï¼Œç¬¬ä¸€æ¬¡å¾ªç¯è¯»å– 12ï¼Œç¬¬äºŒæ¬¡å¾ªç¯è¯»å– 34ï¼Œè¯»å–å®Œåè¿›å…¥ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼Œä½†æ˜¯å› ä¸ºæ­¤æ—¶å·²ç»æ— æ•°æ®å¯è¯»äº†ï¼Œæ‰€ä»¥ä¼šé˜»å¡åœ¨ read å¤„ï¼Œé™¤éå¯¹ç«¯ä¸»åŠ¨å…³é—­è¿”å› 0ï¼Œå¦åˆ™å°†æ°¸è¿œé˜»å¡ã€‚è€Œæ•´ä¸ªç¨‹åºåˆæ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™å°†å¯¼è‡´å…¶ä»–è¿æ¥æ— æ³•è¢«å¤„ç†ã€‚\nè§£å†³æ–¹æ³•æ˜¯å°† socket è®¾ç½®ä¸ºéé˜»å¡ï¼ˆNONBLOCKï¼‰ï¼Œå½“æ— æ•°æ®å¯è¯»æ—¶ï¼Œä¼šç«‹é©¬è¿”å› EAGAIN é”™è¯¯ï¼ˆpsï¼šEAGAIN å’Œ EWOULDBLOCK æ˜¯ä¸€æ ·çš„ï¼‰è€Œä¸æ˜¯é˜»å¡ã€‚åªéœ€è¦å°† accpet è¿”å›çš„ conn è®¾ç½®ä¸ºéé˜»å¡å³å¯ï¼š\nif (events[i].data.fd == s.Sockfd()) { auto conn = s.Accept(); // set conn nonblock util::SetNonBlock(conn-\u0026gt;Connfd()); event.events = EPOLLIN | EPOLLET; event.data.fd = conn-\u0026gt;Connfd(); epoll_ctl(epfd, EPOLL_CTL_ADD, conn-\u0026gt;Connfd(), \u0026amp;event); cout \u0026lt;\u0026lt; \u0026quot;connected client: \u0026quot; \u0026lt;\u0026lt; conn-\u0026gt;Connfd() \u0026lt;\u0026lt; endl; } int util::SetNonBlock(int fd) { int old_opt = fcntl(fd, F_GETFL); int new_opt = old_opt | O_NONBLOCK; fcntl(fd, F_SETFL, new_opt); return old_opt; } ä¸ºä»€ä¹ˆ LT ä¸éœ€è¦è®¾ç½®éé˜»å¡ LT ä¸‹çš„ echo æœåŠ¡ï¼š\n// // Created by root on 7/18/21. // #include \u0026quot;../pkg/net/net.h\u0026quot; #include \u0026lt;iostream\u0026gt; #include \u0026lt;sys/epoll.h\u0026gt; #define BUF_SIZE 4 // å°†è°ƒç”¨ read å‡½æ•°æ—¶ä½¿ç”¨çš„ç¼“å†²å¤§å°ç¼©å‡ä¸º 4 ä¸ªå­—èŠ‚ #define EPOLL_SIZE 50 int main() { Server s(\u0026quot;tcp\u0026quot;, \u0026quot;0.0.0.0\u0026quot;, \u0026quot;8080\u0026quot;); s.Listen(100); char buf[BUF_SIZE]; int epfd = epoll_create(EPOLL_SIZE); struct epoll_event *events; struct epoll_event event; events = (epoll_event*) malloc(sizeof(struct epoll_event) * EPOLL_SIZE); event.data.fd = s.Sockfd(); event.events = EPOLLIN; epoll_ctl(epfd, EPOLL_CTL_ADD, s.Sockfd(), \u0026amp;event); for (; ;) { int okcnt = epoll_wait(epfd, events, EPOLL_SIZE, -1); if (okcnt == -1) { cout \u0026lt;\u0026lt; \u0026quot;epoll wait error\u0026quot; \u0026lt;\u0026lt; endl; break; } // æ’å…¥éªŒè¯ epoll_wait å‡½æ•°è°ƒç”¨æ¬¡æ•°çš„è¯­å¥ cout \u0026lt;\u0026lt; \u0026quot;trigger once!\u0026quot; \u0026lt;\u0026lt; endl; for (int i = 0; i \u0026lt; okcnt; i++) { if (events[i].data.fd == s.Sockfd()) { auto conn = s.Accept(); event.events = EPOLLIN; event.data.fd = conn-\u0026gt;Connfd(); epoll_ctl(epfd, EPOLL_CTL_ADD, conn-\u0026gt;Connfd(), \u0026amp;event); cout \u0026lt;\u0026lt; \u0026quot;connected client: \u0026quot; \u0026lt;\u0026lt; conn-\u0026gt;Connfd() \u0026lt;\u0026lt; endl; } else { int n = read(events[i].data.fd, buf, BUF_SIZE); if (n == 0) { epoll_ctl(epfd, EPOLL_CTL_DEL, events[i].data.fd, nullptr); close(events[i].data.fd); printf(\u0026quot;closed client: %d\\n\u0026quot;, events[i].data.fd); } else { write(events[i].data.fd, buf, n); } } } } } LT æ¨¡å¼ä¸‹ï¼Œåªè¦ç¼“å†²åŒºè¿˜æœ‰æ•°æ®å°±ä¼šè§¦å‘äº‹ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸€æ¬¡å…¨éƒ¨è¯»å–ï¼Œæ¯æ¬¡è§¦å‘äº‹ä»¶åªä¼š read ä¸€æ¬¡ï¼ˆè§¦å‘äº‹ä»¶å³è¡¨ç¤º read å¯è¯»ï¼‰ï¼Œè€Œä¸æ˜¯åƒ ET ä¸€æ ·åœ¨æ­»å¾ªç¯é‡Œä¸€ç›´ readï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šå‘ç”Ÿé˜»å¡é—®é¢˜äº†ã€‚æ¯”å¦‚è¯»å– 1234ï¼Œç¬¬ä¸€æ¬¡è¯»å– 12 é€€å‡ºå¾ªç¯ï¼Œå› ä¸ºè¿˜æœ‰æ•°æ®ï¼Œç»§ç»­è§¦å‘äº‹ä»¶ï¼Œè¯»å–å‰©ä½™çš„ 34ã€‚\n","date":"2021å¹´07æœˆ23æ—¥","permalink":"/posts/epoll-de-lt-he-et/","summary":"Linux epoll çš„æ¡ä»¶è§¦å‘( Level Trigger )å’Œè¾¹ç¼˜è§¦å‘( Edge Trigger )","title":"epoll çš„ LT å’Œ ET"},{"contents":"heapï¼ˆå †ï¼‰ï¼Œæ˜¯ä¸€ä¸ªç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘ï¼Œå¸¸ç”¨äºæ„å»ºä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ’åºå’Œå¿«é€Ÿæ‰¾å‡ºä¸€ä¸ªé›†åˆä¸­çš„æœ€å°å€¼ï¼ˆæˆ–è€…æœ€å¤§å€¼ï¼‰ã€‚åœ¨ go æ ‡å‡†åº“ä¸‹çš„ container åŒ…ä¸­æä¾›äº†è¿™ç§æ•°æ®ç»“æ„ã€‚\næºç  interface è¦æƒ³ä½¿ç”¨å †ï¼Œéœ€è¦å®ç° Interface æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¸­å†…åµŒäº†ä¸€ä¸ª sort.Interface æ¥å£ï¼Œæ‰€ä»¥ä¸€å…±éœ€è¦åŒ…å« 5 ä¸ªæ–¹æ³•ï¼šLen() ç”¨äºè¿”å›é•¿åº¦ï¼ŒSwap() ç”¨äºäº¤æ¢ä¸¤ä¸ªå€¼ï¼ŒLess() ç”¨äºå®šä¹‰æ¯”è¾ƒä¸¤ä¸ªå€¼çš„è§„åˆ™ï¼ŒPush() å’Œ Pop() åˆ†åˆ«ä»£è¡¨æ·»åŠ åˆ°æœ«å°¾å’Œå¼¹å‡ºæœ«å°¾å…ƒç´ ã€‚é€šè¿‡ Less() å¯ä»¥è‡ªå®šä¹‰å †ä¸ºæœ€å¤§å †è¿˜æ˜¯æœ€å°å †ã€‚\ntype Interface interface { sort.Interface Push(x interface{}) // æ·»åŠ  x åˆ°æœ«å°¾ Pop() interface{} // å¼¹å‡ºæœ«å°¾å…ƒç´ å¹¶è¿”å› } ä¸€å¼€å§‹æˆ‘ä¸æ˜¯å¾ˆæ˜ç™½ä¸ºä»€ä¹ˆè¦å®ç° Push å’Œ Pop ä¸¤ä¸ªæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•çš„å®šä¹‰å·²ç»å¾ˆæ˜ç¡®äº†ï¼Œåæ¥çœ‹äº† heap åŒ…ä¸‹çš„ example_pq_test.go æ‰æ˜ç™½äº†åŸå› ï¼Œä¸»è¦åœ¨äºä¸€äº›æ“ä½œè¿˜éœ€è¦åšä¸€äº›é¢å¤–çš„å·¥ä½œï¼Œæ¯”å¦‚ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å®ç°ï¼Œå…¶å®ç°çš„ Pop() å¦‚ä¸‹ï¼š\nfunc (pq *PriorityQueue) Pop() interface{} { old := *pq n := len(old) item := old[n-1] old[n-1] = nil // avoid memory leak // å°† index ç½®ä¸º -1 æ˜¯ä¸ºäº†æ ‡è¯†è¯¥æ•°æ®å·²ç»å‡ºäº†ä¼˜å…ˆçº§é˜Ÿåˆ—äº† item.index = -1 *pq = old[0 : n-1] return item } Push func Push(h Interface, x interface{}) { h.Push(x) // ä»ä¸‹åˆ°ä¸Šå †åŒ– up(h, h.Len()-1) } Push ä¼šå…ˆæ‰§è¡Œè‡ªå·±å®ç°çš„ h.Push æ–¹æ³•ï¼Œå°† x æ·»åŠ åˆ°æœ«å°¾ï¼Œä¹‹åå†æ‰§è¡Œ up è¿›è¡Œå †åŒ–ã€‚\nup // up ä»£è¡¨ä¸Šæµ®ï¼Œä»ä¸‹åˆ°ä¸Šå †åŒ– // j ä»£è¡¨éœ€è¦å †åŒ–çš„å…ƒç´  indexï¼Œup ä¼šä»è¯¥å…ƒç´ å¼€å§‹ï¼Œä¸æ–­å‘ä¸Šè°ƒæ•´å † // åœ¨ Push ä¸­ä¼šè°ƒç”¨ up func up(h Interface, j int) { for { // j çš„çˆ¶èŠ‚ç‚¹ i := (j - 1) / 2 // parent // i == j ï¼šæ­¤æ—¶ i æ˜¯æœ€åä¸€ä¸ªå…ƒç´  // // åœ¨è§£é‡Š !h.Less(j, i) ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ Less(i, j int) æ¥å£çš„å®šä¹‰ï¼š // // func (m myheap) Less(i, j int) bool { //\treturn m[i] \u0026lt; m[j]\t// è¿™ä»£è¡¨å®ç°çš„å †ä¸ºæœ€å°å † // } // // func (m myheap) Less(i, j int) bool { //\treturn m[i] \u0026gt; m[j]\t// è¿™ä»£è¡¨å®ç°çš„å †ä¸ºæœ€å¤§å † // } // // // 1. æœ€å°å †ï¼Œå¦‚æœ jï¼ˆå­èŠ‚ç‚¹ï¼‰å¤§äº iï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ï¼Œæƒ…å†µå¦‚ä¸‹å›¾ï¼š // //\t3\ti //\t\\ //\t5 j // // æ­¤æ—¶ä¾¿ä¸éœ€è¦äº¤æ¢ i å’Œ jï¼Œ!h.Less(j, i) å¯¹åº” !m[j] \u0026lt; m[i]ï¼Œå³ m[j] \u0026gt; m[i] // // æœ€å¤§å †åŒç† if i == j || !h.Less(j, i) { break } // å¦åˆ™éœ€è¦è¿›è¡Œäº¤æ¢ï¼Œè¿˜æ˜¯ä»¥æœ€å°å †ä¸ºä¾‹ï¼š // //\t5\ti //\t\\ //\t3 j // // æ­¤æ—¶ä¸æ»¡è¶³ !h.Less(j, i)ï¼Œæ­¤æ—¶ iï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰å¤§äº jï¼ˆå­èŠ‚ç‚¹ï¼‰ï¼Œ // ä¸æ»¡è¶³æœ€å°å †çš„å®šä¹‰ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œäº¤æ¢ h.Swap(i, j) // up ä»£è¡¨ä¸Šæµ®ï¼Œæ‰€ä»¥æ›´æ–° j ä¸ºå…¶çˆ¶èŠ‚ç‚¹ i j = i } } Push çš„æµç¨‹å›¾ç¤º æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š\ntype myheap []int // myheap æ˜¯ä¸€ä¸ªæœ€å°å † func TestHeapPushPop(t *testing.T) { h := new(myheap) heap.Push(h, 5) heap.Push(h, 10) heap.Push(h, 2) heap.Push(h, 99) heap.Push(h, 3) heap.Push(h, 233) heap.Push(h, 1) } Pop func Pop(h Interface) interface{} { n := h.Len() - 1 // å †é¡¶æ˜¯æœ€å°ï¼ˆæˆ–æœ€å¤§ï¼‰å…ƒç´ ï¼Œå°†å…¶äº¤æ¢åˆ°æœ«å°¾ï¼Œpop ä¼šç§»é™¤è¯¥å…ƒç´  h.Swap(0, n) // FIXME down çš„ä½œç”¨ä¸ç¡®å®šï¼Œä»¥ä¸‹ä¸ºçŒœæµ‹ // down ä¼šå°†ç¬¬äºŒå°ï¼ˆæˆ–å¤§ï¼‰çš„å…ƒç´ ç§»åŠ¨åˆ°å †é¡¶ï¼Œä¾¿äºä¸‹æ¬¡æ“ä½œ down(h, 0, n) return h.Pop() } down func down(h Interface, i0, n int) bool { i := i0 for { j1 := 2*i + 1 // j1 æ˜¯ i çš„å·¦å­èŠ‚ç‚¹ // j1 \u0026gt; n ä»£è¡¨å­èŠ‚ç‚¹ä¸å­˜åœ¨ // j1 == n ä»£è¡¨å­èŠ‚ç‚¹æ˜¯å †ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œdown æ“ä½œä¼šå¿½ç•¥æœ€åä¸€ä¸ªå…ƒç´  if j1 \u0026gt;= n || j1 \u0026lt; 0 { // j1 \u0026lt; 0 after int overflow break } // j ç”¨æ¥ä¿å­˜å­èŠ‚ç‚¹ä¸­è¾ƒå°ï¼ˆå¤§ï¼‰çš„é‚£ä¸ªï¼Œé»˜è®¤ä¸ºå·¦å­èŠ‚ç‚¹ j := j1 // left child // j2 := j1 + 1ï¼Œè¿™è¡¨ç¤º j2 æ˜¯ i çš„å³å­èŠ‚ç‚¹ // è¿™é‡Œæ˜¯ j2 \u0026lt; n è€Œä¸æ˜¯ j2 \u0026lt;= nï¼Œå› ä¸º down æ“ä½œä¼šå¿½ç•¥æœ€åä¸€ä¸ªå…ƒç´  // å¦‚æœæ˜¯æœ€å°å †ï¼Œåˆ™é€‰å‡º j1ï¼ˆå·¦å­èŠ‚ç‚¹ï¼‰å’Œ j2ï¼ˆå³å­èŠ‚ç‚¹ï¼‰ä¸­è¾ƒå°çš„é‚£ä¸ª // å¦‚æœæ˜¯æœ€å¤§å †ï¼Œåˆ™é€‰å‡º j1ï¼ˆå·¦å­èŠ‚ç‚¹ï¼‰å’Œ j2ï¼ˆå³å­èŠ‚ç‚¹ï¼‰ä¸­è¾ƒå¤§çš„é‚£ä¸ª if j2 := j1 + 1; j2 \u0026lt; n \u0026amp;\u0026amp; h.Less(j2, j1) { // æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ›´æ–° j ä¸ºå³å­èŠ‚ç‚¹ j = j2 // = 2*i + 2 // right child } // åˆ¤æ–­ jï¼ˆå­èŠ‚ç‚¹ï¼‰ å’Œ iï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰çš„å…³ç³» // å¦‚æœæ˜¯æœ€å°å †ï¼Œ!h.Less(j, i) ä»£è¡¨ j \u0026gt; iï¼Œå³çˆ¶èŠ‚ç‚¹å°äºè¾ƒå°çš„å­èŠ‚ç‚¹ï¼Œ // æ­¤æ—¶å·²ç»æ»¡è¶³æœ€å°å †çš„ç‰¹æ€§äº†ï¼Œç›´æ¥ break // å¦‚æœæ˜¯æœ€å¤§å †ï¼Œ!h.Less(j, i) ä»£è¡¨ j \u0026lt; iï¼Œä¸ä¸Šé¢åŒç† if !h.Less(j, i) { break } // åˆ°è¿™é‡Œè¯´æ˜ jï¼ˆå­èŠ‚ç‚¹ï¼‰ å’Œ iï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ä¸æ»¡è¶³å †çš„ç‰¹æ€§ï¼Œ // å¦‚æœæ˜¯æœ€å°å †ï¼Œè¯´æ˜æ­¤æ—¶ i \u0026gt; jï¼Œéœ€è¦äº¤æ¢ // å¦‚æœæ˜¯æœ€å¤§å †ï¼Œè¯´æ˜æ­¤æ—¶ i \u0026lt; jï¼Œéœ€è¦äº¤æ¢ h.Swap(i, j) // down ä»£è¡¨ä¸‹æ²‰ï¼Œæ›´æ–° i ä¸ºå…¶å­èŠ‚ç‚¹ jï¼Œè¿›è¡Œä¸‹ä¸€è½®å¾ªç¯ i = j } // å¦‚æœæ²¡æœ‰æ‰§è¡Œè¿‡ i = jï¼Œåˆ™ä¸æ»¡è¶³ i \u0026gt; i0 æ¡ä»¶ï¼Œ // è¿™ä»£è¡¨æ²¡æœ‰è¿›è¡Œ down æ“ä½œ return i \u0026gt; i0 } Pop çš„æµç¨‹å¦‚ä¸‹å›¾ï¼š å†™åœ¨æœ€å ä¸Šé¢åªå¯¹ heap åŒ…ä¸­çš„æ ¸å¿ƒå‡½æ•°è¿›è¡Œäº†åˆ†æï¼Œå‰©ä½™è¿˜æœ‰ Initï¼ŒRemoveï¼ŒFix() å‡½æ•°ï¼Œä½†æ˜¯å…¶å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨äº† up å’Œ down è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å°±ä¸ä¸€ä¸€åˆ†æäº†ã€‚\n","date":"2021å¹´07æœˆ22æ—¥","permalink":"/posts/go-containerheap-yuan-ma-yue-du/","summary":"heapï¼ˆå †ï¼‰ï¼Œæ˜¯ä¸€ä¸ªç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘ï¼Œå¸¸ç”¨äºæ„å»ºä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ’åºå’Œå¿«é€Ÿæ‰¾å‡ºä¸€ä¸ªé›†åˆä¸­çš„æœ€å°å€¼ï¼ˆæˆ–è€…æœ€å¤§å€¼ï¼‰ã€‚åœ¨ go æ ‡å‡†åº“ä¸‹çš„ container åŒ…ä¸­æä¾›äº†è¿™ç§æ•°æ®ç»“æ„ã€‚","title":"go container/heap æºç é˜…è¯»"},{"contents":"è¾“å…¥æ•´æ•°æ•°ç»„ arr ï¼Œæ‰¾å‡ºå…¶ä¸­æœ€å°çš„ k ä¸ªæ•°\nè¾“å…¥æ•´æ•°æ•°ç»„ arr ï¼Œæ‰¾å‡ºå…¶ä¸­æœ€å°çš„ k ä¸ªæ•°ã€‚ä¾‹å¦‚ï¼Œè¾“å…¥4ã€5ã€1ã€6ã€2ã€7ã€3ã€8 è¿™ 8 ä¸ªæ•°å­—ï¼Œåˆ™æœ€å°çš„ 4 ä¸ªæ•°å­—æ˜¯ 1ã€2ã€3ã€4ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šarr = [3,2,1], k = 2 è¾“å‡ºï¼š[1,2] æˆ–è€… [2,1]\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šarr = [0,1,2,1], k = 1 è¾“å‡ºï¼š[0]\næ–¹æ³•1 æ’åº ä½¿ç”¨ä»»æ„ä¸€ç§æ’åºç®—æ³•è¿›è¡Œæ’åºï¼Œæ’åºåå–å‰ k ä¸ªå³å¯ï¼Œè¿™é‡Œä½¿ç”¨å¿«æ’ï¼š\nfunc getLeastNumbers(arr []int, k int) []int { quickSort(arr) return arr[:k] } func quickSort(arr []int) { if len(arr) \u0026lt;= 1 { return } q := arr[0] l, r := 0, len(arr)-1 for l \u0026lt; r { for r \u0026gt; l \u0026amp;\u0026amp; arr[r] \u0026gt; q { r-- } arr[l] = arr[r] for r \u0026gt; l \u0026amp;\u0026amp; arr[l] \u0026lt;= q { l++ } arr[r] = arr[l] } arr[l] = q quickSort(arr[:r]) quickSort(arr[r+1:]) } æ–¹æ³•2 ä¼˜åŒ–å¿«æ’ é¢˜ç›®åªæ˜¯è¦æ±‚æ‰¾å‡º top kï¼Œä½†æ˜¯æ–¹æ³• 1 å´å¯¹æ•´ä¸ªæ•°ç»„è¿›è¡Œäº†æ’åºï¼Œæ˜¾ç„¶æ˜¯ä¸å¿…è¦çš„ã€‚è¿™é‡Œå¯ä»¥åˆ©ç”¨å¿«æ’çš„æ€§è´¨åšä¸€äº›ä¼˜åŒ–ï¼Œå¿«æ’çš„æ ¸å¿ƒæ˜¯ï¼Œæ¯è½®éƒ½ä¼šé€‰å‡ºä¸€ä¸ªåŸºå‡†ç‚¹ï¼Œä»¥è¯¥ç‚¹ä¸ºåˆ†éš”çº¿ï¼Œå°†æ¯”å®ƒå°çš„éƒ½æ”¾åœ¨å·¦è¾¹ï¼Œæ¯”å®ƒå¤§çš„æ”¾åœ¨å³è¾¹ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯¹ topk è¿›è¡Œä¼˜åŒ–ã€‚\nå½“æŒ‘é€‰å‡ºåŸºå‡†ç‚¹ p æ—¶ï¼Œå°†å…¶ä¸ k è¿›è¡Œæ¯”å¯¹ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\np \u0026lt; k\næ¯”å¦‚ï¼š-1, 1, 2, 5, 3, 5, 9ï¼Œk = 5ï¼Œç¬¬ä¸€è½®æ±‚å¾— p = [2] = 2\næ­¤æ—¶ 2 ä½œä¸ºåŸºå‡†ç‚¹ï¼Œå…¶å·¦è¾¹å…ƒç´ éƒ½æ¯”å®ƒå°ï¼Œå³è¾¹å…ƒç´ éƒ½æ¯”å®ƒå¤§ï¼Œé¢˜ç›®è¦æ±‚çš„æ˜¯æ±‚å‰ 5 ä¸ªæœ€å°å…ƒç´ ï¼Œç°åœ¨å·²ç»ç¡®å®šäº† -1ï¼Œ1ï¼Œ2 ä¸‰ä¸ªå…ƒç´ ï¼Œè¿˜å·® 5 - 3 = 2 ä¸ªï¼Œä¸”è¿™ä¸¤ä¸ªå…ƒç´ ä¸€å®šåœ¨ 2 çš„å³è¾¹ï¼Œæ‰€ä»¥å¯ä»¥å†å¯¹å³è¾¹éƒ¨åˆ† [5, 3, 5, 9] è¿›è¡Œå¿«æ’ï¼ŒåŒæ—¶ k éœ€è¦æ›´æ”¹ä¸º k - p - 1 = 5 - 2 - 1 = 2ã€‚\nä¸Šé¢çš„ç»“æœï¼š5, 3, 5, 9ï¼Œk = 2ï¼Œp = [2] = 5ï¼Œæ­¤æ—¶ k = pï¼Œç»“æŸï¼ˆk = p çš„æƒ…å†µåœ¨åé¢ä¼šè¯´æ˜ï¼‰ã€‚è‡³æ­¤ï¼Œæ•°ç»„æ’åºä¸º -1, 1, 2, 5, 3, 5, 9ï¼Œå¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å¯¹æ•´ä¸ªæ•°ç»„è¿›è¡Œæ’åºã€‚æœ€ååªéœ€è¦è¿”å›æ’åºåæ•°ç»„çš„å‰ k ä¸ªå…ƒç´ å³å¯ï¼Œå³ -1, 1, 2, 5, 3ï¼ˆå‰ k ä¸ªå…ƒç´ ä¸éœ€è¦æœ‰åºï¼‰\np \u0026gt; k\næ¯”å¦‚ï¼š-1, 2, 3, 4, 1, 5, 8, 9, k = 3ï¼Œç¬¬ä¸€è½®æ±‚å¾— p = [5] = 5\np çš„å·¦è¾¹éƒ½æ˜¯å°äº p çš„ï¼Œè€Œæ­¤æ—¶ p \u0026gt; kï¼Œä»£è¡¨æˆ‘ä»¬åªéœ€è¦ 3 ä¸ªå…ƒç´ ï¼Œä½†æ˜¯ p ä¹‹å‰å´åŒ…å«äº† 5 ä¸ªå…ƒç´ ï¼Œè¿™è¶…è¿‡äº†æˆ‘ä»¬çš„æ‰€éœ€æ•°é‡ï¼Œæ‰€ä»¥éœ€è¦å†ä»è¿™ 5 ä¸ªå…ƒç´ æ‰¾å‡ºæœ€å°çš„ 3 ä¸ªï¼Œå³å†å¯¹ p çš„å·¦è¾¹éƒ¨åˆ†è¿›è¡Œå¿«æ’ã€‚\np = k\næ¯”å¦‚ï¼š-1, 1, 2, 5, 3, 5, 9ï¼Œk = 2ï¼Œç¬¬ä¸€è½®æ±‚å¾— p = [2] = 2\næ­¤æ—¶ p = kï¼Œè¿™ä»£è¡¨ç€ï¼šp å·¦è¾¹çš„å…ƒç´ æ•°é‡åˆšå¥½ç­‰äºæ‰€éœ€çš„æ•°é‡ kï¼Œæ­¤æ—¶æ•°ç»„çš„ [0:k-1] éƒ¨åˆ†å·²ç»æ˜¯æ‰€éœ€äº†ï¼Œæ— éœ€ä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›å³å¯ï¼Œ\né€šè¿‡ä¸Šè¯‰æ“ä½œå¯ä»¥é¿å…å¯¹æ•´ä¸ªæ•°ç»„è¿›è¡Œæ’åºï¼Œæç¤ºäº†æ•ˆç‡ã€‚\nfunc getLeastNumbers(arr []int, k int) []int { quickSort(arr, k) return arr[:k] } func quickSort(arr []int, k int) { if len(arr) \u0026lt;= 1 { return } q := arr[0] l, r := 0, len(arr)-1 for l \u0026lt; r { for r \u0026gt; l \u0026amp;\u0026amp; arr[r] \u0026gt; q { r-- } arr[l] = arr[r] for r \u0026gt; l \u0026amp;\u0026amp; arr[l] \u0026lt;= q { l++ } arr[r] = arr[l] } arr[l] = q if l \u0026gt; k { quickSort(arr[:l], k) } else if l \u0026lt; k { quickSort(arr[l+1:], k-l-1) } return } æ–¹æ³• 3 å † type myHeap []int func (h myHeap) Len() int { return len(h) } func (h myHeap) Swap(i, j int) { h[i], h[j] = h[j], h[i] } func (h myHeap) Less(i, j int) bool { return h[i] \u0026gt; h[j] } func (h *myHeap) Push(x interface{}) { *h = append(*h, x.(int)) } func (h *myHeap) Pop() interface{} { p := (*h)[len(*h)-1] *h = (*h)[:len(*h)-1] return p } func (h myHeap) Top() int { return h[0] } func getLeastNumbers(arr []int, k int) []int { if len(arr) == 0 || k == 0 { return nil } h := new(myHeap) for i := 0; i \u0026lt; len(arr); i++ { if h.Len() \u0026lt; k { heap.Push(h, arr[i]) } else { if h.Top() \u0026gt; arr[i] { heap.Pop(h) heap.Push(h, arr[i]) } } } return *h } ","date":"2021å¹´07æœˆ21æ—¥","permalink":"/posts/jian-zhi-offer-40-zui-xiao-de-k-ge-shu/","summary":"è¾“å…¥æ•´æ•°æ•°ç»„ arr ï¼Œæ‰¾å‡ºå…¶ä¸­æœ€å°çš„ k ä¸ªæ•°","title":"å‰‘æŒ‡ Offer 40. æœ€å°çš„ k ä¸ªæ•°"},{"contents":"åè½¬é“¾è¡¨çš„æŒ‡å®šéƒ¨åˆ†\nç»™ä½ å•é“¾è¡¨çš„å¤´æŒ‡é’ˆ head å’Œä¸¤ä¸ªæ•´æ•°Â left å’Œ right ï¼Œå…¶ä¸­Â left \u0026lt;= right ã€‚è¯·ä½ åè½¬ä»ä½ç½® left åˆ°ä½ç½® right çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œè¿”å›åè½¬åçš„é“¾è¡¨ ã€‚\nç¤ºä¾‹1ï¼š\n1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 4 -\u0026gt; 5\tåè½¬å‰\n1 -\u0026gt; 4 -\u0026gt; 3 -\u0026gt; 2 -\u0026gt; 5\tåè½¬å\nè¾“å…¥ï¼šhead = [1,2,3,4,5], left = 2, right = 4 è¾“å‡ºï¼š[1,4,3,2,5]\nè¯´æ˜ï¼šåè½¬ç¬¬äºŒä¸ªå…ƒç´ åˆ°ç¬¬å››ä¸ªå…ƒç´ è¿™éƒ¨åˆ†ï¼ˆä» 1 å¼€å§‹ï¼‰\nè¿›é˜¶ï¼š ä½ å¯ä»¥ä½¿ç”¨ä¸€è¶Ÿæ‰«æå®Œæˆåè½¬å—ï¼Ÿ\næ–¹æ³•1 æ–­é“¾ï¼Œåè½¬ï¼Œå†æ‹¼æ¥ è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç›´è§‚ï¼Œå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•ï¼Œé¦–å…ˆæ‰¾åˆ° left å’Œ right å¯¹åº”çš„èŠ‚ç‚¹ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œleft å¯¹åº”èŠ‚ç‚¹ä¸º 2ï¼Œright å¯¹åº”èŠ‚ç‚¹ä¸º 4ï¼Œç„¶åå°† right æ–­é“¾ï¼Œå³ right.Next = nilï¼Œæ­¤æ—¶é“¾è¡¨å˜ä¸ºï¼š1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 4ã€‚åŒæ—¶è¿˜è¦è®°å½• left çš„å‰ä¸€ä¸ªèŠ‚ç‚¹å’Œ right çš„åä¸€ä¸ªèŠ‚ç‚¹ï¼Œç”¨äºä¹‹åæ¢å¤é“¾è¡¨ã€‚\nå†å®šä¹‰ä¸€ä¸ªåè½¬é“¾è¡¨å‡½æ•°ï¼Œå’Œ lc206 åè½¬é“¾è¡¨ ä¸€æ ·ï¼Œä¼ å…¥å‚æ•°ä¸º left èŠ‚ç‚¹ï¼Œå‡½æ•°ä¼šæŠŠ left åˆ° right è¿™éƒ¨åˆ†åè½¬ï¼ˆright å·²ç»æ–­é“¾äº†ï¼Œæ‰€ä»¥ä¸ä¼šå½±å“ right åé¢çš„éƒ¨åˆ†ï¼‰ï¼Œåè½¬è¿‡å 2 -\u0026gt; 3 -\u0026gt; 4 å˜ä¸º 4 -\u0026gt; 3 -\u0026gt; 2ï¼Œä½†æ˜¯è¿™æ—¶ 1 ä¾ç„¶è¿˜æŒ‡å‘ 2ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æ›´æ–° 1 çš„æŒ‡å‘ï¼Œå°† 1 æŒ‡å‘åè½¬åçš„é“¾è¡¨å¤´ï¼Œæ­¤æ—¶é“¾è¡¨ä¸º 1 -\u0026gt; 4 -\u0026gt; 3 -\u0026gt; 2ï¼Œç„¶åå†å°†é“¾è¡¨å°¾æŒ‡å‘å…ˆå‰ä¿å­˜çš„ right çš„åä¸€ä¸ªèŠ‚ç‚¹ï¼Œ1 -\u0026gt; 4 -\u0026gt; 3 -\u0026gt; 2 -\u0026gt; 5ï¼Œå¤§åŠŸå‘Šæˆã€‚\nä»£ç ï¼š\n/** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */ func reverseBetween(head *ListNode, left int, right int) *ListNode { var ( leftPrev, leftNode *ListNode rightNext, rightNode *ListNode count = 1 ) h := head for h != nil { // æ‰¾åˆ° left å¯¹åº”çš„èŠ‚ç‚¹åŠè¯¥èŠ‚ç‚¹çš„ prev èŠ‚ç‚¹ if count != left \u0026amp;\u0026amp; leftNode == nil { leftPrev = h } else if count == left { leftNode = h } // æ‰¾åˆ° right å¯¹åº”çš„èŠ‚ç‚¹åŠè¯¥èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ if count == right \u0026amp;\u0026amp; rightNode == nil { rightNode = h rightNext = h.Next } h = h.Next count++ } if rightNode != nil { rightNode.Next = nil // æ–­é“¾ } // æŠŠ leftNode åˆ° rightNode è¿™éƒ¨åˆ†åè½¬ reverse(leftNode) //fmt.Println(leftPrev, leftNode, rightNode, rightNext) //printList(rightNode) // åè½¬ä¹‹åï¼ŒrightNode æˆäº†å¤´èŠ‚ç‚¹ï¼ŒleftNode æˆäº†æœ€åä¸€ä¸ªèŠ‚ç‚¹ // æ­¤æ—¶å†å°† leftPrev æ¥ä¸Š rightNodeï¼ŒleftNode æ¥ä¸Š rightNext if leftPrev != nil { leftPrev.Next = rightNode } else { // å¦‚æœ leftPrev ä¸º nil leftNode.Next = rightNext return rightNode } if leftNode != nil { leftNode.Next = rightNext } return head } func reverse(head *ListNode) { var ( cur = head next *ListNode prev *ListNode ) for cur != nil { next = cur.Next cur.Next = prev prev = cur cur = next } } // è°ƒè¯•å‡½æ•° func printList(head *ListNode) { h := head for h != nil { fmt.Print(h.Val, \u0026quot; -\u0026gt; \u0026quot;) h = h.Next } } ä¸Šé¢çš„ä»£ç æœ‰ä¸å°‘çš„è¾¹ç•Œåˆ¤æ–­ï¼Œå¯¼è‡´ç•¥æ˜¾å†—ä½™æ‚ä¹±ï¼Œå¯èƒ½æ›´å¥½çš„è§£å†³æ–¹æ³•æ˜¯è®¾ç½®ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥åº”å¯¹ ä¸€äº›è¾¹ç•Œæƒ…å†µäº†ï¼Œæ¯”å¦‚ left æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ—¶ prev å°†æ˜¯ nilï¼Œå½“ leftPrev.Next æ—¶å°±ä¼šæŠ¥é”™ï¼Œä½†è®¾ç½®äº†å“¨å…µèŠ‚ç‚¹åï¼Œprev æ˜¯å“¨å…µèŠ‚ç‚¹ï¼Œè¿™æ · leftPrev.Next å°±ä¸ä¼šäº§ç”Ÿé”™è¯¯äº†ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘è¿˜æ²¡æœ‰å®è·µï¼Œå› ä¸ºè¿˜æœ‰ä¸€ç§æ›´å¥½çš„æ–¹æ³•ã€‚\næ–¹æ³•2 ä¸€æ¬¡éå† æ–¹æ³• 1 è™½ç„¶å¯ä»¥ acï¼Œä½†æ˜¯ä¸æ»¡è¶³é¢˜ç›®çš„è¿›é˜¶è¦æ±‚ï¼šåªéå†é“¾è¡¨ä¸€æ¬¡ã€‚åœ¨å‚è€ƒäº†é¢˜è§£åï¼Œäº†è§£äº†å¦ä¸€ç§æ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•ç•¥å¾®æœ‰äº›ç¹çï¼Œæ–‡å­—éš¾ä»¥æè¿°ï¼Œç›´æ¥ä¸Šå›¾æ›´å¥½ç†è§£ï¼š\nä»£ç å¦‚ä¸‹ï¼š\nfunc reverseBetween(head *ListNode, left int, right int) *ListNode { var ( s = \u0026amp;ListNode{Next: head} prev = s cur, next *ListNode ) for i := 0; i \u0026lt; left-1; i++ { prev = prev.Next } cur = prev.Next next = cur.Next for i := 0; i \u0026lt; right-left; i++ { cur.Next = next.Next next.Next = prev.Next prev.Next = next next = cur.Next } return s.Next } ","date":"2021å¹´07æœˆ20æ—¥","permalink":"/posts/leetcode-92-fan-zhuan-lian-biao-ii/","summary":"åè½¬é“¾è¡¨çš„æŒ‡å®šéƒ¨åˆ†\nç»™ä½ å•é“¾è¡¨çš„å¤´æŒ‡é’ˆ head å’Œä¸¤ä¸ªæ•´æ•°Â left å’Œ right ï¼Œå…¶ä¸­Â left \u0026lt;= right ã€‚è¯·ä½ åè½¬ä»ä½ç½® left åˆ°ä½ç½® right çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œè¿”å›åè½¬åçš„é“¾è¡¨ ã€‚","title":"LeetCode 92. åè½¬é“¾è¡¨ II"},{"contents":"select é”™è¯¯ä½¿ç”¨è®°å½•ï¼ŒåŠ æ·±å¯¹ select çš„ç†è§£\né”™è¯¯çš„ä»£ç  æœ‰å¦‚ä¸‹ä¸€ä¸ªä½¿ç”¨å¤šè·¯å¤ç”¨ select å®ç°çš„ echoï¼ˆå›å“ï¼‰æœåŠ¡å™¨ï¼š\nint main() { char buf[BUF_SIZE]; // ç®€å•å°è£…äº†ä¸€ä¸‹ socket çš„åˆ›å»ºæµç¨‹ Server s(\u0026quot;tcp\u0026quot;, \u0026quot;0.0.0.0\u0026quot;, \u0026quot;8080\u0026quot;); s.Listen(1024); fd_set readfds; // ç›‘å¬æœåŠ¡ç«¯socketï¼Œå½“æœ‰å®¢æˆ·è¿æ¥æ—¶ä¼šè§¦å‘äº‹ä»¶ FD_ZERO(\u0026amp;readfds); FD_SET(s.Sockfd(), \u0026amp;readfds); int maxfd = s.Sockfd(); for (; ;) { int okcnt = select(maxfd+1, \u0026amp;readfds, nullptr, nullptr, nullptr); if (okcnt == -1) { printf(\u0026quot;select error\\n\u0026quot;); break; } if (okcnt == 0) { continue; } // éå† select æ•°ç»„ for (int i = 0; i \u0026lt; maxfd+1; ++i) { // æ‰¾åˆ°æ‰€æœ‰å€¼ä¸º 1 çš„ fdï¼Œè¿™è¡¨ç¤ºè¯¥ fd å·²ç»å‡†å¤‡å°±ç»ªäº† if (FD_ISSET(i, \u0026amp;readfds)) { // å¦‚æœå°±ç»ªçš„ fd ä¸º server,è¯´æ˜æœ‰æ–°çš„è¿æ¥è¯·æ±‚ if (i == s.Sockfd()) { // è°ƒç”¨ accept æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ auto conn = s.Accept(); int connfd = conn-\u0026gt;Connfd(); // æ›´æ–° maxfd if (connfd \u0026gt; maxfd) { maxfd = connfd; } // å°† conn çš„ fd æ·»åŠ åˆ° select ç›‘å¬é›†åˆä¸­ FD_SET(connfd, \u0026amp;readfds); printf(\u0026quot;connected client: %d\\n\u0026quot;, conn-\u0026gt;Connfd()); // å¦‚æœå°±ç»ªçš„ fd ä¸æ˜¯ server fdï¼Œåˆ™æ˜¯ conn fd } else { printf(\u0026quot;conn %d is already\\n\u0026quot;, i); // å¯ä»¥å¯¹è¿™äº›å‡†å¤‡å°±ç»ªçš„ conn è¿›è¡Œ echo å¤„ç†äº† int n = read(i, buf, BUF_SIZE); if (n == 0) { // EOF // FD_CLR(i, \u0026amp;readfds); close(i); printf(\u0026quot;close conn: %d\\n\u0026quot;, i); } else { write(i, buf, n); } } } } } s.Close(); return 0; } è¿è¡Œç»“æœ ç¼–è¯‘å¹¶è¿è¡Œï¼š\ng++ -o echo_server_wrong_example echo_server_wrong_example.cc ./echo_server_wrong_example æ–°å»ºä¸€ä¸ªç»ˆç«¯å¹¶å¼€å¯ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼š\nnc localhost 8080 æ­¤æ—¶åªè¿æ¥åˆ°æœåŠ¡ç«¯ï¼Œä¸å‘é€ä»»ä½•æ•°æ®ï¼ŒæœåŠ¡ç«¯çš„æ—¥å¿—ï¼š\nconnected client: 4 conn 4 is already éšåå†æ–°å»ºä¸€ä¸ªç»ˆç«¯å¹¶å¼€å¯ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶å°è¯•å‘é€æ•°æ®ï¼š\nnc localhost 8080 1 ä½†æ˜¯æ²¡æœ‰ä»»ä½•å›åº”ï¼ŒæŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ï¼š\nconnected client: 4 conn 4 is already æ ¹æœ¬æ²¡æœ‰æ¥æ”¶ç¬¬äºŒä¸ªæœåŠ¡ç«¯çš„è¿æ¥ï¼è¯´æ˜ç¼–å†™çš„è¿™ä¸ªç¨‹åºæ˜¯æ²¡æœ‰å¹¶å‘èƒ½åŠ›çš„ï¼Œä¸€å®šæ˜¯æŸä¸ªåœ°æ–¹å†™é”™äº†\nå†è¿”å›å»çœ‹ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯æ˜¯å¦èƒ½æ­£å¸¸æ”¶åˆ°å“åº”ï¼š\nnc localhost 8080 1 // å‘é€çš„ 1\t// å“åº”çš„ ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„\nå†å°†ç¬¬ä¸€ä¸ªæœåŠ¡ç«¯ç»“æŸï¼ŒæœåŠ¡ç«¯æ—¥å¿—ï¼š\nclose conn: 4 æ­¤æ—¶åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œå‘ç°åŸæ¥é˜»å¡çš„è¯·æ±‚å¾—åˆ°äº†å“åº”ï¼š\nnc localhost 8080 1 l æœåŠ¡ç«¯æ—¥å¿—ï¼š\n// ä¹‹å‰çš„ connected client: 4 conn 4 is already close conn: 4 // æ–°çš„ connected client: 4 conn 4 is already å¹¶ä¸”ä¹‹åçš„æ‰€æœ‰è¯·æ±‚éƒ½èƒ½å¤Ÿå¾—åˆ°å“åº”\næ­¤æ—¶å†å¯åŠ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼š\næœåŠ¡ç«¯æ—¥å¿—ï¼š\nconnected client: 5 conn 5 is already å°è¯•å‘é€æ•°æ®ï¼š\nkk kk adasd adasd å…¨éƒ¨èƒ½å¤Ÿå¾—åˆ°å“åº”\nå†åˆ‡åˆ°ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶å‘é€æ•°æ®ï¼Œç»“æœå‘ç°é˜»å¡äº†ï¼ŒæœåŠ¡ç«¯æ—¥å¿—æ²¡æœ‰ä»»ä½•å˜åŒ–\næ­£ç¡®çš„ä»£ç  ä¿®æ”¹ä¸ºæ­£ç¡®çš„ç¨‹åºï¼š\n// // Created by root on 7/17/21. // #include \u0026quot;../pkg/net/net.h\u0026quot; #include \u0026lt;sys/select.h\u0026gt; #define BUF_SIZE 100 // g++ -o echo_server echo_server.cc ../pkg/net/net.cpp int main() { char buf[BUF_SIZE]; Server s(\u0026quot;tcp\u0026quot;, \u0026quot;0.0.0.0\u0026quot;, \u0026quot;8080\u0026quot;); s.Listen(1024); fd_set readfds; FD_ZERO(\u0026amp;readfds); // ç›‘å¬æœåŠ¡ç«¯socketï¼Œå½“æœ‰å®¢æˆ·è¿æ¥æ—¶ä¼šè§¦å‘äº‹ä»¶ FD_SET(s.Sockfd(), \u0026amp;readfds); int maxfd = s.Sockfd(); for (; ;) { // è¿™å¥è¯éå¸¸é‡è¦ï¼Œå¦åˆ™ä¼šå‡ºç°å¤šæ¡è¿æ¥åªæœ‰ä¸€æ¡èƒ½æ­£å¸¸å·¥ä½œï¼Œå…¶ä»–å…¨éƒ¨é˜»å¡çš„ bug // readfds ä¿å­˜çš„æ˜¯è¦ç›‘å¬çš„ fd é›†åˆï¼Œä½†æ˜¯æ¯æ¬¡è°ƒç”¨ select åï¼Œä¼šå°†è¿™äº›ç›‘ // å¬ fd ä¸­å·²ç»å‡†å¤‡å¥½çš„ç½® 1ï¼Œæœªå‡†å¤‡å¥½çš„ç½® 0ï¼Œå¦‚æœä½¿ç”¨è¿™ä¸ªå·²è¢«æ›´æ”¹çš„ fdsetï¼Œ // å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å¼‚å¸¸æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥è¿™é‡Œå°† fdset æ‹·è´ä¸€ä»½ï¼Œè°ƒç”¨ select æ—¶ä¼  // å…¥æ‹·è´å€¼ï¼Œè¿™æ · select çš„æ›´æ”¹å°±ä¸ä¼šå½±å“åˆ°åŸ fdset fd_set cpyset = readfds; // okcntï¼šå‡†å¤‡å°±ç»ªçš„ fd æ•°é‡ int okcnt = select(maxfd+1, \u0026amp;cpyset, nullptr, nullptr, nullptr); if (okcnt == -1) { printf(\u0026quot;select error\\n\u0026quot;); break; } if (okcnt == 0) { continue; } // éå† select æ•°ç»„ for (int i = 0; i \u0026lt; maxfd+1; ++i) { // æ‰¾åˆ°æ‰€æœ‰å€¼ä¸º 1 çš„ fdï¼Œè¿™è¡¨ç¤ºè¯¥ fd å·²ç»å‡†å¤‡å°±ç»ªäº† if (FD_ISSET(i, \u0026amp;cpyset)) { // å¦‚æœå°±ç»ªçš„ fd ä¸º server,è¯´æ˜æœ‰æ–°çš„è¿æ¥è¯·æ±‚ if (i == s.Sockfd()) { // è°ƒç”¨ accept æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ auto conn = s.Accept(); int connfd = conn-\u0026gt;Connfd(); // æ›´æ–° maxfd if (connfd \u0026gt; maxfd) { maxfd = connfd; } // å°† conn çš„ fd æ·»åŠ åˆ° select ç›‘å¬é›†åˆä¸­ FD_SET(connfd, \u0026amp;readfds); printf(\u0026quot;connected client: %d\\n\u0026quot;, conn-\u0026gt;Connfd()); // å¦‚æœå°±ç»ªçš„ fd ä¸æ˜¯ server fdï¼Œåˆ™æ˜¯ conn fd } else { printf(\u0026quot;conn %d is already\\n\u0026quot;, i); // å¯ä»¥å¯¹è¿™äº›å‡†å¤‡å°±ç»ªçš„ conn è¿›è¡Œ echo å¤„ç†äº† int n = read(i, buf, BUF_SIZE); if (n == 0) { // EOF // FD_CLR(i, \u0026amp;readfds); close(i); printf(\u0026quot;close conn: %d\\n\u0026quot;, i); } else { write(i, buf, n); } } } } } s.Close(); return 0; } è¿™æ®µä»£ç åªæ›´æ”¹äº†å‡ ä¸ªåœ°æ–¹ï¼š\n29 è¡Œçš„ fd_set cpyset = readfds\n32 è¡Œçš„ select(maxfd+1, \u0026amp;cpyset, nullptr, nullptr, nullptr)ï¼Œå°†ç¬¬äºŒä¸ªå‚æ•°ç”± readfds æ›´æ”¹ä¸º cpyset\n44 è¡Œçš„ if (FD_ISSET(i, \u0026amp;cpyset))ï¼Œä¹‹å‰ä¸º if (FD_ISSET(i, \u0026amp;readfds))\nåˆ†æ ç®€å•è¯´æ˜ä¸‹ç¨‹åºçš„æµç¨‹ï¼š\nå…ˆå°†æœåŠ¡ç«¯ socket åŠ å…¥åˆ° select çš„ç›‘å¬é›†åˆï¼Œä¹‹åè°ƒç”¨ select int okcnt = select(maxfd+1, \u0026amp;readfds, nullptr, nullptr, nullptr); è¿™é‡Œä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ fd å‡†å¤‡å¥½ã€‚\nå½“æœåŠ¡ç«¯ socket å‡†å¤‡å¥½äº†ä»¥åï¼Œselect è¿”å› 1ï¼ˆå› ä¸ºåªç›‘å¬äº†ä¸€ä¸ª fdï¼‰ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ for (int i = 0; i \u0026lt; maxfd+1; ++i)ï¼Œç»§ç»­æ‰§è¡Œ if (FD_ISSET(i, \u0026amp;readfds))ï¼Œè¿™æ ·ä¼šéå† fdset å¹¶æ‰¾åˆ°å‡†å¤‡å°±ç»ªçš„ fdï¼Œæ­¤æ—¶åªæœ‰æœåŠ¡ç«¯çš„ fd å‡†å¤‡å¥½äº†ï¼Œæ‰€ä»¥å¿…ç„¶è¿›å…¥ä¸‹é¢çš„è¯­å¥if (i == s.Sockfd())ï¼Œä¹‹å FD_SET(connfd, \u0026amp;readfds)å¹¶ä¸”æ›´æ–° maxfdã€‚\né—®é¢˜æ¥äº†ï¼ŒFD_SET(connfd, \u0026amp;readfds)æ˜¯å¸Œæœ›å°† connfd æ·»åŠ åˆ°ç›‘å¬é›†åˆä¸­ï¼Œä½†æ˜¯ç¨‹åºä¼šé”™è¯¯çš„ç»§ç»­æ‰§è¡Œ for (int i = 0; i \u0026lt; maxfd+1; ++i)ï¼Œå¹¶æ‰¾åˆ° connfdï¼Œå› ä¸ºåˆšåˆšçš„ FD_SET æ“ä½œæŠŠå…¶ç½®äº 1ï¼Œå¯¼è‡´ç¨‹åºé”™è¯¯çš„è®¤ä¸ºè¯¥ fd å·²ç»å‡†å¤‡å°±ç»ªï¼Œåˆå› ä¸ºä¸æ»¡è¶³ if (i == s.Sockfd())ï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ï¼Œè¿›å…¥ read(i, buf, BUF_SIZE) æ“ä½œï¼Œä½†æ˜¯å› ä¸ºè¯¥ fd æ ¹æœ¬æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæ‰€ä»¥æ•´ä¸ªç¨‹åºä¼šè¿›å…¥é˜»å¡ã€‚\né€ æˆè¯¥é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ select çš„æœºåˆ¶é—®é¢˜ï¼šä¼ å…¥è¦ç›‘å¬çš„ fd åˆ° fdset ä¸­ï¼Œå½“å…¶è¿”å›æ—¶ï¼Œä¼šå°†ç›‘å¬ä¸­å·²å°±ç»ªçš„ç½®1ï¼Œæœªå°±ç»ªçš„ç½® 0ï¼Œfdset å³å……å½“äº†è®°å½•è¢«ç›‘å¬ fd çš„è§’è‰²ï¼Œåˆå……å½“äº†è®°å½•å·²å°±ç»ª fd çš„è§’è‰²ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ··ä¹±çš„ç»“æœï¼Œåœ¨é”™è¯¯çš„ç¨‹åºä¸­å°±æ˜¯è¿™æ ·ï¼Œreadfds å……å½“äº†ä¸¤ä¸ªè§’è‰²ï¼Œå¯¼è‡´äº†ç¨‹åºçš„ä¸æ­£ç¡®ã€‚\nè§£å†³æ–¹æ³•å°±æ˜¯é¢å¤–åˆ›å»ºä¸€ä¸ª fdsetï¼Œä¸€ä¸ªç”¨æ¥è®°å½•è¦ç›‘å¬çš„ fdï¼Œä¸€ä¸ªè®°å½•å·²å°±ç»ª fdï¼Œåœ¨æ­£ç¡®çš„ä»£ç ä¸­ï¼Œ readfdså°±æ˜¯ç”¨æ¥è®°å½•è¦ç›‘å¬çš„ fdï¼Œcpyset æ˜¯ç”¨æ¥è®°å½•å·²å°±ç»ª fdã€‚\næ¯æ¬¡ for å¾ªç¯ï¼Œcpyset éƒ½ä¼šæ‹·è´ readfdsè·å¾—è¦ç›‘å¬çš„æ‰€æœ‰ fdï¼Œå¹¶ä¼ å…¥ selectï¼Œå¾—åˆ°å·²å°±ç»ªçš„ fdï¼Œä¹‹åçš„ FD_ISSET ä¹Ÿæ˜¯åŸºäºcpysetï¼Œå½“è¦æ–°è®°å½• fd æ—¶ï¼Œæ‰§è¡Œè¯­å¥FD_SET(connfd, \u0026amp;readfds)ï¼Œå°† fd æ·»åŠ åˆ° readfds ä¸­ï¼Œåˆ é™¤ fd æ—¶ä¹Ÿæ˜¯ FD_CLR(i, \u0026amp;readfds)ï¼Œè¿™æ ·äºŒè€…å„å¸å…¶èŒï¼Œå°±å¯ä»¥ä¿è¯ç¨‹åºçš„æ­£å¸¸å·¥ä½œäº†ã€‚\n","date":"2021å¹´07æœˆ18æ—¥","permalink":"/posts/linux-select-de-cuo-wu-shi-yong-an-li/","summary":"select é”™è¯¯ä½¿ç”¨è®°å½•ï¼ŒåŠ æ·±å¯¹ select çš„ç†è§£\né”™è¯¯çš„ä»£ç  æœ‰å¦‚ä¸‹ä¸€ä¸ªä½¿ç”¨å¤šè·¯å¤ç”¨ select å®ç°çš„ echoï¼ˆå›å“ï¼‰æœåŠ¡å™¨ï¼š","title":"linux select çš„é”™è¯¯ä½¿ç”¨æ¡ˆä¾‹"},{"contents":"ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿çš„å›æ–‡å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦\nç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿çš„å›æ–‡å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦ã€‚å¯ä»¥å‡è®¾ s çš„æœ€å¤§é•¿åº¦ä¸º 1000 ã€‚\nç¤ºä¾‹ 1: è¾“å…¥: \u0026ldquo;bbbab\u0026rdquo;\nè¾“å‡º: 4\nä¸€ä¸ªå¯èƒ½çš„æœ€é•¿å›æ–‡å­åºåˆ—ä¸º \u0026ldquo;bbbb\u0026rdquo;ã€‚\nç¤ºä¾‹ 2: è¾“å…¥: \u0026ldquo;cbbd\u0026rdquo;\nè¾“å‡º: 2 ä¸€ä¸ªå¯èƒ½çš„æœ€é•¿å›æ–‡å­åºåˆ—ä¸º \u0026ldquo;bb\u0026rdquo;ã€‚\næç¤ºï¼š\n1 \u0026lt;= s.length \u0026lt;= 1000 s åªåŒ…å«å°å†™è‹±æ–‡å­—æ¯\næ–¹æ³•1 åŠ¨æ€è§„åˆ’ è¿™é“é¢˜å’Œ LeetCode 5 æœ€é•¿å›æ–‡å­ä¸² ç±»ä¼¼ï¼Œï¼ˆhttps://zengh1.github.io/post/leetcode-5-zui-chang-hui-wen-zi-chuan/ ï¼‰\nä»£ç å¦‚ä¸‹ï¼š cpp\nclass Solution { public: int longestPalindromeSubseq(string s) { int len = s.size(); vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; dp(len, vector\u0026lt;int\u0026gt;(len, 0)); int maxlen = 1; for (int i = len - 1; i \u0026gt;= 0; i--) { for (int j = i; j \u0026lt; len; j++) { if (i == j) { dp[i][j] = 1; } else if (s[i] == s[j]) { dp[i][j] = dp[i+1][j-1] + 2; } else { dp[i][j] = max(dp[i+1][j], dp[i][j-1]); } maxlen = max(maxlen, dp[i][j]); } } return maxlen; } }; ","date":"2021å¹´07æœˆ01æ—¥","permalink":"/posts/leetcode-516-zui-chang-hui-wen-zi-xu-lie/","summary":"ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿çš„å›æ–‡å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦\nç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿çš„å›æ–‡å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦ã€‚å¯ä»¥å‡è®¾ s çš„æœ€å¤§é•¿åº¦ä¸º 1000 ã€‚","title":"LeetCode 516. æœ€é•¿å›æ–‡å­åºåˆ—"},{"contents":"ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œæ‰¾åˆ° s ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚\nç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œæ‰¾åˆ° s ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;babad\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;bab\u0026rdquo; è§£é‡Šï¼š\u0026ldquo;aba\u0026rdquo; åŒæ ·æ˜¯ç¬¦åˆé¢˜æ„çš„ç­”æ¡ˆã€‚\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;cbbd\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;bb\u0026rdquo;\nç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;a\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;a\u0026rdquo;\nç¤ºä¾‹ 4ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;ac\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;a\u0026rdquo;\næç¤ºï¼š\n1 \u0026lt;= s.length \u0026lt;= 1000 s ä»…ç”±æ•°å­—å’Œè‹±æ–‡å­—æ¯ï¼ˆå¤§å†™å’Œ/æˆ–å°å†™ï¼‰ç»„æˆ\næ–¹æ³•1 åŠ¨æ€è§„åˆ’ ä»£ç å¦‚ä¸‹ï¼š\ncpp\nclass Solution { public: string longestPalindrome(string s) { vector\u0026lt;vector\u0026lt;bool\u0026gt;\u0026gt; dp(s.size(), vector\u0026lt;bool\u0026gt;(s.size())); string res; int maxlen = 0; for (int i = s.size(); i \u0026gt;= 0; i--) { for (int j = i; j \u0026lt; s.size(); j++) { if (i == j) { dp[i][j] = true; } else if (s[i] != s[j]) { dp[i][j] = false; } else if (i == j-1) { dp[i][j] = s[i] == s[j]; } else if (s[i] == s[j]) { dp[i][j] = dp[i+1][j-1]; } if (dp[i][j]) { if (j-i \u0026gt;= maxlen) { maxlen = j - i; res = s.substr(i, j-i+1); } } } } return res; } }; ","date":"2021å¹´06æœˆ29æ—¥","permalink":"/posts/leetcode-5-zui-chang-hui-wen-zi-chuan/","summary":"ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œæ‰¾åˆ° s ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚\nç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œæ‰¾åˆ° s ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚","title":"LeetCode 5. æœ€é•¿å›æ–‡å­ä¸²"},{"contents":"ç»™å®šä¸¤ä¸ªä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤ºçš„éè´Ÿæ•´æ•°Â num1Â å’ŒÂ num2ï¼Œè¿”å›Â num1Â å’ŒÂ num2Â çš„ä¹˜ç§¯ï¼Œå®ƒä»¬çš„ä¹˜ç§¯ä¹Ÿè¡¨ç¤ºä¸ºå­—ç¬¦ä¸²å½¢å¼ã€‚\nç»™å®šä¸¤ä¸ªä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤ºçš„éè´Ÿæ•´æ•°Â num1Â å’ŒÂ num2ï¼Œè¿”å›Â num1Â å’ŒÂ num2Â çš„ä¹˜ç§¯ï¼Œå®ƒä»¬çš„ä¹˜ç§¯ä¹Ÿè¡¨ç¤ºä¸ºå­—ç¬¦ä¸²å½¢å¼ã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: num1 = \u0026ldquo;2\u0026rdquo;, num2 = \u0026ldquo;3\u0026rdquo; è¾“å‡º: \u0026ldquo;6\u0026rdquo;\nç¤ºä¾‹Â 2:\nè¾“å…¥: num1 = \u0026ldquo;123\u0026rdquo;, num2 = \u0026ldquo;456\u0026rdquo; è¾“å‡º: \u0026ldquo;56088\u0026rdquo;\nè¯´æ˜ï¼š\nnum1Â å’ŒÂ num2Â çš„é•¿åº¦å°äº110ã€‚ num1 å’ŒÂ num2 åªåŒ…å«æ•°å­—Â 0-9ã€‚ num1 å’ŒÂ num2Â å‡ä¸ä»¥é›¶å¼€å¤´ï¼Œé™¤éæ˜¯æ•°å­— 0 æœ¬èº«ã€‚ ä¸èƒ½ä½¿ç”¨ä»»ä½•æ ‡å‡†åº“çš„å¤§æ•°ç±»å‹ï¼ˆæ¯”å¦‚ BigIntegerï¼‰æˆ–ç›´æ¥å°†è¾“å…¥è½¬æ¢ä¸ºæ•´æ•°æ¥å¤„ç†ã€‚\næ–¹æ³•1 æ¨¡æ‹Ÿæ•°å­¦ åœ¨è‰ç¨¿çº¸ä¸Šå†™ä¸€ä¸‹ä¹˜æ³•çš„è¿ç®—æ­¥éª¤ï¼Œå¹¶å°†å…¶æ”¹å†™ä¸ºä»£ç å½¢å¼ï¼š\n// 45 //\t* 123 // --------------\t// 135\t// + 90 // 45 // --------------- // 5535 func multiply(num1 string, num2 string) string { var ( flag int // ä¿å­˜è¿›ä½ res string pown int // ç¡®å®šè¦è¡¥å‡ ä¸ª 0 ) if num1 == \u0026quot;0\u0026quot; || num2 == \u0026quot;0\u0026quot; { return \u0026quot;0\u0026quot; } for i := len(num1) - 1; i \u0026gt;= 0; i-- { var r strings.Builder for j := len(num2) - 1; j \u0026gt;= 0; j-- { v1 := int(num1[i] - '0') v2 := int(num2[j] - '0') tmp := v1*v2 + flag flag = tmp / 10 tmp %= 10 r.WriteByte(byte(tmp + '0')) } if flag != 0 { r.WriteByte(byte(flag) + '0') flag = 0 } rstr := reverseStr(r.String()) // 45 //\t* 123 // --------------\tæ¯æ­¥åé¢è¡¥ n-1 ä¸ª 0ï¼Œn ä¸º ä½æ•° // 135\t135\tè¡¥ 0 ä¸ª // 90 =\u0026gt; 900\tè¡¥ 1 ä¸ª // 45\t4500 è¡¥ 2 ä¸ª for i := 0; i \u0026lt; pown; i++ { rstr += \u0026quot;0\u0026quot; } pown++ // å­—ç¬¦ä¸²ç›¸åŠ  res = strAdd(res, rstr) } return res } func reverseStr(s string) string { b := []byte(s) for i, j := 0, len(s)-1; i \u0026lt; j; i, j = i+1, j-1 { b[i], b[j] = b[j], b[i] } return string(b) } func strAdd(s1, s2 string) string { var ( flag int res strings.Builder ) for i, j := len(s1)-1, len(s2)-1; i \u0026gt;= 0 || j \u0026gt;= 0; i, j = i-1, j-1 { var v1, v2 int if i \u0026gt;= 0 { v1 = int(s1[i] - '0') } else { v1 = 0 } if j \u0026gt;= 0 { v2 = int(s2[j] - '0') } else { v2 = 0 } sum := v1 + v2 + flag flag = sum / 10 sum %= 10 res.WriteByte(byte(sum) + '0') } if flag != 0 { res.WriteByte(byte(flag) + '0') } str := reverseStr(res.String()) return str } æ–¹æ³•2 ä¼˜åŒ– æ–¹æ³•ä¸€çš„åšæ³•æ˜¯ä»å³å¾€å·¦éå†ä¹˜æ•°ï¼Œå°†ä¹˜æ•°çš„æ¯ä¸€ä½ä¸è¢«ä¹˜æ•°ç›¸ä¹˜å¾—åˆ°å¯¹åº”çš„ç»“æœï¼Œå†å°†æ¯æ¬¡å¾—åˆ°çš„ç»“æœç´¯åŠ ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°è¾ƒå¤šå­—ç¬¦ä¸²ç›¸åŠ çš„æ“ä½œã€‚å¦‚æœä½¿ç”¨æ•°ç»„ä»£æ›¿å­—ç¬¦ä¸²å­˜å‚¨ç»“æœï¼Œåˆ™å¯ä»¥å‡å°‘å¯¹å­—ç¬¦ä¸²çš„æ“ä½œã€‚å…·ä½“çš„æ–¹æ³•å¦‚ä¸‹ï¼š\nä»£ç å¦‚ä¸‹ï¼š\ngo\nfunc multiply(num1 string, num2 string) string { if num1 == \u0026quot;0\u0026quot; || num2 == \u0026quot;0\u0026quot; { return \u0026quot;0\u0026quot; } n1l := len(num1) n2l := len(num2) n := make([]int, n1l+n2l, n1l+n2l) for i := n1l - 1; i \u0026gt;= 0; i-- { v1 := num1[i] - '0' for j := n2l - 1; j \u0026gt;= 0; j-- { v2 := num2[j] - '0' n[i+j+1] += int(v1) * int(v2) } } var ( flag int res strings.Builder start int ) for i := len(n) - 1; i \u0026gt;= 0; i-- { n[i] += flag flag = n[i] / 10 n[i] %= 10 } //fmt.Println(n) if n[0] == 0 { start = 1 } for ; start \u0026lt; len(n); start++ { s := strconv.Itoa(n[start]) res.WriteString(s) } return res.String() } cpp\nclass Solution { public: string multiply(string num1, string num2) { if (num1 == \u0026quot;0\u0026quot; || num2 == \u0026quot;0\u0026quot;) { return \u0026quot;0\u0026quot;; } int n1l = num1.size(); int n2l = num2.size(); vector\u0026lt;int\u0026gt; v(n1l + n2l); for (int i = n1l - 1; i \u0026gt;= 0; i--) { for (int j = n2l - 1; j \u0026gt;= 0; j--) { v[i+j+1] += (num1[i] - '0') * (num2[j] - '0'); } } int flag = 0; string res; int start = 0; for (int i = v.size() - 1; i \u0026gt;= 0; i--) { v[i] += flag; flag = v[i] / 10; v[i] %= 10; } // for (auto vv : v) { // cout \u0026lt;\u0026lt; vv \u0026lt;\u0026lt; endl; // } if (v[0] == 0) { start = 1; } for (; start \u0026lt; v.size(); start++) { res += char(v[start]+'0'); } return res; } }; ","date":"2021å¹´06æœˆ23æ—¥","permalink":"/posts/leetcode-43-zi-fu-chuan-xiang-cheng/","summary":"ç»™å®šä¸¤ä¸ªä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤ºçš„éè´Ÿæ•´æ•°Â num1Â å’ŒÂ num2ï¼Œè¿”å›Â num1Â å’ŒÂ num2Â çš„ä¹˜ç§¯ï¼Œå®ƒä»¬çš„ä¹˜ç§¯ä¹Ÿè¡¨ç¤ºä¸ºå­—ç¬¦ä¸²å½¢å¼ã€‚","title":"LeetCode 43. å­—ç¬¦ä¸²ç›¸ä¹˜"},{"contents":"æœ€ä¸ç»å¸¸ä½¿ç”¨ï¼ˆLFUï¼‰ç¼“å­˜ç®—æ³•\nè¯·ä½ ä¸º æœ€ä¸ç»å¸¸ä½¿ç”¨ï¼ˆLFUï¼‰ç¼“å­˜ç®—æ³•è®¾è®¡å¹¶å®ç°æ•°æ®ç»“æ„ã€‚\nå®ç° LFUCache ç±»ï¼š\nLFUCache(int capacity) - ç”¨æ•°æ®ç»“æ„çš„å®¹é‡Â capacity åˆå§‹åŒ–å¯¹è±¡ int get(int key)Â - å¦‚æœé”®å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è·å–é”®çš„å€¼ï¼Œå¦åˆ™è¿”å› -1ã€‚ void put(int key, int value)Â - å¦‚æœé”®å·²å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶å€¼ï¼›å¦‚æœé”®ä¸å­˜åœ¨ï¼Œè¯·æ’å…¥é”®å€¼å¯¹ã€‚å½“ç¼“å­˜è¾¾åˆ°å…¶å®¹é‡æ—¶ï¼Œåˆ™åº”è¯¥åœ¨æ’å…¥æ–°é¡¹ä¹‹å‰ï¼Œä½¿æœ€ä¸ç»å¸¸ä½¿ç”¨çš„é¡¹æ— æ•ˆã€‚åœ¨æ­¤é—®é¢˜ä¸­ï¼Œå½“å­˜åœ¨å¹³å±€ï¼ˆå³ä¸¤ä¸ªæˆ–æ›´å¤šä¸ªé”®å…·æœ‰ç›¸åŒä½¿ç”¨é¢‘ç‡ï¼‰æ—¶ï¼Œåº”è¯¥å»é™¤ æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ çš„é”®ã€‚ æ³¨æ„ã€Œé¡¹çš„ä½¿ç”¨æ¬¡æ•°ã€å°±æ˜¯è‡ªæ’å…¥è¯¥é¡¹ä»¥æ¥å¯¹å…¶è°ƒç”¨ get å’Œ put å‡½æ•°çš„æ¬¡æ•°ä¹‹å’Œã€‚ä½¿ç”¨æ¬¡æ•°ä¼šåœ¨å¯¹åº”é¡¹è¢«ç§»é™¤åç½®ä¸º 0 ã€‚\nä¸ºäº†ç¡®å®šæœ€ä¸å¸¸ä½¿ç”¨çš„é”®ï¼Œå¯ä»¥ä¸ºç¼“å­˜ä¸­çš„æ¯ä¸ªé”®ç»´æŠ¤ä¸€ä¸ª ä½¿ç”¨è®¡æ•°å™¨ ã€‚ä½¿ç”¨è®¡æ•°æœ€å°çš„é”®æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„é”®ã€‚\nå½“ä¸€ä¸ªé”®é¦–æ¬¡æ’å…¥åˆ°ç¼“å­˜ä¸­æ—¶ï¼Œå®ƒçš„ä½¿ç”¨è®¡æ•°å™¨è¢«è®¾ç½®ä¸º 1 (ç”±äº put æ“ä½œ)ã€‚å¯¹ç¼“å­˜ä¸­çš„é”®æ‰§è¡Œ get æˆ– put æ“ä½œï¼Œä½¿ç”¨è®¡æ•°å™¨çš„å€¼å°†ä¼šé€’å¢ã€‚\nç¤ºä¾‹ï¼š\nè¾“å…¥ï¼š [\u0026ldquo;LFUCache\u0026rdquo;, \u0026ldquo;put\u0026rdquo;, \u0026ldquo;put\u0026rdquo;, \u0026ldquo;get\u0026rdquo;, \u0026ldquo;put\u0026rdquo;, \u0026ldquo;get\u0026rdquo;, \u0026ldquo;get\u0026rdquo;, \u0026ldquo;put\u0026rdquo;, \u0026ldquo;get\u0026rdquo;, \u0026ldquo;get\u0026rdquo;, \u0026ldquo;get\u0026rdquo;] [[2], [1, 1], [2, 2], [1], [3, 3], [2], [3], [4, 4], [1], [3], [4]] è¾“å‡ºï¼š [null, null, null, 1, null, -1, 3, null, -1, 3, 4]\nè§£é‡Šï¼š // cnt(x) = é”® x çš„ä½¿ç”¨è®¡æ•° // cache=[] å°†æ˜¾ç¤ºæœ€åä¸€æ¬¡ä½¿ç”¨çš„é¡ºåºï¼ˆæœ€å·¦è¾¹çš„å…ƒç´ æ˜¯æœ€è¿‘çš„ï¼‰ LFUCache lFUCache = new LFUCache(2); lFUCache.put(1, 1); // cache=[1,_], cnt(1)=1 lFUCache.put(2, 2); // cache=[2,1], cnt(2)=1, cnt(1)=1 lFUCache.get(1); // è¿”å› 1 // cache=[1,2], cnt(2)=1, cnt(1)=2 lFUCache.put(3, 3); // å»é™¤é”® 2 ï¼Œå› ä¸º cnt(2)=1 ï¼Œä½¿ç”¨è®¡æ•°æœ€å° // cache=[3,1], cnt(3)=1, cnt(1)=2 lFUCache.get(2); // è¿”å› -1ï¼ˆæœªæ‰¾åˆ°ï¼‰ lFUCache.get(3); // è¿”å› 3 // cache=[3,1], cnt(3)=2, cnt(1)=2 lFUCache.put(4, 4); // å»é™¤é”® 1 ï¼Œ1 å’Œ 3 çš„ cnt ç›¸åŒï¼Œä½† 1 æœ€ä¹…æœªä½¿ç”¨ // cache=[4,3], cnt(4)=1, cnt(3)=2 lFUCache.get(1); // è¿”å› -1ï¼ˆæœªæ‰¾åˆ°ï¼‰ lFUCache.get(3); // è¿”å› 3 // cache=[3,4], cnt(4)=1, cnt(3)=3 lFUCache.get(4); // è¿”å› 4 // cache=[3,4], cnt(4)=2, cnt(3)=3\næç¤ºï¼š\n0 \u0026lt;=Â capacity, key, value \u0026lt;= 104 æœ€å¤šè°ƒç”¨ 105 æ¬¡ get å’Œ put æ–¹æ³•\nè¿›é˜¶ï¼šä½ å¯ä»¥ä¸ºè¿™ä¸¤ç§æ“ä½œè®¾è®¡æ—¶é—´å¤æ‚åº¦ä¸º O(1) çš„å®ç°å—ï¼Ÿ\næ–¹æ³•1\tåŒå“ˆå¸Œè¡¨+é“¾è¡¨ å“ˆå¸Œè¡¨1ï¼š\nkey è®°å½•ä½¿ç”¨æ¬¡æ•°\nvalue ä¸ºä¸€æ¡é“¾è¡¨\nå› ä¸ºå¯èƒ½æœ‰å¤šä¸ªé”®ä½¿ç”¨æ¬¡æ•°ç›¸åŒï¼Œæ‰€ä»¥ç”¨é“¾è¡¨å°†è¿™äº›ç›¸åŒé¢‘æ¬¡çš„é”®è¿æ¥èµ·æ¥ï¼Œæ­¤å¤–ï¼Œè¯¥é“¾è¡¨ä¹Ÿå¯ä»¥è®°å½•è¿™äº›é”®çš„ä½¿ç”¨æ—¶é—´ï¼Œé“¾è¡¨å¤´ä¸ºæœ€è¿‘ä½¿ç”¨è¿‡çš„ï¼Œé“¾è¡¨å°¾ä¸ºæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„ã€‚å½“éœ€è¦æ·˜æ±°é”®æ—¶ï¼Œç§»é™¤é“¾è¡¨å°¾å³å¯ï¼Œå½“éœ€è¦æ’å…¥æ—¶ï¼Œæ·»åŠ åˆ°é“¾è¡¨å¤´ã€‚\nå“ˆå¸Œè¡¨2ï¼š\nkey ä¸é”®ç›¸åŒï¼Œåšå¿«é€Ÿæ˜ å°„\nvalue ä¸ºé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹\næ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ª min å€¼æ¥ä¿å­˜å…¨å±€æœ€å°‘ä½¿ç”¨æ¬¡æ•°ï¼Œå½“éœ€è¦æ·˜æ±°æ—¶ä¾¿ã€‚\nå¤§ä½“æ€è·¯ ç”±é¢˜å¯çŸ¥ï¼Œå½“æ‰§è¡Œ get å’Œ put æ“ä½œæ—¶ï¼Œéƒ½ä¼šä½¿å¾—é”®çš„ä½¿ç”¨æ¬¡æ•°å¢åŠ ï¼Œè€Œä½¿ç”¨æ¬¡æ•°å¢åŠ åï¼Œå°±éœ€è¦ä»å½“å‰é“¾è¡¨ç§»åŠ¨åˆ°å…¶ä»–é“¾è¡¨ä¸­ï¼Œæ“ä½œæ€è·¯ä¸ºï¼šå…ˆè·å–åˆ°å½“å‰é”®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œé€šè¿‡ å“ˆå¸Œè¡¨1 å®šä½åˆ°æ‰€åœ¨é“¾è¡¨ï¼Œå¹¶ä»ä¸­ç§»é™¤ï¼Œå†é€šè¿‡å“ˆå¸Œè¡¨1 è·å– ä½¿ç”¨æ¬¡æ•°+1 å¤„çš„é“¾è¡¨ï¼Œå¹¶å°†é”®æ·»åŠ åˆ°é“¾è¡¨å¤´ï¼Œï¼ˆè¿™ä¸¤æ­¥éƒ½éœ€è¦æ³¨æ„æ˜ å°„çš„é“¾è¡¨æ˜¯å¦ä¸º nullï¼Œå¦åˆ™ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯ï¼‰ï¼Œæ­¤å¤–è¿˜éœ€è¦æ›´æ–°è¯¥ key çš„ä½¿ç”¨æ¬¡æ•°ã€‚\nget é¦–å…ˆä» å“ˆå¸Œè¡¨2 ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™æ‰§è¡Œä¸Šé¢çš„ç§»åŠ¨æ“ä½œï¼Œå¹¶è¿”å›å€¼ï¼Œæœªæ‰¾åˆ°åˆ™è¿”å› -1ã€‚\nput é¦–å…ˆéœ€è¦æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™åªæ›´æ–° valueï¼ŒåŒæ—¶æ‰§è¡Œç§»åŠ¨æ“ä½œï¼Œè¿”å›ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ·˜æ±°ï¼Œæ·˜æ±°å¯ä»¥é€šè¿‡å…¨å±€æœ€å°‘ä½¿ç”¨æ¬¡æ•° min ä» å“ˆå¸Œè¡¨1 ä¸­å®šä½åˆ°é“¾è¡¨ï¼Œå¹¶ç§»é™¤è¯¥é“¾è¡¨çš„å°¾å…ƒç´ ï¼ŒåŒæ—¶ä¹Ÿè¦ä» å“ˆå¸Œè¡¨2 ä¸­ç§»é™¤ã€‚å¦‚æœä¸éœ€è¦æ·˜æ±°ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°ä¸¤ä¸ªå“ˆå¸Œè¡¨å³å¯ï¼Œå› ä¸ºæ˜¯æ–°å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨æ¬¡æ•°ä¸º 1ï¼Œè¦å°† min ç½®ä¸º 1ã€‚\nè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•æ›´æ–° min çš„å€¼å‘¢ï¼Ÿå½“éœ€è¦ç§»åŠ¨æ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹ç§»åŠ¨åï¼Œè¯¥é“¾è¡¨é•¿åº¦æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸ºç©ºåˆ™æ›´æ–° minã€‚ä¾‹å¦‚ï¼š\nå“ˆå¸Œè¡¨1 æƒ…å†µå¦‚ä¸‹ï¼š\n1 -\u0026gt; [3, 3] 2 -\u0026gt; [1, 1] æ­¤æ—¶ min = 1\nå½“æ‰§è¡Œ get 3 æ“ä½œæ—¶ï¼š 2 -\u0026gt; [3, 3] -\u0026gt; [1, 1] æ­¤æ—¶åº”è¯¥æ›´æ–° min = 2\nå½“ [3, 3] ä» 1 ç§»åŠ¨åˆ° 2 åï¼Œ1 å¯¹åº”çš„é“¾è¡¨é•¿åº¦ä¸º 0ï¼Œä¸” [3, 3] çš„ä½¿ç”¨æ¬¡æ•° = min = 1ï¼Œæ‰€ä»¥éœ€è¦å°† min æ›´æ–°ä¸º 2ã€‚\nä»£ç ï¼š package lfu import \u0026quot;container/list\u0026quot; type LFUCache struct { // è®°å½•å‡ºç°æ¬¡æ•°ï¼Œkey ä¸ºæ¬¡æ•°ï¼Œvalue ä¸ºé“¾è¡¨ï¼Œ // å› ä¸ºåŒä¸€ä¸ªæ¬¡æ•°å¯èƒ½æœ‰å¤šä¸ªå€¼ï¼ŒæŒ‰ç…§è§„å®šï¼Œæ¬¡æ•°ç›¸åŒæ—¶æŒ‰ä½¿ç”¨æ—¶é—´æ¥æ¯”è¾ƒï¼Œ // æ‰€ä»¥ç”¨é“¾è¡¨æ¥è®°å½•é¡ºåºï¼Œæ–°èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨å¤´ï¼Œå½“éœ€è¦æ·˜æ±°æ—¶ï¼Œæ·˜æ±°é“¾è¡¨å°¾ cm map[int]*list.List // ä»¥é”®å€¼ key ä¸ºç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•å­˜æ”¾å¯¹åº”ç¼“å­˜åœ¨ cm ä¸­é“¾è¡¨é‡Œçš„å†…å­˜åœ°å€ m map[int]*list.Element // æœ€å¤§å®¹é‡ cap int // å…¨å±€æœ€å°‘ä½¿ç”¨æ¬¡æ•°ï¼Œå½“éœ€è¦æ‰§è¡Œæ·˜æ±°æ“ä½œæ—¶ï¼Œé€šè¿‡è¯¥å˜é‡å¯ä»¥åœ¨ O(1) å†…å®šä½åˆ° cm çš„å¯¹åº”é“¾è¡¨ min int } // node é“¾è¡¨ä¸­å­˜å‚¨çš„å€¼ type node struct { key int val int cnt int // ä½¿ç”¨æ¬¡æ•° } func Constructor(capacity int) LFUCache { return LFUCache{ cm: make(map[int]*list.List), m: make(map[int]*list.Element), cap: capacity, min: 0, } } func (c *LFUCache) Get(key int) int { if c.cap == 0 { return -1 } if e, ok := c.m[key]; ok { n := e.Value.(*node) // å°† n ä»æ—§çš„é“¾è¡¨ä¸­ç§»é™¤ï¼Œå› ä¸º get() åå…¶ä½¿ç”¨æ¬¡æ•°å¢åŠ äº† if c.cm[n.cnt] != nil { c.cm[n.cnt].Remove(e) } // å¦‚æœç§»é™¤åæ—§é“¾è¡¨ä¸ºç©ºï¼Œåˆ™æ›´æ–°å…¨å±€æœ€å°ä½¿ç”¨æ¬¡æ•° min if c.cm[n.cnt] == nil || c.cm[n.cnt].Len() == 0 { // é“¾è¡¨ä¸ºç©ºäº†ï¼Œcm ä¿å­˜ä¹Ÿå°±æ²¡æ„ä¹‰äº†ï¼Œå¯ä»¥ä» cm ä¸­åˆ é™¤ delete(c.cm, n.cnt) if c.min == n.cnt { c.min++ } } // æ›´æ–° n çš„ä½¿ç”¨æ¬¡æ•° n.cnt++ // è·å–æ–°çš„é“¾è¡¨ï¼Œå¹¶å°† n æ·»åŠ åˆ°å¤´éƒ¨ if c.cm[n.cnt] == nil { c.cm[n.cnt] = list.New() } ele := c.cm[n.cnt].PushFront(n) // æ›´æ–° m ä¸­çš„ä¿¡æ¯ c.m[key] = ele return e.Value.(*node).val } return -1 } func (c *LFUCache) Put(key int, value int) { // éœ€è¦å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå†åˆ¤æ–­å®¹é‡æ˜¯å¦æº¢å‡ºï¼Œä¾‹å¦‚ // LFU å®¹é‡ä¸º 2ï¼Œç°æœ‰å¦‚ä¸‹æ•°æ®ï¼š // 1 -\u0026gt; [1,5] -\u0026gt; [2,6] // ä½¿ç”¨ 1 æ¬¡å¯¹åº”çš„é“¾è¡¨ // æ­¤æ—¶ push [1,2]ï¼Œå¦‚æœå…ˆåˆ¤æ–­å®¹é‡æº¢å‡ºï¼Œåˆ™ä¼šè§¦å‘ç§»é™¤æ“ä½œï¼Œ // å°† [2,6] ç§»é™¤ï¼Œå¯¼è‡´ç»“æœä¸º 1 -\u0026gt; [1,2] -\u0026gt; [1,5]ï¼Œ // æ­£ç¡®ç»“æœåº”è¯¥ä¸ºï¼š // 1 -\u0026gt; [2,6] // 2 -\u0026gt; [1,2] // å¦‚æœè¯¥ key å·²ç»å­˜åœ¨ if no, ok := c.m[key]; ok { n := no.Value.(*node) if c.cm[n.cnt] != nil { c.cm[n.cnt].Remove(no) } if c.cm[n.cnt] == nil || c.cm[n.cnt].Len() == 0 { delete(c.cm, n.cnt) if c.min == n.cnt { c.min++ } } n.cnt++ // ä½¿ç”¨æ¬¡æ•° +1 n.val = value // æ›´æ–° val if c.cm[n.cnt] == nil { c.cm[n.cnt] = list.New() } ele := c.cm[n.cnt].PushFront(n) c.m[key] = ele return } // å¦‚æœæ·»åŠ è¯¥èŠ‚ç‚¹åå®¹é‡æº¢å‡ºï¼Œåˆ™éœ€è¦æ·˜æ±°ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„èŠ‚ç‚¹ if len(c.m) == c.cap { // æ ¹æ® min å­—æ®µï¼Œå–å‡ºæœ€å°ä½¿ç”¨æ¬¡æ•°å¯¹åº”çš„é“¾è¡¨ l := c.cm[c.min] if l != nil { //fmt.Println(l.Back()) // è¯¥é“¾è¡¨çš„æœ€åä¸€ä¸ªå³ä¸ºæœ€é•¿æ—¶é—´æœªä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œå°†å…¶ç§»é™¤ rm := l.Remove(l.Back()) // åŒæ—¶ä¹Ÿä» m ä¸­ç§»é™¤ delete(c.m, rm.(*node).key) } } // key ä¸å­˜åœ¨ n := \u0026amp;node{ key: key, val: value, cnt: 1, } if _, ok := c.cm[1]; !ok { c.cm[1] = list.New() } l := c.cm[1] // æ·»åŠ åˆ°è®¡æ•°é“¾è¡¨ä¸­ node := l.PushFront(n) // æ·»åŠ åˆ° m ä¸­ c.m[key] = node // æ›´æ–°å…¨å±€æœ€å°ä½¿ç”¨æ¬¡æ•° min ä¸º 1 c.min = 1 } ","date":"2021å¹´06æœˆ16æ—¥","permalink":"/posts/leetcode-460-lfu-huan-cun/","summary":"æœ€ä¸ç»å¸¸ä½¿ç”¨ï¼ˆLFUï¼‰ç¼“å­˜ç®—æ³•\nè¯·ä½ ä¸º æœ€ä¸ç»å¸¸ä½¿ç”¨ï¼ˆLFUï¼‰ç¼“å­˜ç®—æ³•è®¾è®¡å¹¶å®ç°æ•°æ®ç»“æ„ã€‚\nå®ç° LFUCache ç±»ï¼š","title":"LeetCode 460. LFU ç¼“å­˜"},{"contents":" 25 åŒ¹é©¬ï¼Œ5æ¡è·‘é“ï¼Œæ¯ä¸ªè·‘é“æœ€å¤šèƒ½æœ‰ 1 åŒ¹é©¬è¿›è¡Œæ¯”èµ›ï¼Œï¼ˆå°±æ˜¯è¯´æœ€å¤šåŒæ—¶å¯ä»¥æœ‰ 5 åŒ¹é©¬ä¸€èµ·æ¯”èµ›ï¼‰ï¼Œ ä¸èƒ½ä½¿ç”¨è®¡æ—¶å™¨ï¼Œä¸”æ¯åŒ¹é©¬çš„é€Ÿåº¦éƒ½å¾ˆç¨³å®šï¼ˆæ„æ€æ˜¯åœ¨ä¸Šä¸€åœºæ¯”èµ›ä¸­ A é©¬æ¯” B é©¬å¿«ï¼Œåˆ™ä¸‹ä¸€åœºæ¯”èµ›ä¸­Aé©¬ ä¾ç„¶æ¯” B é©¬å¿«ï¼‰ï¼Œé—®æœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3åå’Œå‰5åï¼Ÿ\nå‰ 3 å é¦–å…ˆå°† 25 åŒ¹é©¬åˆ†æˆ 5 ç»„ï¼Œæ¯ç»„ 5 åŒ¹é©¬ã€‚\n1 - 5 æ¬¡ æ¯ç»„åˆ†åˆ«è¿›è¡Œæ¯”èµ›ï¼Œé€‰å‡ºæ¯ç»„çš„ç¬¬ä¸€åï¼Œå‡è®¾æ€»ä½“æ¯”èµ›æƒ…å†µä¸ºï¼š\nAç»„ï¼š [A1 A2 A3 A4 A5] Bç»„ï¼š [B1 B2 B3 B4 B5] Cç»„ï¼š [C1 C2 C3 C4 C5] Dç»„ï¼š [D1 D2 D3 D4 D5] Eç»„ï¼š [E1 E2 E3 E4 E5] æ¯ç»„ç¬¬ä¸€åä¸º [A1, B1, C1, D1, E1]\nç¬¬ 6 æ¬¡ å†å¯¹è¿™ 5 ä¸ªç¬¬ä¸€åè¿›è¡Œæ¯”èµ›ï¼Œè¿™é‡Œé¢çš„ç¬¬ä¸€åä¾¿æ˜¯æ‰€æœ‰é©¬ä¸­æœ€å¿«çš„ï¼Œè¿™é‡Œå‡è®¾ç»“æœä¸º [A1, B1, C1, D1, E1]ï¼Œç¬¬ä¸€åä¸º A1ã€‚\næ­¤æ—¶ç¬¬ä¸€åå·²ç»ç¡®å®šäº†ï¼Œè¿˜å‰©ä¸‹äºŒä¸‰åéœ€è¦ç¡®å®šã€‚\nç¬¬ 7 æ¬¡ ç¬¬äºŒåå¯èƒ½æ˜¯ç´§éš A1 å…¶åçš„ A2ï¼ŒåŒæ—¶ä¹Ÿå¯èƒ½æ˜¯ B ç»„çš„ç¬¬ä¸€å B1ï¼Œå› ä¸ºä¸èƒ½ä½¿ç”¨è®¡æ—¶å™¨ï¼Œæ‰€ä»¥æ— æ³•ç¡®å®šåˆ°åº•æ˜¯å“ªä¸ªï¼Œè§£å†³åŠæ³•å°±æ˜¯è®© A2 å’Œ B1 è¿›è¡Œä¸€æ¬¡æ¯”èµ›ï¼Œå†³å‡ºç¬¬äºŒåï¼Œä½†æ˜¯è·‘é“ä¸€å…±æœ‰ 5 æ¡ï¼Œç°åœ¨å´åªæœ‰ä¸¤åŒ¹é©¬å‚èµ›ï¼Œç©ºå‡ºæ¥çš„ 3 æ¡è·‘é“å²‚ä¸æ˜¯ç™½ç™½æµªè´¹äº†ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨èµ·æ¥ï¼Œå†³å‡ºç¬¬ä¸‰åã€‚\nå¯èƒ½å‡ºç°çš„æƒ…å†µï¼š\nç¬¬äºŒåä¸º A2 é‚£ä¹ˆç¬¬ä¸‰åå°†ä» A2 ä¹‹åçš„ A3ï¼Œä»¥åŠ B ç»„çš„ç¬¬ä¸€ B1 äºŒè€…ä¸­ç¡®å®šã€‚ ç¬¬äºŒåä¸º B1 ç¬¬ä¸‰åå°†ä» A2ï¼ŒB2ï¼Œä»¥åŠ C ç»„çš„å¤´æ¦œ C1 ä¸­ç¡®å®šã€‚ ç¬¬äºŒä¸‰åçš„å…¨éƒ¨æƒ…å†µï¼š\n[A2, A3] [A2, B1] [B1, B2] [B1, A2] [B1, C1]\næ‰€ä»¥ç”¨ä¸Šé¢çš„ 5 åŒ¹é©¬ [A2, A3, B1, B2, C1] è¿›è¡Œä¸€æ¬¡æ¯”èµ›å³å¯ç¡®å®šç¬¬2ï¼Œ3åï¼Œå…¶ä¸­çš„ç¬¬1ï¼Œ2ååˆ™ä¸ºå…¨éƒ¨é©¬åŒ¹ä¸­çš„ç¬¬2ï¼Œ3åã€‚\nç»¼ä¸Šï¼Œæœ€å°‘éœ€è¦ 7 æ¬¡å³å¯ç¡®å®šé©¬åŒ¹ä¸­çš„å‰ 3 åã€‚\nå‰ 5 å 1-7 æ¬¡ å’Œ å‰ 3 å ä¸€æ ·ï¼Œé€šè¿‡è¿™ 7 æ¬¡å¯ä»¥ç¡®å®šå‡ºæ‰€æœ‰é©¬åŒ¹ä¸­çš„ 1ï¼Œ2ï¼Œ3åã€‚å…¨éƒ¨æƒ…å†µä¸ºï¼š [A1, A2, A3] [A1, A2, B1] [A1, B1, B2] [A1, B1, A2] [A1, B1, C1]\nç¬¬ 8 æ¬¡ ç¬¬ 8 æ¬¡éœ€è¦æ ¹æ®ç¬¬7åœºçš„æ‰€æœ‰å¯èƒ½çš„æ¯”èµ›æƒ…å†µè¿›è¡Œåˆ†æã€‚\nç¬¬äºŒå = A2ï¼Œç¬¬ä¸‰å = A3ï¼Œé‚£ä¹ˆç¬¬å››åä¸º A4 æˆ–è€… B1ã€‚\nå¦‚æœç¬¬å››åä¸º A4ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º A5 æˆ–è€… B1ã€‚ å¦‚æœç¬¬å››åä¸º B1ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º A4ã€B2 æˆ–è€… C1ã€‚ æ‰€ä»¥ç”¨ [A4, B1, A5, B2, C1] å³å¯ç¡®å®šå‡ºç¬¬ 4ï¼Œ5åï¼Œä¸€å…±éœ€è¦ 8 æ¬¡ã€‚\nç¬¬äºŒå = A2ï¼Œç¬¬ä¸‰å = B1ï¼Œé‚£ä¹ˆç¬¬å››åä¸º A3 æˆ–è€… B2 æˆ–è€… C1ã€‚\nå¦‚æœç¬¬å››åä¸º A3ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º A4 æˆ–è€… B2ã€‚ å¦‚æœç¬¬å››åä¸º B2ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º B3 æˆ–è€… A3ã€‚ å¦‚æœç¬¬å››åä¸º C1ï¼Œé‚£ä¹ˆç¬¬äº”åä» A3, B2, C2, D1 ä¸­äº§ç”Ÿã€‚ ç»¼ä¸Šï¼Œç”¨ [A3, B2, B3, C1, A4, C2, D1] ä¸ƒåŒ¹é©¬æ‰å¯ä»¥ç¡®å®š4ï¼Œ 5åï¼Œè€Œä¸€æ¬¡æ¯”èµ›æœ€å¤šåªèƒ½æœ‰ 5 åŒ¹é©¬ï¼Œæ‰€ä»¥éœ€è¦æ¯”èµ› 2 æ¬¡ï¼Œä¸€å…±éœ€è¦ 9 æ¬¡ã€‚\nç¬¬äºŒå = B1ï¼Œç¬¬ä¸‰å = B2ï¼Œé‚£ä¹ˆç¬¬å››åä¸º B3ã€A2 æˆ–è€… C1ã€‚\nå¦‚æœç¬¬å››åä¸º B3ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º B4ã€A2ã€C1ã€‚ å¦‚æœç¬¬å››åä¸º A2ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º A3ã€B3ï¼ŒC1ã€‚ å¦‚æœç¬¬å››åä¸º C1ï¼Œé‚£ä¹ˆç¬¬äº”åä¸º A2ã€B3ã€C2ã€D1ã€‚ ç»¼ä¸Šï¼Œç”¨ [A2, B3, B4, C1, A3, C2, D1] ä¸ƒåŒ¹é©¬æ‰å¯ä»¥ç¡®å®š4ï¼Œ 5åï¼Œè€Œä¸€æ¬¡æ¯”èµ›æœ€å¤šåªèƒ½æœ‰ 5 åŒ¹é©¬ï¼Œæ‰€ä»¥éœ€è¦æ¯”èµ› 2 æ¬¡ï¼Œä¸€å…±éœ€è¦ 9 æ¬¡ã€‚\nç¬¬2å=B1ï¼Œç¬¬3å=A2ï¼Œå’Œæƒ…å†µ 2 ä¸€æ ·ã€‚\nç¬¬2å=B1ï¼Œç¬¬3å=C1ã€‚é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A2ã€B2ã€C2ã€D1ä¸­äº§ç”Ÿã€‚\nå¦‚æœç¬¬4å=A2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A3ã€B2ã€C2ã€D1ä¸­äº§ç”Ÿã€‚\nå¦‚æœç¬¬4å=B2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B3ã€C2ã€D1ä¸­äº§ç”Ÿã€‚\nå¦‚æœç¬¬4å=C2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B2ã€C3ã€D1ä¸­äº§ç”Ÿã€‚\nå¦‚æœç¬¬4å=D1ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B2ã€C2ã€D2ã€E2ä¸­äº§ç”Ÿã€‚\né‚£ä¹ˆï¼Œç¬¬4ã€5åéœ€è¦åœ¨é©¬åŒ¹[A2ã€B2ã€C2ã€D1ã€A3ã€B3ã€C3ã€D2ã€E1]ä¹åŒ¹é©¬ä¸­äº§ç”Ÿï¼Œå› æ­¤ä¹Ÿå¿…é¡»æ¯”èµ›ä¸¤åœºï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬ 9 åœºå†³å‡ºèƒœè´Ÿã€‚\nç»¼ä¸Šï¼Œç¡®å®šå‰ 5 åæœ€å°‘éœ€è¦ 8 æˆ– 9 æ¬¡ã€‚\nå‚è€ƒï¼šhttps://www.iteye.com/blog/hxraid-662643ï¼Œè¿™ç¯‡åšæ–‡è®²è§£çš„éå¸¸æ£’ï¼Œæˆ‘è¿™é‡Œåªæ˜¯å°†å…¶ç”¨è‡ªå·±çš„è¯å†å™è¿°äº†ä¸€éï¼Œä»¥åŠ æ·±ç†è§£ã€‚\n","date":"2021å¹´06æœˆ15æ—¥","permalink":"/posts/25-pi-ma-de-jiao-zhu/","summary":"25 åŒ¹é©¬ï¼Œ5æ¡è·‘é“ï¼Œæ¯ä¸ªè·‘é“æœ€å¤šèƒ½æœ‰ 1 åŒ¹é©¬è¿›è¡Œæ¯”èµ›ï¼Œï¼ˆå°±æ˜¯è¯´æœ€å¤šåŒæ—¶å¯ä»¥æœ‰ 5 åŒ¹é©¬ä¸€èµ·æ¯”èµ›ï¼‰ï¼Œ ä¸èƒ½ä½¿ç”¨è®¡æ—¶å™¨ï¼Œä¸”æ¯åŒ¹é©¬çš„é€Ÿåº¦éƒ½å¾ˆç¨³å®šï¼ˆæ„æ€æ˜¯åœ¨ä¸Šä¸€åœºæ¯”èµ›ä¸­ A é©¬æ¯” B é©¬å¿«ï¼Œåˆ™ä¸‹ä¸€åœºæ¯”èµ›ä¸­Aé©¬ ä¾ç„¶æ¯” B é©¬å¿«ï¼‰ï¼Œé—®æœ€å°‘æ¯”å¤šå°‘æ¬¡èƒ½æ¯”å‡ºå‰3åå’Œå‰5åï¼Ÿ","title":"25åŒ¹é©¬çš„è§’é€"},{"contents":" ä½œè€…ï¼šluozhiyun åšå®¢ï¼šhttps://www.luozhiyun.com/archives/475 æœ¬æ–‡ä½¿ç”¨çš„ Go çš„æºç 1.15.7\nåŸæ–‡åœ°å€ï¼šhttps://www.luozhiyun.com/archives/475\n1. ä¸‰è‰²æ ‡è®°æ³• 1.1 ä¸‰ç§é¢œè‰² é»‘è‰²ï¼šè¯¥å¯¹è±¡å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä¸”è¯¥å¯¹è±¡ä¸‹çš„å±æ€§ã€è¿™é‡Œä¸æ˜¯å¾ˆæ˜ç™½ï¼Œæ˜¯æŒ‡è¯¥å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ï¼Ÿï¼Ÿã€‘ä¹Ÿå…¨éƒ¨éƒ½è¢«æ ‡è®°è¿‡äº†ï¼ˆç¨‹åºæ‰€éœ€è¦çš„å¯¹è±¡ï¼‰\nè¯´æ˜ï¼šä»…æ˜¯è¯¥å¯¹è±¡ä¸‹çš„å±æ€§ï¼Œå…¶ä¹‹ä¸‹çš„å±æ€§çš„ä¸‹é¢çš„å±æ€§ä¸è€ƒè™‘åœ¨å†…ã€‚\nä¾‹å¦‚ï¼šA -\u0026gt; B -\u0026gt; Cï¼Œå½“ A å·²è¢«æ ‡è®°ï¼Œä¸” B ä¹Ÿè¢«æ ‡è®°æ—¶ï¼ŒA å°±ä¼šå˜æˆé»‘è‰²ï¼Œä¸éœ€è€ƒè™‘ C æ˜¯å¦è¢«æ ‡è®°ï¼ŒC æ˜¯å¦è¢«æ ‡è®°å½±å“çš„æ˜¯ B èƒ½å¦å˜æˆé»‘è‰²ï¼Œä¸ A æ— å…³ã€‚\nç°è‰²ï¼šè¯¥å¯¹è±¡å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä½†è¯¥å¯¹è±¡ä¸‹çš„å±æ€§æ²¡æœ‰å…¨è¢«æ ‡è®°å®Œï¼ˆGCéœ€è¦ä»æ­¤å¯¹è±¡ä¸­å»å¯»æ‰¾åƒåœ¾ï¼‰ï¼›\nç™½è‰²ï¼šè¯¥å¯¹è±¡æ²¡æœ‰è¢«æ ‡è®°è¿‡ï¼ˆå¯¹è±¡åƒåœ¾ï¼‰ï¼›\nåœ¨åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œæ—¶ï¼Œä» GC Roots å¼€å§‹è¿›è¡Œéå†è®¿é—®ï¼Œè®¿é—®æ­¥éª¤å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ æ­¥ï¼š\nGC Roots æ ¹å¯¹è±¡ä¼šè¢«æ ‡è®°æˆç°è‰²ï¼› ç„¶åä»ç°è‰²é›†åˆä¸­è·å–å¯¹è±¡ï¼Œå°†å…¶æ ‡è®°ä¸ºé»‘è‰²ï¼Œå°†è¯¥å¯¹è±¡å¼•ç”¨åˆ°çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼›ã€åªä¼šæ ‡è®°ä¸€æ¬¡ï¼Œä¸ä¼šé€’å½’æ ‡è®°ï¼Œå³ä¸ä¼šæ ‡è®°å¼•ç”¨å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ã€‘ é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°æ²¡æœ‰ç°è‰²é›†åˆå¯ä»¥æ ‡è®°ä¸ºæ­¢ï¼› ç»“æŸåï¼Œå‰©ä¸‹çš„æ²¡æœ‰è¢«æ ‡è®°çš„ç™½è‰²å¯¹è±¡å³ä¸º GC Roots ä¸å¯è¾¾ï¼Œå¯ä»¥è¿›è¡Œå›æ”¶ã€‚ 1.2 ä¸‰è‰²æ ‡è®°å­˜åœ¨çš„é—®é¢˜ å¤šæ ‡-æµ®åŠ¨åƒåœ¾é—®é¢˜ æ–‡ç« ä¸­å·²ç»è¯´çš„æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œæ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸€ä¸ªå¼•ç”¨å¯¹è±¡è¢«é”™è¯¯çš„æ ‡è®°ä¸ºç°è‰²ï¼Œä¼šå¯¼è‡´ç»§ç»­éå†æ‰«æï¼Œå¯¼è‡´è¯¥å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡éƒ½ä¼šè¢«é”™è¯¯æ ‡è®°ï¼Œæœ€ç»ˆå¯¼è‡´çš„å¯èƒ½ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œæ˜¯ä¸€æ‰¹å¯¹è±¡æœªè¢«æ­£ç¡®å›æ”¶ã€‚\næ¼æ ‡-æ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ æ–‡ç« ä¸­ä¹Ÿæ¯”è¾ƒæ¸…æ¥šçš„è¯´æ˜äº†ã€‚\nç–‘é—®ï¼š\nä¸Šé¢ä¸¤ä¸ªé—®é¢˜äº§ç”Ÿçš„åŸå› åœ¨äºï¼šåœ¨åƒåœ¾å›æ”¶ä¸­é€”ï¼Œç¨‹åºåˆæ”¹å˜äº†å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ã€‚ä¸ºä»€ä¹ˆå…è®¸ç¨‹åºå’Œåƒåœ¾å›æ”¶åŒæ—¶æ‰§è¡Œï¼Ÿ\n","date":"2021å¹´06æœˆ04æ—¥","permalink":"/posts/liang-wan-zi-chang-wen-dai-ni-shen-ru-go-yu-yan-gc-yuan-ma-teng-xun-ji-zhu-gong-cheng-yue-du-bi-ji/","summary":"ä½œè€…ï¼šluozhiyun åšå®¢ï¼šhttps://www.luozhiyun.com/archives/475 æœ¬æ–‡ä½¿ç”¨çš„ Go çš„æºç 1.","title":"ã€ä¸¤ä¸‡å­—é•¿æ–‡å¸¦ä½ æ·±å…¥Goè¯­è¨€GCæºç â€”â€”è…¾è®¯æŠ€æœ¯å·¥ç¨‹ã€‘é˜…è¯»ç¬”è®°"},{"contents":" ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„Â nums ï¼Œæ•°ç»„ä¸­çš„å…ƒç´  äº’ä¸ç›¸åŒ ã€‚è¿”å›è¯¥æ•°ç»„æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆå¹‚é›†ï¼‰ã€‚\nè§£é›†ä¸èƒ½åŒ…å«é‡å¤çš„å­é›†ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›è§£é›†ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šnums = [1,2,3] è¾“å‡ºï¼š[[],[1],[2],[1,2],[3],[1,3],[2,3],[1,2,3]]\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šnums = [0] è¾“å‡ºï¼š[[],[0]]\næç¤ºï¼š\n1 \u0026lt;= nums.length \u0026lt;= 10 -10 \u0026lt;= nums[i] \u0026lt;= 10 nums ä¸­çš„æ‰€æœ‰å…ƒç´  äº’ä¸ç›¸åŒ\næ–¹æ³•1 å›æº¯ ä»£ç ï¼š\nclass Solution { public: vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; subsets(vector\u0026lt;int\u0026gt;\u0026amp; nums) { vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; res; vector\u0026lt;int\u0026gt; temp; backtrack(nums, res, temp, 0); return res; } void backtrack(vector\u0026lt;int\u0026gt; \u0026amp;nums, vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; \u0026amp;res, vector\u0026lt;int\u0026gt; \u0026amp;temp, int start) { res.emplace_back(temp); for (int i = start; i \u0026lt; nums.size(); i++) { temp.emplace_back(nums[i]); // i+1 ok // start+1 !ok backtrack(nums, res, temp, i+1); temp.pop_back(); } } }; ","date":"2021å¹´06æœˆ03æ—¥","permalink":"/posts/leetcode-78-zi-ji/","summary":"ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„Â nums ï¼Œæ•°ç»„ä¸­çš„å…ƒç´  äº’ä¸ç›¸åŒ ã€‚è¿”å›è¯¥æ•°ç»„æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆå¹‚é›†ï¼‰ã€‚","title":"leetcode 78. å­é›†"},{"contents":"1. å­—èŠ‚åº å­—èŠ‚åºï¼šå†…å­˜ä¸­å­˜å‚¨å¤šä¸ªå­—èŠ‚çš„æ–¹å¼ã€‚\nä¾‹å¦‚ä¸€ä¸ª 16 è¿›åˆ¶æ•°ï¼Œå®ƒç”±ä¸¤ä¸ªå­—èŠ‚ç»„æˆï¼Œå†…å­˜ä¸­å­˜å‚¨è¿™ä¸¤ä¸ªå­—èŠ‚æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºå¤§ç«¯å­—èŠ‚åºå’Œå°ç«¯ å­—èŠ‚åºã€‚\nå¤§ç«¯ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åœ¨ä½åœ°å€ï¼Œä½ä½å­—èŠ‚å­˜æ”¾åœ¨é«˜åœ°å€ã€‚\nå°ç«¯ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åœ¨é«˜åœ°å€ï¼Œä½ä½å­—èŠ‚å­˜æ”¾åœ¨ä½åœ°å€ã€‚\nå¦‚ä½•åŒºåˆ†å­—èŠ‚çš„é«˜ä½ä½å’Œåœ°å€çš„é«˜ä½ä½ï¼Ÿ\n0x12 0x34 é«˜ä½å­—èŠ‚ ä½ä½å­—èŠ‚ â† å­—èŠ‚å¢é•¿æ–¹å‘ ä½åœ°å€ é«˜åœ°å€ â†’ å†…å­˜å¢é•¿æ–¹å‘\n1.1 ç½‘ç»œå­—èŠ‚åºå’Œä¸»æœºå­—èŠ‚åº ä¸»æœºå­—èŠ‚åºï¼šæŸä¸ªç»™å®šç³»ç»Ÿæ‰€ç”¨çš„å­—èŠ‚åºç§°ä¸ºä¸»æœºå­—èŠ‚åºã€‚ä¸åŒçš„æ“ä½œç³»ç»Ÿé‡‡ç”¨çš„å­—èŠ‚åºä¸åŒï¼Œæ¯”å¦‚ macos é‡‡ç”¨çš„æ˜¯å¤§ç«¯ï¼Œè€Œ linux é‡‡ç”¨çš„æ˜¯å°ç«¯ã€‚\nç½‘ç»œå­—èŠ‚åºï¼šä¸ºäº†åœ¨ä¿¡æ¯ä¼ è¾“æ—¶ï¼Œå±è”½æ‰ä¸åŒç¡¬ä»¶ç»“æ„ä¸Šçš„å­—èŠ‚åºçš„å·®å¼‚ï¼ŒTCP/IPåè®®è§„å®šï¼Œæ‰€æœ‰åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å¤šå­—èŠ‚æ•´æ•°éƒ½ä»¥å¤§ç«¯åºç¼–ç ï¼Œæ‰€ä»¥å¤§ç«¯åºå°±æ˜¯ç½‘ç»œå­—èŠ‚åºã€‚\nå­—èŠ‚åºè½¬æ¢çš„å‡½æ•°ï¼š\n#include \u0026lt;netinet/in.h\u0026gt; // ä¸»æœºå­—èŠ‚åºè½¬ç½‘ç»œå­—èŠ‚åºï¼Œä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«åœ¨äºé•¿åº¦ä¸åŒ // è¾ƒçŸ­çš„å‡½æ•°å¯ä»¥ç”¨æ¥è½¬æ¢ç«¯å£å·ï¼Œè¾ƒé•¿çš„å¯ä»¥è½¬æ¢ ip åœ°å€ uint16_t htons(uint16_t host16bitvalue); uint32_t htonl(uint32_t host32bitvalue); // ç½‘ç»œå­—èŠ‚åºè½¬ä¸»æœºå­—èŠ‚åº uint16_t ntonhs(uint16_t net16bitvalue); uint32_t ntonhs(uint32_t net32bitvalue); 2. socket api 2.1 åˆ›å»º socket #include \u0026lt;sys/socket.h\u0026gt; int socket(int family, int type, int protocol); // è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºéè´Ÿæè¿°ç¬¦ï¼Œå‡ºé”™åˆ™ä¸º -1 å‚æ•°æè¿°ï¼š\nfamily ç”¨æ¥é€‰æ‹©é€šä¿¡åè®®ï¼Œå‚æ•°ä¸»è¦æœ‰ä»¥ä¸‹ä¸€äº›å¸¸ç”¨ç±»å‹\nAF_UNIX, AF_LOCALï¼šç”¨äºæœ¬åœ°é€šä¿¡ï¼ŒUnix Domain Socket\nAF_INETï¼šç”¨äº IP4\nAF_INET6ï¼šç”¨äº IP6\ntype æŒ‡æ˜å¥—æ¥å­—ç±»å‹\nSOCK_STREAM å­—èŠ‚æµå¥—æ¥å­—ï¼Œå³ tcp\nSOCK_DGRAM æ•°æ®åŒ…å¥—æ¥å­—ï¼Œå³ udp\nSOCK_NONBLOCK å°† socket è®¾ç½®ä¸ºéé˜»å¡ SOCK_CLOEXEC fork å­è¿›ç¨‹ä¸­å…³é—­è¯¥ socket protocol åœ¨å‰ä¸¤ä¸ªå‚æ•°æ„æˆçš„åè®®é›†åˆä¸‹ï¼Œå†é€‰æ‹©ä¸€ä¸ªå…·ä½“çš„åè®®ï¼Œé€šå¸¸è®¾ç½®ä¸º 0 å³å¯ï¼ˆä»£è¡¨é»˜è®¤åè®®ï¼‰\n2.2 å‘½å socket socket å‘½åï¼šå°†ä¸€ä¸ª socket å’Œ socket åœ°å€ç»‘å®šã€‚\n#include \u0026lt;sys/socket.h\u0026gt; int bind(int sockfd, const struct *myaddr, socklen_t addrlen); // æˆåŠŸè¿”å› 0ï¼Œå‡ºé”™è¿”å› -1 ä½¿ç”¨ï¼š\nstruct sockaddr_in servaddr; bzero(\u0026amp;servaddr, sizeof(servaddr));\t// åˆå§‹åŒ–ç»“æ„ä½“ servaddr.sin_family = AF_INEF; // ip4 servaddr.sin_addr.s_addr = htonl(INADDR_ANY); // æŒ‡å®š ipï¼Œå¹¶è½¬æ¢ä¸ºç½‘ç»œåº servaddr.port = htons(13);\t// æŒ‡å®šç«¯å£å·ï¼Œå¹¶è½¬æ¢ä¸ºç½‘ç»œåº // ç¬¬äºŒä¸ªå‚æ•°éœ€è¦å¼ºè½¬æˆ struct sockaddrï¼Œsockaddr æ˜¯ä¸€ä¸ªé€šç”¨çš„å¥—æ¥å­—åœ°å€ç»“æ„ bind(\u0026amp;servaddr, (struct sockaddr*) \u0026amp;servaddr, sizeof(servaddr)); 2.3 ç›‘å¬ socket #include \u0026lt;sys/socket.h\u0026gt; int listen(int sockfd, int backlog); // æˆåŠŸè¿”å› 0ï¼Œå‡ºé”™è¿”å› -1 ","date":"2021å¹´05æœˆ29æ—¥","permalink":"/posts/linux-gao-xing-neng-fu-wu-qi-bian-cheng-yue-du-bi-ji-di-wu-zhang-linux-wang-luo-bian-cheng-ji-chu-api/","summary":"1. å­—èŠ‚åº å­—èŠ‚åºï¼šå†…å­˜ä¸­å­˜å‚¨å¤šä¸ªå­—èŠ‚çš„æ–¹å¼ã€‚\nä¾‹å¦‚ä¸€ä¸ª 16 è¿›åˆ¶æ•°ï¼Œå®ƒç”±ä¸¤ä¸ªå­—èŠ‚ç»„æˆï¼Œå†…å­˜ä¸­å­˜å‚¨è¿™ä¸¤ä¸ªå­—èŠ‚æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºå¤§ç«¯å­—èŠ‚åºå’Œå°ç«¯ å­—èŠ‚åºã€‚","title":"ã€Linux é«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‘é˜…è¯»ç¬”è®° ç¬¬äº”ç«  -- Linux ç½‘ç»œç¼–ç¨‹åŸºç¡€ api"},{"contents":" ç»™å®šä¸€ä¸ªäºŒå‰æœç´¢æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚\nç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œ æ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€\nä¾‹å¦‚ï¼Œç»™å®šå¦‚ä¸‹äºŒå‰æœç´¢æ ‘:Â root =Â [6,2,8,0,4,7,9,null,null,3,5]\nç¤ºä¾‹ 1:\nè¾“å…¥: root = [6,2,8,0,4,7,9,null,null,3,5], p = 2, q = 8 è¾“å‡º: 6 è§£é‡Š: èŠ‚ç‚¹ 2 å’ŒèŠ‚ç‚¹ 8 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯ 6ã€‚\nç¤ºä¾‹ 2:\nè¾“å…¥: root = [6,2,8,0,4,7,9,null,null,3,5], p = 2, q = 4 è¾“å‡º: 2 è§£é‡Š: èŠ‚ç‚¹ 2 å’ŒèŠ‚ç‚¹ 4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯ 2, å› ä¸ºæ ¹æ®å®šä¹‰æœ€è¿‘å…¬å…±ç¥–å…ˆèŠ‚ç‚¹å¯ä»¥ä¸ºèŠ‚ç‚¹æœ¬èº«ã€‚ \u0026gt;\nè¯´æ˜:\næ‰€æœ‰èŠ‚ç‚¹çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ã€‚ pã€q ä¸ºä¸åŒèŠ‚ç‚¹ä¸”å‡å­˜åœ¨äºç»™å®šçš„äºŒå‰æœç´¢æ ‘ä¸­ã€‚\nåˆ†æ æ–¹æ³•ç±»ä¼¼äº äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œä½†æ˜¯å› ä¸ºæ˜¯äºŒå‰æœç´¢æ ‘ï¼Œæ‰€ä»¥éš¾åº¦ä¼šé™ä½å¾ˆå¤šï¼Œåªè¦åˆ©ç”¨æœç´¢æ ‘çš„æ€§è´¨å³å¯ã€‚\næ–¹æ³• 1 æ‰¾åˆ° p å’Œ q çš„è·¯å¾„ åˆ†åˆ«æ‰¾å‡ºæ ¹èŠ‚ç‚¹åˆ° p çš„è·¯å¾„å’Œæ ¹èŠ‚ç‚¹åˆ° q çš„è·¯å¾„ï¼Œå†æ±‚ä¸¤æ¡è·¯å¾„ä¸­çš„æœ€åä¸€ä¸ªç›¸åŒçš„èŠ‚ç‚¹å³å¯ï¼Œåœ¨æ™®é€šäºŒå‰æ ‘ä¸­å¯»æ‰¾è·¯å¾„éœ€è¦é€šè¿‡å…¨æ’åˆ—çš„æ–¹å¼ï¼Œä½†æ˜¯åœ¨æœç´¢æ ‘ä¸­å°±éå¸¸ç®€å•äº†ï¼Œåˆ©ç”¨å¥½æœç´¢æ ‘çš„æ€§è´¨å³å¯ã€‚\nä»£ç å¦‚ä¸‹ï¼ˆè¿™é“é¢˜ä¸æ”¯æŒ goï¼Œæ‰€ä»¥ç”¨ c++ å®ç°ï¼‰ï¼š\n/** * Definition for a binary tree node. * struct TreeNode { * int val; * TreeNode *left; * TreeNode *right; * TreeNode(int x) : val(x), left(NULL), right(NULL) {} * }; */ #define print(name) for (auto v : name) {cout \u0026lt;\u0026lt; v-\u0026gt;val \u0026lt;\u0026lt; \u0026quot; \u0026quot;;}; cout \u0026lt;\u0026lt; endl; class Solution { public: TreeNode* lowestCommonAncestor(TreeNode* root, TreeNode* p, TreeNode* q) { vector\u0026lt;TreeNode*\u0026gt; pv, qv; get_path(pv, root, p); get_path(qv, root, q); //print(pv); //print(qv); TreeNode *res = find_last_same(pv, qv); return res; } void get_path(vector\u0026lt;TreeNode*\u0026gt; \u0026amp;vec, TreeNode* root, TreeNode* need) { if (root == NULL) { return; } TreeNode *cur = root; for (;;) { //cout \u0026lt;\u0026lt; cur-\u0026gt;val \u0026lt;\u0026lt; p-\u0026gt;val \u0026lt;\u0026lt; endl; if (need-\u0026gt;val \u0026gt; cur-\u0026gt;val) { vec.emplace_back(cur); cur = cur-\u0026gt;right; } else if (need-\u0026gt;val \u0026lt; cur-\u0026gt;val) { vec.emplace_back(cur); cur = cur-\u0026gt;left; } else { vec.emplace_back(cur); break; } } } TreeNode* find_last_same(vector\u0026lt;TreeNode*\u0026gt; \u0026amp;v1, vector\u0026lt;TreeNode*\u0026gt; \u0026amp;v2) { int m = min(v1.size(), v2.size()); TreeNode* res; for (int i = 0; i \u0026lt; m; i++) { if (v1.at(i)-\u0026gt;val == v2.at(i)-\u0026gt;val) { res = v1.at(i); } } return res; } }; è¿™ç§æ–¹æ³•è™½ç„¶å¯ä»¥é€šè¿‡ï¼Œä½†æ˜¯è¾ƒä¸ºç¹çï¼Œè¿˜æœ‰æ›´ç®€æ´çš„å†™æ³•ã€‚\næ–¹æ³• 2 è¿­ä»£ /** * Definition for a binary tree node. * struct TreeNode { * int val; * TreeNode *left; * TreeNode *right; * TreeNode(int x) : val(x), left(NULL), right(NULL) {} * }; */ class Solution { public: TreeNode* lowestCommonAncestor(TreeNode* root, TreeNode* p, TreeNode* q) { for (;;) { if (p-\u0026gt;val \u0026gt; root-\u0026gt;val \u0026amp;\u0026amp; q-\u0026gt;val \u0026gt; root-\u0026gt;val) { root = root-\u0026gt;right; } else if (p-\u0026gt;val \u0026lt; root-\u0026gt;val \u0026amp;\u0026amp; q-\u0026gt;val \u0026lt; root-\u0026gt;val) { root = root-\u0026gt;left; } else { break; } } return root; } }; è¿™ç§æ–¹æ³•å°±å’Œ äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ ç±»ä¼¼äº†ï¼Œé€šè¿‡åˆ¤æ–­ p å’Œ q åœ¨åŒä¾§è¿˜æ˜¯å¼‚ä¾§ï¼Œæ¥å†³å®šçˆ¶èŠ‚ç‚¹çš„å€¼ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« \næ–¹æ³•3 é€’å½’ æ–¹æ³•å’Œè¿­ä»£ä¸€æ ·ï¼Œåªæ˜¯æ¢æˆäº†é€’å½’çš„æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š\n/** * Definition for a binary tree node. * struct TreeNode { * int val; * TreeNode *left; * TreeNode *right; * TreeNode(int x) : val(x), left(NULL), right(NULL) {} * }; */ class Solution { public: TreeNode* lowestCommonAncestor(TreeNode* root, TreeNode* p, TreeNode* q) { if (p-\u0026gt;val \u0026gt; root-\u0026gt;val \u0026amp;\u0026amp; q-\u0026gt;val \u0026gt; root-\u0026gt;val) { return lowestCommonAncestor(root-\u0026gt;right, p, q); } else if (p-\u0026gt;val \u0026lt; root-\u0026gt;val \u0026amp;\u0026amp; q-\u0026gt;val \u0026lt; root-\u0026gt;val) { return lowestCommonAncestor(root-\u0026gt;left, p, q); } else { return root; } return NULL; } }; ","date":"2021å¹´05æœˆ09æ—¥","permalink":"/posts/jian-zhi-offer-68-i-er-cha-sou-suo-shu-de-zui-jin-gong-gong-zu-xian/","summary":"ç»™å®šä¸€ä¸ªäºŒå‰æœç´¢æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚\nç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œ æ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€","title":"å‰‘æŒ‡ Offer 68 - I. äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"},{"contents":" è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•° target ï¼Œè¾“å‡ºæ‰€æœ‰å’Œä¸º target çš„è¿ç»­æ­£æ•´æ•°åºåˆ—ï¼ˆè‡³å°‘å«æœ‰ä¸¤ä¸ªæ•°ï¼‰ã€‚\nåºåˆ—å†…çš„æ•°å­—ç”±å°åˆ°å¤§æ’åˆ—ï¼Œä¸åŒåºåˆ—æŒ‰ç…§é¦–ä¸ªæ•°å­—ä»å°åˆ°å¤§æ’åˆ—ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼štarget = 9 è¾“å‡ºï¼š[[2,3,4],[4,5]]\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼štarget = 15 è¾“å‡ºï¼š[[1,2,3,4,5],[4,5,6],[7,8]]\né™åˆ¶ï¼š\n1 \u0026lt;= target \u0026lt;= 10^5\næ–¹æ³• 1 æ»‘åŠ¨çª—å£ é€šè¿‡åŒæŒ‡é’ˆç»´æŠ¤ä¸€ä¸ªçª—å£ï¼Œå¹¶æ ¹æ®çª—å£ä¸­çš„å’Œå€¼ï¼Œæ¥è¿›è¡Œç›¸åº”çš„ç§»åŠ¨å¤„ç†ï¼Œå…·ä½“ä¸ºä¸‹ï¼š\nå’Œå€¼å°äºæ‰€éœ€çš„å€¼ï¼Œæ‰©å¤§çª—å£ï¼Œæ“ä½œä¸ºå³æŒ‡é’ˆ + 1 å’Œå€¼å¤§äºæ‰€éœ€çš„å€¼ï¼Œç¼©å°çª—å£ï¼Œæ“ä½œä¸ºå·¦æŒ‡é’ˆ + 1 å’Œå€¼ç­‰äºæ‰€éœ€çš„å€¼ï¼Œè®°å½•ç»“æœï¼Œå·¦å³æŒ‡é’ˆåŒæ—¶ + 1 æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä»£ç å¦‚ä¸‹ï¼š\nfunc findContinuousSequence(target int) [][]int { var res [][]int // æ„å»ºä¸€ä¸ªæ•°ç»„ç”¨äºæ»‘åŠ¨çª—å£ n := make([]int, (target\u0026gt;\u0026gt;1)+1) for i := 0; i \u0026lt; len(n); i++ { n[i] = i + 1 } i, j := 0, 1 sum := n[i] + n[j] for i \u0026lt; j { if sum \u0026lt; target { j++ sum += n[j] } else if sum \u0026gt; target { sum -= n[i] i++ } else if sum == target { var temp []int for i1 := i; i1 \u0026lt;= j; i1++ { temp = append(temp, n[i1]) } res = append(res, temp) sum -= n[i] i++ // j ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæ‰æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼Œ // å¦åˆ™ j++ åä¼šå¯¼è‡´ n[j] è¶Šç•Œ if j \u0026lt; len(n)-1 { j++ sum += n[j] } } } return res } è¿™é‡Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š\nå¦‚æœéœ€è¦ç§»åŠ¨ j æŒ‡é’ˆï¼Œåˆ™æ›´æ–°å’Œå€¼æ“ä½œéœ€è¦åœ¨ç§»åŠ¨åè¿›è¡Œï¼š\nj++ sum += n[j] å¦‚æœéœ€è¦ç§»åŠ¨ i æŒ‡é’ˆï¼Œéœ€è¦åœ¨ç§»åŠ¨å‰æ›´æ–°å’Œå€¼ï¼š\nsum -= n[i] i++ sum == target æ—¶ é˜²æ­¢ j è¶Šç•Œ\n// j ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæ‰æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼Œ // å¦åˆ™ j++ åä¼šå¯¼è‡´ n[j] è¶Šç•Œ if j \u0026lt; len(n)-1 { j++ sum += n[j] } ä¼˜åŒ–ä¸€ä¸‹ è™½ç„¶ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯åœ¨å‚è€ƒäº†é¢˜è§£åï¼Œå‘ç°è‡ªå·±çš„ä»£ç è¿˜æœ‰ä¸€äº›å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œé¦–å…ˆæ˜¯æœ€å¼€å§‹çš„æ„å»ºæ•°ç»„ï¼Œè¿™æ˜¯å®Œå…¨æ²¡å¿…è¦çš„ï¼Œå› ä¸ºæ˜¯è¿ç»­æ­£æ•´æ•°åºåˆ—ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æŠŠæŒ‡é’ˆä½œä¸ºæ•°å­—ï¼Œè€Œä¸æ˜¯ä¸‹æ ‡ã€‚\næ­¤å¤–ï¼Œå¯¹äº sum == target è¿™ç§æƒ…å†µï¼Œæˆ‘çš„å¤„ç†é€»è¾‘æ˜¯ i å’Œ j éƒ½ç§»åŠ¨ï¼Œä½†æ˜¯å®é™…ä¸Šåªéœ€è¦ç§»åŠ¨ i å³å¯ï¼Œè¿™æ ·å¯ä»¥çœå»è¶Šç•Œåˆ¤æ–­ï¼Œä¸”å¯æ¥å‡å°‘ç§»åŠ¨æ¬¡æ•°ã€‚\nå‡å°‘ç§»åŠ¨æ¬¡æ•°ç¤ºä¾‹ï¼š i å’Œ j éƒ½ç§»åŠ¨\ni = 4, j = 5, s = 9 == target i++ = 5, j++ = 6, sum= 11 \u0026gt; 9 i++ = 6ï¼Œi == j ï¼Œbreak åªç§»åŠ¨ i\ni = 4, j = 5, s = 9 == target i =5, j = 5, i == j ï¼Œbreak ä»£ç å¦‚ä¸‹ï¼š\nfunc findContinuousSequence(target int) [][]int { var res [][]int i, j, sum := 1, 2, 3 for i \u0026lt; j { if sum \u0026lt; target { j++ sum += j } else if sum \u0026gt; target { sum -= i i++ } else if sum == target { var temp []int for i1 := i; i1 \u0026lt;= j; i1++ { temp = append(temp, i1) } res = append(res, temp) sum -= i i++ } } return res } ","date":"2021å¹´05æœˆ04æ—¥","permalink":"/posts/jian-zhi-offer-57-ii-he-wei-s-de-lian-xu-zheng-shu-xu-lie/","summary":"è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•° target ï¼Œè¾“å‡ºæ‰€æœ‰å’Œä¸º target çš„è¿ç»­æ­£æ•´æ•°åºåˆ—ï¼ˆè‡³å°‘å«æœ‰ä¸¤ä¸ªæ•°ï¼‰ã€‚","title":"å‰‘æŒ‡ Offer 57 - II. å’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—"},{"contents":" ç»™å®šä¸€ä¸ªä¿å­˜å‘˜å·¥ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«äº†å‘˜å·¥ å”¯ä¸€çš„ id ï¼Œé‡è¦åº¦Â å’Œ ç›´ç³»ä¸‹å±çš„ id\næ¯”å¦‚ï¼Œå‘˜å·¥ 1 æ˜¯å‘˜å·¥ 2 çš„é¢†å¯¼ï¼Œå‘˜å·¥ 2 æ˜¯å‘˜å·¥ 3 çš„é¢†å¯¼ã€‚ä»–ä»¬ç›¸åº”çš„é‡è¦åº¦ä¸º 15 , 10 , 5 ã€‚é‚£ä¹ˆ å‘˜å·¥ 1 çš„æ•°æ®ç»“æ„æ˜¯ [1, 15, [2]] ï¼Œå‘˜å·¥ 2çš„ æ•°æ®ç»“æ„æ˜¯ [2, 10, [3]] ï¼Œå‘˜å·¥ 3 çš„æ•°æ®ç»“æ„æ˜¯ [3, 5, []] ã€‚æ³¨æ„è™½ç„¶å‘˜å·¥ 3 ä¹Ÿæ˜¯å‘˜å·¥ 1 çš„ä¸€ä¸ªä¸‹å±ï¼Œä½†æ˜¯ç”±äº å¹¶ä¸æ˜¯ç›´ç³» ä¸‹å±ï¼Œå› æ­¤æ²¡æœ‰ä½“ç°åœ¨ å‘˜å·¥ 1 çš„æ•°æ®ç»“æ„ä¸­ã€‚\nç°åœ¨è¾“å…¥ä¸€ä¸ªå…¬å¸çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ï¼Œä»¥åŠå•ä¸ªå‘˜å·¥ id ï¼Œè¿”å›è¿™ä¸ªå‘˜å·¥å’Œä»–æ‰€æœ‰ä¸‹å±çš„é‡è¦åº¦ä¹‹å’Œã€‚\nç¤ºä¾‹ï¼š\nè¾“å…¥ï¼š[[1, 5, [2, 3]], [2, 3, []], [3, 3, []]], 1 è¾“å‡ºï¼š11 è§£é‡Šï¼š å‘˜å·¥ 1 è‡ªèº«çš„é‡è¦åº¦æ˜¯ 5 ï¼Œä»–æœ‰ä¸¤ä¸ªç›´ç³»ä¸‹å± 2 å’Œ 3 ï¼Œè€Œä¸” 2 å’Œ 3 çš„é‡è¦åº¦å‡ä¸º 3 ã€‚å› æ­¤å‘˜å·¥ 1 çš„æ€»é‡è¦åº¦æ˜¯ 5 + 3 + 3 = 11 ã€‚\næç¤ºï¼š\nä¸€ä¸ªå‘˜å·¥æœ€å¤šæœ‰ä¸€ä¸ª ç›´ç³» é¢†å¯¼ï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ª ç›´ç³» ä¸‹å± å‘˜å·¥æ•°é‡ä¸è¶…è¿‡ 2000 ã€‚\næ–¹æ³•1 æ™®é€šé€’å½’ /** * Definition for Employee. * type Employee struct { * Id int * Importance int * Subordinates []int * } */ func getImportance(employees []*Employee, id int) int { var res int dfs(employees, id, \u0026amp;res) return res } func dfs(emp []*Employee, id int, res *int) { for _, v := range emp { if v.Id == id { *res += v.Importance for _, s := range v.Subordinates { dfs(emp, s, res) } } } } æ‰§è¡Œç”¨æ—¶: 8 ms å†…å­˜æ¶ˆè€—: 6.6 MB æ–¹æ³•2 é€’å½’ + å“ˆå¸Œè¡¨ é€šè¿‡å“ˆå¸Œè¡¨å¯ä»¥åœ¨ O(1) å†…é€šè¿‡ id æŸ¥æ‰¾åˆ°å¯¹è±¡ï¼Œè€Œæ— éœ€éå†æ•°ç»„ã€‚\n/** * Definition for Employee. * type Employee struct { * Id int * Importance int * Subordinates []int * } */ func getImportance(employees []*Employee, id int) int { m := make(map[int]*Employee) var res int for _, v := range employees { m[v.Id] = v } dfs(m, id, \u0026amp;res) return res } func dfs(m map[int]*Employee, id int, res *int) { e := m[id] *res += e.Importance for _, v := range e.Subordinates { dfs(m, v, res) } } æ‰§è¡Œç”¨æ—¶: 16 ms å†…å­˜æ¶ˆè€—: 6.8 MB ä¸ºä»€ä¹ˆåè€Œæ›´æ…¢äº†ã€‚ã€‚ã€‚\næ–¹æ³•3 è¿­ä»£ é€šè¿‡é˜Ÿåˆ— + å“ˆå¸Œè¡¨æ¥å®ç°ã€‚\n/** * Definition for Employee. * type Employee struct { * Id int * Importance int * Subordinates []int * } */ func getImportance(employees []*Employee, id int) int { m := make(map[int]*Employee) for _, e := range employees { m[e.Id] = e } var res int queue := list.New() queue.PushBack(m[id]) for queue.Len() \u0026gt; 0 { pop := queue.Remove(queue.Front()).(*Employee) res += pop.Importance for _, e := range pop.Subordinates { queue.PushBack(m[e]) } } return res } æ‰§è¡Œç”¨æ—¶: 12 ms å†…å­˜æ¶ˆè€—: 6.7 MB ","date":"2021å¹´05æœˆ02æ—¥","permalink":"/posts/leetcode-690-yuan-gong-de-chong-yao-xing/","summary":"ç»™å®šä¸€ä¸ªä¿å­˜å‘˜å·¥ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«äº†å‘˜å·¥ å”¯ä¸€çš„ id ï¼Œé‡è¦åº¦Â å’Œ ç›´ç³»ä¸‹å±çš„ id","title":"LeetCode 690. å‘˜å·¥çš„é‡è¦æ€§"},{"contents":"Parallels Desktop 16 åœ¨æœ€æ–°çš„macOS Big Sur 11.0ç³»ç»Ÿä¸Šæ— æ³•è”ç½‘ï¼Œå¹¶ä¸”æ— æ³•è¿æ¥USBè®¾å¤‡ã€‚ä¹‹å‰è§£å†³è”ç½‘çš„åŠæ³•æ˜¯åœ¨ç»ˆç«¯é€šè¿‡å‘½ä»¤å¯åŠ¨parallels desktopçš„æ–¹æ³•è§£å†³è”ç½‘çš„é—®é¢˜ï¼Œä½†æ˜¯ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è¿˜æ˜¯æ— æ³•è§£å†³Parallels Desktop 16 ä¸èƒ½è¿æ¥USBè®¾å¤‡çš„é—®é¢˜ã€‚\nä»Šå¤©å°ç¼–ä¸ºå¤§å®¶æä¾›ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•è§£å†³Parallels Desktop 16 ä¸èƒ½è”ç½‘ä¸è¿æ¥USBè®¾å¤‡çš„é—®é¢˜ã€‚è¯¦ç»†æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š\n1ã€æ‰“å¼€è®¿è¾¾ï¼ŒæŒ‰ä¸‹shift+command+G ä¸‰ä¸ªé”®ï¼Œå‰å¾€æ–‡ä»¶å¤¹ï¼š/Library/Preferences/ParallelsÂ ï¼›\n2ã€ä¸‹è½½Â Sublime TextÂ æ‰“å¼€æ–‡ä»¶Â network.desktop.xml ï¼Œæ‰¾åˆ°ç¬¬5è¡Œçš„Â -1Â ï¼ˆä¹Ÿå¯èƒ½æ˜¯Â 1Â ï¼‰ï¼Œä¿®æ”¹ä¸ºÂ 0Â ä¿å­˜å¹¶é€€å‡ºï¼Œä¿å­˜æ—¶ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¾“å…¥ç³»ç»Ÿå¯†ç ç¡®å®šå³å¯ï¼›\n3ã€ç”¨ Sublime Text æ‰“å¼€æ–‡ä»¶ dispatcher.desktop.xml ï¼ŒæŒ‰ command + F æŸ¥æ‰¾ 0 ï¼Œä¿®æ”¹ä¸º 1 ä¿å­˜å¹¶é€€å‡ºï¼Œä¿å­˜æ—¶ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¾“å…¥ç³»ç»Ÿå¯†ç ç¡®å®šå³å¯ï¼›\n4ã€ç„¶åæ‰“å¼€Parallels Desktop 16ï¼Œå¯èƒ½ä¼šæç¤º Parallelséœ€è¦ç³»ç»Ÿæ‰©å±• ï¼Œæ‰“å¼€ ç³»ç»Ÿåå¥½è®¾ç½® ï¼Œè¿›å…¥ å®‰å…¨æ€§ä¸éšç§ ï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„é”å›¾æ ‡è§£é”ï¼Œåœ¨ç‚¹å‡»ä¸‹æ–¹ã€ æ¥è‡ªå¼€å‘è€…â€œParallels International GmbHâ€çš„ç³»ç»Ÿè½¯ä»¶å·²è¢«é˜»æ­¢è½½å…¥ã€‚ ã€‘å³ä¾§çš„ å…è®¸ æŒ‰é’®ï¼Œæç¤ºéœ€è¦é‡å¯ï¼Œç‚¹å‡»ç¡®å®šé‡å¯ç”µè„‘ï¼Œå†æ‰“å¼€Parallels Desktop 16è¿›å…¥Windowsç³»ç»Ÿå³å¯æ­£å¸¸ä¸Šç½‘å’Œè¿æ¥USBè®¾å¤‡äº†ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œblank_tã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/blank_t/article/details/111567618\n","date":"2021å¹´05æœˆ01æ—¥","permalink":"/posts/parallels-desktop-16-wang-luo-chu-shi-hua-shi-bai-he-bu-neng-lian-jie-usb-she-bei-jie-jue-fang-fa/","summary":"Parallels Desktop 16 åœ¨æœ€æ–°çš„macOS Big Sur 11.","title":"Parallels Desktop 16 ç½‘ç»œåˆå§‹åŒ–å¤±è´¥å’Œä¸èƒ½è¿æ¥USBè®¾å¤‡è§£å†³æ–¹æ³•"},{"contents":"é”™è¯¯1ï¼š func test() error { if err := func1(); err != nil { // func1() ä¼šäº§ç”Ÿé”™è¯¯ return err } defer func() { fmt.Println(\u0026quot;defer func\u0026quot;) } } ä¸Šé¢çš„å‡½æ•°ä¸ä¼šè¾“å‡º â€defer funcâ€œï¼Œå› ä¸ºå‹æ ¹å°±æ²¡æœ‰æ‰§è¡Œåˆ° defer å¤„ï¼Œå¯¼è‡´ defer æ²¡æœ‰æ³¨å†Œï¼ˆæˆ–è€…è¯´æ˜¯å‹å…¥æ ˆä¸­ï¼Ÿè¿˜ä¸äº†è§£ defer çš„åŸç†ï¼‰\næ­£ç¡®å†™æ³•ï¼š\nfunc test() error { defer func() { fmt.Println(\u0026quot;defer func\u0026quot;) } if err := func1(); err != nil { // func1() ä¼šäº§ç”Ÿé”™è¯¯ return err } } æŠŠ defer å®šä¹‰åœ¨å‰é¢å°±å¥½äº†ï¼Œè¿™æ ·åœ¨ä¸€å¼€å§‹å°±ä¼šå°† defer å‡½æ•°æ³¨å†Œã€‚ çœ‹æ¥è¿˜æ˜¯å¾—å¤šå†™å†™é¡¹ç›®æ‰èƒ½å‘ç°è‡ªå·±çš„é—®é¢˜ã€‚\n","date":"2021å¹´04æœˆ23æ—¥","permalink":"/posts/goji-yi-ci-defer-cuo-wu/","summary":"é”™è¯¯1ï¼š func test() error { if err := func1(); err !","title":"goï¼šè®°ä¸€æ¬¡ defer é”™è¯¯"},{"contents":"æœ‰å¦‚ä¸‹ c++ ä»£ç ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯åˆ é™¤å®¹å™¨ä¸­æ‰€æœ‰å°äº 10 çš„å…ƒç´ ï¼š\nlist\u0026lt;int\u0026gt; l{1, 2, 3, 4, 12, 13, 15}; int xx = 10; for (auto f = l.front(); f \u0026lt; xx \u0026amp;\u0026amp; !l.empty(); ) { l.pop_front(); } for_each(l.begin(), l.end(), [](int v) -\u0026gt; void { cout \u0026lt;\u0026lt; v \u0026lt;\u0026lt; \u0026quot; \u0026quot;; }); cout \u0026lt;\u0026lt; endl; è¿™æ®µä»£ç çš„é€»è¾‘æ˜¯ï¼šé¦–å…ˆè·å– list çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼ï¼Œç”¨å˜é‡ f ä¿å­˜ï¼Œå†ç”¨ f å’Œ å˜é‡ xx æ¯”è¾ƒï¼Œå¦‚æœ f \u0026lt; xx ä¸” list ä¸ä¸ºç©ºï¼Œåˆ™ç§»é™¤ list çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚\næ­£ç¡®çš„ç»“æœåº”è¯¥æ˜¯ [12, 13, 15]ï¼Œä½†æ˜¯è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œç»“æœå´ä¸ºç©ºï¼Œå®¹å™¨é‡Œçš„æ‰€æœ‰å…ƒç´ éƒ½è¢«åˆ æ‰äº†ã€‚\nå°†ä¸Šé¢çš„ for æ”¹æˆä¸‹é¢çš„ä»£ç åï¼Œç»“æœæ­£ç¡®\nfor (; l.front() \u0026lt; xx \u0026amp;\u0026amp; !l.empty(); ) { l.pop_front(); } åŸå› å‡ºåœ¨ auto f = l.front() è¿™é‡Œäº†ï¼Œæ‰“å°ä¸€ä¸‹è¯¥å€¼ï¼š\nlist\u0026lt;int\u0026gt; l{1, 2, 3, 4, 12, 13, 15}; int xx = 10; for (auto f = l.front(); f \u0026lt; xx \u0026amp;\u0026amp; !l.empty(); ) { l.pop_front(); } è¾“å‡ºï¼š1 1 1 1 1 1 1\næˆ‘å¸Œæœ›çš„æ˜¯æ¯æ¬¡ for éƒ½ä¼šæ›´æ–° f çš„å€¼ï¼Œå› ä¸ºæ‰§è¡Œäº† pop_front() åï¼Œl.front() ä¹Ÿéšä¹‹æ”¹å˜ï¼Œæ‰€ä»¥ç”¨æ¥ä¿å­˜ front() çš„å˜é‡ f ä¹Ÿéœ€è¦æ”¹å˜ï¼Œä½†è¿™æ°å¥½è¯´æ˜äº†æˆ‘çš„åŸºç¡€ä¸ç‰¢å›ºï¼Œå¯¹ for å¾ªç¯çš„ç†è§£ä¸åˆ°ä½ã€‚\nå‚è§èœé¸Ÿæ•™ç¨‹ä¸­å¯¹ for å¾ªç¯çš„è®²è§£ï¼šï¼ˆhttps://www.runoob.com/cplusplus/cpp-for-loop.htmlï¼‰\nfor ( init; condition; increment ) { statement(s); } init ä¼šé¦–å…ˆè¢«æ‰§è¡Œï¼Œä¸”åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¿™ä¸€æ­¥å…è®¸æ‚¨å£°æ˜å¹¶åˆå§‹åŒ–ä»»ä½•å¾ªç¯æ§åˆ¶å˜é‡ã€‚æ‚¨ä¹Ÿå¯ä»¥ä¸åœ¨è¿™é‡Œ å†™ä»»ä½•è¯­å¥ï¼Œåªè¦æœ‰ä¸€ä¸ªåˆ†å·å‡ºç°å³å¯ã€‚\nfor å¾ªç¯çš„ç¬¬ä¸€ä¸ªè¯­å¥åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸Šé¢çš„è¿è¡Œç»“æœå¯ä»¥è¯æ˜è¿™ä¸€ç‚¹ï¼Œæœ‰è¿™ä¸€å¥è¯å°±å¯ä»¥è§£é‡Šä¸Šé¢çš„æ‰€æœ‰é—®é¢˜äº†ã€‚\n","date":"2021å¹´04æœˆ23æ—¥","permalink":"/posts/wei-shi-me-bu-neng-yong-bian-liang-bao-cun-die-dai-qi/","summary":"æœ‰å¦‚ä¸‹ c++ ä»£ç ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯åˆ é™¤å®¹å™¨ä¸­æ‰€æœ‰å°äº 10 çš„å…ƒç´ ï¼š","title":"å†æ¢ for å¾ªç¯"},{"contents":" å†™ä¸€ä¸ªå‡½æ•° StrToIntï¼Œå®ç°æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°è¿™ä¸ªåŠŸèƒ½ã€‚ä¸èƒ½ä½¿ç”¨ atoi æˆ–è€…å…¶ä»–ç±»ä¼¼çš„åº“å‡½æ•°ã€‚\né¦–å…ˆï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®éœ€è¦ä¸¢å¼ƒæ— ç”¨çš„å¼€å¤´ç©ºæ ¼å­—ç¬¦ï¼Œç›´åˆ°å¯»æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºæ ¼çš„å­—ç¬¦ä¸ºæ­¢ã€‚\nå½“æˆ‘ä»¬å¯»æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦ä¸ºæ­£æˆ–è€…è´Ÿå·æ—¶ï¼Œåˆ™å°†è¯¥ç¬¦å·ä¸ä¹‹åé¢å°½å¯èƒ½å¤šçš„è¿ç»­æ•°å­—ç»„åˆèµ·æ¥ï¼Œä½œä¸º è¯¥æ•´æ•°çš„æ­£è´Ÿå·ï¼›å‡å¦‚ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦æ˜¯æ•°å­—ï¼Œåˆ™ç›´æ¥å°†å…¶ä¸ä¹‹åè¿ç»­çš„æ•°å­—å­—ç¬¦ç»„åˆèµ·æ¥ï¼Œå½¢æˆæ•´æ•°ã€‚\nè¯¥å­—ç¬¦ä¸²é™¤äº†æœ‰æ•ˆçš„æ•´æ•°éƒ¨åˆ†ä¹‹åä¹Ÿå¯èƒ½ä¼šå­˜åœ¨å¤šä½™çš„å­—ç¬¦ï¼Œè¿™äº›å­—ç¬¦å¯ä»¥è¢«å¿½ç•¥ï¼Œå®ƒä»¬å¯¹äºå‡½æ•°ä¸åº”è¯¥é€  æˆå½±å“ã€‚\næ³¨æ„ï¼šå‡å¦‚è¯¥å­—ç¬¦ä¸²ä¸­çš„ç¬¬ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆæ•´æ•°å­—ç¬¦ã€å­—ç¬¦ä¸²ä¸ºç©ºæˆ–å­—ç¬¦ä¸²ä»…åŒ…å«ç©ºç™½å­—ç¬¦ æ—¶ï¼Œåˆ™ä½ çš„å‡½æ•°ä¸éœ€è¦è¿›è¡Œè½¬æ¢ã€‚\nåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œè‹¥å‡½æ•°ä¸èƒ½è¿›è¡Œæœ‰æ•ˆçš„è½¬æ¢æ—¶ï¼Œè¯·è¿”å› 0ã€‚\nè¯´æ˜ï¼š\nå‡è®¾æˆ‘ä»¬çš„ç¯å¢ƒåªèƒ½å­˜å‚¨ 32 ä½å¤§å°çš„æœ‰ç¬¦å·æ•´æ•°ï¼Œé‚£ä¹ˆå…¶æ•°å€¼èŒƒå›´ä¸ºÂ [âˆ’231,Â 231Â âˆ’ 1]ã€‚å¦‚æœæ•°å€¼è¶… è¿‡è¿™ä¸ªèŒƒå›´ï¼Œè¯·è¿”å› INT_MAX (231Â âˆ’ 1) æˆ–Â INT_MIN (âˆ’231) ã€‚\nç¤ºä¾‹Â 1:\nè¾“å…¥: \u0026ldquo;42\u0026rdquo; è¾“å‡º: 42\nç¤ºä¾‹Â 2:\nè¾“å…¥: \u0026quot; -42\u0026quot; è¾“å‡º: -42 è§£é‡Š: ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦ä¸º \u0026lsquo;-\u0026rsquo;, å®ƒæ˜¯ä¸€ä¸ªè´Ÿå·ã€‚ æˆ‘ä»¬å°½å¯èƒ½å°†è´Ÿå·ä¸åé¢æ‰€æœ‰è¿ç»­å‡ºç°çš„æ•°å­—ç»„åˆèµ·æ¥ï¼Œæœ€åå¾—åˆ° -42 ã€‚\nç¤ºä¾‹Â 3:\nè¾“å…¥: \u0026ldquo;4193 with words\u0026rdquo; è¾“å‡º: 4193 è§£é‡Š: è½¬æ¢æˆªæ­¢äºæ•°å­— \u0026lsquo;3\u0026rsquo; ï¼Œå› ä¸ºå®ƒçš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸ä¸ºæ•°å­—ã€‚\nç¤ºä¾‹Â 4:\nè¾“å…¥: \u0026ldquo;words and 987\u0026rdquo; è¾“å‡º: 0 è§£é‡Š: ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦æ˜¯ \u0026lsquo;w\u0026rsquo;, ä½†å®ƒä¸æ˜¯æ•°å­—æˆ–æ­£ã€è´Ÿå·ã€‚ å› æ­¤æ— æ³•æ‰§è¡Œæœ‰æ•ˆçš„è½¬æ¢ã€‚\nç¤ºä¾‹Â 5:\nè¾“å…¥: \u0026ldquo;-91283472332\u0026rdquo; è¾“å‡º: -2147483648 è§£é‡Š: æ•°å­— \u0026ldquo;-91283472332\u0026rdquo; è¶…è¿‡ 32 ä½æœ‰ç¬¦å·æ•´æ•°èŒƒå›´ã€‚ å› æ­¤è¿”å› INT_MIN (âˆ’231) ã€‚\nåˆ†æ è¿™é“é¢˜ä¹ä¸€çœ‹å¥½åƒæ²¡ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ï¼Œä¸å°±æ˜¯ä¸€ä¸ª atoi å˜›ï¼Œåªæ˜¯è¿™ä¸ª 28% çš„é€šè¿‡ç‡æœ‰äº›ä¸å¯¹åŠ²ï¼Œç­‰åˆ°è‡ªå·±å†™çš„æ—¶å€™æ‰å‘ç°ï¼Œè¿™é“é¢˜å¤ª tm æ¶å¿ƒäº†ï¼Œæœ‰å„ç§å„æ ·çš„ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ï¼š\nâ€ +1â€œ ç©ºæ ¼åé¢ç´§è·Ÿä¸€ä¸ªç¬¦å· â€ +-1â€œ ä¸¤ä¸ªç¬¦å·åœ¨ä¸€èµ· â€ +0 123â€œ ä¸¤ä¸ªæ•°å­—ä¹‹é—´æœ‰ç©ºæ ¼ â€0-1â€œ ä¸¤ä¸ªæ•°å­—ä¹‹é—´å³ç¬¦å· è¿˜æœ‰æº¢å‡ºçš„é—®é¢˜ï¼Œå¦‚æœå°äº minInt32ï¼Œåˆ™è¿”å› minInt32ï¼ŒmaxInt32 åŒç† è¿™äº›æ¡ä»¶ä¼šå¯¼è‡´å†™å‡ºæ¥çš„ä»£ç éå¸¸ç¹çï¼Œè€Œä¸”éå¸¸å®¹æ˜“å‡ºé”™ï¼Œå¾€å¾€æ˜¯è§£å†³äº†ä¸€ç§æƒ…å†µï¼Œåˆå¯¼è‡´å¦ä¸€ç§æƒ…å†µé”™è¯¯ï¼Œæœ‰ç‚¹åƒè¾¹ä¿® bug è¾¹é€  bugã€‚\næ–¹æ³•1 è‡ªåŠ¨æœº è‡ªåŠ¨æœºè¡¨ç¤ºå¦‚ä¸‹ï¼š\nstart signed in_number end start start signed in_number end signed end end in_number end in_number end end in_number end end end end end end è§£é‡Šï¼š startï¼šä»£è¡¨ç©ºæ ¼ signedï¼šä»£è¡¨ â€œ+â€ æˆ–è€… â€œ-â€ in_numberï¼šä»£è¡¨æ•°å­— endï¼šä»£è¡¨å…¶ä»–å­—ç¬¦\nå½“ start é‡åˆ° start æ—¶ï¼šä»£è¡¨ç©ºæ ¼é‡åˆ°ç©ºæ ¼ï¼ŒçŠ¶æ€ä¾ç„¶ä¸º startï¼Œä¾‹å¦‚ â€œ â€ å½“ start é‡åˆ° signed æ—¶ï¼šä»£è¡¨ç©ºæ ¼é‡åˆ° + æˆ– -ï¼ŒçŠ¶æ€æ”¹å˜ä¸º signedï¼Œä¾‹å¦‚ â€œ +â€ å½“ start é‡åˆ° in_number æ—¶ï¼šä»£è¡¨ç©ºæ ¼é‡åˆ°æ•°å­—ï¼ŒçŠ¶æ€æ”¹å˜ä¸º in_numberï¼Œä¾‹å¦‚ â€œ 1â€ å½“ start é‡åˆ° end æ—¶ï¼šä»£è¡¨ç©ºæ ¼é‡åˆ°å…¶ä»–å­—ç¬¦ï¼ŒçŠ¶æ€æ”¹å˜ä¸º endï¼Œä¾‹å¦‚ â€œ aâ€\nå½“ signed é‡åˆ° start æ—¶ï¼šä»£è¡¨ç¬¦å·é‡åˆ°ç©ºæ ¼ï¼Œä¾‹å¦‚ â€œ+ â€ï¼Œæ­¤æ—¶ä¸ºéæ³•ï¼ŒçŠ¶æ€æ”¹ä¸º end å½“ signed é‡åˆ° signed æ—¶ï¼šä»£è¡¨ç¬¦å·é‡åˆ°ç¬¦å·ï¼šä¾‹å¦‚ â€œ++â€ï¼Œæ­¤æ—¶ä¸ºéæ³•ï¼ŒçŠ¶æ€æ”¹ä¸º end å½“ signed é‡åˆ° in_number æ—¶ï¼Œä»£è¡¨ç¬¦å·é‡åˆ°æ•°å­—ï¼Œä¾‹å¦‚ â€œ+1â€ï¼Œåˆæ³•ä¸”ä¸ºä¸€ä¸ªæ•°å­—ï¼ŒçŠ¶æ€æ”¹ä¸º in_number å½“ signed é‡åˆ° end æ—¶ï¼Œä»£è¡¨ç¬¦å·é‡åˆ°å…¶ä»–å­—ç¬¦ï¼Œä¾‹å¦‚ â€œ+aâ€ï¼Œæ­¤æ—¶ä¸ºéæ³•ï¼ŒçŠ¶æ€æ”¹ä¸º end\nä¸‹é¢ä¸ºç®€å†™ï¼Œx -\u0026gt; y è¡¨ç¤ºä¸º x é‡åˆ° yï¼Œ\u0026quot; \u0026quot; ä¸ºç¤ºä¾‹ï¼Œstat ä¸ºæ›´æ–°åçš„çŠ¶æ€\nin_number -\u0026gt; startï¼š\u0026ldquo;1 \u0026ldquo;ï¼Œstat = end in_number -\u0026gt; signedï¼š\u0026ldquo;1+\u0026quot;ï¼Œstat = end in_number -\u0026gt; in_numberï¼š\u0026ldquo;12\u0026rdquo;ï¼Œstat = in_number in_number -\u0026gt; endï¼š\u0026ldquo;1a\u0026rdquo;ï¼Œstat = end\nend -\u0026gt; startï¼š\u0026ldquo;a \u0026ldquo;ï¼Œstat = end end -\u0026gt; signedï¼š\u0026ldquo;a+\u0026quot;ï¼Œstat = end end -\u0026gt; in_numberï¼š\u0026ldquo;a1\u0026rdquo;ï¼Œstat = end end -\u0026gt; endï¼š\u0026ldquo;ab\u0026rdquo;ï¼Œstat = end\nç†è§£äº†è‡ªåŠ¨æœºä»¥åï¼Œä¹Ÿå°±æœ‰äº†ä¸€äº›å†™ä»£ç çš„æ€è·¯äº†ï¼Œä¸å¾—ä¸è¯´è¿™ç§æ–¹æ³•çœŸçš„ååˆ†å·§å¦™ï¼Œèƒ½å¤Ÿè½»æ¾åŒ–è§£å„ç§ç¹æ‚çš„ if else æ¡ä»¶å’Œè¾¹ç•Œåˆ¤æ–­ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n// å¯¹åº”ä¹‹å‰çš„è‡ªåŠ¨æœºå›¾è¡¨ var stat = map[string][]string{ \u0026quot;start\u0026quot;: {\u0026quot;start\u0026quot;, \u0026quot;sign\u0026quot;, \u0026quot;num\u0026quot;, \u0026quot;end\u0026quot;}, \u0026quot;sign\u0026quot;: {\u0026quot;end\u0026quot;, \u0026quot;end\u0026quot;, \u0026quot;num\u0026quot;, \u0026quot;end\u0026quot;}, \u0026quot;num\u0026quot;: {\u0026quot;end\u0026quot;, \u0026quot;end\u0026quot;, \u0026quot;num\u0026quot;, \u0026quot;end\u0026quot;}, \u0026quot;end\u0026quot;: {\u0026quot;end\u0026quot;, \u0026quot;end\u0026quot;, \u0026quot;end\u0026quot;, \u0026quot;end\u0026quot;}, } // å¯¹åº”è‡ªåŠ¨æœºå›¾è¡¨çš„è¡¨å¤´ func getStat(c rune) int { if unicode.IsSpace(c) { return 0 } else if c == '+' || c == '-' { return 1 } else if unicode.IsDigit(c) { return 2 } else { return 3 } } func myAtoi(s string) int { is := \u0026quot;start\u0026quot; sign := 1 var res int for _, c := range s { is = stat[is][getStat(c)] if is == \u0026quot;num\u0026quot; { res = res*10 + int(c-'0') // math.MinInt32: -2147483648 // math.MaxInt32: 2147483647 switch sign { case 1: res = min(res, math.MaxInt32) case -1: // min(res, math.MaxInt32) // è¾“å…¥ï¼š\u0026quot;-91283472332\u0026quot; // è¾“å‡ºï¼š-2147483647 // é¢„æœŸï¼š-2147483648 // -math.MinInt32 ???? res = min(res, -math.MinInt32) } } if is == \u0026quot;sign\u0026quot; { if c == '+' { sign = 1 } else { sign = -1 } } } return res * sign } func min(x, y int) int { if x \u0026gt; y { return y } return x } è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹ sign = -1 æ—¶çš„æº¢å‡ºåˆ¤æ–­ res = min(res, -math.MinInt32) ï¼Œä¸ºä»€ä¹ˆè¦åŠ è´Ÿå·å‘¢ï¼Ÿä»¥æµ‹è¯•ç”¨ä¾‹ -91283472332 ä¸ºä¾‹ï¼Œæ­£ç¡®çš„ç»“æœä¸º -2147483648ï¼š\n(æ³¨ï¼šmath.MinInt32: -2147483648 math.MaxInt32: 2147483647)\nå› ä¸ºæœ‰è´Ÿå·ï¼Œæ‰€ä»¥ sign çš„å€¼æ›´æ–°ä¸º -1ï¼Œè€Œæœ€åè¿”å›çš„çš„ç»“æœä¸º res * signï¼Œå³ - resï¼Œæ‰€ä»¥éœ€è¦ä¸º math.MinInt32 æ·»åŠ ä¸€ä¸ªç¬¦å·ï¼Œå°†å…¶å˜ä¸º 2147483648ï¼Œè¿™æ ·å†ä¸ sign ç›¸ä¹˜ï¼Œå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªè´Ÿæ•°äº†ã€‚\næ­¤å¤–ï¼Œå¦‚æœæ¡ä»¶ä¸º min(res, math.MinInt32)ï¼Œé‚£ä¹ˆå½“ res ä¸º -42 æ—¶ï¼Œå¹¶æ²¡æœ‰æº¢å‡ºï¼Œä½†æ˜¯ä¼šé”™è¯¯çš„è¿”å› MinInt32ï¼Œå¦‚æœæ”¹ä¸º -math.MinInt32 åˆ™ä¼šæ­£ç¡®çš„è¿”å› -42 äº†ã€‚\n","date":"2021å¹´04æœˆ21æ—¥","permalink":"/posts/jian-zhi-offer-67-ba-zi-fu-chuan-zhuan-huan-cheng-zheng-shu/","summary":"å†™ä¸€ä¸ªå‡½æ•° StrToIntï¼Œå®ç°æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°è¿™ä¸ªåŠŸèƒ½ã€‚ä¸èƒ½ä½¿ç”¨ atoi æˆ–è€…å…¶ä»–ç±»ä¼¼çš„åº“å‡½æ•°ã€‚","title":"å‰‘æŒ‡ Offer 67. æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°"},{"contents":"é¢˜ç›®æè¿° ç»™å®šä¸€ä¸ªç»è¿‡ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè¿”å›å®ƒè§£ç åçš„å­—ç¬¦ä¸²ã€‚\nç¼–ç è§„åˆ™ä¸º: k[encoded_string]ï¼Œè¡¨ç¤ºå…¶ä¸­æ–¹æ‹¬å·å†…éƒ¨çš„ encoded_string æ­£å¥½é‡å¤ k æ¬¡ã€‚æ³¨æ„ k ä¿è¯ä¸ºæ­£æ•´æ•°ã€‚\nä½ å¯ä»¥è®¤ä¸ºè¾“å…¥å­—ç¬¦ä¸²æ€»æ˜¯æœ‰æ•ˆçš„ï¼›è¾“å…¥å­—ç¬¦ä¸²ä¸­æ²¡æœ‰é¢å¤–çš„ç©ºæ ¼ï¼Œä¸”è¾“å…¥çš„æ–¹æ‹¬å·æ€»æ˜¯ç¬¦åˆæ ¼å¼è¦æ±‚çš„ã€‚\næ­¤å¤–ï¼Œä½ å¯ä»¥è®¤ä¸ºåŸå§‹æ•°æ®ä¸åŒ…å«æ•°å­—ï¼Œæ‰€æœ‰çš„æ•°å­—åªè¡¨ç¤ºé‡å¤çš„æ¬¡æ•° k ï¼Œä¾‹å¦‚ä¸ä¼šå‡ºç°åƒÂ 3aÂ æˆ–Â 2[4]Â çš„è¾“å…¥ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;3[a]2[bc]\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;aaabcbc\u0026rdquo;\nç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;3[a2[c]]\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;accaccacc\u0026rdquo;\nç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;2[abc]3[cd]ef\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;abcabccdcdcdef\u0026rdquo;\nç¤ºä¾‹ 4ï¼š\nè¾“å…¥ï¼šs = \u0026ldquo;abc3[cd]xyz\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;abccdcdcdxyz\u0026rdquo;\næ–¹æ³•1 ä¸¤ä¸ªè¾…åŠ©æ ˆ ä»£ç å¦‚ä¸‹ï¼š\nfunc decodeString(s string) string { resStack := list.New() culStack := list.New() mul, res := 0, \u0026quot;\u0026quot; for _, char := range s { c := byte(char) if c == '[' { resStack.PushBack(res) culStack.PushBack(mul) mul = 0 res = \u0026quot;\u0026quot; } else if c == ']' { var temp string cpop := culStack.Remove(culStack.Back()).(int) for i := 0; i \u0026lt; cpop; i++ { temp += res } rpop := resStack.Remove(resStack.Back()).(string) res = rpop + temp } else if c \u0026gt;= '0' \u0026amp;\u0026amp; c \u0026lt;= '9' { mul = mul*10 + int(c-'0') } else { res += string(c) } } return res } ","date":"2021å¹´04æœˆ19æ—¥","permalink":"/posts/leetcode-394-zi-fu-chuan-jie-ma/","summary":"é¢˜ç›®æè¿° ç»™å®šä¸€ä¸ªç»è¿‡ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè¿”å›å®ƒè§£ç åçš„å­—ç¬¦ä¸²ã€‚\nç¼–ç è§„åˆ™ä¸º: k[encoded_string]ï¼Œè¡¨ç¤ºå…¶ä¸­æ–¹æ‹¬å·å†…éƒ¨çš„ encoded_string æ­£å¥½é‡å¤ k æ¬¡ã€‚æ³¨æ„ k ä¿è¯ä¸ºæ­£æ•´æ•°ã€‚","title":"leetcode 394. å­—ç¬¦ä¸²è§£ç "},{"contents":"æœ‰å¦‚ä¸‹ä»£ç ï¼Œå…ˆä½¿ç”¨ io.Copy å°† request.Body copy åˆ° stdout æ ‡å‡†è¾“å‡ºï¼Œå†ä½¿ç”¨ io.ReadAll å†æ¬¡è¯»å– request.Bodyï¼š\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;io\u0026quot; \u0026quot;os\u0026quot; ) func main() { http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, r *http.Request) { io.WriteString(os.Stdout, \u0026quot;read request body from io.Copy: \u0026quot;) io.Copy(os.Stdout, r.Body) io.WriteString(os.Stdout, \u0026quot;\\n\u0026quot;) body, err := io.ReadAll(r.Body) if err != nil { fmt.Println(\u0026quot;read request body error: \u0026quot;, err) return } fmt.Println(\u0026quot;read request body from io.ReadAll: \u0026quot;, body) }) if err := http.ListenAndServe(\u0026quot;:8080\u0026quot;, nil); err != nil { panic(err) } } ä½¿ç”¨ curl è®¿é—®æ¥å£ï¼š\n$ curl localhost:8080 -d \u0026quot;user=admin\u0026amp;passwd=12345678\u0026quot; # http server è¿™è¾¹çš„è¾“å‡ºï¼š $ go run http_readcloser.go read request body from io.Copy: user=admin\u0026amp;passwd=12345678 read request body from io.ReadAll: [] æ‰§è¡Œæ—¶å‘ç° io.ReadAll() è¯»å‡ºæ¥çš„å†…å®¹å§‹ç»ˆä¸ºç©ºã€‚\nåŸå› ï¼š ã€çŒœæµ‹ã€‘copy() ä¼šå°† src æ¸…ç©ºè€Œä¸æ˜¯ copyï¼Œè¿™å’Œå®ƒçš„å‡½æ•°åä¸ç¬¦ï¼Œ\ncopy å‡½æ•°æ²¡æœ‰é—®é¢˜ï¼Œå¯¹äºè¿™ç§æ ‡å‡†åº“çš„ä¸œè¥¿ä¹Ÿä¸å¯èƒ½çŠ¯è¿™ç§ä½çº§é”™è¯¯ï¼ŒçœŸæ­£çš„åŸå› åœ¨äº http.Request.Bodyã€‚\nhttp.request.Body æ˜¯ readCloser ç±»å‹çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ ReadAll è¯»å– http.request.Body åå°†æ— æ³•å†æ¬¡è¯»å– http.request.Body é‡Œé¢çš„ä¿¡æ¯\nè§£å†³æ–¹æ³• var bodyB []byte bodyB, _ = io.ReadAll(r.Body) fmt.Println(bodyB) // æŠŠåˆšåˆšè¯»å‡ºæ¥çš„å†å†™è¿›å» r.Body = io.NopCloser(bytes.NewReader(bodyB)) all, _ := io.ReadAll(r.Body) fmt.Println(all) ä¸ºä»€ä¹ˆ Request.Body åªèƒ½è¯»å–ä¸€æ¬¡ï¼ˆæœªè§£å†³ï¼‰ NopCloser() è¯¥å‡½æ•°å°†ä¸€ä¸ª reader ç±»å‹åŒ…è£…æˆ readCloser ç±»å‹ï¼Œè€Œç›¸åº”çš„ Close æ–¹æ³•å•¥ä¹Ÿä¸åšï¼Œåªæ˜¯è¿”å› nilã€‚\næºç ï¼š\n// NopCloser returns a ReadCloser with a no-op Close method wrapping // the provided Reader r. func NopCloser(r Reader) ReadCloser { return nopCloser{r} } type nopCloser struct { Reader } ","date":"2021å¹´04æœˆ17æ—¥","permalink":"/posts/goiocopy-de-keng/","summary":"æœ‰å¦‚ä¸‹ä»£ç ï¼Œå…ˆä½¿ç”¨ io.Copy å°† request.Body copy åˆ° stdout æ ‡å‡†è¾“å‡ºï¼Œå†ä½¿ç”¨ io.","title":"goï¼šhttp.Request.Body ç¬¬äºŒæ¬¡è¯»å–ä¸ºç©º "},{"contents":"æƒ…æ™¯ æŸå¤©çªå‘å¥‡æƒ³ï¼Œå†™äº†ä¸€ä¸ªåœ¨çº¿é˜…è¯»çš„ http å°ç¨‹åºï¼Œå½“è®¿é—®æŸä¸€è·¯ç”±æ—¶ä¼šè¯»å–ç”µå­ä¹¦æ–‡ä»¶ï¼Œå¹¶å†™å…¥åˆ° response ä¸­ï¼Œå…¶ä¸­å°è£…äº†ä¸€ä¸ªè¯»å–æ–‡ä»¶çš„å‡½æ•°ï¼š\nfunc ReadFile(src string) ([]byte, error) { file, err := os.Open(src) if err != nil { return nil, err } b, err := io.ReadAll(file) if err != nil { return nil, err } defer file.Close() return b, nil } å¾ˆç®€å•çš„ä¸€ä¸ªå‡½æ•°ï¼Œä½¿ç”¨ io.ReadAll() ï¼ˆåœ¨ go 1.16 ä¸­åºŸå¼ƒäº† ioutilåŒ…ï¼Œå°†å…¶ä¸­çš„å‡½æ•°å…¨éƒ¨ç§»åˆ°äº† io åŒ…ä¸‹ï¼‰è¯»å–æ–‡ä»¶ä¸ºå­—èŠ‚åˆ‡ç‰‡å¹¶è¿”å›ï¼Œè¿™é‡Œè¯»å–çš„æ–‡ä»¶æ˜¯ç”µå­ä¹¦ã€‚\nä½†æ˜¯å½“éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼ˆ1æ ¸ 2g çš„å­¦ç”ŸæœåŠ¡å™¨ï¼‰å¹¶è®¿é—®è·¯ç”±æ—¶ï¼Œäº§ç”Ÿäº† out of memory å¼‚å¸¸ï¼Œè‡´ä½¿ç¨‹åºä¸­æŒ‡ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘è¿˜æœªæ›¾è§è¿‡çš„é”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿæ¯”è¾ƒè¯§å¼‚ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„å°ç¨‹åºä¸ºä»€ä¹ˆä¼šå†…å­˜æº¢å‡ºå‘¢ï¼Ÿ\nä»é”™è¯¯çš„æç¤ºä¿¡æ¯ä¸­ï¼Œå®šä½åˆ°äº†é—®é¢˜çš„æ‰€åœ¨ä¸ºï¼šio.ReadAll()ï¼Œæ—©å°±å¬è¯´è¿‡è¿™ä¸ªå‡½æ•°æ˜¯ä¸€æ¬¡æ€§å°†æ–‡ä»¶å…¨éƒ¨è¯»å–çš„ï¼Œåœ¨æ–‡ä»¶è¾ƒå¤§æ—¶ä¸å»ºè®®ä½¿ç”¨ï¼ˆgo è¯­è¨€åœ£ç»ä¸­æœ‰æåˆ°ï¼‰ï¼Œä½†ä¹Ÿæ²¡å¤ªå½“å›äº‹ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ‰€è°“çš„â€œæ–‡ä»¶è¾ƒå¤§â€è¿‡äºå®½æ³›ï¼Œä½†ç»è¿‡è¿™æ¬¡çš„é”™è¯¯åï¼Œæˆ‘å¯¹æ–‡ä»¶è¾ƒå¤§è¿™ä¸ªæ¦‚å¿µæœ‰äº†æ–°çš„è®¤è¯†ï¼Œåœ¨æˆ‘è¿™å°åœŸè±†æœåŠ¡å™¨ä¸Šï¼Œè¯»å–ä¸€ä¸ª 300m çš„æ–‡ä»¶ä¼šç›´æ¥å¯¼è‡´å†…å­˜æº¢å‡ºï¼ŒæœåŠ¡å™¨çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼šKiB Mem : 1882892 total, 70112 free, 1347204 used ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ ReadAll() è¯»å–ä¸€ä¸ª 300m çš„æ–‡ä»¶ï¼Œä¼šå ç”¨è¶…è¿‡ 700m çš„å†…å­˜ã€‚\nè§£å†³æ–¹æ³• å°† ReadAll() æ›¿æ¢ä¸º io.Copy() å³å¯\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/goioutilreadall-yin-fa-de-out-of-memory/","summary":"æƒ…æ™¯ æŸå¤©çªå‘å¥‡æƒ³ï¼Œå†™äº†ä¸€ä¸ªåœ¨çº¿é˜…è¯»çš„ http å°ç¨‹åºï¼Œå½“è®¿é—®æŸä¸€è·¯ç”±æ—¶ä¼šè¯»å–ç”µå­ä¹¦æ–‡ä»¶ï¼Œå¹¶å†™å…¥åˆ° response ä¸­ï¼Œå…¶ä¸­å°è£…äº†ä¸€ä¸ªè¯»å–æ–‡ä»¶çš„å‡½æ•°ï¼š","title":"goï¼šioutil.ReadAll() å¼•å‘çš„ out of memory "},{"contents":"åœ¨åš å‹ç¼©å­—ç¬¦ä¸² è¿™é“é¢˜æ—¶ï¼Œæäº¤çš„è¾“å‡ºç»“æœååˆ†è¯¡å¼‚ï¼Œå¦‚ä¸‹ï¼š\nè¾“å…¥ï¼š\n[\u0026ldquo;a\u0026rdquo;,\u0026ldquo;a\u0026rdquo;,\u0026ldquo;b\u0026rdquo;,\u0026ldquo;b\u0026rdquo;,\u0026ldquo;c\u0026rdquo;,\u0026ldquo;c\u0026rdquo;,\u0026ldquo;c\u0026rdquo;]\nè¾“å‡ºï¼š\n[\u0026ldquo;a\u0026rdquo;,\u0026quot;\\u0002\u0026quot;,\u0026ldquo;b\u0026rdquo;,\u0026quot;\\u0002\u0026quot;,\u0026ldquo;c\u0026rdquo;,\u0026quot;\\u0003\u0026quot;]\né¢„æœŸï¼š\n[\u0026ldquo;a\u0026rdquo;,\u0026ldquo;2\u0026rdquo;,\u0026ldquo;b\u0026rdquo;,\u0026ldquo;2\u0026rdquo;,\u0026ldquo;c\u0026rdquo;,\u0026ldquo;3\u0026rdquo;]\nå¯ä»¥çœ‹åˆ°ç»“æœä¸­çš„æ•°å­—éƒ¨åˆ†æ˜¯å¯¹çš„ï¼Œä½†æ˜¯å¤šäº† \\u000 è¿™éƒ¨åˆ†ï¼Œè¿™ä¸ªç»“æœä»¤æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œåœ¨ ide ä¸­è¿è¡Œæ—¶æ­£å¸¸çš„ï¼Œä½†åœ¨åŠ›æ‰£ä¸Šè¿è¡Œä¸€ç›´éƒ½ä¼šæœ‰ \\u000 ï¼Œèµ·åˆè¿˜ä»¥ä¸ºæ˜¯åŠ›æ‰£çš„é—®é¢˜ï¼Œåœ¨æŸ¥é˜…èµ„æ–™ä»¥åç»ˆäºæ‰¾åˆ°äº†åŸå› æ‰€åœ¨ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒä½çº§çš„é”™è¯¯ã€‚\nå¤§æ¦‚æ˜¯åŠ›æ‰£ä¼šå°†è¿è¡Œçš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œå­—ç¬¦æ•°ç»„è½¬å­—ç¬¦ä¸²ä¼šæ ¹æ® ascii æ¥æ˜ å°„è½¬æ¢ï¼Œé—®é¢˜æ¥äº†ï¼Œæˆ‘çš„å­—èŠ‚æ•°ç»„é‡Œå­˜å‚¨çš„å…¨éƒ¨éƒ½æ˜¯ 1 - 9 çš„æ•°å­—ï¼Œè€Œä¸æ˜¯æ•°å­—å¯¹åº”çš„ ascii ç ï¼Œæ‰€ä»¥åœ¨è½¬æ¢åæ— æ³•è¾“å‡ºæœ‰æ•ˆå­—ç¬¦ï¼Œè§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦åœ¨å­˜å‚¨çš„å€¼ä¸ŠåŠ  \u0026lsquo;0\u0026rsquo; å³å¯ï¼ˆascii ä¸º48ï¼‰\næ¯”å¦‚ï¼ŒåŸå…ˆçš„å­—èŠ‚æ•°ç»„æ˜¯ [2, 2, 3]ï¼Œå†åŠ  48 ä»¥åï¼Œå˜æˆäº† [50, 50, 51]ï¼Œascii 50 å¯¹åº”åè¿›åˆ¶ 2ï¼Œascii 51 å¯¹åº”åè¿›åˆ¶ 3ï¼Œæ­¤æ—¶è½¬æ¢åçš„ç»“æœå°±æ˜¯æ­£ç¡®çš„äº†ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-13-byte-array/","summary":"åœ¨åš å‹ç¼©å­—ç¬¦ä¸² è¿™é“é¢˜æ—¶ï¼Œæäº¤çš„è¾“å‡ºç»“æœååˆ†è¯¡å¼‚ï¼Œå¦‚ä¸‹ï¼š\nè¾“å…¥ï¼š\n[\u0026ldquo;a\u0026rdquo;,\u0026ldquo;a\u0026rdquo;,\u0026ldquo;b\u0026rdquo;,\u0026ldquo;b\u0026rdquo;,\u0026ldquo;c\u0026rdquo;,\u0026ldquo;c\u0026rdquo;,\u0026ldquo;c\u0026rdquo;]","title":"go å­—èŠ‚æ•°ç»„é”™è¯¯ï¼š\\u0001"},{"contents":"èƒŒæ™¯ï¼š\næœ¬åœ° MacOS ä¸Šé€šè¿‡ GDB è°ƒè¯• golang ç¨‹åºï¼Œç»“æœæç¤º No symbol table is loaded. Use the \u0026ldquo;file\u0026rdquo; command.\nè§£å†³æ–¹æ³•ï¼š\næ‰“åŒ…æ—¶åŠ ä¸Š -ldflags=-compressdwarf=false å‚æ•°å³å¯ æ¯”å¦‚åœ¨ä½œè€…æœ¬åœ°å°±æ˜¯ go build -gcflags \u0026ldquo;-N -l\u0026rdquo; -ldflags=-compressdwarf=false gdb/main.go ç„¶åé€šè¿‡å‘½ä»¤ gdb main å³å¯è°ƒè¯•\nå‚è€ƒï¼šhttps://kaijuan.co/topics/25/no-symbol-table-is-loaded-use-the-file-command\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-4-10-golang-gdb/","summary":"èƒŒæ™¯ï¼š\næœ¬åœ° MacOS ä¸Šé€šè¿‡ GDB è°ƒè¯• golang ç¨‹åºï¼Œç»“æœæç¤º No symbol table is loaded.","title":"Golang GDB è°ƒè¯•æç¤º No symbol table is loaded. Use the \"file\" command"},{"contents":"æƒ…æ™¯æè¿° æœ‰å¦‚ä¸‹ c++ ä»£ç ï¼š\nauto b = vec.begin(); *b = 99999; for (int \u0026amp;i : vec) { cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; \u0026quot; \u0026quot;; // Output: 99999 2 3 4 5 } cout \u0026lt;\u0026lt; endl; auto bb = *vec.begin(); cout \u0026lt;\u0026lt; \u0026quot;bb: \u0026quot; \u0026lt;\u0026lt; bb \u0026lt;\u0026lt; endl; bb = 5; for (int \u0026amp; i : vec) { cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; \u0026quot; \u0026quot;; // Output: 99999 2 3 4 5 } cout \u0026lt;\u0026lt; endl; é€šè¿‡ *b çš„æ–¹å¼å¯ä»¥æ›´æ”¹å…ƒç´ çš„å€¼ï¼Œè€Œ bb åˆ™ä¸è¡Œã€‚è¿™é‡Œæˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ï¼Œ*b å’Œ *vec.begin() éš¾é“ä¸ä¸€æ ·å—ï¼Ÿ\né€šè¿‡ç¼–è¯‘å™¨æŸ¥çœ‹å¾—çŸ¥ï¼Œb çš„ç±»å‹æ˜¯ __wrap_iter\u0026lt;vector\u0026lt;int, allocator\u0026lt;_Tp\u0026gt;\u0026gt;::pointer\u0026gt;ï¼Œbb çš„ç±»å‹æ˜¯ intï¼Œè¿™è®©æˆ‘æœ‰äº†ä¸€äº›æ€è·¯ã€‚\nä¸¾ä¸€ä¸ªæŒ‡é’ˆçš„ä¾‹å­ï¼š\nint i = 5; int *p = \u0026amp;i; // ç±»ä¼¼ä¸Šé¢çš„ b int *b = p; *b = 555; cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; endl; // Output: 555 // ä¿®æ”¹æˆåŠŸ // ç±»ä¼¼ä¸Šé¢çš„ bb int bb = *p; bb = 555; cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; endl; // Output: 5 // æœªä¿®æ”¹ b ä¿å­˜çš„æ˜¯ p æŒ‡å‘çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ iï¼Œæ‰€ä»¥é€šè¿‡è§£å¼•ç”¨ *b çš„æ–¹å¼å¯ä»¥æ›´æ”¹æ‰ i çš„å€¼ï¼Œè€Œ bb ä¿å­˜çš„æ˜¯ p è§£å¼•ç”¨çš„å€¼ï¼Œä»…ä»…æ˜¯ä¸€ä¸ª int å˜é‡ï¼Œè€Œä¸æ˜¯åœ°å€ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå¯¹ i äº§ç”Ÿä»»ä½•å½±å“ã€‚\nè¯´æ˜ é‰´äºè¿˜å¤„äºåˆå­¦ c++ çš„é˜¶æ®µï¼Œå¯¹è¿­ä»£å™¨ä»¥åŠè¯­è¨€æœ¬èº«éƒ½ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥ä»¥ä¸Šä»…ä»…æ˜¯çŒœæƒ³ï¼Œæœ¬æ–‡ä»…åšä¿å­˜è®°å½•ï¼Œæ–¹ä¾¿ä»¥åçš„å›çœ‹ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-4-14-whats-different-in-cpp-iterator-var/","summary":"æƒ…æ™¯æè¿° æœ‰å¦‚ä¸‹ c++ ä»£ç ï¼š\nauto b = vec.","title":"c++ï¼šiterator.begin() å’Œ *iterator.begin() çš„åŒºåˆ« ã€æœªå®Œã€‘"},{"contents":"etcd è¿œç¨‹æ“ä½œå¤±è´¥ï¼šError: context deadline exceeded åœ¨æœåŠ¡å™¨å¯åŠ¨ etcdï¼Œå¹¶åœ¨æœ¬åœ°æœºå™¨é€šè¿‡ etcdctl \u0026ndash;endpoints=http://ip:2379 put name \u0026ldquo;123\u0026rdquo; å‘½ä»¤ï¼Œåœ¨æœåŠ¡å™¨çš„ etcd ä¸­åˆ›å»ºä¸€å¯¹é”®å€¼å¯¹ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næœåŠ¡ç«¯ etcd çš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š\nä½†æ˜¯åœ¨æ‰§è¡Œ etcdctl å‘½ä»¤åå‘ç”Ÿäº†é”™è¯¯ï¼š\nç»è¿‡ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œç»ˆäºæ‰¾åˆ°äº†è§£å†³æ–¹æ³•ï¼Œåœ¨å¯åŠ¨ etcd æ—¶ï¼Œéœ€è¦æ·»åŠ ä¸€äº›å‚æ•°ï¼Œå¦åˆ™è¿œç¨‹è¿æ¥æ— æ³•æ‰§è¡Œï¼Œ\nå®Œæ•´å‘½ä»¤å¦‚ä¸‹ï¼š\n$ ./etcd --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://0.0.0.0:2379 --listen-peer-urls http://0.0.0.0:2380 --initial-advertise-peer-urls http://0.0.0.0:2380 --initial-cluster my-etcd-1=http://0.0.0.0:2380 å°†ipä¸º0.0.0.0å¯ä»¥ç†è§£ä¸ºä¸é™åˆ¶è¿æ¥æœºå™¨ï¼ˆçœŸæ­£çš„ç”Ÿäº§ä¸æ¨èè¿™æ ·è®¾ç½®ï¼‰ã€‚\nä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤å¯åŠ¨ etcd åï¼Œæœ¬åœ°æœºå°±å¯ä»¥æ­£å¸¸çš„å¯¹å…¶æ‰§è¡Œæ“ä½œäº†\nå‚è€ƒï¼šhttps://github.com/yuedun/micro-service/blob/master/README.md\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2020-10-17-etcd-error/","summary":"etcd è¿œç¨‹æ“ä½œå¤±è´¥ï¼šError: context deadline exceeded åœ¨æœåŠ¡å™¨å¯åŠ¨ etcdï¼Œå¹¶åœ¨æœ¬åœ°æœºå™¨é€šè¿‡ etcdctl \u0026ndash;endpoints=http://ip:2379 put name \u0026ldquo;123\u0026rdquo; å‘½ä»¤ï¼Œåœ¨æœåŠ¡å™¨çš„ etcd ä¸­åˆ›å»ºä¸€å¯¹é”®å€¼å¯¹ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š","title":"etcd é”™è¯¯ï¼šcontext deadline exceeded"},{"contents":"é¢˜ç›®æè¿° å­—ç¬¦ä¸²å‹ç¼©ã€‚åˆ©ç”¨å­—ç¬¦é‡å¤å‡ºç°çš„æ¬¡æ•°ï¼Œç¼–å†™ä¸€ç§æ–¹æ³•ï¼Œå®ç°åŸºæœ¬çš„å­—ç¬¦ä¸²å‹ç¼©åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œå­—ç¬¦ä¸²aabcccccaaaä¼šå˜ä¸ºa2b1c5a3ã€‚è‹¥â€œå‹ç¼©â€åçš„å­—ç¬¦ä¸²æ²¡æœ‰å˜çŸ­ï¼Œåˆ™è¿”å›åŸå…ˆçš„å­—ç¬¦ä¸²ã€‚ä½ å¯ä»¥å‡è®¾å­—ç¬¦ä¸²ä¸­åªåŒ…å«å¤§å°å†™è‹±æ–‡å­—æ¯ï¼ˆaè‡³zï¼‰ã€‚\nç¤ºä¾‹1:\nè¾“å…¥ï¼š\u0026ldquo;aabcccccaaa\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;a2b1c5a3\u0026rdquo; ç¤ºä¾‹2:\nè¾“å…¥ï¼š\u0026ldquo;abbccd\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;abbccd\u0026rdquo; è§£é‡Šï¼š\u0026ldquo;abbccd\u0026quot;å‹ç¼©åä¸º\u0026quot;a1b2c2d1\u0026rdquo;ï¼Œæ¯”åŸå­—ç¬¦ä¸²é•¿åº¦æ›´é•¿ã€‚ æç¤ºï¼š\nå­—ç¬¦ä¸²é•¿åº¦åœ¨[0, 50000]èŒƒå›´å†…ã€‚\nåŒæŒ‡é’ˆ ä»£ç \nfunc compressString(S string) string { var sb strings.Builder p, l := 0, 1 // l è®°å½•é•¿åº¦ï¼Œåˆå§‹å€¼ä¸º 1 var cur byte // æŒ‡é’ˆ p ä» 0 å¼€å§‹ï¼Œi ä» 1 å¼€å§‹ for i := 1; i \u0026lt; len(S); i++ { cur = S[p] if S[i] == cur { l++ } else { sb.WriteByte(cur) sb.WriteString(strconv.Itoa(l)) l = 1 // é‡ç½® l } if i == len(S) - 1 { // åˆ°æœ€åä¸€ä¸ª char äº† sb.WriteByte(S[i]) sb.WriteString(strconv.Itoa(l)) } p++ } // å‹ç¼©åæ²¡æœ‰å˜çŸ­åˆ™è¿”å›åŸå…ˆçš„å­—ç¬¦ä¸² // é•¿åº¦ä¸º 1 çš„ä¹Ÿç›´æ¥è¿”å› if sb.Len() \u0026gt;= len(S) || len(S) \u0026lt;= 1 { return S } return sb.String() } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-13-ctcl-0106-compress-string/","summary":"é¢˜ç›®æè¿° å­—ç¬¦ä¸²å‹ç¼©ã€‚åˆ©ç”¨å­—ç¬¦é‡å¤å‡ºç°çš„æ¬¡æ•°ï¼Œç¼–å†™ä¸€ç§æ–¹æ³•ï¼Œå®ç°åŸºæœ¬çš„å­—ç¬¦ä¸²å‹ç¼©åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œå­—ç¬¦ä¸²aabcccccaaaä¼šå˜ä¸ºa2b1c5a3ã€‚è‹¥â€œå‹ç¼©â€åçš„å­—ç¬¦ä¸²æ²¡æœ‰å˜çŸ­ï¼Œåˆ™è¿”å›åŸå…ˆçš„å­—ç¬¦ä¸²ã€‚ä½ å¯ä»¥å‡è®¾å­—ç¬¦ä¸²ä¸­åªåŒ…å«å¤§å°å†™è‹±æ–‡å­—æ¯ï¼ˆaè‡³zï¼‰ã€‚\nç¤ºä¾‹1:\nè¾“å…¥ï¼š\u0026ldquo;aabcccccaaa\u0026rdquo; è¾“å‡ºï¼š\u0026ldquo;a2b1c5a3\u0026rdquo; ç¤ºä¾‹2:","title":"é¢è¯•é¢˜ 01.06. å­—ç¬¦ä¸²å‹ç¼©"},{"contents":"é¢˜ç›®æè¿° ç»Ÿè®¡ä¸€ä¸ªæ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: nums = [5,7,7,8,8,10], target = 8 è¾“å‡º: 2 ç¤ºä¾‹Â 2:\nè¾“å…¥: nums = [5,7,7,8,8,10], target = 6 è¾“å‡º: 0\né™åˆ¶ï¼š\n0 \u0026lt;= æ•°ç»„é•¿åº¦ \u0026lt;= 50000\næ–¹æ³•1ï¼šäºŒåˆ†æŸ¥æ‰¾ è¿™é“é¢˜æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯ä»å¤´éå†ï¼Œå½“è·å–åˆ°å€¼ç­‰äº target çš„å…ƒç´ æ—¶å¼€å§‹ç´¯åŠ æ¬¡æ•°ï¼Œç›´åˆ°å½“å‰å€¼ä¸ç­‰äº targetï¼Œä½†æ˜¯è¿™æ ·åšçš„è¯æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œæ­¤å¤–åƒè¿™ç§æš´åŠ›æ³•ä¹Ÿæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªåˆæ ¼çš„è§£å†³æ–¹æ¡ˆã€‚\nè§£å†³è¿™é“é¢˜çš„å¦ä¸€ç§æ–¹å¼æ˜¯ äºŒåˆ†æŸ¥æ‰¾ï¼Œè¿™é“é¢˜å±äºäºŒåˆ†æŸ¥æ‰¾çš„ä¸€ä¸ªå˜ç§ï¼Œå¸¸è§„çš„äºŒåˆ†æŸ¥æ‰¾ï¼Œåœ¨ nums[mid] == target æ—¶è¿”å›ï¼Œä½†æ˜¯è¿™é“é¢˜è¦æ±‚çš„æ˜¯å¯»æ‰¾å‡º target å‡ºç°çš„æ¬¡æ•°ï¼Œæ‰€ä»¥åŒºåˆ«å°±åœ¨äº nums[mid] == target æ—¶çš„å¤„ç†ã€‚\næ•´é“é¢˜çš„æ€è·¯å¯ä»¥æ˜¯è¿™æ ·ï¼šå…ˆæŸ¥æ‰¾å‡º target æœ€åå‡ºç°çš„ä½ç½®ï¼Œè®°ä¸º leftIndexï¼Œå†æŸ¥æ‰¾å‡º target ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œè®°ä¸º rightIndexï¼Œç„¶åç”¨ leftIndex - rightIndex + 1 å³å¯æ±‚å‡ºå‡ºç°çš„æ¬¡æ•°ã€‚\nè‡³äºäºŒåˆ†æŸ¥æ‰¾çš„ç‰¹æ®Šå¤„ç†ï¼Œå¯ä»¥å°† [mid] == target æ—¶å¤„ç†ä¸º left = mid + 1ã€‚\nå…·ä½“çš„æµç¨‹å¦‚ä¸‹å›¾ï¼š\nä»£ç å¦‚ä¸‹ï¼š\nfunc search(nums []int, target int) int { leftIndex := binarySearch(nums, target) rightIndex := binarySearch(nums, target-1) return leftIndex - rightIndex } func binarySearch(nums []int, target int) int { l, r := 0, len(nums)-1 for l \u0026lt;= r { m := (l + r) \u0026gt;\u0026gt; 1 if nums[m] \u0026lt;= target { l = m + 1 } else { r = m - 1 } } return l } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-17-offer-53-search-sort-array1/","summary":"é¢˜ç›®æè¿° ç»Ÿè®¡ä¸€ä¸ªæ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: nums = [5,7,7,8,8,10], target = 8 è¾“å‡º: 2 ç¤ºä¾‹Â 2:","title":"å‰‘æŒ‡ Offer 53 - I. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾æ•°å­— I"},{"contents":"é¢˜ç›®æè¿° è¾“å…¥ä¸¤ä¸ªé“¾è¡¨ï¼Œæ‰¾å‡ºå®ƒä»¬çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ã€‚\tç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œæ‰¾åˆ°ä¸¤ä¸ªå•é“¾è¡¨ç›¸äº¤çš„èµ·å§‹èŠ‚ç‚¹ã€‚\nå¦‚ä¸‹é¢çš„ä¸¤ä¸ªé“¾è¡¨ï¼š\na1 -\u0026gt; a2 â†˜ c1 -\u0026gt; c2 -\u0026gt; c3 b1 -\u0026gt; b2 -\u0026gt; b3 â†— åœ¨èŠ‚ç‚¹ c1 å¼€å§‹ç›¸äº¤ã€‚\nç¤ºä¾‹ 1ï¼š\n4 -\u0026gt; 1 â†˜ 8 -\u0026gt; 4 -\u0026gt; 5 5 -\u0026gt; 0 -\u0026gt; 1 â†— è¾“å…¥ï¼šintersectVal = 8, listA = [4,1,8,4,5], listB = [5,0,1,8,4,5], skipA = 2, skipB = 3\nè¾“å‡ºï¼šReference of the node with value = 8\nè¾“å…¥è§£é‡Šï¼šç›¸äº¤èŠ‚ç‚¹çš„å€¼ä¸º 8 ï¼ˆæ³¨æ„ï¼Œå¦‚æœä¸¤ä¸ªé“¾è¡¨ç›¸äº¤åˆ™ä¸èƒ½ä¸º 0ï¼‰ã€‚ ä»å„è‡ªçš„è¡¨å¤´å¼€å§‹ç®—èµ·ï¼Œé“¾è¡¨ A ä¸º [4,1,8,4,5]ï¼Œé“¾è¡¨ B ä¸º [5,0,1,8,4,5]ã€‚ åœ¨ A ä¸­ï¼Œç›¸äº¤èŠ‚ç‚¹å‰æœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼›åœ¨ B ä¸­ï¼Œç›¸äº¤èŠ‚ç‚¹å‰æœ‰ 3 ä¸ªèŠ‚ç‚¹ã€‚\nç¤ºä¾‹ 2ï¼š\n2 -\u0026gt; 6 -\u0026gt; 4 1 -\u0026gt; 5\nè¾“å…¥ï¼šintersectVal = 0, listA = [2,6,4], listB = [1,5], skipA = 3, skipB = 2 è¾“å‡ºï¼šnull\nè¾“å…¥è§£é‡Šï¼šä»å„è‡ªçš„è¡¨å¤´å¼€å§‹ç®—èµ·ï¼Œé“¾è¡¨ A ä¸º [2,6,4]ï¼Œé“¾è¡¨ B ä¸º [1,5]ã€‚ ç”±äºè¿™ä¸¤ä¸ªé“¾è¡¨ä¸ç›¸äº¤ï¼Œæ‰€ä»¥ intersectVal å¿…é¡»ä¸º 0ï¼Œè€Œ skipA å’Œ skipB å¯ä»¥æ˜¯ä»»æ„å€¼ã€‚ è§£é‡Šï¼šè¿™ä¸¤ä¸ªé“¾è¡¨ä¸ç›¸äº¤ï¼Œå› æ­¤è¿”å› nullã€‚\nå¦‚æœä¸¤ä¸ªé“¾è¡¨æ²¡æœ‰äº¤ç‚¹ï¼Œè¿”å› null. åœ¨è¿”å›ç»“æœåï¼Œä¸¤ä¸ªé“¾è¡¨ä»é¡»ä¿æŒåŸæœ‰çš„ç»“æ„ã€‚ å¯å‡å®šæ•´ä¸ªé“¾è¡¨ç»“æ„ä¸­æ²¡æœ‰å¾ªç¯ã€‚ ç¨‹åºå°½é‡æ»¡è¶³ O(n) æ—¶é—´å¤æ‚åº¦ï¼Œä¸”ä»…ç”¨ O(1) å†…å­˜ã€‚ æœ¬é¢˜ä¸ä¸»ç«™ 160 é¢˜ç›¸åŒï¼šhttps://leetcode-cn.com/problems/intersection-of-two-linked-lists/\næ–¹æ³•1 åŒæŒ‡é’ˆæ³• å…·ä½“çš„æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š\n/** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */ func getIntersectionNode(headA, headB *ListNode) *ListNode { // ä¸éœ€è¦è¾¹ç•Œæ£€æŸ¥ // if headA == nil || headB == nil { // return nil // } hha, hhb := headA, headB //pa, pb := headA, headB for headA != headB { if headA == nil { headA = hhb } else { headA = headA.Next } if headB == nil { headB = hha } else { headB = headB.Next } } return headA } é”™è¯¯è®°å½• 1.è¶…å‡ºæ—¶é—´é™åˆ¶ /** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */ func getIntersectionNode(headA, headB *ListNode) *ListNode { hha, hhb := headA, headB pa, pb := headA, headB for pa != pb { pa = pa.Next if pa == nil { pa = hhb } pb = pb.Next if pb == nil { pb = hha } } return pa } æµ‹è¯•ç”¨ä¾‹ï¼š\n0 [2,6,4] [1,5] 3 2 åˆ†æï¼šä¸¤ä¸ªé“¾è¡¨åˆ†åˆ«ä¸º 2 -\u0026gt; 6 -\u0026gt; 4 å’Œ 1 -\u0026gt; 5ï¼Œä¸”æ²¡æœ‰äº¤ç‚¹ï¼Œè€Œä¸Šé¢ä»£ç çš„é—®é¢˜åœ¨äºï¼Œå½“æŸä¸ªæŒ‡é’ˆä¸º null æ—¶ï¼Œä¼šç»§ç»­è·³è½¬åˆ°å¦ä¸€ä¸ªé“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œä¸ä¼šåœç•™ã€‚å¯¹åº”ä»£ç ä¸ºï¼š\npa = pa.Next if pa == nil { pa = hhb } å¯¹äºä¸¤ä¸ªä¸ç›¸äº¤çš„é“¾è¡¨è€Œè¨€ï¼Œé€€å‡º while çš„æ¡ä»¶æ˜¯ä¸¤ä¸ªæŒ‡é’ˆéƒ½ä¸º nullï¼Œè€Œä¸Šé¢çš„ä»£ç ä¼šå¯¼è‡´æŒ‡é’ˆæ°¸è¿œä¸ä¸º nullï¼Œ while æ¡ä»¶ pa != pb æ°¸è¿œä¸ä¼šæˆç«‹ï¼Œæ‰€ä»¥ä¼šè¿›å…¥æ­»å¾ªç¯ã€‚\n2.å…¶ä¸­ä¸€ä¸ªé“¾è¡¨ä¸ºç©º /** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */ func getIntersectionNode(headA, headB *ListNode) *ListNode { hha, hhb := headA, headB pa, pb := headA, headB for pa != pb { if pa == nil { pa = hhb } pa = pa.Next if pb == nil { pb = hha } pb = pb.Next } return pa } æµ‹è¯•ç”¨ä¾‹ï¼š\n0 [1,3] [] 2 0 åˆ†æï¼šè§£å†³ä¹‹å‰çš„ è¶…å‡ºæ—¶é—´ é—®é¢˜å¾ˆç®€å•ï¼Œåªè¦è°ƒæ¢ä¸€ä¸‹ pa == nil å’Œ pa = pa.Next çš„ä½ç½®å³å¯ï¼Œç°åœ¨æŒ‡é’ˆä¼šåœç•™åœ¨ null ä¸Šäº†ã€‚\nä½†åˆæœ‰äº†æ–°çš„é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªé“¾è¡¨æœ‰ä¸€ä¸ªä¸ºç©ºï¼Œå¦‚è¿™é‡Œçš„æµ‹è¯•ç”¨ä¾‹ 1 -\u0026gt; 3 å’Œ nullï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªæŒ‡é’ˆç§»åŠ¨åˆ° 3ï¼Œç¬¬äºŒä¸ªé“¾è¡¨çš„æŒ‡é’ˆä¼šç›´æ¥ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªé“¾è¡¨çš„ 1 å¤„ï¼Œæ¥ç€åˆä¼šæ‰§è¡Œ pa = pa.Next ç§»åŠ¨åˆ° 3ï¼Œä¸¤ä¸ªæŒ‡é’ˆçš„èŠ‚ç‚¹ç›¸åŒï¼Œè¿”å›ç»“æœ 3\nè¿™ä¸ªç»“æœæ˜æ˜¾æ˜¯é”™è¯¯çš„ï¼Œæœ‰ä¸€ä¸ªç©ºé“¾è¡¨ï¼Œæ€ä¹ˆå¯èƒ½ä¼šæœ‰äº¤ç‚¹å‘¢ï¼Œé”™è¯¯çš„åŸå› åœ¨äºï¼špa = pa.Next è¿™å¥è¯æ˜¯ä¸€å®šä¼šæ‰§è¡Œçš„ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦ä¸º pa = pa.Next åŠ ä¸€ä¸ª elseï¼Œè®© pa = hhb å’Œ pa = pa.Next åªæœ‰ä¸€ä¸ªèƒ½æ‰§è¡Œå³å¯ï¼Œæ›´æ”¹åå¦‚ä¸‹ã€‚\nif pa == nil { pa = hhb } else { pa = pa.Next } èµ·åˆè¿˜ä»¥ä¸ºæ˜¯è¾¹ç•Œåˆ¤æ–­çš„é—®é¢˜ï¼Œä¸ºæ­¤åŠ ä¸Šäº†åˆ¤æ–­è¯­å¥\nif headA == nil || headB == nil { return nil } åæ¥åˆ†æäº†ä»¥åæ‰å‘ç°ï¼Œè¿™é“é¢˜å¹¶ä¸éœ€è¦è¾¹ç•Œæ£€æŸ¥ã€‚\nä¸€ä¸ªç‰¹æ®Šçš„æµ‹è¯•ç”¨ä¾‹ 3 [3] [2,3] 0 1 ä¸¤ä¸ªé“¾è¡¨åˆ†åˆ«ä¸º 3 å’Œ 2 -\u0026gt; 3ï¼Œåœ¨ 3 å¤„ç›¸äº¤ã€‚\næŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ï¼š ç¬¬ 1 æ¬¡ p1 = 3.Next = null ï¼ˆé“¾è¡¨1ï¼‰ p2 = 2.Next = 3 ï¼ˆé“¾è¡¨2ï¼‰\nç¬¬ 2 æ¬¡ p1 = 2 ï¼ˆé“¾è¡¨2ï¼‰ p2 = 3.Next = null ï¼ˆé“¾è¡¨2ï¼‰\nç¬¬ 3 æ¬¡ p1 = 2.Next = 3 ï¼ˆé“¾è¡¨2ï¼‰ p2 = 3 ï¼ˆé“¾è¡¨1ï¼‰\næ­¤æ—¶è™½ç„¶ä¸¤ä¸ªæŒ‡é’ˆéƒ½ä¸º 3ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªåœ¨é“¾è¡¨1ï¼Œä¸€ä¸ªåœ¨é“¾è¡¨2ï¼ŒæŒ‰ç…§é€»è¾‘ï¼Œå¦‚æœç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä¸¤ä¸ªæŒ‡é’ˆåˆ™éƒ½ä¸º nullï¼Œä¼šè¿”å›é”™è¯¯ç»“æœ æ— äº¤ç‚¹ã€‚\nä½†è¿”å›çš„å´æ˜¯æ­£ç¡®ç»“æœ 3ï¼Œé€ æˆè¿™ä¸€ç»“æœçš„åŸå› ï¼Œåªå¯èƒ½æ˜¯ä¸¤ä¸ªé“¾è¡¨çš„ 3 èŠ‚ç‚¹æ˜¯ç›¸åŒçš„åœ°å€ï¼Œä¸ºäº†éªŒè¯è¿™ä¸€çŒœæƒ³ï¼Œæ‰“å°ä¸€ä¸‹ä¸¤ä¸ªç»“æ„ä½“ï¼š\nfmt.Printf(\u0026quot;h1:%p %v h2:%p %v\\n\u0026quot;, headA, headA, headB, headB) // Output: // h1:0xc00008a320 \u0026amp;{3 \u0026lt;nil\u0026gt;} h2:0xc00008a340 \u0026amp;{2 0xc00008a320} æœçœŸå¦‚æ­¤ï¼Œä¸¤ä¸ªé“¾è¡¨çš„ 3 èŠ‚ç‚¹åœ°å€éƒ½ä¸º 0xc00008a320\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-23-offer-52-get-intersection-node/","summary":"é¢˜ç›®æè¿° è¾“å…¥ä¸¤ä¸ªé“¾è¡¨ï¼Œæ‰¾å‡ºå®ƒä»¬çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ã€‚\tç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œæ‰¾åˆ°ä¸¤ä¸ªå•é“¾è¡¨ç›¸äº¤çš„èµ·å§‹èŠ‚ç‚¹ã€‚\nå¦‚ä¸‹é¢çš„ä¸¤ä¸ªé“¾è¡¨ï¼š\na1 -\u0026gt; a2 â†˜ c1 -\u0026gt; c2 -\u0026gt; c3 b1 -\u0026gt; b2 -\u0026gt; b3 â†— åœ¨èŠ‚ç‚¹ c1 å¼€å§‹ç›¸äº¤ã€‚","title":"å‰‘æŒ‡ Offer 52. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹"},{"contents":"é¢˜ç›®æè¿° ç»™ä½ ä¸€ä¸ªåŒ…å« n ä¸ªæ•´æ•°çš„æ•°ç»„Â numsï¼Œåˆ¤æ–­Â numsÂ ä¸­æ˜¯å¦å­˜åœ¨ä¸‰ ä¸ªå…ƒç´  aï¼Œbï¼Œc ï¼Œä½¿å¾—Â a + b + c = 0 è¯·ä½ æ‰¾å‡ºæ‰€æœ‰å’Œä¸º 0 ä¸”ä¸é‡å¤çš„ä¸‰å…ƒç»„ã€‚\næ³¨æ„ï¼šç­”æ¡ˆä¸­ä¸å¯ä»¥åŒ…å«é‡å¤çš„ä¸‰å…ƒç»„ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šnums = [-1,0,1,2,-1,-4] è¾“å‡ºï¼š[[-1,-1,2],[-1,0,1]] ç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šnums = [] è¾“å‡ºï¼š[] ç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šnums = [0] è¾“å‡ºï¼š[] æç¤ºï¼š\n0 \u0026lt;= nums.length \u0026lt;= 3000 -105 \u0026lt;= nums[i] \u0026lt;= 105\næ–¹æ³•1ï¼šæ’åº + åŒæŒ‡é’ˆ ç®—æ³•æµç¨‹ å¤§è‡´æµç¨‹ï¼š\né¦–å…ˆå°†æ•°ç»„æŒ‰ å‡åº æ’åº å‡†å¤‡ä¸‰ä¸ªæŒ‡é’ˆ kã€iã€j åˆå§‹åŒ–ï¼Œå°† k æ”¾ç½®åœ¨ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œi æ”¾ç½®åœ¨ k+1 å¤„ï¼Œj æ”¾ç½®åœ¨æœ€åä¸€ä¸ªå…ƒç´ å¤„ å¼€å§‹å¾ªç¯ï¼Œæ¡ä»¶ä¸º k \u0026lt; len(nums)-2 å¦‚æœå½“å‰ nums[k] \u0026gt; 0ï¼Œåˆ™ break å¦‚æœ nums[k\u0026ndash;] å’Œ nums[k] ç›¸åŒï¼Œåˆ™ continue å»é‡ å›ºå®š k ï¼Œå…ˆç§»åŠ¨ i å’Œ jï¼Œå½“ i == j æ—¶ï¼Œå†ç§»åŠ¨ k åœ¨ç§»åŠ¨ i å’Œ j æ—¶è®¡ç®— nums[k] + nums[j] + nums[i] çš„å€¼ï¼Œè®°ä¸º s å¦‚æœ s \u0026lt; 0ï¼Œå°† i++ï¼Œå¦‚æœ nums[i++] == nums[i]ï¼Œåˆ™ç»§ç»­ + 1ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä¸å–åˆ°é‡å¤å…ƒç´  å¦‚æœ s \u0026gt; 0ï¼Œå°† j\u0026ndash;ï¼Œå¦‚æœ nums[j\u0026ndash;] == nums[j]ï¼Œåˆ™ç»§ç»­ - 1ï¼ŒåŸå› åŒä¸Š å¦‚æœ s == 0ï¼Œè®°å½•å½“å‰çš„ä¸‰ä¸ªæ•°å­—ï¼Œä¹‹åå°† i++ï¼Œj\u0026ndash;ï¼Œç§»åŠ¨åŒæ—¶å’Œä¸Šé¢ä¸€æ ·ï¼Œè¿›è¡Œå»é‡å¤„ç† åˆ†æï¼š\nå› ä¸ºæ•°ç»„æ˜¯æ’å¥½åºçš„ï¼Œæ‰€ä»¥ k æŒ‡å‘çš„æ˜¯æœ€å°å…ƒç´ ï¼Œi æŒ‡å‘æ¬¡å°å…ƒç´ ï¼Œj æŒ‡å‘æœ€å¤§å…ƒç´ ï¼ˆæ’é™¤ä¸€äº›ç‰¹æ®Šæƒ…å†µæ¯”å¦‚ [0, 0, 0, 0]ï¼‰\nè¿™é‡Œçš„ k èµ·çš„æ˜¯å›ºå®šä½œç”¨ï¼Œç›®çš„æ˜¯æšä¸¾å…¨éƒ¨æƒ…å†µï¼Œå½“ä¸‰ä¸ªå€¼çš„å’Œå°äº 0 æ—¶ï¼Œå¯ä»¥å°† i++ ä½¿å’Œå¢å¤§ï¼ŒåŒç†å½“å’Œå¤§äº 0 æ—¶ï¼Œå¯ä»¥å°† j\u0026ndash; å°†å’Œå‡å°ï¼Œå½“å’Œç­‰äº 0 æ—¶ï¼Œè¯´æ˜æ­¤æ—¶å·²ç»æœé›†åˆ°äº†ç»“æœï¼Œå¯ä»¥å°† k++ è¿›è¡Œä¸‹ä¸ªæ•°çš„æšä¸¾\nç¬¬ 5 æ­¥çš„åŸå› æ˜¯ï¼šå› ä¸º nums[j] \u0026gt;= nums[i] \u0026gt;= nums[k] \u0026gt; 0ï¼Œå³ 3 ä¸ªæ•°å­—éƒ½å¤§äº 0 ï¼Œåœ¨æ­¤å›ºå®šæŒ‡é’ˆ k ä¹‹åä¸å¯èƒ½å†æ‰¾åˆ°ç»“æœäº†ã€‚\nç¬¬ 4 æ­¥çš„æ¡ä»¶ä¸º k \u0026lt; len(nums)-2ï¼ŒåŸå› æ˜¯ i å’Œ j éƒ½åœ¨ k ä¹‹åï¼Œå½“ k åœ¨ len(nums)-2-1 å¤„æ—¶ï¼Œj åœ¨æœ€åä¸€ä¸ªï¼Œi åœ¨å€’æ•°ç¬¬äºŒä¸ªï¼Œkï¼Œiï¼Œj åˆšå¥½å¯¹åº”æœ€åä¸‰ä¸ªæ•°ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºæœ€åä¸€æ¬¡åˆ¤æ–­ã€‚è¿™åªæ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œå¯ä»¥å‡å°‘ 2 æ¬¡ä¸å¿…è¦çš„å¾ªç¯ï¼Œk \u0026lt; len(nums) ä¾ç„¶æ˜¯æ­£ç¡®çš„ã€‚\nå…³äºå»é‡çš„æ¡ä»¶ i \u0026lt; j \u0026amp;\u0026amp; nums[i] == nums[i+1] ä¸­éœ€è¦é¦–å…ˆåˆ¤æ–­ i \u0026lt; j çš„åŸå› æ˜¯é˜²æ­¢è¶Šç•Œï¼Œä¾‹å¦‚ï¼š\næµ‹è¯•ç”¨ä¾‹ [0, 0, 0]ï¼Œk åœ¨ [0]ï¼Œi åœ¨ [1]ï¼Œj åœ¨ [2]ï¼Œsum = 0ï¼Œæ­¤æ—¶å› ä¸º nums[i] == nums[i+1]ï¼Œæ‰€ä»¥æ‰§è¡Œ i++ åˆ° [1]ï¼Œè¿˜æ˜¯é‡å¤ï¼Œç»§ç»­ i++ åˆ° [2]ï¼Œå¦‚æœæ²¡æœ‰ i \u0026lt; j çš„æ¡ä»¶ï¼Œè¿™é‡Œä¼šæ‰§è¡Œåˆ¤æ–­è¯­å¥ nums[i] == nums[i+1] å³ nums[2] == nums[3]ï¼Œè€Œè¿™ä¸ª nums[3] å°±ä¼šå¯¼è‡´è¶Šç•Œè‡´ä½¿ç¨‹åºé”™è¯¯ï¼Œä½†åŠ äº† i \u0026lt; j ä¼šå¯¼è‡´çŸ­è·¯ï¼Œä½¿å¾—åé¢çš„ nums[i] == nums[i+1] ä¸æ‰§è¡Œã€‚\nå¯¹äº i \u0026lt; j \u0026amp;\u0026amp; nums[j] == nums[j-1] ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œè¿˜æ˜¯æµ‹è¯•ç”¨ä¾‹ [0, 0, 0]ï¼Œå¦‚æœæ²¡æœ‰ i \u0026lt; j çš„çº¦æŸï¼Œåˆ™ j ä¼šä¸€ç›´æ‰§è¡Œ j\u0026ndash;ï¼Œå½“ j åˆ°è¾¾ 0 æ—¶ï¼Œ[j-1] å°±ä¼šå‘ç”Ÿæ•°ç»„è¶Šç•Œé—®é¢˜ã€‚\næµç¨‹å¦‚ä¸‹å›¾ï¼š\nä»£ç å¦‚ä¸‹ï¼š\næœªä¼˜åŒ–ç‰ˆï¼Œæ˜¯æˆ‘æ ¹æ®ä¸Šé¢æ€è·¯å†™çš„ï¼š\nfunc threeSum(nums []int) [][]int { res := make([][]int, 0) if len(nums) == 0 { return res } sort.Slice(nums, func(i, j int) bool { return nums[i] \u0026lt; nums[j] }) k := 0 i, j := k+1, len(nums)-1 for k \u0026lt; len(nums)-2 { count++ s := 0 // [-1, 0, 0] if i \u0026gt;= j { k++ continue } if nums[k] \u0026gt; 0 { break } //fmt.Println(k, i, j) s = nums[k] + nums[i] + nums[j] if s \u0026gt; 0 { for i \u0026lt; j \u0026amp;\u0026amp; nums[j] == nums[j-1] { j-- } j-- } else if s \u0026lt; 0 { for i \u0026lt; j \u0026amp;\u0026amp; nums[i] == nums[i+1] { i++ } i++ } else { r := make([]int, 0) r = append(r, nums[k], nums[i], nums[j]) res = append(res, r) for i \u0026lt; j \u0026amp;\u0026amp; nums[i] == nums[i+1] { i++ } for i \u0026lt; j \u0026amp;\u0026amp; nums[j] == nums[j-1] { j-- } i++ j-- } if i \u0026gt;= j { for k \u0026lt; len(nums)-1 \u0026amp;\u0026amp; nums[k] == nums[k+1] { k++ } k++ i, j = k+1, len(nums)-1 } } return res }\tä¼˜åŒ–ç‰ˆï¼Œæ¥è‡ªé¢˜è§£ï¼š\nfunc threeSum1(nums []int) [][]int { sort.Slice(nums, func(i, j int) bool { return nums[i] \u0026lt; nums[j] }) res := make([][]int, 0) for k := 0; k \u0026lt; len(nums)-2; k++ { count++ if nums[k] \u0026gt; 0 { break } if k \u0026gt; 0 \u0026amp;\u0026amp; nums[k] == nums[k-1] { continue } i, j := k+1, len(nums)-1 for i \u0026lt; j { count++ sum := nums[i] + nums[j] + nums[k] if sum \u0026lt; 0 { for i \u0026lt; j \u0026amp;\u0026amp; nums[i] == nums[i+1] { i++ } i++ } else if sum \u0026gt; 0 { for i \u0026lt; j \u0026amp;\u0026amp; nums[j] == nums[j-1] { j-- } j-- } else { r := make([]int, 0) r = append(r, nums[k], nums[i], nums[j]) res = append(res, r) for i \u0026lt; j \u0026amp;\u0026amp; nums[i] == nums[i+1] { i++ } i++ for i \u0026lt; j \u0026amp;\u0026amp; nums[j] == nums[j-1] { j-- } j-- } } } return res } ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œæ—¶é—´ç›¸å·®äº†ä¸‰åå€ï¼ä¸çŸ¥é“ä¸ºä½•æ€§èƒ½å·®è·ä¼šå¦‚æ­¤ä¹‹å¤§ï¼Œå¯èƒ½æ˜¯æˆ‘å†™çš„å†—ä½™åˆ¤æ–­æ¡ä»¶å¤ªå¤šäº†ï¼Œæš‚æ—¶ä¹Ÿæ²¡æœ‰å»ä»”ç»†åˆ†æçš„æƒ³æ³•ï¼Œåªèƒ½è¯´æ˜è‡ªå·±çš„é€»è¾‘èƒ½åŠ›è¿˜æ˜¯èœçš„æŠ è„šï¼Œè¿˜éœ€è¦å¤šå¤šå»ç»ƒä¹ æ‰è¡Œã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-24-leet-15-three-sum/","summary":"é¢˜ç›®æè¿° ç»™ä½ ä¸€ä¸ªåŒ…å« n ä¸ªæ•´æ•°çš„æ•°ç»„Â numsï¼Œåˆ¤æ–­Â numsÂ ä¸­æ˜¯å¦å­˜åœ¨ä¸‰ ä¸ªå…ƒç´  aï¼Œbï¼Œc ï¼Œä½¿å¾—Â a + b + c = 0 è¯·ä½ æ‰¾å‡ºæ‰€æœ‰å’Œä¸º 0 ä¸”ä¸é‡å¤çš„ä¸‰å…ƒç»„ã€‚","title":"leetcode 15. ä¸‰æ•°ä¹‹å’Œ"},{"contents":"é¢˜ç›®æè¿° ä»¥æ•°ç»„ intervals è¡¨ç¤ºè‹¥å¹²ä¸ªåŒºé—´çš„é›†åˆï¼Œå…¶ä¸­å•ä¸ªåŒºé—´ä¸º intervals[i] = [starti, endi] ã€‚ è¯·ä½ åˆå¹¶æ‰€æœ‰é‡å çš„åŒºé—´ï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸é‡å çš„åŒºé—´æ•°ç»„ï¼Œè¯¥æ•°ç»„éœ€æ°å¥½è¦†ç›–è¾“å…¥ä¸­çš„æ‰€æœ‰åŒºé—´ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šintervals = [[1,3],[2,6],[8,10],[15,18]] è¾“å‡ºï¼š[[1,6],[8,10],[15,18]] è§£é‡Šï¼šåŒºé—´ [1,3] å’Œ [2,6] é‡å , å°†å®ƒä»¬åˆå¹¶ä¸º [1,6].\nç¤ºä¾‹Â 2ï¼š\nè¾“å…¥ï¼šintervals = [[1,4],[4,5]] è¾“å‡ºï¼š[[1,5]] è§£é‡Šï¼šåŒºé—´ [1,4] å’Œ [4,5] å¯è¢«è§†ä¸ºé‡å åŒºé—´ã€‚\nåˆ†æ å¦‚ä½•åˆ¤æ–­åŒºé—´æ˜¯å¦é‡å ï¼Œéœ€è¦æ¯”è¾ƒç¬¬äºŒä¸ªæ•°ç»„çš„é¦–å…ƒç´ æ˜¯å¦å°äºå‰ä¸€ä¸ªæ•°ç»„çš„å°¾å…ƒç´ ï¼Œä¾‹å¦‚ [1,5],[2,6]ï¼Œ2 æ˜¯å°äº 6 çš„ï¼Œæ‰€ä»¥å­˜åœ¨é‡å ï¼Œ è€Œ [2,6],[8,10] ä¸­ï¼Œ8 å¤§äº 6ï¼Œæ‰€ä»¥åŒºé—´ä¸é‡å ã€‚åˆ¤æ–­æ˜¯å¦é‡å å¹¶ä¸éš¾ï¼Œéš¾çš„åœ¨äºåˆå¹¶ã€‚\nè€ƒè™‘å¦‚ä¸‹å‡ ç§æƒ…å†µï¼š\né‡å ï¼Œä¸¤ä¸ªæ•°ç»„çš„å°¾å…ƒç´ ç›¸åŒï¼Œä¾‹å¦‚ï¼š[[1,4],[0,4]] =\u0026gt; [0, 4] é‡å ï¼Œç¬¬äºŒä¸ªæ•°ç»„çš„å°¾å…ƒç´ å¤§äºç¬¬ä¸€ä¸ªæ•°ç»„çš„å°¾å…ƒç´ ï¼š[[1,5],[2,6]] =\u0026gt; [1, 6] é‡å ï¼Œç¬¬äºŒä¸ªæ•°ç»„çš„å°¾å…ƒç´ å°äºç¬¬ä¸€ä¸ªæ•°ç»„çš„å°¾å…ƒç´ ï¼š[[1,5],[2,4]] =\u0026gt; [1, 5] é‡å ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„çš„é¦–å…ƒç´ å¤§äºç¬¬äºŒä¸ªæ•°ç»„çš„é¦–å…ƒç´ ï¼š[[1,4],[0,1]] =\u0026gt; [1, 4] é‡å ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„çš„é¦–å…ƒç´ å°äºç¬¬äºŒä¸ªæ•°ç»„çš„é¦–å…ƒç´ ï¼š[[0,4],[1,2]] =\u0026gt; [1, 4] æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œ[[1,4],[0,0]] =\u0026gt; [[0,0],[1,4]] ç­‰ç­‰å…¶ä»–æƒ…å†µ å¯ä»¥çœ‹åˆ°æƒ…å†µæœ‰å¾ˆå¤šç§ï¼Œè€Œæˆ‘çš„ç¬¬ä¸€æƒ³æ³•ä¹Ÿæ˜¯ç²—æš´çš„ if elseï¼Œäºæ˜¯å†™å‡ºäº†ä¸‹é¢çš„ä¸‘é™‹ä»£ç ï¼š\nfunc merge(intervals [][]int) [][]int { res := make([][]int, 0) res = append(res, intervals[0]) // ä¸Šä¸€ä¸ªæ•°ç»„çš„ä¸‹æ ‡ prev := 0 //start, end := intervals[0][0], intervals[0][1] for i := 1; i \u0026lt; len(intervals); i++ { // ä¸Šä¸€ä¸ªæ•°ç»„çš„ [0] å’Œ [1] prevs, preve := intervals[prev][0], intervals[prev][1] // å½“å‰æ•°ç»„çš„ [0] å’Œ [1] curs, cure := intervals[i][0], intervals[i][1] if curs \u0026lt;= preve \u0026amp;\u0026amp; cure \u0026gt; preve { // [[1,5],[2,6]] if curs \u0026lt; prevs { // [[1,4],[0,5]] r := []int{curs, cure} res[i-1] = r prev = i - 1 } else { r := []int{prevs, cure} res[i-1] = r prev = i - 1 } } else if curs \u0026lt;= preve \u0026amp;\u0026amp; cure \u0026lt;= preve { // [[1,5],[2,4]] if curs \u0026lt; prevs { // [[1,4],[0,4]] [[1,4],[0,1]] r := []int{curs, preve} res[i-1] = r prev = i - 1 } else if cure \u0026lt; prevs { // [[1,4],[0,0]] res = append(res, intervals[i]) swap(res, i, prev) } else { continue } } else { res = append(res, intervals[i]) } } return res } func swap(nums [][]int, i, j int) { nums[i], nums[j] = nums[j], nums[i] } è¿™æ˜¯åœ¨æäº¤å¤±è´¥äº† n æ¬¡çš„åŸºç¡€ä¸Šä¸æ–­ä¿®æ”¹çš„ï¼Œæ¯ä¸ª if åˆ†æ”¯éƒ½æ ‡æ˜äº†å¯¹åº”çš„æƒ…å†µï¼Œä½†æ˜¯ï¼Œè¿˜æ˜¯é‡åˆ°äº†ä¸€ç§ç‰¹æ®Šçš„æµ‹è¯•ç”¨ä¾‹ï¼š[[1,4],[0,0]]ï¼Œæˆ‘çš„ä»£ç è¿è¡Œçš„ç»“æœæ˜¯ [0,4]ï¼Œä½†æ˜¯æ­£ç¡®ç­”æ¡ˆæ˜¯ [[0,0],[1,4]]ï¼Œä¸ºäº†å¯¹ä»˜è¿™ç§æƒ…å†µï¼Œæˆ‘åˆå†™äº†ä¸€ä¸ª swap å‡½æ•°æ¥åº”å¯¹ã€‚è€ƒè™‘çš„æƒ…å†µè¶Šæ¥è¶Šå¤šï¼Œä»£ç ä¹Ÿè¶Šæ¥è¶Šä¸‘ï¼Œæœ€å…³é”®çš„æ˜¯ï¼Œæäº¤è¿˜å§‹ç»ˆæ— æ³•é€šè¿‡ã€‚æ— å¥ˆåªèƒ½çœ‹é¢˜è§£äº†ï¼Œ\næ–¹æ³• æ’åº + åŒæŒ‡é’ˆ è¿™ä¸ªæ’åºæˆ‘æ˜¯ä¸‡ä¸‡æ²¡æƒ³åˆ°çš„ï¼Œæ ¹æ®æ•°ç»„çš„å·¦å…ƒç´ è¿›è¡Œæ’åºï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥å®Œç¾å¤„ç† [[1,4],[0,0]] è¿™ç§æƒ…å†µäº†ã€‚\nè¿™é‡Œç›´æ¥è´´ä¸Šæ¥è‡ªé¢˜è§£ä¸­çš„ä»£ç ï¼Œéå¸¸ç›´è§‚æ˜“æ‡‚ä¸”ç®€æ´ï¼Œå·§å¦™çš„ä½¿ç”¨äº† max å‡½æ•°æ¥åˆå¹¶åŒºé—´ï¼Œæ¯”æˆ‘å‚»å‚»çš„å†™çš„ä¸€å † if else ä¼˜é›…å¤šäº†ã€‚ ï¼ˆæ¥è‡ª https://leetcode-cn.com/problems/merge-intervals/solution/shou-hua-tu-jie-56he-bing-qu-jian-by-xiao_ben_zhu/ï¼‰\nfunc merge(intervals [][]int) [][]int { sort.Slice(intervals, func(i, j int) bool { return intervals[i][0] \u0026lt; intervals[j][0] }) res := [][]int{} prev := intervals[0] for i := 1; i \u0026lt; len(intervals); i++ { cur := intervals[i] if prev[1] \u0026lt; cur[0] { // æ²¡æœ‰ä¸€ç‚¹é‡åˆ res = append(res, prev) prev = cur } else { // æœ‰é‡åˆ prev[1] = max(prev[1], cur[1]) } } res = append(res, prev) return res } func max(a, b int) int { if a \u0026gt; b { return a } return b } è¿™é‡Œç”¨ prev æ¥ä¿å­˜ä¸Šä¸€ä¸ªæ•°ç»„ï¼Œåˆå§‹ä¿å­˜çš„æ˜¯ç¬¬ 0 ä¸ªï¼Œç„¶å for ä» 1 å¼€å§‹ï¼Œå³ç”¨ç¬¬ 1 ä¸ªå’Œç¬¬ 0 ä¸ªè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ²¡æœ‰é‡åˆï¼Œåˆ™ append å¹¶æ›´æ–° prev ä¸ºå½“å‰æ•°ç»„ï¼Œæœ‰é‡åˆï¼Œåˆ™å¯¹ prev è¿›è¡Œåˆå¹¶ï¼Œå› ä¸ºå·²ç»æ’å¥½åºäº†ï¼Œæ‰€ä»¥å‰ä¸€ä¸ªçš„ [0] æ˜¯ä¸€å®šå°äºåä¸€ä¸ªçš„ [0]ï¼Œåªéœ€è¦æ¯”è¾ƒ å‰ä¸€ä¸ªçš„[1] å’Œåä¸€ä¸ªçš„ [1] å³å¯ï¼Œè¿™é‡Œç”¨äº† max å‡½æ•°æ¥æ¯”è¾ƒã€‚\nç‰¹åˆ«æ³¨æ„ä¸€ä¸‹æœ€åçš„ res = append(res, prev) ï¼Œæ²¡æœ‰è¿™å¥è¯ä¼šå¯¼è‡´é”™è¯¯ã€‚\nåŸå› ï¼šfor æ˜¯ä»ç¬¬äºŒä¸ªæ•°ç»„å¼€å§‹åˆ¤æ–­çš„ï¼Œå¹¶ä¸æ–­ä¸å‰ä¸€ä¸ªæ•°ç»„æ¯”è¾ƒï¼Œå¦‚æœä¸åœ¨ for å¤–é¢å†å®šä¹‰ä¸€æ¬¡ res = append(res, prev)ï¼Œåˆ™ä¼šå¯¼è‡´ç»“æœç¼ºå¤±çš„æƒ…å†µã€‚\nä¾‹å¦‚ï¼š[[1,3]]ï¼Œæ­¤æ—¶éƒ½ä¸ä¼šè¿›å…¥ for ï¼Œå¦‚æœæ²¡æœ‰æœ«å°¾çš„è¿™å¥è¯ï¼Œä¼šç›´æ¥å¯¼è‡´ç»“æœä¸ºç©ºã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-26-leet-56-merge-interval/","summary":"é¢˜ç›®æè¿° ä»¥æ•°ç»„ intervals è¡¨ç¤ºè‹¥å¹²ä¸ªåŒºé—´çš„é›†åˆï¼Œå…¶ä¸­å•ä¸ªåŒºé—´ä¸º intervals[i] = [starti, endi] ã€‚ è¯·ä½ åˆå¹¶æ‰€æœ‰é‡å çš„åŒºé—´ï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸é‡å çš„åŒºé—´æ•°ç»„ï¼Œè¯¥æ•°ç»„éœ€æ°å¥½è¦†ç›–è¾“å…¥ä¸­çš„æ‰€æœ‰åŒºé—´ã€‚","title":"LeetCode 56. åˆå¹¶åŒºé—´"},{"contents":"ç®—æ³•æè¿° è¿™ä¸æ˜¯ä¸€é“åŠ›æ‰£æˆ–è€…å‰‘æŒ‡ä¸Šçš„åŸé¢˜ï¼Œä½†å´æ˜¯äºŒå‰æ ‘é—®é¢˜çš„ä¸€ä¸ªåŸºç¡€æ ¸å¿ƒç®—æ³•ï¼Œé€‚ç”¨äºè®¸å¤šäºŒå‰æ ‘ç±»å‹çš„é¢˜ç›®ï¼Œæ¯”å¦‚ å‰‘æŒ‡ Offer 68 - II. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œå› ä¸ºè¿™é‡Œæœ‰å¿…è¦è®°å½•ä¸€ä¸‹ï¼Œå¤§è‡´çš„è¯´æ˜å¦‚ä¸‹ï¼š\nä¾‹å¦‚å¦‚ä¸‹ä¸€é¢—äºŒå‰æ ‘ï¼š\nå½“æŒ‡å®šèŠ‚ç‚¹ä¸º 4 æ—¶ï¼Œè¾“å‡º [3,5,2,4]\næ–¹æ³•1 å›æº¯ï¼Œæœ‰è¿”å›å€¼ ä»£ç å¦‚ä¸‹ï¼Œå‚è€ƒ\n// æ‰¾åˆ°æ ¹èŠ‚ç‚¹åˆ°æŸä¸€èŠ‚ç‚¹çš„è·¯å¾„ func findPath(node, need *TreeNode, // node: å½“å‰èŠ‚ç‚¹ï¼Œneed: æŒ‡å®šèŠ‚ç‚¹ path, res *[]*TreeNode, // path: è®°å½•å½“å‰è·¯å¾„ res: ä¿å­˜ç»“æœè·¯å¾„ flag *bool) []*TreeNode {\t// flag: ç”¨æ¥æ ‡è¯†æ˜¯å¦å·²ç»æ‰¾åˆ°ç»“æœï¼Œä½œä¸ºé€’å½’ç»ˆæ­¢çš„æ¡ä»¶ if node == nil || *flag { return *res } *path = append(*path, node) // æ‰¾åˆ°æŒ‡å®šçš„èŠ‚ç‚¹äº†ï¼Œå°† flag æ›´æ”¹ä¸º trueï¼ŒåŒæ—¶å°†å½“å‰è·¯å¾„æ·»åŠ åˆ° res ä½œä¸ºç»“æœ if node == need { *flag = true *res = *path } // å…ˆæ‰¾å·¦å­æ ‘ï¼Œå†æ‰¾å³å­æ ‘ findPath(node.Left, need, path, res, flag) findPath(node.Right, need, path, res, flag) // å›æº¯ï¼Œåœ¨ path ä¸­ç§»é™¤å½“å‰èŠ‚ç‚¹ *path = (*path)[:len(*path)-1] rr := make([]*TreeNode, len(*res)) // å› ä¸º slice å…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œç¬¬äºŒæ¬¡ä¼šæ›´æ”¹ç¬¬ä¸€æ¬¡çš„ç»“æœï¼Œ // æ‰€ä»¥éœ€è¦ copy ä¸€ä¸ªæ–° slice copy(rr, *res) return rr } path å’Œ res éƒ½éœ€è¦ä¸ºæŒ‡é’ˆåˆ‡ç‰‡ï¼Œå› ä¸º append ä¼šå¯¼è‡´åœ°å€å˜æ›´ï¼Œflag ä¸ºäº†ä¿è¯é€’å½’å‚æ•°ä¼ é€’çš„çŠ¶æ€ä¸€è‡´ï¼Œä¹Ÿéœ€è¦ä¸ºæŒ‡é’ˆç±»å‹ï¼Œå…¶ä»–çš„éƒ½å†™åœ¨æ³¨é‡Šä¸­äº†ï¼Œç‰¹åˆ«éœ€è¦è¯´æ˜çš„æ˜¯æœ€åçš„ copyï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è¸©çš„ä¸€ä¸ªå‘ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ï¼š\nå¼•ç”¨ ç®—æ³• ä¸­çš„äºŒå‰æ ‘ï¼Œæ±‚ 1 å’Œ 4 ä¸¤ä¸ªèŠ‚ç‚¹çš„è·¯å¾„ï¼Œæ­£ç¡®ç»“æœåº”è¯¥ä¸º [3,1] å’Œ [3,5,2,4]ä½†æ˜¯æœ€åè¿è¡Œçš„ç»“æœå´æ˜¯ [3,5] å’Œ [3,5,2,4]ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n// p = 1 pr := findPath(root, p, \u0026amp;path, \u0026amp;res, \u0026amp;flag) flag = false // p = 4 qr := findPath(root, q, \u0026amp;path, \u0026amp;res, \u0026amp;flag) for i := 0; i \u0026lt; len(pr); i++ { fmt.Printf(\u0026quot;%v \u0026quot;, pr[i]) // Output: [3, 5] } fmt.Println() for i := 0; i \u0026lt; len(qr); i++ { fmt.Printf(\u0026quot;%v \u0026quot;, qr[i]) // Output: [3,5,2,4] } æˆ‘åˆå°è¯•å°† pr çš„è¾“å‡ºè¯­å¥ç§»åŠ¨è‡³ qr å‰ï¼Œç»“æœæ˜¯æ­£ç¡®çš„ï¼š\n// p = 1 pr := findPath(root, p, \u0026amp;path, \u0026amp;res, \u0026amp;flag) for i := 0; i \u0026lt; len(pr); i++ { fmt.Printf(\u0026quot;%v \u0026quot;, pr[i]) // Output: [3, 1] } fmt.Println() flag = false // p = 4 qr := findPath(root, q, \u0026amp;path, \u0026amp;res, \u0026amp;flag) for i := 0; i \u0026lt; len(qr); i++ { fmt.Printf(\u0026quot;%v \u0026quot;, qr[i]) // Output: [3,5,2,4] } åŸå› æ˜¯å› ä¸ºæˆ‘åˆšå¼€å§‹åœ¨å‡½æ•°ä¸­è¿”å›çš„æ˜¯ *resï¼Œè€Œ *res = *path ï¼Œå³è®© res çš„åº•å±‚æ•°ç»„æŒ‡é’ˆæŒ‡å‘äº† path çš„åº•å±‚æ•°ç»„ï¼Œ ä¼ å…¥çš„ path éƒ½æ˜¯åŒä¸€ä¸ªï¼Œè¿™æ ·ç¬¬äºŒæ¬¡å¯»æ‰¾è·¯å¾„æ—¶ï¼Œpath ä¼šæ”¹å˜ï¼Œè¿™ä¼šä½¿å¾—æŒ‡å‘ path çš„ res ä¹Ÿè·Ÿç€æ”¹å˜ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡è¿è¡Œæ—¶ä¼šå°† res çš„ [1] æ”¹ä¸º [5]ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯æ–°å®šä¹‰ä¸€ä¸ª sliceï¼Œå¹¶ copyï¼Œå†è¿”å›è¿™ä¸ªæ–° slice å³å¯ã€‚\næ­¤å¤–ï¼Œflag å‚æ•°ä¹Ÿä¸éœ€è¦ä¼ é€’æŒ‡é’ˆç±»å‹ï¼Œåªè¦ bool å³å¯ã€‚\næ–¹æ³•2 å›æº¯ï¼Œæ— è¿”å›å€¼ æ–¹æ³• 1 ä¸­çš„è¿”å›å€¼å…¶å®å®Œå…¨æ˜¯å¤šä½™çš„ï¼Œå‚æ•° res å·²ç»ä¿å­˜äº†ç»“æœï¼Œå®Œå…¨å¯ä»¥ä¸éœ€è¦è¿”å›å€¼ï¼Œå¦‚ä¸‹ï¼š\nfunc findPath(root, need *TreeNode, path, res *[]*TreeNode, flag *bool) { if root == nil || *flag { return } *path = append(*path, root) if root == need { *flag = true // copy ä¸€ä¸ªæ–°åˆ‡ç‰‡ï¼Œé˜²æ­¢å¤šä¸ª res æŒ‡å‘åŒä¸€ä¸ª path news := make([]*TreeNode, len(*path)) copy(news, *path) *res = news return } findPath(root.Left, need, path, res, flag) findPath(root.Right, need, path, res, flag) *path = (*path)[:len(*path)-1] return } func main() { var path, pp, qq []*TreeNode var flag bool findPath(root, p, \u0026amp;path, \u0026amp;pp, \u0026amp;flag) // é‡ç½®å‚æ•° flag = false path = path[0:0] findPath(root, q, \u0026amp;path, \u0026amp;qq, \u0026amp;flag) // æ­¤æ—¶ pp å’Œ qq å·²ç»ä¿å­˜äº†ç»“æœ } æœ‰æ— è¿”å›å€¼çš„æ€§èƒ½å·®å¼‚ åœ¨ å‰‘æŒ‡ Offer 68 - II. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ è¿™é“é¢˜ä¸­ï¼Œæœ‰ä¸€ä¸ªéå¸¸é•¿çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆå¯èƒ½æœ‰ä¸Šä¸‡ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨æœ‰è¿”å›å€¼çš„æ–¹æ³•ä¼šè¶…æ—¶ï¼Œå³ä½¿è¿”å›æŒ‡é’ˆä¹Ÿä¸€æ ·è¶…æ—¶ï¼Œè€Œæ— è¿”å›å€¼åˆ™æ­£å¸¸ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¿”å›å€¼éœ€è¦æ‹·è´çš„ç¼˜æ•…ï¼Œè€Œä¸”æ–¹æ³• 1 çš„è¿”å›å€¼æœ¬èº«å°±æ˜¯ä¸€ä¸ªå†—ä½™çš„ä¸œè¥¿ï¼Œæ—¢ç„¶éƒ½å·²ç»æä¾›äº† res å‚æ•°ç”¨æ¥ä¿å­˜ç»“æœï¼Œå°±ä¸éœ€è¦å†è¿”å›äº†ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-27-find-binarytree-root-to-node-path/","summary":"ç®—æ³•æè¿° è¿™ä¸æ˜¯ä¸€é“åŠ›æ‰£æˆ–è€…å‰‘æŒ‡ä¸Šçš„åŸé¢˜ï¼Œä½†å´æ˜¯äºŒå‰æ ‘é—®é¢˜çš„ä¸€ä¸ªåŸºç¡€æ ¸å¿ƒç®—æ³•ï¼Œé€‚ç”¨äºè®¸å¤šäºŒå‰æ ‘ç±»å‹çš„é¢˜ç›®ï¼Œæ¯”å¦‚ å‰‘æŒ‡ Offer 68 - II.","title":"æ±‚äºŒå‰æ ‘æ ¹èŠ‚ç‚¹åˆ°æŒ‡å®šèŠ‚ç‚¹çš„è·¯å¾„"},{"contents":"é¢˜ç›®æè¿° ç»™ä½ ä¸¤ä¸ªç‰ˆæœ¬å· version1 å’Œ version2 ï¼Œè¯·ä½ æ¯”è¾ƒå®ƒä»¬ã€‚\nç‰ˆæœ¬å·ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä¿®è®¢å·ç»„æˆï¼Œå„ä¿®è®¢å·ç”±ä¸€ä¸ª \u0026lsquo;.\u0026rsquo; è¿æ¥ã€‚æ¯ä¸ªä¿®è®¢å·ç”± å¤šä½æ•°å­— ç»„æˆï¼Œå¯èƒ½åŒ…å« å‰å¯¼é›¶ ã€‚æ¯ä¸ªç‰ˆæœ¬å·è‡³å°‘åŒ…å«ä¸€ä¸ªå­—ç¬¦ã€‚ä¿®è®¢å·ä»å·¦åˆ°å³ç¼–å·ï¼Œä¸‹æ ‡ä» 0 å¼€å§‹ï¼Œæœ€å·¦è¾¹çš„ä¿®è®¢å·ä¸‹æ ‡ä¸º 0 ï¼Œä¸‹ä¸€ä¸ªä¿®è®¢å·ä¸‹æ ‡ä¸º 1 ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä¾‹å¦‚ï¼Œ2.5.33 å’Œ 0.1 éƒ½æ˜¯æœ‰æ•ˆçš„ç‰ˆæœ¬å·ã€‚\næ¯”è¾ƒç‰ˆæœ¬å·æ—¶ï¼Œè¯·æŒ‰ä»å·¦åˆ°å³çš„é¡ºåºä¾æ¬¡æ¯”è¾ƒå®ƒä»¬çš„ä¿®è®¢å·ã€‚æ¯”è¾ƒä¿®è®¢å·æ—¶ï¼Œåªéœ€æ¯”è¾ƒ å¿½ç•¥ä»»ä½•å‰å¯¼é›¶åçš„æ•´æ•°å€¼ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®è®¢å· 1 å’Œä¿®è®¢å· 001 ç›¸ç­‰ ã€‚å¦‚æœç‰ˆæœ¬å·æ²¡æœ‰æŒ‡å®šæŸä¸ªä¸‹æ ‡å¤„çš„ä¿®è®¢å·ï¼Œåˆ™è¯¥ä¿®è®¢å·è§†ä¸º 0 ã€‚ä¾‹å¦‚ï¼Œç‰ˆæœ¬ 1.0 å°äºç‰ˆæœ¬ 1.1 ï¼Œå› ä¸ºå®ƒä»¬ä¸‹æ ‡ä¸º 0 çš„ä¿®è®¢å·ç›¸åŒï¼Œè€Œä¸‹æ ‡ä¸º 1 çš„ä¿®è®¢å·åˆ†åˆ«ä¸º 0 å’Œ 1 ï¼Œ0 \u0026lt; 1 ã€‚\nè¿”å›è§„åˆ™å¦‚ä¸‹ï¼š\nå¦‚æœ version1 \u0026gt; version2 è¿”å› 1ï¼Œ å¦‚æœ version1 \u0026lt; version2 è¿”å› -1ï¼Œ é™¤æ­¤ä¹‹å¤–è¿”å› 0ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼šversion1 = \u0026ldquo;1.01\u0026rdquo;, version2 = \u0026ldquo;1.001\u0026rdquo; è¾“å‡ºï¼š0 è§£é‡Šï¼šå¿½ç•¥å‰å¯¼é›¶ï¼Œ\u0026ldquo;01\u0026rdquo; å’Œ \u0026ldquo;001\u0026rdquo; éƒ½è¡¨ç¤ºç›¸åŒçš„æ•´æ•° \u0026ldquo;1\u0026rdquo; ç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼šversion1 = \u0026ldquo;1.0\u0026rdquo;, version2 = \u0026ldquo;1.0.0\u0026rdquo; è¾“å‡ºï¼š0 è§£é‡Šï¼šversion1 æ²¡æœ‰æŒ‡å®šä¸‹æ ‡ä¸º 2 çš„ä¿®è®¢å·ï¼Œå³è§†ä¸º \u0026ldquo;0\u0026rdquo; ç¤ºä¾‹ 3ï¼š\nè¾“å…¥ï¼šversion1 = \u0026ldquo;0.1\u0026rdquo;, version2 = \u0026ldquo;1.1\u0026rdquo; è¾“å‡ºï¼š-1 è§£é‡Šï¼šversion1 ä¸­ä¸‹æ ‡ä¸º 0 çš„ä¿®è®¢å·æ˜¯ \u0026ldquo;0\u0026rdquo;ï¼Œversion2 ä¸­ä¸‹æ ‡ä¸º 0 çš„ä¿®è®¢å·æ˜¯ \u0026ldquo;1\u0026rdquo; ã€‚0 \u0026lt; 1ï¼Œæ‰€ä»¥ version1 \u0026lt; version2 ç¤ºä¾‹ 4ï¼š\nè¾“å…¥ï¼šversion1 = \u0026ldquo;1.0.1\u0026rdquo;, version2 = \u0026ldquo;1\u0026rdquo; è¾“å‡ºï¼š1 ç¤ºä¾‹ 5ï¼š\nè¾“å…¥ï¼šversion1 = \u0026ldquo;7.5.2.4\u0026rdquo;, version2 = \u0026ldquo;7.5.3\u0026rdquo; è¾“å‡ºï¼š-1\næç¤ºï¼š\n1 \u0026lt;= version1.length, version2.length \u0026lt;= 500 version1 å’Œ version2 ä»…åŒ…å«æ•°å­—å’Œ \u0026lsquo;.\u0026rsquo; version1 å’Œ version2 éƒ½æ˜¯ æœ‰æ•ˆç‰ˆæœ¬å· version1 å’Œ version2 çš„æ‰€æœ‰ä¿®è®¢å·éƒ½å¯ä»¥å­˜å‚¨åœ¨ 32 ä½æ•´æ•° ä¸­\nç®—æ³•è®¾è®¡ 1.åˆ‡å‰²æ¯”è¾ƒ æ€è·¯ï¼šä½¿ç”¨ strings.split() å‡½æ•°ï¼ŒæŒ‰ . åˆ‡å‰²ï¼Œå†ä½¿ç”¨ atoi() å°†åˆ‡å‰²å¥½çš„å­—ç¬¦è½¬æ¢ä¸ºæ•´å½¢ï¼Œå¹¶ä¸€ä¸€æ¯”è¾ƒã€‚\nä¸Šé¢çš„é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªç‰ˆæœ¬å·é•¿åº¦ä¸åŒï¼Œä¾‹å¦‚ 1.0 å’Œ 1.0.0ï¼Œåˆ‡å‰²å‡ºçš„æ•°ç»„åˆ†åˆ«ä¸º [1, 0] å’Œ [1, 0, 0]ï¼ŒæŒ‰ä¸‹æ ‡é€ä¸€æ¯”è¾ƒï¼Œä¼šæœ‰ä¸€ä¸ªå‡ºç°è¶Šç•Œå¼‚å¸¸\nè§£å†³æ–¹æ³•ï¼šå¯¹è¾ƒçŸ­çš„æ•°ç»„è¿›è¡Œæ‰©å……ï¼Œä½¿äºŒè€…é•¿åº¦ç›¸åŒï¼Œæ‰©å……å…ƒç´ ä¸º 0ï¼Œå› ä¸º 0 ä¸ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥å°† 1 æ‰©å……ä¸º [1, 0, 0]ï¼Œè¿™æ ·å°±å¯ä»¥å®‰å…¨æ¯”è¾ƒäº†ã€‚\nä»£ç å¦‚ä¸‹ï¼š\nfunc compareVersion(version1 string, version2 string) int { v1arr := strings.Split(version1, \u0026quot;.\u0026quot;) v2arr := strings.Split(version2, \u0026quot;.\u0026quot;) // ä¸ºè¾ƒçŸ­æ•°ç»„å¡«å…… 0ï¼Œä½¿ä¸¤ä¸ªæ•°ç»„çš„é•¿åº¦ç›¸åŒ if len(v1arr) \u0026gt; len(v2arr) { sub := len(v1arr) - len(v2arr) for sub \u0026gt; 0 { v2arr = append(v2arr, \u0026quot;0\u0026quot;) sub-- } } else if len(v1arr) \u0026lt; len(v2arr) { sub := len(v2arr) - len(v1arr) for sub \u0026gt; 0 { v1arr = append(v1arr, \u0026quot;0\u0026quot;) sub-- } } for i := 0; i \u0026lt; len(v1arr); i++ { // è½¬æ¢ä¸ºæ•´å½¢æ¯”è¾ƒï¼Œæ— éœ€æ‹…å¿ƒ 001 è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œatoi() ä¼šæ™ºèƒ½çš„å°†å…¶è½¬æ¢ä¸º 1 v1i, _ := strconv.Atoi(v1arr[i]) v2i, _ := strconv.Atoi(v2arr[i]) if v1i \u0026gt; v2i { return 1 } else if v1i \u0026lt; v2i { return -1 } else { continue } } return 0 } 2.åŒæŒ‡é’ˆ ç¬¬ä¸€ç§æ–¹æ³•æ¯”è¾ƒç›´è§‚æ˜“æ‡‚ï¼Œä½†æ˜¯éœ€è¦é¢å¤–çš„ç©ºé—´ï¼Œè¿˜éœ€è¦å¤šæ¬¡éå†ï¼Œæ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œè€ŒåŒæŒ‡é’ˆæ³•å¯ä»¥è§£å†³ä¸Šè¿°çš„é—®é¢˜ã€‚\næ€è·¯ï¼šå‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«ç½®äºä¸¤ä¸ªç‰ˆæœ¬å·çš„å¼€å¤´ï¼Œä¹‹åä¸æ–­ç§»åŠ¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œç›´åˆ°éƒ½åˆ°è¾¾æœ«å°¾ã€‚åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªå˜é‡ v1ï¼Œv2 ç”¨äºä¿å­˜å½“å‰å°ç‰ˆæœ¬å·çš„å€¼ï¼Œå¦‚ä½•è·å–å°ç‰ˆæœ¬å·çš„å€¼å‘¢ï¼Ÿåªéœ€è¦ä½¿ç”¨ while å¾ªç¯ä¸æ–­ç§»åŠ¨æŒ‡é’ˆï¼Œå½“æŒ‡é’ˆå€¼ä¸º . æ—¶åœæ­¢ï¼Œæ¯æ¬¡å¾ªç¯éƒ½å°† v1 = v1 + æŒ‡é’ˆå€¼ - \u0026lsquo;0\u0026rsquo;ï¼Œ\nfunc compareVersion(version1 string, version2 string) int { l1, l2 := len(version1), len(version2) p1, p2 := 0, 0 // è·å–æœ€å¤§å€¼ var maxFunc = func(x, y int) int { if x \u0026gt; y { return x } else { return y } } max := maxFunc(l1, l2) for p1 \u0026lt; max || p2 \u0026lt; max { var v1, v2 int // ä½¿ç”¨ while æ¥å¾ªç¯è¯»å–ä¸€ä¸ªå°ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ 1.111 ä¸­çš„ 1 å’Œ 111 å°±æ˜¯å°ç‰ˆæœ¬å·ï¼‰ï¼Œ // é‡åˆ° . åœæ­¢ï¼Œæ­¤æ—¶ vv1, vv2 çš„å€¼å³æ˜¯å°ç‰ˆæœ¬å·ï¼Œvv1 å’Œ vv2 å®šä¹‰åœ¨å¤–å±‚ for å†…ï¼Œ // æ¯æ¬¡æ¯”è¾ƒåéƒ½ä¼šæ¸…é›¶ for p1 \u0026lt; l1 \u0026amp;\u0026amp; version1[p1] != '.' { v1 = v1*10 + int(version1[p1]) - '0' p1++ } for p2 \u0026lt; l2 \u0026amp;\u0026amp; version2[p2] != '.' { v2 = v2*10 + int(version2[p2]) - '0' p2++ } if v1 \u0026gt; v2 { return 1 } else if v1 \u0026lt; v2 { return -1 } p1++ p2++ } return 0 } é”™è¯¯è®°å½• 1. è¶…å‡ºæ—¶é—´é™åˆ¶ func compareVersion(version1 string, version2 string) int { p1, p2 := 0, 0 for p1 \u0026lt; len(version1) || p2 \u0026lt; len(version2) { v1, v2 := 0, 0 for p1 \u0026lt; len(version1) \u0026amp;\u0026amp; version1[p1] != '.' { v, _ := strconv.Atoi(string(version1[p1])) v1 += v p1++ } for p2 \u0026lt; len(version2) \u0026amp;\u0026amp; version1[p2] != '.' { v, _ := strconv.Atoi(string(version1[p2])) v2 += v p2++ } if v1 \u0026gt; v2 { return 1 } else if v1 \u0026lt; v2 { return -1 } } return 0 } è¿™é‡Œè¶…æ—¶çš„åŸå› æ˜¯æœ«å°¾æ²¡æœ‰ p1++ å’Œ p2++ï¼Œå½“ p1 å’Œ p2 éƒ½ä¸º \u0026lsquo;.\u0026rsquo; æ—¶ï¼Œp1 å’Œ p2 å°†ä¸ä¼šæœ‰ä»»ä½•æ”¹å˜ï¼Œè¿™ä¼šå¯¼è‡´ while æ¡ä»¶ä¸€ç›´æ»¡è¶³ï¼Œä»è€Œé™·å…¥æ­»å¾ªç¯ã€‚\næ‰€ä»¥æœ«å°¾çš„ p1++ å’Œ p2++ å°±æ˜¯ç”¨æ¥ä¿è¯å½“ p1ï¼Œp2 éƒ½ä¸º \u0026lsquo;.\u0026rsquo; æ—¶ä»ç„¶ä¼šç§»åŠ¨ï¼Œé˜²æ­¢æ­»å¾ªç¯çš„å‘ç”Ÿã€‚\n2. è§£ç­”é”™è¯¯ func compareVersion(version1 string, version2 string) int { p1, p2 := 0, 0 for p1 \u0026lt; len(version1) || p2 \u0026lt; len(version2) { v1, v2 := 0, 0 for p1 \u0026lt; len(version1) \u0026amp;\u0026amp; version1[p1] != '.' { v, _ := strconv.Atoi(string(version1[p1])) v1 += v p1++ } for p2 \u0026lt; len(version2) \u0026amp;\u0026amp; version2[p2] != '.' { v, _ := strconv.Atoi(string(version2[p2])) v2 += v p2++ } if v1 \u0026gt; v2 { return 1 } else if v1 \u0026lt; v2 { return -1 } p1++ p2++ } return 0 } æµ‹è¯•ç”¨ä¾‹ï¼š\n\u0026quot;1.1\u0026quot; \u0026quot;1.10\u0026quot; è¿™é‡Œé”™è¯¯çš„åŸå› æ˜¯å› ä¸ºå¯¹äºå°ç‰ˆæœ¬å·åªæ˜¯å•çº¯çš„ç›¸åŠ æ“ä½œï¼Œå¯¹äº 1.10 çš„ç¬¬äºŒä¸ªå°ç‰ˆæœ¬è€Œè¨€ï¼Œç»“æœä¸º 1 + 0 = 1ï¼Œä»è€Œå¯¼è‡´é”™è¯¯ç»“æœ 1.1 = 1.10ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†å¯¹åº”å°ç‰ˆæœ¬å·ä» string è½¬ä¸º intï¼Œå…·ä½“æ–¹æ³•æ˜¯ v = v*10 + s[i] - \u0026lsquo;0\u0026rsquo;ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-5-leet-165-compare-version-numbers/","summary":"é¢˜ç›®æè¿° ç»™ä½ ä¸¤ä¸ªç‰ˆæœ¬å· version1 å’Œ version2 ï¼Œè¯·ä½ æ¯”è¾ƒå®ƒä»¬ã€‚","title":"LeetCode165.æ¯”è¾ƒç‰ˆæœ¬å·"},{"contents":"é¢˜ç›®æè¿° æŠŠä¸€ä¸ªæ•°ç»„æœ€å¼€å§‹çš„è‹¥å¹²ä¸ªå…ƒç´ æ¬åˆ°æ•°ç»„çš„æœ«å°¾ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ•°ç»„çš„æ—‹è½¬ã€‚è¾“å…¥ä¸€ä¸ªé€’å¢æ’åºçš„æ•°ç»„çš„ä¸€ä¸ªæ—‹è½¬ï¼Œè¾“å‡ºæ—‹è½¬æ•°ç»„çš„æœ€å°å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œæ•°ç»„ [3,4,5,1,2] ä¸º [1,2,3,4,5] çš„ä¸€ä¸ªæ—‹è½¬ï¼Œè¯¥æ•°ç»„çš„æœ€å°å€¼ä¸º1ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼š[3,4,5,1,2] è¾“å‡ºï¼š1 ç¤ºä¾‹ 2ï¼š\nè¾“å…¥ï¼š[2,2,2,0,1] è¾“å‡ºï¼š0\nå›¾ç‰‡æ¥æºï¼šhttps://leetcode-cn.com/problems/xuan-zhuan-shu-zu-de-zui-xiao-shu-zi-lcof/solution/mian-shi-ti-11-xuan-zhuan-shu-zu-de-zui-xiao-shu-3/\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€è°“çš„æ—‹è½¬æ•°ç»„ï¼Œå®è´¨ä¸Šæ˜¯å˜æˆäº†ä¸¤ä¸ªæœ‰åºæ•°ç»„ï¼Œä¸”å·¦è¾¹çš„æœ‰åºæ•°ç»„è¦å¤§äºå³è¾¹çš„æœ‰åºæ•°ç»„ï¼Œæ‰€ä»¥å³è¾¹çš„æœ‰åºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œå°±æ˜¯æ•´ä¸ªæ•°ç»„ä¸­çš„æœ€å°å€¼ã€‚\näºŒåˆ†æŸ¥æ‰¾ï¼Œæ˜¯é€šè¿‡æ¯æ¬¡ç¼©çŸ­æŸ¥æ‰¾åŒºé—´æ¥å‡å°‘æŸ¥æ‰¾çš„æ¬¡æ•°ï¼Œä½†å‰ææ˜¯æ•°ç»„å¿…é¡»æ˜¯æœ‰åºçš„ï¼Œè€Œæ—‹è½¬æ•°ç»„æ°å¥½ç ´åäº†æ•°ç»„çš„æœ‰åºæ€§ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨æ—‹è½¬æ•°ç»„å°±ä¸èƒ½ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥è§£å†³é—®é¢˜äº†ã€‚\næ€è·¯ è¿˜æ˜¯å’Œå¸¸è§„çš„äºŒåˆ†æŸ¥æ‰¾ä¸€æ ·ï¼Œå…ˆåˆ›å»ºä¸¤ä¸ªæŒ‡é’ˆï¼ˆleft å’Œ rightï¼‰ï¼Œåˆ†åˆ«ç½®äºæ•°ç»„çš„ç¬¬ä¸€ä¸ªæ•°ï¼ˆleftï¼‰å’Œæœ€åä¸€ä¸ªæ•°ï¼ˆrightï¼‰ï¼Œå¹¶ç›¸åŠ é™¤ä»¥äºŒæ±‚å‡ºä¸­ä½ æ¥ä¸‹æ¥åˆ¤æ–­ä¸­ä½å±äºå“ªä¸ªæœ‰åºæ•°ç»„ï¼Œæ˜¯å·¦è¾¹çš„è¿˜æ˜¯å³è¾¹çš„ï¼Œå…·ä½“çš„åˆ¤æ–­æ–¹æ³•åé¢ä¼šæåˆ° åœ¨ç¡®å®šäº†å±äºå“ªä¸ªæœ‰åºæ•°ç»„åï¼Œå°±å¯ä»¥åƒæ™®é€šçš„äºŒåˆ†æŸ¥æ‰¾ä¸€æ ·ï¼Œå»æ‰ä¸€éƒ¨åˆ†çš„æŸ¥æ‰¾åŒºé—´äº†ï¼Œå¦‚ä½•å»é™¤ï¼Œåé¢ä¼šæåˆ° ä¸æ–­æ›´æ–°æŒ‡é’ˆï¼Œç›´åˆ°ä¸¤ä¸ªæŒ‡é’ˆåœ¨åŒä¸€ä½ç½® 1.å¦‚ä½•åˆ¤æ–­ä¸­ä½å±äºå·¦è¾¹è¿˜æ˜¯å³è¾¹ï¼Ÿ\nå¦‚æœä¸­ä½å€¼ å¤§äº right çš„å€¼ï¼Œè¯´æ˜åœ¨å·¦è¾¹æ•°ç»„ å¦‚æœä¸­ä½å€¼ å°äº right çš„å€¼ï¼Œè¯´æ˜åœ¨å³è¾¹æ•°ç»„\nä¾‹å¦‚ï¼š [4, 5, 1, 2, 3]ï¼Œä¸­ä½å€¼ä¸º 1ï¼Œå°äº right 3ï¼Œæ‰€ä»¥åœ¨å³è¾¹æ•°ç»„ [3, 4, 5, 1, 2]ï¼Œä¸­ä½å€¼ä¸º 5ï¼Œå¤§äº right 2ï¼Œæ‰€ä»¥åœ¨å·¦è¾¹æ•°ç»„\n2.åœ¨ç¡®å®šäº†ä¸­ä½æ‰€å±æ•°ç»„åï¼Œå¦‚ä½•ç¼©çŸ­æŸ¥æ‰¾ç©ºé—´ï¼Ÿ\nå› ä¸ºå·¦æ•°ç»„è¦å¤§äºå³æ•°ç»„ï¼Œæ‰€ä»¥ï¼š\nå¦‚æœä¸­ä½åœ¨å³æ•°ç»„ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥å»æ‰å·¦æ•°ç»„ï¼Œä¾‹å¦‚ [4, 5, 1, 2, 3]ï¼Œå·¦æ•°ç»„ [4, 5] æ˜¯è¦å¤§äºå³æ•°ç»„ [1, 2, 3] çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å»æ‰ 4, 5 è¿™ä¸¤ä¸ªå…ƒç´ ï¼Œä½†å…¶æœ¬èº«æœ‰å¯èƒ½æ˜¯æœ€å°å…ƒç´ ï¼Œæ‰€ä»¥ä¸èƒ½å»é™¤ã€‚\nå¦‚æœä¸­ä½åœ¨å·¦æ•°ç»„ï¼Œé‚£ä¹ˆå¯ä»¥å»æ‰å…¶å·¦è¾¹çš„æ‰€æœ‰å…ƒç´ ä»¥åŠå®ƒè‡ªå·±ï¼Œå› ä¸ºå·¦æ•°ç»„æ˜¯è¦å¤§äºå³æ•°ç»„çš„ï¼Œä¾‹å¦‚ [3, 4, 5, 1, 2]ï¼Œå¯ä»¥ç›´æ¥å°† 3ï¼Œ4ï¼Œ5å…¨éƒ¨å»æ‰\nå¦‚æœä¸­ä½åœ¨å³æ•°ç»„ï¼Œé‚£ä¹ˆå¯ä»¥å»æ‰å…¶å³è¾¹çš„æ‰€æœ‰å…ƒç´ ï¼Œå› ä¸ºè¿™äº›å…ƒç´ æ˜¯ä¸€å®šæ¯”å®ƒå¤§çš„ï¼Œä¾‹å¦‚ [5, 1, 2, 3, 4]ï¼Œä¸­ä½æ‰€å¤„æ•°ç»„ä¸º [1, 2, 3, 4]ï¼Œå®ƒå³è¾¹çš„ 3 å’Œ 4 å¯ä»¥ç›´æ¥å»é™¤æ‰ã€‚\nä¸€ç§ç‰¹æ®Šæƒ…å†µï¼š [1, 0, 1, 1, 1]ï¼Œä¸­ä½çš„å€¼å’Œ right å€¼ç›¸ç­‰ï¼Œè¿™æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå‚ç…§åŠ›æ‰£çš„é¢˜è§£è¯´æ³•ï¼šé‡åˆ° nums[mid] == nums[right] çš„æ—¶å€™ï¼Œä¸èƒ½è‰ç‡åœ°ä¸‹å®šç»“è®ºæœ€å°æ•°å­—åœ¨å“ªä¸€è¾¹ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šçš„æ˜¯ï¼ŒæŠŠ right èˆå¼ƒæ‰ï¼Œå¹¶ä¸å½±å“ç»“æœã€‚\nå›¾è§£ å›¾ç‰‡æ¥æºï¼šhttps://leetcode-cn.com/problems/xuan-zhuan-shu-zu-de-zui-xiao-shu-zi-lcof/solution/mian-shi-ti-11-xuan-zhuan-shu-zu-de-zui-xiao-shu-3/\nä»£ç  func minArray(numbers []int) int { left, right := 0, len(numbers)-1 for left \u0026lt; right { mid := (left + right) \u0026gt;\u0026gt; 1 // åœ¨ç¬¬ä¸€ä¸ªæ•°ç»„ if numbers[mid] \u0026gt; numbers[right] { left = mid + 1 } else if numbers[mid] \u0026lt; numbers[right] { // åœ¨ç¬¬äºŒä¸ª right = mid } else { right-- } } return numbers[left] } é”™è¯¯è®°å½•/æ€è€ƒ ä¸ºä»€ä¹ˆåˆ¤æ–­æ˜¯å¦åœ¨ç¬¬ä¸€ä¸ªæ•°ç»„ï¼Œå¿…é¡»ç”¨ mid å’Œ right æ¯”è¾ƒï¼Œè€Œä¸èƒ½å’Œ left æ¯”è¾ƒï¼Ÿæ¯”å¦‚ [3, 4, 5, 1, 2]ï¼Œå¯ä»¥é€šè¿‡ mid \u0026gt; right å¾—åˆ°åœ¨ç¬¬ä¸€ä¸ªæ•°ç»„ï¼Œä½†åŒæ ·ä¹Ÿå¯ä»¥ç”¨ mid \u0026gt; left åˆ¤æ–­å‡ºåŒæ ·çš„ç»“æœã€‚\né¦–å…ˆå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œmid å’Œ left æ¯”è¾ƒä¼šå‡ºé”™ï¼Œæ¯”å¦‚è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ [1, 1, 0, 1, 1]ï¼Œä¸¤ç§æ¯”è¾ƒæ–¹å¼ç»“æœå¦‚ä¸‹å›¾ï¼š\nå¯¹äºè¿™æ ·ä¸€ç§ç‰¹æ®Šæ—‹è½¬æ•°ç»„ [1, 2, 3, 4, 5] ï¼ˆå³æ—‹è½¬äº† 0 ä¸ªæ•°ï¼‰ï¼Œæ­¤æ—¶ mid æ— æ³•ç¡®å®šå±äºå“ªä¸ªæ•°ç»„ï¼Œä¸”ä¹Ÿä¸ç¬¦åˆä¹‹å‰çš„å·¦æ•°ç»„å¤§äºå³æ•°ç»„çš„æ¡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸ right æ¯”è¾ƒæ˜¯å®‰å…¨çš„ï¼Œè¿™ä¼šå°†å…¶åˆ†é…åˆ°å³æ•°ç»„ [3, 4, 5]ï¼Œå¹¶å°†æœç´¢åŒºé—´è½¬ç§»åˆ°å·¦éƒ¨åˆ† [1, 2, 3]ã€‚\nå¦‚æœä¸ left æ¯”è¾ƒï¼Œä¼šé”™è¯¯çš„åˆ†é…åˆ°å³æ•°ç»„ [1, 2, 3]ï¼Œå¹¶å°†è¿™éƒ¨åˆ†ä»æœç´¢åŒºé—´ä¸­å»é™¤ï¼Œç•™ä¸‹ [4, 5]ï¼Œç»“æœä¹Ÿæ˜¾ç„¶æ„è§æ˜¯é”™è¯¯çš„ã€‚\nç»¼ä¸Šï¼Œè¦é¿å…ä¸ left æ¯”è¾ƒã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-3-6-offer-11-retate-array-min-num/","summary":"é¢˜ç›®æè¿° æŠŠä¸€ä¸ªæ•°ç»„æœ€å¼€å§‹çš„è‹¥å¹²ä¸ªå…ƒç´ æ¬åˆ°æ•°ç»„çš„æœ«å°¾ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ•°ç»„çš„æ—‹è½¬ã€‚è¾“å…¥ä¸€ä¸ªé€’å¢æ’åºçš„æ•°ç»„çš„ä¸€ä¸ªæ—‹è½¬ï¼Œè¾“å‡ºæ—‹è½¬æ•°ç»„çš„æœ€å°å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œæ•°ç»„ [3,4,5,1,2] ä¸º [1,2,3,4,5] çš„ä¸€ä¸ªæ—‹è½¬ï¼Œè¯¥æ•°ç»„çš„æœ€å°å€¼ä¸º1ã€‚","title":"å‰‘æŒ‡ Offer 11. æ—‹è½¬æ•°ç»„çš„æœ€å°æ•°å­—"},{"contents":"é¢˜ç›®æè¿° ç»™å®šä¸€ä¸ªäºŒå‰æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚\nç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œæ»¡è¶³ x æ˜¯ pã€q çš„ç¥– å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€\nä¾‹å¦‚ï¼Œç»™å®šå¦‚ä¸‹äºŒå‰æ ‘:\nroot =Â [3,5,1,6,2,0,8,null,null,7,4] ç¤ºä¾‹ 1:\nè¾“å…¥: root = [3,5,1,6,2,0,8,null,null,7,4], p = 5, q = 1 è¾“å‡º: 3 è§£é‡Š: èŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 1 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 3ã€‚\nç¤ºä¾‹Â 2:\nè¾“å…¥: root = [3,5,1,6,2,0,8,null,null,7,4], p = 5, q = 4 è¾“å‡º: 5 è§£é‡Š: èŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 5ã€‚å› ä¸ºæ ¹æ®å®š ä¹‰æœ€è¿‘å…¬å…±ç¥–å…ˆèŠ‚ç‚¹å¯ä»¥ä¸ºèŠ‚ç‚¹æœ¬èº«ã€‚\nç®—æ³•è®¾è®¡ æ–¹æ³•1. é€’å½’ è¿™æ¬¡ä¸å¤š bb ç›´æ¥ä¸Šä»£ç ï¼š\nä»£ç ï¼š /** * Definition for a binary tree node. * type TreeNode struct { * Val int * Left *TreeNode * Right *TreeNode * } */ func lowestCommonAncestor(root, p, q *TreeNode) *TreeNode { if root == nil || root == p || root == q { return root } // è®°å½•å·¦å­æ ‘éƒ¨åˆ†æ˜¯å¦æœ‰ p æˆ– qï¼Œå¦‚æœæœ‰ï¼Œåˆ™ left çš„å€¼ä¸º p æˆ– q çš„æŸ // ä¸€çˆ¶èŠ‚ç‚¹ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯ p æˆ– qæœ¬èº«ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸º null left := lowestCommonAncestor(root.Left, p, q) // è®°å½•å³å­æ ‘éƒ¨åˆ†æ˜¯å¦æœ‰ p æˆ– qï¼Œå¦‚æœæœ‰ï¼Œåˆ™ left çš„å€¼ä¸º p æˆ– q çš„æŸ // ä¸€çˆ¶èŠ‚ç‚¹ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯ p æˆ– qæœ¬èº«ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸º null right := lowestCommonAncestor(root.Right, p, q) // left ä¸ºç©ºï¼Œè¯´æ˜å·¦å­æ ‘éƒ¨åˆ†æ²¡æœ‰ pï¼Œqï¼Œè¿”å› rightï¼Œå³åœ¨å³å­æ ‘éƒ¨åˆ† // æ‰¾åˆ°çš„ç»“æœ if left == nil { return right // åŒç†å¦‚ä¸Š } else if right == nil { return left } // left å’Œ right éƒ½ä¸ä¸ºç©ºï¼Œè¯´æ˜ pï¼Œq åœ¨å¼‚ä¾§ï¼Œæ­¤æ—¶å½“å‰èŠ‚ç‚¹ root // å°±æ˜¯å®ƒä»¬çš„å…¬å…±çˆ¶èŠ‚ç‚¹ return root } é€’å½’åˆ†æ é€’å½’æµç¨‹å›¾ é€’å½’è¿‡ç¨‹ ï¼ˆå‹˜è¯¯ï¼šp=7ï¼Œq=4 è¿™ä¸€æ­¥çš„å›¾ç‰‡æµç¨‹çš„ç¬¬ 2 æ­¥ï¼Œåº”è¯¥æ˜¯ï¼šè¯´æ˜è¯¥èŠ‚ç‚¹åœ¨å…¶å³å­æ ‘ï¼Œå›¾ç‰‡ä¸­é”™è¯¯çš„å†™æˆäº†ï¼šè¯´æ˜è¯¥èŠ‚ç‚¹åœ¨å…¶å·¦å­æ ‘ï¼Œè¿™é‡Œæ‡’å¾—å†ä¿®æ”¹å›¾ç‰‡äº†ï¼Œç›´æ¥æ–‡å­—è¯´æ˜ï¼‰\næ–‡å­—åˆ†æ é€’å½’è§£æï¼š\nç»ˆæ­¢æ¡ä»¶ï¼š å½“è¶Šè¿‡å¶èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è¿”å› nullï¼› å½“ root ç­‰äº p, qï¼Œåˆ™ç›´æ¥è¿”å› rootï¼› é€’æ¨å·¥ä½œï¼š å¼€å¯é€’å½’å·¦å­èŠ‚ç‚¹ï¼Œè¿”å›å€¼è®°ä¸º leftï¼› å¼€å¯é€’å½’å³å­èŠ‚ç‚¹ï¼Œè¿”å›å€¼è®°ä¸º rightï¼› è¿”å›å€¼ï¼š æ ¹æ® left å’Œ right ï¼Œå¯å±•å¼€ä¸ºå››ç§æƒ…å†µï¼› å½“ left å’Œ right åŒæ—¶ä¸ºç©º ï¼šè¯´æ˜ root çš„å·¦ / å³å­æ ‘ä¸­éƒ½ä¸åŒ…å« p,q ï¼Œè¿”å› nullï¼› å½“ left å’Œ right åŒæ—¶ä¸ä¸ºç©º ï¼šè¯´æ˜ p, q åˆ†åˆ—åœ¨ root çš„ å¼‚ä¾§ ï¼ˆåˆ†åˆ«åœ¨ å·¦ / å³å­æ ‘ï¼‰ï¼Œå› æ­¤ root ä¸ºæœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œè¿”å› rootï¼› å½“ left ä¸ºç©º ï¼Œright ä¸ä¸ºç©º ï¼šp,q éƒ½ä¸åœ¨ root çš„å·¦å­æ ‘ä¸­ï¼Œç›´æ¥è¿”å› right ã€‚å…·ä½“å¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š p,q å…¶ä¸­ä¸€ä¸ªåœ¨ root çš„ å³å­æ ‘ ä¸­ï¼Œæ­¤æ—¶ right æŒ‡å‘ ppï¼ˆå‡è®¾ä¸º pp ï¼‰ï¼› p,q ä¸¤èŠ‚ç‚¹éƒ½åœ¨ root çš„ å³å­æ ‘ ä¸­ï¼Œæ­¤æ—¶çš„ right æŒ‡å‘ æœ€è¿‘å…¬å…±ç¥–å…ˆèŠ‚ç‚¹ ï¼› å½“ left ä¸ä¸ºç©º ï¼Œ right ä¸ºç©º ï¼šä¸æƒ…å†µ 3. åŒç†ï¼› å‚è€ƒ\né€’å½’åœ¨å‘ä¸Šå½’æ—¶ï¼Œä¼šä¸æ–­æ ¹æ®å½“å‰æ¡ä»¶ï¼Œæ›´æ–°è¿”å›çš„ä¿¡æ¯ï¼ˆå‚è€ƒé€’å½’è¿‡ç¨‹å›¾ï¼‰\næ–¹æ³•2. æœç´¢æ ¹èŠ‚ç‚¹åˆ° pï¼Œq çš„è·¯å¾„ï¼Œå†æ±‚ä¸¤æ¡è·¯å¾„çš„æœ€åä¸€ä¸ªç›¸åŒèŠ‚ç‚¹ ä»£ç ï¼š /** * Definition for a binary tree node. * type TreeNode struct { * Val int * Left *TreeNode * Right *TreeNode * } */ func lowestCommonAncestor(root, p, q *TreeNode) *TreeNode { var path, pp, qq []*TreeNode var flag bool findPath(root, p, \u0026amp;path, \u0026amp;pp, \u0026amp;flag) flag = false path = path[0:0] findPath(root, q, \u0026amp;path, \u0026amp;qq, \u0026amp;flag) size := min(len(pp), len(qq)) i := 0 for ; i \u0026lt; size; i++ { if pp[i] == qq[i] { continue } else { break } } return pp[i-1] } func findPath(root, need *TreeNode, path, res *[]*TreeNode, flag *bool) { if root == nil || *flag { return } *path = append(*path, root) if root == need { *flag = true //*res = *path //fmt.Println(res) news := make([]*TreeNode, len(*path)) copy(news, *path) //fmt.Println(news) *res = news return } findPath(root.Left, need, path, res, flag) findPath(root.Right, need, path, res, flag) *path = (*path)[:len(*path)-1] return } func min(x, y int) int { if x \u0026lt; y { return x } return y } ç®—æ³•çš„æ€è·¯å·²ç»å†™åœ¨æ ‡é¢˜é‡Œäº†ï¼Œåˆ†æå¯ä»¥å‚è€ƒæ–‡ç«  æ±‚äºŒå‰æ ‘æ ¹èŠ‚ç‚¹åˆ°æŒ‡å®šèŠ‚ç‚¹çš„è·¯å¾„\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-4-3-offer-68-lowest-common-ancestor/","summary":"é¢˜ç›®æè¿° ç»™å®šä¸€ä¸ªäºŒå‰æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚\nç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œæ»¡è¶³ x æ˜¯ pã€q çš„ç¥– å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€","title":"å‰‘æŒ‡ Offer 68 - II. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"},{"contents":"é¢˜ç›®æè¿° ç®—æ³•è®¾è®¡ æ–¹æ³•1 å›æº¯æ³•ï¼Œä½¿ç”¨ bool æ•°ç»„è®°å½•æ¯ä¸ªæ•°æ˜¯å¦è¢«è®¿é—® cpp ç‰ˆæœ¬ï¼š\nclass Solution { public: vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; permute(vector\u0026lt;int\u0026gt;\u0026amp; nums) { vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; res; vector\u0026lt;bool\u0026gt; visit; // error: load of null pointer of type 'std::_Bit_type' // need init bool vector visit.resize(nums.size(), false); vector\u0026lt;int\u0026gt; temp; backtrack(nums, temp, visit, res); return res; } void backtrack(vector\u0026lt;int\u0026gt;\u0026amp; nums, vector\u0026lt;int\u0026gt;\u0026amp; temp, vector\u0026lt;bool\u0026gt;\u0026amp; visit, vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt;\u0026amp; res) { if (temp.size() == nums.size()){ res.emplace_back(temp); return; } for (int i = 0; i \u0026lt; nums.size(); i++) { if (visit[i]) { continue; } temp.emplace_back(nums[i]); visit[i] = true; backtrack(nums, temp, visit, res); visit[i] = false; temp.pop_back(); } } }; go ç‰ˆæœ¬ï¼š\nfunc permute(nums []int) [][]int { res := make([][]int, 0) if len(nums) == 0 { return res } temp := make([]int, 0) isvisited := make([]bool, len(nums)) BackTrack(isvisited, temp, nums, \u0026amp;res) return res } func BackTrack(isvisited []bool, temp []int, nums []int, res *[][]int) { if len(temp) == len(nums) { newTemp := make([]int, len(temp)) copy(newTemp, temp) *res = append(*res, newTemp) return // è¿™é‡Œå¯ä»¥ç›´æ¥ return äº†ï¼Œæ²¡å¿…è¦å†èµ°ä¸‹é¢çš„å¾ªç¯äº† } for i := 0; i \u0026lt; len(nums); i++ { if isvisited[i] { continue } temp = append(temp, nums[i]) isvisited[i] = true BackTrack(isvisited, temp, nums, res) temp = temp[:len(temp)-1] isvisited[i] = false } } æ–¹æ³•2 å›æº¯æ³•ï¼Œä½¿ç”¨ swap swap çš„æ–¹å¼ç›¸æ¯”æ–¹æ³• 1 è¦ç®€æ´ä¸€äº›ï¼Œä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œæ•ˆç‡ä¹Ÿé«˜ä¸€äº›ã€‚\nä»£ç å¦‚ä¸‹ï¼š\ncpp ç‰ˆæœ¬ï¼š\nclass Solution { public: vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; permute(vector\u0026lt;int\u0026gt;\u0026amp; nums) { vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt; res; backtrack(nums, 0, res); return res; } void backtrack(vector\u0026lt;int\u0026gt;\u0026amp; vec, int first, vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt;\u0026amp; res) { if (first == vec.size()) { res.emplace_back(vec); return; } for (int i = first; i \u0026lt; vec.size(); i++) { swap(vec.at(i), vec.at(first)); backtrack(vec, first+1, res); swap(vec.at(i), vec.at(first)); } } }; go ç‰ˆæœ¬ï¼š\nfunc permute(nums []int) [][]int { var res [][]int backtrack(nums, 0, \u0026amp;res) return res } func backtrack(nums []int, first int, res *[][]int) { if first == len(nums) { news := make([]int, len(nums)) copy(news, nums) *res = append(*res, news) } for i := first; i \u0026lt; len(nums); i++ { swap(nums, first, i) backtrack(nums, first+1, res) swap(nums, first, i) } } func swap(nums []int, i, j int) { nums[i], nums[j] = nums[j], nums[i] } æ€§èƒ½æµ‹è¯• é‡‡ç”¨ go test benchmarkï¼Œç»“æœå¦‚ä¸‹ï¼š\n// BenchmarkBool-8 2581156\t437.1 ns/op // BenchmarkSwap-8 1999869\t573.2 ns/op // BenchmarkSwap-8 2313684\t440.1 ns/op func BenchmarkSwap(b *testing.B) { n := []int{1, 2, 3} for i := 0; i \u0026lt; b.N; i++ { permute(n) } } // BenchmarkBool-8 999951\t1029 ns/op // BenchmarkBool-8 1098356\t963.6 ns/op // BenchmarkBool-8 1248417\t927.0 ns/op func BenchmarkBool(b *testing.B) { n := []int{1, 2, 3} for i := 0; i \u0026lt; b.N; i++ { permute1(n) } } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/2021-4-6-leet-46-quan-pai-lie/","summary":"é¢˜ç›®æè¿° ç®—æ³•è®¾è®¡ æ–¹æ³•1 å›æº¯æ³•ï¼Œä½¿ç”¨ bool æ•°ç»„è®°å½•æ¯ä¸ªæ•°æ˜¯å¦è¢«è®¿é—® cpp ç‰ˆæœ¬ï¼š","title":"leetcode 46.å…¨æ’åˆ—ã€æœªå®Œã€‘"},{"contents":"é¢˜ç›®æè¿° è¯·ä½ ä»…ä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—å®ç°ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆï¼Œå¹¶æ”¯æŒæ™®é€šé˜Ÿåˆ—çš„å…¨éƒ¨å››ç§æ“ä½œï¼ˆpushã€topã€pop å’Œ emptyï¼‰ã€‚\nå®ç° MyStack ç±»ï¼š\nvoid push(int x) å°†å…ƒç´  x å‹å…¥æ ˆé¡¶ã€‚ int pop() ç§»é™¤å¹¶è¿”å›æ ˆé¡¶å…ƒç´ ã€‚ int top() è¿”å›æ ˆé¡¶å…ƒç´ ã€‚ boolean empty() å¦‚æœæ ˆæ˜¯ç©ºçš„ï¼Œè¿”å› true ï¼›å¦åˆ™ï¼Œè¿”å› false ã€‚ æ³¨æ„ï¼š\nä½ åªèƒ½ä½¿ç”¨é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œ â€”â€” ä¹Ÿå°±æ˜¯Â push to backã€peek/pop from frontã€size å’ŒÂ is emptyÂ è¿™äº›æ“ä½œã€‚ ä½ æ‰€ä½¿ç”¨çš„è¯­è¨€ä¹Ÿè®¸ä¸æ”¯æŒé˜Ÿåˆ—ã€‚Â ä½ å¯ä»¥ä½¿ç”¨ list ï¼ˆåˆ—è¡¨ï¼‰æˆ–è€… dequeï¼ˆåŒç«¯é˜Ÿåˆ—ï¼‰æ¥æ¨¡æ‹Ÿä¸€ä¸ªé˜Ÿåˆ—Â , åªè¦æ˜¯æ ‡å‡†çš„é˜Ÿåˆ—æ“ä½œå³å¯ã€‚ ç¤ºä¾‹ï¼š\nè¾“å…¥ï¼š [\u0026ldquo;MyStack\u0026rdquo;, \u0026ldquo;push\u0026rdquo;, \u0026ldquo;push\u0026rdquo;, \u0026ldquo;top\u0026rdquo;, \u0026ldquo;pop\u0026rdquo;, \u0026ldquo;empty\u0026rdquo;] [[], [1], [2], [], [], []] è¾“å‡ºï¼š [null, null, null, 2, 2, false]\nè§£é‡Šï¼š MyStack myStack = new MyStack(); myStack.push(1); myStack.push(2); myStack.top(); // è¿”å› 2 myStack.pop(); // è¿”å› 2 myStack.empty(); // è¿”å› False æç¤ºï¼š\n1 \u0026lt;= x \u0026lt;= 9 æœ€å¤šè°ƒç”¨100 æ¬¡ pushã€popã€top å’Œ empty æ¯æ¬¡è°ƒç”¨ pop å’Œ top éƒ½ä¿è¯æ ˆä¸ä¸ºç©º è¿›é˜¶ï¼šä½ èƒ½å¦å®ç°æ¯ç§æ“ä½œçš„å‡æ‘Šæ—¶é—´å¤æ‚åº¦ä¸º O(1) çš„æ ˆï¼Ÿæ¢å¥è¯è¯´ï¼Œæ‰§è¡Œ n ä¸ªæ“ä½œçš„æ€»æ—¶é—´å¤æ‚åº¦ O(n) ï¼Œå°½ç®¡å…¶ä¸­æŸä¸ªæ“ä½œå¯èƒ½éœ€è¦æ¯”å…¶ä»–æ“ä½œæ›´é•¿çš„æ—¶é—´ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªä»¥ä¸Šçš„é˜Ÿåˆ—ã€‚\næ–¹æ³•1 ä¸€ä¸ªé˜Ÿåˆ—å®ç° å…·ä½“æ€è·¯ï¼š push æ—¶ï¼Œå…ˆå°†å…ƒç´ æ­£å¸¸ push åˆ°é˜Ÿå°¾ï¼Œå†å°†ä¹‹å‰çš„æ‰€æœ‰å…ƒç´ æ‰§è¡Œ 1.å‡ºé˜Ÿã€2.å…¥é˜Ÿ æ“ä½œ\nä»£ç å¦‚ä¸‹ï¼š\ntype MyStack struct { Queue *list.List } /** Initialize your data structure here. */ func Constructor() MyStack { return MyStack{ Queue: list.New(), } } /** Push element x onto stack. */ func (this *MyStack) Push(x int) { q := this.Queue _len := q.Len() q.PushBack(x) for i := 0; i \u0026lt; _len; i++ { q.PushBack(q.Remove(q.Front()) ) } } /** Removes the element on top of the stack and returns that element. */ func (this *MyStack) Pop() int { return this.Queue.Remove(this.Queue.Front()).(int) } /** Get the top element. */ func (this *MyStack) Top() int { return this.Queue.Front().Value.(int) } /** Returns whether the stack is empty. */ func (this *MyStack) Empty() bool { return this.Queue.Len() == 0 } /** * Your MyStack object will be instantiated and called as such: * obj := Constructor(); * obj.Push(x); * param_2 := obj.Pop(); * param_3 := obj.Top(); * param_4 := obj.Empty(); */ ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/leetcode-225-yong-dui-lie-shi-xian-zhan-wei-wan/","summary":"é¢˜ç›®æè¿° è¯·ä½ ä»…ä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—å®ç°ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆï¼Œå¹¶æ”¯æŒæ™®é€šé˜Ÿåˆ—çš„å…¨éƒ¨å››ç§æ“ä½œï¼ˆpushã€topã€pop å’Œ emptyï¼‰ã€‚\nå®ç° MyStack ç±»ï¼š","title":"leetcode 225. ç”¨é˜Ÿåˆ—å®ç°æ ˆã€æœªå®Œã€‘"},{"contents":"é¢˜ç›®æè¿° åœ¨ä¸€ä¸ª n * m çš„äºŒç»´æ•°ç»„ä¸­ï¼Œæ¯ä¸€è¡Œéƒ½æŒ‰ç…§ä»å·¦åˆ°å³é€’å¢çš„é¡ºåºæ’åºï¼Œæ¯ä¸€åˆ—éƒ½æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹é€’å¢çš„é¡ºåºæ’åºã€‚è¯·å®Œæˆä¸€ä¸ªé«˜æ•ˆçš„å‡½æ•°ï¼Œè¾“å…¥è¿™æ ·çš„ä¸€ä¸ªäºŒç»´æ•°ç»„å’Œä¸€ä¸ªæ•´æ•°ï¼Œåˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦å«æœ‰è¯¥æ•´æ•°ã€‚\nç¤ºä¾‹ï¼š\nç°æœ‰çŸ©é˜µ matrix å¦‚ä¸‹ï¼š\n[ [1, 4, 7, 11, 15], [2, 5, 8, 12, 19], [3, 6, 9, 16, 22], [10, 13, 14, 17, 24], [18, 21, 23, 26, 30] ] ç»™å®š target = 5ï¼Œè¿”å› trueã€‚\nç»™å®š target = 20ï¼Œè¿”å› falseã€‚\né™åˆ¶ï¼š\n0 \u0026lt;= n \u0026lt;= 1000 0 \u0026lt;= m \u0026lt;= 1000 åˆ†æ å› ä¸ºçŸ©é˜µæ˜¯ä»ä¸Šå¾€ä¸‹ã€ä»å·¦å¾€å³é€’å¢çš„ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©å·¦ä¸‹è§’æˆ–è€…å³ä¸Šè§’ä¸ºèµ·å§‹ç‚¹ï¼š\nç®—æ³•æµç¨‹ï¼š\nä»èµ·å§‹ç‚¹ m[a] [b] å¼€å§‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ å³ä¸Šè§’ï¼Œè‹¥å½“å‰å€¼ å¤§äº targetï¼Œåˆ™å¯ä»¥ b\u0026ndash; å»æ‰ å½“å‰åˆ— ï¼Œè‹¥å½“å‰å€¼ å°äº targetï¼Œå¯ä»¥ a++ å»æ‰ å½“å‰è¡Œ ï¼Œå·¦ä¸‹è§’ä¹Ÿç±»ä¼¼\nå›¾è§£ï¼Œè¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„ï¼š\nä½œè€…ï¼šjyd é“¾æ¥ï¼šhttps://leetcode-cn.com/problems/er-wei-shu-zu-zhong-de-cha-zhao-lcof/solution/mian-shi-ti-04-er-wei-shu-zu-zhong-de-cha-zhao-zuo/\nç»“åˆä¸Šé¢çš„å›¾ç¤ºï¼Œè¿™é“é¢˜çš„æ€è·¯è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œä½†æ˜¯ä»£ç å¹¶ä¸å¥½å†™ï¼Œä¸»è¦æ˜¯ while æ¡ä»¶æ¯”è¾ƒéš¾æŠŠæ¡ï¼Œå¾ˆå®¹æ˜“å‡ºé”™ï¼Œæ¯”å¦‚å¯¹äºä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š\n// è¶Šç•Œ [[1,4,7,11,15],[2,5,8,12,19],[3,6,9,16,22],[10,13,14,17,24],[18,21,23,26,30]] 20 // ä¸æ‰§è¡Œ whileï¼Œç›´æ¥è¿”å› false [[-5]] -5 å…·ä½“åˆ†æå¦‚ä¸‹ï¼š\nä»£ç  èµ·å§‹ç‚¹åœ¨å·¦ä¸‹è§’ï¼š\nfunc findNumberIn2DArray(matrix [][]int, target int) bool { if len(matrix) == 0 || len(matrix[0]) == 0 { return false } i, j := len(matrix)-1, 0 var flag int for i \u0026gt;= 0 \u0026amp;\u0026amp; j \u0026lt; len(matrix[0]) { flag = matrix[i][j] if flag \u0026gt; target { i-- } else if flag \u0026lt; target { j++ } else { return true } } return false } èµ·å§‹ç‚¹åœ¨å³ä¸Šè§’ï¼š\nfunc findNumberIn2DArray(matrix [][]int, target int) bool { if len(matrix) == 0 { return false } if len(matrix[0]) == 0 { return false } i, j := 0, len(matrix[0])-1 var flag int for i \u0026lt; len(matrix) \u0026amp;\u0026amp; j \u0026gt;= 0 { flag = matrix[i][j] if flag \u0026gt; target { j-- } else if flag \u0026lt; target { i++ } else { return true } //fmt.Printf(\u0026quot;i -\u0026gt; %d j -\u0026gt; %d\\n\u0026quot;, i, j) //fmt.Println(\u0026quot;flag: \u0026quot;, flag) //flag = matrix[i][j] } return false } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-04-er-wei-shu-zu-zhong-de-cha-zhao/","summary":"é¢˜ç›®æè¿° åœ¨ä¸€ä¸ª n * m çš„äºŒç»´æ•°ç»„ä¸­ï¼Œæ¯ä¸€è¡Œéƒ½æŒ‰ç…§ä»å·¦åˆ°å³é€’å¢çš„é¡ºåºæ’åºï¼Œæ¯ä¸€åˆ—éƒ½æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹é€’å¢çš„é¡ºåºæ’åºã€‚è¯·å®Œæˆä¸€ä¸ªé«˜æ•ˆçš„å‡½æ•°ï¼Œè¾“å…¥è¿™æ ·çš„ä¸€ä¸ªäºŒç»´æ•°ç»„å’Œä¸€ä¸ªæ•´æ•°ï¼Œåˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦å«æœ‰è¯¥æ•´æ•°ã€‚","title":"å‰‘æŒ‡ Offer 04. äºŒç»´æ•°ç»„ä¸­çš„æŸ¥æ‰¾"},{"contents":"é¢˜ç›®æè¿° è¯·ä»å­—ç¬¦ä¸²ä¸­æ‰¾å‡ºä¸€ä¸ªæœ€é•¿çš„ä¸åŒ…å«é‡å¤å­—ç¬¦çš„å­å­—ç¬¦ä¸²ï¼Œè®¡ç®—è¯¥æœ€é•¿å­å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: \u0026quot;abcabcbb\u0026quot; è¾“å‡º: 3 è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \u0026quot;abc\u0026quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ ç¤ºä¾‹ 2:\nè¾“å…¥: \u0026quot;bbbbb\u0026quot; è¾“å‡º: 1 è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \u0026quot;b\u0026quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚ ç¤ºä¾‹ 3:\nè¾“å…¥: \u0026quot;pwwkew\u0026quot; è¾“å‡º: 3 è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \u0026quot;wke\u0026quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ\u0026quot;pwke\u0026quot; æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸² æç¤ºï¼š\ns.length \u0026lt;= 40000\næ–¹æ³•1ï¼šæ»‘åŠ¨çª—å£ é€šè¿‡åŒæŒ‡é’ˆ + å“ˆå¸Œè¡¨å®ç°ï¼Œç®—æ³•æ€è·¯å¦‚ä¸‹ï¼š\nåˆå§‹åŒ–ä¸¤ä¸ªæŒ‡é’ˆ i å’Œ jï¼ŒåŒæ—¶æŒ‡å‘ç¬¬ä¸€ä¸ªå­—ç¬¦ i æŒ‡é’ˆä¸åŠ¨ï¼Œj æŒ‡é’ˆä¸æ–­å‰è¿›ï¼Œæ¯æ¬¡å‰è¿›éƒ½æ›´æ–°å…¶åœ¨ map ä¸­çš„å€¼ï¼ˆå€¼æ˜¯ä¸‹æ ‡ï¼‰ï¼ŒåŒæ—¶è®¡ç®—æœ€å¤§çª—å£å€¼ å¦‚æœ j åœ¨ç§»åŠ¨è¿‡ç¨‹ä¸­é‡åˆ°é‡å¤å…ƒç´ ï¼ˆåœ¨ map ä¸­å·²å­˜åœ¨ï¼‰ï¼Œåˆ™å°† i ç§»åŠ¨åˆ° max(i, map[é‡å¤å…ƒç´ ]+1) å¤„ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦æ¯”è¾ƒå¤§å°ï¼Œåé¢ä¼šè§£é‡Š å½“ j å¤§äºå­—ç¬¦ä¸²é•¿åº¦æ—¶ï¼Œç»“æŸå¾ªç¯ï¼Œè¿”å›æœ€å¤§çª—å£å€¼ å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š\nfunc lengthOfLongestSubstring(s string) int { i, j, maxl := 0, 0, 0 m := make(map[byte]int) for j \u0026lt; len(s) { cur := s[j] // å½“å‰å­—ç¬¦é‡å¤ if _, ok := m[cur]; ok { // ç§»åŠ¨ i åˆ°é‡å¤å…ƒç´ ä¸‹æ ‡+1 å¤„ï¼Œå¦‚æœå½“å‰ä½ç½®ä¸‹æ ‡å¤§äº m[cur]+1ï¼Œåˆ™ä¸ç§»åŠ¨ i = max(i, m[cur]+1) } // å¦‚æœå½“å‰é•¿åº¦æ›´å¤§ï¼Œåˆ™æ›´æ–°æœ€å¤§é•¿åº¦ maxl = max(maxl, j-i+1) m[cur] = j j++ } return maxl } func max(a, b int) int { if a \u0026gt; b { return a } else { return b } } // æ‰§è¡Œç”¨æ—¶: 8 ms // å†…å­˜æ¶ˆè€—: 3.1 MB ç–‘é—® å½“å…ƒç´ é‡å¤æ—¶ï¼Œä¸ºä»€ä¹ˆ i è¦ç§»åŠ¨åˆ° max(i, m[cur]+1) å¤„ï¼Œè€Œä¸æ˜¯ç›´æ¥ç§»åŠ¨åˆ° m[cur]+1 å¤„ï¼Ÿ\nåˆšå¼€å§‹å†™çš„æ—¶å€™ï¼Œæˆ‘å°±çŠ¯äº†è¿™ä¸ªé”™è¯¯ï¼Œå†™ä¸‹äº†å¦‚ä¸‹ä»£ç ï¼š\nfunc lengthOfLongestSubstring(s string) int { i, j := 0, 0 m := make(map[byte]int) maxl := 0 for j \u0026lt; len(s) { char := s[j] if _, ok := m[char]; ok { i = m[char] + 1 } maxl = max(maxl, j-i) m[char] = j j++ } return maxl } func max(a, b int) int { if a \u0026gt; b { return a } else { return b } } æµ‹è¯•ç”¨ä¾‹ï¼šabbaï¼Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ 2 ï¼Œä½†æ˜¯ä¸Šé¢ä»£ç æ‰§è¡Œå´è¯¡å¼‚çš„è¿”å›äº† 3ï¼Œé€šè¿‡ç”»å›¾åˆ†æåæ‰çŸ¥é“äº†åŸå› æ‰€åœ¨ï¼š\né”™è¯¯è®°å½• func lengthOfLongestSubstring(s string) int { i, j := 0, 0 m := make(map[byte]int) maxl := 0 for j \u0026lt; len(s) { char := s[j] if _, ok := m[char]; ok { maxl = max(maxl, j-i) i = m[char] + 1 } m[char] = j j++ } return maxl } func max(a, b int) int { if a \u0026gt; b { return a } else { return b } } æµ‹è¯•ç”¨ä¾‹ï¼š\nau\té¢„æœŸï¼š2\tè¾“å‡ºï¼š0\nåŸå› ï¼šæ›´æ–°æœ€å¤§é•¿åº¦è¯­å¥å†™åœ¨äº† if å†…ï¼Œåªæœ‰å­—ç¬¦é‡å¤æ—¶æ‰ä¼šæ‰§è¡Œï¼Œå¯¹äº au è¿™ä¸ªæ²¡æœ‰é‡å¤å­—ç¬¦çš„ stringï¼Œè¯¥è¯­è¨€å§‹ç»ˆä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥æœ€åä¼šè¿”å› 0\n\u0026quot; \u0026quot;\té¢„æœŸï¼š1\tè¾“å‡ºï¼š0\nåŸå› ï¼šè¿˜æ˜¯å’Œä¸Šé¢ä¸€æ ·çš„æƒ…å†µã€‚\næ€»ç»“ ç¬¬ä¸€æ¬¡åšè¿™é“é¢˜çš„æ—¶å€™æ˜¯æ¯«æ— å¤´ç»ªçš„ï¼Œå› ä¸ºå½“æ—¶å¹¶ä¸çŸ¥é“æ»‘åŠ¨çª—å£æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨çœ‹äº†é¢˜è§£åï¼Œç…§çŒ«ç”»è™ï¼Œå¤§è‡´æ‘¸æ¸…äº†ç®—æ³•æ€è·¯ï¼Œä½†å¯¹äºä¸€äº›ç‰¹æ®Šè¯­å¥ï¼Œæ¯”å¦‚ if ä¸­çš„ max(i, m[s[j]]+1)ï¼Œå´æ²¡æœ‰å¾ˆå¥½çš„ç†è§£ï¼Œåªæ˜¯çŸ¥é“è¿™å¥è¯ä¸è¿™æ ·å†™ï¼Œç­”æ¡ˆå°±ä¸ä¼šæ­£ç¡®ã€‚\nè¿™æ¬¡äºŒåˆ·ï¼Œåˆ™æ˜¯å…ˆå¤§è‡´å›æƒ³ä¸€ä¸‹ä¹‹å‰è®°å¿†é‡Œçš„æ€è·¯ï¼Œå¹¶å°è¯•åœ¨ä¸çœ‹åŸæ¥æ­£ç¡®ä»£ç çš„æƒ…å†µä¸‹ï¼Œå…ˆè‡ªå·±å†™å†™ï¼Œç»“æœå°±å‘ç°äº†å¾ˆå¤šé—®é¢˜ï¼Œä¸€äº›æµ‹è¯•ç”¨ä¾‹æ— æ³•é€šè¿‡ï¼Œè¿™æ—¶å†ç»“åˆä¹‹å‰çš„æ­£ç¡®ä»£ç ï¼Œæ¯”è¾ƒè‡ªå·±å†™çš„ä»£ç çš„ç¼ºé™·å¹¶æ”¹æ­£ï¼Œå¯¹äºç‰¹æ®Šè¯­å¥ä¹Ÿç†è§£æ¸…æ¥šäº†ã€‚\næ‰€ä»¥è¿™é“é¢˜ç»™æˆ‘çš„æ„Ÿæ‚Ÿå°±æ˜¯ï¼Œåšé¢˜è¿˜æ˜¯å¾—è‡ªå·±åŠ¨æ‰‹å®è·µæ‰èƒ½çœŸæ­£ç†è§£ï¼Œåªæ˜¯çœ‹åˆ«äººçš„ä»£ç ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå¤„äºåŠçŸ¥åŠè§£çŠ¶æ€ã€‚ç®—æ³•é¢˜å°±æ˜¯è¿™æ ·ï¼Œå¾€å¾€ä½ ä»¥ä¸ºè‡ªå·±åšå¯¹äº†ï¼Œå®é™…å¹¶æ²¡æœ‰ï¼Œå°±æ˜¯æœ‰å‡ ä¸ªåˆé’»çš„æµ‹è¯•ç”¨ä¾‹è¿‡ä¸å»ï¼Œåªè¦æœ‰ 1 ä¸ªæµ‹è¯•è¿‡ä¸å»ï¼Œå°±è¯´æ˜è¿™ä¸ªä»£ç å†™çš„æ˜¯æœ‰é—®é¢˜çš„ï¼Œè¿™ä¸ªæ—¶å€™å†ç»“åˆé”™è¯¯ä»”ç»†åˆ†æï¼ŒæŸ¥æ‰¾å‘ç°æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œå°±èƒ½æ›´å¥½çš„ç†è§£ä»£ç ã€‚å¦‚æœåªæ˜¯çœ‹åˆ«äººçš„ï¼Œå°‘äº†å‘ç°å¹¶æ”¹æ­£é”™è¯¯çš„è¿‡ç¨‹ï¼Œå¯¹ä»£ç çš„ç†è§£ä¹Ÿä¼šä¸å¤Ÿé€å½»ï¼Œã€‚\næ€»çš„æ¥è¯´ï¼Œåœ¨ä¸ä¼šåšçš„æƒ…å†µä¸‹å¯ä»¥çœ‹åˆ«äººçš„é¢˜è§£ï¼Œå­¦ä¹ æ–¹æ³•å’Œæ€è·¯ï¼Œä½†ä¸èƒ½åªçœ‹ä¸å†™ï¼Œè¦è¯•ç€å°†åˆ«äººçš„æ€è·¯è½¬æ¢æˆè‡ªå·±çš„ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-48-zui-chang-bu-han-chong-fu-zi-fu-de-zi-zi-fu-chuan/","summary":"é¢˜ç›®æè¿° è¯·ä»å­—ç¬¦ä¸²ä¸­æ‰¾å‡ºä¸€ä¸ªæœ€é•¿çš„ä¸åŒ…å«é‡å¤å­—ç¬¦çš„å­å­—ç¬¦ä¸²ï¼Œè®¡ç®—è¯¥æœ€é•¿å­å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚\nç¤ºä¾‹ 1:\nè¾“å…¥: \u0026quot;abcabcbb\u0026quot; è¾“å‡º: 3 è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \u0026quot;abc\u0026quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ ç¤ºä¾‹ 2:","title":"å‰‘æŒ‡ Offer 48. æœ€é•¿ä¸å«é‡å¤å­—ç¬¦çš„å­å­—ç¬¦ä¸²"},{"contents":"é¢˜ç›®æè¿° åœ¨å­—ç¬¦ä¸² s ä¸­æ‰¾å‡ºç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¿”å›ä¸€ä¸ªå•ç©ºæ ¼ã€‚ s åªåŒ…å«å°å†™å­—æ¯ã€‚\nç¤ºä¾‹:\ns = \u0026quot;abaccdeff\u0026quot; è¿”å› \u0026quot;b\u0026quot; s = \u0026quot;\u0026quot; è¿”å› \u0026quot; \u0026quot; é™åˆ¶ï¼š\n0 \u0026lt;= s çš„é•¿åº¦ \u0026lt;= 50000 æ–¹æ³•1ï¼šå“ˆå¸Œè¡¨ å¯ä»¥å°†å“ˆå¸Œè¡¨çš„ key å®šä¹‰ä¸º charï¼Œç”¨æ¥å­˜å‚¨ string çš„æ¯ä¸ªå­—ç¬¦ï¼›value å®šä¹‰ä¸º int ï¼Œç”¨æ¥è®°å½•å­—ç¬¦å‡ºç°çš„æ¬¡æ•°ï¼Œæˆ–è€…å®šä¹‰ä¸º boolï¼Œç”¨æ¥æ ‡è¯†å­—ç¬¦æ˜¯å¦é‡å¤å‡ºç°ï¼Œå› ä¸º bool çš„æ–¹å¼ç›¸å¯¹ç®€å•æ˜äº†ï¼Œä¹Ÿå¹¶ä¸éœ€è¦é¢‘ç¹å¯¹å˜é‡è¿›è¡Œè‡ªå¢æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹© boolï¼Œfalse ä»£è¡¨æœªé‡å¤å‡ºç°ã€‚\nç”±äº go çš„ map æ˜¯æ— åºçš„ï¼Œéå†å‡ºçš„ç¬¬ä¸€ä¸ª value ä¸º false çš„å­—ç¬¦ï¼Œåœ¨å­—ç¬¦ä¸²ä¸­æœªå¿…æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡äºŒæ¬¡éå†å­—ç¬¦ä¸²ï¼Œåˆ¤æ–­æ¯ä¸ªå­—ç¬¦åœ¨ map ä¸­å¯¹åº”çš„å€¼ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªå€¼ä¸º false çš„å­—ç¬¦ã€‚\nä»£ç å¦‚ä¸‹ï¼š\nfunc firstUniqChar(s string) byte { m := make(map[rune]bool) for _, char := range s { if _, ok := m[char]; ok { m[char] = true continue } m[char] = false } for _, char := range s { if !m[char] { return byte(char) } } return 32 } // æ‰§è¡Œç”¨æ—¶: 48 ms // å†…å­˜æ¶ˆè€—: 5.3 MB æ–¹æ³•2ï¼šä½¿ç”¨æ•°ç»„ä»£æ›¿å“ˆå¸Œè¡¨ è¿™æ˜¯ ã€Šå‰‘æŒ‡offerã€‹ ä¸­æä¾›çš„æ–¹æ³•ï¼Œè™½ç„¶å“ˆå¸Œè¡¨å¯ä»¥å¾ˆå¥½åœ°è§£å†³é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªåªæœ‰å°å†™å­—æ¯çš„å­—ç¬¦ä¸²æ¥è¯´ï¼ˆé¢˜ç›®ä¸­è¯´æ˜äº†ï¼‰æ¥è¯´ï¼Œæ€é¸¡ç„‰ç”¨å®°ç‰›åˆ€ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªé•¿åº¦ä¸º 26 çš„æ•°ç»„ï¼Œå»ºç«‹ä¸€ä¸ªç®€å•çš„å“ˆå¸Œè¡¨å³å¯ï¼Œç”¨å­—ç¬¦çš„ ascii å‡å» 97 ä½œä¸ºä¸‹æ ‡ï¼Œå€¼ä¸ºå‡ºç°çš„æ¬¡æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š\nfunc firstUniqChar(s string) byte { n := [26]int{} for _, char := range s { n[char-97]++ } for _, char := range s { if n[char-97] == 1 { return byte(char) } } return 32 } // æ‰§è¡Œç”¨æ—¶: 8 ms // å†…å­˜æ¶ˆè€—: 5.3 MB æ‰§è¡Œç”¨æ—¶åªæœ‰åŸæ¥çš„ 1/6ï¼Œè¿™ä¸ªç»“æœå¯èƒ½ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œä½†æ˜¯ç›¸å¯¹å“ˆå¸Œè¡¨è€Œè¨€ï¼Œå°‘äº†å“ˆå¸Œè®¡ç®—ã€å¤„ç†å“ˆå¸Œå†²çªç­‰ç­‰æ“ä½œï¼Œæ•ˆç‡è‚¯å®šè¦å¥½ä¸€äº›çš„ã€‚é€šè¿‡è¿™é“é¢˜ä¹Ÿä½¿æˆ‘æ˜ç™½äº†ï¼Œä¸è¦æ— è„‘ä½¿ç”¨ mapï¼Œåœ¨ä¸€äº›ç‰¹æ®Šæ¡ä»¶ä¸‹ï¼Œå¾€å¾€ä¼šæœ‰æ›´ç®€å•é«˜æ•ˆçš„è§£å†³æ–¹æ³•ã€‚\næ–¹æ³• 3ï¼š æœ‰åºå“ˆå¸Œè¡¨ å¦‚æœå“ˆå¸Œè¡¨æœ‰åºï¼Œåˆ™å¯ä»¥éå†å“ˆå¸Œè¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå€¼ä¸º fasle çš„å­—ç¬¦ï¼Œä½† go ä¸­æ²¡æœ‰æä¾›æœ‰åº mapï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸€ä¸ª slice æ¥æŒ‰é¡ºåºä¿å­˜ key ï¼Œä¹‹åéå†è¿™ä¸ª slice å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š\nfunc firstUniqChar(s string) byte { sli := make([]rune, 0) m := make(map[rune]bool) for _, char := range s { // map ä¸­æ²¡æœ‰è¯¥ charï¼Œåˆ™ append åˆ° slice ä¸­ if _, ok := m[char]; !ok { sli = append(sli, char) } if _, ok := m[char]; ok { m[char] = true continue } m[char] = false } // éå† slice for _, char := range sli { if m[char] == false { return byte(char) } } return 32 } // æ‰§è¡Œç”¨æ—¶: 48 ms // å†…å­˜æ¶ˆè€—: 5.3 MB ä¸è¿‡è¯¥æ–¹æ³•çœ‹èµ·æ¥å¹¶æ²¡æœ‰æ˜¾è‘—æé«˜æ•ˆç‡ã€‚\né”™è¯¯è®°å½• func firstUniqChar(s string) byte { // è¿™é‡Œé”™è¯¯çš„å°† value è®¾ç½®ä¸º byte ç±»å‹ï¼Œæœ€å¤§å€¼åªæœ‰ 255ï¼Œ255 + 1 ä¼šè¢«é‡ç½®ä¸º 0 // ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªæ•°å‡ºç°äº† 257 æ¬¡ï¼Œåˆ™å®ƒçš„å€¼ä¼šå˜ä¸º 1 n := [26]byte{} for _, char := range s { n[char-97]++ } for _, char := range s { if n[char-97] == 1 { return byte(char) } } return 32 } ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªåˆé’»çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå®ƒçš„æ­£ç¡®ç»“æœåº”è¯¥æ˜¯ \u0026ldquo;y\u0026rdquo;ï¼Œä½†æ˜¯ä¸Šé¢çš„ä»£ç å´è¿”å›äº† \u0026ldquo;n\u0026rdquo;ï¼ŒåŸå› å°±æ˜¯ n å‡ºç°äº† 257 æ¬¡ï¼Œå€¼å˜ä¸ºäº† 1ï¼Œè€Œå­—ç¬¦ä¸²ä¸­ n åˆæ¯” y å…ˆå‡ºç°ï¼Œå¯¼è‡´é”™è¯¯åœ°è¿”å›äº† nã€‚\n\u0026quot;uindrseqbljlhqvlwvgdebeihttirikuahlikgnahvgnptmqwbovmuwesxkvcitcwrwrucsbbfqvldridfviduqvmfcmeiphoqupbitnwdbvevouoaetisdmgvvvwoglwtgjrpcbghxkrkjthetxeexbphbjiehaicuicgnirslhdstgmqcdnlulpdpadjdltfouwhfqicfcqntnpeqaohslwkhbvflxaudembsrsindluthxapnmrqinsivbxmkohubvmmmpmklbfrmeuvdrhptdmelmjjefgbsqqlbqhvsmswwxrlkutadqbbeisbgfrcivvoxmxxptrscxnjjvtajfhqiucdihihcutxhlonlomfdnbwanrcnbarojsajseqrgkuqgkcnvrghxnmbclfomktwfaakodeecsglufvobkgoqsbrhdiuhxqbcndkmxuertupngvnkgwrfwgdbiurbooxariklwarjgavsuddoveipltessrssxwxgvrrtkisnbavkbpaphicxhapjjpkccakepuafjdaswfwfmbdmuuaveukxvnpkgmhcjcpqntssthjlvrngugbhrivtwmbrvrprrlfmvwjdkonfmgnepqoxwfcvefjihisarwskjfmqrjlkbbugfawmkqgfxgpokkxxivqbqimwsccdekjegwcxhmmuhpstxfpofwmrmhrxeptxwbvxsesheijjfsshgrrwckjkmbslpbngnwhokjnujtiepfrdhiwwgbffixaidabacaibummwxgxowsewlqfxrkarjrkqxmxwobqbcoowmbggtpoqadhqdxlhvxrkfuwpxxgnchudreoeuefkqhlrmwwfvjexvbxdhtdngwvoohpjtdbdbesceiafrhenfljleegsencfmbauxlltfueudnjxsiiggsfwiuidgktsbtcvxtdllviocfdbonjciosucbjidwxnogmnveqkcrxbpamfxwxiugjgrfpstromuxxdiodqeoqdlfulttraquskhwfholbrcbchijlgqvuwxvejedikvgetlmrcmeampdgjvmbdovkcjilbralhmniwvbeandldnudkpjvhoqtfdwllridwljfvflfdrbqadvabggwsiexrthrngexpebuhtefkqgkkjoopsmunesfotsprxuaswwenhkdvsspkppulecahkkvccqngeaoijjgvsfqfpvphvhdnkkcqsebhijkvfpqjmarbkpejagtbtisnflrrvawmvfxeccxtrmorihgslxlqrqcmouojjfhcieuwlrcqhevmveookgonxqdbtgqjimsidnaaiuchwkfkpxfptuvhfqemojixqvhgokdekdwbomptqqlfiaiptxvgfmovdqxupjxjpoxuplsagxpgpmvtcpawkrrthvclhdbpqeucchxptdceswhnqocmeocpgthkgxmxggwlnantwwuoqpmnpvgateitxlocmhnihmfgjnvrggenbhnjfubtoteojojjkjpcnwqthxhlfukingjletwnxdnjwrgjopqoxtqcvwsakqxxumbtcblufdmdvxfkshitenmenkxjvblsoiyhjpakinimwxhcebabgsvqftfvwjnstltjawhwipkubadtoxqrutkwxjnmfoowtnvqplvqokcuwlkmxxhboampcdwokjfxggtnojebagxlwaeowtomubtbfsrufkttugfpnxmipkcsphqafjuxovwpcgonhiqmomsweunoeqkpkxxsdksmufowqpmkontccckcdbwrfwamikananakgjkahndrepemcgxecgpltvdbpoexemnrejdephuuxhfcubxlbdrmhvmeqmtdhnbkwnidigxdantmkckijiecavkpumegrbveffclcltmibjcstrrauphfxxssgxkkirapiihnlbrodvfostahqdkajqtrrfwdsemwxlucbbjjspnnqjnpnpmimhulgoskwpsactexmkfdhaihnlggqeunqevxfrpiwskhrhgfluelshqejavomjshfomvgpugqesbtakvxqwrtguuebcgqphocglfrircfvuikfbviomfrsnpvvlftwrkbmjpvdpgvohtmxcxwnuhwojnfvsfwvdlaxxlmafihpussffcawjpaxdwerwfbvsbipljualcnhseealvqiqfiaiskaafufaubvhjglktfhbdsaskmedroxkrxshnggumcbtdcablawkodmnafkjekuiecqlvbxocfcwipaicgndfafjhtjcelakrecmntjxeqjqgxkxapuobbcaxfrpsktjswxdfvugmmgjwiphnsclqwmranthpiueffaxvhplajqsrtoxbixbdpcfkbpkjkelemubwachcpxcniaqmkmasmvlfcubcdkxfkupgcgbrvmbmgnjgfbawmmdritdrkppswatwtdjemhifhmshunkvaivhteqnwkdcrpfxmrafupfhbgligbvrqjkvcgbiqudvtblhfgetffduvsfhsmjimgruxrvbqniluapaoniwhqhltbxvrphmlisfaomqoecmdbbrgujgsbdelkbddcgmpggogfonssxisphbwljlvhwhewmpqugxgbubqfeilobxxhtcxmxvjtbuavxlaghhjiemihvrsjxbleutpuumgndtnocwkpkdaupbmcsahcbwoelmgnwqummmekwhpahtdvehoprfcciwqphfwppscruimikiximhbkdomovbdalsihioncpaclevxawqcqthtmuogolkrvlipropmnmecttmlecpapdlrcqxopfjobgsvhcadqiudqjoscpvjguddnorldkpqtoocrtkcutkvdpbkkekenpqjmxmuxccamkwwxrdrbdmameptvcgsltqdasicoouvdtbranexokmtkioptqblrruaihvfvvebjigkuwwgearxvmimlgmxgpvbnotepprknjxcunheclsvxxmmoufvdhrwxqlrkmvcaxtbiqrjrnrsfrkvttnpxbspnetcofhpcbcphrchivnrskkalsvdllhtisnaerxbcxutcpmnquwrutmmvrtchhheplhdmbfkrrrxalosjbebtdqtsjbdcuuatgldnubigijbkehxsmhsadwtcbwinlnilthiqslvsduspkjuunpetcofujbqhtkmalnjmllhulckqodbgffxdiqjajecbmlekvepkirxnguqnpnfjdptinuphcoxkoqhqrmkkawmngqwvfpcuxgpekkprupplsbwshmsduaitlhcjargacduewtqgnxbtpwrkawpncarxlsnardkftmsdjflmhoplghandjisupacixxthwokctbxekqwbmhtoutgrogxsdnmcaqrsqrpigbigqhsmrksxgkdbdbxkwimpehltcffuhrphbaqgvabjduudbrxgwiljkwijvaugnleamskjijhnvcspagsfnhjielrvxddxqfgaipfflffksmvgaioaclfsjhovcotoaiwhhnmrudsqmsepsgdofnxjjcgdejutmdtgauuvuepajlikebtpgfimudswplfwgaodtwqjuaujlbqqartevsqesmrpknoanfprqcwochqdrcvquovtsogptduvfiaislfvpxwsqitodxwckprpfxtqhbdixklhtsajqgbinfpdqaehrwhnwggmggnbstolrcbmlhpfjurbknpwbrfhvdanrjcwnvsxudagbkhdlwujqvwpbbgmsfrkgutkqwxqfemaaokrfdocsbbktwaugoadgvqcdhmqkworbvxqwdpmbjkqghmapevrsnaaparwnbvcfnhhgfqplfwiswrxxistamulcbxcmvkbcxsgftbmbvqlxrhbmcujkktdvcgnjkfaclxndtjkdbgqvbqxicgmpowbjsfvspvxtrovjwbbkaapfgcqbifdosnmutvfbgdmhiqvflasedhafqnmrlmwbuhmptnkvvojnjngiepmdktewwsuxernpfmktsgwwnxfvmuotpfxfntcrsjpldmringfpkpievvbgbghevlmuticukrfvahrmtkvckjbxxrmkilbeojsxgbvbhsgvkhgtjddoreipbkwiqbkecobfexswiwttlohnfwokixfmfrpadtudrssiobbvhctpbeesiogwhdqojoalxpxikwuheilvsrxbfbnckjeswhkfviihvwrfxkxcomhvsjojhltospooumkstqqnvxmrowlrtufhxkipxnfecchklrqljfwnglxeharemawsbvnuentnapewjhnzbieisjtomdqtjkigisgopmgcfqxcxninrisupchhmfrosxgdtakhrrnbbnxovvbfjgwdgnlxoxswhsfjeijvivqemoekkmrttscthlpglaorarhibrucuhikfkphqmhowloobeumlikqmmlatesupiekwjhdvntnjbakohrbobimmujkbatfxpmgfmmqsgwsffcbenwgdrhlqrsmfghevnjfdlxupihmkptsefubmixhacnxngpjrckxhvhrelolqwevoqklhxbplakmsxdetvpuddmvaodpglmsknbvfftstckjurbntwqenuhcurxqvotrxfpootqkobeatoduihwhpjxxrvboggkcxagnrrfwfuaqplirlnafprumnkcjxlpvanfmqwuoaupqptqeulpwvnhbahbkihustenkbdushjakemufdhjllnowmvgpdxbrhxfonpgcjslvwgdmajicqqmdxubrofvdodfsedjghpbjncgkckeudxwascljlraoodwvgpvojcqgbalntslsfrwnfcdvidsdrvwhscskpalubxeobapkgpdsqcjpwkednraijmbcreplwijofniggavpdlwfmwnvsaridhbppeolakquhamneffnfmbruivassdaaikxiaxupgdpgkfojvkkagcsmqnweofwikvevrsottkbtcldoruakajinnlgxmpddcrmohaktsdrxjelrbmfdthspikxeocqqdordrqwjtaxihswcubtfomksaxddcvtadnrtqkmdnacgduudtdbhsgpfomrdiaotcfwqlxccqeelgtnkflgixpjcriroruhbbgpidwkggdevpfratqebewaxcudseaikqjuuhpsguvtwxniofskkslfnrphatmxngneuituefcxufisrsjitqxwufrgidbwlmkrqojpwpljasaiukwwthrudhcocoguerakhajdncxbrnuavoqeuwsamwdqgutbaoixcgeibpoajhedooqcewiqvddedmanxljjjcbojgbmwabkfbvamgnfpncdcxoaqhmgurifpwpgrpctlqpwmqraknjltneknsphtwbnbiahknxipsovljkivlpggvldeveeopvoqlvfjbratadttlcecomllpkdgiloeedquivsnmxkfcvrkwaohgbrbvjklkktgwtlfgafqgbigheajrvffvvkkmibcedfmnwasopoqgxjohjoqnijeaifuwiwmogkwqlfmibuwecvnulvhkbsukscqlqlsxjulillmlgjkrbmllcunhbqmbujftqgkpwkvemthigednfohxpsduotwfnknfjbexflcfieaosnlhndsorbkcdlahovwbccshmrlcofowrmqajluiqaarnqtxokbaddswftiexiahmstpbonwmhvqgcpmfrocvtwfhjrtsupscfmvwfvaoolanrlgdsvgoseltdnoxrdglockhwlvffaakgrxjfnfbxnbprfvpwmexnhfekjnkenbohhmwlqoteiwgtjsrnceptbgwkfcmtkliwwqskmsoihmnbjsvnmfkwbwemijdtpnajgrousbrdaagenqlgeaiixfgcbfhceaxkwxbpksfouuqcvcerqecpdtvtsubbadmaatdnmnqhladeiapejkxffoagbwqbvppssvvvhlvhntatxlvqgjxbejpvxemqbdjknuogumrwbognklmvjsldrktpeowiuaapbjgktxwfjiferxgmafbcerteqlvpqvxbgdwiufdctkwptadtujmifppudubpmdtiedmqhnihquansnjufpbuumhhmidphkwusjdsdaocavtauhsvtgcoqhufmacwcbxvjmagkounkoqpcnoanhgwsjvgtlwgvbpdbufekosgagfsmadmvbonkrtcbspoabugkcjeebqhqwfjcqlqjvabaqecofgwskqplgup\u0026quot; æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæ„šè ¢çš„é”™è¯¯ï¼Œä½†å¯¹äºæˆ‘è¿™æ ·çš„èœé¸¡æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå®¹æ˜“å¿½è§†çš„é”™è¯¯ï¼Œåˆšå¼€å§‹å‘ç°æ—¶ä¹Ÿç¡®å®æ˜¯æ¯”è¾ƒå›°æƒ‘çš„ï¼Œæ‰€ä»¥ç‰¹æ­¤è®°å½•ä¸€ä¸‹ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-50-di-yi-ge-zhi-chu-xian-yi-ci-de-zi-fu-shu-zhong-wei-35-ti/","summary":"é¢˜ç›®æè¿° åœ¨å­—ç¬¦ä¸² s ä¸­æ‰¾å‡ºç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¿”å›ä¸€ä¸ªå•ç©ºæ ¼ã€‚ s åªåŒ…å«å°å†™å­—æ¯ã€‚","title":"å‰‘æŒ‡ Offer 50. ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦ï¼ˆä¹¦ä¸­ä¸º35é¢˜ï¼‰"},{"contents":"é¢˜ç›®æè¿° è¾“å…¥ä¸€ä¸ªé“¾è¡¨ï¼Œè¾“å‡ºè¯¥é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ã€‚ä¸ºäº†ç¬¦åˆå¤§å¤šæ•°äººçš„ä¹ æƒ¯ï¼Œæœ¬é¢˜ä»1å¼€å§‹è®¡æ•°ï¼Œå³é“¾è¡¨çš„å°¾èŠ‚ç‚¹æ˜¯å€’æ•°ç¬¬1ä¸ªèŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé“¾è¡¨æœ‰6ä¸ªèŠ‚ç‚¹ï¼Œä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œå®ƒä»¬çš„å€¼ä¾æ¬¡æ˜¯1ã€2ã€3ã€4ã€5ã€6ã€‚è¿™ä¸ªé“¾è¡¨çš„å€’æ•°ç¬¬3ä¸ªèŠ‚ç‚¹æ˜¯å€¼ä¸º4çš„èŠ‚ç‚¹ã€‚\nç¤ºä¾‹ï¼š\nç»™å®šä¸€ä¸ªé“¾è¡¨: 1-\u0026gt;2-\u0026gt;3-\u0026gt;4-\u0026gt;5, å’Œ k = 2.\nè¿”å›é“¾è¡¨ 4-\u0026gt;5.\nåŒæŒ‡é’ˆ ç®—æ³•æµç¨‹ï¼š\nå®šé‡ä¸¤ä¸ªå˜é‡ i å’Œ jï¼Œè¿™ä¸¤ä¸ªå˜é‡åˆå§‹éƒ½æŒ‡å‘é“¾è¡¨çš„å¤´ç»“ç‚¹ å…ˆè®© j å‘å‰ç§»åŠ¨ k æ­¥ i å’Œ j åŒæ—¶å‘å‰ç§»åŠ¨ å½“ j çš„å€¼ä¸º null æ—¶ï¼Œi å°±æ˜¯å€’æ•°ç¬¬ k ä¸ªèŠ‚ç‚¹ ä»£ç å¦‚ä¸‹ï¼š\nfunc getKthFromEnd(head *ListNode, k int) *ListNode { h := head i, j := h, h // j å…ˆèµ° k æ­¥ for i := 0; i \u0026lt; k; i++ { if j != nil { j = j.Next } } // ä¹‹å i å’Œ j åŒæ—¶å‰è¿› 1 æ­¥ for j != nil { i = i.Next j = j.Next } return i } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-22-lian-biao-zhong-dao-shu-di-k-ge-jie-dian/","summary":"é¢˜ç›®æè¿° è¾“å…¥ä¸€ä¸ªé“¾è¡¨ï¼Œè¾“å‡ºè¯¥é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ã€‚ä¸ºäº†ç¬¦åˆå¤§å¤šæ•°äººçš„ä¹ æƒ¯ï¼Œæœ¬é¢˜ä»1å¼€å§‹è®¡æ•°ï¼Œå³é“¾è¡¨çš„å°¾èŠ‚ç‚¹æ˜¯å€’æ•°ç¬¬1ä¸ªèŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé“¾è¡¨æœ‰6ä¸ªèŠ‚ç‚¹ï¼Œä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œå®ƒä»¬çš„å€¼ä¾æ¬¡æ˜¯1ã€2ã€3ã€4ã€5ã€6ã€‚è¿™ä¸ªé“¾è¡¨çš„å€’æ•°ç¬¬3ä¸ªèŠ‚ç‚¹æ˜¯å€¼ä¸º4çš„èŠ‚ç‚¹ã€‚\nç¤ºä¾‹ï¼š\nç»™å®šä¸€ä¸ªé“¾è¡¨: 1-\u0026gt;2-\u0026gt;3-\u0026gt;4-\u0026gt;5, å’Œ k = 2.","title":"å‰‘æŒ‡ Offer 22. é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹"},{"contents":"é¢˜ç›®æè¿° ç»™å®šå•å‘é“¾è¡¨çš„å¤´æŒ‡é’ˆå’Œä¸€ä¸ªè¦åˆ é™¤çš„èŠ‚ç‚¹çš„å€¼ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚\nè¿”å›åˆ é™¤åçš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚\næ³¨æ„ï¼šæ­¤é¢˜å¯¹æ¯”åŸé¢˜æœ‰æ”¹åŠ¨\nç¤ºä¾‹ 1:\nè¾“å…¥: head = [4,5,1,9], val = 5 è¾“å‡º: [4,1,9] è§£é‡Š: ç»™å®šä½ é“¾è¡¨ä¸­å€¼ä¸º 5 çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨äº†ä½ çš„å‡½æ•°ä¹‹åï¼Œè¯¥é“¾è¡¨åº”å˜ä¸º 4 -\u0026gt; 1 -\u0026gt; 9. ç¤ºä¾‹ 2:\nè¾“å…¥: head = [4,5,1,9], val = 1 è¾“å‡º: [4,5,9] è§£é‡Š: ç»™å®šä½ é“¾è¡¨ä¸­å€¼ä¸º 1 çš„ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨äº†ä½ çš„å‡½æ•°ä¹‹åï¼Œè¯¥é“¾è¡¨åº”å˜ä¸º 4 -\u0026gt; 5 -\u0026gt; 9.\nè¯´æ˜ï¼š\né¢˜ç›®ä¿è¯é“¾è¡¨ä¸­èŠ‚ç‚¹çš„å€¼äº’ä¸ç›¸åŒ è‹¥ä½¿ç”¨ C æˆ– C++ è¯­è¨€ï¼Œä½ ä¸éœ€è¦ free æˆ– delete è¢«åˆ é™¤çš„èŠ‚ç‚¹ã€‚\nåŒæŒ‡é’ˆ ç®—æ³•æµç¨‹ï¼š\nå®šé‡ä¸¤ä¸ªå˜é‡ i å’Œ jï¼Œè¿™ä¸¤ä¸ªå˜é‡åˆå§‹éƒ½æŒ‡å‘é“¾è¡¨çš„å¤´ç»“ç‚¹ å…ˆè®© j å‘å‰ç§»åŠ¨ k æ­¥ i å’Œ j åŒæ—¶å‘å‰ç§»åŠ¨ å½“ j çš„å€¼ä¸º null æ—¶ï¼Œi å°±æ˜¯å€’æ•°ç¬¬ k ä¸ªèŠ‚ç‚¹ ä»£ç å¦‚ä¸‹ï¼š\nfunc getKthFromEnd(head *ListNode, k int) *ListNode { h := head i, j := h, h // j å…ˆèµ° k æ­¥ for i := 0; i \u0026lt; k; i++ { if j != nil { j = j.Next } } // ä¹‹å i å’Œ j åŒæ—¶å‰è¿› 1 æ­¥ for j != nil { i = i.Next j = j.Next } return i } ","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-18-shan-chu-lian-biao-de-jie-dian/","summary":"é¢˜ç›®æè¿° ç»™å®šå•å‘é“¾è¡¨çš„å¤´æŒ‡é’ˆå’Œä¸€ä¸ªè¦åˆ é™¤çš„èŠ‚ç‚¹çš„å€¼ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚\nè¿”å›åˆ é™¤åçš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚\næ³¨æ„ï¼šæ­¤é¢˜å¯¹æ¯”åŸé¢˜æœ‰æ”¹åŠ¨\nç¤ºä¾‹ 1:","title":"å‰‘æŒ‡ Offer 18. åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹"},{"contents":" é¢˜ç›®æè¿° æ‰¾å‡ºæ•°ç»„ä¸­é‡å¤çš„æ•°å­—ã€‚\nåœ¨ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ nums é‡Œçš„æ‰€æœ‰æ•°å­—éƒ½åœ¨ 0ï½n-1 çš„èŒƒå›´å†…ã€‚æ•°ç»„ä¸­æŸäº›æ•°å­—æ˜¯é‡å¤çš„ï¼Œä½†ä¸çŸ¥é“æœ‰å‡ ä¸ªæ•°å­—é‡å¤äº†ï¼Œä¹Ÿä¸çŸ¥é“æ¯ä¸ªæ•°å­—é‡å¤äº†å‡ æ¬¡ã€‚è¯·æ‰¾å‡ºæ•°ç»„ä¸­ä»»æ„ä¸€ä¸ªé‡å¤çš„æ•°å­—ã€‚\nç¤ºä¾‹ 1ï¼š\nè¾“å…¥ï¼š [2, 3, 1, 0, 2, 5, 3] è¾“å‡ºï¼š2 æˆ– 3\né™åˆ¶ï¼š\n2 \u0026lt;= n \u0026lt;= 100000\næ–¹æ³•1ï¼šå“ˆå¸Œè¡¨ çœ‹åˆ°è¿™ç§å¯»æ‰¾é‡å¤å…ƒç´ çš„é¢˜ç›®ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯å“ˆå¸Œè¡¨ï¼Œé€šè¿‡ map çš„ key å¯ä»¥å¾ˆå®¹æ˜“çš„æ‰¾åˆ°é‡å¤å…ƒç´ ï¼š\nfunc findRepeatNumber(nums []int) int { m := make(map[int]struct{}) for i := 0; i \u0026lt; len(nums); i++ { // å¦‚æœè¯¥ key å·²å­˜åœ¨ï¼Œè¯´æ˜é‡å¤ if _, ok := m[nums[i]]; ok { return nums[i] } m[nums[i]] = struct{}{} } return -1 } // æ‰§è¡Œç”¨æ—¶: 40 ms // å†…å­˜æ¶ˆè€—: 9.6 MB å¤æ‚åº¦åˆ†æï¼š æ—¶é—´å¤æ‚åº¦ O(N) ï¼š éå†æ•°ç»„ä½¿ç”¨ O(N) ï¼Œmap æ·»åŠ ä¸æŸ¥æ‰¾å…ƒç´ çš†ä¸º O(1) ã€‚ ç©ºé—´å¤æ‚åº¦ O(N) ï¼š map å ç”¨ O(N) å¤§å°çš„é¢å¤–ç©ºé—´ã€‚\næ–¹æ³•2ï¼šæ’åº å¯¹æ•°ç»„æ’åºåï¼Œçœ‹ç›¸é‚»å…ƒç´ æ˜¯å¦æœ‰ç›¸åŒçš„ï¼š\nfunc findRepeatNumber(nums []int) int { // å…ˆæ’åº sort.Slice(nums, func(i, j int) bool { return nums[i] \u0026lt; nums[j] }) for i := 0; i \u0026lt; len(nums); i++ { if nums[i] == nums[i+1] { return nums[i] } } return -1 } // æ‰§è¡Œç”¨æ—¶: 48 ms // å†…å­˜æ¶ˆè€—: 8.7 MB å¤æ‚åº¦åˆ†æï¼š æ—¶é—´å¤æ‚åº¦ O(NlogN) ï¼š æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(NlogN) ç©ºé—´å¤æ‚åº¦ O(1) ï¼š æ— éœ€é¢å¤–ç©ºé—´\næ–¹æ³•3ï¼šåŸåœ°ç½®æ¢ã€åŸåœ°å“ˆå¸Œ é¢˜å¹²ä¸­æœ‰ä¸€å¥å¾ˆé‡è¦çš„è¯ï¼šåœ¨ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ nums é‡Œçš„æ‰€æœ‰æ•°å­—éƒ½åœ¨ 0ï½n-1 çš„èŒƒå›´å†…ï¼Œè¿™è¯´æ˜äº†æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥å­˜æ”¾åœ¨å…¶å€¼ä¸‹æ ‡å¤„ï¼ˆä¾‹å¦‚ 2 å¯ä»¥å­˜åœ¨ nums[2]ï¼Œ5 å¯ä»¥å­˜åœ¨ nums[5]ï¼‰,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŸç§æ–¹æ³•ï¼Œå°†æ¯ä¸ªå…ƒç´ æ”¾åˆ°å…¶å¯¹åº”ä½ç½®ï¼Œå®ç°ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå“ˆå¸Œè¡¨çš„ key æ˜¯æ•°ç»„ä¸‹æ ‡ï¼Œvalue æ˜¯ä¸ä¸‹æ ‡ç›¸åŒçš„å€¼ï¼Œä¾‹å¦‚ï¼š\nå½“ key å‘ç”Ÿå†²çªæ—¶ï¼Œè¯´æ˜è¯¥å…ƒç´ æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é‡å¤æ•°ï¼Œä½†æ˜¯ç”¨ä»€ä¹ˆæ–¹æ³•ä½¿æ¯ä¸ªå…ƒç´ ç§»åŠ¨åˆ°å…¶å¯¹åº”ä½ç½®å‘¢?\nè¿™é‡Œå¯ä»¥ä½¿ç”¨åŸåœ°ç½®æ¢æ³•ï¼Œé¦–å…ˆåˆ¤æ–­ i æ˜¯å¦ç­‰äº nums[i]ï¼Œä¸æ˜¯çš„è¯åˆ™ç»§ç»­åˆ¤æ–­ nums[i] æ˜¯å¦ç­‰äº nums[nums[i]]ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†å†²çªï¼Œè¯¥æ•°ä¸ºé‡å¤æ•°ï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™äº¤æ¢ä¸¤ä¸ªä½ç½®çš„å€¼ï¼ˆswap(nums[i], nums[nums[i]]) ï¼‰ï¼Œå¦‚æœ i ç­‰äº nums[i]ï¼Œåˆ™è¯´æ˜ nums[i] å·²ç»æ”¾åœ¨äº†å¯¹åº”çš„ä½ç½®ï¼Œæ­¤æ—¶å¯ä»¥i++ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ° i \u0026gt; len(nums) æˆ–è€… returnã€‚\nç®—æ³•æµç¨‹ï¼š\néå†æ•°ç»„ nums ï¼Œè®¾ç´¢å¼•åˆå§‹å€¼ä¸º i = 0 : è‹¥ nums[i] = i ï¼š è¯´æ˜æ­¤æ•°å­—å·²åœ¨å¯¹åº”ç´¢å¼•ä½ç½®ï¼Œæ— éœ€äº¤æ¢ï¼Œå› æ­¤è·³è¿‡ï¼› è‹¥ nums[nums[i]] = nums[i] ï¼š ä»£è¡¨ç´¢å¼• nums[i] å¤„å’Œç´¢å¼• i å¤„çš„å…ƒç´ å€¼éƒ½ä¸º nums[i] ï¼Œå³æ‰¾ åˆ°ä¸€ç»„é‡å¤å€¼ï¼Œè¿”å›æ­¤å€¼ nums[i] ï¼› å¦åˆ™ï¼š äº¤æ¢ç´¢å¼•ä¸º i å’Œ nums[i] çš„å…ƒç´ å€¼ï¼Œå°†æ­¤æ•°å­—äº¤æ¢è‡³å¯¹åº”ç´¢å¼•ä½ç½®ã€‚ è‹¥éå†å®Œæ¯•å°šæœªè¿”å›ï¼Œåˆ™è¿”å› -1 ã€‚ æ–‡å­—å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œç»“åˆä¸‹é¢çš„å›¾å¸®åŠ©ç†è§£ï¼š\nfunc findRepeatNumber(nums []int) int { i := 0 for i \u0026lt; len(nums) { if i == nums[nums[i]] { i++ } else if nums[i] == nums[nums[i]] { return nums[i] } nums[i], nums[nums[i]] = nums[nums[i]], nums[i] } return -1 } // æ‰§è¡Œç”¨æ—¶: 36 ms // å†…å­˜æ¶ˆè€—: 8.7 MB å¤æ‚åº¦åˆ†æï¼š æ—¶é—´å¤æ‚åº¦ O(N) ï¼š éå†æ•°ç»„ä½¿ç”¨ O(N)ï¼Œæ¯è½®éå†çš„åˆ¤æ–­å’Œäº¤æ¢æ“ä½œä½¿ç”¨ O(1)ã€‚ ç©ºé—´å¤æ‚åº¦ O(1) ï¼š ä½¿ç”¨å¸¸æ•°å¤æ‚åº¦çš„é¢å¤–ç©ºé—´ã€‚\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/jian-zhi-offer-03-shu-zu-zhong-chong-fu-de-shu-zi/","summary":"é¢˜ç›®æè¿° æ‰¾å‡ºæ•°ç»„ä¸­é‡å¤çš„æ•°å­—ã€‚\nåœ¨ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ nums é‡Œçš„æ‰€æœ‰æ•°å­—éƒ½åœ¨ 0ï½n-1 çš„èŒƒå›´å†…ã€‚æ•°ç»„ä¸­æŸäº›æ•°å­—æ˜¯é‡å¤çš„ï¼Œä½†ä¸çŸ¥é“æœ‰å‡ ä¸ªæ•°å­—é‡å¤äº†ï¼Œä¹Ÿä¸çŸ¥é“æ¯ä¸ªæ•°å­—é‡å¤äº†å‡ æ¬¡ã€‚è¯·æ‰¾å‡ºæ•°ç»„ä¸­ä»»æ„ä¸€ä¸ªé‡å¤çš„æ•°å­—ã€‚","title":"å‰‘æŒ‡ Offer 03. æ•°ç»„ä¸­é‡å¤çš„æ•°å­—"},{"contents":"é¢˜ç›®æè¿° è¿ç”¨ä½ æ‰€æŒæ¡çš„æ•°æ®ç»“æ„ï¼Œè®¾è®¡å’Œå®ç°ä¸€ä¸ª LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜æœºåˆ¶ã€‚å®ƒåº”è¯¥æ”¯æŒä»¥ä¸‹æ“ä½œï¼š è·å–æ•°æ® get å’Œ å†™å…¥æ•°æ® put ã€‚\nè·å–æ•°æ® get(key) - å¦‚æœå…³é”®å­— (key) å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è·å–å…³é”®å­—çš„å€¼ï¼ˆæ€»æ˜¯æ­£æ•°ï¼‰ï¼Œå¦åˆ™è¿”å› -1ã€‚ å†™å…¥æ•°æ® put(key, value) - å¦‚æœå…³é”®å­—å·²ç»å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶æ•°æ®å€¼ï¼›å¦‚æœå…³é”®å­—ä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥è¯¥ç»„ã€Œå…³é”®å­—/å€¼ã€ã€‚å½“ç¼“å­˜å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå®ƒåº”è¯¥åœ¨å†™å…¥æ–°æ•°æ®ä¹‹å‰åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®å€¼ï¼Œä»è€Œä¸ºæ–°çš„æ•°æ®å€¼ç•™å‡ºç©ºé—´ã€‚\nç¤ºä¾‹:\nLRUCache cache = new LRUCache( 2 /* ç¼“å­˜å®¹é‡ */ );\ncache.put(1, 1); cache.put(2, 2); cache.get(1); // è¿”å› 1 cache.put(3, 3); // è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 2 ä½œåºŸ cache.get(2); // è¿”å› -1 (æœªæ‰¾åˆ°) cache.put(4, 4); // è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 1 ä½œåºŸ cache.get(1); // è¿”å› -1 (æœªæ‰¾åˆ°) cache.get(3); // è¿”å› 3 cache.get(4); // è¿”å› 4\nè¿›é˜¶:\nä½ æ˜¯å¦å¯ä»¥åœ¨ O(1) æ—¶é—´å¤æ‚åº¦å†…å®Œæˆè¿™ä¸¤ç§æ“ä½œï¼Ÿ\nä¸Šé¢çš„æ“ä½œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né€šè¿‡ä¸Šå›¾åº”è¯¥å¯ä»¥å¤§è‡´äº†è§£ lru çš„å·¥ä½œè¿‡ç¨‹äº†ï¼Œè¦æƒ³è¿›ä¸€æ­¥äº†è§£ lruï¼Œå¯ä»¥è‡ªè¡Œç½‘ä¸ŠæŸ¥é˜…ã€‚\nç®—æ³•è®¾è®¡ ä½æ•ˆç‡ç‰ˆ å¦‚æœå¿½è§†é¢˜ç›®æè¿°ä¸­çš„è¿›é˜¶è¦æ±‚ï¼šåœ¨ O(1) æ—¶é—´å¤æ‚åº¦å†…å®Œæˆè¿™ä¸¤ç§æ“ä½œï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å†™å‡ºä¸€ä¸ª lru ç®—æ³•ï¼Œåªè¦é€šè¿‡ä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨é“¾è¡¨ä¸­å­˜å‚¨ map å³å¯å®ç°ï¼Œ\n// âš ï¸ ä½æ•ˆç‡ï¼Œget å’Œ put æ—¶é—´å¤æ‚åº¦é O(1) type LRUCache struct { Cap int Element *list.List } func Constructor(capacity int) LRUCache { l := LRUCache{ Cap: capacity, Element: list.New(), } return l } func (c *LRUCache) Get(key int) int { for i := c.Element.Front(); i != nil; i = i.Next() { data := i.Value.(map[int]int) if val, ok := data[key]; ok { // å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›çš„åŒæ—¶å°†å…¶ç½®äºå¤´éƒ¨ c.Element.MoveToFront(i) return val } } return -1 } func (c *LRUCache) Put(key int, value int) { e := c.Element // å¦‚æœ key å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°å€¼ï¼ŒåŒæ—¶ç½®äºå¤´éƒ¨ for i := e.Front(); i != nil; i = i.Next() { data := i.Value.(map[int]int) if _, ok := data[key]; ok { data[key] = value // ç½®äºå¤´éƒ¨ c.Element.MoveToFront(i) return } } // å¦‚æœå·²æ»¡ï¼Œåˆ™ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´  if e.Len() == c.Cap { e.Remove(e.Back()) } data := make(map[int]int) data[key] = value e.PushFront(data) } è™½ç„¶é€šè¿‡äº†æµ‹è¯•ï¼Œä½†æ˜¯æ•ˆç‡éå¸¸ä½ä¸‹ï¼Œå› ä¸ºæ¯æ¬¡ get å’Œ put éƒ½éœ€è¦éå†é“¾è¡¨ï¼Œå¹¶ä¸”åˆ¤æ–­å½“å‰é“¾è¡¨å­˜å‚¨çš„ map çš„ keyï¼Œæ—¶é—´å¤æ‚åº¦ä¼šéå¸¸é«˜ã€‚\næ›´å¥½çš„æ–¹æ³•ï¼š\nè¦è®© put å’Œ get æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºè¿™ä¸ªæ•°æ®ç»“æ„å¿…è¦çš„æ¡ä»¶ï¼šæŸ¥æ‰¾å¿«ï¼Œæ’å…¥å¿«ï¼Œåˆ é™¤å¿«ï¼Œæœ‰é¡ºåºä¹‹åˆ†ã€‚\nå› ä¸ºæ˜¾ç„¶ cache å¿…é¡»æœ‰é¡ºåºä¹‹åˆ†ï¼Œä»¥åŒºåˆ†æœ€è¿‘ä½¿ç”¨çš„å’Œä¹…æœªä½¿ç”¨çš„æ•°æ®ï¼›è€Œä¸”æˆ‘ä»¬è¦åœ¨ cache ä¸­æŸ¥æ‰¾é”®æ˜¯å¦å·²å­˜åœ¨ï¼›å¦‚æœå®¹é‡æ»¡äº†è¦åˆ é™¤æœ€åä¸€ä¸ªæ•°æ®ï¼›æ¯æ¬¡è®¿é—®è¿˜è¦æŠŠæ•°æ®æ’å…¥åˆ°é˜Ÿå¤´ã€‚\né‚£ä¹ˆï¼Œä»€ä¹ˆæ•°æ®ç»“æ„åŒæ—¶ç¬¦åˆä¸Šè¿°æ¡ä»¶å‘¢ï¼Ÿå“ˆå¸Œè¡¨æŸ¥æ‰¾å¿«ï¼Œä½†æ˜¯æ•°æ®æ— å›ºå®šé¡ºåºï¼›é“¾è¡¨æœ‰é¡ºåºä¹‹åˆ†ï¼Œæ’å…¥åˆ é™¤å¿«ï¼Œä½†æ˜¯æŸ¥æ‰¾æ…¢ã€‚æ‰€ä»¥ç»“åˆä¸€ä¸‹ï¼Œå½¢æˆä¸€ç§æ–°çš„æ•°æ®ç»“æ„ï¼šå“ˆå¸Œé“¾è¡¨ã€‚\nåŒé“¾è¡¨ä¸­å­˜å‚¨äº†ä¸€å¯¹é”®å€¼å¯¹ï¼Œå¹¶ä¸” é”® å’Œ å“ˆå¸Œè¡¨çš„ é”® ä¿æŒä¸€è‡´ï¼Œæ¥è¾¾åˆ° å“ˆå¸Œè¡¨æ˜ å°„åŒé“¾è¡¨çš„ç›®çš„ã€‚\nå“ˆå¸Œè¡¨å¯ä»¥ä½¿æŸ¥è¯¢ç›¸å…³æ“ä½œè¾¾åˆ° O(1) æ—¶é—´å¤æ‚åº¦ï¼Œä¾‹å¦‚ get æ“ä½œï¼Œä»¥åŠ put ä¸­ åˆ¤æ–­è¯¥ key æ˜¯å¦ä»¥åŠå­˜åœ¨ï¼›é€šè¿‡å“ˆå¸Œè¡¨å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å¯¹åº”çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯é“¾è¡¨çš„åˆ é™¤æ“ä½œä¹Ÿä¸º O(1) ï¼ˆé“¾è¡¨åˆ é™¤è™½ç„¶åªéœ€è¦æ”¹å˜æŒ‡é’ˆï¼Œä½†æ˜¯è¿˜éœ€è¦æ‰¾åˆ°è¯¥èŠ‚ç‚¹ï¼‰ã€‚\nå…·ä½“ä»£ç å¦‚ä¸‹ï¼š\ntype LRUCache struct { // æœ€å¤§å®¹é‡ cap int // map æ˜ å°„åˆ° åŒå‘é“¾è¡¨ï¼Œå®ç° O(1) çš„æ—¶é—´å¤æ‚åº¦ cache map[int]*list.Element // åŒå‘é“¾è¡¨å®ç° lru list *list.List } // è¯¥ç»“æ„ä½“ä½œä¸ºé“¾è¡¨çš„èŠ‚ç‚¹å€¼ï¼Œå¹¶ä¸” key ä¸ cache çš„ key ä¿æŒåŒæ­¥ï¼Œ // ä»¥æ­¤å®ç° map æ˜ å°„åˆ° list type kv struct { key int value int } func Constructor(capacity int) LRUCache { return LRUCache{ cap: capacity, cache: make(map[int]*list.Element), list: list.New(), } } func (c *LRUCache) Get(key int) int { // é€šè¿‡ cache (map ç±»å‹) æŸ¥è¯¢ keyï¼Œå› ä¸º list èŠ‚ç‚¹ value çš„ key ä¸ cache key ç›¸åŒï¼Œ // æ‰€ä»¥å¯ä»¥é€šè¿‡ cache ä»¥ O(1) æŸ¥è¯¢åˆ°å¯¹åº”çš„ list node if v, ok := c.cache[key]; ok { // å°†æŸ¥è¯¢åˆ°çš„ node ç§»åŠ¨åˆ° list å¤´éƒ¨ c.list.MoveToFront(v) // cache çš„ value æ˜¯ä¸€ä¸ª list nodeï¼Œå¹¶ä¸” node value æ˜¯ struct kvï¼Œ // è¿”å› struct kv çš„ value return v.Value.(*kv).value } return -1 } func (c *LRUCache) Put(key int, value int) { // å¦‚æœè¯¥ key å·²ç»å­˜åœ¨ï¼Œåˆ™æ›´æ–° valueï¼Œå¹¶ç½®äº list å¤´éƒ¨ if v, ok := c.cache[key]; ok { // æ›´æ–°ä½ç½® c.list.MoveToFront(v) // æ›´æ–° value v.Value = \u0026amp;kv{ key: key, value: value, } // è¯¥ key ä¸å­˜åœ¨ } else { // å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§å®¹é‡ if c.list.Len() == c.cap { // åˆ é™¤ cache ä¸­å¤„äºæœ«å°¾çš„ key delete(c.cache, c.list.Back().Value.(*kv).key) // åˆ é™¤ list ä¸­æœ€åä¸€ä¸ª node c.list.Remove(c.list.Back()) } // è¿˜æœ‰å‰©ä½™å®¹é‡ e := \u0026amp;kv{ key: key, value: value, } // ç½®äº list å¤´éƒ¨ c.list.PushFront(e) // value å– list é¦–å…ƒç´  c.cache[key] = c.list.Front() } } å¯ä»¥çœ‹åˆ°æ‰§è¡Œè€—æ—¶ç¼©çŸ­äº†è¿‘ 7 å€ã€‚\næ³¨ï¼šgo å®˜æ–¹æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼ kvç¼“å­˜åº“ï¼Œé‡Œé¢æœ‰ lru çš„å®ç°æ–¹å¼ï¼Œåœ°å€å¦‚ä¸‹ï¼š\nhttps://github.com/golang/groupcache/blob/master/lru/lru.go\n","date":"2021å¹´04æœˆ16æ—¥","permalink":"/posts/leetcode146lru-huan-cun-ji-zhi/","summary":"é¢˜ç›®æè¿° è¿ç”¨ä½ æ‰€æŒæ¡çš„æ•°æ®ç»“æ„ï¼Œè®¾è®¡å’Œå®ç°ä¸€ä¸ª LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜æœºåˆ¶ã€‚å®ƒåº”è¯¥æ”¯æŒä»¥ä¸‹æ“ä½œï¼š è·å–æ•°æ® get å’Œ å†™å…¥æ•°æ® put ã€‚","title":"LeetCode146.LRU ç¼“å­˜æœºåˆ¶"},{"contents":"docker å®‰è£… etcd åˆ›å»ºä¸€ä¸ª sh æ–‡ä»¶\nç²˜è´´ä¸‹é¢å†…å®¹\nrm -rf /tmp/etcd-data.tmp \u0026amp;\u0026amp; mkdir -p /tmp/etcd-data.tmp \u0026amp;\u0026amp; \\ # docker rmi quay.io/coreos/etcd:v3.3.13 || true \u0026amp;\u0026amp; \\ docker run -d \\ -p 2379:2379 \\ -p 2380:2380 \\ --mount type=bind,source=/tmp/etcd-data.tmp,destination=/etcd-data \\ --name etcd-gcr-v3.3.13 \\ quay.io/coreos/etcd:v3.3.13 \\ /usr/local/bin/etcd \\ --name s1 \\ --data-dir /etcd-data \\ --listen-client-urls http://0.0.0.0:2379 \\ --advertise-client-urls http://0.0.0.0:2379 \\ --listen-peer-urls http://0.0.0.0:2380 \\ --initial-advertise-peer-urls http://0.0.0.0:2380 \\ --initial-cluster s1=http://0.0.0.0:2380 \\ --initial-cluster-token tkn \\ --initial-cluster-state new æ‰§è¡Œ\né™„ï¼šè¿›å…¥å®¹å™¨çš„å‘½ä»¤\ndocker exec -it å®¹å™¨id /usr/local/bin/etcdctl ","date":"2020å¹´11æœˆ06æ—¥","permalink":"/posts/2020-11-6-docker-etcd/","summary":"docker å®‰è£… etcd åˆ›å»ºä¸€ä¸ª sh æ–‡ä»¶","title":"docker å®‰è£… etcd"},{"contents":"ä½¿ç”¨dockerå®‰è£…redisï¼ŒæŒ‚è½½å¤–éƒ¨é…ç½®å’Œæ•°æ® mkdir /docker\nmkdir /docker/redis\nmkdir /docker/redis/conf\nmkdir /docker/redis/data\nåˆ›å»ºredis.confé…ç½®æ–‡ä»¶\ntouch /docker/redis/conf/redis.conf\ncd åˆ°confä¸‹ï¼Œvi redis.conf\niè¿›å…¥æ’å…¥æ¨¡å¼ï¼Œç²˜è´´é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¸­éœ€å°†daemonizeè®¾ç½®ä¸ºnoï¼Œ#requirepass xx å»æ‰æ³¨é‡Šï¼Œå¹¶è®¾ç½®å¯†ç ï¼ˆxxå¤„å³ä¸ºè¦è®¾ç½®çš„å¯†ç ï¼‰ï¼Œprotected-modeæ”¹ä¸ºnoï¼Œbindæ³¨é‡Šæ‰ã€‚\nesc :wqä¿å­˜\ndocker run -d \u0026ndash;privileged=true -p 6379:6379 -v /docker/redis/conf/redis.conf:/etc/redis/redis.conf -v /docker/redis/data:/data \u0026ndash;name redis redis redis-server /etc/redis/redis.conf \u0026ndash;appendonly yes\nmacä¸‹ï¼š\ndocker run -d \u0026ndash;privileged=true -p 6379:6379 -v /usr/local/redis/conf/redis.conf:/etc/redis/redis.conf -v /usr/local/redis/data:/data \u0026ndash;name redis redis redis-server /etc/redis/redis.conf \u0026ndash;appendonly yes\nåˆ›å»ºæŒ‚è½½å¤–éƒ¨é…ç½®çš„å®¹å™¨\nå‚æ•°è¯´æ˜ï¼š\n\u0026ndash;privileged=trueï¼šå®¹å™¨å†…çš„rootæ‹¥æœ‰çœŸæ­£rootæƒé™ï¼Œå¦åˆ™å®¹å™¨å†…rootåªæ˜¯å¤–éƒ¨æ™®é€šç”¨æˆ·æƒé™\n-v /docker/redis/conf/redis.conf:/etc/redis/redis.confï¼šæ˜ å°„é…ç½®æ–‡ä»¶\n-v /docker/redis/data:/dataï¼šæ˜ å°„æ•°æ®ç›®å½•\nredis-server /etc/redis/redis.confï¼šæŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨redis-serverè¿›ç¨‹\n\u0026ndash;appendonly yesï¼šå¼€å¯æ•°æ®æŒä¹…åŒ–\né™„ï¼šå·²ç»ä¿®æ”¹å¥½çš„é…ç½®æ–‡ä»¶\n# Redis configuration file example. # # Note that in order to read the configuration file, Redis must be # started with the file path as first argument: # # ./redis-server /path/to/redis.conf # Note on units: when memory size is needed, it is possible to specify # it in the usual form of 1k 5GB 4M and so forth: # # 1k =\u0026gt; 1000 bytes # 1kb =\u0026gt; 1024 bytes # 1m =\u0026gt; 1000000 bytes # 1mb =\u0026gt; 1024*1024 bytes # 1g =\u0026gt; 1000000000 bytes # 1gb =\u0026gt; 1024*1024*1024 bytes # # units are case insensitive so 1GB 1Gb 1gB are all the same. ################################## INCLUDES ################################### # Include one or more other config files here. This is useful if you # have a standard template that goes to all Redis servers but also need # to customize a few per-server settings. Include files can include # other files, so use this wisely. # # Notice option \u0026quot;include\u0026quot; won't be rewritten by command \u0026quot;CONFIG REWRITE\u0026quot; # from admin or Redis Sentinel. Since Redis always uses the last processed # line as value of a configuration directive, you'd better put includes # at the beginning of this file to avoid overwriting config change at runtime. # # If instead you are interested in using includes to override configuration # options, it is better to use include as the last line. # # include /path/to/local.conf # include /path/to/other.conf ################################## MODULES ##################################### # Load modules at startup. If the server is not able to load modules # it will abort. It is possible to use multiple loadmodule directives. # # loadmodule /path/to/my_module.so # loadmodule /path/to/other_module.so ################################## NETWORK ##################################### # By default, if no \u0026quot;bind\u0026quot; configuration directive is specified, Redis listens # for connections from all the network interfaces available on the server. # It is possible to listen to just one or multiple selected interfaces using # the \u0026quot;bind\u0026quot; configuration directive, followed by one or more IP addresses. # # Examples: # # bind 192.168.1.100 10.0.0.1 # bind 127.0.0.1 ::1 # # ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the # internet, binding to all the interfaces is dangerous and will expose the # instance to everybody on the internet. So by default we uncomment the # following bind directive, that will force Redis to listen only into # the IPv4 loopback interface address (this means Redis will be able to # accept connections only from clients running into the same computer it # is running). # # IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES # JUST COMMENT THE FOLLOWING LINE. # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ # bind 127.0.0.1 ::1 # Protected mode is a layer of security protection, in order to avoid that # Redis instances left open on the internet are accessed and exploited. # # When protected mode is on and if: # # 1) The server is not binding explicitly to a set of addresses using the # \u0026quot;bind\u0026quot; directive. # 2) No password is configured. # # The server only accepts connections from clients connecting from the # IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain # sockets. # # By default protected mode is enabled. You should disable it only if # you are sure you want clients from other hosts to connect to Redis # even if no authentication is configured, nor a specific set of interfaces # are explicitly listed using the \u0026quot;bind\u0026quot; directive. protected-mode no # Accept connections on the specified port, default is 6379 (IANA #815344). # If port 0 is specified Redis will not listen on a TCP socket. port 6379 # TCP listen() backlog. # # In high requests-per-second environments you need an high backlog in order # to avoid slow clients connections issues. Note that the Linux kernel # will silently truncate it to the value of /proc/sys/net/core/somaxconn so # make sure to raise both the value of somaxconn and tcp_max_syn_backlog # in order to get the desired effect. tcp-backlog 511 # Unix socket. # # Specify the path for the Unix socket that will be used to listen for # incoming connections. There is no default, so Redis will not listen # on a unix socket when not specified. # # unixsocket /tmp/redis.sock # unixsocketperm 700 # Close the connection after a client is idle for N seconds (0 to disable) timeout 0 # TCP keepalive. # # If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence # of communication. This is useful for two reasons: # # 1) Detect dead peers. # 2) Take the connection alive from the point of view of network # equipment in the middle. # # On Linux, the specified value (in seconds) is the period used to send ACKs. # Note that to close the connection the double of the time is needed. # On other kernels the period depends on the kernel configuration. # # A reasonable value for this option is 300 seconds, which is the new # Redis default starting with Redis 3.2.1. tcp-keepalive 300 ################################# TLS/SSL ##################################### # By default, TLS/SSL is disabled. To enable it, the \u0026quot;tls-port\u0026quot; configuration # directive can be used to define TLS-listening ports. To enable TLS on the # default port, use: # # port 0 # tls-port 6379 # Configure a X.509 certificate and private key to use for authenticating the # server to connected clients, masters or cluster peers. These files should be # PEM formatted. # # tls-cert-file redis.crt # tls-key-file redis.key # Configure a DH parameters file to enable Diffie-Hellman (DH) key exchange: # # tls-dh-params-file redis.dh # Configure a CA certificate(s) bundle or directory to authenticate TLS/SSL # clients and peers. Redis requires an explicit configuration of at least one # of these, and will not implicitly use the system wide configuration. # # tls-ca-cert-file ca.crt # tls-ca-cert-dir /etc/ssl/certs # By default, clients (including replica servers) on a TLS port are required # to authenticate using valid client side certificates. # # If \u0026quot;no\u0026quot; is specified, client certificates are not required and not accepted. # If \u0026quot;optional\u0026quot; is specified, client certificates are accepted and must be # valid if provided, but are not required. # # tls-auth-clients no # tls-auth-clients optional # By default, a Redis replica does not attempt to establish a TLS connection # with its master. # # Use the following directive to enable TLS on replication links. # # tls-replication yes # By default, the Redis Cluster bus uses a plain TCP connection. To enable # TLS for the bus protocol, use the following directive: # # tls-cluster yes # Explicitly specify TLS versions to support. Allowed values are case insensitive # and include \u0026quot;TLSv1\u0026quot;, \u0026quot;TLSv1.1\u0026quot;, \u0026quot;TLSv1.2\u0026quot;, \u0026quot;TLSv1.3\u0026quot; (OpenSSL \u0026gt;= 1.1.1) or # any combination. To enable only TLSv1.2 and TLSv1.3, use: # # tls-protocols \u0026quot;TLSv1.2 TLSv1.3\u0026quot; # Configure allowed ciphers. See the ciphers(1ssl) manpage for more information # about the syntax of this string. # # Note: this configuration applies only to \u0026lt;= TLSv1.2. # # tls-ciphers DEFAULT:!MEDIUM # Configure allowed TLSv1.3 ciphersuites. See the ciphers(1ssl) manpage for more # information about the syntax of this string, and specifically for TLSv1.3 # ciphersuites. # # tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256 # When choosing a cipher, use the server's preference instead of the client # preference. By default, the server follows the client's preference. # # tls-prefer-server-ciphers yes # By default, TLS session caching is enabled to allow faster and less expensive # reconnections by clients that support it. Use the following directive to disable # caching. # # tls-session-caching no # Change the default number of TLS sessions cached. A zero value sets the cache # to unlimited size. The default size is 20480. # # tls-session-cache-size 5000 # Change the default timeout of cached TLS sessions. The default timeout is 300 # seconds. # # tls-session-cache-timeout 60 ################################# GENERAL ##################################### # By default Redis does not run as a daemon. Use 'yes' if you need it. # Note that Redis will write a pid file in /usr/local/var/run/redis.pid when daemonized. daemonize no # If you run Redis from upstart or systemd, Redis can interact with your # supervision tree. Options: # supervised no - no supervision interaction # supervised upstart - signal upstart by putting Redis into SIGSTOP mode # supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET # supervised auto - detect upstart or systemd method based on # UPSTART_JOB or NOTIFY_SOCKET environment variables # Note: these supervision methods only signal \u0026quot;process is ready.\u0026quot; # They do not enable continuous liveness pings back to your supervisor. supervised no # If a pid file is specified, Redis writes it where specified at startup # and removes it at exit. # # When the server runs non daemonized, no pid file is created if none is # specified in the configuration. When the server is daemonized, the pid file # is used even if not specified, defaulting to \u0026quot;/usr/local/var/run/redis.pid\u0026quot;. # # Creating a pid file is best effort: if Redis is not able to create it # nothing bad happens, the server will start and run normally. pidfile /var/run/redis_6379.pid # Specify the server verbosity level. # This can be one of: # debug (a lot of information, useful for development/testing) # verbose (many rarely useful info, but not a mess like the debug level) # notice (moderately verbose, what you want in production probably) # warning (only very important / critical messages are logged) loglevel notice # Specify the log file name. Also the empty string can be used to force # Redis to log on the standard output. Note that if you use standard # output for logging but daemonize, logs will be sent to /dev/null logfile \u0026quot;\u0026quot; # To enable logging to the system logger, just set 'syslog-enabled' to yes, # and optionally update the other syslog parameters to suit your needs. # syslog-enabled no # Specify the syslog identity. # syslog-ident redis # Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7. # syslog-facility local0 # Set the number of databases. The default database is DB 0, you can select # a different one on a per-connection basis using SELECT \u0026lt;dbid\u0026gt; where # dbid is a number between 0 and 'databases'-1 databases 16 # By default Redis shows an ASCII art logo only when started to log to the # standard output and if the standard output is a TTY. Basically this means # that normally a logo is displayed only in interactive sessions. # # However it is possible to force the pre-4.0 behavior and always show a # ASCII art logo in startup logs by setting the following option to yes. always-show-logo yes ################################ SNAPSHOTTING ################################ # # Save the DB on disk: # # save \u0026lt;seconds\u0026gt; \u0026lt;changes\u0026gt; # # Will save the DB if both the given number of seconds and the given # number of write operations against the DB occurred. # # In the example below the behaviour will be to save: # after 900 sec (15 min) if at least 1 key changed # after 300 sec (5 min) if at least 10 keys changed # after 60 sec if at least 10000 keys changed # # Note: you can disable saving completely by commenting out all \u0026quot;save\u0026quot; lines. # # It is also possible to remove all the previously configured save # points by adding a save directive with a single empty string argument # like in the following example: # # save \u0026quot;\u0026quot; save 900 1 save 300 10 save 60 10000 # By default Redis will stop accepting writes if RDB snapshots are enabled # (at least one save point) and the latest background save failed. # This will make the user aware (in a hard way) that data is not persisting # on disk properly, otherwise chances are that no one will notice and some # disaster will happen. # # If the background saving process will start working again Redis will # automatically allow writes again. # # However if you have setup your proper monitoring of the Redis server # and persistence, you may want to disable this feature so that Redis will # continue to work as usual even if there are problems with disk, # permissions, and so forth. stop-writes-on-bgsave-error yes # Compress string objects using LZF when dump .rdb databases? # For default that's set to 'yes' as it's almost always a win. # If you want to save some CPU in the saving child set it to 'no' but # the dataset will likely be bigger if you have compressible values or keys. rdbcompression yes # Since version 5 of RDB a CRC64 checksum is placed at the end of the file. # This makes the format more resistant to corruption but there is a performance # hit to pay (around 10%) when saving and loading RDB files, so you can disable it # for maximum performances. # # RDB files created with checksum disabled have a checksum of zero that will # tell the loading code to skip the check. rdbchecksum yes # The filename where to dump the DB dbfilename dump.rdb # Remove RDB files used by replication in instances without persistence # enabled. By default this option is disabled, however there are environments # where for regulations or other security concerns, RDB files persisted on # disk by masters in order to feed replicas, or stored on disk by replicas # in order to load them for the initial synchronization, should be deleted # ASAP. Note that this option ONLY WORKS in instances that have both AOF # and RDB persistence disabled, otherwise is completely ignored. # # An alternative (and sometimes better) way to obtain the same effect is # to use diskless replication on both master and replicas instances. However # in the case of replicas, diskless is not always an option. rdb-del-sync-files no # The working directory. # # The DB will be written inside this directory, with the filename specified # above using the 'dbfilename' configuration directive. # # The Append Only File will also be created inside this directory. # # Note that you must specify a directory here, not a file name. dir /usr/local/var/db/redis/ ################################# REPLICATION ################################# # Master-Replica replication. Use replicaof to make a Redis instance a copy of # another Redis server. A few things to understand ASAP about Redis replication. # # +------------------+ +---------------+ # | Master | ---\u0026gt; | Replica | # | (receive writes) | | (exact copy) | # +------------------+ +---------------+ # # 1) Redis replication is asynchronous, but you can configure a master to # stop accepting writes if it appears to be not connected with at least # a given number of replicas. # 2) Redis replicas are able to perform a partial resynchronization with the # master if the replication link is lost for a relatively small amount of # time. You may want to configure the replication backlog size (see the next # sections of this file) with a sensible value depending on your needs. # 3) Replication is automatic and does not need user intervention. After a # network partition replicas automatically try to reconnect to masters # and resynchronize with them. # # replicaof \u0026lt;masterip\u0026gt; \u0026lt;masterport\u0026gt; # If the master is password protected (using the \u0026quot;requirepass\u0026quot; configuration # directive below) it is possible to tell the replica to authenticate before # starting the replication synchronization process, otherwise the master will # refuse the replica request. # # masterauth \u0026lt;master-password\u0026gt; # # However this is not enough if you are using Redis ACLs (for Redis version # 6 or greater), and the default user is not capable of running the PSYNC # command and/or other commands needed for replication. In this case it's # better to configure a special user to use with replication, and specify the # masteruser configuration as such: # # masteruser \u0026lt;username\u0026gt; # # When masteruser is specified, the replica will authenticate against its # master using the new AUTH form: AUTH \u0026lt;username\u0026gt; \u0026lt;password\u0026gt;. # When a replica loses its connection with the master, or when the replication # is still in progress, the replica can act in two different ways: # # 1) if replica-serve-stale-data is set to 'yes' (the default) the replica will # still reply to client requests, possibly with out of date data, or the # data set may just be empty if this is the first synchronization. # # 2) if replica-serve-stale-data is set to 'no' the replica will reply with # an error \u0026quot;SYNC with master in progress\u0026quot; to all the kind of commands # but to INFO, replicaOF, AUTH, PING, SHUTDOWN, REPLCONF, ROLE, CONFIG, # SUBSCRIBE, UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB, # COMMAND, POST, HOST: and LATENCY. # replica-serve-stale-data yes # You can configure a replica instance to accept writes or not. Writing against # a replica instance may be useful to store some ephemeral data (because data # written on a replica will be easily deleted after resync with the master) but # may also cause problems if clients are writing to it because of a # misconfiguration. # # Since Redis 2.6 by default replicas are read-only. # # Note: read only replicas are not designed to be exposed to untrusted clients # on the internet. It's just a protection layer against misuse of the instance. # Still a read only replica exports by default all the administrative commands # such as CONFIG, DEBUG, and so forth. To a limited extent you can improve # security of read only replicas using 'rename-command' to shadow all the # administrative / dangerous commands. replica-read-only yes # Replication SYNC strategy: disk or socket. # # New replicas and reconnecting replicas that are not able to continue the # replication process just receiving differences, need to do what is called a # \u0026quot;full synchronization\u0026quot;. An RDB file is transmitted from the master to the # replicas. # # The transmission can happen in two different ways: # # 1) Disk-backed: The Redis master creates a new process that writes the RDB # file on disk. Later the file is transferred by the parent # process to the replicas incrementally. # 2) Diskless: The Redis master creates a new process that directly writes the # RDB file to replica sockets, without touching the disk at all. # # With disk-backed replication, while the RDB file is generated, more replicas # can be queued and served with the RDB file as soon as the current child # producing the RDB file finishes its work. With diskless replication instead # once the transfer starts, new replicas arriving will be queued and a new # transfer will start when the current one terminates. # # When diskless replication is used, the master waits a configurable amount of # time (in seconds) before starting the transfer in the hope that multiple # replicas will arrive and the transfer can be parallelized. # # With slow disks and fast (large bandwidth) networks, diskless replication # works better. repl-diskless-sync no # When diskless replication is enabled, it is possible to configure the delay # the server waits in order to spawn the child that transfers the RDB via socket # to the replicas. # # This is important since once the transfer starts, it is not possible to serve # new replicas arriving, that will be queued for the next RDB transfer, so the # server waits a delay in order to let more replicas arrive. # # The delay is specified in seconds, and by default is 5 seconds. To disable # it entirely just set it to 0 seconds and the transfer will start ASAP. repl-diskless-sync-delay 5 # ----------------------------------------------------------------------------- # WARNING: RDB diskless load is experimental. Since in this setup the replica # does not immediately store an RDB on disk, it may cause data loss during # failovers. RDB diskless load + Redis modules not handling I/O reads may also # cause Redis to abort in case of I/O errors during the initial synchronization # stage with the master. Use only if your do what you are doing. # ----------------------------------------------------------------------------- # # Replica can load the RDB it reads from the replication link directly from the # socket, or store the RDB to a file and read that file after it was completely # recived from the master. # # In many cases the disk is slower than the network, and storing and loading # the RDB file may increase replication time (and even increase the master's # Copy on Write memory and salve buffers). # However, parsing the RDB file directly from the socket may mean that we have # to flush the contents of the current database before the full rdb was # received. For this reason we have the following options: # # \u0026quot;disabled\u0026quot; - Don't use diskless load (store the rdb file to the disk first) # \u0026quot;on-empty-db\u0026quot; - Use diskless load only when it is completely safe. # \u0026quot;swapdb\u0026quot; - Keep a copy of the current db contents in RAM while parsing # the data directly from the socket. note that this requires # sufficient memory, if you don't have it, you risk an OOM kill. repl-diskless-load disabled # Replicas send PINGs to server in a predefined interval. It's possible to # change this interval with the repl_ping_replica_period option. The default # value is 10 seconds. # # repl-ping-replica-period 10 # The following option sets the replication timeout for: # # 1) Bulk transfer I/O during SYNC, from the point of view of replica. # 2) Master timeout from the point of view of replicas (data, pings). # 3) Replica timeout from the point of view of masters (REPLCONF ACK pings). # # It is important to make sure that this value is greater than the value # specified for repl-ping-replica-period otherwise a timeout will be detected # every time there is low traffic between the master and the replica. # # repl-timeout 60 # Disable TCP_NODELAY on the replica socket after SYNC? # # If you select \u0026quot;yes\u0026quot; Redis will use a smaller number of TCP packets and # less bandwidth to send data to replicas. But this can add a delay for # the data to appear on the replica side, up to 40 milliseconds with # Linux kernels using a default configuration. # # If you select \u0026quot;no\u0026quot; the delay for data to appear on the replica side will # be reduced but more bandwidth will be used for replication. # # By default we optimize for low latency, but in very high traffic conditions # or when the master and replicas are many hops away, turning this to \u0026quot;yes\u0026quot; may # be a good idea. repl-disable-tcp-nodelay no # Set the replication backlog size. The backlog is a buffer that accumulates # replica data when replicas are disconnected for some time, so that when a # replica wants to reconnect again, often a full resync is not needed, but a # partial resync is enough, just passing the portion of data the replica # missed while disconnected. # # The bigger the replication backlog, the longer the time the replica can be # disconnected and later be able to perform a partial resynchronization. # # The backlog is only allocated once there is at least a replica connected. # # repl-backlog-size 1mb # After a master has no longer connected replicas for some time, the backlog # will be freed. The following option configures the amount of seconds that # need to elapse, starting from the time the last replica disconnected, for # the backlog buffer to be freed. # # Note that replicas never free the backlog for timeout, since they may be # promoted to masters later, and should be able to correctly \u0026quot;partially # resynchronize\u0026quot; with the replicas: hence they should always accumulate backlog. # # A value of 0 means to never release the backlog. # # repl-backlog-ttl 3600 # The replica priority is an integer number published by Redis in the INFO # output. It is used by Redis Sentinel in order to select a replica to promote # into a master if the master is no longer working correctly. # # A replica with a low priority number is considered better for promotion, so # for instance if there are three replicas with priority 10, 100, 25 Sentinel # will pick the one with priority 10, that is the lowest. # # However a special priority of 0 marks the replica as not able to perform the # role of master, so a replica with priority of 0 will never be selected by # Redis Sentinel for promotion. # # By default the priority is 100. replica-priority 100 # It is possible for a master to stop accepting writes if there are less than # N replicas connected, having a lag less or equal than M seconds. # # The N replicas need to be in \u0026quot;online\u0026quot; state. # # The lag in seconds, that must be \u0026lt;= the specified value, is calculated from # the last ping received from the replica, that is usually sent every second. # # This option does not GUARANTEE that N replicas will accept the write, but # will limit the window of exposure for lost writes in case not enough replicas # are available, to the specified number of seconds. # # For example to require at least 3 replicas with a lag \u0026lt;= 10 seconds use: # # min-replicas-to-write 3 # min-replicas-max-lag 10 # # Setting one or the other to 0 disables the feature. # # By default min-replicas-to-write is set to 0 (feature disabled) and # min-replicas-max-lag is set to 10. # A Redis master is able to list the address and port of the attached # replicas in different ways. For example the \u0026quot;INFO replication\u0026quot; section # offers this information, which is used, among other tools, by # Redis Sentinel in order to discover replica instances. # Another place where this info is available is in the output of the # \u0026quot;ROLE\u0026quot; command of a master. # # The listed IP and address normally reported by a replica is obtained # in the following way: # # IP: The address is auto detected by checking the peer address # of the socket used by the replica to connect with the master. # # Port: The port is communicated by the replica during the replication # handshake, and is normally the port that the replica is using to # listen for connections. # # However when port forwarding or Network Address Translation (NAT) is # used, the replica may be actually reachable via different IP and port # pairs. The following two options can be used by a replica in order to # report to its master a specific set of IP and port, so that both INFO # and ROLE will report those values. # # There is no need to use both the options if you need to override just # the port or the IP address. # # replica-announce-ip 5.5.5.5 # replica-announce-port 1234 ############################### KEYS TRACKING ################################# # Redis implements server assisted support for client side caching of values. # This is implemented using an invalidation table that remembers, using # 16 millions of slots, what clients may have certain subsets of keys. In turn # this is used in order to send invalidation messages to clients. Please # to understand more about the feature check this page: # # https://redis.io/topics/client-side-caching # # When tracking is enabled for a client, all the read only queries are assumed # to be cached: this will force Redis to store information in the invalidation # table. When keys are modified, such information is flushed away, and # invalidation messages are sent to the clients. However if the workload is # heavily dominated by reads, Redis could use more and more memory in order # to track the keys fetched by many clients. # # For this reason it is possible to configure a maximum fill value for the # invalidation table. By default it is set to 1M of keys, and once this limit # is reached, Redis will start to evict keys in the invalidation table # even if they were not modified, just to reclaim memory: this will in turn # force the clients to invalidate the cached values. Basically the table # maximum size is a trade off between the memory you want to spend server # side to track information about who cached what, and the ability of clients # to retain cached objects in memory. # # If you set the value to 0, it means there are no limits, and Redis will # retain as many keys as needed in the invalidation table. # In the \u0026quot;stats\u0026quot; INFO section, you can find information about the number of # keys in the invalidation table at every given moment. # # Note: when key tracking is used in broadcasting mode, no memory is used # in the server side so this setting is useless. # # tracking-table-max-keys 1000000 ################################## SECURITY ################################### # Warning: since Redis is pretty fast an outside user can try up to # 1 million passwords per second against a modern box. This means that you # should use very strong passwords, otherwise they will be very easy to break. # Note that because the password is really a shared secret between the client # and the server, and should not be memorized by any human, the password # can be easily a long string from /dev/urandom or whatever, so by using a # long and unguessable password no brute force attack will be possible. # Redis ACL users are defined in the following format: # # user \u0026lt;username\u0026gt; ... acl rules ... # # For example: # # user worker +@list +@connection ~jobs:* on \u0026gt;ffa9203c493aa99 # # The special username \u0026quot;default\u0026quot; is used for new connections. If this user # has the \u0026quot;nopass\u0026quot; rule, then new connections will be immediately authenticated # as the \u0026quot;default\u0026quot; user without the need of any password provided via the # AUTH command. Otherwise if the \u0026quot;default\u0026quot; user is not flagged with \u0026quot;nopass\u0026quot; # the connections will start in not authenticated state, and will require # AUTH (or the HELLO command AUTH option) in order to be authenticated and # start to work. # # The ACL rules that describe what an user can do are the following: # # on Enable the user: it is possible to authenticate as this user. # off Disable the user: it's no longer possible to authenticate # with this user, however the already authenticated connections # will still work. # +\u0026lt;command\u0026gt; Allow the execution of that command # -\u0026lt;command\u0026gt; Disallow the execution of that command # +@\u0026lt;category\u0026gt; Allow the execution of all the commands in such category # with valid categories are like @admin, @set, @sortedset, ... # and so forth, see the full list in the server.c file where # the Redis command table is described and defined. # The special category @all means all the commands, but currently # present in the server, and that will be loaded in the future # via modules. # +\u0026lt;command\u0026gt;|subcommand Allow a specific subcommand of an otherwise # disabled command. Note that this form is not # allowed as negative like -DEBUG|SEGFAULT, but # only additive starting with \u0026quot;+\u0026quot;. # allcommands Alias for +@all. Note that it implies the ability to execute # all the future commands loaded via the modules system. # nocommands Alias for -@all. # ~\u0026lt;pattern\u0026gt; Add a pattern of keys that can be mentioned as part of # commands. For instance ~* allows all the keys. The pattern # is a glob-style pattern like the one of KEYS. # It is possible to specify multiple patterns. # allkeys Alias for ~* # resetkeys Flush the list of allowed keys patterns. # \u0026gt;\u0026lt;password\u0026gt; Add this passowrd to the list of valid password for the user. # For example \u0026gt;mypass will add \u0026quot;mypass\u0026quot; to the list. # This directive clears the \u0026quot;nopass\u0026quot; flag (see later). # \u0026lt;\u0026lt;password\u0026gt; Remove this password from the list of valid passwords. # nopass All the set passwords of the user are removed, and the user # is flagged as requiring no password: it means that every # password will work against this user. If this directive is # used for the default user, every new connection will be # immediately authenticated with the default user without # any explicit AUTH command required. Note that the \u0026quot;resetpass\u0026quot; # directive will clear this condition. # resetpass Flush the list of allowed passwords. Moreover removes the # \u0026quot;nopass\u0026quot; status. After \u0026quot;resetpass\u0026quot; the user has no associated # passwords and there is no way to authenticate without adding # some password (or setting it as \u0026quot;nopass\u0026quot; later). # reset Performs the following actions: resetpass, resetkeys, off, # -@all. The user returns to the same state it has immediately # after its creation. # # ACL rules can be specified in any order: for instance you can start with # passwords, then flags, or key patterns. However note that the additive # and subtractive rules will CHANGE MEANING depending on the ordering. # For instance see the following example: # # user alice on +@all -DEBUG ~* \u0026gt;somepassword # # This will allow \u0026quot;alice\u0026quot; to use all the commands with the exception of the # DEBUG command, since +@all added all the commands to the set of the commands # alice can use, and later DEBUG was removed. However if we invert the order # of two ACL rules the result will be different: # # user alice on -DEBUG +@all ~* \u0026gt;somepassword # # Now DEBUG was removed when alice had yet no commands in the set of allowed # commands, later all the commands are added, so the user will be able to # execute everything. # # Basically ACL rules are processed left-to-right. # # For more information about ACL configuration please refer to # the Redis web site at https://redis.io/topics/acl # ACL LOG # # The ACL Log tracks failed commands and authentication events associated # with ACLs. The ACL Log is useful to troubleshoot failed commands blocked # by ACLs. The ACL Log is stored in memory. You can reclaim memory with # ACL LOG RESET. Define the maximum entry length of the ACL Log below. acllog-max-len 128 # Using an external ACL file # # Instead of configuring users here in this file, it is possible to use # a stand-alone file just listing users. The two methods cannot be mixed: # if you configure users here and at the same time you activate the exteranl # ACL file, the server will refuse to start. # # The format of the external ACL user file is exactly the same as the # format that is used inside redis.conf to describe users. # # aclfile /etc/redis/users.acl # IMPORTANT NOTE: starting with Redis 6 \u0026quot;requirepass\u0026quot; is just a compatiblity # layer on top of the new ACL system. The option effect will be just setting # the password for the default user. Clients will still authenticate using # AUTH \u0026lt;password\u0026gt; as usually, or more explicitly with AUTH default \u0026lt;password\u0026gt; # if they follow the new protocol: both will work. # requirepass zxvf666 # Command renaming (DEPRECATED). # # ------------------------------------------------------------------------ # WARNING: avoid using this option if possible. Instead use ACLs to remove # commands from the default user, and put them only in some admin user you # create for administrative purposes. # ------------------------------------------------------------------------ # # It is possible to change the name of dangerous commands in a shared # environment. For instance the CONFIG command may be renamed into something # hard to guess so that it will still be available for internal-use tools # but not available for general clients. # # Example: # # rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52 # # It is also possible to completely kill a command by renaming it into # an empty string: # # rename-command CONFIG \u0026quot;\u0026quot; # # Please note that changing the name of commands that are logged into the # AOF file or transmitted to replicas may cause problems. ################################### CLIENTS #################################### # Set the max number of connected clients at the same time. By default # this limit is set to 10000 clients, however if the Redis server is not # able to configure the process file limit to allow for the specified limit # the max number of allowed clients is set to the current file limit # minus 32 (as Redis reserves a few file descriptors for internal uses). # # Once the limit is reached Redis will close all the new connections sending # an error 'max number of clients reached'. # # IMPORTANT: When Redis Cluster is used, the max number of connections is also # shared with the cluster bus: every node in the cluster will use two # connections, one incoming and another outgoing. It is important to size the # limit accordingly in case of very large clusters. # # maxclients 10000 ############################## MEMORY MANAGEMENT ################################ # Set a memory usage limit to the specified amount of bytes. # When the memory limit is reached Redis will try to remove keys # according to the eviction policy selected (see maxmemory-policy). # # If Redis can't remove keys according to the policy, or if the policy is # set to 'noeviction', Redis will start to reply with errors to commands # that would use more memory, like SET, LPUSH, and so on, and will continue # to reply to read-only commands like GET. # # This option is usually useful when using Redis as an LRU or LFU cache, or to # set a hard memory limit for an instance (using the 'noeviction' policy). # # WARNING: If you have replicas attached to an instance with maxmemory on, # the size of the output buffers needed to feed the replicas are subtracted # from the used memory count, so that network problems / resyncs will # not trigger a loop where keys are evicted, and in turn the output # buffer of replicas is full with DELs of keys evicted triggering the deletion # of more keys, and so forth until the database is completely emptied. # # In short... if you have replicas attached it is suggested that you set a lower # limit for maxmemory so that there is some free RAM on the system for replica # output buffers (but this is not needed if the policy is 'noeviction'). # # maxmemory \u0026lt;bytes\u0026gt; # MAXMEMORY POLICY: how Redis will select what to remove when maxmemory # is reached. You can select one from the following behaviors: # # volatile-lru -\u0026gt; Evict using approximated LRU, only keys with an expire set. # allkeys-lru -\u0026gt; Evict any key using approximated LRU. # volatile-lfu -\u0026gt; Evict using approximated LFU, only keys with an expire set. # allkeys-lfu -\u0026gt; Evict any key using approximated LFU. # volatile-random -\u0026gt; Remove a random key having an expire set. # allkeys-random -\u0026gt; Remove a random key, any key. # volatile-ttl -\u0026gt; Remove the key with the nearest expire time (minor TTL) # noeviction -\u0026gt; Don't evict anything, just return an error on write operations. # # LRU means Least Recently Used # LFU means Least Frequently Used # # Both LRU, LFU and volatile-ttl are implemented using approximated # randomized algorithms. # # Note: with any of the above policies, Redis will return an error on write # operations, when there are no suitable keys for eviction. # # At the date of writing these commands are: set setnx setex append # incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd # sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby # zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby # getset mset msetnx exec sort # # The default is: # # maxmemory-policy noeviction # LRU, LFU and minimal TTL algorithms are not precise algorithms but approximated # algorithms (in order to save memory), so you can tune it for speed or # accuracy. For default Redis will check five keys and pick the one that was # used less recently, you can change the sample size using the following # configuration directive. # # The default of 5 produces good enough results. 10 Approximates very closely # true LRU but costs more CPU. 3 is faster but not very accurate. # # maxmemory-samples 5 # Starting from Redis 5, by default a replica will ignore its maxmemory setting # (unless it is promoted to master after a failover or manually). It means # that the eviction of keys will be just handled by the master, sending the # DEL commands to the replica as keys evict in the master side. # # This behavior ensures that masters and replicas stay consistent, and is usually # what you want, however if your replica is writable, or you want the replica # to have a different memory setting, and you are sure all the writes performed # to the replica are idempotent, then you may change this default (but be sure # to understand what you are doing). # # Note that since the replica by default does not evict, it may end using more # memory than the one set via maxmemory (there are certain buffers that may # be larger on the replica, or data structures may sometimes take more memory # and so forth). So make sure you monitor your replicas and make sure they # have enough memory to never hit a real out-of-memory condition before the # master hits the configured maxmemory setting. # # replica-ignore-maxmemory yes # Redis reclaims expired keys in two ways: upon access when those keys are # found to be expired, and also in background, in what is called the # \u0026quot;active expire key\u0026quot;. The key space is slowly and interactively scanned # looking for expired keys to reclaim, so that it is possible to free memory # of keys that are expired and will never be accessed again in a short time. # # The default effort of the expire cycle will try to avoid having more than # ten percent of expired keys still in memory, and will try to avoid consuming # more than 25% of total memory and to add latency to the system. However # it is possible to increase the expire \u0026quot;effort\u0026quot; that is normally set to # \u0026quot;1\u0026quot;, to a greater value, up to the value \u0026quot;10\u0026quot;. At its maximum value the # system will use more CPU, longer cycles (and technically may introduce # more latency), and will tollerate less already expired keys still present # in the system. It's a tradeoff betweeen memory, CPU and latecy. # # active-expire-effort 1 ############################# LAZY FREEING #################################### # Redis has two primitives to delete keys. One is called DEL and is a blocking # deletion of the object. It means that the server stops processing new commands # in order to reclaim all the memory associated with an object in a synchronous # way. If the key deleted is associated with a small object, the time needed # in order to execute the DEL command is very small and comparable to most other # O(1) or O(log_N) commands in Redis. However if the key is associated with an # aggregated value containing millions of elements, the server can block for # a long time (even seconds) in order to complete the operation. # # For the above reasons Redis also offers non blocking deletion primitives # such as UNLINK (non blocking DEL) and the ASYNC option of FLUSHALL and # FLUSHDB commands, in order to reclaim memory in background. Those commands # are executed in constant time. Another thread will incrementally free the # object in the background as fast as possible. # # DEL, UNLINK and ASYNC option of FLUSHALL and FLUSHDB are user-controlled. # It's up to the design of the application to understand when it is a good # idea to use one or the other. However the Redis server sometimes has to # delete keys or flush the whole database as a side effect of other operations. # Specifically Redis deletes objects independently of a user call in the # following scenarios: # # 1) On eviction, because of the maxmemory and maxmemory policy configurations, # in order to make room for new data, without going over the specified # memory limit. # 2) Because of expire: when a key with an associated time to live (see the # EXPIRE command) must be deleted from memory. # 3) Because of a side effect of a command that stores data on a key that may # already exist. For example the RENAME command may delete the old key # content when it is replaced with another one. Similarly SUNIONSTORE # or SORT with STORE option may delete existing keys. The SET command # itself removes any old content of the specified key in order to replace # it with the specified string. # 4) During replication, when a replica performs a full resynchronization with # its master, the content of the whole database is removed in order to # load the RDB file just transferred. # # In all the above cases the default is to delete objects in a blocking way, # like if DEL was called. However you can configure each case specifically # in order to instead release memory in a non-blocking way like if UNLINK # was called, using the following configuration directives. lazyfree-lazy-eviction no lazyfree-lazy-expire no lazyfree-lazy-server-del no replica-lazy-flush no # It is also possible, for the case when to replace the user code DEL calls # with UNLINK calls is not easy, to modify the default behavior of the DEL # command to act exactly like UNLINK, using the following configuration # directive: lazyfree-lazy-user-del no ################################ THREADED I/O ################################# # Redis is mostly single threaded, however there are certain threaded # operations such as UNLINK, slow I/O accesses and other things that are # performed on side threads. # # Now it is also possible to handle Redis clients socket reads and writes # in different I/O threads. Since especially writing is so slow, normally # Redis users use pipelining in order to speedup the Redis performances per # core, and spawn multiple instances in order to scale more. Using I/O # threads it is possible to easily speedup two times Redis without resorting # to pipelining nor sharding of the instance. # # By default threading is disabled, we suggest enabling it only in machines # that have at least 4 or more cores, leaving at least one spare core. # Using more than 8 threads is unlikely to help much. We also recommend using # threaded I/O only if you actually have performance problems, with Redis # instances being able to use a quite big percentage of CPU time, otherwise # there is no point in using this feature. # # So for instance if you have a four cores boxes, try to use 2 or 3 I/O # threads, if you have a 8 cores, try to use 6 threads. In order to # enable I/O threads use the following configuration directive: # # io-threads 4 # # Setting io-threads to 1 will just use the main thread as usually. # When I/O threads are enabled, we only use threads for writes, that is # to thread the write(2) syscall and transfer the client buffers to the # socket. However it is also possible to enable threading of reads and # protocol parsing using the following configuration directive, by setting # it to yes: # # io-threads-do-reads no # # Usually threading reads doesn't help much. # # NOTE 1: This configuration directive cannot be changed at runtime via # CONFIG SET. Aso this feature currently does not work when SSL is # enabled. # # NOTE 2: If you want to test the Redis speedup using redis-benchmark, make # sure you also run the benchmark itself in threaded mode, using the # --threads option to match the number of Redis theads, otherwise you'll not # be able to notice the improvements. ############################ KERNEL OOM CONTROL ############################## # On Linux, it is possible to hint the kernel OOM killer on what processes # should be killed first when out of memory. # # Enabling this feature makes Redis actively control the oom_score_adj value # for all its processes, depending on their role. The default scores will # attempt to have background child processes killed before all others, and # replicas killed before masters. oom-score-adj no # When oom-score-adj is used, this directive controls the specific values used # for master, replica and background child processes. Values range -1000 to # 1000 (higher means more likely to be killed). # # Unprivileged processes (not root, and without CAP_SYS_RESOURCE capabilities) # can freely increase their value, but not decrease it below its initial # settings. # # Values are used relative to the initial value of oom_score_adj when the server # starts. Because typically the initial value is 0, they will often match the # absolute values. oom-score-adj-values 0 200 800 ############################## APPEND ONLY MODE ############################### # By default Redis asynchronously dumps the dataset on disk. This mode is # good enough in many applications, but an issue with the Redis process or # a power outage may result into a few minutes of writes lost (depending on # the configured save points). # # The Append Only File is an alternative persistence mode that provides # much better durability. For instance using the default data fsync policy # (see later in the config file) Redis can lose just one second of writes in a # dramatic event like a server power outage, or a single write if something # wrong with the Redis process itself happens, but the operating system is # still running correctly. # # AOF and RDB persistence can be enabled at the same time without problems. # If the AOF is enabled on startup Redis will load the AOF, that is the file # with the better durability guarantees. # # Please check http://redis.io/topics/persistence for more information. appendonly no # The name of the append only file (default: \u0026quot;appendonly.aof\u0026quot;) appendfilename \u0026quot;appendonly.aof\u0026quot; # The fsync() call tells the Operating System to actually write data on disk # instead of waiting for more data in the output buffer. Some OS will really flush # data on disk, some other OS will just try to do it ASAP. # # Redis supports three different modes: # # no: don't fsync, just let the OS flush the data when it wants. Faster. # always: fsync after every write to the append only log. Slow, Safest. # everysec: fsync only one time every second. Compromise. # # The default is \u0026quot;everysec\u0026quot;, as that's usually the right compromise between # speed and data safety. It's up to you to understand if you can relax this to # \u0026quot;no\u0026quot; that will let the operating system flush the output buffer when # it wants, for better performances (but if you can live with the idea of # some data loss consider the default persistence mode that's snapshotting), # or on the contrary, use \u0026quot;always\u0026quot; that's very slow but a bit safer than # everysec. # # More details please check the following article: # http://antirez.com/post/redis-persistence-demystified.html # # If unsure, use \u0026quot;everysec\u0026quot;. # appendfsync always appendfsync everysec # appendfsync no # When the AOF fsync policy is set to always or everysec, and a background # saving process (a background save or AOF log background rewriting) is # performing a lot of I/O against the disk, in some Linux configurations # Redis may block too long on the fsync() call. Note that there is no fix for # this currently, as even performing fsync in a different thread will block # our synchronous write(2) call. # # In order to mitigate this problem it's possible to use the following option # that will prevent fsync() from being called in the main process while a # BGSAVE or BGREWRITEAOF is in progress. # # This means that while another child is saving, the durability of Redis is # the same as \u0026quot;appendfsync none\u0026quot;. In practical terms, this means that it is # possible to lose up to 30 seconds of log in the worst scenario (with the # default Linux settings). # # If you have latency problems turn this to \u0026quot;yes\u0026quot;. Otherwise leave it as # \u0026quot;no\u0026quot; that is the safest pick from the point of view of durability. no-appendfsync-on-rewrite no # Automatic rewrite of the append only file. # Redis is able to automatically rewrite the log file implicitly calling # BGREWRITEAOF when the AOF log size grows by the specified percentage. # # This is how it works: Redis remembers the size of the AOF file after the # latest rewrite (if no rewrite has happened since the restart, the size of # the AOF at startup is used). # # This base size is compared to the current size. If the current size is # bigger than the specified percentage, the rewrite is triggered. Also # you need to specify a minimal size for the AOF file to be rewritten, this # is useful to avoid rewriting the AOF file even if the percentage increase # is reached but it is still pretty small. # # Specify a percentage of zero in order to disable the automatic AOF # rewrite feature. auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb # An AOF file may be found to be truncated at the end during the Redis # startup process, when the AOF data gets loaded back into memory. # This may happen when the system where Redis is running # crashes, especially when an ext4 filesystem is mounted without the # data=ordered option (however this can't happen when Redis itself # crashes or aborts but the operating system still works correctly). # # Redis can either exit with an error when this happens, or load as much # data as possible (the default now) and start if the AOF file is found # to be truncated at the end. The following option controls this behavior. # # If aof-load-truncated is set to yes, a truncated AOF file is loaded and # the Redis server starts emitting a log to inform the user of the event. # Otherwise if the option is set to no, the server aborts with an error # and refuses to start. When the option is set to no, the user requires # to fix the AOF file using the \u0026quot;redis-check-aof\u0026quot; utility before to restart # the server. # # Note that if the AOF file will be found to be corrupted in the middle # the server will still exit with an error. This option only applies when # Redis will try to read more data from the AOF file but not enough bytes # will be found. aof-load-truncated yes # When rewriting the AOF file, Redis is able to use an RDB preamble in the # AOF file for faster rewrites and recoveries. When this option is turned # on the rewritten AOF file is composed of two different stanzas: # # [RDB file][AOF tail] # # When loading Redis recognizes that the AOF file starts with the \u0026quot;REDIS\u0026quot; # string and loads the prefixed RDB file, and continues loading the AOF # tail. aof-use-rdb-preamble yes ################################ LUA SCRIPTING ############################### # Max execution time of a Lua script in milliseconds. # # If the maximum execution time is reached Redis will log that a script is # still in execution after the maximum allowed time and will start to # reply to queries with an error. # # When a long running script exceeds the maximum execution time only the # SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be # used to stop a script that did not yet called write commands. The second # is the only way to shut down the server in the case a write command was # already issued by the script but the user doesn't want to wait for the natural # termination of the script. # # Set it to 0 or a negative value for unlimited execution without warnings. lua-time-limit 5000 ################################ REDIS CLUSTER ############################### # Normal Redis instances can't be part of a Redis Cluster; only nodes that are # started as cluster nodes can. In order to start a Redis instance as a # cluster node enable the cluster support uncommenting the following: # # cluster-enabled yes # Every cluster node has a cluster configuration file. This file is not # intended to be edited by hand. It is created and updated by Redis nodes. # Every Redis Cluster node requires a different cluster configuration file. # Make sure that instances running in the same system do not have # overlapping cluster configuration file names. # # cluster-config-file nodes-6379.conf # Cluster node timeout is the amount of milliseconds a node must be unreachable # for it to be considered in failure state. # Most other internal time limits are multiple of the node timeout. # # cluster-node-timeout 15000 # A replica of a failing master will avoid to start a failover if its data # looks too old. # # There is no simple way for a replica to actually have an exact measure of # its \u0026quot;data age\u0026quot;, so the following two checks are performed: # # 1) If there are multiple replicas able to failover, they exchange messages # in order to try to give an advantage to the replica with the best # replication offset (more data from the master processed). # Replicas will try to get their rank by offset, and apply to the start # of the failover a delay proportional to their rank. # # 2) Every single replica computes the time of the last interaction with # its master. This can be the last ping or command received (if the master # is still in the \u0026quot;connected\u0026quot; state), or the time that elapsed since the # disconnection with the master (if the replication link is currently down). # If the last interaction is too old, the replica will not try to failover # at all. # # The point \u0026quot;2\u0026quot; can be tuned by user. Specifically a replica will not perform # the failover if, since the last interaction with the master, the time # elapsed is greater than: # # (node-timeout * replica-validity-factor) + repl-ping-replica-period # # So for example if node-timeout is 30 seconds, and the replica-validity-factor # is 10, and assuming a default repl-ping-replica-period of 10 seconds, the # replica will not try to failover if it was not able to talk with the master # for longer than 310 seconds. # # A large replica-validity-factor may allow replicas with too old data to failover # a master, while a too small value may prevent the cluster from being able to # elect a replica at all. # # For maximum availability, it is possible to set the replica-validity-factor # to a value of 0, which means, that replicas will always try to failover the # master regardless of the last time they interacted with the master. # (However they'll always try to apply a delay proportional to their # offset rank). # # Zero is the only value able to guarantee that when all the partitions heal # the cluster will always be able to continue. # # cluster-replica-validity-factor 10 # Cluster replicas are able to migrate to orphaned masters, that are masters # that are left without working replicas. This improves the cluster ability # to resist to failures as otherwise an orphaned master can't be failed over # in case of failure if it has no working replicas. # # Replicas migrate to orphaned masters only if there are still at least a # given number of other working replicas for their old master. This number # is the \u0026quot;migration barrier\u0026quot;. A migration barrier of 1 means that a replica # will migrate only if there is at least 1 other working replica for its master # and so forth. It usually reflects the number of replicas you want for every # master in your cluster. # # Default is 1 (replicas migrate only if their masters remain with at least # one replica). To disable migration just set it to a very large value. # A value of 0 can be set but is useful only for debugging and dangerous # in production. # # cluster-migration-barrier 1 # By default Redis Cluster nodes stop accepting queries if they detect there # is at least an hash slot uncovered (no available node is serving it). # This way if the cluster is partially down (for example a range of hash slots # are no longer covered) all the cluster becomes, eventually, unavailable. # It automatically returns available as soon as all the slots are covered again. # # However sometimes you want the subset of the cluster which is working, # to continue to accept queries for the part of the key space that is still # covered. In order to do so, just set the cluster-require-full-coverage # option to no. # # cluster-require-full-coverage yes # This option, when set to yes, prevents replicas from trying to failover its # master during master failures. However the master can still perform a # manual failover, if forced to do so. # # This is useful in different scenarios, especially in the case of multiple # data center operations, where we want one side to never be promoted if not # in the case of a total DC failure. # # cluster-replica-no-failover no # This option, when set to yes, allows nodes to serve read traffic while the # the cluster is in a down state, as long as it believes it owns the slots. # # This is useful for two cases. The first case is for when an application # doesn't require consistency of data during node failures or network partitions. # One example of this is a cache, where as long as the node has the data it # should be able to serve it. # # The second use case is for configurations that don't meet the recommended # three shards but want to enable cluster mode and scale later. A # master outage in a 1 or 2 shard configuration causes a read/write outage to the # entire cluster without this option set, with it set there is only a write outage. # Without a quorum of masters, slot ownership will not change automatically. # # cluster-allow-reads-when-down no # In order to setup your cluster make sure to read the documentation # available at http://redis.io web site. ########################## CLUSTER DOCKER/NAT support ######################## # In certain deployments, Redis Cluster nodes address discovery fails, because # addresses are NAT-ted or because ports are forwarded (the typical case is # Docker and other containers). # # In order to make Redis Cluster working in such environments, a static # configuration where each node knows its public address is needed. The # following two options are used for this scope, and are: # # * cluster-announce-ip # * cluster-announce-port # * cluster-announce-bus-port # # Each instruct the node about its address, client port, and cluster message # bus port. The information is then published in the header of the bus packets # so that other nodes will be able to correctly map the address of the node # publishing the information. # # If the above options are not used, the normal Redis Cluster auto-detection # will be used instead. # # Note that when remapped, the bus port may not be at the fixed offset of # clients port + 10000, so you can specify any port and bus-port depending # on how they get remapped. If the bus-port is not set, a fixed offset of # 10000 will be used as usually. # # Example: # # cluster-announce-ip 10.1.1.5 # cluster-announce-port 6379 # cluster-announce-bus-port 6380 ################################## SLOW LOG ################################### # The Redis Slow Log is a system to log queries that exceeded a specified # execution time. The execution time does not include the I/O operations # like talking with the client, sending the reply and so forth, # but just the time needed to actually execute the command (this is the only # stage of command execution where the thread is blocked and can not serve # other requests in the meantime). # # You can configure the slow log with two parameters: one tells Redis # what is the execution time, in microseconds, to exceed in order for the # command to get logged, and the other parameter is the length of the # slow log. When a new command is logged the oldest one is removed from the # queue of logged commands. # The following time is expressed in microseconds, so 1000000 is equivalent # to one second. Note that a negative number disables the slow log, while # a value of zero forces the logging of every command. slowlog-log-slower-than 10000 # There is no limit to this length. Just be aware that it will consume memory. # You can reclaim memory used by the slow log with SLOWLOG RESET. slowlog-max-len 128 ################################ LATENCY MONITOR ############################## # The Redis latency monitoring subsystem samples different operations # at runtime in order to collect data related to possible sources of # latency of a Redis instance. # # Via the LATENCY command this information is available to the user that can # print graphs and obtain reports. # # The system only logs operations that were performed in a time equal or # greater than the amount of milliseconds specified via the # latency-monitor-threshold configuration directive. When its value is set # to zero, the latency monitor is turned off. # # By default latency monitoring is disabled since it is mostly not needed # if you don't have latency issues, and collecting data has a performance # impact, that while very small, can be measured under big load. Latency # monitoring can easily be enabled at runtime using the command # \u0026quot;CONFIG SET latency-monitor-threshold \u0026lt;milliseconds\u0026gt;\u0026quot; if needed. latency-monitor-threshold 0 ############################# EVENT NOTIFICATION ############################## # Redis can notify Pub/Sub clients about events happening in the key space. # This feature is documented at http://redis.io/topics/notifications # # For instance if keyspace events notification is enabled, and a client # performs a DEL operation on key \u0026quot;foo\u0026quot; stored in the Database 0, two # messages will be published via Pub/Sub: # # PUBLISH __keyspace@0__:foo del # PUBLISH __keyevent@0__:del foo # # It is possible to select the events that Redis will notify among a set # of classes. Every class is identified by a single character: # # K Keyspace events, published with __keyspace@\u0026lt;db\u0026gt;__ prefix. # E Keyevent events, published with __keyevent@\u0026lt;db\u0026gt;__ prefix. # g Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ... # $ String commands # l List commands # s Set commands # h Hash commands # z Sorted set commands # x Expired events (events generated every time a key expires) # e Evicted events (events generated when a key is evicted for maxmemory) # t Stream commands # m Key-miss events (Note: It is not included in the 'A' class) # A Alias for g$lshzxet, so that the \u0026quot;AKE\u0026quot; string means all the events # (Except key-miss events which are excluded from 'A' due to their # unique nature). # # The \u0026quot;notify-keyspace-events\u0026quot; takes as argument a string that is composed # of zero or multiple characters. The empty string means that notifications # are disabled. # # Example: to enable list and generic events, from the point of view of the # event name, use: # # notify-keyspace-events Elg # # Example 2: to get the stream of the expired keys subscribing to channel # name __keyevent@0__:expired use: # # notify-keyspace-events Ex # # By default all notifications are disabled because most users don't need # this feature and the feature has some overhead. Note that if you don't # specify at least one of K or E, no events will be delivered. notify-keyspace-events \u0026quot;\u0026quot; ############################### GOPHER SERVER ################################# # Redis contains an implementation of the Gopher protocol, as specified in # the RFC 1436 (https://www.ietf.org/rfc/rfc1436.txt). # # The Gopher protocol was very popular in the late '90s. It is an alternative # to the web, and the implementation both server and client side is so simple # that the Redis server has just 100 lines of code in order to implement this # support. # # What do you do with Gopher nowadays? Well Gopher never *really* died, and # lately there is a movement in order for the Gopher more hierarchical content # composed of just plain text documents to be resurrected. Some want a simpler # internet, others believe that the mainstream internet became too much # controlled, and it's cool to create an alternative space for people that # want a bit of fresh air. # # Anyway for the 10nth birthday of the Redis, we gave it the Gopher protocol # as a gift. # # --- HOW IT WORKS? --- # # The Redis Gopher support uses the inline protocol of Redis, and specifically # two kind of inline requests that were anyway illegal: an empty request # or any request that starts with \u0026quot;/\u0026quot; (there are no Redis commands starting # with such a slash). Normal RESP2/RESP3 requests are completely out of the # path of the Gopher protocol implementation and are served as usually as well. # # If you open a connection to Redis when Gopher is enabled and send it # a string like \u0026quot;/foo\u0026quot;, if there is a key named \u0026quot;/foo\u0026quot; it is served via the # Gopher protocol. # # In order to create a real Gopher \u0026quot;hole\u0026quot; (the name of a Gopher site in Gopher # talking), you likely need a script like the following: # # https://github.com/antirez/gopher2redis # # --- SECURITY WARNING --- # # If you plan to put Redis on the internet in a publicly accessible address # to server Gopher pages MAKE SURE TO SET A PASSWORD to the instance. # Once a password is set: # # 1. The Gopher server (when enabled, not by default) will still serve # content via Gopher. # 2. However other commands cannot be called before the client will # authenticate. # # So use the 'requirepass' option to protect your instance. # # To enable Gopher support uncomment the following line and set # the option from no (the default) to yes. # # gopher-enabled no ############################### ADVANCED CONFIG ############################### # Hashes are encoded using a memory efficient data structure when they have a # small number of entries, and the biggest entry does not exceed a given # threshold. These thresholds can be configured using the following directives. hash-max-ziplist-entries 512 hash-max-ziplist-value 64 # Lists are also encoded in a special way to save a lot of space. # The number of entries allowed per internal list node can be specified # as a fixed maximum size or a maximum number of elements. # For a fixed maximum size, use -5 through -1, meaning: # -5: max size: 64 Kb \u0026lt;-- not recommended for normal workloads # -4: max size: 32 Kb \u0026lt;-- not recommended # -3: max size: 16 Kb \u0026lt;-- probably not recommended # -2: max size: 8 Kb \u0026lt;-- good # -1: max size: 4 Kb \u0026lt;-- good # Positive numbers mean store up to _exactly_ that number of elements # per list node. # The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size), # but if your use case is unique, adjust the settings as necessary. list-max-ziplist-size -2 # Lists may also be compressed. # Compress depth is the number of quicklist ziplist nodes from *each* side of # the list to *exclude* from compression. The head and tail of the list # are always uncompressed for fast push/pop operations. Settings are: # 0: disable all list compression # 1: depth 1 means \u0026quot;don't start compressing until after 1 node into the list, # going from either the head or tail\u0026quot; # So: [head]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[tail] # [head], [tail] will always be uncompressed; inner nodes will compress. # 2: [head]-\u0026gt;[next]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[prev]-\u0026gt;[tail] # 2 here means: don't compress head or head-\u0026gt;next or tail-\u0026gt;prev or tail, # but compress all nodes between them. # 3: [head]-\u0026gt;[next]-\u0026gt;[next]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[prev]-\u0026gt;[prev]-\u0026gt;[tail] # etc. list-compress-depth 0 # Sets have a special encoding in just one case: when a set is composed # of just strings that happen to be integers in radix 10 in the range # of 64 bit signed integers. # The following configuration setting sets the limit in the size of the # set in order to use this special memory saving encoding. set-max-intset-entries 512 # Similarly to hashes and lists, sorted sets are also specially encoded in # order to save a lot of space. This encoding is only used when the length and # elements of a sorted set are below the following limits: zset-max-ziplist-entries 128 zset-max-ziplist-value 64 # HyperLogLog sparse representation bytes limit. The limit includes the # 16 bytes header. When an HyperLogLog using the sparse representation crosses # this limit, it is converted into the dense representation. # # A value greater than 16000 is totally useless, since at that point the # dense representation is more memory efficient. # # The suggested value is ~ 3000 in order to have the benefits of # the space efficient encoding without slowing down too much PFADD, # which is O(N) with the sparse encoding. The value can be raised to # ~ 10000 when CPU is not a concern, but space is, and the data set is # composed of many HyperLogLogs with cardinality in the 0 - 15000 range. hll-sparse-max-bytes 3000 # Streams macro node max size / items. The stream data structure is a radix # tree of big nodes that encode multiple items inside. Using this configuration # it is possible to configure how big a single node can be in bytes, and the # maximum number of items it may contain before switching to a new node when # appending new stream entries. If any of the following settings are set to # zero, the limit is ignored, so for instance it is possible to set just a # max entires limit by setting max-bytes to 0 and max-entries to the desired # value. stream-node-max-bytes 4096 stream-node-max-entries 100 # Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in # order to help rehashing the main Redis hash table (the one mapping top-level # keys to values). The hash table implementation Redis uses (see dict.c) # performs a lazy rehashing: the more operation you run into a hash table # that is rehashing, the more rehashing \u0026quot;steps\u0026quot; are performed, so if the # server is idle the rehashing is never complete and some more memory is used # by the hash table. # # The default is to use this millisecond 10 times every second in order to # actively rehash the main dictionaries, freeing memory when possible. # # If unsure: # use \u0026quot;activerehashing no\u0026quot; if you have hard latency requirements and it is # not a good thing in your environment that Redis can reply from time to time # to queries with 2 milliseconds delay. # # use \u0026quot;activerehashing yes\u0026quot; if you don't have such hard requirements but # want to free memory asap when possible. activerehashing yes # The client output buffer limits can be used to force disconnection of clients # that are not reading data from the server fast enough for some reason (a # common reason is that a Pub/Sub client can't consume messages as fast as the # publisher can produce them). # # The limit can be set differently for the three different classes of clients: # # normal -\u0026gt; normal clients including MONITOR clients # replica -\u0026gt; replica clients # pubsub -\u0026gt; clients subscribed to at least one pubsub channel or pattern # # The syntax of every client-output-buffer-limit directive is the following: # # client-output-buffer-limit \u0026lt;class\u0026gt; \u0026lt;hard limit\u0026gt; \u0026lt;soft limit\u0026gt; \u0026lt;soft seconds\u0026gt; # # A client is immediately disconnected once the hard limit is reached, or if # the soft limit is reached and remains reached for the specified number of # seconds (continuously). # So for instance if the hard limit is 32 megabytes and the soft limit is # 16 megabytes / 10 seconds, the client will get disconnected immediately # if the size of the output buffers reach 32 megabytes, but will also get # disconnected if the client reaches 16 megabytes and continuously overcomes # the limit for 10 seconds. # # By default normal clients are not limited because they don't receive data # without asking (in a push way), but just after a request, so only # asynchronous clients may create a scenario where data is requested faster # than it can read. # # Instead there is a default limit for pubsub and replica clients, since # subscribers and replicas receive data in a push fashion. # # Both the hard or the soft limit can be disabled by setting them to zero. client-output-buffer-limit normal 0 0 0 client-output-buffer-limit replica 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 # Client query buffers accumulate new commands. They are limited to a fixed # amount by default in order to avoid that a protocol desynchronization (for # instance due to a bug in the client) will lead to unbound memory usage in # the query buffer. However you can configure it here if you have very special # needs, such us huge multi/exec requests or alike. # # client-query-buffer-limit 1gb # In the Redis protocol, bulk requests, that are, elements representing single # strings, are normally limited ot 512 mb. However you can change this limit # here, but must be 1mb or greater # # proto-max-bulk-len 512mb # Redis calls an internal function to perform many background tasks, like # closing connections of clients in timeout, purging expired keys that are # never requested, and so forth. # # Not all tasks are performed with the same frequency, but Redis checks for # tasks to perform according to the specified \u0026quot;hz\u0026quot; value. # # By default \u0026quot;hz\u0026quot; is set to 10. Raising the value will use more CPU when # Redis is idle, but at the same time will make Redis more responsive when # there are many keys expiring at the same time, and timeouts may be # handled with more precision. # # The range is between 1 and 500, however a value over 100 is usually not # a good idea. Most users should use the default of 10 and raise this up to # 100 only in environments where very low latency is required. hz 10 # Normally it is useful to have an HZ value which is proportional to the # number of clients connected. This is useful in order, for instance, to # avoid too many clients are processed for each background task invocation # in order to avoid latency spikes. # # Since the default HZ value by default is conservatively set to 10, Redis # offers, and enables by default, the ability to use an adaptive HZ value # which will temporary raise when there are many connected clients. # # When dynamic HZ is enabled, the actual configured HZ will be used # as a baseline, but multiples of the configured HZ value will be actually # used as needed once more clients are connected. In this way an idle # instance will use very little CPU time while a busy instance will be # more responsive. dynamic-hz yes # When a child rewrites the AOF file, if the following option is enabled # the file will be fsync-ed every 32 MB of data generated. This is useful # in order to commit the file to the disk more incrementally and avoid # big latency spikes. aof-rewrite-incremental-fsync yes # When redis saves RDB file, if the following option is enabled # the file will be fsync-ed every 32 MB of data generated. This is useful # in order to commit the file to the disk more incrementally and avoid # big latency spikes. rdb-save-incremental-fsync yes # Redis LFU eviction (see maxmemory setting) can be tuned. However it is a good # idea to start with the default settings and only change them after investigating # how to improve the performances and how the keys LFU change over time, which # is possible to inspect via the OBJECT FREQ command. # # There are two tunable parameters in the Redis LFU implementation: the # counter logarithm factor and the counter decay time. It is important to # understand what the two parameters mean before changing them. # # The LFU counter is just 8 bits per key, it's maximum value is 255, so Redis # uses a probabilistic increment with logarithmic behavior. Given the value # of the old counter, when a key is accessed, the counter is incremented in # this way: # # 1. A random number R between 0 and 1 is extracted. # 2. A probability P is calculated as 1/(old_value*lfu_log_factor+1). # 3. The counter is incremented only if R \u0026lt; P. # # The default lfu-log-factor is 10. This is a table of how the frequency # counter changes with a different number of accesses with different # logarithmic factors: # # +--------+------------+------------+------------+------------+------------+ # | factor | 100 hits | 1000 hits | 100K hits | 1M hits | 10M hits | # +--------+------------+------------+------------+------------+------------+ # | 0 | 104 | 255 | 255 | 255 | 255 | # +--------+------------+------------+------------+------------+------------+ # | 1 | 18 | 49 | 255 | 255 | 255 | # +--------+------------+------------+------------+------------+------------+ # | 10 | 10 | 18 | 142 | 255 | 255 | # +--------+------------+------------+------------+------------+------------+ # | 100 | 8 | 11 | 49 | 143 | 255 | # +--------+------------+------------+------------+------------+------------+ # # NOTE: The above table was obtained by running the following commands: # # redis-benchmark -n 1000000 incr foo # redis-cli object freq foo # # NOTE 2: The counter initial value is 5 in order to give new objects a chance # to accumulate hits. # # The counter decay time is the time, in minutes, that must elapse in order # for the key counter to be divided by two (or decremented if it has a value # less \u0026lt;= 10). # # The default value for the lfu-decay-time is 1. A Special value of 0 means to # decay the counter every time it happens to be scanned. # # lfu-log-factor 10 # lfu-decay-time 1 ########################### ACTIVE DEFRAGMENTATION ####################### # # What is active defragmentation? # ------------------------------- # # Active (online) defragmentation allows a Redis server to compact the # spaces left between small allocations and deallocations of data in memory, # thus allowing to reclaim back memory. # # Fragmentation is a natural process that happens with every allocator (but # less so with Jemalloc, fortunately) and certain workloads. Normally a server # restart is needed in order to lower the fragmentation, or at least to flush # away all the data and create it again. However thanks to this feature # implemented by Oran Agra for Redis 4.0 this process can happen at runtime # in an \u0026quot;hot\u0026quot; way, while the server is running. # # Basically when the fragmentation is over a certain level (see the # configuration options below) Redis will start to create new copies of the # values in contiguous memory regions by exploiting certain specific Jemalloc # features (in order to understand if an allocation is causing fragmentation # and to allocate it in a better place), and at the same time, will release the # old copies of the data. This process, repeated incrementally for all the keys # will cause the fragmentation to drop back to normal values. # # Important things to understand: # # 1. This feature is disabled by default, and only works if you compiled Redis # to use the copy of Jemalloc we ship with the source code of Redis. # This is the default with Linux builds. # # 2. You never need to enable this feature if you don't have fragmentation # issues. # # 3. Once you experience fragmentation, you can enable this feature when # needed with the command \u0026quot;CONFIG SET activedefrag yes\u0026quot;. # # The configuration parameters are able to fine tune the behavior of the # defragmentation process. If you are not sure about what they mean it is # a good idea to leave the defaults untouched. # Enabled active defragmentation # activedefrag no # Minimum amount of fragmentation waste to start active defrag # active-defrag-ignore-bytes 100mb # Minimum percentage of fragmentation to start active defrag # active-defrag-threshold-lower 10 # Maximum percentage of fragmentation at which we use maximum effort # active-defrag-threshold-upper 100 # Minimal effort for defrag in CPU percentage, to be used when the lower # threshold is reached # active-defrag-cycle-min 1 # Maximal effort for defrag in CPU percentage, to be used when the upper # threshold is reached # active-defrag-cycle-max 25 # Maximum number of set/hash/zset/list fields that will be processed from # the main dictionary scan # active-defrag-max-scan-fields 1000 # Jemalloc background thread for purging will be enabled by default jemalloc-bg-thread yes # It is possible to pin different threads and processes of Redis to specific # CPUs in your system, in order to maximize the performances of the server. # This is useful both in order to pin different Redis threads in different # CPUs, but also in order to make sure that multiple Redis instances running # in the same host will be pinned to different CPUs. # # Normally you can do this using the \u0026quot;taskset\u0026quot; command, however it is also # possible to this via Redis configuration directly, both in Linux and FreeBSD. # # You can pin the server/IO threads, bio threads, aof rewrite child process, and # the bgsave child process. The syntax to specify the cpu list is the same as # the taskset command: # # Set redis server/io threads to cpu affinity 0,2,4,6: # server_cpulist 0-7:2 # # Set bio threads to cpu affinity 1,3: # bio_cpulist 1,3 # # Set aof rewrite child process to cpu affinity 8,9,10,11: # aof_rewrite_cpulist 8-11 # # Set bgsave child process to cpu affinity 1,10,11 # bgsave_cpulist 1,10-11 ","date":"2020å¹´11æœˆ06æ—¥","permalink":"/posts/2020-11-7-docker-redis-config/","summary":"ä½¿ç”¨dockerå®‰è£…redisï¼ŒæŒ‚è½½å¤–éƒ¨é…ç½®å’Œæ•°æ® mkdir /docker\nmkdir /docker/redis","title":"docker ä¸‹çš„ redis å¦‚ä½•æŒ‚è½½å¤–éƒ¨é…ç½®å’Œæ•°æ®"},{"contents":" This is official blog theme.\nXshellè¿æ¥åŠdockerã€rediså®‰è£… 1.è¿æ¥Xshell ip addr æŸ¥çœ‹æœ¬æœºip\nvi /etc/sysconfig/network-scripts/ifcfg-ens33 ifcfg-xxxxï¼Œxxxä¸ipåœ°å€2ï¼š ç›¸åŒ\naï¼šè¿›å…¥æ’å…¥æ¨¡å¼\nä¿®æ”¹ONBOOT=yesï¼ˆå¼€æœºå¯åŠ¨ç½‘å¡ï¼‰\nesc ä¹‹å :wq ä¿å­˜å¹¶é€€å‡º\nip addr 2:ä¸­çš„inetå°±æ˜¯ipåœ°å€\næ³¨ï¼šLinux å·²ä¿®æ”¹ipåœ°å€ï¼ˆONBOOT=yesï¼‰,ä½†æ˜¯ä¸æ˜¾ç¤ºipåœ°å€\nå…¶å®åŸå› å¾ˆç®€å•ï¼Œæ˜¯å› ä¸ºä½ çš„ï¼ˆVMware DHCP Serviceï¼‰è¿™ä¸ªæœåŠ¡æ²¡æœ‰å¼€ï¼Œè¿›å…¥è®¡ç®—æœºç®¡ç†â€“ã€‹æœåŠ¡å’Œåº”ç”¨ç¨‹åºâ€“ã€‹æœåŠ¡ æ‰¾åˆ°VMware DHCP Serviceæ‰“å¼€å°±è¡Œäº†\n2.å®‰è£…docker sudo yum update ç¡®ä¿ yum åŒ…æ›´æ–°åˆ°æœ€æ–°ã€‚\nsudo yum install -y yum-utils device-mapper-persistent-data lvm2 å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼Œ yum-util æä¾›yum-config-manageråŠŸèƒ½ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯devicemapperé©±åŠ¨ä¾èµ–çš„ã€‚\nsudo yum-config-manager \u0026ndash;add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo è®¾ç½®yumæºï¼Œä½¿ç”¨é˜¿é‡Œäº‘ã€‚\nsudo yum install docker-ce å®‰è£…dockerã€‚\nsudo systemctl start docker sudo systemctl enable docker å¯åŠ¨å¹¶åŠ å…¥å¼€æœºå¯åŠ¨ã€‚\ndocker version éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ(æœ‰clientå’Œserviceä¸¤éƒ¨åˆ†è¡¨ç¤ºdockerå®‰è£…å¯åŠ¨éƒ½æˆåŠŸäº†)ã€‚\n3.dockerå®‰è£…redis docker search redis æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ã€‚\ndocker pull redis:latest æ‹‰å–å®˜æ–¹çš„æœ€æ–°ç‰ˆæœ¬çš„é•œåƒã€‚\ndocker image åˆ—å‡ºæœ¬åœ°é•œåƒã€‚æŸ¥çœ‹æ˜¯å¦å·²å®‰è£…äº† redisã€‚\ndocker ps æ˜¾ç¤ºå½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚\ndocker run -itd \u0026ndash;name redis-test -p 6379:6379 redis æˆ–è€…ï¼šdocker run -p 6379:6379 -d redis åˆ›å»ºå®¹å™¨å¹¶è¿è¡Œã€‚\nè¿è¡Œå·²å­˜åœ¨å®¹å™¨ï¼šsudo docker start \u0026ldquo;redis-test\u0026rdquo; è¿è¡Œ redis å®¹å™¨ã€‚\ndocker exec -it redis /bin/bash -it xxx xxxä¸docker ps çš„ names ç›¸åŒ\næ³¨æ„ï¼š/binä¹‹å‰æœ‰ç©ºæ ¼\nroot@fcd32baa79ff:/data# redis-cli é€šè¿‡ redis-cli è¿æ¥æµ‹è¯•ä½¿ç”¨ redis æœåŠ¡ã€‚\nä¸­æ–‡ä¸ä¹±ç ï¼š\u0026ndash;raw root@fcd32baa79ff:/data# redis-cli \u0026ndash;raw\néªŒè¯èº«ä»½ å·²ç™»å½•ï¼šauth password\nç™»å½•çš„åŒæ—¶éªŒè¯ï¼šredis-cli -a password\n","date":"2020å¹´10æœˆ11æ—¥","permalink":"/posts/2018-11-7-redis/","summary":"This is official blog theme.","title":"Xshellè¿æ¥åŠdockerã€rediså®‰è£…"},{"contents":"é¡¹ç›® 1/ Django-mdeditor\nDjango-mdeditor æ˜¯åŸºäº Editor.md çš„ä¸€ä¸ª django Markdown æ–‡æœ¬ç¼–è¾‘æ’ä»¶åº”ç”¨ã€‚\n2/ liBlog\nä¸€ä¸ªåŸºäºDjango1.11TLSç‰ˆæœ¬çš„åšå®¢ç³»ç»Ÿã€‚è‡ªå·±çš„ç»ƒæ‰‹å‘¨è¾¹é¡¹ç›®ï¼Œä¼šéšæ—¶å°è¯•æ–°æŠ€æœ¯ã€‚\næ•™ç¨‹ Python å…¥é—¨åŸºç¡€æ•™ç¨‹\nhttps://pylixm.cc/python_start\nPythonå…¥é—¨åŸºç¡€æ•™ç¨‹ï¼Œåˆ†åŸºç¡€ã€å®æˆ˜ã€è¿›é˜¶æé«˜ï¼Œæ„åœ¨ä»å®æˆ˜ä¸­å­¦ä¹ PythonåŸºç¡€è¯­æ³•ã€‚\n","date":"2020å¹´07æœˆ23æ—¥","permalink":"/project/","summary":"é¡¹ç›® 1/ Django-mdeditor\nDjango-mdeditor æ˜¯åŸºäº Editor.","title":"é¡¹ç›®å’Œæ•™ç¨‹"},{"contents":"æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶è¿”å›äº†ä¸€ä¸ªå¼•ç”¨ï¼š\nint \u0026amp;ret_val(int \u0026amp;a) { return a; } å¦ä¸€ä¸ªå‡½æ•°ç”¨æ¥æ¥æ”¶è¿”å›çš„å¼•ç”¨ï¼š\n// æ¥æ”¶ä¸€ä¸ªå¼•ç”¨è¿”å› void receive_refer() { int i = 10; int a = ret_val(i); // int æ¥æ”¶ cout \u0026lt;\u0026lt; a \u0026lt;\u0026lt; endl; // Output: 10 a = 50; cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; endl; // Output: 10 int \u0026amp;a1 = ret_val(i); // int\u0026amp; æ¥æ”¶ a1 = 50; cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; endl; // Output: 50 ret_val(i) = 555; cout \u0026lt;\u0026lt; i \u0026lt;\u0026lt; endl; // Output: 555 } æ¥æ”¶å¼•ç”¨æœ‰ä¸¤ç§æ–¹å¼ï¼šä½¿ç”¨ int æ¥æ”¶ï¼Œæˆ–è€…ä½¿ç”¨ int\u0026amp; æ¥æ”¶ï¼Œåˆ†åˆ«å¯¹åº”ä¸Šé¢çš„ a å’Œ a1ï¼Œå…¶ä¸­ a ä¸èƒ½ä¿®æ”¹ i çš„å€¼ï¼Œè€Œ a1 å¯ä»¥ã€‚æˆ‘çš„ç–‘é—®æ˜¯ï¼Œæ—¢ç„¶è¿”å›å€¼æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œé‚£ä¹ˆæ¥æ”¶è€…ä¸åº”è¯¥ä¹Ÿå¾—æ˜¯ä¸€ä¸ªå¼•ç”¨å—ï¼Œå°±å¥½æ¯”ä¸€ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ int æŒ‡é’ˆï¼Œé‚£ä¹ˆæ¥æ”¶è€…ä¹Ÿå¿…é¡»æ˜¯ä¸€ä¸ª int æŒ‡é’ˆï¼Œè€Œä¸èƒ½æ˜¯ intã€‚\nå¯¹åº”ä¸Šé¢çš„æŒ‡é’ˆç‰ˆï¼š\nint *ret_val(int *a) { return a; } void receive_() { int i = 10; int a = ret_val(\u0026amp;i); // é”™è¯¯ï¼Œä¸èƒ½ç”¨ int æ¥æ”¶æŒ‡é’ˆ int *a1 = ret_val(\u0026amp;a); *a1 = 50; int aa = *a1; } ","date":"2020å¹´04æœˆ15æ—¥","permalink":"/posts/2021-4-15-cpp_func_return_reference/","summary":"æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶è¿”å›äº†ä¸€ä¸ªå¼•ç”¨ï¼š\nint \u0026amp;ret_val(int \u0026amp;a) { return a; } å¦ä¸€ä¸ªå‡½æ•°ç”¨æ¥æ¥æ”¶è¿”å›çš„å¼•ç”¨ï¼š","title":"c++ï¼šå¦‚ä½•ç†è§£å‡½æ•°è¿”å›ä¸€ä¸ªå¼•ç”¨ã€æœªå®Œã€‘"},{"contents":"List // Listä»£è¡¨ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚Listé›¶å€¼ä¸ºä¸€ä¸ªç©ºçš„ã€å¯ç”¨çš„é“¾è¡¨ã€‚ type List struct { // å“¨å…µèŠ‚ç‚¹ï¼Œè¿æ¥é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼Œroot.next è¿æ¥çš„æ˜¯ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼Œroot.prev è¿æ¥çš„æ˜¯æœ€åä¸€\t// ä¸ªç»“ç‚¹ root Element // å½“å‰åˆ—è¡¨é•¿åº¦ï¼Œä¸åŒ…æ‹¬å“¨å…µèŠ‚ç‚¹ len int } åˆå§‹åŒ– // åˆå§‹åŒ–æˆ–æ¸…ç©º list lã€‚ func (l *List) Init() *List { l.root.next = \u0026amp;l.root l.root.prev = \u0026amp;l.root l.len = 0 return l } func (l *List) lazyInit() { if l.root.next == nil { l.Init() } } æ’å…¥ // insert inserts e after at, increments l.len, and returns e. func (l *List) insert(e, at *Element) *Element { e.prev = at e.next = at.next e.prev.next = e e.next.prev = e e.list = l l.len++ return e } // insertValue is a convenience wrapper for insert(\u0026amp;Element{Value: v}, at). func (l *List) insertValue(v interface{}, at *Element) *Element { return l.insert(\u0026amp;Element{Value: v}, at) } // PushBack inserts a new element e with value v at the back of list l and returns e. func (l *List) PushBack(v interface{}) *Element { l.lazyInit() return l.insertValue(v, l.root.prev) } è·å– Front() è·å–é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹\n// è¿”å›åˆ—è¡¨ l çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œåˆ™è¿”å›nilã€‚ func (l *List) Front() *Element { if l.len == 0 { return nil } // è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ç”¨ root.next è¿æ¥ç¬¬ä¸€ä¸ªç»“ç‚¹ return l.root.next } Back() è·å–é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹\n// è¿”å›åˆ—è¡¨lçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼›å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œåˆ™è¿”å›nilã€‚ func (l *List) Back() *Element { if l.len == 0 { return nil } // è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ç”¨ root.prev è¿æ¥æœ€åä¸€ä¸ªèŠ‚ç‚¹ return l.root.prev } ","date":"2020å¹´02æœˆ24æ—¥","permalink":"/posts/2021-2-24-go-container-list-source-code/","summary":"List // Listä»£è¡¨ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚Listé›¶å€¼ä¸ºä¸€ä¸ªç©ºçš„ã€å¯ç”¨çš„é“¾è¡¨ã€‚ type List struct { // å“¨å…µèŠ‚ç‚¹ï¼Œè¿æ¥é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼Œroot.","title":"go container/list æºç åˆ†æã€æœªå®Œã€‘"},{"contents":"åœºæ™¯ åœ¨ LeetCode 255.ç”¨é˜Ÿåˆ—å®ç°æ ˆ è¿™é“é¢˜é‡Œï¼Œéœ€è¦ç”¨åˆ°ä¸¤ä¸ªé˜Ÿåˆ—æ¥å®ç°ä¸€ä¸ªæ ˆï¼Œå¹¶ä¸”åœ¨ç®—æ³•æµç¨‹ä¸­ï¼Œéœ€è¦äº¤æ¢è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šé˜Ÿåˆ— A =\u0026gt; [1, 2, 3]ï¼Œé˜Ÿåˆ— B =\u0026gt; [555]ï¼Œäº¤æ¢åï¼šA =\u0026gt; [555]ï¼ŒB =\u0026gt; [1, 2, 3]ã€‚\ngo æ ‡å‡†åº“ä¸­å¹¶æ²¡æœ‰æä¾›é˜Ÿåˆ—çš„å®ç°ï¼Œä½†æ˜¯æä¾›äº† container/list è¿™æ ·ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ list æ¥æ¨¡æ‹Ÿä¸€ä¸ªé˜Ÿåˆ—ï¼Œå®šä¹‰å¦‚ä¸‹ç»“æ„ä½“ï¼š\ntype MyStack struct { Queue1 *list.List\t// é˜Ÿåˆ— 1 Queue2 *list.List\t// é˜Ÿåˆ— 2 } åœ¨ push æ–¹æ³•ä¸­éœ€è¦äº¤æ¢ä¸¤ä¸ªé˜Ÿåˆ—çš„å†…å®¹ï¼š\nå†™æ³•1 func (this *MyStack) Push(x int) { // çœç•¥å…¶ä»–ä»£ç  // åœ¨è¿™é‡Œäº¤æ¢å€¼ this.Queue1, this.Queue2 = this.Queue2, this.Queue1 } ä¸Šé¢çš„ä»£ç æ˜¯å¯ä»¥æ­£ç¡®è¿è¡Œçš„ï¼Œè¿™é‡Œçš„äº¤æ¢è¯­å¥è®© Queue1 é‡æ–°æŒ‡å‘äº†å¦ä¸€ä¸ª listï¼ŒQueue2 ä¹ŸåŒæ ·å¦‚æ­¤ï¼Œä¾‹å¦‚ï¼šQueue1 =\u0026gt; 0x0001ï¼ŒQueue2 =\u0026gt; 0x0013ï¼Œäº¤æ¢åï¼šQueue1 =\u0026gt; 0x0013ï¼ŒQueue2 =\u0026gt; 0x0001ï¼Œè¿™é‡Œä»…ä»…æ˜¯æ”¹å˜äº†ç»“æ„ä½“æˆå‘˜å±æ€§çš„å€¼ï¼ˆæŒ‡å‘ï¼‰ï¼Œå¹¶æ²¡æœ‰å¯¹å±æ€§ list å†…éƒ¨è¿›è¡Œæ›´æ”¹ã€‚\nå†™æ³•2 ä¸ºäº†è®©ä»£ç æ›´ç®€æ´ä¸€äº›ï¼Œæˆ‘å°è¯•ç”¨ä¸¤ä¸ªå˜é‡ä¿å­˜ this.Queue1å’Œ this.Queue2ï¼š\nfunc (this *MyStack) Push(x int) { q1 := this.Queue1 q2 := this.Queue2 // çœç•¥å…¶ä»–ä»£ç  // åœ¨è¿™é‡Œäº¤æ¢å€¼ q1, q2 = q2, q1 } ä¸Šé¢è¿™æ®µä»£ç ä¼šå‡ºé”™ï¼Œå› ä¸ºè¿™é‡Œçš„äº¤æ¢çš„æ˜¯ä»…ä»…ä¸¤ä¸ªå˜é‡ q1 å’Œ q2 çš„å€¼ï¼Œå¹¶æ²¡æœ‰å¯¹ç»“æ„ä½“ä¸­çš„å±æ€§é€ æˆå½±å“ã€‚\nå†™æ³•3 func (this *MyStack) Push(x int) { q1 := this.Queue1 q2 := this.Queue2 // çœç•¥å…¶ä»–ä»£ç  // åœ¨è¿™é‡Œäº¤æ¢å€¼ *q1, *q2 = *q2, *q1 } å› ä¸º q1 å’Œ q2 éƒ½æ˜¯æŒ‡é’ˆå˜é‡ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ *å–å†…å®¹ç¬¦ æ¥äº¤æ¢å€¼ï¼Œå°±å’Œäº¤æ¢ä¸¤ä¸ªæŒ‡é’ˆå‚æ•°å€¼ä¸€æ ·ï¼Œçœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯è¿è¡Œç»“æœå´è¯¡å¼‚çš„å‡ºç°äº†æ­»å¾ªç¯ï¼Œè€Œä¸”æ’æŸ¥äº†è®¸ä¹…éƒ½æ‰¾ä¸åˆ°åŸå› ã€‚\næµ‹è¯• Struct ll å®šä¹‰ä¸€ä¸ªç±»ä¼¼çš„ç»“æ„ä½“ï¼š\ntype ll struct { l1 *list.List l2 *list.List } swap() ç±»ä¼¼ æ–¹æ³•ä¸‰ ä¸­çš„å–å€¼äº¤æ¢æ–¹å¼ï¼š\nfunc swap(l1, l2 *list.List) { *l1, *l2 = *l2, *l1 } _print å®šä¹‰ä¸€ä¸ªè¾“å‡ºå‡½æ•°ç”¨æ¥å‹å¥½è¾“å‡ºé“¾è¡¨ï¼Œè¾“å‡ºå€¼çš„åŒæ—¶ä¹Ÿè¾“å‡ºåœ°å€å€¼ï¼š\nfunc _print(name string, l *list.List) { fmt.Print(name + \u0026quot;: \u0026quot;) for i := l.Front(); i != nil; i = i.Next() { fmt.Printf(\u0026quot;%v[%p] -\u0026gt; \\t\u0026quot;, i.Value, i) } fmt.Println() } æµ‹è¯•ä»£ç ï¼š\n// åˆ›å»ºä¸¤ä¸ª list l1 := list.New() l2 := list.New() // ä¸ºä¸¤ä¸ªé“¾è¡¨æ·»åŠ å€¼ï¼Œl1: 1 -\u0026gt; 2 -\u0026gt; 3ï¼Œl2: 666 l1.PushBack(1) l1.PushBack(2) l1.PushBack(3) l2.PushBack(666) // è¾“å‡ºäº¤æ¢å‰çš„å€¼ fmt.Println(\u0026quot;before: \u0026quot;) _print(\u0026quot;l1\u0026quot;, l1) _print(\u0026quot;l2\u0026quot;, l2) // äº¤æ¢å‡½æ•° swap(l1, l2) // è¾“å‡ºäº¤æ¢åçš„å€¼ fmt.Println(\u0026quot;after: \u0026quot;) _print(\u0026quot;l1\u0026quot;, l1) _print(\u0026quot;l2\u0026quot;, l2) è¿è¡Œç»“æœï¼š\nbefore: l1: 1[0xc00009cde0] -\u0026gt; 2[0xc00009ce10] -\u0026gt; 3[0xc00009ce40] -\u0026gt; l2: 666[0xc00009ce70] -\u0026gt; after: l1: 666[0xc00009ce70] -\u0026gt; l2: 1[0xc00009cde0] -\u0026gt; 2[0xc00009ce10] -\u0026gt; 3[0xc00009ce40] -\u0026gt; ä¸¤ä¸ªé“¾è¡¨çš„å€¼ç¡®å®å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåœ¨ æ–¹æ³• 3 ä¸­ä¼šäº§ç”Ÿè¯¡å¼‚çš„é”™è¯¯å‘¢ï¼Ÿç»§ç»­å°è¯•è¿½åŠ å€¼ï¼š\n// äº¤æ¢å®Œä¹‹å pushback fmt.Println(\u0026quot;after swap pushback: \u0026quot;) l2.PushBack(555) l1.PushBack(6) // è¾“å‡ºä¸¤ä¸ªé“¾è¡¨ _print(\u0026quot;l1\u0026quot;, l1) _print(\u0026quot;l2\u0026quot;, l2) è¿è¡Œç»“æœï¼š\nafter swap pushback: l1: 666[0xc000104e70] -\u0026gt; 6[0xc000104ed0] -\u0026gt; 555[0xc000104ea0] -\u0026gt; \u0026lt;nil\u0026gt;[0xc000104db0] -\u0026gt; l2: 1[0xc000104de0] -\u0026gt; 2[0xc000104e10] -\u0026gt; 3[0xc000104e40] -\u0026gt; ä¸Šé¢çš„ä»£ç å‘ l1 å°¾éƒ¨æ·»åŠ äº† å…ƒç´  6ï¼Œå‘ l2 å°¾éƒ¨æ·»åŠ å…ƒç´  555ï¼Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ï¼š\nl1: 666 -\u0026gt; 6\nl2: 1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 555\nä½†è¿è¡Œç»“æœå´ååˆ†è¯¡å¼‚ï¼š\nl1: 666 -\u0026gt; 6 -\u0026gt; 555 -\u0026gt; nil\nl2: 1 -\u0026gt; 2 -\u0026gt; 3\næœ¬æ¥åº”è¯¥æ·»åŠ åˆ° l2 çš„ 555 è¢«æ·»åŠ åˆ°äº† l1ï¼Œå¹¶ä¸” l1 è¿˜å¤šäº†ä¸€ä¸ª é¢å¤–çš„ nil\nåˆ†æ ç»“åˆæºç è¿›è¡Œäº†åˆ†æï¼ˆä¸ä¸€å®šæ­£ç¡®ï¼‰\nè‡³äºä¸ºä»€ä¹ˆä¼šå‡ºç° æµ‹è¯• ä¸­çš„è¯¡å¼‚æƒ…å†µï¼Œå‘ç°è‡ªå·±æ°´å¹³æœ‰é™ï¼Œç”»å›¾ç”»çš„æ™•å¤´è½¬å‘ï¼Œæ‰¾ä¸å‡ºä¸€ä¸ªåˆç†çš„åŸå› ï¼Œåªèƒ½è‰è‰å½’ç»“äº list çš„ç¯å½¢è¢«ç ´åï¼Œå¯¼è‡´äº§ç”Ÿæ— æ³•é¢„æ–™çš„ç»“æœã€‚\næ€»ç»“ å†™æ³•1 this.Queue1, this.Queue2 = this.Queue2, this.Queue1 åªæ˜¯äº¤æ¢äº†ç»“æ„ä½“å±æ€§ q1 å’Œ q2 çš„æŒ‡å‘ï¼Œæ²¡æœ‰å¯¹ list å†…éƒ¨è¿›è¡Œä¿®æ”¹ï¼Œè€Œ å†™æ³•3 *this.Queue1, *this.Queue2 = *this.Queue2, *this.Queue1 åˆ™æ˜¯ç›´æ¥å¯¹ list å†…éƒ¨è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ‰€ä»¥äº§ç”Ÿäº†æ— æ³•é¢„æ–™çš„åæœï¼Œè¿™ä¹Ÿå……åˆ†è¯´æ˜äº†æŒ‡é’ˆçš„å±é™©æ€§ã€‚\n","date":"2020å¹´02æœˆ24æ—¥","permalink":"/posts/2021-2-24-go-container-list-swap/","summary":"åœºæ™¯ åœ¨ LeetCode 255.ç”¨é˜Ÿåˆ—å®ç°æ ˆ è¿™é“é¢˜é‡Œï¼Œéœ€è¦ç”¨åˆ°ä¸¤ä¸ªé˜Ÿåˆ—æ¥å®ç°ä¸€ä¸ªæ ˆï¼Œå¹¶ä¸”åœ¨ç®—æ³•æµç¨‹ä¸­ï¼Œéœ€è¦äº¤æ¢è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šé˜Ÿåˆ— A =\u0026gt; [1, 2, 3]ï¼Œé˜Ÿåˆ— B =\u0026gt; [555]ï¼Œäº¤æ¢åï¼šA =\u0026gt; [555]ï¼ŒB =\u0026gt; [1, 2, 3]ã€‚","title":"go äº¤æ¢ container/list çš„å€¼"},{"contents":"go åŸºç¡€ä¹‹ä½¿ç”¨åŸç”Ÿ http åº“å‘é€ post è¯·æ±‚\næ–¹å¼ 1 // ç”Ÿæˆè¯·æ±‚å‚æ•°é”®å€¼å¯¹ data := url.Values{\u0026quot;propId\u0026quot;: {giftId}, \u0026quot;propCount\u0026quot;: {count}, \u0026quot;roomId\u0026quot;: {c.RoomId}} // Encode() ç¼–ç æˆå­—ç¬¦ä¸²ï¼Œå¹¶åŒ…è£…æˆä¸€ä¸ª io.Reader body := strings.NewReader(data.Encode()) // ä¼ åˆ°ç¬¬ä¸‰ä¸ªå‚æ•° req, err := http.NewRequest(\u0026quot;POST\u0026quot;, \u0026quot;https://www.douyu.com/japi/prop/donate/mainsite/v1\u0026quot;, body) client := http.Client{} response, err := client.Do(req) æ–¹å¼ 2 var r http.Request r.ParseForm() r.Form.Add(\u0026quot;propId\u0026quot;, giftId) r.Form.Add(\u0026quot;propCount\u0026quot;, count) r.Form.Add(\u0026quot;roomId\u0026quot;, roomId) body := strings.NewReader(r.Form.Encode()) req, err := http.NewRequest(\u0026quot;POST\u0026quot;, \u0026quot;https://www.douyu.com/japi/prop/donate/mainsite/v1\u0026quot;, body) client := http.Client{} response, err := client.Do(req) æ–¹å¼ 3 // ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸² body := strings.NewReader(\u0026quot;propId=268\u0026amp;propCount=1\u0026amp;roomId=9999\u0026amp;bizExt=%7B%22yzxq%22%3A%7B%7D%7D\u0026quot;) req, err := http.NewRequest(\u0026quot;POST\u0026quot;, \u0026quot;https://www.douyu.com/japi/prop/donate/mainsite/v1\u0026quot;, body) client := http.Client{} response, err := client.Do(req) å…¶ä»– ä¸Šé¢çš„ä¸‰ç§æ–¹æ³•ï¼Œåªæ˜¯åˆ›å»ºè¯·æ±‚å‚æ•°é”®å€¼å¯¹çš„æ–¹å¼ä¸åŒï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨äº† http.Client.Do() æ–¹æ³•ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œgo è¿˜å°è£…äº†ä¸€äº› post æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n// æ–¹æ³• 1 data := url.Values{\u0026quot;start\u0026quot;:{\u0026quot;0\u0026quot;}, \u0026quot;offset\u0026quot;:{\u0026quot;xxxx\u0026quot;}} body := strings.NewReader(data.Encode()) resp, err := http.Post(\u0026quot;url\u0026quot;, \u0026quot;application/x-www-form-urlencoded\u0026quot;, body) // æ–¹æ³• 2 var r http.Request r.ParseForm() r.Form.Add(\u0026quot;xxx\u0026quot;, \u0026quot;xxx\u0026quot;) body := strings.NewReader(r.Form.Encode()) http.Post(\u0026quot;xxxx\u0026quot;, \u0026quot;application/x-www-form-urlencoded\u0026quot;, body) // æ–¹æ³• 3 data := url.Values{\u0026quot;start\u0026quot;:{\u0026quot;0\u0026quot;}, \u0026quot;offset\u0026quot;:{\u0026quot;xxxx\u0026quot;}} // PostForm çš„é»˜è®¤ content-type æ˜¯ application/x-www-form-urlencoded http.PostForm(\u0026quot;xxxx\u0026quot;, data) å‘é€ json bodyJson := `{\u0026quot;name\u0026quot;:\u0026quot;zhang3 by json\u0026quot;, \u0026quot;id\u0026quot;:\u0026quot;123 by json\u0026quot;}` body := bytes.NewReader([]byte(bodyJson)) req, err := http.NewRequest(http.MethodPost, __url__, body) if err != nil { log.Fatal(err) } // è®¾ç½® content-type ä¸º application/json req.Header.Set(\u0026quot;Content-Type\u0026quot;, \u0026quot;application/json\u0026quot;) resp1, _ := http.DefaultClient.Do(req) defer resp1.Body.Close() fmt.Println(\u0026quot;(2)\u0026quot;, string(read(resp1.Body))) ","date":"2020å¹´01æœˆ24æ—¥","permalink":"/posts/2021-1-24-go-post-request/","summary":"go åŸºç¡€ä¹‹ä½¿ç”¨åŸç”Ÿ http åº“å‘é€ post è¯·æ±‚","title":"go å‘é€ post è¯·æ±‚"},{"contents":"åœ¨ c++ çš„å¼•ç”¨è§„åˆ™ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ¡ï¼šä¸€æ—¦åˆå§‹åŒ–å®Œæˆ ï¼Œå¼•ç”¨å°†å’Œå®ƒçš„åˆå§‹å€¼å¯¹è±¡ä¸€ç›´ç»‘å®šåœ¨ä¸€èµ·ï¼ˆå³ä¸èƒ½å†æŒ‡å‘å…¶ä»–å¯¹è±¡ï¼‰ã€‚æŠ±ç€åˆå­¦è€…çš„å¥½å¥‡å¿ƒæ€ï¼Œæˆ‘å°è¯•æ”¹å˜å¼•ç”¨çš„æŒ‡å‘ï¼Œå†™å‡ºäº†å¦‚ä¸‹ä»£ç ï¼š\n// å®šä¹‰ä¸¤ä¸ª string å˜é‡ std::string s = \u0026quot;123\u0026quot;; std::string s2 = \u0026quot;456\u0026quot;; // è®© s1 å¼•ç”¨ s std::string \u0026amp;s1 = s; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹å‰ï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // ä¿®æ”¹ s1 çš„å¼•ç”¨ï¼Ÿ s1 = s2; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹åï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // output ä¿®æ”¹å‰ï¼šs1: 123 ä¿®æ”¹åï¼šs1: 456 è¿™é‡Œæˆ‘è®© s1 é‡æ–°æŒ‡å‘ s2ï¼Œå¹¶ä¸”ä»è¾“å‡ºç»“æœæ¥çœ‹ï¼Œs1 çš„å€¼ä¹Ÿç¡®å®è¢«ä¿®æ”¹äº†ï¼Œä¸å¯¹å•Šï¼Œè§„åˆ™ä¸­æ˜æ˜è¯´å¥½äº†ä¸èƒ½ä¿®æ”¹çš„ï¼Œæ€ä¹ˆå®é™…ä»£ç ä¸­å¯ä»¥ï¼Ÿä¸ºäº†éªŒè¯å¼•ç”¨æ˜¯å¦çœŸçš„è¢«ä¿®æ”¹ï¼Œå°†ä¸‰ä¸ªå˜é‡çš„æŒ‡é’ˆæ‰“å°å‡ºæ¥ï¼š\nprintf(\u0026quot;æŒ‡é’ˆ =\u0026gt; s1: %p | s2: %p | s: %p \\n\u0026quot;, \u0026amp;s1, \u0026amp;s2, \u0026amp;s); // output æŒ‡é’ˆ =\u0026gt; s1: 0x7ffee199e7c8 | s2: 0x7ffee199e7b0 | s: 0x7ffee199e7c8 s1 å’Œ s3 æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œè¯´æ˜å¼•ç”¨å¹¶æœªæ”¹å˜ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¼•ç”¨è¢«ä¿®æ”¹äº†ï¼Œè€Œæ˜¯æˆ‘çš„ç†è§£å‡ºç°äº†é—®é¢˜ï¼Œä»£ç ä¸­çš„ s1 = s2ï¼Œå¹¶ä¸æ˜¯è®©å¼•ç”¨é‡æ–°æŒ‡å‘ s2ï¼Œè€Œæ˜¯æŠŠå€¼èµ‹ç»™äº†ä¸å¼•ç”¨ç»‘å®šçš„å¯¹è±¡ï¼ˆç­‰åŒäº s = s2ï¼‰ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•éªŒè¯å°±å¾ˆå¥½ç†è§£äº†ï¼š\n// å®šä¹‰ä¸¤ä¸ª string å˜é‡ std::string s = \u0026quot;123\u0026quot;; std::string s2 = \u0026quot;456\u0026quot;; // è®© s1 å¼•ç”¨ s std::string \u0026amp;s1 = s; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹å‰ï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // ä¿®æ”¹ s1 çš„å¼•ç”¨ï¼Ÿ s1 = s2; // ä¿®æ”¹ s2 çš„å€¼ï¼Œå¦‚æœ s1 çš„å¼•ç”¨è¢«ä¿®æ”¹ä¸ºæŒ‡å‘ s2ï¼Œé‚£ä¹ˆ s1 çš„å€¼åº”è¯¥ä¹Ÿä¼šæ”¹ä¸º \u0026quot;666\u0026quot; s2 = \u0026quot;666\u0026quot;; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹åï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // output ä¿®æ”¹å‰ï¼šs1: 123 ä¿®æ”¹åï¼šs1: 456 s1 å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ä¸º \u0026ldquo;666\u0026rdquo;ï¼Œæ‰€ä»¥å¯ä»¥å°è¯ä¸Šé¢çš„è¯´æ³•ã€‚\n","date":"2020å¹´01æœˆ11æ—¥","permalink":"/posts/2021-1-11-reference_c++/","summary":"åœ¨ c++ çš„å¼•ç”¨è§„åˆ™ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ¡ï¼šä¸€æ—¦åˆå§‹åŒ–å®Œæˆ ï¼Œå¼•ç”¨å°†å’Œå®ƒçš„åˆå§‹å€¼å¯¹è±¡ä¸€ç›´ç»‘å®šåœ¨ä¸€èµ·ï¼ˆå³ä¸èƒ½å†æŒ‡å‘å…¶ä»–å¯¹è±¡ï¼‰ã€‚æŠ±ç€åˆå­¦è€…çš„å¥½å¥‡å¿ƒæ€ï¼Œæˆ‘å°è¯•æ”¹å˜å¼•ç”¨çš„æŒ‡å‘ï¼Œå†™å‡ºäº†å¦‚ä¸‹ä»£ç ï¼š\n// å®šä¹‰ä¸¤ä¸ª string å˜é‡ std::string s = \u0026quot;123\u0026quot;; std::string s2 = \u0026quot;456\u0026quot;; // è®© s1 å¼•ç”¨ s std::string \u0026amp;s1 = s; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹å‰ï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // ä¿®æ”¹ s1 çš„å¼•ç”¨ï¼Ÿ s1 = s2; std::cout \u0026lt;\u0026lt; \u0026quot;ä¿®æ”¹åï¼š\u0026quot; \u0026lt;\u0026lt; \u0026quot;s1: \u0026quot; \u0026lt;\u0026lt; s1 \u0026lt;\u0026lt; std::endl; // output ä¿®æ”¹å‰ï¼šs1: 123 ä¿®æ”¹åï¼šs1: 456 è¿™é‡Œæˆ‘è®© s1 é‡æ–°æŒ‡å‘ s2ï¼Œå¹¶ä¸”ä»è¾“å‡ºç»“æœæ¥çœ‹ï¼Œs1 çš„å€¼ä¹Ÿç¡®å®è¢«ä¿®æ”¹äº†ï¼Œä¸å¯¹å•Šï¼Œè§„åˆ™ä¸­æ˜æ˜è¯´å¥½äº†ä¸èƒ½ä¿®æ”¹çš„ï¼Œæ€ä¹ˆå®é™…ä»£ç ä¸­å¯ä»¥ï¼Ÿä¸ºäº†éªŒè¯å¼•ç”¨æ˜¯å¦çœŸçš„è¢«ä¿®æ”¹ï¼Œå°†ä¸‰ä¸ªå˜é‡çš„æŒ‡é’ˆæ‰“å°å‡ºæ¥ï¼š","title":"c++ å¼•ç”¨ï¼šå¦‚ä½•ç†è§£\"å¼•ç”¨è¢«åˆå§‹åŒ–åï¼Œä¸èƒ½å†æŒ‡å‘å…¶ä»–å¯¹è±¡\""},{"contents":"Linux çš„ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥\nç´¢å¼•èŠ‚ç‚¹ åœ¨Linuxçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¿å­˜åœ¨ç£ç›˜åˆ†åŒºä¸­çš„æ–‡ä»¶ä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹éƒ½ç»™å®ƒåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œç§°ä¸ºç´¢å¼•èŠ‚ç‚¹å·(Inode Index)ï¼Œå¯ä»¥é€šè¿‡ ls -li æŸ¥çœ‹æ¯ä¸ªæ–‡ä»¶çš„ç´¢å¼•èŠ‚ç‚¹ï¼š\nls -li total 56 8758859 -rw-r--r-- 1 zz staff 364 12 27 11:57 bufio_read.go 7957721 -rw-r--r-- 1 zz staff 383 12 13 22:30 bufio_scann.go 10097171 -rw-r--r-- 1 zz staff 225 1 8 12:04 deferTest.go 10164017 -rw-r--r-- 1 zz staff 464 1 8 20:43 inToOut.go 8751290 -rw-r--r-- 1 zz staff 276 12 26 22:13 scanfTest.go 7173127 -rw-r--r-- 1 zz staff 338 12 2 14:45 t1.go 7173519 -rw-r--r--@ 1 zz staff 1520 12 2 14:59 test.go ç¡¬é“¾æ¥ åŸºæœ¬å‘½ä»¤ï¼š\nln f1 f2 #åˆ›å»ºf1çš„ä¸€ä¸ªç¡¬è¿æ¥æ–‡ä»¶f2 ç¡¬é“¾æ¥å¯ä»¥ç®€å•æŠŠå®ƒæƒ³æˆ C è¯­è¨€ä¸­çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†ç‰©ç†ç¡¬ç›˜çš„ä¸€ä¸ªåŒºå—ï¼Œå¤šä¸ªç¡¬é“¾æ¥ä¼šæŒ‡å‘åŒä¸€ä¸ªåŒºå—ï¼Œï¼ˆå¯ä»¥ç†è§£ä¸º C ä¸­çš„å¤šä¸ªæŒ‡é’ˆæŒ‡å‘äº†åŒä¸€å—å†…å­˜ç©ºé—´ï¼‰ã€‚\ntouch f \u0026amp;\u0026amp; echo \u0026quot;hello\u0026quot; \u0026gt; f # åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶å‘å…¶å†™å…¥å†…å®¹ ln f hard_f # åˆ›å»º f çš„ç¬¬ä¸€æ¡ç¡¬é“¾æ¥ hard_f ln f hard_f1 # åˆ›å»º f çš„ç¬¬äºŒæ¡ç¡¬é“¾æ¥ hard_f1 ll -i 10966044 -rw-r--r-- 3 zz staff 6B 1 19 11:52 f 10966044 -rw-r--r-- 3 zz staff 6B 1 19 11:52 hard_f 10966044 -rw-r--r-- 3 zz staff 6B 1 19 11:52 hard_f1 # ä¸¤ä¸ªç¡¬é“¾æ¥çš„ inode index ä¸æºæ–‡ä»¶ç›¸åŒ å› ä¸ºæŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªç¡¬ç›˜åŒºå—ï¼Œæ‰€ä»¥é€šè¿‡ç¡¬é“¾æ¥æ›´æ”¹æ–‡ä»¶å†…å®¹æ—¶ï¼Œä¼šå¯¼è‡´å…¶ä»–çš„ç¡¬é“¾æ¥åŠæºæ–‡ä»¶ä¹Ÿè¢«æ›´æ”¹ï¼š\ncat f hard_f hard_f1 # è¾“å‡ºä¸‰ä¸ªæ–‡ä»¶çš„åˆå§‹å€¼ hello hello hello echo \u0026quot;123\u0026quot; \u0026gt; hard_f # ä¿®æ”¹ hard_f çš„å†…å®¹ cat f hard_f hard_f1 # ä¸‰ä¸ªæ–‡ä»¶çš„å€¼å·²ç»å…¨éƒ¨æ›´æ”¹äº† 123 123 123 äº‹å®ä¸Šæ–‡ä»¶ç³»ç»Ÿä¼šç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œåªè¦æœ‰æ–‡ä»¶æŒ‡å‘è¿™ä¸ªåŒºå—ï¼Œå®ƒå°±ä¸ä¼šä»ç¡¬ç›˜ä¸Šæ¶ˆå¤±ã€‚\nrm f # åˆ é™¤æºæ–‡ä»¶ cat hard_f hard_f1 # å°è¯•è¾“å‡ºä¸¤ä¸ªé“¾æ¥æ–‡ä»¶çš„å†…å®¹ 123 123 # ç¡¬é“¾æ¥æ–‡ä»¶å¯ä»¥æ­£å¸¸è¾“å‡º ç¡¬è¿æ¥çš„ä½œç”¨æ˜¯å…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªæœ‰æ•ˆè·¯å¾„åï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å»ºç«‹ç¡¬è¿æ¥åˆ°é‡è¦æ–‡ä»¶ï¼Œä»¥é˜²æ­¢â€œè¯¯åˆ â€çš„åŠŸèƒ½ã€‚å…¶åŸå› å¦‚ä¸Šæ‰€è¿°ï¼Œå› ä¸ºå¯¹åº”è¯¥ç›®å½•çš„ç´¢å¼•èŠ‚ç‚¹æœ‰ä¸€ä¸ªä»¥ä¸Šçš„è¿æ¥ã€‚åªåˆ é™¤ä¸€ä¸ªè¿æ¥å¹¶ä¸å½±å“ç´¢å¼•èŠ‚ç‚¹æœ¬èº«å’Œå…¶å®ƒçš„è¿æ¥ï¼Œåªæœ‰å½“æœ€åä¸€ä¸ªè¿æ¥è¢«åˆ é™¤åï¼Œæ–‡ä»¶çš„æ•°æ®å—åŠç›®å½•çš„è¿æ¥æ‰ä¼šè¢«é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶çœŸæ­£åˆ é™¤çš„æ¡ä»¶æ˜¯ä¸ä¹‹ç›¸å…³çš„æ‰€æœ‰ç¡¬è¿æ¥æ–‡ä»¶å‡è¢«åˆ é™¤ã€‚\nè½¯é“¾æ¥ åŸºæœ¬å‘½ä»¤ï¼š\nln -s f1 soft è½¯é“¾æ¥ä¹Ÿç§°ä¹‹ä¸ºç¬¦å·è¿æ¥ï¼ˆSymbolic Linkï¼‰ï¼Œè½¯é“¾æ¥æ–‡ä»¶æœ‰ç±»ä¼¼äºWindowsçš„å¿«æ·æ–¹å¼ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ã€‚åœ¨ç¬¦å·è¿æ¥ä¸­ï¼Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æœ‰å¦ä¸€æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼Œåœ¨ç¡¬ç›˜ä¸Šæœ‰ç‹¬ç«‹çš„åŒºå—ï¼Œè®¿é—®æ—¶æ›¿æ¢è‡ªèº«è·¯å¾„ã€‚\nä¸ç¡¬é“¾æ¥ä¸åŒï¼Œè½¯é“¾æ¥çš„ inode_index ä¸æºæ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œæ¯ä¸ªè½¯é“¾æ¥çš„ inode_index ä¹Ÿä¸åŒï¼Œå¦‚ä¸‹ï¼š\nln -s f soft_f1\t# åˆ›å»ºä¸¤ä¸ªè½¯é“¾æ¥ ln -s f soft_f2 ll -i 10973146 -rw-r--r-- 1 zz staff 4B 1 19 17:19 f 10973197 lrwxr-xr-x 1 zz staff 1B 1 19 17:19 soft_f1 -\u0026gt; f 10973203 lrwxr-xr-x 1 zz staff 1B 1 19 17:20 soft_f2 -\u0026gt; f è½¯é“¾æ¥çš„æ˜¾ç¤ºå½¢å¼ä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œä¸º è½¯é“¾æ¥æ–‡ä»¶ -\u0026gt; æºæ–‡ä»¶ã€‚\nåˆ é™¤æºæ–‡ä»¶åï¼Œæ‰€æœ‰å…³è”çš„çš„è½¯é“¾æ¥æ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼ˆå› ä¸ºä¸¤ä¸ªæ˜¯ä¸åŒçš„æ–‡ä»¶ï¼‰ï¼Œä½†æŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ— æ•ˆçš„é“¾æ¥ï¼š\nrm f\t# åˆ é™¤æºæ–‡ä»¶ cat soft_f1 soft_f2\t# å°è¯•è¾“å‡ºä¸¤ä¸ªè½¯é“¾æ¥æ–‡ä»¶ cat: soft_f1: No such file or directory\t# æ— æ³•è¾“å‡ºå†…å®¹ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ cat: soft_f2: No such file or directory æ€»ç»“ ç¡¬é“¾æ¥æ˜¯æŒ‡é’ˆï¼Œæ‰€æœ‰çš„ç¡¬é“¾æ¥éƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªç£ç›˜å—ã€‚ åˆ é™¤ä¸€ä¸ªæŒ‡é’ˆä¸ä¼šçœŸæ­£åˆ é™¤æ–‡ä»¶ï¼Œåªæœ‰æŠŠæ‰€æœ‰çš„æŒ‡é’ˆéƒ½åˆ é™¤æ‰ä¼šçœŸæ­£åˆ é™¤æ–‡ä»¶ã€‚ è½¯è¿æ¥æ˜¯å¦å¤–ä¸€ç§ç±»å‹çš„æ–‡ä»¶ï¼Œä¿å­˜çš„æ˜¯å®ƒæŒ‡å‘æ–‡ä»¶çš„å…¨è·¯å¾„ï¼Œ è®¿é—®æ—¶ä¼šæ›¿æ¢æˆç»å¯¹è·¯å¾„\n","date":"2020å¹´01æœˆ11æ—¥","permalink":"/posts/2021-1-19-soft-hard-link/","summary":"Linux çš„ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥\nç´¢å¼•èŠ‚ç‚¹ åœ¨Linuxçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¿å­˜åœ¨ç£ç›˜åˆ†åŒºä¸­çš„æ–‡ä»¶ä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹éƒ½ç»™å®ƒåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œç§°ä¸ºç´¢å¼•èŠ‚ç‚¹å·(Inode Index)ï¼Œå¯ä»¥é€šè¿‡ ls -li æŸ¥çœ‹æ¯ä¸ªæ–‡ä»¶çš„ç´¢å¼•èŠ‚ç‚¹ï¼š","title":"ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥"},{"contents":"è‹±è¯­ ç¨‹åºå‘˜å·¥ä½œä¸­å¸¸è§çš„è‹±è¯­è¯æ±‡ äººäººéƒ½èƒ½ç”¨è‹±è¯­-æç¬‘æ¥ å¤§å‰ç«¯ç±» Javascript èµ„æºï¼šAirbnb javascriptç¼–ç è§„èŒƒ Fluter èµ„æºï¼šFluteræ ·å¼æ¨¡æ¿ ç”µå­ä¹¦ï¼šFluterå®æˆ˜ Vue.js è½¯ä»¶ï¼šmavonEditor åŸºäºvueçš„markdownåœ¨çº¿ç¼–è¾‘å™¨ å¾®ä¿¡å°ç¨‹åº èµ„æºï¼šawesome-wechat-weapp åç«¯ç±» é¢è¯•ï¼šåç«¯é¢è¯•åŸºç¡€çŸ¥è¯†åˆé›† Python èµ„æºï¼šPythonå…¥é—¨æ•™ç¨‹ èµ„æºï¼šPythonå­¦ä¹ 100å¤© èµ„æºï¼šPyConChina ç”¨æˆ·ç»„ èµ„æºï¼šGuido PEGç³»åˆ—æ–‡ç« ç¿»è¯‘ èµ„æºï¼šè®¾è®¡æ¨¡å¼Pythonå®ç° èµ„æºï¼šå„ç§ç®—æ³•çš„Pythonå®ç° èµ„æºï¼šDjangoä¼˜ç§€èµ„æ–™å¤§å…¨ awesome django é¢è¯•ï¼šå…³äºPythonçš„é¢è¯•é¢˜åˆé›† ç”µå­ä¹¦ï¼šDjangoè®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µï¼ŒåŸºäºdjango1.7 ç”µå­ä¹¦ï¼šPython CookBook ç¬¬ä¸‰ç‰ˆ ç”µå­ä¹¦ï¼šåˆ©ç”¨Pythonè¿›è¡Œæ•°æ®åˆ†æÂ·ç¬¬2ç‰ˆ è½¯ä»¶ï¼šhttpxä¸‹ä¸€ä»£çš„python http client è½¯ä»¶ï¼šrequests-async å¼‚æ­¥è¯·æ±‚çš„http client Golang èµ„æºï¼šAwosome Golang èµ„æºï¼šAwosome Golang CN èµ„æºï¼šGolangè¯­è¨€çŸ¥è¯†å›¾è°± èµ„æºï¼šè®¾è®¡æ¨¡å¼Golangå®ç° è½¯ä»¶ï¼šlris: ä¸€æ¬¾ä¼˜ç§€çš„webæ¡†æ¶ è½¯ä»¶ï¼šKratosï¼šbilibiliå¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…· è½¯ä»¶ï¼šwideï¼šä¸€æ¬¾åŸºäº Web çš„ Go è¯­è¨€ IDE ç”µå­ä¹¦ï¼šGOè¯­è¨€é«˜çº§ç¼–ç¨‹ æ•°æ®åº“ç±» å¤§æ•°æ®ç±» èµ„æºï¼šå¤§æ•°æ®å…¥é—¨æŒ‡å— ç®—æ³•ç±» èµ„æºï¼šæœºå™¨å­¦ä¹ (Machine Learning)ã€æ·±åº¦å­¦ä¹ (Deep Learning)ã€NLPé¢è¯•ä¸­å¸¸è€ƒåˆ°çš„çŸ¥è¯†ç‚¹å’Œä»£ç å®ç° æœºå™¨å­¦ä¹  èµ„æºï¼šæœºå™¨å­¦ä¹ 100å¤©-ä¸­æ–‡ç‰ˆ èµ„æºï¼šæœºå™¨å­¦ä¹ 100å¤©-è‹±æ–‡ç‰ˆ èµ„æºï¼šè¥¿ç“œä¹¦(å‘¨å¿—åã€Šæœºå™¨å­¦ä¹ ã€‹)å­¦ä¹ ç¬”è®° ç”µå­ä¹¦ï¼šåŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹  ç”µå­ä¹¦ï¼šæ·±åº¦å­¦ä¹ å·¥ç¨‹å¸ˆç”Ÿå­˜æŒ‡å— Devops èµ„æºï¼šDevopså­¦ä¹ æŒ‡å—ï¼ŒåŒ…æ‹¬é¢è¯•é¢˜ èµ„æºï¼šè¿ç»´å®è·µæŒ‡å— èµ„æºï¼šåº”æ€¥å“åº”å®æˆ˜ç¬”è®° è½¯ä»¶ï¼šwalleï¼Œä¸€æ¬¾å¼€æºä¸Šçº¿éƒ¨ç½²ç³»ç»Ÿ è½¯ä»¶ï¼šCODOï¼ŒåŸºäºtonardoçš„å¾®æœåŠ¡devopsè§£å†³æ–¹æ¡ˆ åŒºå—é“¾ èµ„æºï¼šåŒºå—é“¾ä¸­æ–‡èµ„æº å…¶ä»– èµ„æºï¼šmarkdownåœ¨çº¿æ ¼å¼åŒ–é¡¹ç›®ï¼Œå…¬ä¼—å·ä½œè€…æ¨èä½¿ç”¨ èµ„æºï¼šè®¡ç®—æœºæŠ€æœ¯çš„è‡ªå­¦ä¹‹è·¯ é¢è¯•ï¼š2019æœ€æ–°å„å¤§äº’è”ç½‘é¢è¯•é¢˜åˆé›† èµ„æºï¼šä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦è¯¾ç¨‹èµ„æº è½¯ä»¶ï¼šlottery å¹´ä¼šæŠ½å¥– èµ„æºï¼šç¨‹åºå‘˜æ‰¾å·¥ä½œé»‘åå•å•ä½ ç”µå­ä¹¦ï¼šå…è´¹çš„è®¡ç®—æœºç±»ä¹¦ç±å¤§é›†åˆ ","date":"2019å¹´11æœˆ04æ—¥","permalink":"/resource/","summary":"è‹±è¯­ ç¨‹åºå‘˜å·¥ä½œä¸­å¸¸è§çš„è‹±è¯­è¯æ±‡ äººäººéƒ½èƒ½ç”¨è‹±è¯­-æç¬‘æ¥ å¤§å‰ç«¯ç±» Javascript èµ„æºï¼šAirbnb javascriptç¼–ç è§„èŒƒ Fluter èµ„æºï¼šFluteræ ·å¼æ¨¡æ¿ ç”µå­ä¹¦ï¼šFluterå®æˆ˜ Vue.","title":"èµ„æ–™åº“"},{"contents":" æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤\nğŸ  å…³äºæœ¬ç«™ ğŸ‘¨â€ğŸ’» åšä¸»æ˜¯è° â›¹ å…´è¶£çˆ±å¥½ ğŸ“¬ è”ç³»æˆ‘å‘€ ","date":"2019å¹´01æœˆ25æ—¥","permalink":"/posts/about/","summary":" æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤\nğŸ  å…³äºæœ¬ç«™ ğŸ‘¨â€ğŸ’» åšä¸»æ˜¯è° â›¹ å…´è¶£çˆ±å¥½ ğŸ“¬ è”ç³»æˆ‘å‘€ ","title":"å…³äº"},{"contents":"ğŸ‘ æ¬¢è¿ä½¿ç”¨ Gridea ï¼\nâœï¸ Gridea ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„\u0026hellip; \u0026hellip;\nGithub\nGridea ä¸»é¡µ\nç¤ºä¾‹ç½‘ç«™\nç‰¹æ€§ğŸ‘‡ ğŸ“ ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ Markdown è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ\nğŸŒ‰ ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡\nğŸ·ï¸ ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„\nğŸ“‹ ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•\nğŸ’» ä½ å¯ä»¥åœ¨ Windowsï¼ŒMacOS æˆ– Linux è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯\nğŸŒ ä½ å¯ä»¥ä½¿ç”¨ ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ æˆ– Coding Pages å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°\nğŸ’¬ ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ Gitalk æˆ– DisqusJS è¯„è®ºç³»ç»Ÿ\nğŸ‡¬ğŸ‡§ ä½ å¯ä»¥ä½¿ç”¨ä¸­æ–‡ç®€ä½“æˆ–è‹±è¯­\nğŸŒ ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›\nğŸ–¥ ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥\nğŸŒ± å½“ç„¶ Gridea è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ\næœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´\nå°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼\nğŸ˜˜ Enjoy~\n","date":"2018å¹´12æœˆ12æ—¥","permalink":"/posts/hello-gridea/","summary":"ğŸ‘ æ¬¢è¿ä½¿ç”¨ Gridea ï¼\nâœï¸ Gridea ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„\u0026hellip; \u0026hellip;","title":"Hello Gridea"},{"contents":"","date":"0001å¹´01æœˆ01æ—¥","permalink":"/search/","summary":"","title":"åŒ…å«å…³é”®è¯ çš„æ–‡ç« "},{"contents":"","date":"0001å¹´01æœˆ01æ—¥","permalink":"/tags/","summary":"","title":"æ ‡ç­¾"},{"contents":"","date":"0001å¹´01æœˆ01æ—¥","permalink":"/categories/","summary":"","title":"åˆ†ç±»"},{"contents":"","date":"0001å¹´01æœˆ01æ—¥","permalink":"/archive/","summary":"","title":"å½’æ¡£"},{"contents":"ä¸ªäººä¿¡æ¯ å´ç§€æ°‘/ç”·/1988 æœ¬ç§‘/ä¸´æ²‚å¤§å­¦/è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ å·¥ä½œå¹´é™ï¼š9å¹´ æŠ€æœ¯åšå®¢ï¼šhttps://pylixm.cc/ Githubï¼šhttps://github.com/pylixm æœŸæœ›èŒä½ï¼šè¿ç»´é«˜çº§å¼€å‘å·¥ç¨‹å¸ˆ/é«˜çº§å¼€å‘å·¥ç¨‹å¸ˆ æœŸæœ›è–ªèµ„ï¼šå¹´è–ª60wï¼Œç‰¹åˆ«å–œæ¬¢çš„å…¬å¸å¯ä¾‹å¤– æœŸæœ›åŸå¸‚ï¼šåŒ—äº¬ è”ç³»æ–¹å¼ æ‰‹æœº/å¾®ä¿¡ï¼š18612410531 Emailï¼špyli.xm#gmail.com QQï¼š20894205 æŠ€èƒ½æ¸…å• æŠ€æœ¯æ–¹é¢\nç†Ÿç»ƒæŒæ¡Pythonå¼€å‘ï¼Œç†Ÿæ‚‰Golang/javaçš„å¼€å‘ï¼› å–„äºä½¿ç”¨django æ¡†æ¶å¼€å‘webç³»ç»Ÿï¼Œå¯ä¸ªäººè´Ÿè´£å¼€å‘ä¸šåŠ¡å¤æ‚çš„å‰åç«¯ç³»ç»ŸåŠŸèƒ½ã€‚ç†Ÿæ‚‰flask ã€tornado ã€fastapiã€sanicç­‰python web æ¡†æ¶ï¼› ç†Ÿç»ƒæŒæ¡SaltStack/Ansibleç­‰è¿ç»´è‡ªåŠ¨åŒ–å·¥å…·ï¼Œé˜…è¯»è¿‡SaltStackçš„éƒ¨åˆ†æºç ï¼› ç†Ÿç»ƒæŒæ¡Git/Svnç­‰ç‰ˆæœ¬ç®¡ç†å·¥å…·å’Œå·¥ä½œæµç¨‹ï¼› ç†Ÿæ‚‰vue.jsç”Ÿæ€ï¼Œå¯å¼€å‘ä¸šåŠ¡å¤æ‚çš„å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼› ç†Ÿæ‚‰MySQL/PostgreSQLç­‰æ•°æ®åº“ï¼ŒRedis/Memcached/MongoDBç­‰NOSQLï¼› ç†Ÿæ‚‰Dockerã€K8Sã€Rancherç­‰å®¹å™¨æŠ€æœ¯ï¼› ç†Ÿæ‚‰Prometheusã€Grafanaç­‰ç”Ÿæ€ç»„ä»¶ï¼› ç†Ÿæ‚‰ELKã€KafKaç­‰å¤§æ•°æ®ç»„ä»¶ï¼› ç†Ÿæ‚‰LVS, Nginxç­‰4ã€7å±‚è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼› ç†Ÿæ‚‰TCP/IPï¼ŒHTTPï¼ŒRestfulç­‰äº’è”ç½‘ç›¸å…³æŠ€æœ¯æ ‡å‡†ï¼› ç†Ÿæ‚‰Linuxä¸‹çš„è‡ªåŠ¨åŒ–ç³»ç»Ÿè¿ç»´å’Œå¼€å‘çš„ç”Ÿæ€çŸ¥è¯†ï¼› ç†Ÿæ‚‰é˜¿é‡Œäº‘/è…¾è®¯äº‘/åä¸ºäº‘/å¾®åšå¼€æ”¾å¹³å°/å¾®ä¿¡å°ç¨‹åºï¼› äº†è§£äº’è”ç½‘äº§å“çš„ç”Ÿå‘½å‘¨æœŸå’Œå‘å±•è¿‡ç¨‹ã€å¼€å‘å›¢é˜Ÿç®¡ç†å’Œé¡¹ç›®ç®¡ç†ã€åº”ç”¨å‘å¸ƒå’Œç‰ˆæœ¬æ§åˆ¶ï¼Œå…·æœ‰è‰¯å¥½çš„æ–‡æ¡£èƒ½åŠ›ï¼› è‰¯å¥½çš„è‡ªæˆ‘é©±åŠ¨èƒ½åŠ›å’Œæ—¶é—´ç®¡ç†ï¼Œç§¯æå‚ä¸å¹¶è´¡çŒ®å¼€æºé¡¹ç›®ï¼› ç®¡ç†æ–¹é¢\nè§„åˆ’é¡¹ç›®é•¿æœŸç›®æ ‡å’ŒçŸ­æœŸç›®æ ‡ æŠ€æœ¯é€‰å‹ï¼Œæ–¹æ¡ˆè®¾è®¡ï¼Œæ¨¡å—å’ŒåŠŸèƒ½è®¾è®¡ å®šæœŸé¡¹ç›®æ€»ç»“ï¼Œå‘ä¸‹ç®¡ç†ï¼Œå‘ä¸Šæ±‡æŠ¥ å·¥ä½œç»å† è·å¾—åœºæ™¯è§†é¢‘ï¼ˆ 2021å¹´4æœˆ ~ ä»Š ï¼‰ å°±èŒè¿ç»´éƒ¨ï¼Œä»»è¿ç»´å¹³å°æ¶æ„å¸ˆï¼Œè´Ÿè´£ç»„ç»‡å¼€å‘å…¬å¸è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ã€DevOpsã€å®¹å™¨ç­‰å¹³å°æŠ€æœ¯çš„å¼€å‘è½åœ°å·¥ä½œã€‚\nè´Ÿè´£ç®¡ç†è¿ç»´å¼€å‘å›¢é˜Ÿï¼ˆ5äººï¼‰ï¼Œåˆ¶å®šå…¨å¹´OKRï¼Œè¿›è¡Œä»»åŠ¡è§„åˆ’ã€æ‹†åˆ†ï¼Œå¯¹ç»„å‘˜è¿›è¡Œç»©æ•ˆè€ƒæ ¸ã€‚\nä¸»è¦å‚ä¸é¡¹ç›®å¦‚ä¸‹ï¼š\né¡¹ç›®åç§° è§’è‰² æè¿° è‡ªåŠ¨åŒ–è¿ç»´å¹³å° å…¬å¸å¤§ä¸€ç»Ÿè¿ç»´å¹³å° åŒ…æ‹¬èµ„äº§ç®¡ç†ã€ä¸šåŠ¡ç»„ç»‡ç®¡ç†ã€CICDã€ç›‘æ§å‘Šè­¦ã€æ•°æ®åº“ç®¡ç†ã€å®¹å™¨ç®¡ç†ç­‰æ¨¡å— é‡ç‚¹é¡¹ç›® è‡ªåŠ¨åŒ–è¿ç»´å¹³å° å¹³å°å®šä½å…¬å¸çº§åˆ«çš„è‡ªåŠ¨åŒ–ITåŸºç¡€è®¾æ–½å¹³å°ï¼ŒåŒ…æ‹¬èµ„äº§ç®¡ç†ã€ç›‘æ§å‘Šè­¦ã€CICDã€æ•°æ®åº“ç®¡ç†ã€å®¹å™¨ç®¡ç†ç­‰æ¨¡å—ã€‚\nä½œä¸ºé¡¹ç›®æ¶æ„å¸ˆè´Ÿè´£äººï¼Œè§„åˆ’ç³»ç»Ÿå„æ¨¡å—çš„åŠŸèƒ½ï¼Œç»„ç»‡ç»„å‘˜é«˜æ•ˆçš„å®Œæˆè®¡åˆ’å†…çš„ä»»åŠ¡ã€‚\nèµ„äº§ç®¡ç†ï¼šåŸºäºæœåŠ¡æ ‘æ ‡ç­¾ï¼Œå¯¹å…¬å¸èµ„äº§è¿›è¡Œäº†å½’ç±»æ•´ç†ç»Ÿä¸€ç®¡ç†ï¼Œå¢åŠ äº†å¤šæºçš„è‡ªåŠ¨é‡‡é›†ã€‚ CICDï¼šä½¿ç”¨ ansible æ‰“é€šæœåŠ¡å™¨ç®¡ç†é€šé“ï¼ŒåŸºäºJenkins å’Œè‡ªç ”ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œæ‰“é€šåŒ…æ‹¬ä¸Šä¸‹çº¿æµé‡ã€å¼€å…³æŠ¥è­¦ã€å¥åº·ç›‘æµ‹ã€ç¼–è¯‘å‘å¸ƒåº”ç”¨çš„DevOpså…¨æµç¨‹ã€‚å°†å…¬å¸æ•´ä½“çš„ä¸Šçº¿æ—¶é—´ç”±å¤©ç¼©çŸ­åˆ°åˆ†é’Ÿçº§åˆ«ã€‚ ç›‘æ§å‘Šè­¦ï¼šåŸºäºOpenfalcon å’Œ Prometheusåšçš„äºŒæ¬¡å¼€å‘ï¼Œå®ç°äº†åŸºç¡€ã€ä¸šåŠ¡ã€å®¹å™¨çš„ç›‘æ§å‘Šè­¦ç»Ÿä¸€ç®¡ç†ã€‚åŒ…æ‹¬äº‘å’Œè‡ªå»ºæœºæˆ¿çš„æœåŠ¡å™¨ã€äº¤æ¢æœºç­‰åŸºç¡€ç›‘æ§æŠ¥è­¦ï¼Œä¸šåŠ¡è¿›ç¨‹ã€ç«¯å£å’Œè‡ªå®šä¹‰çš„ä¸šåŠ¡ç›‘æ§ï¼Œä»¥åŠå®¹å™¨å¹³å°çš„å„ç§å®¹å™¨ã€podã€nodeç­‰å®¹å™¨ç›‘æ§ã€‚å‘Šè­¦æœºåˆ¶ä¸°å¯Œå¯åˆ†ç»„ï¼Œå¯å‡çº§ï¼Œå®ç°äº†å‘Šè­¦æŠ‘åˆ¶ã€åˆå¹¶ã€é™é»˜ã€å¿½ç•¥ç­‰ç‰¹æ®Šå¤„ç†ã€‚ æ•°æ®åº“ç®¡ç†ï¼šå¯¹äº‘å’Œè‡ªå»ºæ•°æ®åº“åšäº†å®ä¾‹å’Œåº“çš„è‡ªåŠ¨é‡‡é›†ï¼Œåˆ©ç”¨å¼€æºçš„ Yearning å®ç°äº†æ•°æ®çš„è‡ªä¸»ç®¡ç†ã€‚ å®¹å™¨å¹³å°ï¼šè‡ªå»ºäº† K8S å®¹å™¨å¹³å°ï¼Œä½¿ç”¨ Rancher å¼€æºå·¥å…·è¿›è¡Œè‡ªä¸»åŒ–ç®¡ç†ï¼Œä½¿ç”¨Prometheusç›‘æ§ç”Ÿæ€é‡‡é›†å®¹å™¨ç›¸å…³ç›‘æ§æŒ‡æ ‡å’Œè‡ªå»ºç›‘æ§ç»“åˆç»Ÿä¸€æŠ¥è­¦ç®¡ç†ï¼ŒåŸºäºJenkins Pipline å®ç°å®¹å™¨çš„è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒå’Œå›æ»šã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Djangoã€vue.jsã€mysqlã€redisã€Dockerã€Kubernetesã€Rancherã€Prometheusã€Jenkins\næ–°æµªå¾®åš ï¼ˆ 2018å¹´4æœˆ ~ 2021å¹´3æœˆ ï¼‰ å°±èŒæ–°æµªå¾®åšSREå›¢é˜Ÿï¼Œä¸»è¦è´Ÿè´£è‡ªåŠ¨åŒ–è¿ç»´å¹³å°çš„ç ”å‘å·¥ä½œå’Œè§†é¢‘é€šè®¯ç­‰ä¸šåŠ¡çº¿çš„è¿ç»´å·¥ä½œã€‚ä¸»è¦å‚ä¸é¡¹ç›®å¦‚ä¸‹ï¼š\né¡¹ç›®åç§° è§’è‰² æè¿° å¾®åšè‡ªåŠ¨åŒ–è¿ç»´å¹³å° è¿ç»´åº•å±‚ç®¡ç†é€šé“ è¿ç»´ä¾§çš„ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬èµ„äº§ç®¡ç†ã€CICDã€ç›‘æ§æŠ¥è­¦ç­‰ï¼Œä¸ºä¸Šå±‚æœåŠ¡æä¾›åº•å±‚é€šé“ é…ç½®ç®¡ç†ç³»ç»Ÿ é…ç½®æ–‡ä»¶å’Œè„šæœ¬çš„ç®¡ç†ç³»ç»Ÿ ä¸»è¦ä¸ºæ‰‹åŠ¨å’Œè‡ªåŠ¨ç®¡ç†è„šæœ¬å’Œ7å±‚LBé…ç½®ï¼Œæä¾›ç³»ç»ŸåŠŸèƒ½æœåŠ¡ ä¸šåŠ¡ä¿éšœç³»ç»Ÿ ä¸šåŠ¡ä¾§çš„è‡ªåŠ¨åŒ–å¹³å° åŒ…æ‹¬èµ„äº§ç®¡ç†ã€åˆ©ç”¨ç‡ç®¡ç†ã€CICDçš„ä¸Šå±‚å°è£…è°ƒç”¨ æ—¥å¿—å­˜å‚¨ç³»ç»Ÿ æ—¥å¿—çº§åˆ«æ’éšœç®¡ç† æ”¶é›†ä¿å­˜äº†ä¸šåŠ¡ä»7å±‚åˆ°ä¸Šä¼ æœåŠ¡çš„é“¾è·¯æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ ä¸šåŠ¡æ—¥å¸¸ä¿éšœ æ—¥å¸¸ä¿éšœ ä¸šåŠ¡æŠ¥è­¦å¤„ç†å’Œæ–°ä¸šåŠ¡æ¥å…¥è‡ªåŠ¨åŒ–è¿ç»´ä½“ç³» é‡ç‚¹é¡¹ç›® å¾®åšè‡ªåŠ¨åŒ–è¿ç»´å¹³å°é¡¹ç›® ã€Œå¾®åšè‡ªåŠ¨åŒ–è¿ç»´å¹³å°é¡¹ç›®ã€ä½œä¸ºå¾®åšç ”å‘å¹³å°çš„åº•å±‚è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ï¼Œæä¾›äº†ä¸Šçº¿å‘å¸ƒã€ç›‘æ§é¢„è­¦ã€ä»»åŠ¡å¤„ç†ã€æµé‡åˆ‡æ¢ã€è‡ªåŠ¨æ‰©ç¼©å®¹å’ŒæœåŠ¡ç®¡ç†ç­‰åŠŸèƒ½ã€‚å…¶é—´åšäº†å¦‚ä¸‹é‡ç‚¹å·¥ä½œï¼š\nä½œä¸ºä¸»ç¨‹å‚ä¸å¼€å‘äº†ç³»ç»Ÿçš„DNSè§£æåˆ‡æ¢åŠŸèƒ½æ¨¡å—ã€‚é’ˆå¯¹è€ç‰ˆæœ¬çš„åŸŸååˆ‡æ¢åšäº†ç”¨æˆ·ä½“éªŒçš„ä¼˜åŒ–ï¼Œç¼©çŸ­äº†æ“ä½œè·¯å¾„ï¼Œæé«˜äº†æ“ä½œæ•ˆç‡ã€‚ ä½œä¸ºä¸»ç¨‹ä¸ºè¯¥é¡¹ç›®é¦–æ¬¡å¼•å…¥vue.jsæ¡†æ¶ï¼Œæ­å»ºäº†ç§»åŠ¨ç«¯çš„å¼€å‘è„šæ‰‹æ¶ï¼Œå¹¶å®Œæˆäº†è¯¥ç³»ç»Ÿç›‘æ§é¢„è­¦ã€ä¸Šçº¿å‘å¸ƒå’Œæµé‡åˆ‡æ¢ç­‰æ¨¡å—çš„ç§»åŠ¨ç«¯çš„å¼€å‘ã€‚ æ¨åŠ¨ä¸šåŠ¡äº§å“çº¿æ¥å…¥è¿ç»´ç³»ç»Ÿï¼ŒåŒ…æ‹¬JavaæŠ€æœ¯æ ˆã€GolangæŠ€æœ¯æ ˆã€PythonæŠ€æœ¯æ ˆçš„å·¥ç¨‹é¡¹ç›®çš„æ¥å…¥ï¼Œç¼–å†™æ¥å…¥ç³»ç»Ÿæµç¨‹éœ€è¦çš„å„ç§ä»»åŠ¡å¤„ç†è„šæœ¬ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šGolangã€Pythonã€vue.jsã€mysqlã€redisã€shellã€Dockerã€Graphitã€Grafanaã€ELKã€Search Guardã€K8Sã€kafka\nå¾®åšä¸šåŠ¡ä¿éšœç³»ç»Ÿ è¯¥ç³»ç»Ÿé¢å‘ä¸šåŠ¡äººå‘˜ï¼Œå°†è‡ªåŠ¨åŒ–ç³»ç»Ÿåšè¿›ä¸€æ­¥çš„åŒ…è£…ï¼Œå®ç°RBACçš„æƒé™æ§åˆ¶æ¨¡å‹ï¼Œå°†è¿ç»´ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ç›´æ¥å¼€å‘ç»™ä¸šåŠ¡çº¿ã€‚æœŸé—´ä¸»è¦åšäº†å¦‚ä¸‹å·¥ä½œï¼š\næ­å»ºå¼€å‘è„šæ‰‹æ¶ï¼Œå‰ç«¯ä½¿ç”¨Vueç”Ÿæ€æ­å»ºï¼Œåç«¯ä½¿ç”¨Beegoå®ç°ã€‚ ç‹¬ç«‹å®ç°äº†RBACæ¨¡å‹çš„æƒé™æ§åˆ¶ï¼Œå®ç°èœå•åŸºäºè§’è‰²çš„åŠ¨æ€åŠ è½½ã€‚ å®ç°CMDBã€ä»£ç å‘å¸ƒå’Œç›‘æ§æŠ¥è­¦æŸ¥çœ‹çš„åŠŸèƒ½æ¨¡å—çš„ç§»åŠ¨åŒ–å‰ç«¯å®ç°ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šGolangã€vue.jsã€mysqlã€redisã€Dockerã€Beego\næ—¥å¿—æ”¶é›†ç®¡ç†ç³»ç»Ÿ è¯¥ç³»ç»ŸåŸºäºELKæŠ€æœ¯æ ˆï¼Œå®ç°äº†Nginxã€ATSç­‰ä¸­é—´ä»¶çš„æ—¥å¿—çš„æ”¶é›†å’Œå­˜å‚¨ï¼Œæ–¹ä¾¿äº†é—®é¢˜æ’æŸ¥ï¼Œä¸ºåæœŸçš„å‘Šè­¦è®¡ç®—æä¾›äº†æ•°æ®æºã€‚16å°è®¾å¤‡ç»„æˆçš„ESé›†ç¾¤ï¼Œæ—¥æ”¶é›†æ—¥å¿—é‡åœ¨2.6Tï¼Œæ¯5sçš„å…¥åº“æ•°æ®é‡åœ¨3Wå·¦å³ã€‚æœŸé—´ä¸»è¦åšäº†å¦‚ä¸‹å·¥ä½œï¼š\nåŸºäºELKç‹¬ç«‹æ­å»ºäº†æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼Œä½¿ç”¨ELKç”Ÿæ€ä¸­çš„Eå’ŒKä½œä¸ºå­˜å‚¨å’Œå±•ç¤ºç»„ä»¶ã€‚ ä¸ºå‡å°‘èµ„æºæ¶ˆè€—ï¼Œä½¿ç”¨Pythonå¼€å‘äº†æ—¥å¿—çš„æ¨é€ç«¯ç»„ä»¶ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šELKã€Pythonã€Kafka\næ±½è½¦ä¹‹å®¶ ( 2015å¹´6æœˆ ~ 2018å¹´4æœˆ) å°±èŒåŸºç¡€å¹³å°è¿ç»´å¼€å‘å›¢é˜Ÿï¼Œä¸»è¦ä»äº‹è¿ç»´è‡ªåŠ¨åŒ–å¹³å°çš„ç ”å‘å·¥ä½œã€‚ä¸»è¦å‚ä¸é¡¹ç›®å¦‚ä¸‹ï¼š\né¡¹ç›®åç§° è§’è‰² æè¿° èµ„äº§ç®¡ç†ç³»ç»Ÿ åº•å±‚æ•°æ®é“¶è¡Œ å¯¹æœ‰å½¢å’Œæ— å½¢èµ„äº§å®ç°æ•ˆç‡ç®¡ç†ï¼Œä¸ºä¸Šå±‚æœåŠ¡æä¾›æ•°æ®ä¿éšœ é…ç½®ç®¡ç† ä¸­é—´ä»¶å±‚è‡ªåŠ¨åŒ– å®ç°ä¸­é—´ä»¶çš„è‡ªåŠ¨åŒ–å®‰è£…å’Œé…ç½® å‘å¸ƒç³»ç»Ÿ CICD å®ç°ä¸šåŠ¡ä»£ç çš„æµç¨‹åŒ–å‘å¸ƒ ç›‘æ§ç³»ç»Ÿ ä¿éšœä¾æ® å®ç°å¯¹åŸºç¡€è®¾æ–½å’Œä¸šåŠ¡æœåŠ¡çš„ç›‘æ§æ•°æ®é‡‡é›†å’Œä¿éšœ Saltæ”¹é€  åº•å±‚é€šé“ ä¿éšœäº†åº•å±‚é€šé“çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ è¿ç»´ç»Ÿä¸€å¹³å°é¡¹ç›® å…¥å£é—¨æˆ· ç»Ÿä¸€å„è¿ç»´ç³»ç»Ÿè®¤è¯æˆæƒ é‡ç‚¹é¡¹ç›® èµ„äº§ç®¡ç†ç³»ç»Ÿé¡¹ç›® æœ¬ç³»ç»Ÿä½œä¸ºå…¬å¸æƒå¨çš„èµ„äº§ç®¡ç†ä¸­å¿ƒ(åŒ…æ‹¬æœ‰å½¢èµ„äº§å’Œæ— å½¢èµ„äº§), åˆ©ç”¨å·¥ä½œæµå·¥å…·ç»´æŠ¤æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä»¥æ•°æ®æ¥è§£è¯»è¿ç»´å¹³æ—¶å·¥ä½œä¸­ä½“ç°çš„ä¸šåŠ¡æ€ç»´ã€‚æœŸé—´ä¸»è¦ä»äº‹å¦‚ä¸‹å·¥ä½œï¼š\nä½œä¸ºé¡¹ç›®è´Ÿè´£äººï¼Œå‚ä¸äº†é¡¹ç›®çš„æ”¹ç‰ˆï¼Œä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒï¼Œæé«˜äº†æ•°æ®çš„å‡†ç¡®æ€§ï¼Œæ•°æ®å‡†ç¡®æ€§åŸºæœ¬ä¿è¯åœ¨99%ï¼Œå¢å¤§äº†èµ„äº§æ•°æ®çš„è¦†ç›–ç‡ã€‚ ä¼˜åŒ–äº†å‰ç«¯é¡µé¢å’Œåç«¯è¡¨ç»“æ„ï¼Œæé«˜å‰ç«¯æŸ¥è¯¢å’Œå±•ç¤ºé€Ÿåº¦ã€‚ å¢åŠ äº†æ•°æ®å˜æ›´å­—æ®µçº§åˆ«çš„è®°å½•ï¼Œä¾¿äºè¿½æº¯å’Œå®¡è®¡ã€‚ è¡¥å……å¢åŠ äº†è™šæ‹Ÿèµ„äº§ã€ŒIPæ± ã€çš„ç®¡ç†ã€‚ æ„å»ºäº†ä¸€æ•´å¥—ï¼ŒåŸºäºå¯¹ç§°åŠ å¯†çš„API ä½“ç³»å¹³å°ï¼Œæ–¹ä¾¿ä¸Šå±‚ç³»ç»Ÿè°ƒç”¨ã€‚ ä¸ºä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬å¼€å‘åˆ¶å®šäº†ä»¥â€œç›˜â€ã€â€œå®¡â€ã€â€œç½šâ€ä¸ºæ ¸å¿ƒçš„è‡ªæˆ‘å®¡è®¡æ–¹æ¡ˆã€‚é€šè¿‡ç³»ç»Ÿè‡ªæŸ¥åŠ è§„ç« åˆ¶åº¦çš„æ–¹å¼ï¼Œå¤§å¤§æé«˜äº†æ•°æ®çš„å‡†ç¡®ç‡ã€‚è¯¦æƒ…å¯ä»¥è§å½“æ—¶æ€»ç»“åˆ†äº«çš„æ–‡ç« èŠèŠCMDBçš„èµ„äº§å®¡è®¡ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Djangoã€vue.jsã€Mysqlã€Celeryã€Redisã€Puppet\nåŸºäºSaltStackçš„åº•å±‚æ¶æ„æ‰©å±• åœ¨è¿ç»´è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¸€ä¸ªæ‰¹é‡æœºå™¨çš„ç®¡ç†å·¥å…·ã€‚ç»è¿‡è°ƒç ”ï¼ŒåŒæ—¶ç»“åˆæˆ‘ä»¬å›¢é˜Ÿè‡ªèº«çš„æŠ€æœ¯æ ˆï¼Œé€‰æ‹©äº†SaltStackã€‚ä½†æ˜¯å®ƒä¸Šå±‚çš„APIæ¥å£ï¼Œå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚æˆ‘ä»¬æ ¹æ®è‡ªèº«éœ€æ±‚ï¼Œå¯¹å®ƒåšäº†æ”¹é€ ï¼š\nå°è£…å…¶Restfull APIï¼Œä½¿å…¶å¯ä»¥æ¨ªå‘æ‰©å±•è€Œä¸ä¾èµ–Salt-Master; å¢åŠ Saltå‘½ä»¤ä¸‹å‘åŠæ¨¡å—æ‰§è¡Œçš„å®¡è®¡åŠŸèƒ½ï¼› å¢åŠ Saltçš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥æ ¹æ®Salt-MinionèŒƒå›´åŠæ‰§è¡Œæ¨¡å—åšæƒé™åˆ’åˆ†ï¼› é€šè¿‡å¯¹SaltStackçš„æ”¹é€ ï¼Œå¤¯å®äº†æ•´ä¸ªè‡ªåŠ¨åŒ–æ“ä½œçš„åº•å±‚é€šé“åŸºç¡€ï¼Œä½¿ä¸Šå±‚saasçš„è‡ªåŠ¨åŒ–å¤„ç†æ›´åŠ ç¨³å®šã€å®‰å…¨ã€‚åœ¨è¯¥é¡¹ç›®æœŸé—´ï¼Œä¸»è¦åšäº†å¦‚ä¸‹é‡ç‚¹å·¥ä½œï¼š\nå¼€å‘äº†ä¸Šå±‚çš„APIæœåŠ¡ç»„ä»¶ï¼Œæä¾›äº†å’Œå¤–éƒ¨æœåŠ¡äº¤äº’çš„APIï¼Œæ”¯æŒå‘½ä»¤å®¡è®¡åŠŸèƒ½ã€ç”¨æˆ·æƒé™åŠŸèƒ½ç­‰åŠŸèƒ½ã€‚ ä¼˜åŒ–æ•´ä½“æ¶æ„å’ŒAPIæœåŠ¡ï¼Œä½¿å•å°æœºå™¨çš„QPSç”±200æå‡åˆ°1000+ï¼Œè¯¦ç»†å¯å‚è€ƒå½“æ—¶æ€»ç»“åˆ†æçš„æ–‡ç« è®°ä¸€æ¬¡Tornado QPSä¼˜åŒ–ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Tornadoã€Mysqlã€Redisã€SQLAchemyã€Rabbitmqã€SaltStack\né…ç½®ç®¡ç†ç³»ç»Ÿé¡¹ç›® è¯¥é¡¹ç›®ä¸»è¦è´Ÿè´£åŸºç¡€æ¶æ„çš„å„ä¸­é—´ä»¶çš„è‡ªåŠ¨å®‰è£…å’Œé…ç½®ï¼ŒåŒ…æ‹¬Tomcatã€IISã€Squidç­‰ã€‚æœŸé—´ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š\næ„å»ºå‰ç«¯æ¶æ„è„šæ‰‹æ¶ã€‚ å‰ç«¯webç«¯ä½ çš„è®¾è®¡ã€å¼€å‘å’Œæµ‹è¯•ã€‚ åŸºäºSaltStackçš„æ¨¡å—çš„è‡ªåŠ¨åŒ–å®‰è£…ä¸‹å‘é€»è¾‘æ„å»ºã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Djangoã€Mysqlã€Redisã€SaltStack\nè¿ç»´ç»Ÿä¸€å¹³å°é¡¹ç›® è¯¥é¡¹ç›®ä½œä¸ºå„è¿ç»´å¹³å°çš„ç»Ÿä¸€å…¥å£ï¼Œå’Œå¤–ç•Œäº¤äº’çš„ç½‘å…³ç³»ç»Ÿã€‚è¯¥é¡¹ç›®ä¸­ï¼Œä¸»è¦å‚ä¸é‡ç‚¹å·¥ä½œå¦‚ä¸‹ï¼š\nå’Œå„ä¸šåŠ¡æ–¹è®¨è®ºç¡®è®¤äº†èµ„æºç”Ÿå‘½å‘¨æœŸçš„å„æµç¨‹ï¼ŒåŒ…æ‹¬ä¸Šæ¶ã€ä¸Šçº¿ã€å˜æ›´ã€ä¸‹çº¿ã€é€€åº“æµç¨‹ç»†èŠ‚ã€‚ åŸºäºæµç¨‹ï¼Œå‚ä¸äº†å„é˜¶æ®µçš„API æ¥å£å¯¹æ¥ã€è®¾è®¡å’Œå¼€å‘ã€‚ æŒ‰ç…§ç»Ÿä¸€å¹³å°é¡¹ç›®å‰ç«¯è„šæ‰‹æ¶ï¼Œç»Ÿä¸€æ”¹ç‰ˆäº†éœ€è¦æ¥å…¥çš„ç³»ç»Ÿé¡µé¢ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Djangoã€Mysqlã€Vue.js\nå±±ä¸œå°šæ·ç§‘æŠ€ ( 2012å¹´7æœˆ ~ 2015å¹´6æœˆ) æœŸé—´ä¸»è¦ä½œä¸ºPythonç ”å‘ï¼Œä¸»è¦åšäº†å¦‚ä¸‹é‡ç‚¹å·¥ä½œï¼š\nä½œä¸ºç ”å‘å‚ä¸äº†å¤šå®¶é“¶è¡Œçš„æ•°æ®ç»è¥è€ƒæ ¸ç³»ç»Ÿã€‚ ä½œä¸ºé¡¹ç›®ç»„é•¿ï¼Œè´Ÿè´£æŸé“¶è¡Œçš„ä¿¡ç”¨å¡è¿›ä»¶ç®¡ç†ç³»ç»Ÿçš„éœ€æ±‚æ´½è°ˆã€æ–‡æ¡£çš„ç¼–å†™ã€ç³»ç»Ÿçš„è®¾è®¡åŠå¼€å‘ã€‚ ä¸»è¦æŠ€æœ¯æˆ–è½¯ä»¶å…³é”®å­—ï¼šPythonã€Djangoã€PostgreSQLã€Rabbitmqã€HTML/CSSã€Jquery\nå¼€æºé¡¹ç›® Django-mdeditorï¼šåŸºäºeditor.mdçš„Django-appç»„ä»¶ï¼Œstar 300+ã€‚ PythonåŸºç¡€æ•™ç¨‹ï¼šæ ¹æ®è‡ªå·±å·¥ä½œå­¦ä¹ ç»éªŒæ€»ç»“çš„Pythonå…¥é—¨æ•™ç¨‹ã€‚ æŠ€æœ¯æ–‡ç«  pipenv è¯•ç”¨è¿‡ç¨‹åˆ†æ vagrant å¼€å‘ç¯å¢ƒæ­å»º æˆ‘å¿ƒç›®ä¸­Tornadoæœ€ä½³å®è·µ SQLAlchemy æ•°æ®åº“é“¾æ¥æ± é—®é¢˜æ’æŸ¥è®°å½• Django3.0å¼‚æ­¥ä½¿ç”¨åˆ†äº« è°ˆè°ˆå‰åç«¯åˆ†ç¦»å’Œè®¤è¯é—®é¢˜ è‡´è°¢ æ„Ÿè°¢æ‚¨èŠ±æ—¶é—´é˜…è¯»æˆ‘çš„ç®€å†ï¼ŒæœŸå¾…èƒ½æœ‰æœºä¼šå’Œæ‚¨å…±äº‹ã€‚\n","date":"0001å¹´01æœˆ01æ—¥","permalink":"/resume/","summary":"ä¸ªäººä¿¡æ¯ å´ç§€æ°‘/ç”·/1988 æœ¬ç§‘/ä¸´æ²‚å¤§å­¦/è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ å·¥ä½œå¹´é™ï¼š9å¹´ æŠ€æœ¯åšå®¢ï¼šhttps://pylixm.cc/ Githubï¼šhttps://github.","title":"ç®€å†"}]