

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" href="/img/icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="void">
  <meta name="keywords" content="">
  
    <meta name="description" content="环境主机系统为 win11，通过 vmware 创建了 3 台虚拟机，详情如下：    hostname os ip cpu mem disk    k8s-master Ubuntu 22.04.2 LTS 192.168.223.128 4c 8g 50g   k8s-worker1 Ubuntu 22.04.2 LTS 192.168.223.129 4c 8g 50g   k8s-work">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 二进制安装">
<meta property="og:url" content="https://autsu.github.io/2023/04/13/k8s-binray-install/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="环境主机系统为 win11，通过 vmware 创建了 3 台虚拟机，详情如下：    hostname os ip cpu mem disk    k8s-master Ubuntu 22.04.2 LTS 192.168.223.128 4c 8g 50g   k8s-worker1 Ubuntu 22.04.2 LTS 192.168.223.129 4c 8g 50g   k8s-work">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-04-13T06:05:14.000Z">
<meta property="article:modified_time" content="2023-04-16T12:41:02.363Z">
<meta property="article:author" content="void">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>K8s 二进制安装 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"autsu.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":3},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":"G-80J26VFWFL","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"6KXGn05vaODkTMKM7zd5lWwl-gzGzoHsz","app_key":"qIMQwH4WrxTe8ds3Ua4HAbet","server_url":"https://6kxgn05v.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'G-80J26VFWFL', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>/dev/null</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="K8s 二进制安装"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-13 14:05" pubdate>
          2023年4月13日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          40k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          330 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">K8s 二进制安装</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>主机系统为 win11，通过 vmware 创建了 3 台虚拟机，详情如下：</p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>os</th>
<th>ip</th>
<th>cpu</th>
<th>mem</th>
<th>disk</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.128</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
<tr>
<td>k8s-worker1</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.129</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
<tr>
<td>k8s-worker2</td>
<td>Ubuntu 22.04.2 LTS</td>
<td>192.168.223.130</td>
<td>4c</td>
<td>8g</td>
<td>50g</td>
</tr>
</tbody></table>
<h1 id="基础环境准备"><a href="#基础环境准备" class="headerlink" title="基础环境准备"></a>基础环境准备</h1><h2 id="配置-hosts"><a href="#配置-hosts" class="headerlink" title="配置 hosts"></a>配置 hosts</h2><p>在 3 台主机的 &#x2F;etc&#x2F;hosts 文件中加入以下内容：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.168.223.128</span> k8s-master<br><span class="hljs-number">192.168.223.129</span> k8s-worker1<br><span class="hljs-number">192.168.223.130</span> k8s-worker2<br></code></pre></td></tr></table></figure>

<h2 id="配置免密登录"><a href="#配置免密登录" class="headerlink" title="配置免密登录"></a>配置免密登录</h2><p>首先在每台机器上执行下面的命令来生成 ssh 秘钥，直接回车到底：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh-keygen -t rsa</span><br></code></pre></td></tr></table></figure>

<p>继续执行 <code>ssh-copy-id -i .ssh/id_rsa.pub &lt;hostname&gt;</code> 命令，其中 hostname 填写 <strong>另外两台主机的主机名</strong>，这里以 <code>k8s-worker1</code> 为例。 按照提示输入 yes，最后输入目标主机的密码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh-copy-id -i .ssh/id_rsa.pub k8s-worker1</span><br></code></pre></td></tr></table></figure>

<p>输入密码后，如果提示下面内容，说明配置免密成功，执行 <code>ssh &#39;k8s-worker1&#39;</code>，发现无需输入密码即可直接 ssh 到目标主机。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">Number of key(s) added: 1<br><br>Now try logging into the machine, with:   &quot;ssh &#x27;k8s-worker1&#x27;&quot;<br>and check to make sure that only the key(s) you wanted were added.<br></code></pre></td></tr></table></figure>

<p>按照上面的流程对每台主机执行相同操作，完成 3 台主机相互之间的免密登录，这里不再赘述。</p>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><p>在每台主机上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">disable</span> --now ufw</span><br></code></pre></td></tr></table></figure>

<p>查看效果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ufw status</span><br>Status: inactive<br></code></pre></td></tr></table></figure>

<h2 id="关闭交换分区"><a href="#关闭交换分区" class="headerlink" title="关闭交换分区"></a>关闭交换分区</h2><p>执行下面的命令关闭 swap：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab<br>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0<br></code></pre></td></tr></table></figure>

<p>查看效果，Swap 这栏的 total 为 0，表示关闭成功。上面的命令会永久禁用 Swap，即使重启后也会生效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">free -h</span><br>               total        used        free      shared  buff/cache   available<br>Mem:           7.7Gi       415Mi       6.5Gi       1.0Mi       851Mi       7.1Gi<br>Swap:             0B          0B          0B<br></code></pre></td></tr></table></figure>

<blockquote>
<p>🤔️ 为什么安装 k8s 要需要关闭 Swap？</p>
<p>在安装 Kubernetes 集群时，需要关闭 swap。原因是 Kubernetes 通过 cgroup 来对容器进行资源限制，而 cgroup 只能控制实际内存，无法控制 swap，因此开启 swap 后可能会导致资源不受限制，进而导致容器运行不稳定或者宕机。因此关闭 swap 可以提高 Kubernetes 集群的稳定性和安全性。</p>
</blockquote>
<h2 id="设置时间同步"><a href="#设置时间同步" class="headerlink" title="设置时间同步"></a>设置时间同步</h2><p>在所有主机上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">打开终端输入以下命令安装ntpdate工具。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt install ntpdate</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">再输入命令设置系统时间与网络时间同步。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">ntpdate cn.pool.ntp.org</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">最后输入命令将时间更新到硬件上即可。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hwclock --systohc</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>🤔️ 安装 k8s 为什么需要设置时间同步？</p>
<p>在 Kubernetes 集群中，各个节点之间需要进行协调和通信，如果各个节点的时间不同步，将会导致一些问题，例如：</p>
<ol>
<li>证书问题：Kubernetes 使用 TLS 证书进行节点间的认证和通信，如果各个节点的时间不同步，可能导致证书过期或者无法验证等问题。</li>
<li>日志问题：各个节点的日志需要进行时间戳的记录，如果各个节点的时间不同步，可能导致日志顺序错乱或者无法定位问题。</li>
</ol>
<p>因此，在安装 Kubernetes 时需要设置时间同步，保证各个节点之间的时间是一致的，从而避免出现以上问题。</p>
</blockquote>
<h2 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a><del>安装 Docker</del></h2><p><del>因为我在安装 Ubuntu 时勾选了 Docker，所以系统已经默认安装好了 Docker。</del></p>
<h2 id="所有节点安装-Containerd"><a href="#所有节点安装-Containerd" class="headerlink" title="所有节点安装 Containerd"></a>所有节点安装 Containerd</h2><p>在所有节点执行，master 节点和 worker 节点都需要</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建 cni 插件所需目录</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /etc/cni/net.d /opt/cni/bin</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">解压 cni 二进制包</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar xf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -C / -xzf cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建服务启动文件</span><br>cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF<br>[Unit]<br>Description=containerd container runtime<br>Documentation=https://containerd.io<br>After=network.target local-fs.target<br>[Service]<br>ExecStartPre=-/sbin/modprobe overlay<br>ExecStart=/usr/local/bin/containerd<br>Type=notify<br>Delegate=yes<br>KillMode=process<br>Restart=always<br>RestartSec=5<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>LimitNOFILE=infinity<br>TasksMax=infinity<br>OOMScoreAdjust=-999<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>

<p>配置 Containerd 所需的模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf<br>overlay<br>br_netfilter<br>EOF<br></code></pre></td></tr></table></figure>

<p>加载模块，设置开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart systemd-modules-load.service</span><br></code></pre></td></tr></table></figure>

<p>配置Containerd所需的内核</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf<br>net.bridge.bridge-nf-call-iptables  = 1<br>net.ipv4.ip_forward                 = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">加载内核</span> <br>sysctl --system<br></code></pre></td></tr></table></figure>

<p>创建 Containerd 的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建配置文件</span><br>mkdir -p /etc/containerd<br>containerd config default | tee /etc/containerd/config.toml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改 Containerd 的配置文件</span><br>sed -i &quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot; /etc/containerd/config.toml<br><br>cat /etc/containerd/config.toml | grep SystemdCgroup<br><br>sed -i &quot;s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/abcdocker#g&quot; /etc/containerd/config.toml<br><br>cat /etc/containerd/config.toml | grep sandbox_image<br></code></pre></td></tr></table></figure>

<p>手动删除 <code>/etc/containerd/config.toml</code> 中的 <code>systemd_cgroup = false</code> 这一行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/containerd/config.toml<br></code></pre></td></tr></table></figure>

<p>设置开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable --now containerd<br></code></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ctr version</span><br>Client:<br>  Version:  v1.6.4<br>  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16<br>  Go version: go1.17.9<br>Server:<br>  Version:  v1.6.4<br>  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16<br>  UUID: f3171aee-67b0-4e01-871b-2e93674af2ad<br></code></pre></td></tr></table></figure>





<h1 id="k8s-环境部署"><a href="#k8s-环境部署" class="headerlink" title="k8s 环境部署"></a>k8s 环境部署</h1><h2 id="下载相关二进制文件"><a href="#下载相关二进制文件" class="headerlink" title="下载相关二进制文件"></a>下载相关二进制文件</h2><p>在 master 节点执行下面的命令，下载 k8s 相关的可执行文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://dl.k8s.io/v1.24.3/kubernetes-server-linux-amd64.tar.gz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz</span><br></code></pre></td></tr></table></figure>

<p>解压获得可执行文件，将解压到 <code>/usr/local/bin</code> 目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;<span class="hljs-built_in">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf etcd-v3.5.4-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.4-linux-amd64/etcd&#123;,ctl&#125;</span><br></code></pre></td></tr></table></figure>

<p>检查<code>/usr/local/bin</code>下内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /usr/local/bin/</span><br>cfssl      etcd     kube-apiserver           kubectl  kube-proxy<br>cfssljson  etcdctl  kube-controller-manager  kubelet  kube-scheduler<br></code></pre></td></tr></table></figure>

<p>验证二进制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubelet --version</span><br>Kubernetes v1.24.3<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl version</span><br>etcdctl version: 3.5.4<br>API version: 3.5<br></code></pre></td></tr></table></figure>

<p>将刚刚解压的二进制文件拷贝到其它节点上（另外两个节点都是计算节点，所以其实不用拷贝 etcd 相关的可执行文件，但是 kubectl 什么的还是需要的，所以影响不大）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">for i in k8s-worker1 k8s-worker2;do   <br>	scp /usr/local/bin/kube* root@$i:/usr/local/bin/    <br>	scp /usr/local/bin/&#123;etcd,etcdctl&#125;   root@$i:/usr/local/bin/<br>done<br></code></pre></td></tr></table></figure>



<h2 id="准备一个目录用来存放证书配置文件"><a href="#准备一个目录用来存放证书配置文件" class="headerlink" title="准备一个目录用来存放证书配置文件"></a>准备一个目录用来存放证书配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> pki</span><br></code></pre></td></tr></table></figure>



<h2 id="下载配置-cfssl-证书"><a href="#下载配置-cfssl-证书" class="headerlink" title="下载配置 cfssl 证书"></a>下载配置 cfssl 证书</h2><blockquote>
<p>⚠️ 只需在控制节点 k8s-master 上执行</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget <span class="hljs-string">&quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64&quot;</span> -O /usr/local/bin/cfssl</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget <span class="hljs-string">&quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64&quot;</span> -O /usr/local/bin/cfssljson</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br></code></pre></td></tr></table></figure>

<h2 id="创建证书配置文件"><a href="#创建证书配置文件" class="headerlink" title="创建证书配置文件"></a>创建证书配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> pki</span><br></code></pre></td></tr></table></figure>

<p>下面这段 shell 是用来创建一个 admin 用户的证书签发请求文件 <code>admin-csr.json</code>，其中包含了以下信息：</p>
<ul>
<li><code>CN</code>：Common Name，即证书的名称，这里是 <code>admin</code>。</li>
<li><code>key</code>：用于指定生成密钥的算法及长度，这里是 <code>rsa</code> 算法，长度是 <code>2048</code> 位。</li>
<li><code>names</code>：用于指定证书中的主题（Subject）信息，包括国家（C）、省（ST）、城市（L）、组织（O）和组织单位（OU），这里主要指定了组织为 <code>system:masters</code>，也就是 Kubernetes 的管理员。</li>
</ul>
<p>该证书用于验证用户 <code>admin</code> 对 Kubernetes API Server 的访问权限，由 Kubernetes 的证书管理工具 <code>cfssl</code> 根据此文件生成证书。</p>
<p>（以上内容来自 ChatGPT。。。）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &gt; admin-csr.json &lt;&lt; <span class="hljs-string">EOF</span></span> <br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<p>下面这段 shell 是定义 CA 的配置文件，主要包含两个部分，”signing” 和 “profiles”。</p>
<p>其中，”signing” 部分定义了默认的证书过期时间，这里设置为 876000 小时，也就是 100 年。这个时间可以根据实际情况进行调整。</p>
<p>“profiles” 部分定义了不同 profile 的配置信息。这里只定义了一个叫做 “kubernetes” 的 profile，该 profile 的用途包括 “signing”、”key encipherment”、”server auth” 和 “client auth”，也就是该 profile 适用于用于签发和验证服务器和客户端证书，同时也能用于加密传输数据。该 profile 的证书过期时间也设置为 876000 小时，与默认的证书过期时间相同。</p>
<blockquote>
<p>CA，即证书授权中心（Certificate Authority），是指负责签发、管理和吊销数字证书的可信机构。在网络通信中，数字证书起到验证通信双方身份的作用，CA 则是负责颁发数字证书，以及验证证书的真实性和有效性。</p>
<p>CA 通常由政府、军队、金融机构等具有一定信誉和安全保障能力的机构所担任，以确保数字证书的安全性和可靠性。通过使用CA，数字证书的颁发和验证得以形成一个闭环，使得网络通信过程更加安全和可靠。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &gt; ca-config.json &lt;&lt; <span class="hljs-string">EOF</span></span> <br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;876000h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;kubernetes&quot;: &#123;<br>        &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ],<br>        &quot;expiry&quot;: &quot;876000h&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<p>下面这段 shell 是用于创建 etcd CA 证书签名请求文件的 JSON 配置文件。其中，”CN” 是证书的通用名称，”key” 定义了加密算法和密钥长度，”names” 列出了证书的主题，”ca” 定义了证书颁发机构的过期时间。该文件会被用于生成 etcd CA 证书，用于签发和管理 etcd 集群中的其他证书，保证集群通信的安全性。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &gt; etcd-ca-csr.json  &lt;&lt; <span class="hljs-string">EOF</span></span> <br>&#123;<br>  &quot;CN&quot;: &quot;etcd&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;etcd&quot;,<br>      &quot;OU&quot;: &quot;Etcd Security&quot;<br>    &#125;<br>  ],<br>  &quot;ca&quot;: &#123;<br>    &quot;expiry&quot;: &quot;876000h&quot;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>



<h3 id="这部分直接看这里"><a href="#这部分直接看这里" class="headerlink" title="这部分直接看这里"></a>这部分直接看这里</h3><blockquote>
<p>发现这部分 shell 有点多，懒得一个一个问 ChatGPT 什么意思了，暂时也不关注这些证书相关的东西了。。。</p>
</blockquote>
<p>直接将下面这些命令复制到 terminal 回车即可，会一并创建这些文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; admin-csr.json &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; ca-config.json &lt;&lt; EOF <br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;876000h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;kubernetes&quot;: &#123;<br>        &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ],<br>        &quot;expiry&quot;: &quot;876000h&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br>cat &gt; etcd-ca-csr.json  &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;etcd&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;etcd&quot;,<br>      &quot;OU&quot;: &quot;Etcd Security&quot;<br>    &#125;<br>  ],<br>  &quot;ca&quot;: &#123;<br>    &quot;expiry&quot;: &quot;876000h&quot;<br>  &#125;<br>&#125;<br>EOF<br>cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;kubernetes&quot;,<br>  &quot;key&quot;: &#123;<br>     &quot;algo&quot;: &quot;rsa&quot;,<br>     &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;ca&quot;: &#123;<br>    &quot;expiry&quot;: &quot;876000h&quot;<br>  &#125;<br>&#125;<br>EOF<br>cat &gt; kubelet-csr.json  &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;system:node:\$NODE&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:nodes&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; manager-csr.json &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; apiserver-csr.json &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;kube-apiserver&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;Kubernetes&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; ca-csr.json   &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;kubernetes&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;Kubernetes&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ],<br>  &quot;ca&quot;: &#123;<br>    &quot;expiry&quot;: &quot;876000h&quot;<br>  &#125;<br>&#125;<br>EOF<br>cat &gt; etcd-csr.json &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;etcd&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;etcd&quot;,<br>      &quot;OU&quot;: &quot;Etcd Security&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;front-proxy-client&quot;,<br>  &quot;key&quot;: &#123;<br>     &quot;algo&quot;: &quot;rsa&quot;,<br>     &quot;size&quot;: 2048<br>  &#125;<br>&#125;<br>EOF<br>cat &gt; kube-proxy-csr.json  &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:kube-proxy&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br>cat &gt; scheduler-csr.json &lt;&lt; EOF <br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;ST&quot;: &quot;Beijing&quot;,<br>      &quot;L&quot;: &quot;Beijing&quot;,<br>      &quot;O&quot;: &quot;system:kube-scheduler&quot;,<br>      &quot;OU&quot;: &quot;Kubernetes-manual&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>



<p>继续复制执行下面的命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ..<br>mkdir bootstrap<br>cd bootstrap<br>cat &gt; bootstrap.secret.yaml &lt;&lt; EOF <br>apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: bootstrap-token-c8ad9c<br>  namespace: kube-system<br>type: bootstrap.kubernetes.io/token<br>stringData:<br>  description: &quot;The default bootstrap token generated by &#x27;kubelet &#x27;.&quot;<br>  token-id: c8ad9c<br>  token-secret: 2e4d610cf3e7426e<br>  usage-bootstrap-authentication: &quot;true&quot;<br>  usage-bootstrap-signing: &quot;true&quot;<br>  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: kubelet-bootstrap<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:node-bootstrapper<br>subjects:<br>- apiGroup: rbac.authorization.k8s.io<br>  kind: Group<br>  name: system:bootstrappers:default-node-token<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: node-autoapprove-bootstrap<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient<br>subjects:<br>- apiGroup: rbac.authorization.k8s.io<br>  kind: Group<br>  name: system:bootstrappers:default-node-token<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: node-autoapprove-certificate-rotation<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient<br>subjects:<br>- apiGroup: rbac.authorization.k8s.io<br>  kind: Group<br>  name: system:nodes<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  annotations:<br>    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;<br>  labels:<br>    kubernetes.io/bootstrapping: rbac-defaults<br>  name: system:kube-apiserver-to-kubelet<br>rules:<br>  - apiGroups:<br>      - &quot;&quot;<br>    resources:<br>      - nodes/proxy<br>      - nodes/stats<br>      - nodes/log<br>      - nodes/spec<br>      - nodes/metrics<br>    verbs:<br>      - &quot;*&quot;<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: system:kube-apiserver<br>  namespace: &quot;&quot;<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:kube-apiserver-to-kubelet<br>subjects:<br>  - apiGroup: rbac.authorization.k8s.io<br>    kind: User<br>    name: kube-apiserver<br>EOF<br></code></pre></td></tr></table></figure>

<p>这些 Kubernetes 配置包含以下内容：</p>
<ol>
<li><code>bootstrap-token-c8ad9c</code>: 用于启动 Kubernetes 集群的默认引导令牌及其相关权限信息，包括描述信息、令牌 ID、令牌密钥以及用于启动认证和签名等权限的标志。</li>
<li><code>kubelet-bootstrap</code> ClusterRoleBinding：将 <code>system:node-bootstrapper</code> ClusterRole 分配给 <code>system:bootstrappers:default-node-token</code> 组，以便允许节点使用引导令牌进行身份验证和授权。</li>
<li><code>node-autoapprove-bootstrap</code> ClusterRoleBinding：自动批准使用引导令牌发出的节点客户端证书签名请求。</li>
<li><code>node-autoapprove-certificate-rotation</code> ClusterRoleBinding：自动批准用于自签名节点证书轮换的签名请求。</li>
<li><code>system:kube-apiserver-to-kubelet</code> ClusterRole：定义了一个角色，该角色允许 kube-apiserver 访问 kubelet API，以便可以从 kube-apiserver 发送请求到节点的 kubelet API，以获取节点信息和执行操作。</li>
<li><code>system:kube-apiserver</code> ClusterRoleBinding：将 <code>system:kube-apiserver-to-kubelet</code> ClusterRole 分配给 kube-apiserver 用户，以便在整个 Kubernetes 集群范围内允许 kube-apiserver 访问 kubelet API。</li>
</ol>
<h2 id="ETCD-证书"><a href="#ETCD-证书" class="headerlink" title="ETCD 证书"></a>ETCD 证书</h2><blockquote>
<p>本节操作只需要 master 节点执行即可。</p>
</blockquote>
<h3 id="创建证书文件"><a href="#创建证书文件" class="headerlink" title="创建证书文件"></a>创建证书文件</h3><p>创建用于存放证书的文件夹</p>
<p>PS：因为我只有一个控制面节点 k8s-master，而 etcd 只需要部署在控制面即可，所以不需要在其他节点执行同样的操作，直接在本节点创建</p>
<p><del>for i in k8s-master k8s-worker1 k8s-worker2;do</del><br>   <del>ssh root@$i mkdir &#x2F;etc&#x2F;etcd&#x2F;ssl -p</del><br>   <del>echo $i create done</del><br><del>done</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /etc/etcd/ssl -p<br></code></pre></td></tr></table></figure>

<h3 id="生成-etcd-证书和-etcd-证书的-key"><a href="#生成-etcd-证书和-etcd-证书的-key" class="headerlink" title="生成 etcd 证书和 etcd 证书的 key"></a>生成 etcd 证书和 etcd 证书的 key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> pki</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span><br></code></pre></td></tr></table></figure>

<p>注意 <code>-hostname</code> 这里的参数，改成你对应 master 节点的 hostname 和 IP，别直接 cv 过来就执行，如果你不小心执行错了（和我一样没注意，直接 cv 过来就执行，导致后续 etcd 不认这个节点），直接修改下面的 shell 后再重新执行一遍即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert \</span><br><span class="language-bash">   -ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="language-bash">   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="language-bash">   -config=ca-config.json \</span><br><span class="language-bash">   -hostname=k8s-master,192.168.223.128 \</span><br><span class="language-bash">   -profile=kubernetes \</span><br><span class="language-bash">   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br></code></pre></td></tr></table></figure>

<p>执行完成后，将会在 <code>/etc/etcd/ssl</code> 目录下生成这些证书文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /etc/etcd/ssl</span><br>etcd-ca.csr  etcd-ca-key.pem  etcd-ca.pem  etcd.csr  etcd-key.pem  etcd.pem<br></code></pre></td></tr></table></figure>



<h3 id="将证书复制到其他节点"><a href="#将证书复制到其他节点" class="headerlink" title="将证书复制到其他节点"></a>将证书复制到其他节点</h3><p>我的单节点控制面用不上了</p>
<p><del>for i in k8s-worker1 k8s-worker2;do</del><br>    <del>ssh $i “mkdir -p &#x2F;etc&#x2F;etcd&#x2F;ssl”</del><br>    <del>scp &#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;* $i:&#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;</del><br><del>done</del></p>
<h2 id="k8s-集群证书"><a href="#k8s-集群证书" class="headerlink" title="k8s 集群证书"></a>k8s 集群证书</h2><blockquote>
<p>本节操作只需要 master 节点执行即可。</p>
</blockquote>
<h3 id="创建所有证书的存放目录"><a href="#创建所有证书的存放目录" class="headerlink" title="创建所有证书的存放目录"></a>创建所有证书的存放目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /etc/kubernetes/pki</span><br></code></pre></td></tr></table></figure>

<h3 id="生成一个根证书"><a href="#生成一个根证书" class="headerlink" title="生成一个根证书"></a>生成一个根证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br></code></pre></td></tr></table></figure>

<h3 id="创建-API-Server-凭证与私钥"><a href="#创建-API-Server-凭证与私钥" class="headerlink" title="创建 API Server 凭证与私钥"></a>创建 API Server 凭证与私钥</h3><p>10.96.0.1 是 service 网段的第一个地址，hostname 中指定了生成的证书的 Subject Alternative Names (SANs)，即证书允许被使用的主机名或 IP 地址，这里我填写了 3 台虚拟机的 hostname 和 IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert   \</span><br><span class="language-bash">-ca=/etc/kubernetes/pki/ca.pem   \</span><br><span class="language-bash">-ca-key=/etc/kubernetes/pki/ca-key.pem   \</span><br><span class="language-bash">-config=ca-config.json   \</span><br><span class="language-bash">-hostname=10.96.0.1,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,k8s-master,k8s-worker1,k8s-worker2,192.168.223.128,192.168.223.129,192.168.223.130   \</span><br><span class="language-bash">-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br></code></pre></td></tr></table></figure>

<h3 id="生成-apiserver"><a href="#生成-apiserver" class="headerlink" title="生成 apiserver"></a>生成 apiserver</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca</span> <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert  \</span><br><span class="language-bash">-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \</span><br><span class="language-bash">-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \</span><br><span class="language-bash">-config=ca-config.json   \</span><br><span class="language-bash">-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br></code></pre></td></tr></table></figure>

<h3 id="生成-controller-manage-证书"><a href="#生成-controller-manage-证书" class="headerlink" title="生成 controller-manage 证书"></a>生成 controller-manage 证书</h3><p>注意替换下面命令中的 –server，IP 填写 api-server 的 IP，在我这里是 master 节点的 IP，端口填写 api-server 的 port，这个值在 api server 配置中的 –secure-port&#x3D;6443 指定</p>
<blockquote>
<p>疑问：</p>
<p>我这里只有一个 master 节点，所以 api-server 的 IP 就是该 master 节点的 IP，那如果部署方式是多个 master 节点，此时 api-server 的 IP 又该如何填写呢？</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert \</span><br><span class="language-bash">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="language-bash">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="language-bash">   -config=ca-config.json \</span><br><span class="language-bash">   -profile=kubernetes \</span><br><span class="language-bash">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br>   <br>   <br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置一个集群项</span><br>kubectl config set-cluster kubernetes \<br>     --certificate-authority=/etc/kubernetes/pki/ca.pem \<br>     --embed-certs=true \<br>     --server=https://192.168.223.128:6443 \<br>     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置一个环境项，一个上下文</span><br>kubectl config set-context system:kube-controller-manager@kubernetes \<br>    --cluster=kubernetes \<br>    --user=system:kube-controller-manager \<br>    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置一个用户项</span><br>kubectl config set-credentials system:kube-controller-manager \<br>     --client-certificate=/etc/kubernetes/pki/controller-manager.pem \<br>     --client-key=/etc/kubernetes/pki/controller-manager-key.pem \<br>     --embed-certs=true \<br>     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置默认环境</span><br>kubectl config use-context system:kube-controller-manager@kubernetes \<br>     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig<br>cfssl gencert \<br>   -ca=/etc/kubernetes/pki/ca.pem \<br>   -ca-key=/etc/kubernetes/pki/ca-key.pem \<br>   -config=ca-config.json \<br>   -profile=kubernetes \<br>   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler<br>kubectl config set-cluster kubernetes \<br>     --certificate-authority=/etc/kubernetes/pki/ca.pem \<br>     --embed-certs=true \<br>     --server=https://192.168.223.128:6443 \<br>     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig<br>kubectl config set-credentials system:kube-scheduler \<br>     --client-certificate=/etc/kubernetes/pki/scheduler.pem \<br>     --client-key=/etc/kubernetes/pki/scheduler-key.pem \<br>     --embed-certs=true \<br>     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig<br>kubectl config set-context system:kube-scheduler@kubernetes \<br>     --cluster=kubernetes \<br>     --user=system:kube-scheduler \<br>     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig<br>kubectl config use-context system:kube-scheduler@kubernetes \<br>     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig<br>cfssl gencert \<br>   -ca=/etc/kubernetes/pki/ca.pem \<br>   -ca-key=/etc/kubernetes/pki/ca-key.pem \<br>   -config=ca-config.json \<br>   -profile=kubernetes \<br>   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin<br>kubectl config set-cluster kubernetes     \<br>  --certificate-authority=/etc/kubernetes/pki/ca.pem     \<br>  --embed-certs=true     \<br>  --server=https://192.168.223.128:6443     \<br>  --kubeconfig=/etc/kubernetes/admin.kubeconfig<br>kubectl config set-credentials kubernetes-admin  \<br>  --client-certificate=/etc/kubernetes/pki/admin.pem     \<br>  --client-key=/etc/kubernetes/pki/admin-key.pem     \<br>  --embed-certs=true     \<br>  --kubeconfig=/etc/kubernetes/admin.kubeconfig<br>kubectl config set-context kubernetes-admin@kubernetes    \<br>  --cluster=kubernetes     \<br>  --user=kubernetes-admin     \<br>  --kubeconfig=/etc/kubernetes/admin.kubeconfig<br>kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig<br></code></pre></td></tr></table></figure>

<h3 id="生成-kube-proxy-证书"><a href="#生成-kube-proxy-证书" class="headerlink" title="生成 kube-proxy 证书"></a>生成 kube-proxy 证书</h3><p>注意替换下面命令中的 –server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">cfssl gencert \<br>   -ca=/etc/kubernetes/pki/ca.pem \<br>   -ca-key=/etc/kubernetes/pki/ca-key.pem \<br>   -config=ca-config.json \<br>   -profile=kubernetes \<br>   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy<br>kubectl config set-cluster kubernetes     \<br>  --certificate-authority=/etc/kubernetes/pki/ca.pem     \<br>  --embed-certs=true     \<br>  --server=https://192.168.223.128:6443     \<br>  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig<br>kubectl config set-credentials kube-proxy  \<br>  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \<br>  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \<br>  --embed-certs=true     \<br>  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig<br>kubectl config set-context kube-proxy@kubernetes    \<br>  --cluster=kubernetes     \<br>  --user=kube-proxy     \<br>  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig<br>kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig<br></code></pre></td></tr></table></figure>

<h3 id="创建-ServiceAccount-Key"><a href="#创建-ServiceAccount-Key" class="headerlink" title="创建 ServiceAccount Key"></a>创建 ServiceAccount Key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl rsa -<span class="hljs-keyword">in</span> /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br></code></pre></td></tr></table></figure>

<p>其他节点创建目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">for i in k8s-worker1 k8s-worker2;do    <br>	ssh $i &quot;mkdir  /etc/kubernetes/pki/ -p&quot;    <br>	scp -r /etc/kubernetes/pki $i:/etc/kubernetes/<br>done<br></code></pre></td></tr></table></figure>

<h3 id="查看各个节点的证书"><a href="#查看各个节点的证书" class="headerlink" title="查看各个节点的证书"></a>查看各个节点的证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /etc/kubernetes/pki/</span><br>admin.csr          ca.csr                      front-proxy-ca.csr          kube-proxy.csr      scheduler-key.pem<br>admin-key.pem      ca-key.pem                  front-proxy-ca-key.pem      kube-proxy-key.pem  scheduler.pem<br>admin.pem          ca.pem                      front-proxy-ca.pem          kube-proxy.pem<br>apiserver.csr      controller-manager.csr      front-proxy-client.csr      sa.key<br>apiserver-key.pem  controller-manager-key.pem  front-proxy-client-key.pem  sa.pub<br>apiserver.pem      controller-manager.pem      front-proxy-client.pem      scheduler.csr<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">一共 26 个就对了</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /etc/kubernetes/pki/ |<span class="hljs-built_in">wc</span> -l</span><br>26<br></code></pre></td></tr></table></figure>

<h2 id="配置-ETCD"><a href="#配置-ETCD" class="headerlink" title="配置 ETCD"></a>配置 ETCD</h2><h3 id="master-节点"><a href="#master-节点" class="headerlink" title="master 节点"></a>master 节点</h3><p>在 master 节点执行下面的 shell，注意将配置里的 IP 改为 master 节点的 IP，hostname 也要修改成对应的，initial-cluster 修改成对应的几个节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">如果要用 IPv6 那么把 IPv4 地址修改为 IPv6 即可</span><br>cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF <br>name: &#x27;k8s-master&#x27;<br>data-dir: /var/lib/etcd<br>wal-dir: /var/lib/etcd/wal<br>snapshot-count: 5000<br>heartbeat-interval: 100<br>election-timeout: 1000<br>quota-backend-bytes: 0<br>listen-peer-urls: &#x27;https://192.168.223.128:2380&#x27;<br>listen-client-urls: &#x27;https://192.168.223.128:2379,http://127.0.0.1:2379&#x27;<br>max-snapshots: 3<br>max-wals: 5<br>cors:<br>initial-advertise-peer-urls: &#x27;https://192.168.223.128:2380&#x27;<br>advertise-client-urls: &#x27;https://192.168.223.128:2379&#x27;<br>discovery:<br>discovery-fallback: &#x27;proxy&#x27;<br>discovery-proxy:<br>discovery-srv:<br>initial-cluster: &#x27;k8s-master=https://192.168.223.128:2380&#x27;<br>initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;<br>initial-cluster-state: &#x27;new&#x27;<br>strict-reconfig-check: false<br>enable-v2: true<br>enable-pprof: true<br>proxy: &#x27;off&#x27;<br>proxy-failure-wait: 5000<br>proxy-refresh-interval: 30000<br>proxy-dial-timeout: 1000<br>proxy-write-timeout: 5000<br>proxy-read-timeout: 0<br>client-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>peer-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  peer-client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>debug: false<br>log-package-levels:<br>log-outputs: [default]<br>force-new-cluster: false<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="k8s-worker1-节点"><a href="#k8s-worker1-节点" class="headerlink" title="k8s-worker1 节点"></a><del>k8s-worker1 节点</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">如果要用 IPv6 那么把 IPv4 地址修改为 IPv6 即可</span><br>cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF <br>name: &#x27;k8s-worker1&#x27;<br>data-dir: /var/lib/etcd<br>wal-dir: /var/lib/etcd/wal<br>snapshot-count: 5000<br>heartbeat-interval: 100<br>election-timeout: 1000<br>quota-backend-bytes: 0<br>listen-peer-urls: &#x27;https://192.168.223.129:2380&#x27;<br>listen-client-urls: &#x27;https://192.168.223.129:2379,http://127.0.0.1:2379&#x27;<br>max-snapshots: 3<br>max-wals: 5<br>cors:<br>initial-advertise-peer-urls: &#x27;https://192.168.223.129:2380&#x27;<br>advertise-client-urls: &#x27;https://192.168.223.129:2379&#x27;<br>discovery:<br>discovery-fallback: &#x27;proxy&#x27;<br>discovery-proxy:<br>discovery-srv:<br>initial-cluster: &#x27;k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380&#x27;<br>initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;<br>initial-cluster-state: &#x27;new&#x27;<br>strict-reconfig-check: false<br>enable-v2: true<br>enable-pprof: true<br>proxy: &#x27;off&#x27;<br>proxy-failure-wait: 5000<br>proxy-refresh-interval: 30000<br>proxy-dial-timeout: 1000<br>proxy-write-timeout: 5000<br>proxy-read-timeout: 0<br>client-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>peer-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  peer-client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>debug: false<br>log-package-levels:<br>log-outputs: [default]<br>force-new-cluster: false<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="k8s-worker2-节点"><a href="#k8s-worker2-节点" class="headerlink" title="k8s-worker2 节点"></a><del>k8s-worker2 节点</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">如果要用 IPv6 那么把 IPv4 地址修改为 IPv6 即可</span><br>cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF <br>name: &#x27;k8s-worker2&#x27;<br>data-dir: /var/lib/etcd<br>wal-dir: /var/lib/etcd/wal<br>snapshot-count: 5000<br>heartbeat-interval: 100<br>election-timeout: 1000<br>quota-backend-bytes: 0<br>listen-peer-urls: &#x27;https://192.168.223.130:2380&#x27;<br>listen-client-urls: &#x27;https://192.168.223.130:2379,http://127.0.0.1:2379&#x27;<br>max-snapshots: 3<br>max-wals: 5<br>cors:<br>initial-advertise-peer-urls: &#x27;https://192.168.223.130:2380&#x27;<br>advertise-client-urls: &#x27;https://192.168.223.130:2379&#x27;<br>discovery:<br>discovery-fallback: &#x27;proxy&#x27;<br>discovery-proxy:<br>discovery-srv:<br>initial-cluster: &#x27;k8s-master=https://192.168.223.128:2380,k8s-worker1=https://192.168.223.129:2380,k8s-worker2=https://192.168.223.130:2380&#x27;<br>initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;<br>initial-cluster-state: &#x27;new&#x27;<br>strict-reconfig-check: false<br>enable-v2: true<br>enable-pprof: true<br>proxy: &#x27;off&#x27;<br>proxy-failure-wait: 5000<br>proxy-refresh-interval: 30000<br>proxy-dial-timeout: 1000<br>proxy-write-timeout: 5000<br>proxy-read-timeout: 0<br>client-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>peer-transport-security:<br>  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;<br>  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;<br>  peer-client-cert-auth: true<br>  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;<br>  auto-tls: true<br>debug: false<br>log-package-levels:<br>log-outputs: [default]<br>force-new-cluster: false<br>EOF<br></code></pre></td></tr></table></figure>

<p>创建 etcd 启动服务（需要在所有 master 节点操作）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF<br>[Unit]<br>Description=Etcd Service<br>Documentation=https://coreos.com/etcd/docs/latest/<br>After=network.target<br>[Service]<br>Type=notify<br>ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml<br>Restart=on-failure<br>RestartSec=10<br>LimitNOFILE=65536<br>[Install]<br>WantedBy=multi-user.target<br>Alias=etcd3.service<br>EOF<br></code></pre></td></tr></table></figure>

<p>拷贝 ETCD 证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /etc/kubernetes/pki/etcd<br>ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/<br>systemctl daemon-reload<br>systemctl enable --now etcd<br></code></pre></td></tr></table></figure>

<p>查看 etcd 状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl --endpoints=<span class="hljs-string">&quot;k8s-master:2379&quot;</span> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>之前的配置文件写错了，应该只有 master 节点需要运行 etcd，所以配置文件中的 initial-cluster 需要改为 k8s-master&#x3D;<a target="_blank" rel="noopener" href="https://192.168.223.128:2380'，也就是只添加">https://192.168.223.128:2380&#39;，也就是只添加</a> master 本身即可，删掉之前加入的两个 worker 节点，修改为：</p>
<p><code>initial-cluster: &#39;k8s-master=https://192.168.223.128:2380&#39;</code></p>
<p>然后执行 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart etcd</span><br></code></pre></td></tr></table></figure>

<p>重新运行 etcd，但是发现无法运行，手动执行 etcd –config-file&#x3D;&#x2F;etc&#x2F;etcd&#x2F;etcd.config.yml（也可以使用 <code>sudo journalctl -u etcd</code>），发现日志里输出 “error”:”dial tcp 192.168.223.129:2380: connect: connection refused”，这表示 etcd 依旧在尝试连接 worker1 的 etcd，明明改了 initial-cluster，为什么没有生效呢？</p>
<p>我重新排查日志，发现有这么一行有点可疑：</p>
<p>{“level”:”info”,”ts”:”2023-04-15T16:58:41.252Z”,”caller”:”etcdmain&#x2F;etcd.go:116”,”msg”:”server has been already initialized”,”data-dir”:”&#x2F;var&#x2F;lib&#x2F;etcd”,”dir-type”:”member”}</p>
<p>尝试删掉 &#x2F;var&#x2F;lib&#x2F;etcd&#x2F;member，再次执行 sudo systemctl restart etcd，发现命令不会阻塞了，etcd 成功运行。（此时我只想夸自己一句牛逼 plus）</p>
</blockquote>
<p>如果输出下面这些内容，说明你搞对了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>| k8s-master:2379 | 2918d818e481030f |   3.5.4 |   20 kB |      true |      false |         5 |         10 |                 10 |        |<br>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br></code></pre></td></tr></table></figure>



<h2 id="ApiServer-配置"><a href="#ApiServer-配置" class="headerlink" title="ApiServer 配置"></a>ApiServer 配置</h2><p>创建 apiserver 服务启动文件</p>
<p>需要在每台节点自行修改对应的信息</p>
<ul>
<li>–advertise-address 当前节点 IP</li>
<li>–etcd-servers ETCD 节点信息</li>
<li>–secure-port apiserver 端口号</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes API Server<br>Documentation=https://github.com/kubernetes/kubernetes<br>After=network.target<br>[Service]<br>ExecStart=/usr/local/bin/kube-apiserver \<br>      --v=2  \<br>      --logtostderr=true  \<br>      --allow-privileged=true  \<br>      --bind-address=0.0.0.0  \<br>      --secure-port=6443  \<br>      --advertise-address=192.168.223.128 \<br>      --service-cluster-ip-range=10.96.0.0/12,fd00::/108  \<br>      --feature-gates=IPv6DualStack=true  \<br>      --service-node-port-range=30000-32767  \<br>      --etcd-servers=https://k8s-master:2379 \<br>      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \<br>      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \<br>      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \<br>      --client-ca-file=/etc/kubernetes/pki/ca.pem  \<br>      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \<br>      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \<br>      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \<br>      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \<br>      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \<br>      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \<br>      --service-account-issuer=https://kubernetes.default.svc.cluster.local \<br>      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \<br>      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \<br>      --authorization-mode=Node,RBAC  \<br>      --enable-bootstrap-token-auth=true  \<br>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \<br>      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \<br>      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \<br>      --requestheader-allowed-names=aggregator  \<br>      --requestheader-group-headers=X-Remote-Group  \<br>      --requestheader-extra-headers-prefix=X-Remote-Extra-  \<br>      --requestheader-username-headers=X-Remote-User \<br>      --enable-aggregator-routing=true<br>      # --token-auth-file=/etc/kubernetes/token.csv<br>Restart=on-failure<br>RestartSec=10s<br>LimitNOFILE=65535<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>

<p>启动 apiserver（所有 master 节点）</p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do</del><br>    <del>ssh $i “systemctl daemon-reload &amp;&amp; systemctl enable –now kube-apiserver”</del><br>    <del>echo “$i”</del><br>    <del>sleep 5</del><br>    <del>ssh $i “systemctl status kube-apiserver”</del><br><del>done</del></p>
<p>单 master 节点只需要执行下面的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload &amp;&amp; systemctl <span class="hljs-built_in">enable</span> --now kube-apiserver</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">sleep</span> 5</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kube-apiserver</span><br></code></pre></td></tr></table></figure>

<p>如果输出类似这样，即 Active: active (running)，则代表成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">● kube-apiserver.service - Kubernetes API Server<br>     Loaded: loaded (/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Sat 2023-04-15 18:01:27 UTC; 6s ago<br>       Docs: https://github.com/kubernetes/kubernetes<br>   Main PID: 54969 (kube-apiserver)<br>      Tasks: 15 (limit: 9362)<br>     Memory: 290.8M<br>        CPU: 3.201s<br></code></pre></td></tr></table></figure>

<h2 id="Controller-Manage-配置"><a href="#Controller-Manage-配置" class="headerlink" title="Controller-Manage 配置"></a>Controller-Manage 配置</h2><p>172.16.0.0&#x2F;12 为 pod 网段，按需求设置你自己的网段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Controller Manager<br>Documentation=https://github.com/kubernetes/kubernetes<br>After=network.target<br>[Service]<br>ExecStart=/usr/local/bin/kube-controller-manager \<br>      --v=2 \<br>      --logtostderr=true \<br>      --bind-address=127.0.0.1 \<br>      --root-ca-file=/etc/kubernetes/pki/ca.pem \<br>      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \<br>      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \<br>      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \<br>      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \<br>      --leader-elect=true \<br>      --use-service-account-credentials=true \<br>      --node-monitor-grace-period=40s \<br>      --node-monitor-period=5s \<br>      --pod-eviction-timeout=2m0s \<br>      --controllers=*,bootstrapsigner,tokencleaner \<br>      --allocate-node-cidrs=true \<br>      --feature-gates=IPv6DualStack=true \<br>      --service-cluster-ip-range=10.96.0.0/12,fd00::/108 \<br>      --cluster-cidr=172.16.0.0/12,fc00::/48 \<br>      --node-cidr-mask-size-ipv4=24 \<br>      --node-cidr-mask-size-ipv6=64 \<br>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem <br>Restart=always<br>RestartSec=10s<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>

<p><strong>配置文件拷贝到其它节点</strong></p>
<p><del>for i in k8s-02 k8s-03;do<br>    scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service  $i:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;    	scp &#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.kubeconfig  $i:&#x2F;etc&#x2F;kubernetes&#x2F;</del><br><del>done</del></p>
<p>我这边就用不着了</p>
<p><strong>启动所有节点服务</strong></p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do</del><br>      <del>ssh $i “systemctl daemon-reload &amp;&amp; systemctl enable –now kube-controller-manager &amp;&amp; systemctl  status kube-controller-manager”</del><br><del>done</del></p>
<p>我这里也用不着了，只需要执行下面这段即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload &amp;&amp; systemctl <span class="hljs-built_in">enable</span> --now kube-controller-manager &amp;&amp; systemctl  status kube-controller-manager</span><br></code></pre></td></tr></table></figure>

<p>输出类似下面这样</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /lib/systemd/system/kube-controller-manager.service.<br>● kube-controller-manager.service - Kubernetes Controller Manager<br>     Loaded: loaded (/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Sat 2023-04-15 18:14:05 UTC; 5ms ago<br>       Docs: https://github.com/kubernetes/kubernetes<br>   Main PID: 55081 (kube-controller)<br>      Tasks: 6 (limit: 9362)<br>     Memory: 1.6M<br>        CPU: 3ms<br></code></pre></td></tr></table></figure>

<h2 id="Scheduler-配置"><a href="#Scheduler-配置" class="headerlink" title="Scheduler 配置"></a>Scheduler 配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Scheduler<br>Documentation=https://github.com/kubernetes/kubernetes<br>After=network.target<br>[Service]<br>ExecStart=/usr/local/bin/kube-scheduler \<br>      --v=2 \<br>      --logtostderr=true \<br>      --bind-address=127.0.0.1 \<br>      --leader-elect=true \<br>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig<br>Restart=always<br>RestartSec=10s<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>

<p><del>配置文件拷贝到其它节点</del></p>
<p><del>for i in k8s-02 k8s-03;do<br>    scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service  $i:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;<br>    scp &#x2F;etc&#x2F;kubernetes&#x2F;scheduler.kubeconfig $i:&#x2F;etc&#x2F;kubernetes&#x2F;</del><br><del>done</del></p>
<p>启动所有节点服务</p>
<p><del>for i in k8s-01 k8s-02 k8s-03;do<br>    ssh $i “systemctl daemon-reload &amp;&amp; systemctl enable –now kube-scheduler &amp;&amp; systemctl  status kube-scheduler”</del><br><del>done</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload &amp;&amp; systemctl <span class="hljs-built_in">enable</span> --now kube-scheduler &amp;&amp; systemctl  status kube-scheduler</span><br></code></pre></td></tr></table></figure>

<h2 id="上下文配置"><a href="#上下文配置" class="headerlink" title="上下文配置"></a>上下文配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /root/bootstrap<br>kubectl config set-cluster kubernetes     \<br>--certificate-authority=/etc/kubernetes/pki/ca.pem     \<br>--embed-certs=true     <br>--server=https://192.168.223.128:6443     \<br>--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig<br>kubectl config set-credentials tls-bootstrap-token-user     \<br>--token=c8ad9c.2e4d610cf3e7426e \<br>--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig<br>kubectl config set-context tls-bootstrap-token-user@kubernetes     \<br>--cluster=kubernetes     \<br>--user=tls-bootstrap-token-user     \<br>--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig<br>kubectl config use-context tls-bootstrap-token-user@kubernetes     \<br>--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig<br><span class="hljs-meta prompt_"># </span><span class="language-bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span><br>mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config<br></code></pre></td></tr></table></figure>

<p>查看集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get cs</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">这样就对了</span><br>Warning: v1 ComponentStatus is deprecated in v1.19+<br>NAME                 STATUS    MESSAGE                         ERROR<br>scheduler            Healthy   ok<br>controller-manager   Healthy   ok<br>etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;<br></code></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl create -f bootstrap.secret.yaml</span><br></code></pre></td></tr></table></figure>

<h2 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h2><h3 id="创建-kubelet-启动文件"><a href="#创建-kubelet-启动文件" class="headerlink" title="创建 kubelet 启动文件"></a>创建 kubelet 启动文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Kubelet<br>Documentation=https://github.com/kubernetes/kubernetes<br>After=containerd.service<br>Requires=containerd.service<br>[Service]<br>ExecStart=/usr/local/bin/kubelet \<br>    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \<br>    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \<br>    --config=/etc/kubernetes/kubelet-conf.yml \<br>    --container-runtime=remote  \<br>    --runtime-request-timeout=15m  \<br>    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \<br>    --cgroup-driver=systemd \<br>    --node-labels=node.kubernetes.io/node=&#x27;&#x27; \<br>    --feature-gates=IPv6DualStack=true<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="创建-kubelet-配置文件"><a href="#创建-kubelet-配置文件" class="headerlink" title="创建 kubelet 配置文件"></a>创建 kubelet 配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>kind: KubeletConfiguration<br>address: 0.0.0.0<br>port: 10250<br>readOnlyPort: 10255<br>authentication:<br>  anonymous:<br>    enabled: false<br>  webhook:<br>    cacheTTL: 2m0s<br>    enabled: true<br>  x509:<br>    clientCAFile: /etc/kubernetes/pki/ca.pem<br>authorization:<br>  mode: Webhook<br>  webhook:<br>    cacheAuthorizedTTL: 5m0s<br>    cacheUnauthorizedTTL: 30s<br>cgroupDriver: systemd<br>cgroupsPerQOS: true<br>clusterDNS:<br>- 10.96.0.10<br>clusterDomain: cluster.local<br>containerLogMaxFiles: 5<br>containerLogMaxSize: 10Mi<br>contentType: application/vnd.kubernetes.protobuf<br>cpuCFSQuota: true<br>cpuManagerPolicy: none<br>cpuManagerReconcilePeriod: 10s<br>enableControllerAttachDetach: true<br>enableDebuggingHandlers: true<br>enforceNodeAllocatable:<br>- pods<br>eventBurst: 10<br>eventRecordQPS: 5<br>evictionHard:<br>  imagefs.available: 15%<br>  memory.available: 100Mi<br>  nodefs.available: 10%<br>  nodefs.inodesFree: 5%<br>evictionPressureTransitionPeriod: 5m0s<br>failSwapOn: true<br>fileCheckFrequency: 20s<br>hairpinMode: promiscuous-bridge<br>healthzBindAddress: 127.0.0.1<br>healthzPort: 10248<br>httpCheckFrequency: 20s<br>imageGCHighThresholdPercent: 85<br>imageGCLowThresholdPercent: 80<br>imageMinimumGCAge: 2m0s<br>iptablesDropBit: 15<br>iptablesMasqueradeBit: 14<br>kubeAPIBurst: 10<br>kubeAPIQPS: 5<br>makeIPTablesUtilChains: true<br>maxOpenFiles: 1000000<br>maxPods: 110<br>nodeStatusUpdateFrequency: 10s<br>oomScoreAdj: -999<br>podPidsLimit: -1<br>registryBurst: 10<br>registryPullQPS: 5<br>resolvConf: /etc/resolv.conf<br>rotateCertificates: true<br>runtimeRequestTimeout: 2m0s<br>serializeImagePulls: true<br>staticPodPath: /etc/kubernetes/manifests<br>streamingConnectionIdleTimeout: 4h0m0s<br>syncFrequency: 1m0s<br>volumeStatsAggPeriod: 1m0s<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="拷贝证书到其它节点"><a href="#拷贝证书到其它节点" class="headerlink" title="拷贝证书到其它节点"></a><del>拷贝证书到其它节点</del></h3><p><del>for i in k8s-01 k8s-02 k8s-03;do<br>    ssh $i “mkdir -p &#x2F;var&#x2F;lib&#x2F;kubelet &#x2F;var&#x2F;log&#x2F;kubernetes  &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;“   		scp &#x2F;etc&#x2F;kubernetes&#x2F;kubelet-conf.yml $i:&#x2F;etc&#x2F;kubernetes&#x2F;<br>    scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service  $i:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;<br>    scp &#x2F;etc&#x2F;kubernetes&#x2F;bootstrap-kubelet.kubeconfig $i:&#x2F;etc&#x2F;kubernetes&#x2F;</del><br><del>done</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /var/lib/kubelet /var/log/kubernetes  /etc/kubernetes/manifests/</span><br></code></pre></td></tr></table></figure>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable --now kubelet<br>systemctl status kubelet<br></code></pre></td></tr></table></figure>

<h3 id="查看集群"><a href="#查看集群" class="headerlink" title="查看集群"></a>查看集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get node</span><br><br>No resources found<br></code></pre></td></tr></table></figure>

<p>失败了。。。没有任何节点</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://i4t.com/5636.html">https://i4t.com/5636.html</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/k8s/">#k8s</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>K8s 二进制安装</div>
      <div>https://autsu.github.io/2023/04/13/k8s-binray-install/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>void</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月13日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/14/zhuangji-jilu/" title="装机记录">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">装机记录</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/06/nginx-practice/" title="通过实践学习 Nginx [draft]">
                        <span class="hidden-mobile">通过实践学习 Nginx [draft]</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"6KXGn05vaODkTMKM7zd5lWwl-gzGzoHsz","appKey":"qIMQwH4WrxTe8ds3Ua4HAbet","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
